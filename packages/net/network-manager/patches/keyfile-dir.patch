Allow specifying the system-connections directory.

From: Thierry Reding <thierry.reding@avionic-design.de>


---
 configure.ac                                       |    7 +++++++
 system-settings/plugins/keyfile/Makefile.am        |    2 ++
 system-settings/plugins/keyfile/common.h           |    2 --
 .../plugins/keyfile/nm-keyfile-connection.c        |    4 ++--
 system-settings/plugins/keyfile/plugin.c           |   10 +++++-----
 5 files changed, 16 insertions(+), 9 deletions(-)

diff --git a/configure.ac b/configure.ac
index 6bbfd99..5493e4f 100644
--- a/configure.ac
+++ b/configure.ac
@@ -243,6 +243,13 @@ else
 fi
 AC_SUBST(UDEV_BASE_DIR)
 
+# keyfile plugin
+AC_ARG_WITH([keyfiledir],
+ AS_HELP_STRING([--with-keyfiledir=DIR], [Directory for keyfiles]),
+ [keyfiledir=$withval],
+ [keyfiledir=\${sysconfdir}/NetworkManager/system-connections])
+AC_SUBST(keyfiledir)
+
 # systemd
 AC_ARG_WITH([systemdsystemunitdir],
  AS_HELP_STRING([--with-systemdsystemunitdir=DIR], [Directory for systemd service files]),
diff --git a/system-settings/plugins/keyfile/Makefile.am b/system-settings/plugins/keyfile/Makefile.am
index 1c1fd4a..0d9b4ea 100644
--- a/system-settings/plugins/keyfile/Makefile.am
+++ b/system-settings/plugins/keyfile/Makefile.am
@@ -22,6 +22,7 @@ libkeyfile_io_la_CPPFLAGS = \
 	$(GLIB_CFLAGS) \
 	$(DBUS_CFLAGS) \
 	-DSYSCONFDIR=\"$(sysconfdir)\" \
+	-DKEYFILEDIR=\"$(keyfiledir)\" \
 	-DG_DISABLE_DEPRECATED
 
 libkeyfile_io_la_LIBADD = $(GLIB_LIBS)
@@ -37,6 +38,7 @@ libnm_settings_plugin_keyfile_la_CPPFLAGS = \
 	$(GMODULE_CFLAGS) \
 	$(DBUS_CFLAGS) \
 	-DSYSCONFDIR=\"$(sysconfdir)\" \
+	-DKEYFILEDIR=\"$(keyfiledir)\" \
 	-DG_DISABLE_DEPRECATED
 
 libnm_settings_plugin_keyfile_la_LDFLAGS = -module -avoid-version
diff --git a/system-settings/plugins/keyfile/common.h b/system-settings/plugins/keyfile/common.h
index 7d94a70..3a0db7c 100644
--- a/system-settings/plugins/keyfile/common.h
+++ b/system-settings/plugins/keyfile/common.h
@@ -26,8 +26,6 @@
 #define KEYFILE_PLUGIN_NAME "keyfile"
 #define KEYFILE_PLUGIN_INFO "(c) 2007 - 2010 Red Hat, Inc.  To report bugs please use the NetworkManager mailing list."
 
-#define KEYFILE_DIR SYSCONFDIR "/NetworkManager/system-connections"
-
 #define VPN_SECRETS_GROUP "vpn-secrets"
 
 #define KEYFILE_PLUGIN_ERROR (keyfile_plugin_error_quark ())
diff --git a/system-settings/plugins/keyfile/nm-keyfile-connection.c b/system-settings/plugins/keyfile/nm-keyfile-connection.c
index 3c27a54..d6c9cc8 100644
--- a/system-settings/plugins/keyfile/nm-keyfile-connection.c
+++ b/system-settings/plugins/keyfile/nm-keyfile-connection.c
@@ -93,7 +93,7 @@ nm_keyfile_connection_new (const char *filename, GError **error)
 		g_object_set (s_con, NM_SETTING_CONNECTION_UUID, uuid, NULL);
 		g_free (uuid);
 
-		if (!write_connection (NM_CONNECTION (object), KEYFILE_DIR, 0, 0, NULL, &write_error)) {
+		if (!write_connection (NM_CONNECTION (object), KEYFILEDIR, 0, 0, NULL, &write_error)) {
 			PLUGIN_WARN (KEYFILE_PLUGIN_NAME,
 			             "Couldn't update connection %s with a UUID: (%d) %s",
 			             nm_setting_connection_get_id (s_con),
@@ -123,7 +123,7 @@ update (NMSettingsConnectionInterface *connection,
 	char *filename = NULL;
 	GError *error = NULL;
 
-	if (!write_connection (NM_CONNECTION (connection), KEYFILE_DIR, 0, 0, &filename, &error)) {
+	if (!write_connection (NM_CONNECTION (connection), KEYFILEDIR, 0, 0, &filename, &error)) {
 		callback (connection, error, user_data);
 		g_clear_error (&error);
 		return FALSE;
diff --git a/system-settings/plugins/keyfile/plugin.c b/system-settings/plugins/keyfile/plugin.c
index 27ae0a0..23bcc82 100644
--- a/system-settings/plugins/keyfile/plugin.c
+++ b/system-settings/plugins/keyfile/plugin.c
@@ -75,10 +75,10 @@ read_connections (NMSystemConfigInterface *config)
 	GError *error = NULL;
 	const char *item;
 
-	dir = g_dir_open (KEYFILE_DIR, 0, &error);
+	dir = g_dir_open (KEYFILEDIR, 0, &error);
 	if (!dir) {
 		PLUGIN_WARN (KEYFILE_PLUGIN_NAME, "Cannot read directory '%s': (%d) %s",
-		             KEYFILE_DIR,
+		             KEYFILEDIR,
 		             error ? error->code : -1,
 		             error && error->message ? error->message : "(unknown)");
 		g_clear_error (&error);
@@ -89,7 +89,7 @@ read_connections (NMSystemConfigInterface *config)
 		NMKeyfileConnection *connection;
 		char *full_path;
 
-		full_path = g_build_filename (KEYFILE_DIR, item, NULL);
+		full_path = g_build_filename (KEYFILEDIR, item, NULL);
 		PLUGIN_PRINT (KEYFILE_PLUGIN_NAME, "parsing %s ... ", item);
 		connection = nm_keyfile_connection_new (full_path, &error);
 		if (connection) {
@@ -331,7 +331,7 @@ setup_monitoring (NMSystemConfigInterface *config)
 
 	priv->hash = g_hash_table_new_full (g_str_hash, g_str_equal, NULL, g_object_unref);
 
-	file = g_file_new_for_path (KEYFILE_DIR);
+	file = g_file_new_for_path (KEYFILEDIR);
 	monitor = g_file_monitor_directory (file, G_FILE_MONITOR_NONE, NULL, NULL);
 	g_object_unref (file);
 
@@ -381,7 +381,7 @@ add_connection (NMSystemConfigInterface *config,
                 NMConnection *connection,
                 GError **error)
 {
-	return write_connection (connection, KEYFILE_DIR, 0, 0, NULL, error);
+	return write_connection (connection, KEYFILEDIR, 0, 0, NULL, error);
 }
 
 static GSList *
