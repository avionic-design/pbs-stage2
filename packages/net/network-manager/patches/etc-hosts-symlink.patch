Follow /etc/hosts symlink.

From: Thierry Reding <thierry.reding@avionic-design.de>


---
 src/nm-policy-hosts.c |   20 ++++++++++++++------
 1 files changed, 14 insertions(+), 6 deletions(-)

diff --git a/src/nm-policy-hosts.c b/src/nm-policy-hosts.c
index 7f9cff8..a811611 100644
--- a/src/nm-policy-hosts.c
+++ b/src/nm-policy-hosts.c
@@ -19,6 +19,7 @@
  */
 
 #include <config.h>
+#include <stdlib.h>
 #include <string.h>
 #include <unistd.h>
 #include <errno.h>
@@ -489,15 +490,21 @@ nm_policy_hosts_update_etc_hosts (const char *hostname,
 	GString *new_contents = NULL;
 	gsize contents_len = 0;
 	gboolean success = FALSE;
+	char *filename;
 
 	g_return_val_if_fail (hostname != NULL, FALSE);
 	g_return_val_if_fail (out_changed != NULL, FALSE);
 
-	if (!g_file_get_contents (SYSCONFDIR "/hosts", &contents, &contents_len, &error)) {
-		nm_log_warn (LOGD_DNS, "couldn't read " SYSCONFDIR "/hosts: (%d) %s",
+	filename = realpath(SYSCONFDIR "/hosts", NULL);
+	if (!filename)
+		return FALSE;
+
+	if (!g_file_get_contents (filename, &contents, &contents_len, &error)) {
+		nm_log_warn (LOGD_DNS, "couldn't read %s: (%d) %s", filename,
 		             error ? error->code : 0,
 		             (error && error->message) ? error->message : "(unknown)");
 		g_clear_error (&error);
+		free(filename);
 		return FALSE;
 	}
 
@@ -516,12 +523,12 @@ nm_policy_hosts_update_etc_hosts (const char *hostname,
 	g_free (contents);
 
 	if (new_contents) {
-		nm_log_info (LOGD_DNS, "Updating /etc/hosts with new system hostname");
+		nm_log_info (LOGD_DNS, "Updating %s with new system hostname", filename);
 
 		g_clear_error (&error);
 		/* And actually update /etc/hosts */
-		if (!g_file_set_contents (SYSCONFDIR "/hosts", new_contents->str, -1, &error)) {
-			nm_log_warn (LOGD_DNS, "couldn't update " SYSCONFDIR "/hosts: (%d) %s",
+		if (!g_file_set_contents (filename, new_contents->str, -1, &error)) {
+			nm_log_warn (LOGD_DNS, "couldn't update %s: (%d) %s", filename,
 			             error ? error->code : 0,
 			             (error && error->message) ? error->message : "(unknown)");
 			g_clear_error (&error);
@@ -535,11 +542,12 @@ nm_policy_hosts_update_etc_hosts (const char *hostname,
 		/* No change required */
 		success = TRUE;
 	} else {
-		nm_log_warn (LOGD_DNS, "couldn't read " SYSCONFDIR "/hosts: (%d) %s",
+		nm_log_warn (LOGD_DNS, "couldn't read %s: (%d) %s", filename,
 		             error->code, error->message ? error->message : "(unknown)");
 		g_clear_error (&error);
 	}
 
+	free(filename);
 	return success;
 }
 
