PACKAGE = u-boot
VERSION = git

GIT_URL      = git://git.adnet.avionic-design.de/kernel/u-boot-adx.git
GIT_CHECKOUT = $(CONFIG_U_BOOT_BRANCH)

ifeq ($(CONFIG_U_BOOT_BOARD),)
$(error CONFIG_U_BOOT_BOARD is not defined!)
endif

CONFIG_U_BOOT_BOARD:=$(subst $(quote),,$(CONFIG_U_BOOT_BOARD))

pkgbuildtree := $(pkgbuildtree)
include packages/common.mk
-include $(pkgtree)/version.mk

make-args = \
	O=$(pkgtree)/build \
	CROSS_COMPILE=$(CROSS_COMPILE)

$(pkgtree)/.setup:
	$(call cmd,stamp)

$(pkgtree)/.configure: $(pkgtree)/.patch
	mkdir -p $(pkgtree)/build && cd $(pkgbuildtree) && \
		$(env) $(MAKE) $(make-args) $(CONFIG_U_BOOT_BOARD)_config
	$(call cmd,stamp)

$(pkgtree)/.build: $(pkgtree)/.configure
	cd $(pkgbuildtree) && \
		$(env) $(MAKE) $(make-args)
	$(call cmd,stamp)

$(pkgtree)/.do-install: $(pkgtree)/.build
	$(call cmd,stamp)

$(pkgtree)/version.mk: $(pkgtree)/build/include/version_autogenerated.h
	grep U_BOOT_VERSION $< | sed 's,[^"]*"U-Boot \([^"]*\)",VERSION=\1,' > $@

$(pkgtree)/build/include/version_autogenerated.h: $(pkgtree)/.configure
	cd $(pkgbuildtree) && \
		$(env) $(MAKE) $(make-args) $@

include packages/cleanup.mk
include packages/binary.mk
