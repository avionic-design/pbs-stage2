PACKAGE = u-boot
VERSION = git

GIT_URL      = git://git.adnet.avionic-design.de/kernel/u-boot-adx.git
GIT_CHECKOUT = $(CONFIG_U_BOOT_BRANCH)

ifeq ($(CONFIG_U_BOOT_BOARD),)
$(error CONFIG_U_BOOT_BOARD is not defined!)
endif

CONFIG_U_BOOT_BOARD:=$(subst $(quote),,$(CONFIG_U_BOOT_BOARD))

pkgbuildtree := $(pkgbuildtree)
include packages/common.mk
-include $(pkgtree)/version.mk

make-args = \
	O=$(pkgtree)/build \
	CROSS_COMPILE=$(CROSS_COMPILE) \
	SYSROOT=$(SYSROOT)

$(pkgtree)/.setup:
	$(call cmd,stamp)

$(pkgtree)/.configure: $(pkgtree)/.patch
	mkdir -p $(pkgtree)/build && cd $(pkgbuildtree) && \
		$(env) $(MAKE) $(make-args) $(CONFIG_U_BOOT_BOARD)_config
	$(call cmd,stamp)

$(pkgtree)/.build: $(pkgtree)/.configure
	cd $(pkgbuildtree) && \
		$(env) $(MAKE) $(make-args)
	$(call cmd,stamp)

extrabin := \
	tools/$(ARCH)/mkimage \
	tools/imls/imls \
	tools/env/fw_printenv \

extralink := \
	tools/env/fw_setenv \


built-extrabin  = $(wildcard $(addprefix $(pkgtree)/build/,$(extrabin)))
built-extralink = $(wildcard $(addprefix $(pkgtree)/build/,$(extralink)))
built-extra     = $(built-extrabin) $(built-extralink)

$(pkgtree)/build/u-boot.bin: $(pkgtree)/.build

$(pkgtree)/install/boot/u-boot-$(VERSION).bin: $(pkgtree)/build/u-boot.bin
	@rm -f $(pkgtree)/install/boot/u-boot-*.bin
	$(call cmd,install)

quiet_cmd_install_extra = INSTALL $(notdir $(built-extra))
      cmd_install_extra = \
	mkdir -p $(pkgtree)/install/$(prefix)/bin ; \
	for bin in $(built-extrabin) ; do \
	    $(priv) install -m 755 -o root -g root $$bin $(pkgtree)/install/$(prefix)/bin/ ; \
	done ; \
	for bin in $(built-extralink) ; do \
	    $(priv) cp -d $$bin $(pkgtree)/install/$(prefix)/bin ; \
	done

$(pkgtree)/.do-install: $(pkgtree)/install/boot/u-boot-$(VERSION).bin
	$(if $(built-extra),$(call cmd,install_extra))
	$(call cmd,stamp)

$(pkgtree)/version.mk: $(pkgtree)/build/include/version_autogenerated.h
	grep U_BOOT_VERSION $< | sed 's,[^"]*"U-Boot \([^"]*\)",VERSION=\1,' > $@

$(pkgtree)/build/include/version_autogenerated.h: $(pkgtree)/.configure
	cd $(pkgbuildtree) && \
		$(env) $(MAKE) $(make-args) $@
	touch $@

include packages/cleanup.mk
include packages/binary.mk
