#!/bin/sh

PATH=/sbin:/bin:/usr/bin:/usr/sbin
export PATH

. /scripts/functions

echo "Loading, please wait ..."

# create needed directories
[ -d /dev  ] || mkdir -m 0755 /dev
[ -d /root ] || mkdir -m 0700 /root
[ -d /sys  ] || mkdir         /sys
[ -d /proc ] || mkdir         /proc
[ -d /tmp  ] || mkdir         /tmp

mkdir -p /var/lock

# mount virtual filesystems
log_begin_msg "Mounting virtual filesystems ..."
mount -o nodev,noexec,nosuid -t sysfs  none /sys
mount -o nodev,noexec,nosuid -t procfs none /proc
mount -o nodev,noexec,nosuid -t udev   udev /dev
#mount -o size=10M,mode=0755  -t tmpfs  udev /dev
log_end_msg

# create needed devices
log_begin_msg "Creating devices ..."
[ -e /dev/console ] || mknod /dev/console c 5 1
[ -e /dev/null    ] || mknod /dev/null    c 1 3
log_end_msg

rootmnt=/root
init=/sbin/init

run_scripts /scripts/init-top

run_scripts /scripts/init-premount

#log_begin_msg "Waiting for /dev/mmcblk0 ..."
#while [ ! -e /dev/mmcblk0 ]; do
#	sleep 1
#	echo -n .
#done
#log_end_msg

# mount target root filesystem
log_begin_msg "Mounting root filesystem: ${rootmnt} ..."
mkdir -p /media/sd-card
mount /dev/mmcblk0 /media/sd-card
mount /media/sd-card/rootfs.img ${rootmnt}
log_end_msg

log_begin_msg "Root filesystem: ${rootmnt}"
ls -l ${rootmnt}
log_end_msg

# move virtual filesystems over to the real filesystem
mount -o move /sys  ${rootmnt}/sys
mount -o move /proc ${rootmnt}/proc

# check for init in target filesystem
while [ ! -x ${rootmnt}${init} ]; do
	panic "Target filesystem doesn't have ${init}"
done

exec run-init -c ${rootmnt}/dev/console ${rootmnt} ${init} "$@"

