From 780be0063612994bb25e57c6a6efb3eacf49ddf0 Mon Sep 17 00:00:00 2001
From: Soeren Grunewald <soeren.grunewald@avionic-design.de>
Date: Fri, 12 Apr 2013 11:54:04 +0200
Subject: [PATCH 2/3] Rebase to 2013-03-10

Commit id is 4d86a1f050fb1b0fb3ff274ac2df9a966c709385.

This excludes docs directory
---
 HACKING                             |  274 +++++
 Makefile.in                         |  261 +++--
 RELEASE                             |   93 ++
 aclocal.m4                          |  430 ++++----
 autoregen.sh                        |    2 +
 config.h.in                         |   31 +-
 configure                           |  999 ++++++++++--------
 configure.ac                        |   24 +-
 ext/Makefile.in                     |  168 +--
 ext/ffmpeg/Makefile.am              |    5 +-
 ext/ffmpeg/Makefile.in              |  243 +++--
 ext/ffmpeg/gstffmpeg.c              |    6 +-
 ext/ffmpeg/gstffmpeg.h              |    6 +-
 ext/ffmpeg/gstffmpegaudioresample.c |    6 +-
 ext/ffmpeg/gstffmpegcfg.c           |   40 +-
 ext/ffmpeg/gstffmpegcfg.h           |    8 +-
 ext/ffmpeg/gstffmpegcodecmap.c      |  604 +++++++----
 ext/ffmpeg/gstffmpegcodecmap.h      |   10 +-
 ext/ffmpeg/gstffmpegdec.c           | 1989 +++--------------------------------
 ext/ffmpeg/gstffmpegdeinterlace.c   |    6 +-
 ext/ffmpeg/gstffmpegdemux.c         |    4 +-
 ext/ffmpeg/gstffmpegenc.c           | 1015 ++++--------------
 ext/ffmpeg/gstffmpegenc.h           |   57 +-
 ext/ffmpeg/gstffmpegmux.c           |   39 +-
 ext/ffmpeg/gstffmpegscale.c         |  403 +++++++
 ext/ffmpeg/gstffmpegutils.c         |    2 +-
 ext/ffmpeg/gstffmpegutils.h         |    6 +
 ext/ffmpeg/gstffmpegviddec.c        | 1632 ++++++++++++++++++++++++++++
 ext/ffmpeg/gstffmpegvidenc.c        |  988 +++++++++++++++++
 ext/ffmpeg/gstffmpegvidenc.h        |   95 ++
 ext/libpostproc/Makefile.in         |  171 ++-
 ext/libpostproc/gstpostproc.c       |   12 +-
 ext/libswscale/Makefile.in          |  171 ++-
 ext/libswscale/gstffmpegscale.c     |   11 +-
 gst-ffmpeg.spec                     |   72 --
 gst-libs/Makefile.in                |  168 +--
 gst-libs/ext/Makefile.in            |  158 +--
 ltmain.sh                           |   91 +-
 m4/as-slurp-ffmpeg.m4               |   59 ++
 m4/libtool.m4                       |  337 ++++--
 m4/ltoptions.m4                     |   19 +-
 m4/ltversion.m4                     |   10 +-
 tests/Makefile.in                   |  168 +--
 tests/check/Makefile.am             |    6 +-
 tests/check/Makefile.in             |  233 ++--
 tests/files/Makefile.in             |   65 +-
 46 files changed, 6702 insertions(+), 4495 deletions(-)
 create mode 100644 HACKING
 create mode 100644 RELEASE
 create mode 100755 autoregen.sh
 create mode 100644 ext/ffmpeg/gstffmpegscale.c
 create mode 100644 ext/ffmpeg/gstffmpegviddec.c
 create mode 100644 ext/ffmpeg/gstffmpegvidenc.c
 create mode 100644 ext/ffmpeg/gstffmpegvidenc.h
 delete mode 100644 gst-ffmpeg.spec
 mode change 100755 => 100644 ltmain.sh
 create mode 100644 m4/as-slurp-ffmpeg.m4

diff --git a/HACKING b/HACKING
new file mode 100644
index 0000000..da13515
--- /dev/null
+++ b/HACKING
@@ -0,0 +1,274 @@
+THE GOAL
+--------
+What we are trying to achieve:
+
+satisfy:
+  patching of CVS checkout using our patch files placed in our CVS
+
+  passing of
+    make
+    make distcheck
+    non-srcdir build (ie, mkdir build; cd build; ../configure; make)
+
+THE SETUP
+---------
+There is a "mirror" root CVS module that contains "ffmpeg".
+This directory contains a vendor-branch checkout of upstream FFmpeg CVS
+of a given day.
+
+On head, the following things have been commited on top of this:
+* patches/, which is a directory with a set of patches, and a series file
+  listing the order, as generated by quilt
+* the result of having all these patches commited (ie, quilt push -a) to the
+  ffmpeg tree.
+
+The patched CVS ffmpeg code needs to be commited to CVS so that a checkout 
+gives the patched code
+
+The Quilt state .pc hidden directory must NOT be committed to CVS, because 
+having CVS subdirs inside it confuses the hell out of quilt and causes it to
+start storing diffs against CVS Entries files, and all hell breaks loose
+
+THE WARNING
+-----------
+
+***
+
+NEVER EVER commit stuff in gst-libs/ext/ffmpeg UNLESS your quilt stack is
+completely applied !
+This means, ALWAYS make sure quilt push -a has been run without problems.
+
+What's more, if you want to be on the safe side, make sure that you can
+unapply and reapply without problems, by running quilt pop -a then
+quilt push -a.
+
+The ONLY exception to this is when you're working on a branch to update
+the upstream source you're working with.
+
+***
+
+THE WAY
+-------
+- If you want to hack on our copy of the FFmpeg code, there are some basic
+  rules you need to respect:
+  - you need to use quilt.  If you don't use quilt, you can't hack on it.
+  - we separate patches based on the functionality they patch, and whether
+    or not we want to send stuff upstream.  Make sure you work in the right
+    patch.  use "quilt applied" to check which patches are applied.
+  - before starting to hack, run cvs diff.  There should be NO diffs, and
+    NO files listed with question mark.  If there are, somebody before you
+    probably made a mistake.  To manage the state correctly, it is vital that
+    none of the files are unknown to CVS.
+
+FIRST TIME:
+  - The quilt state is kept in a hidden dir in the gst-libs/ext/ffmpeg dir, 
+    but this hidden dir can't be kept in CVS because it confuses patch. Hence
+    when you get a clean gst-ffmpeg checkout you have an ffmpeg tree with
+    patches applied, but no quilt metadata to modify it with.
+
+  - You need to create the quilt metadata in your checkout:
+    1) Unroll the quilt patches. In gst-libs/ext/ffmpeg, run:
+
+       tac patches/series | while read p; do patch -p1 -R < "patches/$p"; done
+
+    2) Now, push all the patches to quilt and it will apply them, but now with
+       the appropriate stored metadata:
+
+       quilt push -a
+
+- if you want to add a file to a patchset, you need to:
+  - be in the right patchset
+  - quilt add (file)
+  - cvs add .pc/(patchsetname)/(file)
+  - cvs commit .pc/(patchsetname) (to update the state of quilt in cvs)
+  - edit the file
+  - cvs add the file if it doesn't exist yet
+  - quilt refresh
+  - quilt push -a (This one is IMPORTANT, otherwise you'll have a huge diff)
+  - cvs commit
+
+- if you want to add a patchset, you need to:
+  - go over the procedure with thomas to check it's correct
+  - decide where in the stack to put it.  ask for help if you don't know.
+  - go there in the patch stack (use quilt pop/push)
+  - quilt new (patchsetname).patch (don't forget .patch !)
+  - quilt add (files)
+  - cvs add .pc/(patchsetname) the whole tree
+  - cvs commit .pc/(patchsetname)
+  - quilt refresh
+  - quilt push -a
+  - cvs commit
+  - cvs diff (to check if any of the files are unknown to CVS; if they are,
+    you need to add them to CVS)
+
+THE UPSTREAM
+------------
+At some points you want to update the upstream snapshot code to a newer date.
+This is easy if you follow the steps outlined here, but make sure to follow
+them correctly !
+
+- find a good CVS snapshot date for upstream, one that is known to work.
+  You're going to save yourself quite a bit of trouble if you verify this
+  first !
+- check it out to a local directory:
+  cvs -z9 -d:pserver:anonymous@mplayerhq.hu:/cvsroot/ffmpeg export -D '2004-04-11 23:00 GMT' ffmpeg
+- compile it and test it, make sure it works
+
+- in gst-ffmpeg/gst-libs/ext/ffmpeg:
+  - Pre-flight checks:
+    - first make sure you don't have local changes, all files are either in
+      CVS or in .cvsignore patch, the whole quilt stack is applied, and stuff
+      works.
+    - do a quilt pop -a and quilt push -a to verify everything is ok.
+
+  - Branch and rollback:
+    - tag HEAD with the branch root point:
+      cvs tag BRANCH-UPDATE-CVS-2004-04-11-23-00-ROOT
+    - branch:
+      cvs tag -b BRANCH-UPDATE-CVS-2004-04-11-23-00
+    - FIXME: lock cvs HEAD
+    - update local copy to branch:
+      cvs update -r BRANCH-UPDATE-CVS-2004-04-11-23-00
+    - peel off all patches:
+      quilt pop -a
+    - commit this
+      cvs commit
+    - check
+      cvs diff
+      you should only have ? for files that are generated somehow (binaries,
+      build files, ...)
+      you get warnings about cvs not finding files to diff that are in .pc
+      or generated by your patches
+
+  
+    - if you want, you can now compare this state of CVS (which should 
+      be last upstream CVS combined with your local unapplied quilt state)
+    - remember to NOT do cvs update from here on, since you popped your quilt
+      state all your added files that are also in CVS are not locally present.
+
+  - sync with upstream:
+    - in a temp dir, redo the export:
+      cd ..
+      mkdir tmp
+      cd tmp
+      cvs -z9 -d:pserver:anonymous@mplayerhq.hu:/cvsroot/ffmpeg export -D '2004-04-11 23:00 GMT' ffmpeg
+    - rsync it over the old ffmpeg tree
+      rsync -arv ffmpeg ..
+    - go back and commit this new snapshot
+      cd ../ffmpeg
+      cvs commit
+    - check if any new files got added that you should add to cvs
+      cvs diff
+      This will list a lot of local files missing, from your quilt state,
+      which you shouldn't worry about.  Just inspect all the ?'s and add
+      files to cvs that belong to upstream and should be in cvs.
+    - if everything's ok and commited, tag the state:
+      cvs tag UPSTREAM-CVS-2004-04-11-23-00
+
+  - reapply and fix quilt patches one by one
+    - try applying one
+      quilt push
+    - if that didn't work, inspect the patch and figure out how to fix it:
+      - if the patch got applied upstream completely, quilt push will tell
+        you the patch looks like a reverse patch.  In that case you can
+        remove the patch from your patches file (patches/series), and
+        remove the .pc/$(patchname) and patches/$(patchname).patch files from
+        cvs.
+      - if the patch conflicts somehow, you can force application with
+        quilt push -f
+        and then resolve all the rejects, and fix the patch completely.
+        Then refresh quilt state with 
+        quilt refresh
+     - when the patch is succesfully removed or reworked, commit current state
+       to CVS, then check again if nothing is missing using cvs diff, and
+       resolve problems/apply missing files from your quilt state/...
+
+  - after reapplying your complete quilt state, test locally if the complete
+    gst-ffmpeg module now works.  Compile and test.  Resolve all problems
+    (upstream errors, missing symbols, missing files, ...) until you have
+    a working module.  commit again.
+
+  - merge to head:
+    - update locally back to head
+      cvs update -A
+    - FIXME: unlock cvs HEAD
+    - merge from your branch
+      cvs update -j BRANCH-UPDATE-CVS-2004-04-11-23-00
+    - commit
+      cvs commit
+    - check for diffs
+      cvs diff
+    - tag merge point
+      cvs tag BRANCH-UPDATE-CVS-2004-04-11-23-00-MERGE
+    - add upstream date to "THE RECORDS" below
+
+  - get a drink
+
+THE PLUGIN
+----------
+Some notes on how ffmpeg wrapping inside GStreamer currently works:
+* gstffmpeg{dec,enc,demux,mux}.c are wrappers for specific element types from
+    their ffmpeg counterpart. If you want to wrap a new type of element in
+    wrapper file.
+    The ffmpeg element types, define a whole *list* of elements (in 
+    GStreamer, each decoder etc. needs to be its own element). 
+    We use a set of tricks for that to keep coding simple: codec 
+    mapping and dynamic type creation.
+
+* ffmpeg uses CODEC_ID_* enumerations for their codecs. GStreamer uses caps,
+    which consists of a mimetype and a defined set of properties. In ffmpeg,
+    these properties live in a AVCodecContext struct, which contains anything
+    that could configure any codec (which makes it rather messy, but ohwell).
+    To convert from one to the other, we use codec mapping, which is done in
+    gstffmpegcodecmap.[ch]. This is the most important file in the whole
+    ffmpeg wrapping process! It contains functions to go from a codec type
+    (video or audio - used as the output format for decoding or the input
+    format for encoding), a codec id (to identify each format) or a format id
+    (a string identifying a file format - usually the file format extension)
+    to a GstCaps, and the other way around.
+
+* to define multiple elements in one source file (which all behave similarly),
+    we dynamically create types for each plugin and let all of them operate on
+    the same struct (GstFFMpegDec, GstFFMpegEnc, ...). The functions in
+    gstffmpeg{dec,enc,demux,mux}.c called gst_ffmpeg*_register() do this.
+    The magic is as follows: for each codec or format, ffmpeg has a single
+    AVCodec or AV{Input,Output}Format, which are packed together in a list of
+    supported codecs/formats. We simply walk through the list, for each of
+    those, we check whether gstffmpegcodecmap.c knows about this single one.
+    If it does, we get the GstCaps for each pad template that belongs to it,
+    and register a type for all of those together. We also leave this inside
+    a caching struct, that will later be used by the base_init() function to
+    fill in information about this specific codec in the class struct of this
+    element (pad templates and codec/format information). Since the actual
+    codec information is the only thing that really makes each codec/format
+    different (they all behave the same through the ffmpeg API), we don't
+    really need to do anything else that is codec-specific, so all other
+    functions are rather simple.
+
+* one particular thing that needs mention is how gstffmpeg{mux,demux}.c and
+    gstffmpegprotocol.c interoperate. ffmpeg uses URLProtocols for data input
+    and output. Now, of course, we want to use the *GStreamer* way of doing
+    input and output (filesrc, ...) rather than the ffmpeg way. Therefore, we
+    wrap up a GstPad as a URLProtocol and register this with ffmpeg. This is
+    what gstffmpegprotocol.c does. The URL is called gstreamer://%p, where %p
+    is the address of a GstPad. gstffmpeg{mux,demux}.c then open a file called
+    gstreamer://%p, with %p being their source/sink pad, respectively. This
+    way, we use GStreamer for data input/output through the ffmpeg API. It's
+    rather ugly, but it has worked quite well so far.
+
+* there's lots of things that still need doing. See the TODO file for more
+    information.
+
+THE RECORDS
+-----------
+- list of snapshots used:
+
+  CVS-2004-04-11-23-00
+  * other updates people didn't enter :)
+  CVS-2006-02-17-04-00
+
+THE REMINDERS
+-------------
+* the initial ffmpeg checkout was imported using:
+  - get CVS ffmpeg
+    cvs -z3 -d:pserver:anonymous@mplayerhq.hu:/cvsroot/ffmpeg co -D '2004-03-09 06:00 GMT' ffmpeg
diff --git a/Makefile.in b/Makefile.in
index a6ff280..ceb89c2 100644
--- a/Makefile.in
+++ b/Makefile.in
@@ -1,9 +1,8 @@
-# Makefile.in generated by automake 1.11.1 from Makefile.am.
+# Makefile.in generated by automake 1.12.6 from Makefile.am.
 # @configure_input@
 
-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
-# Inc.
+# Copyright (C) 1994-2012 Free Software Foundation, Inc.
+
 # This Makefile.in is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
@@ -26,6 +25,23 @@
 #
 # set CRUFT_FILES and/or CRUFT_DIRS in your Makefile.am when you include this
 VPATH = @srcdir@
+am__make_dryrun = \
+  { \
+    am__dry=no; \
+    case $$MAKEFLAGS in \
+      *\\[\ \	]*) \
+        echo 'am--echo: ; @echo "AM"  OK' | $(MAKE) -f - 2>/dev/null \
+          | grep '^AM OK$$' >/dev/null || am__dry=yes;; \
+      *) \
+        for am__flg in $$MAKEFLAGS; do \
+          case $$am__flg in \
+            *=*|--*) ;; \
+            *n*) am__dry=yes; break;; \
+          esac; \
+        done;; \
+    esac; \
+    test $$am__dry = yes; \
+  }
 pkgdatadir = $(datadir)/@PACKAGE@
 pkgincludedir = $(includedir)/@PACKAGE@
 pkglibdir = $(libdir)/@PACKAGE@
@@ -44,6 +60,7 @@ PRE_UNINSTALL = :
 POST_UNINSTALL = :
 build_triplet = @build@
 host_triplet = @host@
+target_triplet = @target@
 DIST_COMMON = README $(am__configure_deps) $(srcdir)/Makefile.am \
 	$(srcdir)/Makefile.in $(srcdir)/config.h.in \
 	$(srcdir)/gst-ffmpeg.spec.in $(top_srcdir)/common/cruft.mak \
@@ -82,12 +99,18 @@ mkinstalldirs = $(install_sh) -d
 CONFIG_HEADER = config.h
 CONFIG_CLEAN_FILES = gst-ffmpeg.spec
 CONFIG_CLEAN_VPATH_FILES =
-AM_V_GEN = $(am__v_GEN_$(V))
-am__v_GEN_ = $(am__v_GEN_$(AM_DEFAULT_VERBOSITY))
-am__v_GEN_0 = @echo "  GEN   " $@;
-AM_V_at = $(am__v_at_$(V))
-am__v_at_ = $(am__v_at_$(AM_DEFAULT_VERBOSITY))
+AM_V_P = $(am__v_P_@AM_V@)
+am__v_P_ = $(am__v_P_@AM_DEFAULT_V@)
+am__v_P_0 = false
+am__v_P_1 = :
+AM_V_GEN = $(am__v_GEN_@AM_V@)
+am__v_GEN_ = $(am__v_GEN_@AM_DEFAULT_V@)
+am__v_GEN_0 = @echo "  GEN     " $@;
+am__v_GEN_1 = 
+AM_V_at = $(am__v_at_@AM_V@)
+am__v_at_ = $(am__v_at_@AM_DEFAULT_V@)
 am__v_at_0 = @
+am__v_at_1 = 
 SOURCES =
 DIST_SOURCES =
 RECURSIVE_TARGETS = all-recursive check-recursive dvi-recursive \
@@ -97,20 +120,29 @@ RECURSIVE_TARGETS = all-recursive check-recursive dvi-recursive \
 	install-pdf-recursive install-ps-recursive install-recursive \
 	installcheck-recursive installdirs-recursive pdf-recursive \
 	ps-recursive uninstall-recursive
+am__can_run_installinfo = \
+  case $$AM_UPDATE_INFO_DIR in \
+    n|no|NO) false;; \
+    *) (install-info --version) >/dev/null 2>&1;; \
+  esac
 RECURSIVE_CLEAN_TARGETS = mostlyclean-recursive clean-recursive	\
   distclean-recursive maintainer-clean-recursive
 AM_RECURSIVE_TARGETS = $(RECURSIVE_TARGETS:-recursive=) \
 	$(RECURSIVE_CLEAN_TARGETS:-recursive=) tags TAGS ctags CTAGS \
-	distdir dist dist-all distcheck
+	cscope distdir dist dist-all distcheck
 ETAGS = etags
 CTAGS = ctags
+CSCOPE = cscope
 DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
 distdir = $(PACKAGE)-$(VERSION)
 top_distdir = $(distdir)
 am__remove_distdir = \
-  { test ! -d "$(distdir)" \
-    || { find "$(distdir)" -type d ! -perm -200 -exec chmod u+w {} ';' \
-         && rm -fr "$(distdir)"; }; }
+  if test -d "$(distdir)"; then \
+    find "$(distdir)" -type d ! -perm -200 -exec chmod u+w {} ';' \
+      && rm -rf "$(distdir)" \
+      || { sleep 5 && rm -rf "$(distdir)"; }; \
+  else :; fi
+am__post_remove_distdir = $(am__remove_distdir)
 am__relativize = \
   dir0=`pwd`; \
   sed_first='s,^\([^/]*\)/.*$$,\1,'; \
@@ -138,7 +170,10 @@ am__relativize = \
   reldir="$$dir2"
 DIST_ARCHIVES = $(distdir).tar.gz $(distdir).tar.bz2
 GZIP_ENV = --best
+DIST_TARGETS = dist-bzip2 dist-gzip
 distuninstallcheck_listfiles = find . -type f -print
+am__distuninstallcheck_listfiles = $(distuninstallcheck_listfiles) \
+  | sed 's|^\./|$(prefix)/|' | grep -v '$(infodir)/dir$$'
 distcleancheck_listfiles = find . -type f -print
 ACLOCAL = @ACLOCAL@
 ACLOCAL_AMFLAGS = -I m4 -I common/m4
@@ -333,7 +368,11 @@ sbindir = @sbindir@
 sharedstatedir = @sharedstatedir@
 srcdir = @srcdir@
 sysconfdir = @sysconfdir@
+target = @target@
 target_alias = @target_alias@
+target_cpu = @target_cpu@
+target_os = @target_os@
+target_vendor = @target_vendor@
 top_build_prefix = @top_build_prefix@
 top_builddir = @top_builddir@
 top_srcdir = @top_srcdir@
@@ -375,7 +414,7 @@ all: config.h
 	$(MAKE) $(AM_MAKEFLAGS) all-recursive
 
 .SUFFIXES:
-am--refresh:
+am--refresh: Makefile
 	@:
 $(srcdir)/Makefile.in: @MAINTAINER_MODE_TRUE@ $(srcdir)/Makefile.am $(top_srcdir)/common/win32.mak $(top_srcdir)/common/release.mak $(top_srcdir)/common/cruft.mak $(am__configure_deps)
 	@for dep in $?; do \
@@ -400,6 +439,7 @@ Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
 	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $@ $(am__depfiles_maybe)'; \
 	    cd $(top_builddir) && $(SHELL) ./config.status $@ $(am__depfiles_maybe);; \
 	esac;
+$(top_srcdir)/common/win32.mak $(top_srcdir)/common/release.mak $(top_srcdir)/common/cruft.mak:
 
 $(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
 	$(SHELL) ./config.status --recheck
@@ -411,10 +451,8 @@ $(ACLOCAL_M4): @MAINTAINER_MODE_TRUE@ $(am__aclocal_m4_deps)
 $(am__aclocal_m4_deps):
 
 config.h: stamp-h1
-	@if test ! -f $@; then \
-	  rm -f stamp-h1; \
-	  $(MAKE) $(AM_MAKEFLAGS) stamp-h1; \
-	else :; fi
+	@if test ! -f $@; then rm -f stamp-h1; else :; fi
+	@if test ! -f $@; then $(MAKE) $(AM_MAKEFLAGS) stamp-h1; else :; fi
 
 stamp-h1: $(srcdir)/config.h.in $(top_builddir)/config.status
 	@rm -f stamp-h1
@@ -439,12 +477,12 @@ distclean-libtool:
 	-rm -f libtool config.lt
 
 # This directory's subdirectories are mostly independent; you can cd
-# into them and run `make' without going through this Makefile.
-# To change the values of `make' variables: instead of editing Makefiles,
-# (1) if the variable is set in `config.status', edit `config.status'
-#     (which will cause the Makefiles to be regenerated when you run `make');
-# (2) otherwise, pass the desired values on the `make' command line.
-$(RECURSIVE_TARGETS):
+# into them and run 'make' without going through this Makefile.
+# To change the values of 'make' variables: instead of editing Makefiles,
+# (1) if the variable is set in 'config.status', edit 'config.status'
+#     (which will cause the Makefiles to be regenerated when you run 'make');
+# (2) otherwise, pass the desired values on the 'make' command line.
+$(RECURSIVE_TARGETS) $(RECURSIVE_CLEAN_TARGETS):
 	@fail= failcom='exit 1'; \
 	for f in x $$MAKEFLAGS; do \
 	  case $$f in \
@@ -454,7 +492,11 @@ $(RECURSIVE_TARGETS):
 	done; \
 	dot_seen=no; \
 	target=`echo $@ | sed s/-recursive//`; \
-	list='$(SUBDIRS)'; for subdir in $$list; do \
+	case "$@" in \
+	  distclean-* | maintainer-clean-*) list='$(DIST_SUBDIRS)' ;; \
+	  *) list='$(SUBDIRS)' ;; \
+	esac; \
+	for subdir in $$list; do \
 	  echo "Making $$target in $$subdir"; \
 	  if test "$$subdir" = "."; then \
 	    dot_seen=yes; \
@@ -468,37 +510,6 @@ $(RECURSIVE_TARGETS):
 	if test "$$dot_seen" = "no"; then \
 	  $(MAKE) $(AM_MAKEFLAGS) "$$target-am" || exit 1; \
 	fi; test -z "$$fail"
-
-$(RECURSIVE_CLEAN_TARGETS):
-	@fail= failcom='exit 1'; \
-	for f in x $$MAKEFLAGS; do \
-	  case $$f in \
-	    *=* | --[!k]*);; \
-	    *k*) failcom='fail=yes';; \
-	  esac; \
-	done; \
-	dot_seen=no; \
-	case "$@" in \
-	  distclean-* | maintainer-clean-*) list='$(DIST_SUBDIRS)' ;; \
-	  *) list='$(SUBDIRS)' ;; \
-	esac; \
-	rev=''; for subdir in $$list; do \
-	  if test "$$subdir" = "."; then :; else \
-	    rev="$$subdir $$rev"; \
-	  fi; \
-	done; \
-	rev="$$rev ."; \
-	target=`echo $@ | sed s/-recursive//`; \
-	for subdir in $$rev; do \
-	  echo "Making $$target in $$subdir"; \
-	  if test "$$subdir" = "."; then \
-	    local_target="$$target-am"; \
-	  else \
-	    local_target="$$target"; \
-	  fi; \
-	  ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) $$local_target) \
-	  || eval $$failcom; \
-	done && test -z "$$fail"
 tags-recursive:
 	list='$(SUBDIRS)'; for subdir in $$list; do \
 	  test "$$subdir" = . || ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) tags); \
@@ -507,6 +518,10 @@ ctags-recursive:
 	list='$(SUBDIRS)'; for subdir in $$list; do \
 	  test "$$subdir" = . || ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) ctags); \
 	done
+cscopelist-recursive:
+	list='$(SUBDIRS)'; for subdir in $$list; do \
+	  test "$$subdir" = . || ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) cscopelist); \
+	done
 
 ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
 	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
@@ -570,8 +585,32 @@ GTAGS:
 	  && $(am__cd) $(top_srcdir) \
 	  && gtags -i $(GTAGS_ARGS) "$$here"
 
+cscope: cscope.files
+	test ! -s cscope.files \
+	  || $(CSCOPE) -b -q $(AM_CSCOPEFLAGS) $(CSCOPEFLAGS) -i cscope.files $(CSCOPE_ARGS)
+
+clean-cscope:
+	-rm -f cscope.files
+
+cscope.files: clean-cscope cscopelist-recursive cscopelist
+
+cscopelist: cscopelist-recursive $(HEADERS) $(SOURCES) $(LISP)
+	list='$(SOURCES) $(HEADERS) $(LISP)'; \
+	case "$(srcdir)" in \
+	  [\\/]* | ?:[\\/]*) sdir="$(srcdir)" ;; \
+	  *) sdir=$(subdir)/$(srcdir) ;; \
+	esac; \
+	for i in $$list; do \
+	  if test -f "$$i"; then \
+	    echo "$(subdir)/$$i"; \
+	  else \
+	    echo "$$sdir/$$i"; \
+	  fi; \
+	done >> $(top_builddir)/cscope.files
+
 distclean-tags:
 	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
+	-rm -f cscope.out cscope.in.out cscope.po.out cscope.files
 
 distdir: $(DISTFILES)
 	$(am__remove_distdir)
@@ -607,13 +646,10 @@ distdir: $(DISTFILES)
 	done
 	@list='$(DIST_SUBDIRS)'; for subdir in $$list; do \
 	  if test "$$subdir" = .; then :; else \
-	    test -d "$(distdir)/$$subdir" \
-	    || $(MKDIR_P) "$(distdir)/$$subdir" \
-	    || exit 1; \
-	  fi; \
-	done
-	@list='$(DIST_SUBDIRS)'; for subdir in $$list; do \
-	  if test "$$subdir" = .; then :; else \
+	    $(am__make_dryrun) \
+	      || test -d "$(distdir)/$$subdir" \
+	      || $(MKDIR_P) "$(distdir)/$$subdir" \
+	      || exit 1; \
 	    dir1=$$subdir; dir2="$(distdir)/$$subdir"; \
 	    $(am__relativize); \
 	    new_distdir=$$reldir; \
@@ -645,36 +681,35 @@ distdir: $(DISTFILES)
 	|| chmod -R a+r "$(distdir)"
 dist-gzip: distdir
 	tardir=$(distdir) && $(am__tar) | GZIP=$(GZIP_ENV) gzip -c >$(distdir).tar.gz
-	$(am__remove_distdir)
+	$(am__post_remove_distdir)
 dist-bzip2: distdir
-	tardir=$(distdir) && $(am__tar) | bzip2 -9 -c >$(distdir).tar.bz2
-	$(am__remove_distdir)
+	tardir=$(distdir) && $(am__tar) | BZIP2=$${BZIP2--9} bzip2 -c >$(distdir).tar.bz2
+	$(am__post_remove_distdir)
 
-dist-lzma: distdir
-	tardir=$(distdir) && $(am__tar) | lzma -9 -c >$(distdir).tar.lzma
-	$(am__remove_distdir)
+dist-lzip: distdir
+	tardir=$(distdir) && $(am__tar) | lzip -c $${LZIP_OPT--9} >$(distdir).tar.lz
+	$(am__post_remove_distdir)
 
 dist-xz: distdir
-	tardir=$(distdir) && $(am__tar) | xz -c >$(distdir).tar.xz
-	$(am__remove_distdir)
+	tardir=$(distdir) && $(am__tar) | XZ_OPT=$${XZ_OPT--e} xz -c >$(distdir).tar.xz
+	$(am__post_remove_distdir)
 
 dist-tarZ: distdir
 	tardir=$(distdir) && $(am__tar) | compress -c >$(distdir).tar.Z
-	$(am__remove_distdir)
+	$(am__post_remove_distdir)
 
 dist-shar: distdir
 	shar $(distdir) | GZIP=$(GZIP_ENV) gzip -c >$(distdir).shar.gz
-	$(am__remove_distdir)
+	$(am__post_remove_distdir)
 
 dist-zip: distdir
 	-rm -f $(distdir).zip
 	zip -rq $(distdir).zip $(distdir)
-	$(am__remove_distdir)
+	$(am__post_remove_distdir)
 
-dist dist-all: distdir
-	tardir=$(distdir) && $(am__tar) | GZIP=$(GZIP_ENV) gzip -c >$(distdir).tar.gz
-	tardir=$(distdir) && $(am__tar) | bzip2 -9 -c >$(distdir).tar.bz2
-	$(am__remove_distdir)
+dist dist-all:
+	$(MAKE) $(AM_MAKEFLAGS) $(DIST_TARGETS) am__post_remove_distdir='@:'
+	$(am__post_remove_distdir)
 
 # This target untars the dist file and tries a VPATH configuration.  Then
 # it guarantees that the distribution is self-contained by making another
@@ -685,8 +720,8 @@ distcheck: dist
 	  GZIP=$(GZIP_ENV) gzip -dc $(distdir).tar.gz | $(am__untar) ;;\
 	*.tar.bz2*) \
 	  bzip2 -dc $(distdir).tar.bz2 | $(am__untar) ;;\
-	*.tar.lzma*) \
-	  lzma -dc $(distdir).tar.lzma | $(am__untar) ;;\
+	*.tar.lz*) \
+	  lzip -dc $(distdir).tar.lz | $(am__untar) ;;\
 	*.tar.xz*) \
 	  xz -dc $(distdir).tar.xz | $(am__untar) ;;\
 	*.tar.Z*) \
@@ -696,9 +731,9 @@ distcheck: dist
 	*.zip*) \
 	  unzip $(distdir).zip ;;\
 	esac
-	chmod -R a-w $(distdir); chmod a+w $(distdir)
-	mkdir $(distdir)/_build
-	mkdir $(distdir)/_inst
+	chmod -R a-w $(distdir)
+	chmod u+w $(distdir)
+	mkdir $(distdir)/_build $(distdir)/_inst
 	chmod a-w $(distdir)
 	test -d $(distdir)/_build || exit 0; \
 	dc_install_base=`$(am__cd) $(distdir)/_inst && pwd | sed -e 's,^[^:\\/]:[\\/],/,'` \
@@ -707,6 +742,7 @@ distcheck: dist
 	  && am__cwd=`pwd` \
 	  && $(am__cd) $(distdir)/_build \
 	  && ../configure --srcdir=.. --prefix="$$dc_install_base" \
+	    $(AM_DISTCHECK_CONFIGURE_FLAGS) \
 	    $(DISTCHECK_CONFIGURE_FLAGS) \
 	  && $(MAKE) $(AM_MAKEFLAGS) \
 	  && $(MAKE) $(AM_MAKEFLAGS) dvi \
@@ -730,13 +766,21 @@ distcheck: dist
 	  && $(MAKE) $(AM_MAKEFLAGS) distcleancheck \
 	  && cd "$$am__cwd" \
 	  || exit 1
-	$(am__remove_distdir)
+	$(am__post_remove_distdir)
 	@(echo "$(distdir) archives ready for distribution: "; \
 	  list='$(DIST_ARCHIVES)'; for i in $$list; do echo $$i; done) | \
 	  sed -e 1h -e 1s/./=/g -e 1p -e 1x -e '$$p' -e '$$x'
 distuninstallcheck:
-	@$(am__cd) '$(distuninstallcheck_dir)' \
-	&& test `$(distuninstallcheck_listfiles) | wc -l` -le 1 \
+	@test -n '$(distuninstallcheck_dir)' || { \
+	  echo 'ERROR: trying to run $@ with an empty' \
+	       '$$(distuninstallcheck_dir)' >&2; \
+	  exit 1; \
+	}; \
+	$(am__cd) '$(distuninstallcheck_dir)' || { \
+	  echo 'ERROR: cannot chdir into $(distuninstallcheck_dir)' >&2; \
+	  exit 1; \
+	}; \
+	test `$(am__distuninstallcheck_listfiles) | wc -l` -eq 0 \
 	   || { echo "ERROR: files left after uninstall:" ; \
 	        if test -n "$(DESTDIR)"; then \
 	          echo "  (check DESTDIR support)"; \
@@ -767,10 +811,15 @@ install-am: all-am
 
 installcheck: installcheck-recursive
 install-strip:
-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
-	  `test -z '$(STRIP)' || \
-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+	if test -z '$(STRIP)'; then \
+	  $(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+	    install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+	      install; \
+	else \
+	  $(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+	    install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+	    "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'" install; \
+	fi
 mostlyclean-generic:
 
 clean-generic:
@@ -853,24 +902,26 @@ ps-am:
 uninstall-am:
 
 .MAKE: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) all \
-	ctags-recursive install-am install-strip tags-recursive
+	cscopelist-recursive ctags-recursive install-am install-strip \
+	tags-recursive
 
 .PHONY: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) CTAGS GTAGS \
 	all all-am all-local am--refresh check check-am clean \
-	clean-generic clean-libtool ctags ctags-recursive dist \
-	dist-all dist-bzip2 dist-gzip dist-hook dist-lzma dist-shar \
-	dist-tarZ dist-xz dist-zip distcheck distclean \
-	distclean-generic distclean-hdr distclean-libtool \
-	distclean-tags distcleancheck distdir distuninstallcheck dvi \
-	dvi-am html html-am info info-am install install-am \
-	install-data install-data-am install-dvi install-dvi-am \
-	install-exec install-exec-am install-html install-html-am \
-	install-info install-info-am install-man install-pdf \
-	install-pdf-am install-ps install-ps-am install-strip \
-	installcheck installcheck-am installdirs installdirs-am \
-	maintainer-clean maintainer-clean-generic mostlyclean \
-	mostlyclean-generic mostlyclean-libtool pdf pdf-am ps ps-am \
-	tags tags-recursive uninstall uninstall-am
+	clean-cscope clean-generic clean-libtool cscope cscopelist \
+	cscopelist-recursive ctags ctags-recursive dist dist-all \
+	dist-bzip2 dist-gzip dist-hook dist-lzip dist-shar dist-tarZ \
+	dist-xz dist-zip distcheck distclean distclean-generic \
+	distclean-hdr distclean-libtool distclean-tags distcleancheck \
+	distdir distuninstallcheck dvi dvi-am html html-am info \
+	info-am install install-am install-data install-data-am \
+	install-dvi install-dvi-am install-exec install-exec-am \
+	install-html install-html-am install-info install-info-am \
+	install-man install-pdf install-pdf-am install-ps \
+	install-ps-am install-strip installcheck installcheck-am \
+	installdirs installdirs-am maintainer-clean \
+	maintainer-clean-generic mostlyclean mostlyclean-generic \
+	mostlyclean-libtool pdf pdf-am ps ps-am tags tags-recursive \
+	uninstall uninstall-am
 
 
 win32-debug:
diff --git a/RELEASE b/RELEASE
new file mode 100644
index 0000000..2b78d48
--- /dev/null
+++ b/RELEASE
@@ -0,0 +1,93 @@
+
+Release notes for GStreamer FFmpeg Plug-ins 0.10.13 "Speeding, sparks like lightning"
+        
+
+The GStreamer team is proud to announce a new release
+in the 0.10.x stable series of the
+GStreamer FFmpeg Plug-ins.
+
+
+The 0.10.x series is a stable series targeted at end users.
+It is not API or ABI compatible with the stable 0.8.x series.
+It is, however, parallel installable with the 0.8.x series.
+
+
+This module contains plug-ins using libraries from the FFmpeg project.
+
+
+
+Other modules containing plug-ins are:
+
+
+gst-plugins-base
+contains a basic set of well-supported plug-ins
+gst-plugins-ugly
+contains a set of well-supported plug-ins, but might pose problems for
+    distributors
+gst-plugins-bad
+contains a set of less supported plug-ins that haven't passed the
+    rigorous quality testing we expect
+
+
+
+  
+
+Features of this release
+    
+      * Use libav 0.7.2 internal branch for security fixes
+      * Fixes for handling FLAC 
+      * Post QoS messages when dropping 
+      * Properly report GPL or LGPL licensing
+
+Bugs fixed in this release
+     
+      * 566605 : Support the new ffmpeg metadata API
+      * 574661 : [gstffmpegdec] Wrong usage of parsers
+      * 608892 : DCA/AAC/AC-3 decoders broken in gst-ffmpeg
+      * 532779 : ffmpeg configured with options leading to GPL license
+      * 589361 : [ffdec_flac] extradata NULL or too small error
+      * 640012 : ffmpegdec outputs wrong timestamps
+      * 643591 : ffmpegdec: invalid timestamp being used for next timestamp calculation
+      * 651768 : [PATCH] Arm cross compile fail (Failed to configure embedded FFmpeg tree)
+      * 654634 : postproc: gst-inspect-0.10 -a aborts with gstpostproc.c:360:change_mode: assertion failed: (postproc- > mode)
+      * 656155 : ffdec_mpeg2video and interlace property
+      * 656328 : [ffdeinterlace] add automatic " mode " property
+      * 657950 : ffmpegdec: post QoS messages when dropping a frame
+      * 658019 : ffdec_ass: caps seems wrong
+
+Download
+
+You can find source releases of gst-ffmpeg in the download directory:
+http://gstreamer.freedesktop.org/src/gst-ffmpeg/
+
+GStreamer Homepage
+
+More details can be found on the project's website:
+http://gstreamer.freedesktop.org/
+
+Support and Bugs
+
+We use GNOME's bugzilla for bug reports and feature requests:
+http://bugzilla.gnome.org/enter_bug.cgi?product=GStreamer
+
+Developers
+
+GStreamer is stored in Git, hosted at git.freedesktop.org, and can be cloned from there.
+Interested developers of the core library, plug-ins, and applications should
+subscribe to the gstreamer-devel list. If there is sufficient interest we
+will create more lists as necessary.
+
+        
+Applications
+  
+Contributors to this release
+    
+      * Edward Hervey
+      * Martin Storsjo
+      * Nicolas Dufresne
+      * Sjoerd Simons
+      * Stefan Sauer
+      * Tim-Philipp Müller
+      * Tvrtko Ursulin
+      * Vincent Penquerc'h
+ 
\ No newline at end of file
diff --git a/aclocal.m4 b/aclocal.m4
index 5fde66f..b855f13 100644
--- a/aclocal.m4
+++ b/aclocal.m4
@@ -1,7 +1,7 @@
-# generated automatically by aclocal 1.11.1 -*- Autoconf -*-
+# generated automatically by aclocal 1.12.6 -*- Autoconf -*-
+
+# Copyright (C) 1996-2012 Free Software Foundation, Inc.
 
-# Copyright (C) 1996, 1997, 1998, 1999, 2000, 2001, 2002, 2003, 2004,
-# 2005, 2006, 2007, 2008, 2009  Free Software Foundation, Inc.
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
@@ -13,13 +13,13 @@
 
 m4_ifndef([AC_AUTOCONF_VERSION],
   [m4_copy([m4_PACKAGE_VERSION], [AC_AUTOCONF_VERSION])])dnl
-m4_if(m4_defn([AC_AUTOCONF_VERSION]), [2.68],,
-[m4_warning([this file was generated for autoconf 2.68.
+m4_if(m4_defn([AC_AUTOCONF_VERSION]), [2.69],,
+[m4_warning([this file was generated for autoconf 2.69.
 You have another version of autoconf.  It may work, but is not guaranteed to.
 If you have problems, you may need to regenerate the build system entirely.
-To do so, use the procedure documented by the package, typically `autoreconf'.])])
+To do so, use the procedure documented by the package, typically 'autoreconf'.])])
 
-# Copyright (C) 2002, 2003, 2005, 2006, 2007, 2008  Free Software Foundation, Inc.
+# Copyright (C) 2002-2012 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -31,10 +31,10 @@ To do so, use the procedure documented by the package, typically `autoreconf'.])
 # generated from the m4 files accompanying Automake X.Y.
 # (This private macro should not be called outside this file.)
 AC_DEFUN([AM_AUTOMAKE_VERSION],
-[am__api_version='1.11'
+[am__api_version='1.12'
 dnl Some users find AM_AUTOMAKE_VERSION and mistake it for a way to
 dnl require some minimum version.  Point them to the right macro.
-m4_if([$1], [1.11.1], [],
+m4_if([$1], [1.12.6], [],
       [AC_FATAL([Do not call $0, use AM_INIT_AUTOMAKE([$1]).])])dnl
 ])
 
@@ -50,22 +50,22 @@ m4_define([_AM_AUTOCONF_VERSION], [])
 # Call AM_AUTOMAKE_VERSION and AM_AUTOMAKE_VERSION so they can be traced.
 # This function is AC_REQUIREd by AM_INIT_AUTOMAKE.
 AC_DEFUN([AM_SET_CURRENT_AUTOMAKE_VERSION],
-[AM_AUTOMAKE_VERSION([1.11.1])dnl
+[AM_AUTOMAKE_VERSION([1.12.6])dnl
 m4_ifndef([AC_AUTOCONF_VERSION],
   [m4_copy([m4_PACKAGE_VERSION], [AC_AUTOCONF_VERSION])])dnl
 _AM_AUTOCONF_VERSION(m4_defn([AC_AUTOCONF_VERSION]))])
 
 # AM_AUX_DIR_EXPAND                                         -*- Autoconf -*-
 
-# Copyright (C) 2001, 2003, 2005  Free Software Foundation, Inc.
+# Copyright (C) 2001-2012 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
 
 # For projects using AC_CONFIG_AUX_DIR([foo]), Autoconf sets
-# $ac_aux_dir to `$srcdir/foo'.  In other projects, it is set to
-# `$srcdir', `$srcdir/..', or `$srcdir/../..'.
+# $ac_aux_dir to '$srcdir/foo'.  In other projects, it is set to
+# '$srcdir', '$srcdir/..', or '$srcdir/../..'.
 #
 # Of course, Automake must honor this variable whenever it calls a
 # tool from the auxiliary directory.  The problem is that $srcdir (and
@@ -84,7 +84,7 @@ _AM_AUTOCONF_VERSION(m4_defn([AC_AUTOCONF_VERSION]))])
 #
 # The reason of the latter failure is that $top_srcdir and $ac_aux_dir
 # are both prefixed by $srcdir.  In an in-source build this is usually
-# harmless because $srcdir is `.', but things will broke when you
+# harmless because $srcdir is '.', but things will broke when you
 # start a VPATH build or use an absolute $srcdir.
 #
 # So we could use something similar to $top_srcdir/$ac_aux_dir/missing,
@@ -110,22 +110,19 @@ am_aux_dir=`cd $ac_aux_dir && pwd`
 
 # AM_CONDITIONAL                                            -*- Autoconf -*-
 
-# Copyright (C) 1997, 2000, 2001, 2003, 2004, 2005, 2006, 2008
-# Free Software Foundation, Inc.
+# Copyright (C) 1997-2012 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
 
-# serial 9
-
 # AM_CONDITIONAL(NAME, SHELL-CONDITION)
 # -------------------------------------
 # Define a conditional.
 AC_DEFUN([AM_CONDITIONAL],
-[AC_PREREQ(2.52)dnl
- ifelse([$1], [TRUE],  [AC_FATAL([$0: invalid condition: $1])],
-	[$1], [FALSE], [AC_FATAL([$0: invalid condition: $1])])dnl
+[AC_PREREQ([2.52])dnl
+ m4_if([$1], [TRUE],  [AC_FATAL([$0: invalid condition: $1])],
+       [$1], [FALSE], [AC_FATAL([$0: invalid condition: $1])])dnl
 AC_SUBST([$1_TRUE])dnl
 AC_SUBST([$1_FALSE])dnl
 _AM_SUBST_NOTMAKE([$1_TRUE])dnl
@@ -144,16 +141,14 @@ AC_CONFIG_COMMANDS_PRE(
 Usually this means the macro was only invoked conditionally.]])
 fi])])
 
-# Copyright (C) 1999, 2000, 2001, 2002, 2003, 2004, 2005, 2006, 2009
-# Free Software Foundation, Inc.
+# Copyright (C) 1999-2012 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
 
-# serial 10
 
-# There are a few dirty hacks below to avoid letting `AC_PROG_CC' be
+# There are a few dirty hacks below to avoid letting 'AC_PROG_CC' be
 # written in clear, in which case automake, when reading aclocal.m4,
 # will think it sees a *use*, and therefore will trigger all it's
 # C support machinery.  Also note that it means that autoscan, seeing
@@ -163,7 +158,7 @@ fi])])
 # _AM_DEPENDENCIES(NAME)
 # ----------------------
 # See how the compiler implements dependency checking.
-# NAME is "CC", "CXX", "GCJ", or "OBJC".
+# NAME is "CC", "CXX", "OBJC", "OBJCXX", "UPC", or "GJC".
 # We try a few techniques and use that to set a single cache variable.
 #
 # We don't AC_REQUIRE the corresponding AC_PROG_CC since the latter was
@@ -176,12 +171,13 @@ AC_REQUIRE([AM_OUTPUT_DEPENDENCY_COMMANDS])dnl
 AC_REQUIRE([AM_MAKE_INCLUDE])dnl
 AC_REQUIRE([AM_DEP_TRACK])dnl
 
-ifelse([$1], CC,   [depcc="$CC"   am_compiler_list=],
-       [$1], CXX,  [depcc="$CXX"  am_compiler_list=],
-       [$1], OBJC, [depcc="$OBJC" am_compiler_list='gcc3 gcc'],
-       [$1], UPC,  [depcc="$UPC"  am_compiler_list=],
-       [$1], GCJ,  [depcc="$GCJ"  am_compiler_list='gcc3 gcc'],
-                   [depcc="$$1"   am_compiler_list=])
+m4_if([$1], [CC],   [depcc="$CC"   am_compiler_list=],
+      [$1], [CXX],  [depcc="$CXX"  am_compiler_list=],
+      [$1], [OBJC], [depcc="$OBJC" am_compiler_list='gcc3 gcc'],
+      [$1], [OBJCXX], [depcc="$OBJCXX" am_compiler_list='gcc3 gcc'],
+      [$1], [UPC],  [depcc="$UPC"  am_compiler_list=],
+      [$1], [GCJ],  [depcc="$GCJ"  am_compiler_list='gcc3 gcc'],
+                    [depcc="$$1"   am_compiler_list=])
 
 AC_CACHE_CHECK([dependency style of $depcc],
                [am_cv_$1_dependencies_compiler_type],
@@ -189,8 +185,9 @@ AC_CACHE_CHECK([dependency style of $depcc],
   # We make a subdir and do the tests there.  Otherwise we can end up
   # making bogus files that we don't know about and never remove.  For
   # instance it was reported that on HP-UX the gcc test will end up
-  # making a dummy file named `D' -- because `-MD' means `put the output
-  # in D'.
+  # making a dummy file named 'D' -- because '-MD' means "put the output
+  # in D".
+  rm -rf conftest.dir
   mkdir conftest.dir
   # Copy depcomp to subdir because otherwise we won't find it if we're
   # using a relative directory.
@@ -229,16 +226,16 @@ AC_CACHE_CHECK([dependency style of $depcc],
     : > sub/conftest.c
     for i in 1 2 3 4 5 6; do
       echo '#include "conftst'$i'.h"' >> sub/conftest.c
-      # Using `: > sub/conftst$i.h' creates only sub/conftst1.h with
-      # Solaris 8's {/usr,}/bin/sh.
-      touch sub/conftst$i.h
+      # Using ": > sub/conftst$i.h" creates only sub/conftst1.h with
+      # Solaris 10 /bin/sh.
+      echo '/* dummy */' > sub/conftst$i.h
     done
     echo "${am__include} ${am__quote}sub/conftest.Po${am__quote}" > confmf
 
-    # We check with `-c' and `-o' for the sake of the "dashmstdout"
+    # We check with '-c' and '-o' for the sake of the "dashmstdout"
     # mode.  It turns out that the SunPro C++ compiler does not properly
-    # handle `-M -o', and we need to detect this.  Also, some Intel
-    # versions had trouble with output in subdirs
+    # handle '-M -o', and we need to detect this.  Also, some Intel
+    # versions had trouble with output in subdirs.
     am__obj=sub/conftest.${OBJEXT-o}
     am__minus_obj="-o $am__obj"
     case $depmode in
@@ -247,16 +244,16 @@ AC_CACHE_CHECK([dependency style of $depcc],
       test "$am__universal" = false || continue
       ;;
     nosideeffect)
-      # after this tag, mechanisms are not by side-effect, so they'll
-      # only be used when explicitly requested
+      # After this tag, mechanisms are not by side-effect, so they'll
+      # only be used when explicitly requested.
       if test "x$enable_dependency_tracking" = xyes; then
 	continue
       else
 	break
       fi
       ;;
-    msvisualcpp | msvcmsys)
-      # This compiler won't grok `-c -o', but also, the minuso test has
+    msvc7 | msvc7msys | msvisualcpp | msvcmsys)
+      # This compiler won't grok '-c -o', but also, the minuso test has
       # not run yet.  These depmodes are late enough in the game, and
       # so weak that their functioning should not be impacted.
       am__obj=conftest.${OBJEXT-o}
@@ -304,7 +301,7 @@ AM_CONDITIONAL([am__fastdep$1], [
 # AM_SET_DEPDIR
 # -------------
 # Choose a directory name for dependency files.
-# This macro is AC_REQUIREd in _AM_DEPENDENCIES
+# This macro is AC_REQUIREd in _AM_DEPENDENCIES.
 AC_DEFUN([AM_SET_DEPDIR],
 [AC_REQUIRE([AM_SET_LEADING_DOT])dnl
 AC_SUBST([DEPDIR], ["${am__leading_dot}deps"])dnl
@@ -314,28 +311,33 @@ AC_SUBST([DEPDIR], ["${am__leading_dot}deps"])dnl
 # AM_DEP_TRACK
 # ------------
 AC_DEFUN([AM_DEP_TRACK],
-[AC_ARG_ENABLE(dependency-tracking,
-[  --disable-dependency-tracking  speeds up one-time build
-  --enable-dependency-tracking   do not reject slow dependency extractors])
+[AC_ARG_ENABLE([dependency-tracking], [dnl
+AS_HELP_STRING(
+  [--enable-dependency-tracking],
+  [do not reject slow dependency extractors])
+AS_HELP_STRING(
+  [--disable-dependency-tracking],
+  [speeds up one-time build])])
 if test "x$enable_dependency_tracking" != xno; then
   am_depcomp="$ac_aux_dir/depcomp"
   AMDEPBACKSLASH='\'
+  am__nodep='_no'
 fi
 AM_CONDITIONAL([AMDEP], [test "x$enable_dependency_tracking" != xno])
 AC_SUBST([AMDEPBACKSLASH])dnl
 _AM_SUBST_NOTMAKE([AMDEPBACKSLASH])dnl
+AC_SUBST([am__nodep])dnl
+_AM_SUBST_NOTMAKE([am__nodep])dnl
 ])
 
 # Generate code to set up dependency tracking.              -*- Autoconf -*-
 
-# Copyright (C) 1999, 2000, 2001, 2002, 2003, 2004, 2005, 2008
-# Free Software Foundation, Inc.
+# Copyright (C) 1999-2012 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
 
-#serial 5
 
 # _AM_OUTPUT_DEPENDENCY_COMMANDS
 # ------------------------------
@@ -354,7 +356,7 @@ AC_DEFUN([_AM_OUTPUT_DEPENDENCY_COMMANDS],
     # Strip MF so we end up with the name of the file.
     mf=`echo "$mf" | sed -e 's/:.*$//'`
     # Check whether this is an Automake generated Makefile or not.
-    # We used to match only the files named `Makefile.in', but
+    # We used to match only the files named 'Makefile.in', but
     # some people rename them; so instead we look at the file content.
     # Grep'ing the first line is not enough: some people post-process
     # each Makefile.in and add a new line on top of each file to say so.
@@ -366,21 +368,19 @@ AC_DEFUN([_AM_OUTPUT_DEPENDENCY_COMMANDS],
       continue
     fi
     # Extract the definition of DEPDIR, am__include, and am__quote
-    # from the Makefile without running `make'.
+    # from the Makefile without running 'make'.
     DEPDIR=`sed -n 's/^DEPDIR = //p' < "$mf"`
     test -z "$DEPDIR" && continue
     am__include=`sed -n 's/^am__include = //p' < "$mf"`
     test -z "am__include" && continue
     am__quote=`sed -n 's/^am__quote = //p' < "$mf"`
-    # When using ansi2knr, U may be empty or an underscore; expand it
-    U=`sed -n 's/^U = //p' < "$mf"`
     # Find all dependency output files, they are included files with
     # $(DEPDIR) in their names.  We invoke sed twice because it is the
     # simplest approach to changing $(DEPDIR) to its actual value in the
     # expansion.
     for file in `sed -n "
       s/^$am__include $am__quote\(.*(DEPDIR).*\)$am__quote"'$/\1/p' <"$mf" | \
-	 sed -e 's/\$(DEPDIR)/'"$DEPDIR"'/g' -e 's/\$U/'"$U"'/g'`; do
+	 sed -e 's/\$(DEPDIR)/'"$DEPDIR"'/g'`; do
       # Make sure the directory exists.
       test -f "$dirpart/$file" && continue
       fdir=`AS_DIRNAME(["$file"])`
@@ -398,7 +398,7 @@ AC_DEFUN([_AM_OUTPUT_DEPENDENCY_COMMANDS],
 # This macro should only be invoked once -- use via AC_REQUIRE.
 #
 # This code is only required when automatic dependency tracking
-# is enabled.  FIXME.  This creates each `.P' file that we will
+# is enabled.  FIXME.  This creates each '.P' file that we will
 # need in order to bootstrap the dependency handling code.
 AC_DEFUN([AM_OUTPUT_DEPENDENCY_COMMANDS],
 [AC_CONFIG_COMMANDS([depfiles],
@@ -406,29 +406,23 @@ AC_DEFUN([AM_OUTPUT_DEPENDENCY_COMMANDS],
      [AMDEP_TRUE="$AMDEP_TRUE" ac_aux_dir="$ac_aux_dir"])
 ])
 
-# Copyright (C) 1996, 1997, 2000, 2001, 2003, 2005
-# Free Software Foundation, Inc.
+# Copyright (C) 1996-2012 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
 
-# serial 8
-
 # AM_CONFIG_HEADER is obsolete.  It has been replaced by AC_CONFIG_HEADERS.
 AU_DEFUN([AM_CONFIG_HEADER], [AC_CONFIG_HEADERS($@)])
 
 # Do all the work for Automake.                             -*- Autoconf -*-
 
-# Copyright (C) 1996, 1997, 1998, 1999, 2000, 2001, 2002, 2003, 2004,
-# 2005, 2006, 2008, 2009 Free Software Foundation, Inc.
+# Copyright (C) 1996-2012 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
 
-# serial 16
-
 # This macro actually does too much.  Some checks are only needed if
 # your package does certain things.  But this isn't really a big deal.
 
@@ -473,31 +467,41 @@ AC_SUBST([CYGPATH_W])
 # Define the identity of the package.
 dnl Distinguish between old-style and new-style calls.
 m4_ifval([$2],
-[m4_ifval([$3], [_AM_SET_OPTION([no-define])])dnl
+[AC_DIAGNOSE([obsolete],
+[$0: two- and three-arguments forms are deprecated.  For more info, see:
+http://www.gnu.org/software/automake/manual/automake.html#Modernize-AM_INIT_AUTOMAKE-invocation])
+m4_ifval([$3], [_AM_SET_OPTION([no-define])])dnl
  AC_SUBST([PACKAGE], [$1])dnl
  AC_SUBST([VERSION], [$2])],
 [_AM_SET_OPTIONS([$1])dnl
 dnl Diagnose old-style AC_INIT with new-style AM_AUTOMAKE_INIT.
-m4_if(m4_ifdef([AC_PACKAGE_NAME], 1)m4_ifdef([AC_PACKAGE_VERSION], 1), 11,,
+m4_if(
+  m4_ifdef([AC_PACKAGE_NAME], [ok]):m4_ifdef([AC_PACKAGE_VERSION], [ok]),
+  [ok:ok],,
   [m4_fatal([AC_INIT should be called with package and version arguments])])dnl
  AC_SUBST([PACKAGE], ['AC_PACKAGE_TARNAME'])dnl
  AC_SUBST([VERSION], ['AC_PACKAGE_VERSION'])])dnl
 
 _AM_IF_OPTION([no-define],,
-[AC_DEFINE_UNQUOTED(PACKAGE, "$PACKAGE", [Name of package])
- AC_DEFINE_UNQUOTED(VERSION, "$VERSION", [Version number of package])])dnl
+[AC_DEFINE_UNQUOTED([PACKAGE], ["$PACKAGE"], [Name of package])
+ AC_DEFINE_UNQUOTED([VERSION], ["$VERSION"], [Version number of package])])dnl
 
 # Some tools Automake needs.
 AC_REQUIRE([AM_SANITY_CHECK])dnl
 AC_REQUIRE([AC_ARG_PROGRAM])dnl
-AM_MISSING_PROG(ACLOCAL, aclocal-${am__api_version})
-AM_MISSING_PROG(AUTOCONF, autoconf)
-AM_MISSING_PROG(AUTOMAKE, automake-${am__api_version})
-AM_MISSING_PROG(AUTOHEADER, autoheader)
-AM_MISSING_PROG(MAKEINFO, makeinfo)
+AM_MISSING_PROG([ACLOCAL], [aclocal-${am__api_version}])
+AM_MISSING_PROG([AUTOCONF], [autoconf])
+AM_MISSING_PROG([AUTOMAKE], [automake-${am__api_version}])
+AM_MISSING_PROG([AUTOHEADER], [autoheader])
+AM_MISSING_PROG([MAKEINFO], [makeinfo])
 AC_REQUIRE([AM_PROG_INSTALL_SH])dnl
 AC_REQUIRE([AM_PROG_INSTALL_STRIP])dnl
-AC_REQUIRE([AM_PROG_MKDIR_P])dnl
+AC_REQUIRE([AC_PROG_MKDIR_P])dnl
+# For better backward compatibility.  To be removed once Automake 1.9.x
+# dies out for good.  For more background, see:
+# <http://lists.gnu.org/archive/html/automake/2012-07/msg00001.html>
+# <http://lists.gnu.org/archive/html/automake/2012-07/msg00014.html>
+AC_SUBST([mkdir_p], ['$(MKDIR_P)'])
 # We need awk for the "check" target.  The system "awk" is bad on
 # some platforms.
 AC_REQUIRE([AC_PROG_AWK])dnl
@@ -508,28 +512,35 @@ _AM_IF_OPTION([tar-ustar], [_AM_PROG_TAR([ustar])],
 			     [_AM_PROG_TAR([v7])])])
 _AM_IF_OPTION([no-dependencies],,
 [AC_PROVIDE_IFELSE([AC_PROG_CC],
-		  [_AM_DEPENDENCIES(CC)],
-		  [define([AC_PROG_CC],
-			  defn([AC_PROG_CC])[_AM_DEPENDENCIES(CC)])])dnl
+		  [_AM_DEPENDENCIES([CC])],
+		  [m4_define([AC_PROG_CC],
+			     m4_defn([AC_PROG_CC])[_AM_DEPENDENCIES([CC])])])dnl
 AC_PROVIDE_IFELSE([AC_PROG_CXX],
-		  [_AM_DEPENDENCIES(CXX)],
-		  [define([AC_PROG_CXX],
-			  defn([AC_PROG_CXX])[_AM_DEPENDENCIES(CXX)])])dnl
+		  [_AM_DEPENDENCIES([CXX])],
+		  [m4_define([AC_PROG_CXX],
+			     m4_defn([AC_PROG_CXX])[_AM_DEPENDENCIES([CXX])])])dnl
 AC_PROVIDE_IFELSE([AC_PROG_OBJC],
-		  [_AM_DEPENDENCIES(OBJC)],
-		  [define([AC_PROG_OBJC],
-			  defn([AC_PROG_OBJC])[_AM_DEPENDENCIES(OBJC)])])dnl
+		  [_AM_DEPENDENCIES([OBJC])],
+		  [m4_define([AC_PROG_OBJC],
+			     m4_defn([AC_PROG_OBJC])[_AM_DEPENDENCIES([OBJC])])])dnl
+dnl Support for Objective C++ was only introduced in Autoconf 2.65,
+dnl but we still cater to Autoconf 2.62.
+m4_ifdef([AC_PROG_OBJCXX],
+[AC_PROVIDE_IFELSE([AC_PROG_OBJCXX],
+		  [_AM_DEPENDENCIES([OBJCXX])],
+		  [m4_define([AC_PROG_OBJCXX],
+			     m4_defn([AC_PROG_OBJCXX])[_AM_DEPENDENCIES([OBJCXX])])])])dnl
 ])
 _AM_IF_OPTION([silent-rules], [AC_REQUIRE([AM_SILENT_RULES])])dnl
-dnl The `parallel-tests' driver may need to know about EXEEXT, so add the
-dnl `am__EXEEXT' conditional if _AM_COMPILER_EXEEXT was seen.  This macro
+dnl The 'parallel-tests' driver may need to know about EXEEXT, so add the
+dnl 'am__EXEEXT' conditional if _AM_COMPILER_EXEEXT was seen.  This macro
 dnl is hooked onto _AC_COMPILER_EXEEXT early, see below.
 AC_CONFIG_COMMANDS_PRE(dnl
 [m4_provide_if([_AM_COMPILER_EXEEXT],
   [AM_CONDITIONAL([am__EXEEXT], [test -n "$EXEEXT"])])])dnl
 ])
 
-dnl Hook into `_AC_COMPILER_EXEEXT' early to learn its expansion.  Do not
+dnl Hook into '_AC_COMPILER_EXEEXT' early to learn its expansion.  Do not
 dnl add the conditional right here, as _AC_COMPILER_EXEEXT may be further
 dnl mangled by Autoconf and run in a shell conditional statement.
 m4_define([_AC_COMPILER_EXEEXT],
@@ -557,7 +568,7 @@ for _am_header in $config_headers :; do
 done
 echo "timestamp for $_am_arg" >`AS_DIRNAME(["$_am_arg"])`/stamp-h[]$_am_stamp_count])
 
-# Copyright (C) 2001, 2003, 2005, 2008  Free Software Foundation, Inc.
+# Copyright (C) 2001-2012 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -576,16 +587,14 @@ if test x"${install_sh}" != xset; then
     install_sh="\${SHELL} $am_aux_dir/install-sh"
   esac
 fi
-AC_SUBST(install_sh)])
+AC_SUBST([install_sh])])
 
-# Copyright (C) 2003, 2005  Free Software Foundation, Inc.
+# Copyright (C) 2003-2012 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
 
-# serial 2
-
 # Check whether the underlying file-system supports filenames
 # with a leading dot.  For instance MS-DOS doesn't.
 AC_DEFUN([AM_SET_LEADING_DOT],
@@ -602,20 +611,17 @@ AC_SUBST([am__leading_dot])])
 # Add --enable-maintainer-mode option to configure.         -*- Autoconf -*-
 # From Jim Meyering
 
-# Copyright (C) 1996, 1998, 2000, 2001, 2002, 2003, 2004, 2005, 2008
-# Free Software Foundation, Inc.
+# Copyright (C) 1996-2012 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
 
-# serial 5
-
 # AM_MAINTAINER_MODE([DEFAULT-MODE])
 # ----------------------------------
 # Control maintainer-specific portions of Makefiles.
-# Default is to disable them, unless `enable' is passed literally.
-# For symmetry, `disable' may be passed as well.  Anyway, the user
+# Default is to disable them, unless 'enable' is passed literally.
+# For symmetry, 'disable' may be passed as well.  Anyway, the user
 # can override the default with the --enable/--disable switch.
 AC_DEFUN([AM_MAINTAINER_MODE],
 [m4_case(m4_default([$1], [disable]),
@@ -623,13 +629,14 @@ AC_DEFUN([AM_MAINTAINER_MODE],
        [disable], [m4_define([am_maintainer_other], [enable])],
        [m4_define([am_maintainer_other], [enable])
         m4_warn([syntax], [unexpected argument to AM@&t@_MAINTAINER_MODE: $1])])
-AC_MSG_CHECKING([whether to am_maintainer_other maintainer-specific portions of Makefiles])
+AC_MSG_CHECKING([whether to enable maintainer-specific portions of Makefiles])
   dnl maintainer-mode's default is 'disable' unless 'enable' is passed
   AC_ARG_ENABLE([maintainer-mode],
-[  --][am_maintainer_other][-maintainer-mode  am_maintainer_other make rules and dependencies not useful
-			  (and sometimes confusing) to the casual installer],
-      [USE_MAINTAINER_MODE=$enableval],
-      [USE_MAINTAINER_MODE=]m4_if(am_maintainer_other, [enable], [no], [yes]))
+    [AS_HELP_STRING([--]am_maintainer_other[-maintainer-mode],
+      am_maintainer_other[ make rules and dependencies not useful
+      (and sometimes confusing) to the casual installer])],
+    [USE_MAINTAINER_MODE=$enableval],
+    [USE_MAINTAINER_MODE=]m4_if(am_maintainer_other, [enable], [no], [yes]))
   AC_MSG_RESULT([$USE_MAINTAINER_MODE])
   AM_CONDITIONAL([MAINTAINER_MODE], [test $USE_MAINTAINER_MODE = yes])
   MAINT=$MAINTAINER_MODE_TRUE
@@ -641,14 +648,12 @@ AU_DEFUN([jm_MAINTAINER_MODE], [AM_MAINTAINER_MODE])
 
 # Check to see how 'make' treats includes.	            -*- Autoconf -*-
 
-# Copyright (C) 2001, 2002, 2003, 2005, 2009  Free Software Foundation, Inc.
+# Copyright (C) 2001-2012 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
 
-# serial 4
-
 # AM_MAKE_INCLUDE()
 # -----------------
 # Check to see how make treats includes.
@@ -666,7 +671,7 @@ am__quote=
 _am_result=none
 # First try GNU make style include.
 echo "include confinc" > confmf
-# Ignore all kinds of additional output from `make'.
+# Ignore all kinds of additional output from 'make'.
 case `$am_make -s -f confmf 2> /dev/null` in #(
 *the\ am__doit\ target*)
   am__include=include
@@ -691,15 +696,12 @@ AC_MSG_RESULT([$_am_result])
 rm -f confinc confmf
 ])
 
-# Copyright (C) 1999, 2000, 2001, 2003, 2004, 2005, 2008
-# Free Software Foundation, Inc.
+# Copyright (C) 1999-2012 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
 
-# serial 6
-
 # AM_PROG_CC_C_O
 # --------------
 # Like AC_PROG_CC_C_O, but changed for automake.
@@ -728,15 +730,12 @@ m4_define([AC_PROG_CC],
 
 # Fake the existence of programs that GNU maintainers use.  -*- Autoconf -*-
 
-# Copyright (C) 1997, 1999, 2000, 2001, 2003, 2004, 2005, 2008
-# Free Software Foundation, Inc.
+# Copyright (C) 1997-2012 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
 
-# serial 6
-
 # AM_MISSING_PROG(NAME, PROGRAM)
 # ------------------------------
 AC_DEFUN([AM_MISSING_PROG],
@@ -744,7 +743,6 @@ AC_DEFUN([AM_MISSING_PROG],
 $1=${$1-"${am_missing_run}$2"}
 AC_SUBST($1)])
 
-
 # AM_MISSING_HAS_RUN
 # ------------------
 # Define MISSING if not defined so far and test if it supports --run.
@@ -765,59 +763,31 @@ if eval "$MISSING --run true"; then
   am_missing_run="$MISSING --run "
 else
   am_missing_run=
-  AC_MSG_WARN([`missing' script is too old or missing])
+  AC_MSG_WARN(['missing' script is too old or missing])
 fi
 ])
 
-# Copyright (C) 2003, 2004, 2005, 2006  Free Software Foundation, Inc.
-#
-# This file is free software; the Free Software Foundation
-# gives unlimited permission to copy and/or distribute it,
-# with or without modifications, as long as this notice is preserved.
-
-# AM_PROG_MKDIR_P
-# ---------------
-# Check for `mkdir -p'.
-AC_DEFUN([AM_PROG_MKDIR_P],
-[AC_PREREQ([2.60])dnl
-AC_REQUIRE([AC_PROG_MKDIR_P])dnl
-dnl Automake 1.8 to 1.9.6 used to define mkdir_p.  We now use MKDIR_P,
-dnl while keeping a definition of mkdir_p for backward compatibility.
-dnl @MKDIR_P@ is magic: AC_OUTPUT adjusts its value for each Makefile.
-dnl However we cannot define mkdir_p as $(MKDIR_P) for the sake of
-dnl Makefile.ins that do not define MKDIR_P, so we do our own
-dnl adjustment using top_builddir (which is defined more often than
-dnl MKDIR_P).
-AC_SUBST([mkdir_p], ["$MKDIR_P"])dnl
-case $mkdir_p in
-  [[\\/$]]* | ?:[[\\/]]*) ;;
-  */*) mkdir_p="\$(top_builddir)/$mkdir_p" ;;
-esac
-])
-
 # Helper functions for option handling.                     -*- Autoconf -*-
 
-# Copyright (C) 2001, 2002, 2003, 2005, 2008  Free Software Foundation, Inc.
+# Copyright (C) 2001-2012 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
 
-# serial 4
-
 # _AM_MANGLE_OPTION(NAME)
 # -----------------------
 AC_DEFUN([_AM_MANGLE_OPTION],
 [[_AM_OPTION_]m4_bpatsubst($1, [[^a-zA-Z0-9_]], [_])])
 
 # _AM_SET_OPTION(NAME)
-# ------------------------------
+# --------------------
 # Set option NAME.  Presently that only means defining a flag for this option.
 AC_DEFUN([_AM_SET_OPTION],
-[m4_define(_AM_MANGLE_OPTION([$1]), 1)])
+[m4_define(_AM_MANGLE_OPTION([$1]), [1])])
 
 # _AM_SET_OPTIONS(OPTIONS)
-# ----------------------------------
+# ------------------------
 # OPTIONS is a space-separated list of Automake options.
 AC_DEFUN([_AM_SET_OPTIONS],
 [m4_foreach_w([_AM_Option], [$1], [_AM_SET_OPTION(_AM_Option)])])
@@ -830,22 +800,16 @@ AC_DEFUN([_AM_IF_OPTION],
 
 # Check to make sure that the build environment is sane.    -*- Autoconf -*-
 
-# Copyright (C) 1996, 1997, 2000, 2001, 2003, 2005, 2008
-# Free Software Foundation, Inc.
+# Copyright (C) 1996-2012 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
 
-# serial 5
-
 # AM_SANITY_CHECK
 # ---------------
 AC_DEFUN([AM_SANITY_CHECK],
 [AC_MSG_CHECKING([whether build environment is sane])
-# Just in case
-sleep 1
-echo timestamp > conftest.file
 # Reject unsafe characters in $srcdir or the absolute working directory
 # name.  Accept space and tab only in the latter.
 am_lf='
@@ -856,32 +820,40 @@ case `pwd` in
 esac
 case $srcdir in
   *[[\\\"\#\$\&\'\`$am_lf\ \	]]*)
-    AC_MSG_ERROR([unsafe srcdir value: `$srcdir']);;
+    AC_MSG_ERROR([unsafe srcdir value: '$srcdir']);;
 esac
 
-# Do `set' in a subshell so we don't clobber the current shell's
+# Do 'set' in a subshell so we don't clobber the current shell's
 # arguments.  Must try -L first in case configure is actually a
 # symlink; some systems play weird games with the mod time of symlinks
 # (eg FreeBSD returns the mod time of the symlink's containing
 # directory).
 if (
-   set X `ls -Lt "$srcdir/configure" conftest.file 2> /dev/null`
-   if test "$[*]" = "X"; then
-      # -L didn't work.
-      set X `ls -t "$srcdir/configure" conftest.file`
-   fi
-   rm -f conftest.file
-   if test "$[*]" != "X $srcdir/configure conftest.file" \
-      && test "$[*]" != "X conftest.file $srcdir/configure"; then
-
-      # If neither matched, then we have a broken ls.  This can happen
-      # if, for instance, CONFIG_SHELL is bash and it inherits a
-      # broken ls alias from the environment.  This has actually
-      # happened.  Such a system could not be considered "sane".
-      AC_MSG_ERROR([ls -t appears to fail.  Make sure there is not a broken
-alias in your environment])
-   fi
-
+   am_has_slept=no
+   for am_try in 1 2; do
+     echo "timestamp, slept: $am_has_slept" > conftest.file
+     set X `ls -Lt "$srcdir/configure" conftest.file 2> /dev/null`
+     if test "$[*]" = "X"; then
+	# -L didn't work.
+	set X `ls -t "$srcdir/configure" conftest.file`
+     fi
+     if test "$[*]" != "X $srcdir/configure conftest.file" \
+	&& test "$[*]" != "X conftest.file $srcdir/configure"; then
+
+	# If neither matched, then we have a broken ls.  This can happen
+	# if, for instance, CONFIG_SHELL is bash and it inherits a
+	# broken ls alias from the environment.  This has actually
+	# happened.  Such a system could not be considered "sane".
+	AC_MSG_ERROR([ls -t appears to fail.  Make sure there is not a broken
+  alias in your environment])
+     fi
+     if test "$[2]" = conftest.file || test $am_try -eq 2; then
+       break
+     fi
+     # Just in case.
+     sleep 1
+     am_has_slept=yes
+   done
    test "$[2]" = conftest.file
    )
 then
@@ -891,36 +863,85 @@ else
    AC_MSG_ERROR([newly created file is older than distributed files!
 Check your system clock])
 fi
-AC_MSG_RESULT(yes)])
+AC_MSG_RESULT([yes])
+# If we didn't sleep, we still need to ensure time stamps of config.status and
+# generated files are strictly newer.
+am_sleep_pid=
+if grep 'slept: no' conftest.file >/dev/null 2>&1; then
+  ( sleep 1 ) &
+  am_sleep_pid=$!
+fi
+AC_CONFIG_COMMANDS_PRE(
+  [AC_MSG_CHECKING([that generated files are newer than configure])
+   if test -n "$am_sleep_pid"; then
+     # Hide warnings about reused PIDs.
+     wait $am_sleep_pid 2>/dev/null
+   fi
+   AC_MSG_RESULT([done])])
+rm -f conftest.file
+])
 
-# Copyright (C) 2009  Free Software Foundation, Inc.
+# Copyright (C) 2009-2012 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
 
-# serial 1
-
 # AM_SILENT_RULES([DEFAULT])
 # --------------------------
 # Enable less verbose build rules; with the default set to DEFAULT
-# (`yes' being less verbose, `no' or empty being verbose).
+# ("yes" being less verbose, "no" or empty being verbose).
 AC_DEFUN([AM_SILENT_RULES],
-[AC_ARG_ENABLE([silent-rules],
-[  --enable-silent-rules          less verbose build output (undo: `make V=1')
-  --disable-silent-rules         verbose build output (undo: `make V=0')])
-case $enable_silent_rules in
-yes) AM_DEFAULT_VERBOSITY=0;;
-no)  AM_DEFAULT_VERBOSITY=1;;
-*)   AM_DEFAULT_VERBOSITY=m4_if([$1], [yes], [0], [1]);;
+[AC_ARG_ENABLE([silent-rules], [dnl
+AS_HELP_STRING(
+  [--enable-silent-rules],
+  [less verbose build output (undo: "make V=1")])
+AS_HELP_STRING(
+  [--disable-silent-rules],
+  [verbose build output (undo: "make V=0")])dnl
+])
+case $enable_silent_rules in @%:@ (((
+  yes) AM_DEFAULT_VERBOSITY=0;;
+   no) AM_DEFAULT_VERBOSITY=1;;
+    *) AM_DEFAULT_VERBOSITY=m4_if([$1], [yes], [0], [1]);;
 esac
+dnl
+dnl A few 'make' implementations (e.g., NonStop OS and NextStep)
+dnl do not support nested variable expansions.
+dnl See automake bug#9928 and bug#10237.
+am_make=${MAKE-make}
+AC_CACHE_CHECK([whether $am_make supports nested variables],
+   [am_cv_make_support_nested_variables],
+   [if AS_ECHO([['TRUE=$(BAR$(V))
+BAR0=false
+BAR1=true
+V=1
+am__doit:
+	@$(TRUE)
+.PHONY: am__doit']]) | $am_make -f - >/dev/null 2>&1; then
+  am_cv_make_support_nested_variables=yes
+else
+  am_cv_make_support_nested_variables=no
+fi])
+if test $am_cv_make_support_nested_variables = yes; then
+  dnl Using '$V' instead of '$(V)' breaks IRIX make.
+  AM_V='$(V)'
+  AM_DEFAULT_V='$(AM_DEFAULT_VERBOSITY)'
+else
+  AM_V=$AM_DEFAULT_VERBOSITY
+  AM_DEFAULT_V=$AM_DEFAULT_VERBOSITY
+fi
+AC_SUBST([AM_V])dnl
+AM_SUBST_NOTMAKE([AM_V])dnl
+AC_SUBST([AM_DEFAULT_V])dnl
+AM_SUBST_NOTMAKE([AM_DEFAULT_V])dnl
 AC_SUBST([AM_DEFAULT_VERBOSITY])dnl
 AM_BACKSLASH='\'
 AC_SUBST([AM_BACKSLASH])dnl
 _AM_SUBST_NOTMAKE([AM_BACKSLASH])dnl
 ])
 
-# Copyright (C) 2001, 2003, 2005  Free Software Foundation, Inc.
+# Copyright (C) 2001-2012 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -928,34 +949,32 @@ _AM_SUBST_NOTMAKE([AM_BACKSLASH])dnl
 
 # AM_PROG_INSTALL_STRIP
 # ---------------------
-# One issue with vendor `install' (even GNU) is that you can't
+# One issue with vendor 'install' (even GNU) is that you can't
 # specify the program used to strip binaries.  This is especially
 # annoying in cross-compiling environments, where the build's strip
 # is unlikely to handle the host's binaries.
 # Fortunately install-sh will honor a STRIPPROG variable, so we
-# always use install-sh in `make install-strip', and initialize
+# always use install-sh in "make install-strip", and initialize
 # STRIPPROG with the value of the STRIP variable (set by the user).
 AC_DEFUN([AM_PROG_INSTALL_STRIP],
 [AC_REQUIRE([AM_PROG_INSTALL_SH])dnl
-# Installed binaries are usually stripped using `strip' when the user
-# run `make install-strip'.  However `strip' might not be the right
+# Installed binaries are usually stripped using 'strip' when the user
+# run "make install-strip".  However 'strip' might not be the right
 # tool to use in cross-compilation environments, therefore Automake
-# will honor the `STRIP' environment variable to overrule this program.
-dnl Don't test for $cross_compiling = yes, because it might be `maybe'.
+# will honor the 'STRIP' environment variable to overrule this program.
+dnl Don't test for $cross_compiling = yes, because it might be 'maybe'.
 if test "$cross_compiling" != no; then
   AC_CHECK_TOOL([STRIP], [strip], :)
 fi
 INSTALL_STRIP_PROGRAM="\$(install_sh) -c -s"
 AC_SUBST([INSTALL_STRIP_PROGRAM])])
 
-# Copyright (C) 2006, 2008  Free Software Foundation, Inc.
+# Copyright (C) 2006-2012 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
 
-# serial 2
-
 # _AM_SUBST_NOTMAKE(VARIABLE)
 # ---------------------------
 # Prevent Automake from outputting VARIABLE = @VARIABLE@ in Makefile.in.
@@ -963,24 +982,22 @@ AC_SUBST([INSTALL_STRIP_PROGRAM])])
 AC_DEFUN([_AM_SUBST_NOTMAKE])
 
 # AM_SUBST_NOTMAKE(VARIABLE)
-# ---------------------------
+# --------------------------
 # Public sister of _AM_SUBST_NOTMAKE.
 AC_DEFUN([AM_SUBST_NOTMAKE], [_AM_SUBST_NOTMAKE($@)])
 
 # Check how to create a tarball.                            -*- Autoconf -*-
 
-# Copyright (C) 2004, 2005  Free Software Foundation, Inc.
+# Copyright (C) 2004-2012 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
 
-# serial 2
-
 # _AM_PROG_TAR(FORMAT)
 # --------------------
 # Check how to create a tarball in format FORMAT.
-# FORMAT should be one of `v7', `ustar', or `pax'.
+# FORMAT should be one of 'v7', 'ustar', or 'pax'.
 #
 # Substitute a variable $(am__tar) that is a command
 # writing to stdout a FORMAT-tarball containing the directory
@@ -991,10 +1008,11 @@ AC_DEFUN([AM_SUBST_NOTMAKE], [_AM_SUBST_NOTMAKE($@)])
 # a tarball read from stdin.
 #     $(am__untar) < result.tar
 AC_DEFUN([_AM_PROG_TAR],
-[# Always define AMTAR for backward compatibility.
-AM_MISSING_PROG([AMTAR], [tar])
+[# Always define AMTAR for backward compatibility.  Yes, it's still used
+# in the wild :-(  We should find a proper way to deprecate it ...
+AC_SUBST([AMTAR], ['$${TAR-tar}'])
 m4_if([$1], [v7],
-     [am__tar='${AMTAR} chof - "$$tardir"'; am__untar='${AMTAR} xf -'],
+     [am__tar='$${TAR-tar} chof - "$$tardir"' am__untar='$${TAR-tar} xf -'],
      [m4_case([$1], [ustar],, [pax],,
               [m4_fatal([Unknown tar format])])
 AC_MSG_CHECKING([how to create a $1 tar archive])
@@ -1002,7 +1020,7 @@ AC_MSG_CHECKING([how to create a $1 tar archive])
 _am_tools='gnutar m4_if([$1], [ustar], [plaintar]) pax cpio none'
 _am_tools=${am_cv_prog_tar_$1-$_am_tools}
 # Do not fold the above two line into one, because Tru64 sh and
-# Solaris sh will not grok spaces in the rhs of `-'.
+# Solaris sh will not grok spaces in the rhs of '-'.
 for _am_tool in $_am_tools
 do
   case $_am_tool in
diff --git a/autoregen.sh b/autoregen.sh
new file mode 100755
index 0000000..ac55ee0
--- /dev/null
+++ b/autoregen.sh
@@ -0,0 +1,2 @@
+#!/bin/sh
+./autogen.sh --noconfigure $@
diff --git a/config.h.in b/config.h.in
index 7175ecd..f482033 100644
--- a/config.h.in
+++ b/config.h.in
@@ -24,46 +24,46 @@
 /* Define to 1 if you have the <avi.h> header file. */
 #undef HAVE_AVI_H
 
-/* Define if the host CPU is an Alpha */
+/* Define if the target CPU is an Alpha */
 #undef HAVE_CPU_ALPHA
 
-/* Define if the host CPU is an ARM */
+/* Define if the target CPU is an ARM */
 #undef HAVE_CPU_ARM
 
-/* Define if the host CPU is a CRIS */
+/* Define if the target CPU is a CRIS */
 #undef HAVE_CPU_CRIS
 
-/* Define if the host CPU is a CRISv32 */
+/* Define if the target CPU is a CRISv32 */
 #undef HAVE_CPU_CRISV32
 
-/* Define if the host CPU is a HPPA */
+/* Define if the target CPU is a HPPA */
 #undef HAVE_CPU_HPPA
 
-/* Define if the host CPU is an x86 */
+/* Define if the target CPU is an x86 */
 #undef HAVE_CPU_I386
 
-/* Define if the host CPU is a IA64 */
+/* Define if the target CPU is a IA64 */
 #undef HAVE_CPU_IA64
 
-/* Define if the host CPU is a M68K */
+/* Define if the target CPU is a M68K */
 #undef HAVE_CPU_M68K
 
-/* Define if the host CPU is a MIPS */
+/* Define if the target CPU is a MIPS */
 #undef HAVE_CPU_MIPS
 
-/* Define if the host CPU is a PowerPC */
+/* Define if the target CPU is a PowerPC */
 #undef HAVE_CPU_PPC
 
-/* Define if the host CPU is a 64 bit PowerPC */
+/* Define if the target CPU is a 64 bit PowerPC */
 #undef HAVE_CPU_PPC64
 
-/* Define if the host CPU is a S390 */
+/* Define if the target CPU is a S390 */
 #undef HAVE_CPU_S390
 
-/* Define if the host CPU is a SPARC */
+/* Define if the target CPU is a SPARC */
 #undef HAVE_CPU_SPARC
 
-/* Define if the host CPU is a x86_64 */
+/* Define if the target CPU is a x86_64 */
 #undef HAVE_CPU_X86_64
 
 /* Define to 1 if you have the <dlfcn.h> header file. */
@@ -145,6 +145,9 @@
 /* Define to 1 if you have the ANSI C header files. */
 #undef STDC_HEADERS
 
+/* the target CPU */
+#undef TARGET_CPU
+
 /* Version number of package */
 #undef VERSION
 
diff --git a/configure b/configure
index 87e825e..874f0d7 100755
--- a/configure
+++ b/configure
@@ -1,13 +1,11 @@
 #! /bin/sh
 # Guess values for system-dependent variables and create Makefiles.
-# Generated by GNU Autoconf 2.68 for GStreamer Libav 0.10.13.
+# Generated by GNU Autoconf 2.69 for GStreamer Libav 0.10.13.1.
 #
 # Report bugs to <http://bugzilla.gnome.org/enter_bug.cgi?product=GStreamer>.
 #
 #
-# Copyright (C) 1992, 1993, 1994, 1995, 1996, 1998, 1999, 2000, 2001,
-# 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010 Free Software
-# Foundation, Inc.
+# Copyright (C) 1992-1996, 1998-2012 Free Software Foundation, Inc.
 #
 #
 # This configure script is free software; the Free Software Foundation
@@ -136,6 +134,31 @@ export LANGUAGE
 # CDPATH.
 (unset CDPATH) >/dev/null 2>&1 && unset CDPATH
 
+# Use a proper internal environment variable to ensure we don't fall
+  # into an infinite loop, continuously re-executing ourselves.
+  if test x"${_as_can_reexec}" != xno && test "x$CONFIG_SHELL" != x; then
+    _as_can_reexec=no; export _as_can_reexec;
+    # We cannot yet assume a decent shell, so we have to provide a
+# neutralization value for shells without unset; and this also
+# works around shells that cannot unset nonexistent variables.
+# Preserve -v and -x to the replacement shell.
+BASH_ENV=/dev/null
+ENV=/dev/null
+(unset BASH_ENV) >/dev/null 2>&1 && unset BASH_ENV ENV
+case $- in # ((((
+  *v*x* | *x*v* ) as_opts=-vx ;;
+  *v* ) as_opts=-v ;;
+  *x* ) as_opts=-x ;;
+  * ) as_opts= ;;
+esac
+exec $CONFIG_SHELL $as_opts "$as_myself" ${1+"$@"}
+# Admittedly, this is quite paranoid, since all the known shells bail
+# out after a failed `exec'.
+$as_echo "$0: could not re-execute with $CONFIG_SHELL" >&2
+as_fn_exit 255
+  fi
+  # We don't want this to propagate to other subprocesses.
+          { _as_can_reexec=; unset _as_can_reexec;}
 if test "x$CONFIG_SHELL" = x; then
   as_bourne_compatible="if test -n \"\${ZSH_VERSION+set}\" && (emulate sh) >/dev/null 2>&1; then :
   emulate sh
@@ -169,7 +192,8 @@ if ( set x; as_fn_ret_success y && test x = \"\$1\" ); then :
 else
   exitcode=1; echo positional parameters were not saved.
 fi
-test x\$exitcode = x0 || exit 1"
+test x\$exitcode = x0 || exit 1
+test -x / || exit 1"
   as_suggested="  as_lineno_1=";as_suggested=$as_suggested$LINENO;as_suggested=$as_suggested" as_lineno_1a=\$LINENO
   as_lineno_2=";as_suggested=$as_suggested$LINENO;as_suggested=$as_suggested" as_lineno_2a=\$LINENO
   eval 'test \"x\$as_lineno_1'\$as_run'\" != \"x\$as_lineno_2'\$as_run'\" &&
@@ -222,21 +246,25 @@ IFS=$as_save_IFS
 
 
       if test "x$CONFIG_SHELL" != x; then :
-  # We cannot yet assume a decent shell, so we have to provide a
-	# neutralization value for shells without unset; and this also
-	# works around shells that cannot unset nonexistent variables.
-	# Preserve -v and -x to the replacement shell.
-	BASH_ENV=/dev/null
-	ENV=/dev/null
-	(unset BASH_ENV) >/dev/null 2>&1 && unset BASH_ENV ENV
-	export CONFIG_SHELL
-	case $- in # ((((
-	  *v*x* | *x*v* ) as_opts=-vx ;;
-	  *v* ) as_opts=-v ;;
-	  *x* ) as_opts=-x ;;
-	  * ) as_opts= ;;
-	esac
-	exec "$CONFIG_SHELL" $as_opts "$as_myself" ${1+"$@"}
+  export CONFIG_SHELL
+             # We cannot yet assume a decent shell, so we have to provide a
+# neutralization value for shells without unset; and this also
+# works around shells that cannot unset nonexistent variables.
+# Preserve -v and -x to the replacement shell.
+BASH_ENV=/dev/null
+ENV=/dev/null
+(unset BASH_ENV) >/dev/null 2>&1 && unset BASH_ENV ENV
+case $- in # ((((
+  *v*x* | *x*v* ) as_opts=-vx ;;
+  *v* ) as_opts=-v ;;
+  *x* ) as_opts=-x ;;
+  * ) as_opts= ;;
+esac
+exec $CONFIG_SHELL $as_opts "$as_myself" ${1+"$@"}
+# Admittedly, this is quite paranoid, since all the known shells bail
+# out after a failed `exec'.
+$as_echo "$0: could not re-execute with $CONFIG_SHELL" >&2
+exit 255
 fi
 
     if test x$as_have_required = xno; then :
@@ -340,6 +368,14 @@ $as_echo X"$as_dir" |
 
 
 } # as_fn_mkdir_p
+
+# as_fn_executable_p FILE
+# -----------------------
+# Test if FILE is an executable regular file.
+as_fn_executable_p ()
+{
+  test -f "$1" && test -x "$1"
+} # as_fn_executable_p
 # as_fn_append VAR VALUE
 # ----------------------
 # Append the text in VALUE to the end of the definition contained in VAR. Take
@@ -461,6 +497,10 @@ as_cr_alnum=$as_cr_Letters$as_cr_digits
   chmod +x "$as_me.lineno" ||
     { $as_echo "$as_me: error: cannot create $as_me.lineno; rerun with a POSIX shell" >&2; as_fn_exit 1; }
 
+  # If we had to re-execute with $CONFIG_SHELL, we're ensured to have
+  # already done that, so ensure we don't try to do so again and fall
+  # in an infinite loop.  This has already happened in practice.
+  _as_can_reexec=no; export _as_can_reexec
   # Don't try to exec as it changes $[0], causing all sort of problems
   # (the dirname of $[0] is not the place where we might find the
   # original and so on.  Autoconf is especially sensitive to this).
@@ -495,16 +535,16 @@ if (echo >conf$$.file) 2>/dev/null; then
     # ... but there are two gotchas:
     # 1) On MSYS, both `ln -s file dir' and `ln file dir' fail.
     # 2) DJGPP < 2.04 has no symlinks; `ln -s' creates a wrapper executable.
-    # In both cases, we have to default to `cp -p'.
+    # In both cases, we have to default to `cp -pR'.
     ln -s conf$$.file conf$$.dir 2>/dev/null && test ! -f conf$$.exe ||
-      as_ln_s='cp -p'
+      as_ln_s='cp -pR'
   elif ln conf$$.file conf$$ 2>/dev/null; then
     as_ln_s=ln
   else
-    as_ln_s='cp -p'
+    as_ln_s='cp -pR'
   fi
 else
-  as_ln_s='cp -p'
+  as_ln_s='cp -pR'
 fi
 rm -f conf$$ conf$$.exe conf$$.dir/conf$$.file conf$$.file
 rmdir conf$$.dir 2>/dev/null
@@ -516,28 +556,8 @@ else
   as_mkdir_p=false
 fi
 
-if test -x / >/dev/null 2>&1; then
-  as_test_x='test -x'
-else
-  if ls -dL / >/dev/null 2>&1; then
-    as_ls_L_option=L
-  else
-    as_ls_L_option=
-  fi
-  as_test_x='
-    eval sh -c '\''
-      if test -d "$1"; then
-	test -d "$1/.";
-      else
-	case $1 in #(
-	-*)set "./$1";;
-	esac;
-	case `ls -ld'$as_ls_L_option' "$1" 2>/dev/null` in #((
-	???[sx]*):;;*)false;;esac;fi
-    '\'' sh
-  '
-fi
-as_executable_p=$as_test_x
+as_test_x='test -x'
+as_executable_p=as_fn_executable_p
 
 # Sed expression to map a string onto a valid CPP name.
 as_tr_cpp="eval sed 'y%*$as_cr_letters%P$as_cr_LETTERS%;s%[^_$as_cr_alnum]%_%g'"
@@ -571,8 +591,8 @@ MAKEFLAGS=
 # Identity of this package.
 PACKAGE_NAME='GStreamer Libav'
 PACKAGE_TARNAME='gst-ffmpeg'
-PACKAGE_VERSION='0.10.13'
-PACKAGE_STRING='GStreamer Libav 0.10.13'
+PACKAGE_VERSION='0.10.13.1'
+PACKAGE_STRING='GStreamer Libav 0.10.13.1'
 PACKAGE_BUGREPORT='http://bugzilla.gnome.org/enter_bug.cgi?product=GStreamer'
 PACKAGE_URL=''
 
@@ -770,6 +790,7 @@ SED
 am__fastdepCC_FALSE
 am__fastdepCC_TRUE
 CCDEPMODE
+am__nodep
 AMDEPBACKSLASH
 AMDEP_FALSE
 AMDEP_TRUE
@@ -790,14 +811,8 @@ AS
 GST_MAJORMINOR
 AM_BACKSLASH
 AM_DEFAULT_VERBOSITY
-host_os
-host_vendor
-host_cpu
-host
-build_os
-build_vendor
-build_cpu
-build
+AM_DEFAULT_V
+AM_V
 MAINT
 MAINTAINER_MODE_FALSE
 MAINTAINER_MODE_TRUE
@@ -829,6 +844,18 @@ am__isrc
 INSTALL_DATA
 INSTALL_SCRIPT
 INSTALL_PROGRAM
+target_os
+target_vendor
+target_cpu
+target
+host_os
+host_vendor
+host_cpu
+host
+build_os
+build_vendor
+build_cpu
+build
 target_alias
 host_alias
 build_alias
@@ -884,6 +911,7 @@ with_autoconf
 with_autoheader
 with_automake
 with_aclocal
+enable_fatal_warnings
 with_pkg_config_path
 with_package_name
 with_package_origin
@@ -1379,8 +1407,6 @@ target=$target_alias
 if test "x$host_alias" != x; then
   if test "x$build_alias" = x; then
     cross_compiling=maybe
-    $as_echo "$as_me: WARNING: if you wanted to set the --build type, don't use --host.
-    If a cross compiler is detected then cross compile mode will be used" >&2
   elif test "x$build_alias" != "x$host_alias"; then
     cross_compiling=yes
   fi
@@ -1466,7 +1492,7 @@ if test "$ac_init_help" = "long"; then
   # Omit some internal or obsolete options to make the list less imposing.
   # This message is too long to be a string in the A/UX 3.1 sh.
   cat <<_ACEOF
-\`configure' configures GStreamer Libav 0.10.13 to adapt to many kinds of systems.
+\`configure' configures GStreamer Libav 0.10.13.1 to adapt to many kinds of systems.
 
 Usage: $0 [OPTION]... [VAR=VALUE]...
 
@@ -1531,12 +1557,13 @@ Program names:
 System types:
   --build=BUILD     configure for building on BUILD [guessed]
   --host=HOST       cross-compile to build programs to run on HOST [BUILD]
+  --target=TARGET   configure for building compilers for TARGET [HOST]
 _ACEOF
 fi
 
 if test -n "$ac_init_help"; then
   case $ac_init_help in
-     short | recursive ) echo "Configuration of GStreamer Libav 0.10.13:";;
+     short | recursive ) echo "Configuration of GStreamer Libav 0.10.13.1:";;
    esac
   cat <<\_ACEOF
 
@@ -1544,17 +1571,22 @@ Optional Features:
   --disable-option-checking  ignore unrecognized --enable/--with options
   --disable-FEATURE       do not include FEATURE (same as --enable-FEATURE=no)
   --enable-FEATURE[=ARG]  include FEATURE [ARG=yes]
-  --enable-maintainer-mode  enable make rules and dependencies not useful
-			  (and sometimes confusing) to the casual installer
-  --enable-silent-rules          less verbose build output (undo: `make V=1')
-  --disable-silent-rules         verbose build output (undo: `make V=0')
+  --enable-maintainer-mode
+                          enable make rules and dependencies not useful (and
+                          sometimes confusing) to the casual installer
+  --enable-silent-rules   less verbose build output (undo: "make V=1")
+  --disable-silent-rules  verbose build output (undo: "make V=0")
   --enable-shared[=PKGS]  build shared libraries [default=yes]
   --enable-static[=PKGS]  build static libraries [default=yes]
   --enable-fast-install[=PKGS]
                           optimize for fast installation [default=yes]
-  --disable-dependency-tracking  speeds up one-time build
-  --enable-dependency-tracking   do not reject slow dependency extractors
+  --enable-dependency-tracking
+                          do not reject slow dependency extractors
+  --disable-dependency-tracking
+                          speeds up one-time build
   --disable-libtool-lock  avoid locking (might break parallel builds)
+  --disable-fatal-warnings
+                          Don't turn compiler warnings into fatal errors
   --disable-valgrind      disable run-time valgrind detection
   --enable-docbook        use docbook to build documentation [default=no]
   --enable-gtk-doc        use gtk-doc to build documentation [[default=no]]
@@ -1564,7 +1596,7 @@ Optional Features:
 Optional Packages:
   --with-PACKAGE[=ARG]    use PACKAGE [ARG=yes]
   --without-PACKAGE       do not use PACKAGE (same as --with-PACKAGE=no)
-  --with-pic              try to use only PIC/non-PIC objects [default=use
+  --with-pic[=PKGS]       try to use only PIC/non-PIC objects [default=use
                           both]
   --with-gnu-ld           assume the C compiler uses GNU ld [default=no]
   --with-sysroot=DIR Search for dependent libraries within DIR
@@ -1694,10 +1726,10 @@ fi
 test -n "$ac_init_help" && exit $ac_status
 if $ac_init_version; then
   cat <<\_ACEOF
-GStreamer Libav configure 0.10.13
-generated by GNU Autoconf 2.68
+GStreamer Libav configure 0.10.13.1
+generated by GNU Autoconf 2.69
 
-Copyright (C) 2010 Free Software Foundation, Inc.
+Copyright (C) 2012 Free Software Foundation, Inc.
 This configure script is free software; the Free Software Foundation
 gives unlimited permission to copy, distribute and modify it.
 _ACEOF
@@ -1773,7 +1805,7 @@ $as_echo "$ac_try_echo"; } >&5
 	 test ! -s conftest.err
        } && test -s conftest$ac_exeext && {
 	 test "$cross_compiling" = yes ||
-	 $as_test_x conftest$ac_exeext
+	 test -x conftest$ac_exeext
        }; then :
   ac_retval=0
 else
@@ -2109,8 +2141,8 @@ cat >config.log <<_ACEOF
 This file contains any messages produced by compilers while
 running configure, to aid debugging if configure makes a mistake.
 
-It was created by GStreamer Libav $as_me 0.10.13, which was
-generated by GNU Autoconf 2.68.  Invocation command line was
+It was created by GStreamer Libav $as_me 0.10.13.1, which was
+generated by GNU Autoconf 2.69.  Invocation command line was
 
   $ $0 $@
 
@@ -2458,12 +2490,6 @@ ac_compiler_gnu=$ac_cv_c_compiler_gnu
 
 
 
-
-
-
-
-am__api_version='1.11'
-
 ac_aux_dir=
 for ac_dir in "$srcdir" "$srcdir/.." "$srcdir/../.."; do
   if test -f "$ac_dir/install-sh"; then
@@ -2493,6 +2519,122 @@ ac_config_sub="$SHELL $ac_aux_dir/config.sub"  # Please don't use this var.
 ac_configure="$SHELL $ac_aux_dir/configure"  # Please don't use this var.
 
 
+# Make sure we can run config.sub.
+$SHELL "$ac_aux_dir/config.sub" sun4 >/dev/null 2>&1 ||
+  as_fn_error $? "cannot run $SHELL $ac_aux_dir/config.sub" "$LINENO" 5
+
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking build system type" >&5
+$as_echo_n "checking build system type... " >&6; }
+if ${ac_cv_build+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  ac_build_alias=$build_alias
+test "x$ac_build_alias" = x &&
+  ac_build_alias=`$SHELL "$ac_aux_dir/config.guess"`
+test "x$ac_build_alias" = x &&
+  as_fn_error $? "cannot guess build type; you must specify one" "$LINENO" 5
+ac_cv_build=`$SHELL "$ac_aux_dir/config.sub" $ac_build_alias` ||
+  as_fn_error $? "$SHELL $ac_aux_dir/config.sub $ac_build_alias failed" "$LINENO" 5
+
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_build" >&5
+$as_echo "$ac_cv_build" >&6; }
+case $ac_cv_build in
+*-*-*) ;;
+*) as_fn_error $? "invalid value of canonical build" "$LINENO" 5;;
+esac
+build=$ac_cv_build
+ac_save_IFS=$IFS; IFS='-'
+set x $ac_cv_build
+shift
+build_cpu=$1
+build_vendor=$2
+shift; shift
+# Remember, the first character of IFS is used to create $*,
+# except with old shells:
+build_os=$*
+IFS=$ac_save_IFS
+case $build_os in *\ *) build_os=`echo "$build_os" | sed 's/ /-/g'`;; esac
+
+
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking host system type" >&5
+$as_echo_n "checking host system type... " >&6; }
+if ${ac_cv_host+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  if test "x$host_alias" = x; then
+  ac_cv_host=$ac_cv_build
+else
+  ac_cv_host=`$SHELL "$ac_aux_dir/config.sub" $host_alias` ||
+    as_fn_error $? "$SHELL $ac_aux_dir/config.sub $host_alias failed" "$LINENO" 5
+fi
+
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_host" >&5
+$as_echo "$ac_cv_host" >&6; }
+case $ac_cv_host in
+*-*-*) ;;
+*) as_fn_error $? "invalid value of canonical host" "$LINENO" 5;;
+esac
+host=$ac_cv_host
+ac_save_IFS=$IFS; IFS='-'
+set x $ac_cv_host
+shift
+host_cpu=$1
+host_vendor=$2
+shift; shift
+# Remember, the first character of IFS is used to create $*,
+# except with old shells:
+host_os=$*
+IFS=$ac_save_IFS
+case $host_os in *\ *) host_os=`echo "$host_os" | sed 's/ /-/g'`;; esac
+
+
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking target system type" >&5
+$as_echo_n "checking target system type... " >&6; }
+if ${ac_cv_target+:} false; then :
+  $as_echo_n "(cached) " >&6
+else
+  if test "x$target_alias" = x; then
+  ac_cv_target=$ac_cv_host
+else
+  ac_cv_target=`$SHELL "$ac_aux_dir/config.sub" $target_alias` ||
+    as_fn_error $? "$SHELL $ac_aux_dir/config.sub $target_alias failed" "$LINENO" 5
+fi
+
+fi
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_target" >&5
+$as_echo "$ac_cv_target" >&6; }
+case $ac_cv_target in
+*-*-*) ;;
+*) as_fn_error $? "invalid value of canonical target" "$LINENO" 5;;
+esac
+target=$ac_cv_target
+ac_save_IFS=$IFS; IFS='-'
+set x $ac_cv_target
+shift
+target_cpu=$1
+target_vendor=$2
+shift; shift
+# Remember, the first character of IFS is used to create $*,
+# except with old shells:
+target_os=$*
+IFS=$ac_save_IFS
+case $target_os in *\ *) target_os=`echo "$target_os" | sed 's/ /-/g'`;; esac
+
+
+# The aliases save the names the user supplied, while $host etc.
+# will get canonicalized.
+test -n "$target_alias" &&
+  test "$program_prefix$program_suffix$program_transform_name" = \
+    NONENONEs,x,x, &&
+  program_prefix=${target_alias}-
+
+
+
+
+am__api_version='1.12'
+
 # Find a good install program.  We prefer a C program (faster),
 # so one script is as good as another.  But avoid the broken or
 # incompatible versions:
@@ -2530,7 +2672,7 @@ case $as_dir/ in #((
     # by default.
     for ac_prog in ginstall scoinst install; do
       for ac_exec_ext in '' $ac_executable_extensions; do
-	if { test -f "$as_dir/$ac_prog$ac_exec_ext" && $as_test_x "$as_dir/$ac_prog$ac_exec_ext"; }; then
+	if as_fn_executable_p "$as_dir/$ac_prog$ac_exec_ext"; then
 	  if test $ac_prog = install &&
 	    grep dspmsg "$as_dir/$ac_prog$ac_exec_ext" >/dev/null 2>&1; then
 	    # AIX install.  It has an incompatible calling convention.
@@ -2588,9 +2730,6 @@ test -z "$INSTALL_DATA" && INSTALL_DATA='${INSTALL} -m 644'
 
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking whether build environment is sane" >&5
 $as_echo_n "checking whether build environment is sane... " >&6; }
-# Just in case
-sleep 1
-echo timestamp > conftest.file
 # Reject unsafe characters in $srcdir or the absolute working directory
 # name.  Accept space and tab only in the latter.
 am_lf='
@@ -2601,32 +2740,40 @@ case `pwd` in
 esac
 case $srcdir in
   *[\\\"\#\$\&\'\`$am_lf\ \	]*)
-    as_fn_error $? "unsafe srcdir value: \`$srcdir'" "$LINENO" 5;;
+    as_fn_error $? "unsafe srcdir value: '$srcdir'" "$LINENO" 5;;
 esac
 
-# Do `set' in a subshell so we don't clobber the current shell's
+# Do 'set' in a subshell so we don't clobber the current shell's
 # arguments.  Must try -L first in case configure is actually a
 # symlink; some systems play weird games with the mod time of symlinks
 # (eg FreeBSD returns the mod time of the symlink's containing
 # directory).
 if (
-   set X `ls -Lt "$srcdir/configure" conftest.file 2> /dev/null`
-   if test "$*" = "X"; then
-      # -L didn't work.
-      set X `ls -t "$srcdir/configure" conftest.file`
-   fi
-   rm -f conftest.file
-   if test "$*" != "X $srcdir/configure conftest.file" \
-      && test "$*" != "X conftest.file $srcdir/configure"; then
-
-      # If neither matched, then we have a broken ls.  This can happen
-      # if, for instance, CONFIG_SHELL is bash and it inherits a
-      # broken ls alias from the environment.  This has actually
-      # happened.  Such a system could not be considered "sane".
-      as_fn_error $? "ls -t appears to fail.  Make sure there is not a broken
-alias in your environment" "$LINENO" 5
-   fi
-
+   am_has_slept=no
+   for am_try in 1 2; do
+     echo "timestamp, slept: $am_has_slept" > conftest.file
+     set X `ls -Lt "$srcdir/configure" conftest.file 2> /dev/null`
+     if test "$*" = "X"; then
+	# -L didn't work.
+	set X `ls -t "$srcdir/configure" conftest.file`
+     fi
+     if test "$*" != "X $srcdir/configure conftest.file" \
+	&& test "$*" != "X conftest.file $srcdir/configure"; then
+
+	# If neither matched, then we have a broken ls.  This can happen
+	# if, for instance, CONFIG_SHELL is bash and it inherits a
+	# broken ls alias from the environment.  This has actually
+	# happened.  Such a system could not be considered "sane".
+	as_fn_error $? "ls -t appears to fail.  Make sure there is not a broken
+  alias in your environment" "$LINENO" 5
+     fi
+     if test "$2" = conftest.file || test $am_try -eq 2; then
+       break
+     fi
+     # Just in case.
+     sleep 1
+     am_has_slept=yes
+   done
    test "$2" = conftest.file
    )
 then
@@ -2638,6 +2785,16 @@ Check your system clock" "$LINENO" 5
 fi
 { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
 $as_echo "yes" >&6; }
+# If we didn't sleep, we still need to ensure time stamps of config.status and
+# generated files are strictly newer.
+am_sleep_pid=
+if grep 'slept: no' conftest.file >/dev/null 2>&1; then
+  ( sleep 1 ) &
+  am_sleep_pid=$!
+fi
+
+rm -f conftest.file
+
 test "$program_prefix" != NONE &&
   program_transform_name="s&^&$program_prefix&;$program_transform_name"
 # Use a double $ so make ignores it.
@@ -2664,8 +2821,8 @@ if eval "$MISSING --run true"; then
   am_missing_run="$MISSING --run "
 else
   am_missing_run=
-  { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: \`missing' script is too old or missing" >&5
-$as_echo "$as_me: WARNING: \`missing' script is too old or missing" >&2;}
+  { $as_echo "$as_me:${as_lineno-$LINENO}: WARNING: 'missing' script is too old or missing" >&5
+$as_echo "$as_me: WARNING: 'missing' script is too old or missing" >&2;}
 fi
 
 if test x"${install_sh}" != xset; then
@@ -2677,10 +2834,10 @@ if test x"${install_sh}" != xset; then
   esac
 fi
 
-# Installed binaries are usually stripped using `strip' when the user
-# run `make install-strip'.  However `strip' might not be the right
+# Installed binaries are usually stripped using 'strip' when the user
+# run "make install-strip".  However 'strip' might not be the right
 # tool to use in cross-compilation environments, therefore Automake
-# will honor the `STRIP' environment variable to overrule this program.
+# will honor the 'STRIP' environment variable to overrule this program.
 if test "$cross_compiling" != no; then
   if test -n "$ac_tool_prefix"; then
   # Extract the first word of "${ac_tool_prefix}strip", so it can be a program name with args.
@@ -2699,7 +2856,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_STRIP="${ac_tool_prefix}strip"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -2739,7 +2896,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_ac_ct_STRIP="strip"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -2790,7 +2947,7 @@ do
   test -z "$as_dir" && as_dir=.
     for ac_prog in mkdir gmkdir; do
 	 for ac_exec_ext in '' $ac_executable_extensions; do
-	   { test -f "$as_dir/$ac_prog$ac_exec_ext" && $as_test_x "$as_dir/$ac_prog$ac_exec_ext"; } || continue
+	   as_fn_executable_p "$as_dir/$ac_prog$ac_exec_ext" || continue
 	   case `"$as_dir/$ac_prog$ac_exec_ext" --version 2>&1` in #(
 	     'mkdir (GNU coreutils) '* | \
 	     'mkdir (coreutils) '* | \
@@ -2819,12 +2976,6 @@ fi
 { $as_echo "$as_me:${as_lineno-$LINENO}: result: $MKDIR_P" >&5
 $as_echo "$MKDIR_P" >&6; }
 
-mkdir_p="$MKDIR_P"
-case $mkdir_p in
-  [\\/$]* | ?:[\\/]*) ;;
-  */*) mkdir_p="\$(top_builddir)/$mkdir_p" ;;
-esac
-
 for ac_prog in gawk mawk nawk awk
 do
   # Extract the first word of "$ac_prog", so it can be a program name with args.
@@ -2843,7 +2994,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_AWK="$ac_prog"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -2929,7 +3080,7 @@ fi
 
 # Define the identity of the package.
  PACKAGE='gst-ffmpeg'
- VERSION='0.10.13'
+ VERSION='0.10.13.1'
 
 
 cat >>confdefs.h <<_ACEOF
@@ -2957,13 +3108,19 @@ AUTOHEADER=${AUTOHEADER-"${am_missing_run}autoheader"}
 
 MAKEINFO=${MAKEINFO-"${am_missing_run}makeinfo"}
 
+# For better backward compatibility.  To be removed once Automake 1.9.x
+# dies out for good.  For more background, see:
+# <http://lists.gnu.org/archive/html/automake/2012-07/msg00001.html>
+# <http://lists.gnu.org/archive/html/automake/2012-07/msg00014.html>
+mkdir_p='$(MKDIR_P)'
+
 # We need awk for the "check" target.  The system "awk" is bad on
 # some platforms.
-# Always define AMTAR for backward compatibility.
-
-AMTAR=${AMTAR-"${am_missing_run}tar"}
+# Always define AMTAR for backward compatibility.  Yes, it's still used
+# in the wild :-(  We should find a proper way to deprecate it ...
+AMTAR='$${TAR-tar}'
 
-am__tar='${AMTAR} chof - "$$tardir"'; am__untar='${AMTAR} xf -'
+am__tar='$${TAR-tar} chof - "$$tardir"' am__untar='$${TAR-tar} xf -'
 
 
 
@@ -2971,9 +3128,9 @@ am__tar='${AMTAR} chof - "$$tardir"'; am__untar='${AMTAR} xf -'
 
 
 
-  PACKAGE_VERSION_MAJOR=$(echo 0.10.13 | cut -d'.' -f1)
-  PACKAGE_VERSION_MINOR=$(echo 0.10.13 | cut -d'.' -f2)
-  PACKAGE_VERSION_MICRO=$(echo 0.10.13 | cut -d'.' -f3)
+  PACKAGE_VERSION_MAJOR=$(echo 0.10.13.1 | cut -d'.' -f1)
+  PACKAGE_VERSION_MINOR=$(echo 0.10.13.1 | cut -d'.' -f2)
+  PACKAGE_VERSION_MICRO=$(echo 0.10.13.1 | cut -d'.' -f3)
 
 
 
@@ -2984,7 +3141,7 @@ am__tar='${AMTAR} chof - "$$tardir"'; am__untar='${AMTAR} xf -'
   { $as_echo "$as_me:${as_lineno-$LINENO}: checking nano version" >&5
 $as_echo_n "checking nano version... " >&6; }
 
-  NANO=$(echo 0.10.13 | cut -d'.' -f4)
+  NANO=$(echo 0.10.13.1 | cut -d'.' -f4)
 
   if test x"$NANO" = x || test "x$NANO" = "x0" ; then
     { $as_echo "$as_me:${as_lineno-$LINENO}: result: 0 (release)" >&5
@@ -3036,88 +3193,45 @@ fi
 
 
 
-# Make sure we can run config.sub.
-$SHELL "$ac_aux_dir/config.sub" sun4 >/dev/null 2>&1 ||
-  as_fn_error $? "cannot run $SHELL $ac_aux_dir/config.sub" "$LINENO" 5
 
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking build system type" >&5
-$as_echo_n "checking build system type... " >&6; }
-if ${ac_cv_build+:} false; then :
-  $as_echo_n "(cached) " >&6
-else
-  ac_build_alias=$build_alias
-test "x$ac_build_alias" = x &&
-  ac_build_alias=`$SHELL "$ac_aux_dir/config.guess"`
-test "x$ac_build_alias" = x &&
-  as_fn_error $? "cannot guess build type; you must specify one" "$LINENO" 5
-ac_cv_build=`$SHELL "$ac_aux_dir/config.sub" $ac_build_alias` ||
-  as_fn_error $? "$SHELL $ac_aux_dir/config.sub $ac_build_alias failed" "$LINENO" 5
 
+# Check whether --enable-silent-rules was given.
+if test "${enable_silent_rules+set}" = set; then :
+  enableval=$enable_silent_rules;
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_build" >&5
-$as_echo "$ac_cv_build" >&6; }
-case $ac_cv_build in
-*-*-*) ;;
-*) as_fn_error $? "invalid value of canonical build" "$LINENO" 5;;
-esac
-build=$ac_cv_build
-ac_save_IFS=$IFS; IFS='-'
-set x $ac_cv_build
-shift
-build_cpu=$1
-build_vendor=$2
-shift; shift
-# Remember, the first character of IFS is used to create $*,
-# except with old shells:
-build_os=$*
-IFS=$ac_save_IFS
-case $build_os in *\ *) build_os=`echo "$build_os" | sed 's/ /-/g'`;; esac
 
-
-{ $as_echo "$as_me:${as_lineno-$LINENO}: checking host system type" >&5
-$as_echo_n "checking host system type... " >&6; }
-if ${ac_cv_host+:} false; then :
+case $enable_silent_rules in # (((
+  yes) AM_DEFAULT_VERBOSITY=0;;
+   no) AM_DEFAULT_VERBOSITY=1;;
+    *) AM_DEFAULT_VERBOSITY=0;;
+esac
+am_make=${MAKE-make}
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking whether $am_make supports nested variables" >&5
+$as_echo_n "checking whether $am_make supports nested variables... " >&6; }
+if ${am_cv_make_support_nested_variables+:} false; then :
   $as_echo_n "(cached) " >&6
 else
-  if test "x$host_alias" = x; then
-  ac_cv_host=$ac_cv_build
+  if $as_echo 'TRUE=$(BAR$(V))
+BAR0=false
+BAR1=true
+V=1
+am__doit:
+	@$(TRUE)
+.PHONY: am__doit' | $am_make -f - >/dev/null 2>&1; then
+  am_cv_make_support_nested_variables=yes
 else
-  ac_cv_host=`$SHELL "$ac_aux_dir/config.sub" $host_alias` ||
-    as_fn_error $? "$SHELL $ac_aux_dir/config.sub $host_alias failed" "$LINENO" 5
+  am_cv_make_support_nested_variables=no
 fi
-
 fi
-{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $ac_cv_host" >&5
-$as_echo "$ac_cv_host" >&6; }
-case $ac_cv_host in
-*-*-*) ;;
-*) as_fn_error $? "invalid value of canonical host" "$LINENO" 5;;
-esac
-host=$ac_cv_host
-ac_save_IFS=$IFS; IFS='-'
-set x $ac_cv_host
-shift
-host_cpu=$1
-host_vendor=$2
-shift; shift
-# Remember, the first character of IFS is used to create $*,
-# except with old shells:
-host_os=$*
-IFS=$ac_save_IFS
-case $host_os in *\ *) host_os=`echo "$host_os" | sed 's/ /-/g'`;; esac
-
-
-
-# Check whether --enable-silent-rules was given.
-if test "${enable_silent_rules+set}" = set; then :
-  enableval=$enable_silent_rules;
+{ $as_echo "$as_me:${as_lineno-$LINENO}: result: $am_cv_make_support_nested_variables" >&5
+$as_echo "$am_cv_make_support_nested_variables" >&6; }
+if test $am_cv_make_support_nested_variables = yes; then
+    AM_V='$(V)'
+  AM_DEFAULT_V='$(AM_DEFAULT_VERBOSITY)'
+else
+  AM_V=$AM_DEFAULT_VERBOSITY
+  AM_DEFAULT_V=$AM_DEFAULT_VERBOSITY
 fi
-
-case $enable_silent_rules in
-yes) AM_DEFAULT_VERBOSITY=0;;
-no)  AM_DEFAULT_VERBOSITY=1;;
-*)   AM_DEFAULT_VERBOSITY=0;;
-esac
 AM_BACKSLASH='\'
 
 
@@ -3154,7 +3268,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_AS="${ac_tool_prefix}as"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -3194,7 +3308,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_ac_ct_AS="as"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -3246,7 +3360,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_DLLTOOL="${ac_tool_prefix}dlltool"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -3286,7 +3400,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_ac_ct_DLLTOOL="dlltool"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -3338,7 +3452,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_OBJDUMP="${ac_tool_prefix}objdump"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -3378,7 +3492,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_ac_ct_OBJDUMP="objdump"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -3444,8 +3558,8 @@ esac
 
 
 
-macro_version='2.4'
-macro_revision='1.3293'
+macro_version='2.4.2'
+macro_revision='1.3337'
 
 
 
@@ -3549,7 +3663,7 @@ am__quote=
 _am_result=none
 # First try GNU make style include.
 echo "include confinc" > confmf
-# Ignore all kinds of additional output from `make'.
+# Ignore all kinds of additional output from 'make'.
 case `$am_make -s -f confmf 2> /dev/null` in #(
 *the\ am__doit\ target*)
   am__include=include
@@ -3582,6 +3696,7 @@ fi
 if test "x$enable_dependency_tracking" != xno; then
   am_depcomp="$ac_aux_dir/depcomp"
   AMDEPBACKSLASH='\'
+  am__nodep='_no'
 fi
  if test "x$enable_dependency_tracking" != xno; then
   AMDEP_TRUE=
@@ -3614,7 +3729,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_CC="${ac_tool_prefix}gcc"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -3654,7 +3769,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_ac_ct_CC="gcc"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -3707,7 +3822,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_CC="${ac_tool_prefix}cc"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -3748,7 +3863,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     if test "$as_dir/$ac_word$ac_exec_ext" = "/usr/ucb/cc"; then
        ac_prog_rejected=yes
        continue
@@ -3806,7 +3921,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_CC="$ac_tool_prefix$ac_prog"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -3850,7 +3965,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_ac_ct_CC="$ac_prog"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -4296,8 +4411,7 @@ cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
 #include <stdarg.h>
 #include <stdio.h>
-#include <sys/types.h>
-#include <sys/stat.h>
+struct stat;
 /* Most of the following tests are stolen from RCS 5.7's src/conf.sh.  */
 struct buf { int x; };
 FILE * (*rcsopen) (struct buf *, struct stat *, int);
@@ -4393,8 +4507,9 @@ else
   # We make a subdir and do the tests there.  Otherwise we can end up
   # making bogus files that we don't know about and never remove.  For
   # instance it was reported that on HP-UX the gcc test will end up
-  # making a dummy file named `D' -- because `-MD' means `put the output
-  # in D'.
+  # making a dummy file named 'D' -- because '-MD' means "put the output
+  # in D".
+  rm -rf conftest.dir
   mkdir conftest.dir
   # Copy depcomp to subdir because otherwise we won't find it if we're
   # using a relative directory.
@@ -4428,16 +4543,16 @@ else
     : > sub/conftest.c
     for i in 1 2 3 4 5 6; do
       echo '#include "conftst'$i'.h"' >> sub/conftest.c
-      # Using `: > sub/conftst$i.h' creates only sub/conftst1.h with
-      # Solaris 8's {/usr,}/bin/sh.
-      touch sub/conftst$i.h
+      # Using ": > sub/conftst$i.h" creates only sub/conftst1.h with
+      # Solaris 10 /bin/sh.
+      echo '/* dummy */' > sub/conftst$i.h
     done
     echo "${am__include} ${am__quote}sub/conftest.Po${am__quote}" > confmf
 
-    # We check with `-c' and `-o' for the sake of the "dashmstdout"
+    # We check with '-c' and '-o' for the sake of the "dashmstdout"
     # mode.  It turns out that the SunPro C++ compiler does not properly
-    # handle `-M -o', and we need to detect this.  Also, some Intel
-    # versions had trouble with output in subdirs
+    # handle '-M -o', and we need to detect this.  Also, some Intel
+    # versions had trouble with output in subdirs.
     am__obj=sub/conftest.${OBJEXT-o}
     am__minus_obj="-o $am__obj"
     case $depmode in
@@ -4446,16 +4561,16 @@ else
       test "$am__universal" = false || continue
       ;;
     nosideeffect)
-      # after this tag, mechanisms are not by side-effect, so they'll
-      # only be used when explicitly requested
+      # After this tag, mechanisms are not by side-effect, so they'll
+      # only be used when explicitly requested.
       if test "x$enable_dependency_tracking" = xyes; then
 	continue
       else
 	break
       fi
       ;;
-    msvisualcpp | msvcmsys)
-      # This compiler won't grok `-c -o', but also, the minuso test has
+    msvc7 | msvc7msys | msvisualcpp | msvcmsys)
+      # This compiler won't grok '-c -o', but also, the minuso test has
       # not run yet.  These depmodes are late enough in the game, and
       # so weak that their functioning should not be impacted.
       am__obj=conftest.${OBJEXT-o}
@@ -4531,7 +4646,7 @@ do
     for ac_prog in sed gsed; do
     for ac_exec_ext in '' $ac_executable_extensions; do
       ac_path_SED="$as_dir/$ac_prog$ac_exec_ext"
-      { test -f "$ac_path_SED" && $as_test_x "$ac_path_SED"; } || continue
+      as_fn_executable_p "$ac_path_SED" || continue
 # Check for GNU ac_path_SED and select it if it is found.
   # Check for GNU $ac_path_SED
 case `"$ac_path_SED" --version 2>&1` in
@@ -4607,7 +4722,7 @@ do
     for ac_prog in grep ggrep; do
     for ac_exec_ext in '' $ac_executable_extensions; do
       ac_path_GREP="$as_dir/$ac_prog$ac_exec_ext"
-      { test -f "$ac_path_GREP" && $as_test_x "$ac_path_GREP"; } || continue
+      as_fn_executable_p "$ac_path_GREP" || continue
 # Check for GNU ac_path_GREP and select it if it is found.
   # Check for GNU $ac_path_GREP
 case `"$ac_path_GREP" --version 2>&1` in
@@ -4673,7 +4788,7 @@ do
     for ac_prog in egrep; do
     for ac_exec_ext in '' $ac_executable_extensions; do
       ac_path_EGREP="$as_dir/$ac_prog$ac_exec_ext"
-      { test -f "$ac_path_EGREP" && $as_test_x "$ac_path_EGREP"; } || continue
+      as_fn_executable_p "$ac_path_EGREP" || continue
 # Check for GNU ac_path_EGREP and select it if it is found.
   # Check for GNU $ac_path_EGREP
 case `"$ac_path_EGREP" --version 2>&1` in
@@ -4740,7 +4855,7 @@ do
     for ac_prog in fgrep; do
     for ac_exec_ext in '' $ac_executable_extensions; do
       ac_path_FGREP="$as_dir/$ac_prog$ac_exec_ext"
-      { test -f "$ac_path_FGREP" && $as_test_x "$ac_path_FGREP"; } || continue
+      as_fn_executable_p "$ac_path_FGREP" || continue
 # Check for GNU ac_path_FGREP and select it if it is found.
   # Check for GNU $ac_path_FGREP
 case `"$ac_path_FGREP" --version 2>&1` in
@@ -4996,7 +5111,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_DUMPBIN="$ac_tool_prefix$ac_prog"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -5040,7 +5155,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_ac_ct_DUMPBIN="$ac_prog"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -5198,6 +5313,11 @@ else
     lt_cv_sys_max_cmd_len=196608
     ;;
 
+  os2*)
+    # The test takes a long time on OS/2.
+    lt_cv_sys_max_cmd_len=8192
+    ;;
+
   osf*)
     # Dr. Hans Ekkehard Plesser reports seeing a kernel panic running configure
     # due to this test when exec_disable_arg_limit is 1 on Tru64. It is not
@@ -5237,7 +5357,7 @@ else
       # If test is not a shell built-in, we'll probably end up computing a
       # maximum length that is only half of the actual maximum length, but
       # we can't tell.
-      while { test "X"`func_fallback_echo "$teststring$teststring" 2>/dev/null` \
+      while { test "X"`env echo "$teststring$teststring" 2>/dev/null` \
 	         = "X$teststring$teststring"; } >/dev/null 2>&1 &&
 	      test $i != 17 # 1/2 MB should be enough
       do
@@ -5459,7 +5579,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_OBJDUMP="${ac_tool_prefix}objdump"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -5499,7 +5619,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_ac_ct_OBJDUMP="objdump"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -5663,7 +5783,7 @@ irix5* | irix6* | nonstopux*)
   lt_cv_deplibs_check_method=pass_all
   ;;
 
-# This must be Linux ELF.
+# This must be glibc/ELF.
 linux* | k*bsd*-gnu | kopensolaris*-gnu)
   lt_cv_deplibs_check_method=pass_all
   ;;
@@ -5802,7 +5922,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_DLLTOOL="${ac_tool_prefix}dlltool"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -5842,7 +5962,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_ac_ct_DLLTOOL="dlltool"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -5943,7 +6063,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_AR="$ac_tool_prefix$ac_prog"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -5987,7 +6107,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_ac_ct_AR="$ac_prog"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -6112,7 +6232,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_STRIP="${ac_tool_prefix}strip"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -6152,7 +6272,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_ac_ct_STRIP="strip"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -6211,7 +6331,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_RANLIB="${ac_tool_prefix}ranlib"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -6251,7 +6371,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_ac_ct_RANLIB="ranlib"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -6301,13 +6421,13 @@ old_postuninstall_cmds=
 if test -n "$RANLIB"; then
   case $host_os in
   openbsd*)
-    old_postinstall_cmds="$old_postinstall_cmds~\$RANLIB -t \$oldlib"
+    old_postinstall_cmds="$old_postinstall_cmds~\$RANLIB -t \$tool_oldlib"
     ;;
   *)
-    old_postinstall_cmds="$old_postinstall_cmds~\$RANLIB \$oldlib"
+    old_postinstall_cmds="$old_postinstall_cmds~\$RANLIB \$tool_oldlib"
     ;;
   esac
-  old_archive_cmds="$old_archive_cmds~\$RANLIB \$oldlib"
+  old_archive_cmds="$old_archive_cmds~\$RANLIB \$tool_oldlib"
 fi
 
 case $host_os in
@@ -6454,6 +6574,7 @@ for ac_symprfx in "" "_"; do
     # which start with @ or ?.
     lt_cv_sys_global_symbol_pipe="$AWK '"\
 "     {last_section=section; section=\$ 3};"\
+"     /^COFF SYMBOL TABLE/{for(i in hide) delete hide[i]};"\
 "     /Section length .*#relocs.*(pick any)/{hide[last_section]=1};"\
 "     \$ 0!~/External *\|/{next};"\
 "     / 0+ UNDEF /{next}; / UNDEF \([^|]\)*()/{next};"\
@@ -6842,7 +6963,7 @@ $as_echo "$lt_cv_cc_needs_belf" >&6; }
     CFLAGS="$SAVE_CFLAGS"
   fi
   ;;
-sparc*-*solaris*)
+*-*solaris*)
   # Find out which ABI we are using.
   echo 'int i;' > conftest.$ac_ext
   if { { eval echo "\"\$as_me\":${as_lineno-$LINENO}: \"$ac_compile\""; } >&5
@@ -6853,7 +6974,20 @@ sparc*-*solaris*)
     case `/usr/bin/file conftest.o` in
     *64-bit*)
       case $lt_cv_prog_gnu_ld in
-      yes*) LD="${LD-ld} -m elf64_sparc" ;;
+      yes*)
+        case $host in
+        i?86-*-solaris*)
+          LD="${LD-ld} -m elf_x86_64"
+          ;;
+        sparc*-*-solaris*)
+          LD="${LD-ld} -m elf64_sparc"
+          ;;
+        esac
+        # GNU ld 2.21 introduced _sol2 emulations.  Use them if available.
+        if ${LD-ld} -V | grep _sol2 >/dev/null 2>&1; then
+          LD="${LD-ld}_sol2"
+        fi
+        ;;
       *)
 	if ${LD-ld} -64 -r -o conftest2.o conftest.o >/dev/null 2>&1; then
 	  LD="${LD-ld} -64"
@@ -6886,7 +7020,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_MANIFEST_TOOL="${ac_tool_prefix}mt"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -6926,7 +7060,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_ac_ct_MANIFEST_TOOL="mt"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -7006,7 +7140,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_DSYMUTIL="${ac_tool_prefix}dsymutil"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -7046,7 +7180,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_ac_ct_DSYMUTIL="dsymutil"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -7098,7 +7232,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_NMEDIT="${ac_tool_prefix}nmedit"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -7138,7 +7272,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_ac_ct_NMEDIT="nmedit"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -7190,7 +7324,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_LIPO="${ac_tool_prefix}lipo"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -7230,7 +7364,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_ac_ct_LIPO="lipo"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -7282,7 +7416,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_OTOOL="${ac_tool_prefix}otool"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -7322,7 +7456,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_ac_ct_OTOOL="otool"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -7374,7 +7508,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_OTOOL64="${ac_tool_prefix}otool64"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -7414,7 +7548,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_ac_ct_OTOOL64="otool64"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -7493,7 +7627,13 @@ else
 	$LTCC $LTCFLAGS $LDFLAGS -o libconftest.dylib \
 	  -dynamiclib -Wl,-single_module conftest.c 2>conftest.err
         _lt_result=$?
-	if test -f libconftest.dylib && test ! -s conftest.err && test $_lt_result = 0; then
+	# If there is a non-empty error log, and "single_module"
+	# appears in it, assume the flag caused a linker warning
+        if test -s conftest.err && $GREP single_module conftest.err; then
+	  cat conftest.err >&5
+	# Otherwise, if the output was created with a 0 exit code from
+	# the compiler, it worked.
+	elif test -f libconftest.dylib && test $_lt_result -eq 0; then
 	  lt_cv_apple_cc_single_mod=yes
 	else
 	  cat conftest.err >&5
@@ -7504,6 +7644,7 @@ else
 fi
 { $as_echo "$as_me:${as_lineno-$LINENO}: result: $lt_cv_apple_cc_single_mod" >&5
 $as_echo "$lt_cv_apple_cc_single_mod" >&6; }
+
     { $as_echo "$as_me:${as_lineno-$LINENO}: checking for -exported_symbols_list linker flag" >&5
 $as_echo_n "checking for -exported_symbols_list linker flag... " >&6; }
 if ${lt_cv_ld_exported_symbols_list+:} false; then :
@@ -7536,6 +7677,7 @@ rm -f core conftest.err conftest.$ac_objext \
 fi
 { $as_echo "$as_me:${as_lineno-$LINENO}: result: $lt_cv_ld_exported_symbols_list" >&5
 $as_echo "$lt_cv_ld_exported_symbols_list" >&6; }
+
     { $as_echo "$as_me:${as_lineno-$LINENO}: checking for -force_load linker flag" >&5
 $as_echo_n "checking for -force_load linker flag... " >&6; }
 if ${lt_cv_ld_force_load+:} false; then :
@@ -7557,7 +7699,9 @@ _LT_EOF
       echo "$LTCC $LTCFLAGS $LDFLAGS -o conftest conftest.c -Wl,-force_load,./libconftest.a" >&5
       $LTCC $LTCFLAGS $LDFLAGS -o conftest conftest.c -Wl,-force_load,./libconftest.a 2>conftest.err
       _lt_result=$?
-      if test -f conftest && test ! -s conftest.err && test $_lt_result = 0 && $GREP forced_load conftest 2>&1 >/dev/null; then
+      if test -s conftest.err && $GREP force_load conftest.err; then
+	cat conftest.err >&5
+      elif test -f conftest && test $_lt_result -eq 0 && $GREP forced_load conftest >/dev/null 2>&1 ; then
 	lt_cv_ld_force_load=yes
       else
 	cat conftest.err >&5
@@ -7960,7 +8104,22 @@ fi
 
 # Check whether --with-pic was given.
 if test "${with_pic+set}" = set; then :
-  withval=$with_pic; pic_mode="$withval"
+  withval=$with_pic; lt_p=${PACKAGE-default}
+    case $withval in
+    yes|no) pic_mode=$withval ;;
+    *)
+      pic_mode=default
+      # Look at the argument we got.  We use all the common list separators.
+      lt_save_ifs="$IFS"; IFS="${IFS}$PATH_SEPARATOR,"
+      for lt_pkg in $withval; do
+	IFS="$lt_save_ifs"
+	if test "X$lt_pkg" = "X$lt_p"; then
+	  pic_mode=yes
+	fi
+      done
+      IFS="$lt_save_ifs"
+      ;;
+    esac
 else
   pic_mode=default
 fi
@@ -8038,6 +8197,10 @@ LIBTOOL='$(SHELL) $(top_builddir)/libtool'
 
 
 
+
+
+
+
 test -z "$LN_S" && LN_S="ln -s"
 
 
@@ -8497,7 +8660,9 @@ lt_prog_compiler_static=
     case $cc_basename in
     nvcc*) # Cuda Compiler Driver 2.2
       lt_prog_compiler_wl='-Xlinker '
-      lt_prog_compiler_pic='-Xcompiler -fPIC'
+      if test -n "$lt_prog_compiler_pic"; then
+        lt_prog_compiler_pic="-Xcompiler $lt_prog_compiler_pic"
+      fi
       ;;
     esac
   else
@@ -8588,18 +8753,33 @@ lt_prog_compiler_static=
 	;;
       *)
 	case `$CC -V 2>&1 | sed 5q` in
-	*Sun\ F* | *Sun*Fortran*)
+	*Sun\ Ceres\ Fortran* | *Sun*Fortran*\ [1-7].* | *Sun*Fortran*\ 8.[0-3]*)
 	  # Sun Fortran 8.3 passes all unrecognized flags to the linker
 	  lt_prog_compiler_pic='-KPIC'
 	  lt_prog_compiler_static='-Bstatic'
 	  lt_prog_compiler_wl=''
 	  ;;
+	*Sun\ F* | *Sun*Fortran*)
+	  lt_prog_compiler_pic='-KPIC'
+	  lt_prog_compiler_static='-Bstatic'
+	  lt_prog_compiler_wl='-Qoption ld '
+	  ;;
 	*Sun\ C*)
 	  # Sun C 5.9
 	  lt_prog_compiler_pic='-KPIC'
 	  lt_prog_compiler_static='-Bstatic'
 	  lt_prog_compiler_wl='-Wl,'
 	  ;;
+        *Intel*\ [CF]*Compiler*)
+	  lt_prog_compiler_wl='-Wl,'
+	  lt_prog_compiler_pic='-fPIC'
+	  lt_prog_compiler_static='-static'
+	  ;;
+	*Portland\ Group*)
+	  lt_prog_compiler_wl='-Wl,'
+	  lt_prog_compiler_pic='-fpic'
+	  lt_prog_compiler_static='-Bstatic'
+	  ;;
 	esac
 	;;
       esac
@@ -8961,7 +9141,6 @@ $as_echo_n "checking whether the $compiler linker ($LD) supports shared librarie
   hardcode_direct=no
   hardcode_direct_absolute=no
   hardcode_libdir_flag_spec=
-  hardcode_libdir_flag_spec_ld=
   hardcode_libdir_separator=
   hardcode_minus_L=no
   hardcode_shlibpath_var=unsupported
@@ -9211,8 +9390,7 @@ _LT_EOF
 	xlf* | bgf* | bgxlf* | mpixlf*)
 	  # IBM XL Fortran 10.1 on PPC cannot create shared libs itself
 	  whole_archive_flag_spec='--whole-archive$convenience --no-whole-archive'
-	  hardcode_libdir_flag_spec=
-	  hardcode_libdir_flag_spec_ld='-rpath $libdir'
+	  hardcode_libdir_flag_spec='${wl}-rpath ${wl}$libdir'
 	  archive_cmds='$LD -shared $libobjs $deplibs $linker_flags -soname $soname -o $lib'
 	  if test "x$supports_anon_versioning" = xyes; then
 	    archive_expsym_cmds='echo "{ global:" > $output_objdir/$libname.ver~
@@ -9591,6 +9769,7 @@ fi
 	# The linker will not automatically build a static lib if we build a DLL.
 	# _LT_TAGVAR(old_archive_from_new_cmds, )='true'
 	enable_shared_with_static_runtimes=yes
+	exclude_expsyms='_NULL_IMPORT_DESCRIPTOR|_IMPORT_DESCRIPTOR_.*'
 	export_symbols_cmds='$NM $libobjs $convenience | $global_symbol_pipe | $SED -e '\''/^[BCDGRS][ ]/s/.*[ ]\([^ ]*\)/\1,DATA/'\'' | $SED -e '\''/^[AITW][ ]/s/.*[ ]//'\'' | sort | uniq > $export_symbols'
 	# Don't use ranlib
 	old_postinstall_cmds='chmod 644 $oldlib'
@@ -9636,6 +9815,7 @@ fi
   hardcode_shlibpath_var=unsupported
   if test "$lt_cv_ld_force_load" = "yes"; then
     whole_archive_flag_spec='`for conv in $convenience\"\"; do test  -n \"$conv\" && new_convenience=\"$new_convenience ${wl}-force_load,$conv\"; done; func_echo_all \"$new_convenience\"`'
+
   else
     whole_archive_flag_spec=''
   fi
@@ -9664,10 +9844,6 @@ fi
       hardcode_shlibpath_var=no
       ;;
 
-    freebsd1*)
-      ld_shlibs=no
-      ;;
-
     # FreeBSD 2.2.[012] allows us to include c++rt0.o to get C++ constructor
     # support.  Future versions do this automatically, but an explicit c++rt0.o
     # does not break anything, and helps significantly (at the cost of a little
@@ -9680,7 +9856,7 @@ fi
       ;;
 
     # Unfortunately, older versions of FreeBSD 2 do not have this feature.
-    freebsd2*)
+    freebsd2.*)
       archive_cmds='$LD -Bshareable -o $lib $libobjs $deplibs $linker_flags'
       hardcode_direct=yes
       hardcode_minus_L=yes
@@ -9719,7 +9895,6 @@ fi
       fi
       if test "$with_gnu_ld" = no; then
 	hardcode_libdir_flag_spec='${wl}+b ${wl}$libdir'
-	hardcode_libdir_flag_spec_ld='+b $libdir'
 	hardcode_libdir_separator=:
 	hardcode_direct=yes
 	hardcode_direct_absolute=yes
@@ -10343,11 +10518,6 @@ esac
 
 
 
-
-
-
-
-
   { $as_echo "$as_me:${as_lineno-$LINENO}: checking dynamic linker characteristics" >&5
 $as_echo_n "checking dynamic linker characteristics... " >&6; }
 
@@ -10437,7 +10607,7 @@ need_version=unknown
 
 case $host_os in
 aix3*)
-  version_type=linux
+  version_type=linux # correct to gnu/linux during the next big refactor
   library_names_spec='${libname}${release}${shared_ext}$versuffix $libname.a'
   shlibpath_var=LIBPATH
 
@@ -10446,7 +10616,7 @@ aix3*)
   ;;
 
 aix[4-9]*)
-  version_type=linux
+  version_type=linux # correct to gnu/linux during the next big refactor
   need_lib_prefix=no
   need_version=no
   hardcode_into_libs=yes
@@ -10511,7 +10681,7 @@ beos*)
   ;;
 
 bsdi[45]*)
-  version_type=linux
+  version_type=linux # correct to gnu/linux during the next big refactor
   need_version=no
   library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext}$major $libname${shared_ext}'
   soname_spec='${libname}${release}${shared_ext}$major'
@@ -10650,7 +10820,7 @@ darwin* | rhapsody*)
   ;;
 
 dgux*)
-  version_type=linux
+  version_type=linux # correct to gnu/linux during the next big refactor
   need_lib_prefix=no
   need_version=no
   library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext}$major $libname$shared_ext'
@@ -10658,10 +10828,6 @@ dgux*)
   shlibpath_var=LD_LIBRARY_PATH
   ;;
 
-freebsd1*)
-  dynamic_linker=no
-  ;;
-
 freebsd* | dragonfly*)
   # DragonFly does not have aout.  When/if they implement a new
   # versioning mechanism, adjust this.
@@ -10669,18 +10835,11 @@ freebsd* | dragonfly*)
     objformat=`/usr/bin/objformat`
   else
     case $host_os in
-    freebsd[123]*) objformat=aout ;;
+    freebsd[23].*) objformat=aout ;;
     *) objformat=elf ;;
     esac
   fi
-  # Handle Gentoo/FreeBSD as it was Linux
-  case $host_vendor in
-    gentoo)
-      version_type=linux ;;
-    *)
-      version_type=freebsd-$objformat ;;
-  esac
-
+  version_type=freebsd-$objformat
   case $version_type in
     freebsd-elf*)
       library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext} $libname${shared_ext}'
@@ -10691,16 +10850,10 @@ freebsd* | dragonfly*)
       library_names_spec='${libname}${release}${shared_ext}$versuffix $libname${shared_ext}$versuffix'
       need_version=yes
       ;;
-    linux)
-      library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext}$major ${libname}${shared_ext}'
-      soname_spec='${libname}${release}${shared_ext}$major'
-      need_lib_prefix=no
-      need_version=no
-      ;;
   esac
   shlibpath_var=LD_LIBRARY_PATH
   case $host_os in
-  freebsd2*)
+  freebsd2.*)
     shlibpath_overrides_runpath=yes
     ;;
   freebsd3.[01]* | freebsdelf3.[01]*)
@@ -10720,17 +10873,18 @@ freebsd* | dragonfly*)
   ;;
 
 gnu*)
-  version_type=linux
+  version_type=linux # correct to gnu/linux during the next big refactor
   need_lib_prefix=no
   need_version=no
   library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext}${major} ${libname}${shared_ext}'
   soname_spec='${libname}${release}${shared_ext}$major'
   shlibpath_var=LD_LIBRARY_PATH
+  shlibpath_overrides_runpath=no
   hardcode_into_libs=yes
   ;;
 
 haiku*)
-  version_type=linux
+  version_type=linux # correct to gnu/linux during the next big refactor
   need_lib_prefix=no
   need_version=no
   dynamic_linker="$host_os runtime_loader"
@@ -10791,7 +10945,7 @@ hpux9* | hpux10* | hpux11*)
   ;;
 
 interix[3-9]*)
-  version_type=linux
+  version_type=linux # correct to gnu/linux during the next big refactor
   need_lib_prefix=no
   need_version=no
   library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext}$major ${libname}${shared_ext}'
@@ -10807,7 +10961,7 @@ irix5* | irix6* | nonstopux*)
     nonstopux*) version_type=nonstopux ;;
     *)
 	if test "$lt_cv_prog_gnu_ld" = yes; then
-		version_type=linux
+		version_type=linux # correct to gnu/linux during the next big refactor
 	else
 		version_type=irix
 	fi ;;
@@ -10844,9 +10998,9 @@ linux*oldld* | linux*aout* | linux*coff*)
   dynamic_linker=no
   ;;
 
-# This must be Linux ELF.
+# This must be glibc/ELF.
 linux* | k*bsd*-gnu | kopensolaris*-gnu)
-  version_type=linux
+  version_type=linux # correct to gnu/linux during the next big refactor
   need_lib_prefix=no
   need_version=no
   library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext}$major $libname${shared_ext}'
@@ -10928,7 +11082,7 @@ netbsd*)
   ;;
 
 newsos6)
-  version_type=linux
+  version_type=linux # correct to gnu/linux during the next big refactor
   library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext}$major $libname${shared_ext}'
   shlibpath_var=LD_LIBRARY_PATH
   shlibpath_overrides_runpath=yes
@@ -10997,7 +11151,7 @@ rdos*)
   ;;
 
 solaris*)
-  version_type=linux
+  version_type=linux # correct to gnu/linux during the next big refactor
   need_lib_prefix=no
   need_version=no
   library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext}$major $libname${shared_ext}'
@@ -11022,7 +11176,7 @@ sunos4*)
   ;;
 
 sysv4 | sysv4.3*)
-  version_type=linux
+  version_type=linux # correct to gnu/linux during the next big refactor
   library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext}$major $libname${shared_ext}'
   soname_spec='${libname}${release}${shared_ext}$major'
   shlibpath_var=LD_LIBRARY_PATH
@@ -11046,7 +11200,7 @@ sysv4 | sysv4.3*)
 
 sysv4*MP*)
   if test -d /usr/nec ;then
-    version_type=linux
+    version_type=linux # correct to gnu/linux during the next big refactor
     library_names_spec='$libname${shared_ext}.$versuffix $libname${shared_ext}.$major $libname${shared_ext}'
     soname_spec='$libname${shared_ext}.$major'
     shlibpath_var=LD_LIBRARY_PATH
@@ -11077,7 +11231,7 @@ sysv5* | sco3.2v5* | sco5v6* | unixware* | OpenUNIX* | sysv4*uw2*)
 
 tpf*)
   # TPF is a cross-target only.  Preferred cross-host = GNU/Linux.
-  version_type=linux
+  version_type=linux # correct to gnu/linux during the next big refactor
   need_lib_prefix=no
   need_version=no
   library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext}$major $libname${shared_ext}'
@@ -11087,7 +11241,7 @@ tpf*)
   ;;
 
 uts4*)
-  version_type=linux
+  version_type=linux # correct to gnu/linux during the next big refactor
   library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext}$major $libname${shared_ext}'
   soname_spec='${libname}${release}${shared_ext}$major'
   shlibpath_var=LD_LIBRARY_PATH
@@ -11869,6 +12023,8 @@ CC="$lt_save_CC"
 
 
 
+
+
         ac_config_commands="$ac_config_commands libtool"
 
 
@@ -11878,7 +12034,7 @@ CC="$lt_save_CC"
 
 
 
-GST_REQ=0.10.31
+GST_REQ=0.10.36.1
 ORC_REQ=0.4.6
 
 
@@ -11945,6 +12101,21 @@ ACLOCAL_AMFLAGS="-I m4 -I common/m4"
 
 
 
+  # Check whether --enable-fatal-warnings was given.
+if test "${enable_fatal_warnings+set}" = set; then :
+  enableval=$enable_fatal_warnings;
+      case "${enableval}" in
+        yes) FATAL_WARNINGS=yes ;;
+        no)  FATAL_WARNINGS=no ;;
+        *)   as_fn_error $? "bad value ${enableval} for --disable-fatal-warnings" "$LINENO" 5 ;;
+      esac
+
+else
+  FATAL_WARNINGS=no
+fi
+
+
+
 
 # Check whether --with-pkg-config-path was given.
 if test "${with_pkg_config_path+set}" = set; then :
@@ -12045,7 +12216,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_path_PKG_CONFIG="$as_dir/$ac_word$ac_exec_ext"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -12088,7 +12259,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_path_ac_pt_PKG_CONFIG="$as_dir/$ac_word$ac_exec_ext"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -12238,10 +12409,9 @@ $as_echo "$as_me: Using extra code paths for valgrind" >&6;}
 
 
 
-
-    case "x${host_cpu}" in
+    case "x${target_cpu}" in
     xi?86 | xk? | xi?86_64)
-      case $host_os in
+      case $target_os in
          solaris*)
             ac_fn_c_check_decl "$LINENO" "__i386" "ac_cv_have_decl___i386" "$ac_includes_default"
 if test "x$ac_cv_have_decl___i386" = xyes; then :
@@ -12277,7 +12447,7 @@ $as_echo "#define HAVE_CPU_X86_64 1" >>confdefs.h
 $as_echo "#define HAVE_CPU_I386 1" >>confdefs.h
 
 
-                                    case "x${host_cpu}" in
+                                    case "x${target_cpu}" in
               xi386 | xi486) ;;
             *)
 
@@ -12698,6 +12868,11 @@ cat >>confdefs.h <<_ACEOF
 _ACEOF
 
 
+cat >>confdefs.h <<_ACEOF
+#define TARGET_CPU "$target_cpu"
+_ACEOF
+
+
 
 
 ac_ext=c
@@ -12722,7 +12897,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_CC="${ac_tool_prefix}gcc"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -12762,7 +12937,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_ac_ct_CC="gcc"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -12815,7 +12990,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_CC="${ac_tool_prefix}cc"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -12856,7 +13031,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     if test "$as_dir/$ac_word$ac_exec_ext" = "/usr/ucb/cc"; then
        ac_prog_rejected=yes
        continue
@@ -12914,7 +13089,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_CC="$ac_tool_prefix$ac_prog"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -12958,7 +13133,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_ac_ct_CC="$ac_prog"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -13154,8 +13329,7 @@ cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
 #include <stdarg.h>
 #include <stdio.h>
-#include <sys/types.h>
-#include <sys/stat.h>
+struct stat;
 /* Most of the following tests are stolen from RCS 5.7's src/conf.sh.  */
 struct buf { int x; };
 FILE * (*rcsopen) (struct buf *, struct stat *, int);
@@ -13251,8 +13425,9 @@ else
   # We make a subdir and do the tests there.  Otherwise we can end up
   # making bogus files that we don't know about and never remove.  For
   # instance it was reported that on HP-UX the gcc test will end up
-  # making a dummy file named `D' -- because `-MD' means `put the output
-  # in D'.
+  # making a dummy file named 'D' -- because '-MD' means "put the output
+  # in D".
+  rm -rf conftest.dir
   mkdir conftest.dir
   # Copy depcomp to subdir because otherwise we won't find it if we're
   # using a relative directory.
@@ -13286,16 +13461,16 @@ else
     : > sub/conftest.c
     for i in 1 2 3 4 5 6; do
       echo '#include "conftst'$i'.h"' >> sub/conftest.c
-      # Using `: > sub/conftst$i.h' creates only sub/conftst1.h with
-      # Solaris 8's {/usr,}/bin/sh.
-      touch sub/conftst$i.h
+      # Using ": > sub/conftst$i.h" creates only sub/conftst1.h with
+      # Solaris 10 /bin/sh.
+      echo '/* dummy */' > sub/conftst$i.h
     done
     echo "${am__include} ${am__quote}sub/conftest.Po${am__quote}" > confmf
 
-    # We check with `-c' and `-o' for the sake of the "dashmstdout"
+    # We check with '-c' and '-o' for the sake of the "dashmstdout"
     # mode.  It turns out that the SunPro C++ compiler does not properly
-    # handle `-M -o', and we need to detect this.  Also, some Intel
-    # versions had trouble with output in subdirs
+    # handle '-M -o', and we need to detect this.  Also, some Intel
+    # versions had trouble with output in subdirs.
     am__obj=sub/conftest.${OBJEXT-o}
     am__minus_obj="-o $am__obj"
     case $depmode in
@@ -13304,16 +13479,16 @@ else
       test "$am__universal" = false || continue
       ;;
     nosideeffect)
-      # after this tag, mechanisms are not by side-effect, so they'll
-      # only be used when explicitly requested
+      # After this tag, mechanisms are not by side-effect, so they'll
+      # only be used when explicitly requested.
       if test "x$enable_dependency_tracking" = xyes; then
 	continue
       else
 	break
       fi
       ;;
-    msvisualcpp | msvcmsys)
-      # This compiler won't grok `-c -o', but also, the minuso test has
+    msvc7 | msvc7msys | msvisualcpp | msvcmsys)
+      # This compiler won't grok '-c -o', but also, the minuso test has
       # not run yet.  These depmodes are late enough in the game, and
       # so weak that their functioning should not be impacted.
       am__obj=conftest.${OBJEXT-o}
@@ -13517,7 +13692,7 @@ main ()
   return 0;
 }
 _ACEOF
-for ac_arg in '' -std=gnu99 -std=c99 -c99 -AC99 -xc99=all -qlanglvl=extc99
+for ac_arg in '' -std=gnu99 -std=c99 -c99 -AC99 -D_STDC_C99= -qlanglvl=extc99
 do
   CC="$ac_save_CC $ac_arg"
   if ac_fn_c_try_compile "$LINENO"; then :
@@ -13557,8 +13732,7 @@ cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
 #include <stdarg.h>
 #include <stdio.h>
-#include <sys/types.h>
-#include <sys/stat.h>
+struct stat;
 /* Most of the following tests are stolen from RCS 5.7's src/conf.sh.  */
 struct buf { int x; };
 FILE * (*rcsopen) (struct buf *, struct stat *, int);
@@ -13806,7 +13980,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_path_VALGRIND_PATH="$as_dir/$ac_word$ac_exec_ext"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -13873,7 +14047,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_HAVE_DOCBOOK2PS="yes"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -13911,7 +14085,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_HAVE_DOCBOOK2HTML="yes"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -13949,7 +14123,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_HAVE_JADETEX="yes"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -13987,7 +14161,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_HAVE_PS2PDF="yes"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -14073,7 +14247,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_XSLTPROC="xsltproc"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -14146,7 +14320,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_HAVE_DVIPS="yes"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -14184,7 +14358,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_HAVE_XMLLINT="yes"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -14223,7 +14397,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_HAVE_FIG2DEV="yes"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -14288,7 +14462,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_HAVE_PNGTOPNM="yes"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -14326,7 +14500,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_HAVE_PNMTOPS="yes"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -14364,7 +14538,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_prog_HAVE_EPSTOPDF="yes"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -14528,7 +14702,7 @@ do
     for ac_prog in sed gsed; do
     for ac_exec_ext in '' $ac_executable_extensions; do
       ac_path_SED="$as_dir/$ac_prog$ac_exec_ext"
-      { test -f "$ac_path_SED" && $as_test_x "$ac_path_SED"; } || continue
+      as_fn_executable_p "$ac_path_SED" || continue
 # Check for GNU ac_path_SED and select it if it is found.
   # Check for GNU $ac_path_SED
 case `"$ac_path_SED" --version 2>&1` in
@@ -14603,7 +14777,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_path_GTKDOC_CHECK="$as_dir/$ac_word$ac_exec_ext"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -14685,7 +14859,7 @@ do
   IFS=$as_save_IFS
   test -z "$as_dir" && as_dir=.
     for ac_exec_ext in '' $ac_executable_extensions; do
-  if { test -f "$as_dir/$ac_word$ac_exec_ext" && $as_test_x "$as_dir/$ac_word$ac_exec_ext"; }; then
+  if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then
     ac_cv_path_PYTHON="$as_dir/$ac_word$ac_exec_ext"
     $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext" >&5
     break 2
@@ -15894,7 +16068,7 @@ rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
 $as_echo "$flag_ok" >&6; }
 
 
-    if test "x$GST_GIT" != "xno"
+    if test "x$FATAL_WARNINGS" != "xno"
   then
 
   { $as_echo "$as_me:${as_lineno-$LINENO}: checking to see if compiler understands -Werror" >&5
@@ -16696,8 +16870,8 @@ fi
   embffmpeg_configure_args="--prefix=$prefix"
 
   # Enable pic and static so that we get .a files, but with PIC code.
-  embffmpeg_configure_args="$embffmpeg_configure_args --disable-ffserver --disable-ffplay\
-        --disable-ffmpeg --disable-ffprobe --enable-static --enable-pic \
+  embffmpeg_configure_args="$embffmpeg_configure_args --disable-avserver --disable-avplay\
+        --disable-ffmpeg --disable-avprobe --enable-static --enable-pic \
 	--disable-encoder=flac --disable-decoder=cavs --disable-protocols --disable-devices\
 	--disable-network --disable-hwaccels --disable-filters --disable-doc\
 	--enable-optimizations"
@@ -16708,7 +16882,15 @@ fi
   fi
 
   # if we are cross-compiling, tell ffmpeg so
-  target_os=`echo $host_os | sed 's/-gnu//'`
+  case $host in
+      *android*)
+        target_os=linux
+      ;;
+      *)
+        target_os=`echo $host_os | sed 's/-gnu//'`
+      ;;
+  esac
+
   if test "x$cross_compiling" = xyes; then
     embffmpeg_configure_args="$embffmpeg_configure_args --enable-cross-compile \
         --target-os=$target_os --arch=$host_cpu --cross-prefix=$host_alias-"
@@ -16891,6 +17073,14 @@ LIBOBJS=$ac_libobjs
 LTLIBOBJS=$ac_ltlibobjs
 
 
+{ $as_echo "$as_me:${as_lineno-$LINENO}: checking that generated files are newer than configure" >&5
+$as_echo_n "checking that generated files are newer than configure... " >&6; }
+   if test -n "$am_sleep_pid"; then
+     # Hide warnings about reused PIDs.
+     wait $am_sleep_pid 2>/dev/null
+   fi
+   { $as_echo "$as_me:${as_lineno-$LINENO}: result: done" >&5
+$as_echo "done" >&6; }
  if test -n "$EXEEXT"; then
   am__EXEEXT_TRUE=
   am__EXEEXT_FALSE='#'
@@ -17326,16 +17516,16 @@ if (echo >conf$$.file) 2>/dev/null; then
     # ... but there are two gotchas:
     # 1) On MSYS, both `ln -s file dir' and `ln file dir' fail.
     # 2) DJGPP < 2.04 has no symlinks; `ln -s' creates a wrapper executable.
-    # In both cases, we have to default to `cp -p'.
+    # In both cases, we have to default to `cp -pR'.
     ln -s conf$$.file conf$$.dir 2>/dev/null && test ! -f conf$$.exe ||
-      as_ln_s='cp -p'
+      as_ln_s='cp -pR'
   elif ln conf$$.file conf$$ 2>/dev/null; then
     as_ln_s=ln
   else
-    as_ln_s='cp -p'
+    as_ln_s='cp -pR'
   fi
 else
-  as_ln_s='cp -p'
+  as_ln_s='cp -pR'
 fi
 rm -f conf$$ conf$$.exe conf$$.dir/conf$$.file conf$$.file
 rmdir conf$$.dir 2>/dev/null
@@ -17395,28 +17585,16 @@ else
   as_mkdir_p=false
 fi
 
-if test -x / >/dev/null 2>&1; then
-  as_test_x='test -x'
-else
-  if ls -dL / >/dev/null 2>&1; then
-    as_ls_L_option=L
-  else
-    as_ls_L_option=
-  fi
-  as_test_x='
-    eval sh -c '\''
-      if test -d "$1"; then
-	test -d "$1/.";
-      else
-	case $1 in #(
-	-*)set "./$1";;
-	esac;
-	case `ls -ld'$as_ls_L_option' "$1" 2>/dev/null` in #((
-	???[sx]*):;;*)false;;esac;fi
-    '\'' sh
-  '
-fi
-as_executable_p=$as_test_x
+
+# as_fn_executable_p FILE
+# -----------------------
+# Test if FILE is an executable regular file.
+as_fn_executable_p ()
+{
+  test -f "$1" && test -x "$1"
+} # as_fn_executable_p
+as_test_x='test -x'
+as_executable_p=as_fn_executable_p
 
 # Sed expression to map a string onto a valid CPP name.
 as_tr_cpp="eval sed 'y%*$as_cr_letters%P$as_cr_LETTERS%;s%[^_$as_cr_alnum]%_%g'"
@@ -17437,8 +17615,8 @@ cat >>$CONFIG_STATUS <<\_ACEOF || ac_write_fail=1
 # report actual input values of CONFIG_FILES etc. instead of their
 # values after options handling.
 ac_log="
-This file was extended by GStreamer Libav $as_me 0.10.13, which was
-generated by GNU Autoconf 2.68.  Invocation command line was
+This file was extended by GStreamer Libav $as_me 0.10.13.1, which was
+generated by GNU Autoconf 2.69.  Invocation command line was
 
   CONFIG_FILES    = $CONFIG_FILES
   CONFIG_HEADERS  = $CONFIG_HEADERS
@@ -17503,11 +17681,11 @@ _ACEOF
 cat >>$CONFIG_STATUS <<_ACEOF || ac_write_fail=1
 ac_cs_config="`$as_echo "$ac_configure_args" | sed 's/^ //; s/[\\""\`\$]/\\\\&/g'`"
 ac_cs_version="\\
-GStreamer Libav config.status 0.10.13
-configured by $0, generated by GNU Autoconf 2.68,
+GStreamer Libav config.status 0.10.13.1
+configured by $0, generated by GNU Autoconf 2.69,
   with options \\"\$ac_cs_config\\"
 
-Copyright (C) 2010 Free Software Foundation, Inc.
+Copyright (C) 2012 Free Software Foundation, Inc.
 This config.status script is free software; the Free Software Foundation
 gives unlimited permission to copy, distribute and modify it."
 
@@ -17598,7 +17776,7 @@ fi
 _ACEOF
 cat >>$CONFIG_STATUS <<_ACEOF || ac_write_fail=1
 if \$ac_cs_recheck; then
-  set X '$SHELL' '$0' $ac_configure_args \$ac_configure_extra_args --no-create --no-recursion
+  set X $SHELL '$0' $ac_configure_args \$ac_configure_extra_args --no-create --no-recursion
   shift
   \$as_echo "running CONFIG_SHELL=$SHELL \$*" >&6
   CONFIG_SHELL='$SHELL'
@@ -17643,6 +17821,7 @@ pic_mode='`$ECHO "$pic_mode" | $SED "$delay_single_quote_subst"`'
 enable_fast_install='`$ECHO "$enable_fast_install" | $SED "$delay_single_quote_subst"`'
 SHELL='`$ECHO "$SHELL" | $SED "$delay_single_quote_subst"`'
 ECHO='`$ECHO "$ECHO" | $SED "$delay_single_quote_subst"`'
+PATH_SEPARATOR='`$ECHO "$PATH_SEPARATOR" | $SED "$delay_single_quote_subst"`'
 host_alias='`$ECHO "$host_alias" | $SED "$delay_single_quote_subst"`'
 host='`$ECHO "$host" | $SED "$delay_single_quote_subst"`'
 host_os='`$ECHO "$host_os" | $SED "$delay_single_quote_subst"`'
@@ -17723,7 +17902,6 @@ with_gnu_ld='`$ECHO "$with_gnu_ld" | $SED "$delay_single_quote_subst"`'
 allow_undefined_flag='`$ECHO "$allow_undefined_flag" | $SED "$delay_single_quote_subst"`'
 no_undefined_flag='`$ECHO "$no_undefined_flag" | $SED "$delay_single_quote_subst"`'
 hardcode_libdir_flag_spec='`$ECHO "$hardcode_libdir_flag_spec" | $SED "$delay_single_quote_subst"`'
-hardcode_libdir_flag_spec_ld='`$ECHO "$hardcode_libdir_flag_spec_ld" | $SED "$delay_single_quote_subst"`'
 hardcode_libdir_separator='`$ECHO "$hardcode_libdir_separator" | $SED "$delay_single_quote_subst"`'
 hardcode_direct='`$ECHO "$hardcode_direct" | $SED "$delay_single_quote_subst"`'
 hardcode_direct_absolute='`$ECHO "$hardcode_direct_absolute" | $SED "$delay_single_quote_subst"`'
@@ -17782,6 +17960,7 @@ DLLTOOL \
 OBJDUMP \
 SHELL \
 ECHO \
+PATH_SEPARATOR \
 SED \
 GREP \
 EGREP \
@@ -17830,7 +18009,6 @@ with_gnu_ld \
 allow_undefined_flag \
 no_undefined_flag \
 hardcode_libdir_flag_spec \
-hardcode_libdir_flag_spec_ld \
 hardcode_libdir_separator \
 exclude_expsyms \
 include_expsyms \
@@ -18540,7 +18718,7 @@ $as_echo "$as_me: executing $ac_file commands" >&6;}
     # Strip MF so we end up with the name of the file.
     mf=`echo "$mf" | sed -e 's/:.*$//'`
     # Check whether this is an Automake generated Makefile or not.
-    # We used to match only the files named `Makefile.in', but
+    # We used to match only the files named 'Makefile.in', but
     # some people rename them; so instead we look at the file content.
     # Grep'ing the first line is not enough: some people post-process
     # each Makefile.in and add a new line on top of each file to say so.
@@ -18574,21 +18752,19 @@ $as_echo X"$mf" |
       continue
     fi
     # Extract the definition of DEPDIR, am__include, and am__quote
-    # from the Makefile without running `make'.
+    # from the Makefile without running 'make'.
     DEPDIR=`sed -n 's/^DEPDIR = //p' < "$mf"`
     test -z "$DEPDIR" && continue
     am__include=`sed -n 's/^am__include = //p' < "$mf"`
     test -z "am__include" && continue
     am__quote=`sed -n 's/^am__quote = //p' < "$mf"`
-    # When using ansi2knr, U may be empty or an underscore; expand it
-    U=`sed -n 's/^U = //p' < "$mf"`
     # Find all dependency output files, they are included files with
     # $(DEPDIR) in their names.  We invoke sed twice because it is the
     # simplest approach to changing $(DEPDIR) to its actual value in the
     # expansion.
     for file in `sed -n "
       s/^$am__include $am__quote\(.*(DEPDIR).*\)$am__quote"'$/\1/p' <"$mf" | \
-	 sed -e 's/\$(DEPDIR)/'"$DEPDIR"'/g' -e 's/\$U/'"$U"'/g'`; do
+	 sed -e 's/\$(DEPDIR)/'"$DEPDIR"'/g'`; do
       # Make sure the directory exists.
       test -f "$dirpart/$file" && continue
       fdir=`$as_dirname -- "$file" ||
@@ -18642,8 +18818,8 @@ $as_echo X"$file" |
 # NOTE: Changes made to this file will be lost: look at ltmain.sh.
 #
 #   Copyright (C) 1996, 1997, 1998, 1999, 2000, 2001, 2003, 2004, 2005,
-#                 2006, 2007, 2008, 2009, 2010 Free Software Foundation,
-#                 Inc.
+#                 2006, 2007, 2008, 2009, 2010, 2011 Free Software
+#                 Foundation, Inc.
 #   Written by Gordon Matzigkeit, 1996
 #
 #   This file is part of GNU Libtool.
@@ -18706,6 +18882,9 @@ SHELL=$lt_SHELL
 # An echo program that protects backslashes.
 ECHO=$lt_ECHO
 
+# The PATH separator for the build system.
+PATH_SEPARATOR=$lt_PATH_SEPARATOR
+
 # The host system.
 host_alias=$host_alias
 host=$host
@@ -19001,10 +19180,6 @@ no_undefined_flag=$lt_no_undefined_flag
 # This must work even if \$libdir does not exist
 hardcode_libdir_flag_spec=$lt_hardcode_libdir_flag_spec
 
-# If ld is used when linking, flag to hardcode \$libdir into a binary
-# during linking.  This must work even if \$libdir does not exist.
-hardcode_libdir_flag_spec_ld=$lt_hardcode_libdir_flag_spec_ld
-
 # Whether we need a single "-rpath" flag with a separated argument.
 hardcode_libdir_separator=$lt_hardcode_libdir_separator
 
@@ -19260,7 +19435,7 @@ fi
                if test -z "$srcdir" -o "$srcdir" = .; then
        confcmd=./configure
      else
-       confcmd="$origdir"/"$ac_top_srcdir"/gst-libs/ext/libav/configure
+       confcmd="$ac_abs_top_srcdir"/gst-libs/ext/libav/configure
      fi
 
      as_dir="$ac_top_build_prefix"gst-libs/ext/libav; as_fn_mkdir_p
diff --git a/configure.ac b/configure.ac
index 9271c1d..10d2c23 100644
--- a/configure.ac
+++ b/configure.ac
@@ -3,7 +3,7 @@ AC_PREREQ(2.60)
 dnl initialize autoconf
 dnl when going to/from release please set the nano (fourth number) right !
 dnl releases only do Wall, cvs and prerelease does Werror too
-AC_INIT(GStreamer Libav, 0.10.13,
+AC_INIT(GStreamer Libav, 0.10.13.1,
     http://bugzilla.gnome.org/enter_bug.cgi?product=GStreamer,
     gst-ffmpeg)
 
@@ -47,7 +47,7 @@ AC_LIBTOOL_WIN32_DLL
 AM_PROG_LIBTOOL
 
 dnl *** required versions of GStreamer stuff ***
-GST_REQ=0.10.31
+GST_REQ=0.10.36.1
 ORC_REQ=0.4.6
 
 dnl *** autotools stuff ****
@@ -60,6 +60,8 @@ AC_SUBST(ACLOCAL_AMFLAGS, "-I m4 -I common/m4")
 
 dnl *** check for arguments to configure ***
 
+AG_GST_ARG_DISABLE_FATAL_WARNINGS
+
 AG_GST_ARG_WITH_PKG_CONFIG_PATH
 AG_GST_ARG_WITH_PACKAGE_NAME
 AG_GST_ARG_WITH_PACKAGE_ORIGIN
@@ -132,7 +134,7 @@ dnl set location of plugin directory
 AG_GST_SET_PLUGINDIR
 
 dnl define an ERROR_CFLAGS Makefile variable
-AG_GST_SET_ERROR_CFLAGS($GST_GIT, [
+AG_GST_SET_ERROR_CFLAGS($FATAL_WARNINGS, [
     -Wmissing-declarations -Wmissing-prototypes -Wredundant-decls -Wundef
     -Wwrite-strings -Wformat-nonliteral -Wformat-security -Wold-style-definition
     -Winit-self -Wmissing-include-dirs -Waddress
@@ -314,8 +316,8 @@ else
   embffmpeg_configure_args="--prefix=$prefix"
 
   # Enable pic and static so that we get .a files, but with PIC code.
-  embffmpeg_configure_args="$embffmpeg_configure_args --disable-ffserver --disable-ffplay\
-        --disable-ffmpeg --disable-ffprobe --enable-static --enable-pic \
+  embffmpeg_configure_args="$embffmpeg_configure_args --disable-avserver --disable-avplay\
+        --disable-ffmpeg --disable-avprobe --enable-static --enable-pic \
 	--disable-encoder=flac --disable-decoder=cavs --disable-protocols --disable-devices\
 	--disable-network --disable-hwaccels --disable-filters --disable-doc\
 	--enable-optimizations"
@@ -326,7 +328,15 @@ else
   fi
 
   # if we are cross-compiling, tell ffmpeg so
-  target_os=`echo $host_os | sed 's/-gnu//'`
+  case $host in
+      *android*)
+        target_os=linux
+      ;;
+      *)
+        target_os=`echo $host_os | sed 's/-gnu//'`
+      ;;
+  esac
+
   if test "x$cross_compiling" = xyes; then
     embffmpeg_configure_args="$embffmpeg_configure_args --enable-cross-compile \
         --target-os=$target_os --arch=$host_cpu --cross-prefix=$host_alias-"
@@ -379,7 +389,7 @@ else
      if test -z "$srcdir" -o "$srcdir" = .; then
        confcmd=./configure
      else
-       confcmd="$origdir"/"$ac_top_srcdir"/gst-libs/ext/libav/configure
+       confcmd="$ac_abs_top_srcdir"/gst-libs/ext/libav/configure
      fi
 
      AS_MKDIR_P(["$ac_top_build_prefix"gst-libs/ext/libav])
diff --git a/ext/Makefile.in b/ext/Makefile.in
index 5b7ed04..69a0323 100644
--- a/ext/Makefile.in
+++ b/ext/Makefile.in
@@ -1,9 +1,8 @@
-# Makefile.in generated by automake 1.11.1 from Makefile.am.
+# Makefile.in generated by automake 1.12.6 from Makefile.am.
 # @configure_input@
 
-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
-# Inc.
+# Copyright (C) 1994-2012 Free Software Foundation, Inc.
+
 # This Makefile.in is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
@@ -15,6 +14,23 @@
 
 @SET_MAKE@
 VPATH = @srcdir@
+am__make_dryrun = \
+  { \
+    am__dry=no; \
+    case $$MAKEFLAGS in \
+      *\\[\ \	]*) \
+        echo 'am--echo: ; @echo "AM"  OK' | $(MAKE) -f - 2>/dev/null \
+          | grep '^AM OK$$' >/dev/null || am__dry=yes;; \
+      *) \
+        for am__flg in $$MAKEFLAGS; do \
+          case $$am__flg in \
+            *=*|--*) ;; \
+            *n*) am__dry=yes; break;; \
+          esac; \
+        done;; \
+    esac; \
+    test $$am__dry = yes; \
+  }
 pkgdatadir = $(datadir)/@PACKAGE@
 pkgincludedir = $(includedir)/@PACKAGE@
 pkglibdir = $(libdir)/@PACKAGE@
@@ -33,6 +49,7 @@ PRE_UNINSTALL = :
 POST_UNINSTALL = :
 build_triplet = @build@
 host_triplet = @host@
+target_triplet = @target@
 @GST_FFMPEG_ENABLE_LGPL_FALSE@am__append_1 = libpostproc
 subdir = ext
 DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
@@ -64,12 +81,18 @@ mkinstalldirs = $(install_sh) -d
 CONFIG_HEADER = $(top_builddir)/config.h
 CONFIG_CLEAN_FILES =
 CONFIG_CLEAN_VPATH_FILES =
-AM_V_GEN = $(am__v_GEN_$(V))
-am__v_GEN_ = $(am__v_GEN_$(AM_DEFAULT_VERBOSITY))
-am__v_GEN_0 = @echo "  GEN   " $@;
-AM_V_at = $(am__v_at_$(V))
-am__v_at_ = $(am__v_at_$(AM_DEFAULT_VERBOSITY))
+AM_V_P = $(am__v_P_@AM_V@)
+am__v_P_ = $(am__v_P_@AM_DEFAULT_V@)
+am__v_P_0 = false
+am__v_P_1 = :
+AM_V_GEN = $(am__v_GEN_@AM_V@)
+am__v_GEN_ = $(am__v_GEN_@AM_DEFAULT_V@)
+am__v_GEN_0 = @echo "  GEN     " $@;
+am__v_GEN_1 = 
+AM_V_at = $(am__v_at_@AM_V@)
+am__v_at_ = $(am__v_at_@AM_DEFAULT_V@)
 am__v_at_0 = @
+am__v_at_1 = 
 SOURCES =
 DIST_SOURCES =
 RECURSIVE_TARGETS = all-recursive check-recursive dvi-recursive \
@@ -79,6 +102,11 @@ RECURSIVE_TARGETS = all-recursive check-recursive dvi-recursive \
 	install-pdf-recursive install-ps-recursive install-recursive \
 	installcheck-recursive installdirs-recursive pdf-recursive \
 	ps-recursive uninstall-recursive
+am__can_run_installinfo = \
+  case $$AM_UPDATE_INFO_DIR in \
+    n|no|NO) false;; \
+    *) (install-info --version) >/dev/null 2>&1;; \
+  esac
 RECURSIVE_CLEAN_TARGETS = mostlyclean-recursive clean-recursive	\
   distclean-recursive maintainer-clean-recursive
 AM_RECURSIVE_TARGETS = $(RECURSIVE_TARGETS:-recursive=) \
@@ -306,7 +334,11 @@ sbindir = @sbindir@
 sharedstatedir = @sharedstatedir@
 srcdir = @srcdir@
 sysconfdir = @sysconfdir@
+target = @target@
 target_alias = @target_alias@
+target_cpu = @target_cpu@
+target_os = @target_os@
+target_vendor = @target_vendor@
 top_build_prefix = @top_build_prefix@
 top_builddir = @top_builddir@
 top_srcdir = @top_srcdir@
@@ -352,12 +384,12 @@ clean-libtool:
 	-rm -rf .libs _libs
 
 # This directory's subdirectories are mostly independent; you can cd
-# into them and run `make' without going through this Makefile.
-# To change the values of `make' variables: instead of editing Makefiles,
-# (1) if the variable is set in `config.status', edit `config.status'
-#     (which will cause the Makefiles to be regenerated when you run `make');
-# (2) otherwise, pass the desired values on the `make' command line.
-$(RECURSIVE_TARGETS):
+# into them and run 'make' without going through this Makefile.
+# To change the values of 'make' variables: instead of editing Makefiles,
+# (1) if the variable is set in 'config.status', edit 'config.status'
+#     (which will cause the Makefiles to be regenerated when you run 'make');
+# (2) otherwise, pass the desired values on the 'make' command line.
+$(RECURSIVE_TARGETS) $(RECURSIVE_CLEAN_TARGETS):
 	@fail= failcom='exit 1'; \
 	for f in x $$MAKEFLAGS; do \
 	  case $$f in \
@@ -367,7 +399,11 @@ $(RECURSIVE_TARGETS):
 	done; \
 	dot_seen=no; \
 	target=`echo $@ | sed s/-recursive//`; \
-	list='$(SUBDIRS)'; for subdir in $$list; do \
+	case "$@" in \
+	  distclean-* | maintainer-clean-*) list='$(DIST_SUBDIRS)' ;; \
+	  *) list='$(SUBDIRS)' ;; \
+	esac; \
+	for subdir in $$list; do \
 	  echo "Making $$target in $$subdir"; \
 	  if test "$$subdir" = "."; then \
 	    dot_seen=yes; \
@@ -381,37 +417,6 @@ $(RECURSIVE_TARGETS):
 	if test "$$dot_seen" = "no"; then \
 	  $(MAKE) $(AM_MAKEFLAGS) "$$target-am" || exit 1; \
 	fi; test -z "$$fail"
-
-$(RECURSIVE_CLEAN_TARGETS):
-	@fail= failcom='exit 1'; \
-	for f in x $$MAKEFLAGS; do \
-	  case $$f in \
-	    *=* | --[!k]*);; \
-	    *k*) failcom='fail=yes';; \
-	  esac; \
-	done; \
-	dot_seen=no; \
-	case "$@" in \
-	  distclean-* | maintainer-clean-*) list='$(DIST_SUBDIRS)' ;; \
-	  *) list='$(SUBDIRS)' ;; \
-	esac; \
-	rev=''; for subdir in $$list; do \
-	  if test "$$subdir" = "."; then :; else \
-	    rev="$$subdir $$rev"; \
-	  fi; \
-	done; \
-	rev="$$rev ."; \
-	target=`echo $@ | sed s/-recursive//`; \
-	for subdir in $$rev; do \
-	  echo "Making $$target in $$subdir"; \
-	  if test "$$subdir" = "."; then \
-	    local_target="$$target-am"; \
-	  else \
-	    local_target="$$target"; \
-	  fi; \
-	  ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) $$local_target) \
-	  || eval $$failcom; \
-	done && test -z "$$fail"
 tags-recursive:
 	list='$(SUBDIRS)'; for subdir in $$list; do \
 	  test "$$subdir" = . || ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) tags); \
@@ -420,6 +425,10 @@ ctags-recursive:
 	list='$(SUBDIRS)'; for subdir in $$list; do \
 	  test "$$subdir" = . || ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) ctags); \
 	done
+cscopelist-recursive:
+	list='$(SUBDIRS)'; for subdir in $$list; do \
+	  test "$$subdir" = . || ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) cscopelist); \
+	done
 
 ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
 	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
@@ -483,6 +492,20 @@ GTAGS:
 	  && $(am__cd) $(top_srcdir) \
 	  && gtags -i $(GTAGS_ARGS) "$$here"
 
+cscopelist: cscopelist-recursive $(HEADERS) $(SOURCES) $(LISP)
+	list='$(SOURCES) $(HEADERS) $(LISP)'; \
+	case "$(srcdir)" in \
+	  [\\/]* | ?:[\\/]*) sdir="$(srcdir)" ;; \
+	  *) sdir=$(subdir)/$(srcdir) ;; \
+	esac; \
+	for i in $$list; do \
+	  if test -f "$$i"; then \
+	    echo "$(subdir)/$$i"; \
+	  else \
+	    echo "$$sdir/$$i"; \
+	  fi; \
+	done >> $(top_builddir)/cscope.files
+
 distclean-tags:
 	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
 
@@ -518,13 +541,10 @@ distdir: $(DISTFILES)
 	done
 	@list='$(DIST_SUBDIRS)'; for subdir in $$list; do \
 	  if test "$$subdir" = .; then :; else \
-	    test -d "$(distdir)/$$subdir" \
-	    || $(MKDIR_P) "$(distdir)/$$subdir" \
-	    || exit 1; \
-	  fi; \
-	done
-	@list='$(DIST_SUBDIRS)'; for subdir in $$list; do \
-	  if test "$$subdir" = .; then :; else \
+	    $(am__make_dryrun) \
+	      || test -d "$(distdir)/$$subdir" \
+	      || $(MKDIR_P) "$(distdir)/$$subdir" \
+	      || exit 1; \
 	    dir1=$$subdir; dir2="$(distdir)/$$subdir"; \
 	    $(am__relativize); \
 	    new_distdir=$$reldir; \
@@ -559,10 +579,15 @@ install-am: all-am
 
 installcheck: installcheck-recursive
 install-strip:
-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
-	  `test -z '$(STRIP)' || \
-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+	if test -z '$(STRIP)'; then \
+	  $(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+	    install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+	      install; \
+	else \
+	  $(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+	    install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+	    "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'" install; \
+	fi
 mostlyclean-generic:
 
 clean-generic:
@@ -640,22 +665,23 @@ ps-am:
 
 uninstall-am:
 
-.MAKE: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) ctags-recursive \
-	install-am install-strip tags-recursive
+.MAKE: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) \
+	cscopelist-recursive ctags-recursive install-am install-strip \
+	tags-recursive
 
 .PHONY: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) CTAGS GTAGS \
 	all all-am check check-am clean clean-generic clean-libtool \
-	ctags ctags-recursive distclean distclean-generic \
-	distclean-libtool distclean-tags distdir dvi dvi-am html \
-	html-am info info-am install install-am install-data \
-	install-data-am install-dvi install-dvi-am install-exec \
-	install-exec-am install-html install-html-am install-info \
-	install-info-am install-man install-pdf install-pdf-am \
-	install-ps install-ps-am install-strip installcheck \
-	installcheck-am installdirs installdirs-am maintainer-clean \
-	maintainer-clean-generic mostlyclean mostlyclean-generic \
-	mostlyclean-libtool pdf pdf-am ps ps-am tags tags-recursive \
-	uninstall uninstall-am
+	cscopelist cscopelist-recursive ctags ctags-recursive \
+	distclean distclean-generic distclean-libtool distclean-tags \
+	distdir dvi dvi-am html html-am info info-am install \
+	install-am install-data install-data-am install-dvi \
+	install-dvi-am install-exec install-exec-am install-html \
+	install-html-am install-info install-info-am install-man \
+	install-pdf install-pdf-am install-ps install-ps-am \
+	install-strip installcheck installcheck-am installdirs \
+	installdirs-am maintainer-clean maintainer-clean-generic \
+	mostlyclean mostlyclean-generic mostlyclean-libtool pdf pdf-am \
+	ps ps-am tags tags-recursive uninstall uninstall-am
 
 
 # Tell versions [3.59,3.63) of GNU make to not export all variables.
diff --git a/ext/ffmpeg/Makefile.am b/ext/ffmpeg/Makefile.am
index 482807e..1a22aad 100644
--- a/ext/ffmpeg/Makefile.am
+++ b/ext/ffmpeg/Makefile.am
@@ -11,7 +11,9 @@ libgstffmpeg_la_SOURCES = gstffmpeg.c	\
 			  gstffmpegcodecmap.c	\
 			  gstffmpegutils.c	\
 			  gstffmpegenc.c	\
+			  gstffmpegvidenc.c	\
 			  gstffmpegdec.c	\
+			  gstffmpegviddec.c	\
 			  gstffmpegcfg.c	\
 			  gstffmpegdemux.c	\
 			  gstffmpegmux.c    \
@@ -21,7 +23,7 @@ libgstffmpeg_la_SOURCES = gstffmpeg.c	\
 # 			  gstffmpegscale.c
 
 libgstffmpeg_la_CFLAGS = $(FFMPEG_CFLAGS) $(GST_PLUGINS_BASE_CFLAGS) $(GST_CFLAGS)
-libgstffmpeg_la_LIBADD = $(FFMPEG_LIBS) $(GST_BASE_LIBS) $(GST_PLUGINS_BASE_LIBS) -lgstaudio-$(GST_MAJORMINOR) -lgstpbutils-$(GST_MAJORMINOR) $(LIBM) $(WIN32_LIBS) -lz $(BZ2_LIBS)
+libgstffmpeg_la_LIBADD = $(FFMPEG_LIBS) $(GST_BASE_LIBS) $(GST_PLUGINS_BASE_LIBS) -lgstvideo-$(GST_MAJORMINOR) -lgstaudio-$(GST_MAJORMINOR) -lgstpbutils-$(GST_MAJORMINOR) $(LIBM) $(WIN32_LIBS) -lz $(BZ2_LIBS)
 libgstffmpeg_la_LDFLAGS = $(GST_PLUGIN_LDFLAGS) $(DARWIN_LDFLAGS)
 libgstffmpeg_la_LIBTOOLFLAGS = --tag=disable-static
 
@@ -35,5 +37,6 @@ noinst_HEADERS = \
 	gstffmpegcodecmap.h \
 	gstffmpegutils.h \
 	gstffmpegenc.h \
+	gstffmpegvidenc.h \
 	gstffmpegcfg.h \
 	gstffmpegpipe.h
diff --git a/ext/ffmpeg/Makefile.in b/ext/ffmpeg/Makefile.in
index 474d7a1..6acd84b 100644
--- a/ext/ffmpeg/Makefile.in
+++ b/ext/ffmpeg/Makefile.in
@@ -1,9 +1,8 @@
-# Makefile.in generated by automake 1.11.1 from Makefile.am.
+# Makefile.in generated by automake 1.12.6 from Makefile.am.
 # @configure_input@
 
-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
-# Inc.
+# Copyright (C) 1994-2012 Free Software Foundation, Inc.
+
 # This Makefile.in is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
@@ -17,6 +16,23 @@
 
 
 VPATH = @srcdir@
+am__make_dryrun = \
+  { \
+    am__dry=no; \
+    case $$MAKEFLAGS in \
+      *\\[\ \	]*) \
+        echo 'am--echo: ; @echo "AM"  OK' | $(MAKE) -f - 2>/dev/null \
+          | grep '^AM OK$$' >/dev/null || am__dry=yes;; \
+      *) \
+        for am__flg in $$MAKEFLAGS; do \
+          case $$am__flg in \
+            *=*|--*) ;; \
+            *n*) am__dry=yes; break;; \
+          esac; \
+        done;; \
+    esac; \
+    test $$am__dry = yes; \
+  }
 pkgdatadir = $(datadir)/@PACKAGE@
 pkgincludedir = $(includedir)/@PACKAGE@
 pkglibdir = $(libdir)/@PACKAGE@
@@ -35,6 +51,7 @@ PRE_UNINSTALL = :
 POST_UNINSTALL = :
 build_triplet = @build@
 host_triplet = @host@
+target_triplet = @target@
 @HAVE_FFMPEG_UNINSTALLED_FALSE@libgstffmpeg_la_DEPENDENCIES =  \
 @HAVE_FFMPEG_UNINSTALLED_FALSE@	$(am__DEPENDENCIES_1) \
 @HAVE_FFMPEG_UNINSTALLED_FALSE@	$(am__DEPENDENCIES_1) \
@@ -44,7 +61,7 @@ host_triplet = @host@
 @HAVE_FFMPEG_UNINSTALLED_FALSE@	$(am__DEPENDENCIES_1)
 subdir = ext/ffmpeg
 DIST_COMMON = $(noinst_HEADERS) $(srcdir)/Makefile.am \
-	$(srcdir)/Makefile.in
+	$(srcdir)/Makefile.in $(top_srcdir)/depcomp
 ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
 am__aclocal_m4_deps = $(top_srcdir)/common/m4/as-ac-expand.m4 \
 	$(top_srcdir)/common/m4/as-auto-alt.m4 \
@@ -94,6 +111,12 @@ am__nobase_list = $(am__nobase_strip_setup); \
 am__base_list = \
   sed '$$!N;$$!N;$$!N;$$!N;$$!N;$$!N;$$!N;s/\n/ /g' | \
   sed '$$!N;$$!N;$$!N;$$!N;s/\n/ /g'
+am__uninstall_files_from_dir = { \
+  test -z "$$files" \
+    || { test ! -d "$$dir" && test ! -f "$$dir" && test ! -r "$$dir"; } \
+    || { echo " ( cd '$$dir' && rm -f" $$files ")"; \
+         $(am__cd) "$$dir" && rm -f $$files; }; \
+  }
 am__installdirs = "$(DESTDIR)$(plugindir)"
 LTLIBRARIES = $(plugin_LTLIBRARIES)
 am__DEPENDENCIES_1 =
@@ -102,20 +125,35 @@ am_libgstffmpeg_la_OBJECTS = libgstffmpeg_la-gstffmpeg.lo \
 	libgstffmpeg_la-gstffmpegcodecmap.lo \
 	libgstffmpeg_la-gstffmpegutils.lo \
 	libgstffmpeg_la-gstffmpegenc.lo \
+	libgstffmpeg_la-gstffmpegvidenc.lo \
 	libgstffmpeg_la-gstffmpegdec.lo \
+	libgstffmpeg_la-gstffmpegviddec.lo \
 	libgstffmpeg_la-gstffmpegcfg.lo \
 	libgstffmpeg_la-gstffmpegdemux.lo \
 	libgstffmpeg_la-gstffmpegmux.lo \
 	libgstffmpeg_la-gstffmpegdeinterlace.lo \
 	libgstffmpeg_la-gstffmpegaudioresample.lo
 libgstffmpeg_la_OBJECTS = $(am_libgstffmpeg_la_OBJECTS)
-AM_V_lt = $(am__v_lt_$(V))
-am__v_lt_ = $(am__v_lt_$(AM_DEFAULT_VERBOSITY))
+AM_V_lt = $(am__v_lt_@AM_V@)
+am__v_lt_ = $(am__v_lt_@AM_DEFAULT_V@)
 am__v_lt_0 = --silent
+am__v_lt_1 = 
 libgstffmpeg_la_LINK = $(LIBTOOL) $(AM_V_lt) --tag=CC \
 	$(libgstffmpeg_la_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=link \
 	$(CCLD) $(libgstffmpeg_la_CFLAGS) $(CFLAGS) \
 	$(libgstffmpeg_la_LDFLAGS) $(LDFLAGS) -o $@
+AM_V_P = $(am__v_P_@AM_V@)
+am__v_P_ = $(am__v_P_@AM_DEFAULT_V@)
+am__v_P_0 = false
+am__v_P_1 = :
+AM_V_GEN = $(am__v_GEN_@AM_V@)
+am__v_GEN_ = $(am__v_GEN_@AM_DEFAULT_V@)
+am__v_GEN_0 = @echo "  GEN     " $@;
+am__v_GEN_1 = 
+AM_V_at = $(am__v_at_@AM_V@)
+am__v_at_ = $(am__v_at_@AM_DEFAULT_V@)
+am__v_at_0 = @
+am__v_at_1 = 
 DEFAULT_INCLUDES = -I.@am__isrc@ -I$(top_builddir)
 depcomp = $(SHELL) $(top_srcdir)/depcomp
 am__depfiles_maybe = depfiles
@@ -126,24 +164,25 @@ LTCOMPILE = $(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) \
 	$(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) \
 	$(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) \
 	$(AM_CFLAGS) $(CFLAGS)
-AM_V_CC = $(am__v_CC_$(V))
-am__v_CC_ = $(am__v_CC_$(AM_DEFAULT_VERBOSITY))
-am__v_CC_0 = @echo "  CC    " $@;
-AM_V_at = $(am__v_at_$(V))
-am__v_at_ = $(am__v_at_$(AM_DEFAULT_VERBOSITY))
-am__v_at_0 = @
+AM_V_CC = $(am__v_CC_@AM_V@)
+am__v_CC_ = $(am__v_CC_@AM_DEFAULT_V@)
+am__v_CC_0 = @echo "  CC      " $@;
+am__v_CC_1 = 
 CCLD = $(CC)
 LINK = $(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) \
 	$(LIBTOOLFLAGS) --mode=link $(CCLD) $(AM_CFLAGS) $(CFLAGS) \
 	$(AM_LDFLAGS) $(LDFLAGS) -o $@
-AM_V_CCLD = $(am__v_CCLD_$(V))
-am__v_CCLD_ = $(am__v_CCLD_$(AM_DEFAULT_VERBOSITY))
-am__v_CCLD_0 = @echo "  CCLD  " $@;
-AM_V_GEN = $(am__v_GEN_$(V))
-am__v_GEN_ = $(am__v_GEN_$(AM_DEFAULT_VERBOSITY))
-am__v_GEN_0 = @echo "  GEN   " $@;
+AM_V_CCLD = $(am__v_CCLD_@AM_V@)
+am__v_CCLD_ = $(am__v_CCLD_@AM_DEFAULT_V@)
+am__v_CCLD_0 = @echo "  CCLD    " $@;
+am__v_CCLD_1 = 
 SOURCES = $(libgstffmpeg_la_SOURCES)
 DIST_SOURCES = $(libgstffmpeg_la_SOURCES)
+am__can_run_installinfo = \
+  case $$AM_UPDATE_INFO_DIR in \
+    n|no|NO) false;; \
+    *) (install-info --version) >/dev/null 2>&1;; \
+  esac
 HEADERS = $(noinst_HEADERS)
 ETAGS = etags
 CTAGS = ctags
@@ -341,7 +380,11 @@ sbindir = @sbindir@
 sharedstatedir = @sharedstatedir@
 srcdir = @srcdir@
 sysconfdir = @sysconfdir@
+target = @target@
 target_alias = @target_alias@
+target_cpu = @target_cpu@
+target_os = @target_os@
+target_vendor = @target_vendor@
 top_build_prefix = @top_build_prefix@
 top_builddir = @top_builddir@
 top_srcdir = @top_srcdir@
@@ -353,7 +396,9 @@ libgstffmpeg_la_SOURCES = gstffmpeg.c	\
 			  gstffmpegcodecmap.c	\
 			  gstffmpegutils.c	\
 			  gstffmpegenc.c	\
+			  gstffmpegvidenc.c	\
 			  gstffmpegdec.c	\
+			  gstffmpegviddec.c	\
 			  gstffmpegcfg.c	\
 			  gstffmpegdemux.c	\
 			  gstffmpegmux.c    \
@@ -363,7 +408,7 @@ libgstffmpeg_la_SOURCES = gstffmpeg.c	\
 # 	\
 # 			  gstffmpegscale.c
 libgstffmpeg_la_CFLAGS = $(FFMPEG_CFLAGS) $(GST_PLUGINS_BASE_CFLAGS) $(GST_CFLAGS)
-libgstffmpeg_la_LIBADD = $(FFMPEG_LIBS) $(GST_BASE_LIBS) $(GST_PLUGINS_BASE_LIBS) -lgstaudio-$(GST_MAJORMINOR) -lgstpbutils-$(GST_MAJORMINOR) $(LIBM) $(WIN32_LIBS) -lz $(BZ2_LIBS)
+libgstffmpeg_la_LIBADD = $(FFMPEG_LIBS) $(GST_BASE_LIBS) $(GST_PLUGINS_BASE_LIBS) -lgstvideo-$(GST_MAJORMINOR) -lgstaudio-$(GST_MAJORMINOR) -lgstpbutils-$(GST_MAJORMINOR) $(LIBM) $(WIN32_LIBS) -lz $(BZ2_LIBS)
 libgstffmpeg_la_LDFLAGS = $(GST_PLUGIN_LDFLAGS) $(DARWIN_LDFLAGS)
 libgstffmpeg_la_LIBTOOLFLAGS = --tag=disable-static
 @HAVE_FFMPEG_UNINSTALLED_TRUE@libgstffmpeg_la_DEPENDENCIES = $(FFMPEG_LIBS)
@@ -372,6 +417,7 @@ noinst_HEADERS = \
 	gstffmpegcodecmap.h \
 	gstffmpegutils.h \
 	gstffmpegenc.h \
+	gstffmpegvidenc.h \
 	gstffmpegcfg.h \
 	gstffmpegpipe.h
 
@@ -411,7 +457,6 @@ $(ACLOCAL_M4): @MAINTAINER_MODE_TRUE@ $(am__aclocal_m4_deps)
 $(am__aclocal_m4_deps):
 install-pluginLTLIBRARIES: $(plugin_LTLIBRARIES)
 	@$(NORMAL_INSTALL)
-	test -z "$(plugindir)" || $(MKDIR_P) "$(DESTDIR)$(plugindir)"
 	@list='$(plugin_LTLIBRARIES)'; test -n "$(plugindir)" || list=; \
 	list2=; for p in $$list; do \
 	  if test -f $$p; then \
@@ -419,6 +464,8 @@ install-pluginLTLIBRARIES: $(plugin_LTLIBRARIES)
 	  else :; fi; \
 	done; \
 	test -z "$$list2" || { \
+	  echo " $(MKDIR_P) '$(DESTDIR)$(plugindir)'"; \
+	  $(MKDIR_P) "$(DESTDIR)$(plugindir)" || exit 1; \
 	  echo " $(LIBTOOL) $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=install $(INSTALL) $(INSTALL_STRIP_FLAG) $$list2 '$(DESTDIR)$(plugindir)'"; \
 	  $(LIBTOOL) $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=install $(INSTALL) $(INSTALL_STRIP_FLAG) $$list2 "$(DESTDIR)$(plugindir)"; \
 	}
@@ -434,13 +481,15 @@ uninstall-pluginLTLIBRARIES:
 
 clean-pluginLTLIBRARIES:
 	-test -z "$(plugin_LTLIBRARIES)" || rm -f $(plugin_LTLIBRARIES)
-	@list='$(plugin_LTLIBRARIES)'; for p in $$list; do \
-	  dir="`echo $$p | sed -e 's|/[^/]*$$||'`"; \
-	  test "$$dir" != "$$p" || dir=.; \
-	  echo "rm -f \"$${dir}/so_locations\""; \
-	  rm -f "$${dir}/so_locations"; \
-	done
-libgstffmpeg.la: $(libgstffmpeg_la_OBJECTS) $(libgstffmpeg_la_DEPENDENCIES) 
+	@list='$(plugin_LTLIBRARIES)'; \
+	locs=`for p in $$list; do echo $$p; done | \
+	      sed 's|^[^/]*$$|.|; s|/[^/]*$$||; s|$$|/so_locations|' | \
+	      sort -u`; \
+	test -z "$$locs" || { \
+	  echo rm -f $${locs}; \
+	  rm -f $${locs}; \
+	}
+libgstffmpeg.la: $(libgstffmpeg_la_OBJECTS) $(libgstffmpeg_la_DEPENDENCIES) $(EXTRA_libgstffmpeg_la_DEPENDENCIES) 
 	$(AM_V_CCLD)$(libgstffmpeg_la_LINK) -rpath $(plugindir) $(libgstffmpeg_la_OBJECTS) $(libgstffmpeg_la_LIBADD) $(LIBS)
 
 mostlyclean-compile:
@@ -460,118 +509,120 @@ distclean-compile:
 @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/libgstffmpeg_la-gstffmpegmux.Plo@am__quote@
 @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/libgstffmpeg_la-gstffmpegprotocol.Plo@am__quote@
 @AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/libgstffmpeg_la-gstffmpegutils.Plo@am__quote@
+@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/libgstffmpeg_la-gstffmpegviddec.Plo@am__quote@
+@AMDEP_TRUE@@am__include@ @am__quote@./$(DEPDIR)/libgstffmpeg_la-gstffmpegvidenc.Plo@am__quote@
 
 .c.o:
 @am__fastdepCC_TRUE@	$(AM_V_CC)$(COMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
 @am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
-@am__fastdepCC_FALSE@	$(AM_V_CC) @AM_BACKSLASH@
-@AMDEP_TRUE@@am__fastdepCC_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(COMPILE) -c $<
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(COMPILE) -c $<
 
 .c.obj:
 @am__fastdepCC_TRUE@	$(AM_V_CC)$(COMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ `$(CYGPATH_W) '$<'`
 @am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
-@am__fastdepCC_FALSE@	$(AM_V_CC) @AM_BACKSLASH@
-@AMDEP_TRUE@@am__fastdepCC_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(COMPILE) -c `$(CYGPATH_W) '$<'`
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(COMPILE) -c `$(CYGPATH_W) '$<'`
 
 .c.lo:
 @am__fastdepCC_TRUE@	$(AM_V_CC)$(LTCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
 @am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Plo
-@am__fastdepCC_FALSE@	$(AM_V_CC) @AM_BACKSLASH@
-@AMDEP_TRUE@@am__fastdepCC_FALSE@	source='$<' object='$@' libtool=yes @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='$<' object='$@' libtool=yes @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(LTCOMPILE) -c -o $@ $<
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(LTCOMPILE) -c -o $@ $<
 
 libgstffmpeg_la-gstffmpeg.lo: gstffmpeg.c
 @am__fastdepCC_TRUE@	$(AM_V_CC)$(LIBTOOL) $(AM_V_lt) --tag=CC $(libgstffmpeg_la_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libgstffmpeg_la_CFLAGS) $(CFLAGS) -MT libgstffmpeg_la-gstffmpeg.lo -MD -MP -MF $(DEPDIR)/libgstffmpeg_la-gstffmpeg.Tpo -c -o libgstffmpeg_la-gstffmpeg.lo `test -f 'gstffmpeg.c' || echo '$(srcdir)/'`gstffmpeg.c
 @am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/libgstffmpeg_la-gstffmpeg.Tpo $(DEPDIR)/libgstffmpeg_la-gstffmpeg.Plo
-@am__fastdepCC_FALSE@	$(AM_V_CC) @AM_BACKSLASH@
-@AMDEP_TRUE@@am__fastdepCC_FALSE@	source='gstffmpeg.c' object='libgstffmpeg_la-gstffmpeg.lo' libtool=yes @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='gstffmpeg.c' object='libgstffmpeg_la-gstffmpeg.lo' libtool=yes @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(LIBTOOL) $(AM_V_lt) --tag=CC $(libgstffmpeg_la_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libgstffmpeg_la_CFLAGS) $(CFLAGS) -c -o libgstffmpeg_la-gstffmpeg.lo `test -f 'gstffmpeg.c' || echo '$(srcdir)/'`gstffmpeg.c
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(LIBTOOL) $(AM_V_lt) --tag=CC $(libgstffmpeg_la_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libgstffmpeg_la_CFLAGS) $(CFLAGS) -c -o libgstffmpeg_la-gstffmpeg.lo `test -f 'gstffmpeg.c' || echo '$(srcdir)/'`gstffmpeg.c
 
 libgstffmpeg_la-gstffmpegprotocol.lo: gstffmpegprotocol.c
 @am__fastdepCC_TRUE@	$(AM_V_CC)$(LIBTOOL) $(AM_V_lt) --tag=CC $(libgstffmpeg_la_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libgstffmpeg_la_CFLAGS) $(CFLAGS) -MT libgstffmpeg_la-gstffmpegprotocol.lo -MD -MP -MF $(DEPDIR)/libgstffmpeg_la-gstffmpegprotocol.Tpo -c -o libgstffmpeg_la-gstffmpegprotocol.lo `test -f 'gstffmpegprotocol.c' || echo '$(srcdir)/'`gstffmpegprotocol.c
 @am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/libgstffmpeg_la-gstffmpegprotocol.Tpo $(DEPDIR)/libgstffmpeg_la-gstffmpegprotocol.Plo
-@am__fastdepCC_FALSE@	$(AM_V_CC) @AM_BACKSLASH@
-@AMDEP_TRUE@@am__fastdepCC_FALSE@	source='gstffmpegprotocol.c' object='libgstffmpeg_la-gstffmpegprotocol.lo' libtool=yes @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='gstffmpegprotocol.c' object='libgstffmpeg_la-gstffmpegprotocol.lo' libtool=yes @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(LIBTOOL) $(AM_V_lt) --tag=CC $(libgstffmpeg_la_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libgstffmpeg_la_CFLAGS) $(CFLAGS) -c -o libgstffmpeg_la-gstffmpegprotocol.lo `test -f 'gstffmpegprotocol.c' || echo '$(srcdir)/'`gstffmpegprotocol.c
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(LIBTOOL) $(AM_V_lt) --tag=CC $(libgstffmpeg_la_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libgstffmpeg_la_CFLAGS) $(CFLAGS) -c -o libgstffmpeg_la-gstffmpegprotocol.lo `test -f 'gstffmpegprotocol.c' || echo '$(srcdir)/'`gstffmpegprotocol.c
 
 libgstffmpeg_la-gstffmpegcodecmap.lo: gstffmpegcodecmap.c
 @am__fastdepCC_TRUE@	$(AM_V_CC)$(LIBTOOL) $(AM_V_lt) --tag=CC $(libgstffmpeg_la_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libgstffmpeg_la_CFLAGS) $(CFLAGS) -MT libgstffmpeg_la-gstffmpegcodecmap.lo -MD -MP -MF $(DEPDIR)/libgstffmpeg_la-gstffmpegcodecmap.Tpo -c -o libgstffmpeg_la-gstffmpegcodecmap.lo `test -f 'gstffmpegcodecmap.c' || echo '$(srcdir)/'`gstffmpegcodecmap.c
 @am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/libgstffmpeg_la-gstffmpegcodecmap.Tpo $(DEPDIR)/libgstffmpeg_la-gstffmpegcodecmap.Plo
-@am__fastdepCC_FALSE@	$(AM_V_CC) @AM_BACKSLASH@
-@AMDEP_TRUE@@am__fastdepCC_FALSE@	source='gstffmpegcodecmap.c' object='libgstffmpeg_la-gstffmpegcodecmap.lo' libtool=yes @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='gstffmpegcodecmap.c' object='libgstffmpeg_la-gstffmpegcodecmap.lo' libtool=yes @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(LIBTOOL) $(AM_V_lt) --tag=CC $(libgstffmpeg_la_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libgstffmpeg_la_CFLAGS) $(CFLAGS) -c -o libgstffmpeg_la-gstffmpegcodecmap.lo `test -f 'gstffmpegcodecmap.c' || echo '$(srcdir)/'`gstffmpegcodecmap.c
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(LIBTOOL) $(AM_V_lt) --tag=CC $(libgstffmpeg_la_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libgstffmpeg_la_CFLAGS) $(CFLAGS) -c -o libgstffmpeg_la-gstffmpegcodecmap.lo `test -f 'gstffmpegcodecmap.c' || echo '$(srcdir)/'`gstffmpegcodecmap.c
 
 libgstffmpeg_la-gstffmpegutils.lo: gstffmpegutils.c
 @am__fastdepCC_TRUE@	$(AM_V_CC)$(LIBTOOL) $(AM_V_lt) --tag=CC $(libgstffmpeg_la_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libgstffmpeg_la_CFLAGS) $(CFLAGS) -MT libgstffmpeg_la-gstffmpegutils.lo -MD -MP -MF $(DEPDIR)/libgstffmpeg_la-gstffmpegutils.Tpo -c -o libgstffmpeg_la-gstffmpegutils.lo `test -f 'gstffmpegutils.c' || echo '$(srcdir)/'`gstffmpegutils.c
 @am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/libgstffmpeg_la-gstffmpegutils.Tpo $(DEPDIR)/libgstffmpeg_la-gstffmpegutils.Plo
-@am__fastdepCC_FALSE@	$(AM_V_CC) @AM_BACKSLASH@
-@AMDEP_TRUE@@am__fastdepCC_FALSE@	source='gstffmpegutils.c' object='libgstffmpeg_la-gstffmpegutils.lo' libtool=yes @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='gstffmpegutils.c' object='libgstffmpeg_la-gstffmpegutils.lo' libtool=yes @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(LIBTOOL) $(AM_V_lt) --tag=CC $(libgstffmpeg_la_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libgstffmpeg_la_CFLAGS) $(CFLAGS) -c -o libgstffmpeg_la-gstffmpegutils.lo `test -f 'gstffmpegutils.c' || echo '$(srcdir)/'`gstffmpegutils.c
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(LIBTOOL) $(AM_V_lt) --tag=CC $(libgstffmpeg_la_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libgstffmpeg_la_CFLAGS) $(CFLAGS) -c -o libgstffmpeg_la-gstffmpegutils.lo `test -f 'gstffmpegutils.c' || echo '$(srcdir)/'`gstffmpegutils.c
 
 libgstffmpeg_la-gstffmpegenc.lo: gstffmpegenc.c
 @am__fastdepCC_TRUE@	$(AM_V_CC)$(LIBTOOL) $(AM_V_lt) --tag=CC $(libgstffmpeg_la_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libgstffmpeg_la_CFLAGS) $(CFLAGS) -MT libgstffmpeg_la-gstffmpegenc.lo -MD -MP -MF $(DEPDIR)/libgstffmpeg_la-gstffmpegenc.Tpo -c -o libgstffmpeg_la-gstffmpegenc.lo `test -f 'gstffmpegenc.c' || echo '$(srcdir)/'`gstffmpegenc.c
 @am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/libgstffmpeg_la-gstffmpegenc.Tpo $(DEPDIR)/libgstffmpeg_la-gstffmpegenc.Plo
-@am__fastdepCC_FALSE@	$(AM_V_CC) @AM_BACKSLASH@
-@AMDEP_TRUE@@am__fastdepCC_FALSE@	source='gstffmpegenc.c' object='libgstffmpeg_la-gstffmpegenc.lo' libtool=yes @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='gstffmpegenc.c' object='libgstffmpeg_la-gstffmpegenc.lo' libtool=yes @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(LIBTOOL) $(AM_V_lt) --tag=CC $(libgstffmpeg_la_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libgstffmpeg_la_CFLAGS) $(CFLAGS) -c -o libgstffmpeg_la-gstffmpegenc.lo `test -f 'gstffmpegenc.c' || echo '$(srcdir)/'`gstffmpegenc.c
+
+libgstffmpeg_la-gstffmpegvidenc.lo: gstffmpegvidenc.c
+@am__fastdepCC_TRUE@	$(AM_V_CC)$(LIBTOOL) $(AM_V_lt) --tag=CC $(libgstffmpeg_la_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libgstffmpeg_la_CFLAGS) $(CFLAGS) -MT libgstffmpeg_la-gstffmpegvidenc.lo -MD -MP -MF $(DEPDIR)/libgstffmpeg_la-gstffmpegvidenc.Tpo -c -o libgstffmpeg_la-gstffmpegvidenc.lo `test -f 'gstffmpegvidenc.c' || echo '$(srcdir)/'`gstffmpegvidenc.c
+@am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/libgstffmpeg_la-gstffmpegvidenc.Tpo $(DEPDIR)/libgstffmpeg_la-gstffmpegvidenc.Plo
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='gstffmpegvidenc.c' object='libgstffmpeg_la-gstffmpegvidenc.lo' libtool=yes @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(LIBTOOL) $(AM_V_lt) --tag=CC $(libgstffmpeg_la_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libgstffmpeg_la_CFLAGS) $(CFLAGS) -c -o libgstffmpeg_la-gstffmpegenc.lo `test -f 'gstffmpegenc.c' || echo '$(srcdir)/'`gstffmpegenc.c
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(LIBTOOL) $(AM_V_lt) --tag=CC $(libgstffmpeg_la_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libgstffmpeg_la_CFLAGS) $(CFLAGS) -c -o libgstffmpeg_la-gstffmpegvidenc.lo `test -f 'gstffmpegvidenc.c' || echo '$(srcdir)/'`gstffmpegvidenc.c
 
 libgstffmpeg_la-gstffmpegdec.lo: gstffmpegdec.c
 @am__fastdepCC_TRUE@	$(AM_V_CC)$(LIBTOOL) $(AM_V_lt) --tag=CC $(libgstffmpeg_la_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libgstffmpeg_la_CFLAGS) $(CFLAGS) -MT libgstffmpeg_la-gstffmpegdec.lo -MD -MP -MF $(DEPDIR)/libgstffmpeg_la-gstffmpegdec.Tpo -c -o libgstffmpeg_la-gstffmpegdec.lo `test -f 'gstffmpegdec.c' || echo '$(srcdir)/'`gstffmpegdec.c
 @am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/libgstffmpeg_la-gstffmpegdec.Tpo $(DEPDIR)/libgstffmpeg_la-gstffmpegdec.Plo
-@am__fastdepCC_FALSE@	$(AM_V_CC) @AM_BACKSLASH@
-@AMDEP_TRUE@@am__fastdepCC_FALSE@	source='gstffmpegdec.c' object='libgstffmpeg_la-gstffmpegdec.lo' libtool=yes @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='gstffmpegdec.c' object='libgstffmpeg_la-gstffmpegdec.lo' libtool=yes @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(LIBTOOL) $(AM_V_lt) --tag=CC $(libgstffmpeg_la_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libgstffmpeg_la_CFLAGS) $(CFLAGS) -c -o libgstffmpeg_la-gstffmpegdec.lo `test -f 'gstffmpegdec.c' || echo '$(srcdir)/'`gstffmpegdec.c
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(LIBTOOL) $(AM_V_lt) --tag=CC $(libgstffmpeg_la_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libgstffmpeg_la_CFLAGS) $(CFLAGS) -c -o libgstffmpeg_la-gstffmpegdec.lo `test -f 'gstffmpegdec.c' || echo '$(srcdir)/'`gstffmpegdec.c
+
+libgstffmpeg_la-gstffmpegviddec.lo: gstffmpegviddec.c
+@am__fastdepCC_TRUE@	$(AM_V_CC)$(LIBTOOL) $(AM_V_lt) --tag=CC $(libgstffmpeg_la_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libgstffmpeg_la_CFLAGS) $(CFLAGS) -MT libgstffmpeg_la-gstffmpegviddec.lo -MD -MP -MF $(DEPDIR)/libgstffmpeg_la-gstffmpegviddec.Tpo -c -o libgstffmpeg_la-gstffmpegviddec.lo `test -f 'gstffmpegviddec.c' || echo '$(srcdir)/'`gstffmpegviddec.c
+@am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/libgstffmpeg_la-gstffmpegviddec.Tpo $(DEPDIR)/libgstffmpeg_la-gstffmpegviddec.Plo
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='gstffmpegviddec.c' object='libgstffmpeg_la-gstffmpegviddec.lo' libtool=yes @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(LIBTOOL) $(AM_V_lt) --tag=CC $(libgstffmpeg_la_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libgstffmpeg_la_CFLAGS) $(CFLAGS) -c -o libgstffmpeg_la-gstffmpegviddec.lo `test -f 'gstffmpegviddec.c' || echo '$(srcdir)/'`gstffmpegviddec.c
 
 libgstffmpeg_la-gstffmpegcfg.lo: gstffmpegcfg.c
 @am__fastdepCC_TRUE@	$(AM_V_CC)$(LIBTOOL) $(AM_V_lt) --tag=CC $(libgstffmpeg_la_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libgstffmpeg_la_CFLAGS) $(CFLAGS) -MT libgstffmpeg_la-gstffmpegcfg.lo -MD -MP -MF $(DEPDIR)/libgstffmpeg_la-gstffmpegcfg.Tpo -c -o libgstffmpeg_la-gstffmpegcfg.lo `test -f 'gstffmpegcfg.c' || echo '$(srcdir)/'`gstffmpegcfg.c
 @am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/libgstffmpeg_la-gstffmpegcfg.Tpo $(DEPDIR)/libgstffmpeg_la-gstffmpegcfg.Plo
-@am__fastdepCC_FALSE@	$(AM_V_CC) @AM_BACKSLASH@
-@AMDEP_TRUE@@am__fastdepCC_FALSE@	source='gstffmpegcfg.c' object='libgstffmpeg_la-gstffmpegcfg.lo' libtool=yes @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='gstffmpegcfg.c' object='libgstffmpeg_la-gstffmpegcfg.lo' libtool=yes @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(LIBTOOL) $(AM_V_lt) --tag=CC $(libgstffmpeg_la_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libgstffmpeg_la_CFLAGS) $(CFLAGS) -c -o libgstffmpeg_la-gstffmpegcfg.lo `test -f 'gstffmpegcfg.c' || echo '$(srcdir)/'`gstffmpegcfg.c
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(LIBTOOL) $(AM_V_lt) --tag=CC $(libgstffmpeg_la_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libgstffmpeg_la_CFLAGS) $(CFLAGS) -c -o libgstffmpeg_la-gstffmpegcfg.lo `test -f 'gstffmpegcfg.c' || echo '$(srcdir)/'`gstffmpegcfg.c
 
 libgstffmpeg_la-gstffmpegdemux.lo: gstffmpegdemux.c
 @am__fastdepCC_TRUE@	$(AM_V_CC)$(LIBTOOL) $(AM_V_lt) --tag=CC $(libgstffmpeg_la_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libgstffmpeg_la_CFLAGS) $(CFLAGS) -MT libgstffmpeg_la-gstffmpegdemux.lo -MD -MP -MF $(DEPDIR)/libgstffmpeg_la-gstffmpegdemux.Tpo -c -o libgstffmpeg_la-gstffmpegdemux.lo `test -f 'gstffmpegdemux.c' || echo '$(srcdir)/'`gstffmpegdemux.c
 @am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/libgstffmpeg_la-gstffmpegdemux.Tpo $(DEPDIR)/libgstffmpeg_la-gstffmpegdemux.Plo
-@am__fastdepCC_FALSE@	$(AM_V_CC) @AM_BACKSLASH@
-@AMDEP_TRUE@@am__fastdepCC_FALSE@	source='gstffmpegdemux.c' object='libgstffmpeg_la-gstffmpegdemux.lo' libtool=yes @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='gstffmpegdemux.c' object='libgstffmpeg_la-gstffmpegdemux.lo' libtool=yes @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(LIBTOOL) $(AM_V_lt) --tag=CC $(libgstffmpeg_la_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libgstffmpeg_la_CFLAGS) $(CFLAGS) -c -o libgstffmpeg_la-gstffmpegdemux.lo `test -f 'gstffmpegdemux.c' || echo '$(srcdir)/'`gstffmpegdemux.c
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(LIBTOOL) $(AM_V_lt) --tag=CC $(libgstffmpeg_la_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libgstffmpeg_la_CFLAGS) $(CFLAGS) -c -o libgstffmpeg_la-gstffmpegdemux.lo `test -f 'gstffmpegdemux.c' || echo '$(srcdir)/'`gstffmpegdemux.c
 
 libgstffmpeg_la-gstffmpegmux.lo: gstffmpegmux.c
 @am__fastdepCC_TRUE@	$(AM_V_CC)$(LIBTOOL) $(AM_V_lt) --tag=CC $(libgstffmpeg_la_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libgstffmpeg_la_CFLAGS) $(CFLAGS) -MT libgstffmpeg_la-gstffmpegmux.lo -MD -MP -MF $(DEPDIR)/libgstffmpeg_la-gstffmpegmux.Tpo -c -o libgstffmpeg_la-gstffmpegmux.lo `test -f 'gstffmpegmux.c' || echo '$(srcdir)/'`gstffmpegmux.c
 @am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/libgstffmpeg_la-gstffmpegmux.Tpo $(DEPDIR)/libgstffmpeg_la-gstffmpegmux.Plo
-@am__fastdepCC_FALSE@	$(AM_V_CC) @AM_BACKSLASH@
-@AMDEP_TRUE@@am__fastdepCC_FALSE@	source='gstffmpegmux.c' object='libgstffmpeg_la-gstffmpegmux.lo' libtool=yes @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='gstffmpegmux.c' object='libgstffmpeg_la-gstffmpegmux.lo' libtool=yes @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(LIBTOOL) $(AM_V_lt) --tag=CC $(libgstffmpeg_la_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libgstffmpeg_la_CFLAGS) $(CFLAGS) -c -o libgstffmpeg_la-gstffmpegmux.lo `test -f 'gstffmpegmux.c' || echo '$(srcdir)/'`gstffmpegmux.c
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(LIBTOOL) $(AM_V_lt) --tag=CC $(libgstffmpeg_la_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libgstffmpeg_la_CFLAGS) $(CFLAGS) -c -o libgstffmpeg_la-gstffmpegmux.lo `test -f 'gstffmpegmux.c' || echo '$(srcdir)/'`gstffmpegmux.c
 
 libgstffmpeg_la-gstffmpegdeinterlace.lo: gstffmpegdeinterlace.c
 @am__fastdepCC_TRUE@	$(AM_V_CC)$(LIBTOOL) $(AM_V_lt) --tag=CC $(libgstffmpeg_la_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libgstffmpeg_la_CFLAGS) $(CFLAGS) -MT libgstffmpeg_la-gstffmpegdeinterlace.lo -MD -MP -MF $(DEPDIR)/libgstffmpeg_la-gstffmpegdeinterlace.Tpo -c -o libgstffmpeg_la-gstffmpegdeinterlace.lo `test -f 'gstffmpegdeinterlace.c' || echo '$(srcdir)/'`gstffmpegdeinterlace.c
 @am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/libgstffmpeg_la-gstffmpegdeinterlace.Tpo $(DEPDIR)/libgstffmpeg_la-gstffmpegdeinterlace.Plo
-@am__fastdepCC_FALSE@	$(AM_V_CC) @AM_BACKSLASH@
-@AMDEP_TRUE@@am__fastdepCC_FALSE@	source='gstffmpegdeinterlace.c' object='libgstffmpeg_la-gstffmpegdeinterlace.lo' libtool=yes @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='gstffmpegdeinterlace.c' object='libgstffmpeg_la-gstffmpegdeinterlace.lo' libtool=yes @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(LIBTOOL) $(AM_V_lt) --tag=CC $(libgstffmpeg_la_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libgstffmpeg_la_CFLAGS) $(CFLAGS) -c -o libgstffmpeg_la-gstffmpegdeinterlace.lo `test -f 'gstffmpegdeinterlace.c' || echo '$(srcdir)/'`gstffmpegdeinterlace.c
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(LIBTOOL) $(AM_V_lt) --tag=CC $(libgstffmpeg_la_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libgstffmpeg_la_CFLAGS) $(CFLAGS) -c -o libgstffmpeg_la-gstffmpegdeinterlace.lo `test -f 'gstffmpegdeinterlace.c' || echo '$(srcdir)/'`gstffmpegdeinterlace.c
 
 libgstffmpeg_la-gstffmpegaudioresample.lo: gstffmpegaudioresample.c
 @am__fastdepCC_TRUE@	$(AM_V_CC)$(LIBTOOL) $(AM_V_lt) --tag=CC $(libgstffmpeg_la_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libgstffmpeg_la_CFLAGS) $(CFLAGS) -MT libgstffmpeg_la-gstffmpegaudioresample.lo -MD -MP -MF $(DEPDIR)/libgstffmpeg_la-gstffmpegaudioresample.Tpo -c -o libgstffmpeg_la-gstffmpegaudioresample.lo `test -f 'gstffmpegaudioresample.c' || echo '$(srcdir)/'`gstffmpegaudioresample.c
 @am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/libgstffmpeg_la-gstffmpegaudioresample.Tpo $(DEPDIR)/libgstffmpeg_la-gstffmpegaudioresample.Plo
-@am__fastdepCC_FALSE@	$(AM_V_CC) @AM_BACKSLASH@
-@AMDEP_TRUE@@am__fastdepCC_FALSE@	source='gstffmpegaudioresample.c' object='libgstffmpeg_la-gstffmpegaudioresample.lo' libtool=yes @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='gstffmpegaudioresample.c' object='libgstffmpeg_la-gstffmpegaudioresample.lo' libtool=yes @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(LIBTOOL) $(AM_V_lt) --tag=CC $(libgstffmpeg_la_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libgstffmpeg_la_CFLAGS) $(CFLAGS) -c -o libgstffmpeg_la-gstffmpegaudioresample.lo `test -f 'gstffmpegaudioresample.c' || echo '$(srcdir)/'`gstffmpegaudioresample.c
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(LIBTOOL) $(AM_V_lt) --tag=CC $(libgstffmpeg_la_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libgstffmpeg_la_CFLAGS) $(CFLAGS) -c -o libgstffmpeg_la-gstffmpegaudioresample.lo `test -f 'gstffmpegaudioresample.c' || echo '$(srcdir)/'`gstffmpegaudioresample.c
 
 mostlyclean-libtool:
 	-rm -f *.lo
@@ -628,6 +679,20 @@ GTAGS:
 	  && $(am__cd) $(top_srcdir) \
 	  && gtags -i $(GTAGS_ARGS) "$$here"
 
+cscopelist:  $(HEADERS) $(SOURCES) $(LISP)
+	list='$(SOURCES) $(HEADERS) $(LISP)'; \
+	case "$(srcdir)" in \
+	  [\\/]* | ?:[\\/]*) sdir="$(srcdir)" ;; \
+	  *) sdir=$(subdir)/$(srcdir) ;; \
+	esac; \
+	for i in $$list; do \
+	  if test -f "$$i"; then \
+	    echo "$(subdir)/$$i"; \
+	  else \
+	    echo "$$sdir/$$i"; \
+	  fi; \
+	done >> $(top_builddir)/cscope.files
+
 distclean-tags:
 	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
 
@@ -678,10 +743,15 @@ install-am: all-am
 
 installcheck: installcheck-am
 install-strip:
-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
-	  `test -z '$(STRIP)' || \
-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+	if test -z '$(STRIP)'; then \
+	  $(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+	    install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+	      install; \
+	else \
+	  $(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+	    install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+	    "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'" install; \
+	fi
 mostlyclean-generic:
 
 clean-generic:
@@ -767,18 +837,19 @@ uninstall-am: uninstall-pluginLTLIBRARIES
 .MAKE: install-am install-strip
 
 .PHONY: CTAGS GTAGS all all-am check check-am clean clean-generic \
-	clean-libtool clean-pluginLTLIBRARIES ctags distclean \
-	distclean-compile distclean-generic distclean-libtool \
-	distclean-tags distdir dvi dvi-am html html-am info info-am \
-	install install-am install-data install-data-am install-dvi \
-	install-dvi-am install-exec install-exec-am install-html \
-	install-html-am install-info install-info-am install-man \
-	install-pdf install-pdf-am install-pluginLTLIBRARIES \
-	install-ps install-ps-am install-strip installcheck \
-	installcheck-am installdirs maintainer-clean \
-	maintainer-clean-generic mostlyclean mostlyclean-compile \
-	mostlyclean-generic mostlyclean-libtool pdf pdf-am ps ps-am \
-	tags uninstall uninstall-am uninstall-pluginLTLIBRARIES
+	clean-libtool clean-pluginLTLIBRARIES cscopelist ctags \
+	distclean distclean-compile distclean-generic \
+	distclean-libtool distclean-tags distdir dvi dvi-am html \
+	html-am info info-am install install-am install-data \
+	install-data-am install-dvi install-dvi-am install-exec \
+	install-exec-am install-html install-html-am install-info \
+	install-info-am install-man install-pdf install-pdf-am \
+	install-pluginLTLIBRARIES install-ps install-ps-am \
+	install-strip installcheck installcheck-am installdirs \
+	maintainer-clean maintainer-clean-generic mostlyclean \
+	mostlyclean-compile mostlyclean-generic mostlyclean-libtool \
+	pdf pdf-am ps ps-am tags uninstall uninstall-am \
+	uninstall-pluginLTLIBRARIES
 
 
 # Tell versions [3.59,3.63) of GNU make to not export all variables.
diff --git a/ext/ffmpeg/gstffmpeg.c b/ext/ffmpeg/gstffmpeg.c
index 88a43bc..5d3867a 100644
--- a/ext/ffmpeg/gstffmpeg.c
+++ b/ext/ffmpeg/gstffmpeg.c
@@ -138,8 +138,10 @@ plugin_init (GstPlugin * plugin)
 
   av_register_all ();
 
-  gst_ffmpegenc_register (plugin);
-  gst_ffmpegdec_register (plugin);
+  gst_ffmpegaudenc_register (plugin);
+  gst_ffmpegvidenc_register (plugin);
+  gst_ffmpegauddec_register (plugin);
+  gst_ffmpegviddec_register (plugin);
   gst_ffmpegdemux_register (plugin);
   gst_ffmpegmux_register (plugin);
   gst_ffmpegdeinterlace_register (plugin);
diff --git a/ext/ffmpeg/gstffmpeg.h b/ext/ffmpeg/gstffmpeg.h
index 667fa51..2cbddd4 100644
--- a/ext/ffmpeg/gstffmpeg.h
+++ b/ext/ffmpeg/gstffmpeg.h
@@ -44,8 +44,10 @@ extern gboolean _shut_up_I_am_probing;
 #endif
 
 extern gboolean gst_ffmpegdemux_register (GstPlugin * plugin);
-extern gboolean gst_ffmpegdec_register (GstPlugin * plugin);
-extern gboolean gst_ffmpegenc_register (GstPlugin * plugin);
+extern gboolean gst_ffmpegauddec_register (GstPlugin * plugin);
+extern gboolean gst_ffmpegviddec_register (GstPlugin * plugin);
+extern gboolean gst_ffmpegaudenc_register (GstPlugin * plugin);
+extern gboolean gst_ffmpegvidenc_register (GstPlugin * plugin);
 extern gboolean gst_ffmpegmux_register (GstPlugin * plugin);
 extern gboolean gst_ffmpegcsp_register (GstPlugin * plugin);
 #if 0
diff --git a/ext/ffmpeg/gstffmpegaudioresample.c b/ext/ffmpeg/gstffmpegaudioresample.c
index 321a008..b63068d 100644
--- a/ext/ffmpeg/gstffmpegaudioresample.c
+++ b/ext/ffmpeg/gstffmpegaudioresample.c
@@ -103,10 +103,8 @@ gst_ffmpegaudioresample_base_init (gpointer g_class)
 {
   GstElementClass *element_class = GST_ELEMENT_CLASS (g_class);
 
-  gst_element_class_add_pad_template (element_class,
-      gst_static_pad_template_get (&src_factory));
-  gst_element_class_add_pad_template (element_class,
-      gst_static_pad_template_get (&sink_factory));
+  gst_element_class_add_static_pad_template (element_class, &src_factory);
+  gst_element_class_add_static_pad_template (element_class, &sink_factory);
   gst_element_class_set_details_simple (element_class,
       "FFMPEG Audio resampling element", "Filter/Converter/Audio",
       "Converts audio from one samplerate to another",
diff --git a/ext/ffmpeg/gstffmpegcfg.c b/ext/ffmpeg/gstffmpegcfg.c
index 6b87cc3..d9bf4e3 100644
--- a/ext/ffmpeg/gstffmpegcfg.c
+++ b/ext/ffmpeg/gstffmpegcfg.c
@@ -26,7 +26,7 @@
 #endif
 
 #include "gstffmpeg.h"
-#include "gstffmpegenc.h"
+#include "gstffmpegvidenc.h"
 #include "gstffmpegcfg.h"
 
 #include <string.h>
@@ -49,7 +49,7 @@ gst_ffmpeg_pass_get_type (void)
     };
 
     ffmpeg_pass_type =
-        g_enum_register_static ("GstFFMpegEncPass", ffmpeg_passes);
+        g_enum_register_static ("GstFFMpegVidEncPass", ffmpeg_passes);
   }
 
   return ffmpeg_pass_type;
@@ -71,7 +71,7 @@ gst_ffmpeg_lim_pass_get_type (void)
     };
 
     ffmpeg_lim_pass_type =
-        g_enum_register_static ("GstFFMpegEncLimPass", ffmpeg_lim_passes);
+        g_enum_register_static ("GstFFMpegVidEncLimPass", ffmpeg_lim_passes);
   }
 
   return ffmpeg_lim_pass_type;
@@ -94,7 +94,8 @@ gst_ffmpeg_mb_decision_get_type (void)
     };
 
     ffmpeg_mb_decision_type =
-        g_enum_register_static ("GstFFMpegEncMBDecision", ffmpeg_mb_decisions);
+        g_enum_register_static ("GstFFMpegVidEncMBDecision",
+        ffmpeg_mb_decisions);
   }
 
   return ffmpeg_mb_decision_type;
@@ -207,7 +208,8 @@ gst_ffmpeg_quant_type_get_type (void)
     };
 
     ffmpeg_quant_type_type =
-        g_enum_register_static ("GstFFMpegEncQuantTypes", ffmpeg_quant_types);
+        g_enum_register_static ("GstFFMpegVidEncQuantTypes",
+        ffmpeg_quant_types);
   }
 
   return ffmpeg_quant_type_type;
@@ -228,7 +230,7 @@ gst_ffmpeg_pre_me_get_type (void)
     };
 
     ffmpeg_pre_me_type =
-        g_enum_register_static ("GstFFMpegEncPreME", ffmpeg_pre_mes);
+        g_enum_register_static ("GstFFMpegVidEncPreME", ffmpeg_pre_mes);
   }
 
   return ffmpeg_pre_me_type;
@@ -249,7 +251,8 @@ gst_ffmpeg_pred_method_get_type (void)
     };
 
     ffmpeg_pred_method =
-        g_enum_register_static ("GstFFMpegEncPredMethod", ffmpeg_pred_methods);
+        g_enum_register_static ("GstFFMpegVidEncPredMethod",
+        ffmpeg_pred_methods);
   }
 
   return ffmpeg_pred_method;
@@ -325,7 +328,7 @@ struct _GParamSpecData
 /* properties whose member offset is higher than the config base
  * can be copied directly at context configuration time;
  * and can also retrieve a default value from lavc */
-#define CONTEXT_CONFIG_OFFSET   G_STRUCT_OFFSET (GstFFMpegEnc, config)
+#define CONTEXT_CONFIG_OFFSET   G_STRUCT_OFFSET (GstFFMpegVidEnc, config)
 
 /* additional info is named pointer specified by the quark */
 static GQuark quark;
@@ -340,7 +343,7 @@ static GList *property_list;
     default, include, exclude)                                          \
 G_STMT_START {                                                          \
   GParamSpecData *_qdata = g_new0 (GParamSpecData, 1);                  \
-  GstFFMpegEnc _enc;                                                    \
+  GstFFMpegVidEnc _enc;                                                    \
   _qdata->offset = G_STRUCT_OFFSET (struct_type, member);               \
   _qdata->size = sizeof (_enc.member);                                  \
   _qdata->lavc_default = default;                                       \
@@ -351,7 +354,7 @@ G_STMT_START {                                                          \
 } G_STMT_END
 
 #define gst_ffmpeg_add_pspec(pspec, member, default, include, exclude)       \
-  gst_ffmpeg_add_pspec_full (pspec, property_list, GstFFMpegEnc, member,     \
+  gst_ffmpeg_add_pspec_full (pspec, property_list, GstFFMpegVidEnc, member,     \
       default, include, exclude)
 
 /* ==== BEGIN CONFIGURATION SECTION ==== */
@@ -756,7 +759,7 @@ gst_ffmpeg_cfg_codec_has_pspec (enum CodecID codec_id, GParamSpec * pspec)
 
 /* install all properties for klass that have been registered in property_list */
 void
-gst_ffmpeg_cfg_install_property (GstFFMpegEncClass * klass, guint base)
+gst_ffmpeg_cfg_install_property (GstFFMpegVidEncClass * klass, guint base)
 {
   GParamSpec *pspec;
   GList *list;
@@ -888,7 +891,7 @@ gboolean
 gst_ffmpeg_cfg_set_property (GObject * object,
     const GValue * value, GParamSpec * pspec)
 {
-  GstFFMpegEnc *ffmpegenc = (GstFFMpegEnc *) (object);
+  GstFFMpegVidEnc *ffmpegenc = (GstFFMpegVidEnc *) (object);
   GParamSpecData *qdata;
 
   qdata = g_param_spec_get_qdata (pspec, quark);
@@ -956,7 +959,7 @@ gboolean
 gst_ffmpeg_cfg_get_property (GObject * object,
     GValue * value, GParamSpec * pspec)
 {
-  GstFFMpegEnc *ffmpegenc = (GstFFMpegEnc *) (object);
+  GstFFMpegVidEnc *ffmpegenc = (GstFFMpegVidEnc *) (object);
   GParamSpecData *qdata;
 
   qdata = g_param_spec_get_qdata (pspec, quark);
@@ -1016,7 +1019,7 @@ gst_ffmpeg_cfg_get_property (GObject * object,
 }
 
 void
-gst_ffmpeg_cfg_set_defaults (GstFFMpegEnc * ffmpegenc)
+gst_ffmpeg_cfg_set_defaults (GstFFMpegVidEnc * ffmpegenc)
 {
   GParamSpec **pspecs;
   guint num_props, i;
@@ -1044,10 +1047,11 @@ gst_ffmpeg_cfg_set_defaults (GstFFMpegEnc * ffmpegenc)
 
 
 void
-gst_ffmpeg_cfg_fill_context (GstFFMpegEnc * ffmpegenc, AVCodecContext * context)
+gst_ffmpeg_cfg_fill_context (GstFFMpegVidEnc * ffmpegenc,
+    AVCodecContext * context)
 {
-  GstFFMpegEncClass *klass
-      = (GstFFMpegEncClass *) G_OBJECT_GET_CLASS (ffmpegenc);
+  GstFFMpegVidEncClass *klass
+      = (GstFFMpegVidEncClass *) G_OBJECT_GET_CLASS (ffmpegenc);
   GParamSpec *pspec;
   GParamSpecData *qdata;
   GList *list;
@@ -1079,7 +1083,7 @@ gst_ffmpeg_cfg_fill_context (GstFFMpegEnc * ffmpegenc, AVCodecContext * context)
 }
 
 void
-gst_ffmpeg_cfg_finalize (GstFFMpegEnc * ffmpegenc)
+gst_ffmpeg_cfg_finalize (GstFFMpegVidEnc * ffmpegenc)
 {
   GParamSpec **pspecs;
   guint num_props, i;
diff --git a/ext/ffmpeg/gstffmpegcfg.h b/ext/ffmpeg/gstffmpegcfg.h
index 1dcaade..5251eb2 100644
--- a/ext/ffmpeg/gstffmpegcfg.h
+++ b/ext/ffmpeg/gstffmpegcfg.h
@@ -25,7 +25,7 @@ G_BEGIN_DECLS
 
 void gst_ffmpeg_cfg_init (void);
 
-void gst_ffmpeg_cfg_install_property (GstFFMpegEncClass * klass, guint base);
+void gst_ffmpeg_cfg_install_property (GstFFMpegVidEncClass * klass, guint base);
 
 gboolean gst_ffmpeg_cfg_set_property (GObject * object,
     const GValue * value, GParamSpec * pspec);
@@ -33,9 +33,9 @@ gboolean gst_ffmpeg_cfg_set_property (GObject * object,
 gboolean gst_ffmpeg_cfg_get_property (GObject * object,
     GValue * value, GParamSpec * pspec);
 
-void gst_ffmpeg_cfg_fill_context (GstFFMpegEnc * ffmpegenc, AVCodecContext * context);
-void gst_ffmpeg_cfg_set_defaults (GstFFMpegEnc * ffmpegenc);
-void gst_ffmpeg_cfg_finalize (GstFFMpegEnc * ffmpegenc);
+void gst_ffmpeg_cfg_fill_context (GstFFMpegVidEnc * ffmpegenc, AVCodecContext * context);
+void gst_ffmpeg_cfg_set_defaults (GstFFMpegVidEnc * ffmpegenc);
+void gst_ffmpeg_cfg_finalize (GstFFMpegVidEnc * ffmpegenc);
 
 G_END_DECLS
 
diff --git a/ext/ffmpeg/gstffmpegcodecmap.c b/ext/ffmpeg/gstffmpegcodecmap.c
index f3381dd..f80b861 100644
--- a/ext/ffmpeg/gstffmpegcodecmap.c
+++ b/ext/ffmpeg/gstffmpegcodecmap.c
@@ -186,7 +186,7 @@ gst_ff_channel_layout_to_gst (guint64 channel_layout, guint channels)
  */
 static GstCaps *
 gst_ff_vid_caps_new (AVCodecContext * context, enum CodecID codec_id,
-    const char *mimetype, const char *fieldname, ...)
+    gboolean encode, const char *mimetype, const char *fieldname, ...)
 {
   GstStructure *structure = NULL;
   GstCaps *caps = NULL;
@@ -218,7 +218,7 @@ gst_ff_vid_caps_new (AVCodecContext * context, enum CodecID codec_id,
     GST_LOG ("setting framerate: %d/%d", num, denom);
     gst_caps_set_simple (caps,
         "framerate", GST_TYPE_FRACTION, num, denom, NULL);
-  } else {
+  } else if (encode) {
     /* so we are after restricted caps in this case */
     switch (codec_id) {
       case CODEC_ID_H261:
@@ -328,7 +328,7 @@ gst_ff_vid_caps_new (AVCodecContext * context, enum CodecID codec_id,
  */
 static GstCaps *
 gst_ff_aud_caps_new (AVCodecContext * context, enum CodecID codec_id,
-    const char *mimetype, const char *fieldname, ...)
+    gboolean encode, const char *mimetype, const char *fieldname, ...)
 {
   GstCaps *caps = NULL;
   GstStructure *structure = NULL;
@@ -340,25 +340,6 @@ gst_ff_aud_caps_new (AVCodecContext * context, enum CodecID codec_id,
     GstAudioChannelPosition *pos;
     guint64 channel_layout = context->channel_layout;
 
-    if (channel_layout == 0) {
-      const guint64 default_channel_set[] = {
-        0, 0, CH_LAYOUT_SURROUND, CH_LAYOUT_QUAD, CH_LAYOUT_5POINT0,
-        CH_LAYOUT_5POINT1, 0, CH_LAYOUT_7POINT1
-      };
-
-      switch (codec_id) {
-        case CODEC_ID_EAC3:
-        case CODEC_ID_AC3:
-        case CODEC_ID_DTS:
-          if (context->channels > 0
-              && context->channels < G_N_ELEMENTS (default_channel_set))
-            channel_layout = default_channel_set[context->channels - 1];
-          break;
-        default:
-          break;
-      }
-    }
-
     caps = gst_caps_new_simple (mimetype,
         "rate", G_TYPE_INT, context->sample_rate,
         "channels", G_TYPE_INT, context->channels, NULL);
@@ -368,7 +349,7 @@ gst_ff_aud_caps_new (AVCodecContext * context, enum CodecID codec_id,
       gst_audio_set_channel_positions (gst_caps_get_structure (caps, 0), pos);
       g_free (pos);
     }
-  } else {
+  } else if (encode) {
     gint maxchannels = 2;
     const gint *rates = NULL;
     gint n_rates = 0;
@@ -487,6 +468,8 @@ gst_ff_aud_caps_new (AVCodecContext * context, enum CodecID codec_id,
       g_value_unset (&list);
     } else
       gst_caps_set_simple (caps, "rate", GST_TYPE_INT_RANGE, 4000, 96000, NULL);
+  } else {
+    caps = gst_caps_new_simple (mimetype, NULL);
   }
 
   for (i = 0; i < gst_caps_get_size (caps); i++) {
@@ -527,7 +510,7 @@ gst_ffmpeg_codecid_to_caps (enum CodecID codec_id,
   switch (codec_id) {
     case CODEC_ID_MPEG1VIDEO:
       /* FIXME: bitrate */
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/mpeg",
+      caps = gst_ff_vid_caps_new (context, codec_id, encode, "video/mpeg",
           "mpegversion", G_TYPE_INT, 1,
           "systemstream", G_TYPE_BOOLEAN, FALSE, NULL);
       break;
@@ -535,7 +518,7 @@ gst_ffmpeg_codecid_to_caps (enum CodecID codec_id,
     case CODEC_ID_MPEG2VIDEO:
       if (encode) {
         /* FIXME: bitrate */
-        caps = gst_ff_vid_caps_new (context, codec_id, "video/mpeg",
+        caps = gst_ff_vid_caps_new (context, codec_id, encode, "video/mpeg",
             "mpegversion", G_TYPE_INT, 2,
             "systemstream", G_TYPE_BOOLEAN, FALSE, NULL);
       } else {
@@ -553,20 +536,21 @@ gst_ffmpeg_codecid_to_caps (enum CodecID codec_id,
 
     case CODEC_ID_H263:
       if (encode) {
-        caps = gst_ff_vid_caps_new (context, codec_id, "video/x-h263",
+        caps = gst_ff_vid_caps_new (context, codec_id, encode, "video/x-h263",
             "variant", G_TYPE_STRING, "itu",
             "h263version", G_TYPE_STRING, "h263", NULL);
       } else {
         /* don't pass codec_id, we can decode other variants with the H263
          * decoder that don't have specific size requirements
          */
-        caps = gst_ff_vid_caps_new (context, CODEC_ID_NONE, "video/x-h263",
+        caps =
+            gst_ff_vid_caps_new (context, CODEC_ID_NONE, encode, "video/x-h263",
             "variant", G_TYPE_STRING, "itu", NULL);
       }
       break;
 
     case CODEC_ID_H263P:
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-h263",
+      caps = gst_ff_vid_caps_new (context, codec_id, encode, "video/x-h263",
           "variant", G_TYPE_STRING, "itu",
           "h263version", G_TYPE_STRING, "h263p", NULL);
       if (encode && context) {
@@ -581,12 +565,14 @@ gst_ffmpeg_codecid_to_caps (enum CodecID codec_id,
       break;
 
     case CODEC_ID_H263I:
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-intel-h263",
+      caps =
+          gst_ff_vid_caps_new (context, codec_id, encode, "video/x-intel-h263",
           "variant", G_TYPE_STRING, "intel", NULL);
       break;
 
     case CODEC_ID_H261:
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-h261", NULL);
+      caps =
+          gst_ff_vid_caps_new (context, codec_id, encode, "video/x-h261", NULL);
       break;
 
     case CODEC_ID_RV10:
@@ -612,8 +598,9 @@ gst_ffmpeg_codecid_to_caps (enum CodecID codec_id,
       }
 
       /* FIXME: context->sub_id must be filled in during decoding */
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-pn-realvideo",
-          "systemstream", G_TYPE_BOOLEAN, FALSE,
+      caps =
+          gst_ff_vid_caps_new (context, codec_id, encode,
+          "video/x-pn-realvideo", "systemstream", G_TYPE_BOOLEAN, FALSE,
           "rmversion", G_TYPE_INT, version, NULL);
       if (context) {
         gst_caps_set_simple (caps, "format", G_TYPE_INT, context->sub_id, NULL);
@@ -628,20 +615,20 @@ gst_ffmpeg_codecid_to_caps (enum CodecID codec_id,
 
     case CODEC_ID_MP1:
       /* FIXME: bitrate */
-      caps = gst_ff_aud_caps_new (context, codec_id, "audio/mpeg",
+      caps = gst_ff_aud_caps_new (context, codec_id, encode, "audio/mpeg",
           "mpegversion", G_TYPE_INT, 1, "layer", G_TYPE_INT, 1, NULL);
       break;
 
     case CODEC_ID_MP2:
       /* FIXME: bitrate */
-      caps = gst_ff_aud_caps_new (context, codec_id, "audio/mpeg",
+      caps = gst_ff_aud_caps_new (context, codec_id, encode, "audio/mpeg",
           "mpegversion", G_TYPE_INT, 1, "layer", G_TYPE_INT, 2, NULL);
       break;
 
     case CODEC_ID_MP3:
       if (encode) {
         /* FIXME: bitrate */
-        caps = gst_ff_aud_caps_new (context, codec_id, "audio/mpeg",
+        caps = gst_ff_aud_caps_new (context, codec_id, encode, "audio/mpeg",
             "mpegversion", G_TYPE_INT, 1, "layer", G_TYPE_INT, 3, NULL);
       } else {
         /* Decodes MPEG-1 layer 1/2/3. Samplerate, channels et al are
@@ -654,52 +641,57 @@ gst_ffmpeg_codecid_to_caps (enum CodecID codec_id,
 
     case CODEC_ID_MUSEPACK7:
       caps =
-          gst_ff_aud_caps_new (context, codec_id,
+          gst_ff_aud_caps_new (context, codec_id, encode,
           "audio/x-ffmpeg-parsed-musepack", "streamversion", G_TYPE_INT, 7,
           NULL);
       break;
 
     case CODEC_ID_MUSEPACK8:
       caps =
-          gst_ff_aud_caps_new (context, codec_id,
+          gst_ff_aud_caps_new (context, codec_id, encode,
           "audio/x-ffmpeg-parsed-musepack", "streamversion", G_TYPE_INT, 8,
           NULL);
       break;
 
     case CODEC_ID_AC3:
       /* FIXME: bitrate */
-      caps = gst_ff_aud_caps_new (context, codec_id, "audio/x-ac3", NULL);
+      caps =
+          gst_ff_aud_caps_new (context, codec_id, encode, "audio/x-ac3", NULL);
       break;
 
     case CODEC_ID_EAC3:
       /* FIXME: bitrate */
-      caps = gst_ff_aud_caps_new (context, codec_id, "audio/x-eac3", NULL);
+      caps =
+          gst_ff_aud_caps_new (context, codec_id, encode, "audio/x-eac3", NULL);
       break;
 
     case CODEC_ID_TRUEHD:
-      caps = gst_ff_aud_caps_new (context, codec_id, "audio/x-true-hd", NULL);
+      caps =
+          gst_ff_aud_caps_new (context, codec_id, encode, "audio/x-true-hd",
+          NULL);
       break;
 
     case CODEC_ID_ATRAC1:
       caps =
-          gst_ff_aud_caps_new (context, codec_id, "audio/x-vnd.sony.atrac1",
-          NULL);
+          gst_ff_aud_caps_new (context, codec_id, encode,
+          "audio/x-vnd.sony.atrac1", NULL);
       break;
 
     case CODEC_ID_ATRAC3:
       caps =
-          gst_ff_aud_caps_new (context, codec_id, "audio/x-vnd.sony.atrac3",
-          NULL);
+          gst_ff_aud_caps_new (context, codec_id, encode,
+          "audio/x-vnd.sony.atrac3", NULL);
       break;
 
     case CODEC_ID_DTS:
-      caps = gst_ff_aud_caps_new (context, codec_id, "audio/x-dts", NULL);
+      caps =
+          gst_ff_aud_caps_new (context, codec_id, encode, "audio/x-dts", NULL);
       break;
 
     case CODEC_ID_APE:
       caps =
-          gst_ff_aud_caps_new (context, codec_id, "audio/x-ffmpeg-parsed-ape",
-          NULL);
+          gst_ff_aud_caps_new (context, codec_id, encode,
+          "audio/x-ffmpeg-parsed-ape", NULL);
       if (context) {
         gst_caps_set_simple (caps,
             "depth", G_TYPE_INT, context->bits_per_coded_sample, NULL);
@@ -707,11 +699,13 @@ gst_ffmpeg_codecid_to_caps (enum CodecID codec_id,
       break;
 
     case CODEC_ID_MLP:
-      caps = gst_ff_aud_caps_new (context, codec_id, "audio/x-mlp", NULL);
+      caps =
+          gst_ff_aud_caps_new (context, codec_id, encode, "audio/x-mlp", NULL);
       break;
 
     case CODEC_ID_IMC:
-      caps = gst_ff_aud_caps_new (context, codec_id, "audio/x-imc", NULL);
+      caps =
+          gst_ff_aud_caps_new (context, codec_id, encode, "audio/x-imc", NULL);
       break;
 
       /* MJPEG is normal JPEG, Motion-JPEG and Quicktime MJPEG-A. MJPEGB
@@ -721,15 +715,19 @@ gst_ffmpeg_codecid_to_caps (enum CodecID codec_id,
        * MJPEG-B and sp5x decoding...)? */
     case CODEC_ID_MJPEG:
     case CODEC_ID_LJPEG:
-      caps = gst_ff_vid_caps_new (context, codec_id, "image/jpeg", NULL);
+      caps =
+          gst_ff_vid_caps_new (context, codec_id, encode, "image/jpeg", NULL);
       break;
 
     case CODEC_ID_SP5X:
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/sp5x", NULL);
+      caps =
+          gst_ff_vid_caps_new (context, codec_id, encode, "video/sp5x", NULL);
       break;
 
     case CODEC_ID_MJPEGB:
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-mjpeg-b", NULL);
+      caps =
+          gst_ff_vid_caps_new (context, codec_id, encode, "video/x-mjpeg-b",
+          NULL);
       break;
 
     case CODEC_ID_MPEG4:
@@ -738,32 +736,33 @@ gst_ffmpeg_codecid_to_caps (enum CodecID codec_id,
          * the AVI fourcc 'DIVX', but 'mp4v' for Quicktime... */
         switch (context->codec_tag) {
           case GST_MAKE_FOURCC ('D', 'I', 'V', 'X'):
-            caps = gst_ff_vid_caps_new (context, codec_id, "video/x-divx",
+            caps =
+                gst_ff_vid_caps_new (context, codec_id, encode, "video/x-divx",
                 "divxversion", G_TYPE_INT, 5, NULL);
             break;
           case GST_MAKE_FOURCC ('m', 'p', '4', 'v'):
           default:
             /* FIXME: bitrate */
-            caps = gst_ff_vid_caps_new (context, codec_id, "video/mpeg",
+            caps = gst_ff_vid_caps_new (context, codec_id, encode, "video/mpeg",
                 "systemstream", G_TYPE_BOOLEAN, FALSE,
                 "mpegversion", G_TYPE_INT, 4, NULL);
             break;
         }
       } else {
         /* The trick here is to separate xvid, divx, mpeg4, 3ivx et al */
-        caps = gst_ff_vid_caps_new (context, codec_id, "video/mpeg",
+        caps = gst_ff_vid_caps_new (context, codec_id, encode, "video/mpeg",
             "mpegversion", G_TYPE_INT, 4,
             "systemstream", G_TYPE_BOOLEAN, FALSE, NULL);
         if (encode) {
-          gst_caps_append (caps, gst_ff_vid_caps_new (context, codec_id,
+          gst_caps_append (caps, gst_ff_vid_caps_new (context, codec_id, encode,
                   "video/x-divx", "divxversion", G_TYPE_INT, 5, NULL));
         } else {
-          gst_caps_append (caps, gst_ff_vid_caps_new (context, codec_id,
+          gst_caps_append (caps, gst_ff_vid_caps_new (context, codec_id, encode,
                   "video/x-divx", "divxversion", GST_TYPE_INT_RANGE, 4, 5,
                   NULL));
-          gst_caps_append (caps, gst_ff_vid_caps_new (context, codec_id,
+          gst_caps_append (caps, gst_ff_vid_caps_new (context, codec_id, encode,
                   "video/x-xvid", NULL));
-          gst_caps_append (caps, gst_ff_vid_caps_new (context, codec_id,
+          gst_caps_append (caps, gst_ff_vid_caps_new (context, codec_id, encode,
                   "video/x-3ivx", NULL));
         }
       }
@@ -782,10 +781,10 @@ gst_ffmpeg_codecid_to_caps (enum CodecID codec_id,
       gint version = 41 + codec_id - CODEC_ID_MSMPEG4V1;
 
       /* encode-FIXME: bitrate */
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-msmpeg",
+      caps = gst_ff_vid_caps_new (context, codec_id, encode, "video/x-msmpeg",
           "msmpegversion", G_TYPE_INT, version, NULL);
       if (!encode && codec_id == CODEC_ID_MSMPEG4V3) {
-        gst_caps_append (caps, gst_ff_vid_caps_new (context, codec_id,
+        gst_caps_append (caps, gst_ff_vid_caps_new (context, codec_id, encode,
                 "video/x-divx", "divxversion", G_TYPE_INT, 3, NULL));
       }
     }
@@ -796,28 +795,30 @@ gst_ffmpeg_codecid_to_caps (enum CodecID codec_id,
     {
       gint version = (codec_id == CODEC_ID_WMV1) ? 1 : 2;
 
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-wmv",
+      caps = gst_ff_vid_caps_new (context, codec_id, encode, "video/x-wmv",
           "wmvversion", G_TYPE_INT, version, NULL);
     }
       break;
 
     case CODEC_ID_FLV1:
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-flash-video",
+      caps =
+          gst_ff_vid_caps_new (context, codec_id, encode, "video/x-flash-video",
           "flvversion", G_TYPE_INT, 1, NULL);
       break;
 
     case CODEC_ID_SVQ1:
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-svq",
+      caps = gst_ff_vid_caps_new (context, codec_id, encode, "video/x-svq",
           "svqversion", G_TYPE_INT, 1, NULL);
       break;
 
     case CODEC_ID_SVQ3:
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-svq",
+      caps = gst_ff_vid_caps_new (context, codec_id, encode, "video/x-svq",
           "svqversion", G_TYPE_INT, 3, NULL);
       break;
 
     case CODEC_ID_DVAUDIO:
-      caps = gst_ff_aud_caps_new (context, codec_id, "audio/x-dv", NULL);
+      caps =
+          gst_ff_aud_caps_new (context, codec_id, encode, "audio/x-dv", NULL);
       break;
 
     case CODEC_ID_DVVIDEO:
@@ -851,11 +852,11 @@ gst_ffmpeg_codecid_to_caps (enum CodecID codec_id,
             fourcc = GST_MAKE_FOURCC ('I', '4', '2', '0');
             break;
         }
-        caps = gst_ff_vid_caps_new (context, codec_id, "video/x-dv",
+        caps = gst_ff_vid_caps_new (context, codec_id, encode, "video/x-dv",
             "systemstream", G_TYPE_BOOLEAN, FALSE,
             "format", GST_TYPE_FOURCC, fourcc, NULL);
       } else {
-        caps = gst_ff_vid_caps_new (context, codec_id, "video/x-dv",
+        caps = gst_ff_vid_caps_new (context, codec_id, encode, "video/x-dv",
             "systemstream", G_TYPE_BOOLEAN, FALSE, NULL);
       }
     }
@@ -867,12 +868,12 @@ gst_ffmpeg_codecid_to_caps (enum CodecID codec_id,
       gint version = (codec_id == CODEC_ID_WMAV1) ? 1 : 2;
 
       if (context) {
-        caps = gst_ff_aud_caps_new (context, codec_id, "audio/x-wma",
+        caps = gst_ff_aud_caps_new (context, codec_id, encode, "audio/x-wma",
             "wmaversion", G_TYPE_INT, version,
             "block_align", G_TYPE_INT, context->block_align,
             "bitrate", G_TYPE_INT, context->bit_rate, NULL);
       } else {
-        caps = gst_ff_aud_caps_new (context, codec_id, "audio/x-wma",
+        caps = gst_ff_aud_caps_new (context, codec_id, encode, "audio/x-wma",
             "wmaversion", G_TYPE_INT, version,
             "block_align", GST_TYPE_INT_RANGE, 0, G_MAXINT,
             "bitrate", GST_TYPE_INT_RANGE, 0, G_MAXINT, NULL);
@@ -881,14 +882,15 @@ gst_ffmpeg_codecid_to_caps (enum CodecID codec_id,
       break;
     case CODEC_ID_WMAPRO:
     {
-      caps = gst_ff_aud_caps_new (context, codec_id, "audio/x-wma",
+      caps = gst_ff_aud_caps_new (context, codec_id, encode, "audio/x-wma",
           "wmaversion", G_TYPE_INT, 3, NULL);
       break;
     }
 
     case CODEC_ID_WMAVOICE:
     {
-      caps = gst_ff_aud_caps_new (context, codec_id, "audio/x-wms", NULL);
+      caps =
+          gst_ff_aud_caps_new (context, codec_id, encode, "audio/x-wms", NULL);
       break;
     }
 
@@ -897,13 +899,15 @@ gst_ffmpeg_codecid_to_caps (enum CodecID codec_id,
     {
       gint version = (codec_id == CODEC_ID_MACE3) ? 3 : 6;
 
-      caps = gst_ff_aud_caps_new (context, codec_id, "audio/x-mace",
+      caps = gst_ff_aud_caps_new (context, codec_id, encode, "audio/x-mace",
           "maceversion", G_TYPE_INT, version, NULL);
     }
       break;
 
     case CODEC_ID_HUFFYUV:
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-huffyuv", NULL);
+      caps =
+          gst_ff_vid_caps_new (context, codec_id, encode, "video/x-huffyuv",
+          NULL);
       if (context) {
         gst_caps_set_simple (caps,
             "bpp", G_TYPE_INT, context->bits_per_coded_sample, NULL);
@@ -912,65 +916,83 @@ gst_ffmpeg_codecid_to_caps (enum CodecID codec_id,
 
     case CODEC_ID_CYUV:
       caps =
-          gst_ff_vid_caps_new (context, codec_id, "video/x-compressed-yuv",
-          NULL);
+          gst_ff_vid_caps_new (context, codec_id, encode,
+          "video/x-compressed-yuv", NULL);
       break;
 
     case CODEC_ID_H264:
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-h264", NULL);
+      caps =
+          gst_ff_vid_caps_new (context, codec_id, encode, "video/x-h264", NULL);
       break;
 
     case CODEC_ID_INDEO5:
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-indeo",
+      caps = gst_ff_vid_caps_new (context, codec_id, encode, "video/x-indeo",
           "indeoversion", G_TYPE_INT, 5, NULL);
       break;
 
+    case CODEC_ID_INDEO4:
+      caps = gst_ff_vid_caps_new (context, codec_id, encode, "video/x-indeo",
+          "indeoversion", G_TYPE_INT, 4, NULL);
+      break;
+
     case CODEC_ID_INDEO3:
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-indeo",
+      caps = gst_ff_vid_caps_new (context, codec_id, encode, "video/x-indeo",
           "indeoversion", G_TYPE_INT, 3, NULL);
       break;
 
     case CODEC_ID_INDEO2:
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-indeo",
+      caps = gst_ff_vid_caps_new (context, codec_id, encode, "video/x-indeo",
           "indeoversion", G_TYPE_INT, 2, NULL);
       break;
 
     case CODEC_ID_FLASHSV:
       caps =
-          gst_ff_vid_caps_new (context, codec_id, "video/x-flash-screen", NULL);
+          gst_ff_vid_caps_new (context, codec_id, encode,
+          "video/x-flash-screen", NULL);
       break;
 
     case CODEC_ID_VP3:
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-vp3", NULL);
+      caps =
+          gst_ff_vid_caps_new (context, codec_id, encode, "video/x-vp3", NULL);
       break;
 
     case CODEC_ID_VP5:
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-vp5", NULL);
+      caps =
+          gst_ff_vid_caps_new (context, codec_id, encode, "video/x-vp5", NULL);
       break;
 
     case CODEC_ID_VP6:
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-vp6", NULL);
+      caps =
+          gst_ff_vid_caps_new (context, codec_id, encode, "video/x-vp6", NULL);
       break;
 
     case CODEC_ID_VP6F:
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-vp6-flash", NULL);
+      caps =
+          gst_ff_vid_caps_new (context, codec_id, encode, "video/x-vp6-flash",
+          NULL);
       break;
 
     case CODEC_ID_VP6A:
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-vp6-alpha", NULL);
+      caps =
+          gst_ff_vid_caps_new (context, codec_id, encode, "video/x-vp6-alpha",
+          NULL);
       break;
 
     case CODEC_ID_VP8:
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-vp8", NULL);
+      caps =
+          gst_ff_vid_caps_new (context, codec_id, encode, "video/x-vp8", NULL);
       break;
 
     case CODEC_ID_THEORA:
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-theora", NULL);
+      caps =
+          gst_ff_vid_caps_new (context, codec_id, encode, "video/x-theora",
+          NULL);
       break;
 
     case CODEC_ID_AAC:
     {
-      caps = gst_ff_aud_caps_new (context, codec_id, "audio/mpeg", NULL);
+      caps =
+          gst_ff_aud_caps_new (context, codec_id, encode, "audio/mpeg", NULL);
 
       if (!encode) {
         GValue arr = { 0, };
@@ -1012,43 +1034,46 @@ gst_ffmpeg_codecid_to_caps (enum CodecID codec_id,
       break;
     }
     case CODEC_ID_AAC_LATM:    /* LATM/LOAS AAC syntax */
-      caps = gst_ff_aud_caps_new (context, codec_id, "audio/mpeg",
+      caps = gst_ff_aud_caps_new (context, codec_id, encode, "audio/mpeg",
           "mpegversion", G_TYPE_INT, 4, "stream-format", G_TYPE_STRING, "loas",
           NULL);
       break;
 
     case CODEC_ID_ASV1:
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-asus",
+      caps = gst_ff_vid_caps_new (context, codec_id, encode, "video/x-asus",
           "asusversion", G_TYPE_INT, 1, NULL);
       break;
     case CODEC_ID_ASV2:
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-asus",
+      caps = gst_ff_vid_caps_new (context, codec_id, encode, "video/x-asus",
           "asusversion", G_TYPE_INT, 2, NULL);
       break;
 
     case CODEC_ID_FFV1:
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-ffv",
+      caps = gst_ff_vid_caps_new (context, codec_id, encode, "video/x-ffv",
           "ffvversion", G_TYPE_INT, 1, NULL);
       break;
 
     case CODEC_ID_4XM:
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-4xm", NULL);
+      caps =
+          gst_ff_vid_caps_new (context, codec_id, encode, "video/x-4xm", NULL);
       break;
 
     case CODEC_ID_XAN_WC3:
     case CODEC_ID_XAN_WC4:
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-xan",
+      caps = gst_ff_vid_caps_new (context, codec_id, encode, "video/x-xan",
           "wcversion", G_TYPE_INT, 3 - CODEC_ID_XAN_WC3 + codec_id, NULL);
       break;
 
     case CODEC_ID_CLJR:
       caps =
-          gst_ff_vid_caps_new (context, codec_id,
+          gst_ff_vid_caps_new (context, codec_id, encode,
           "video/x-cirrus-logic-accupak", NULL);
       break;
 
     case CODEC_ID_FRAPS:
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-fraps", NULL);
+      caps =
+          gst_ff_vid_caps_new (context, codec_id, encode, "video/x-fraps",
+          NULL);
       break;
 
     case CODEC_ID_MDEC:
@@ -1058,23 +1083,26 @@ gst_ffmpeg_codecid_to_caps (enum CodecID codec_id,
       break;
 
     case CODEC_ID_VCR1:
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-ati-vcr",
+      caps = gst_ff_vid_caps_new (context, codec_id, encode, "video/x-ati-vcr",
           "vcrversion", G_TYPE_INT, 1, NULL);
       break;
 
     case CODEC_ID_RPZA:
       caps =
-          gst_ff_vid_caps_new (context, codec_id, "video/x-apple-video", NULL);
+          gst_ff_vid_caps_new (context, codec_id, encode, "video/x-apple-video",
+          NULL);
       break;
 
     case CODEC_ID_CINEPAK:
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-cinepak", NULL);
+      caps =
+          gst_ff_vid_caps_new (context, codec_id, encode, "video/x-cinepak",
+          NULL);
       break;
 
       /* WS_VQA belogns here (order) */
 
     case CODEC_ID_MSRLE:
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-rle",
+      caps = gst_ff_vid_caps_new (context, codec_id, encode, "video/x-rle",
           "layout", G_TYPE_STRING, "microsoft", NULL);
       if (context) {
         gst_caps_set_simple (caps,
@@ -1085,7 +1113,7 @@ gst_ffmpeg_codecid_to_caps (enum CodecID codec_id,
       break;
 
     case CODEC_ID_QTRLE:
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-rle",
+      caps = gst_ff_vid_caps_new (context, codec_id, encode, "video/x-rle",
           "layout", G_TYPE_STRING, "quicktime", NULL);
       if (context) {
         gst_caps_set_simple (caps,
@@ -1096,47 +1124,56 @@ gst_ffmpeg_codecid_to_caps (enum CodecID codec_id,
       break;
 
     case CODEC_ID_MSVIDEO1:
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-msvideocodec",
-          "msvideoversion", G_TYPE_INT, 1, NULL);
+      caps =
+          gst_ff_vid_caps_new (context, codec_id, encode,
+          "video/x-msvideocodec", "msvideoversion", G_TYPE_INT, 1, NULL);
       break;
 
     case CODEC_ID_WMV3:
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-wmv",
+      caps = gst_ff_vid_caps_new (context, codec_id, encode, "video/x-wmv",
           "wmvversion", G_TYPE_INT, 3, NULL);
       break;
     case CODEC_ID_VC1:
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-wmv",
+      caps = gst_ff_vid_caps_new (context, codec_id, encode, "video/x-wmv",
           "wmvversion", G_TYPE_INT, 3, "format", GST_TYPE_FOURCC,
           GST_MAKE_FOURCC ('W', 'V', 'C', '1'), NULL);
       break;
     case CODEC_ID_QDM2:
-      caps = gst_ff_aud_caps_new (context, codec_id, "audio/x-qdm2", NULL);
+      caps =
+          gst_ff_aud_caps_new (context, codec_id, encode, "audio/x-qdm2", NULL);
       break;
 
     case CODEC_ID_MSZH:
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-mszh", NULL);
+      caps =
+          gst_ff_vid_caps_new (context, codec_id, encode, "video/x-mszh", NULL);
       break;
 
     case CODEC_ID_ZLIB:
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-zlib", NULL);
+      caps =
+          gst_ff_vid_caps_new (context, codec_id, encode, "video/x-zlib", NULL);
       break;
 
     case CODEC_ID_TRUEMOTION1:
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-truemotion",
+      caps =
+          gst_ff_vid_caps_new (context, codec_id, encode, "video/x-truemotion",
           "trueversion", G_TYPE_INT, 1, NULL);
       break;
     case CODEC_ID_TRUEMOTION2:
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-truemotion",
+      caps =
+          gst_ff_vid_caps_new (context, codec_id, encode, "video/x-truemotion",
           "trueversion", G_TYPE_INT, 2, NULL);
       break;
 
     case CODEC_ID_ULTI:
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-ultimotion",
+      caps =
+          gst_ff_vid_caps_new (context, codec_id, encode, "video/x-ultimotion",
           NULL);
       break;
 
     case CODEC_ID_TSCC:
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-camtasia", NULL);
+      caps =
+          gst_ff_vid_caps_new (context, codec_id, encode, "video/x-camtasia",
+          NULL);
       if (context) {
         gst_caps_set_simple (caps,
             "depth", G_TYPE_INT, (gint) context->bits_per_coded_sample, NULL);
@@ -1146,113 +1183,143 @@ gst_ffmpeg_codecid_to_caps (enum CodecID codec_id,
       break;
 
     case CODEC_ID_KMVC:
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-kmvc", NULL);
+      caps =
+          gst_ff_vid_caps_new (context, codec_id, encode, "video/x-kmvc", NULL);
       break;
 
     case CODEC_ID_NUV:
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-nuv", NULL);
+      caps =
+          gst_ff_vid_caps_new (context, codec_id, encode, "video/x-nuv", NULL);
       break;
 
     case CODEC_ID_GIF:
-      caps = gst_ff_vid_caps_new (context, codec_id, "image/gif", NULL);
+      caps = gst_ff_vid_caps_new (context, codec_id, encode, "image/gif", NULL);
       break;
 
     case CODEC_ID_PNG:
-      caps = gst_ff_vid_caps_new (context, codec_id, "image/png", NULL);
+      caps = gst_ff_vid_caps_new (context, codec_id, encode, "image/png", NULL);
       break;
 
     case CODEC_ID_PPM:
-      caps = gst_ff_vid_caps_new (context, codec_id, "image/ppm", NULL);
+      caps = gst_ff_vid_caps_new (context, codec_id, encode, "image/ppm", NULL);
       break;
 
     case CODEC_ID_PBM:
-      caps = gst_ff_vid_caps_new (context, codec_id, "image/pbm", NULL);
+      caps = gst_ff_vid_caps_new (context, codec_id, encode, "image/pbm", NULL);
       break;
 
     case CODEC_ID_PAM:
       caps =
-          gst_ff_vid_caps_new (context, codec_id, "image/x-portable-anymap",
-          NULL);
+          gst_ff_vid_caps_new (context, codec_id, encode,
+          "image/x-portable-anymap", NULL);
       break;
 
     case CODEC_ID_PGM:
       caps =
-          gst_ff_vid_caps_new (context, codec_id, "image/x-portable-graymap",
-          NULL);
+          gst_ff_vid_caps_new (context, codec_id, encode,
+          "image/x-portable-graymap", NULL);
       break;
 
     case CODEC_ID_PCX:
-      caps = gst_ff_vid_caps_new (context, codec_id, "image/x-pcx", NULL);
+      caps =
+          gst_ff_vid_caps_new (context, codec_id, encode, "image/x-pcx", NULL);
       break;
 
     case CODEC_ID_SGI:
-      caps = gst_ff_vid_caps_new (context, codec_id, "image/x-sgi", NULL);
+      caps =
+          gst_ff_vid_caps_new (context, codec_id, encode, "image/x-sgi", NULL);
       break;
 
     case CODEC_ID_TARGA:
-      caps = gst_ff_vid_caps_new (context, codec_id, "image/x-tga", NULL);
+      caps =
+          gst_ff_vid_caps_new (context, codec_id, encode, "image/x-tga", NULL);
       break;
 
     case CODEC_ID_TIFF:
-      caps = gst_ff_vid_caps_new (context, codec_id, "image/tiff", NULL);
+      caps =
+          gst_ff_vid_caps_new (context, codec_id, encode, "image/tiff", NULL);
       break;
 
     case CODEC_ID_SUNRAST:
       caps =
-          gst_ff_vid_caps_new (context, codec_id, "image/x-sun-raster", NULL);
+          gst_ff_vid_caps_new (context, codec_id, encode, "image/x-sun-raster",
+          NULL);
       break;
 
     case CODEC_ID_SMC:
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-smc", NULL);
+      caps =
+          gst_ff_vid_caps_new (context, codec_id, encode, "video/x-smc", NULL);
       break;
 
     case CODEC_ID_QDRAW:
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-qdrw", NULL);
+      caps =
+          gst_ff_vid_caps_new (context, codec_id, encode, "video/x-qdrw", NULL);
       break;
 
     case CODEC_ID_DNXHD:
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-dnxhd", NULL);
+      caps =
+          gst_ff_vid_caps_new (context, codec_id, encode, "video/x-dnxhd",
+          NULL);
+      break;
+
+    case CODEC_ID_PRORES:
+      caps =
+          gst_ff_vid_caps_new (context, codec_id, encode, "video/x-prores",
+          NULL);
       break;
 
     case CODEC_ID_MIMIC:
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-mimic", NULL);
+      caps =
+          gst_ff_vid_caps_new (context, codec_id, encode, "video/x-mimic",
+          NULL);
       break;
 
     case CODEC_ID_VMNC:
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-vmnc", NULL);
+      caps =
+          gst_ff_vid_caps_new (context, codec_id, encode, "video/x-vmnc", NULL);
       break;
 
     case CODEC_ID_TRUESPEECH:
       caps =
-          gst_ff_aud_caps_new (context, codec_id, "audio/x-truespeech", NULL);
+          gst_ff_aud_caps_new (context, codec_id, encode, "audio/x-truespeech",
+          NULL);
       break;
 
     case CODEC_ID_QCELP:
-      caps = gst_ff_aud_caps_new (context, codec_id, "audio/qcelp", NULL);
+      caps =
+          gst_ff_aud_caps_new (context, codec_id, encode, "audio/qcelp", NULL);
       break;
 
     case CODEC_ID_AMV:
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-amv", NULL);
+      caps =
+          gst_ff_vid_caps_new (context, codec_id, encode, "video/x-amv", NULL);
       break;
 
     case CODEC_ID_AASC:
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-aasc", NULL);
+      caps =
+          gst_ff_vid_caps_new (context, codec_id, encode, "video/x-aasc", NULL);
       break;
 
     case CODEC_ID_LOCO:
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-loco", NULL);
+      caps =
+          gst_ff_vid_caps_new (context, codec_id, encode, "video/x-loco", NULL);
       break;
 
     case CODEC_ID_ZMBV:
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-zmbv", NULL);
+      caps =
+          gst_ff_vid_caps_new (context, codec_id, encode, "video/x-zmbv", NULL);
       break;
 
     case CODEC_ID_LAGARITH:
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-lagarith", NULL);
+      caps =
+          gst_ff_vid_caps_new (context, codec_id, encode, "video/x-lagarith",
+          NULL);
       break;
 
     case CODEC_ID_CSCD:
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-camstudio", NULL);
+      caps =
+          gst_ff_vid_caps_new (context, codec_id, encode, "video/x-camstudio",
+          NULL);
       if (context) {
         gst_caps_set_simple (caps,
             "depth", G_TYPE_INT, (gint) context->bits_per_coded_sample, NULL);
@@ -1337,7 +1404,7 @@ gst_ffmpeg_codecid_to_caps (enum CodecID codec_id,
           break;
       }
 
-      caps = gst_ff_aud_caps_new (context, codec_id, "audio/x-raw-int",
+      caps = gst_ff_aud_caps_new (context, codec_id, encode, "audio/x-raw-int",
           "width", G_TYPE_INT, width,
           "depth", G_TYPE_INT, depth,
           "endianness", G_TYPE_INT, endianness,
@@ -1346,15 +1413,19 @@ gst_ffmpeg_codecid_to_caps (enum CodecID codec_id,
       break;
 
     case CODEC_ID_PCM_MULAW:
-      caps = gst_ff_aud_caps_new (context, codec_id, "audio/x-mulaw", NULL);
+      caps =
+          gst_ff_aud_caps_new (context, codec_id, encode, "audio/x-mulaw",
+          NULL);
       break;
 
     case CODEC_ID_PCM_ALAW:
-      caps = gst_ff_aud_caps_new (context, codec_id, "audio/x-alaw", NULL);
+      caps =
+          gst_ff_aud_caps_new (context, codec_id, encode, "audio/x-alaw", NULL);
       break;
 
     case CODEC_ID_ADPCM_G722:
-      caps = gst_ff_aud_caps_new (context, codec_id, "audio/G722", NULL);
+      caps =
+          gst_ff_aud_caps_new (context, codec_id, encode, "audio/G722", NULL);
       if (context)
         gst_caps_set_simple (caps,
             "block_align", G_TYPE_INT, context->block_align,
@@ -1364,7 +1435,7 @@ gst_ffmpeg_codecid_to_caps (enum CodecID codec_id,
     case CODEC_ID_ADPCM_G726:
     {
       /* the G726 decoder can also handle G721 */
-      caps = gst_ff_aud_caps_new (context, codec_id, "audio/x-adpcm",
+      caps = gst_ff_aud_caps_new (context, codec_id, encode, "audio/x-adpcm",
           "layout", G_TYPE_STRING, "g726", NULL);
       if (context)
         gst_caps_set_simple (caps,
@@ -1497,7 +1568,7 @@ gst_ffmpeg_codecid_to_caps (enum CodecID codec_id,
 
       /* FIXME: someone please check whether we need additional properties
        * in this caps definition. */
-      caps = gst_ff_aud_caps_new (context, codec_id, "audio/x-adpcm",
+      caps = gst_ff_aud_caps_new (context, codec_id, encode, "audio/x-adpcm",
           "layout", G_TYPE_STRING, layout, NULL);
       if (context)
         gst_caps_set_simple (caps,
@@ -1507,29 +1578,35 @@ gst_ffmpeg_codecid_to_caps (enum CodecID codec_id,
       break;
 
     case CODEC_ID_AMR_NB:
-      caps = gst_ff_aud_caps_new (context, codec_id, "audio/AMR", NULL);
+      caps = gst_ff_aud_caps_new (context, codec_id, encode, "audio/AMR", NULL);
       break;
 
     case CODEC_ID_AMR_WB:
-      caps = gst_ff_aud_caps_new (context, codec_id, "audio/AMR-WB", NULL);
+      caps =
+          gst_ff_aud_caps_new (context, codec_id, encode, "audio/AMR-WB", NULL);
       break;
 
     case CODEC_ID_GSM:
-      caps = gst_ff_aud_caps_new (context, codec_id, "audio/x-gsm", NULL);
+      caps =
+          gst_ff_aud_caps_new (context, codec_id, encode, "audio/x-gsm", NULL);
       break;
 
     case CODEC_ID_GSM_MS:
-      caps = gst_ff_aud_caps_new (context, codec_id, "audio/ms-gsm", NULL);
+      caps =
+          gst_ff_aud_caps_new (context, codec_id, encode, "audio/ms-gsm", NULL);
       break;
 
     case CODEC_ID_NELLYMOSER:
       caps =
-          gst_ff_aud_caps_new (context, codec_id, "audio/x-nellymoser", NULL);
+          gst_ff_aud_caps_new (context, codec_id, encode, "audio/x-nellymoser",
+          NULL);
       break;
 
     case CODEC_ID_SIPR:
     {
-      caps = gst_ff_aud_caps_new (context, codec_id, "audio/x-sipro", NULL);
+      caps =
+          gst_ff_aud_caps_new (context, codec_id, encode, "audio/x-sipro",
+          NULL);
       if (context) {
         gst_caps_set_simple (caps,
             "leaf_size", G_TYPE_INT, context->block_align,
@@ -1559,8 +1636,9 @@ gst_ffmpeg_codecid_to_caps (enum CodecID codec_id,
       }
 
       /* FIXME: properties? */
-      caps = gst_ff_aud_caps_new (context, codec_id, "audio/x-pn-realaudio",
-          "raversion", G_TYPE_INT, version, NULL);
+      caps =
+          gst_ff_aud_caps_new (context, codec_id, encode,
+          "audio/x-pn-realaudio", "raversion", G_TYPE_INT, version, NULL);
       if (context) {
         gst_caps_set_simple (caps,
             "leaf_size", G_TYPE_INT, context->block_align,
@@ -1596,7 +1674,7 @@ gst_ffmpeg_codecid_to_caps (enum CodecID codec_id,
 
       /* FIXME: someone please check whether we need additional properties
        * in this caps definition. */
-      caps = gst_ff_aud_caps_new (context, codec_id, "audio/x-dpcm",
+      caps = gst_ff_aud_caps_new (context, codec_id, encode, "audio/x-dpcm",
           "layout", G_TYPE_STRING, layout, NULL);
       if (context)
         gst_caps_set_simple (caps,
@@ -1610,7 +1688,8 @@ gst_ffmpeg_codecid_to_caps (enum CodecID codec_id,
       break;
 
     case CODEC_ID_ALAC:
-      caps = gst_ff_aud_caps_new (context, codec_id, "audio/x-alac", NULL);
+      caps =
+          gst_ff_aud_caps_new (context, codec_id, encode, "audio/x-alac", NULL);
       if (context) {
         gst_caps_set_simple (caps,
             "samplesize", G_TYPE_INT, context->bits_per_coded_sample, NULL);
@@ -1633,14 +1712,17 @@ gst_ffmpeg_codecid_to_caps (enum CodecID codec_id,
       caps = gst_caps_new_simple ("image/bmp", NULL);
       break;
     case CODEC_ID_TTA:
-      caps = gst_ff_aud_caps_new (context, codec_id, "audio/x-tta", NULL);
+      caps =
+          gst_ff_aud_caps_new (context, codec_id, encode, "audio/x-tta", NULL);
       if (context) {
         gst_caps_set_simple (caps,
             "samplesize", G_TYPE_INT, context->bits_per_coded_sample, NULL);
       }
       break;
     case CODEC_ID_TWINVQ:
-      caps = gst_ff_aud_caps_new (context, codec_id, "audio/x-twin-vq", NULL);
+      caps =
+          gst_ff_aud_caps_new (context, codec_id, encode, "audio/x-twin-vq",
+          NULL);
       break;
     default:
       GST_DEBUG ("Unknown codec ID %d, please add mapping here", codec_id);
@@ -1659,12 +1741,12 @@ gst_ffmpeg_codecid_to_caps (enum CodecID codec_id,
       switch (codec->type) {
         case AVMEDIA_TYPE_VIDEO:
           mime = g_strdup_printf ("video/x-gst_ff-%s", codec->name);
-          caps = gst_ff_vid_caps_new (context, codec_id, mime, NULL);
+          caps = gst_ff_vid_caps_new (context, codec_id, encode, mime, NULL);
           g_free (mime);
           break;
         case AVMEDIA_TYPE_AUDIO:
           mime = g_strdup_printf ("audio/x-gst_ff-%s", codec->name);
-          caps = gst_ff_aud_caps_new (context, codec_id, mime, NULL);
+          caps = gst_ff_aud_caps_new (context, codec_id, encode, mime, NULL);
           if (context)
             gst_caps_set_simple (caps,
                 "block_align", G_TYPE_INT, context->block_align,
@@ -1712,7 +1794,7 @@ gst_ffmpeg_codecid_to_caps (enum CodecID codec_id,
 
 GstCaps *
 gst_ffmpeg_pixfmt_to_caps (enum PixelFormat pix_fmt, AVCodecContext * context,
-    enum CodecID codec_id)
+    enum CodecID codec_id, gboolean encode)
 {
   GstCaps *caps = NULL;
 
@@ -1796,7 +1878,7 @@ gst_ffmpeg_pixfmt_to_caps (enum PixelFormat pix_fmt, AVCodecContext * context,
       break;
     case PIX_FMT_GRAY8:
       bpp = depth = 8;
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-raw-gray",
+      caps = gst_ff_vid_caps_new (context, codec_id, encode, "video/x-raw-gray",
           "bpp", G_TYPE_INT, bpp, "depth", G_TYPE_INT, depth, NULL);
       break;
     default:
@@ -1808,34 +1890,30 @@ gst_ffmpeg_pixfmt_to_caps (enum PixelFormat pix_fmt, AVCodecContext * context,
     if (bpp != 0) {
       if (r_mask != 0) {
         if (a_mask) {
-          caps = gst_ff_vid_caps_new (context, codec_id, "video/x-raw-rgb",
-              "bpp", G_TYPE_INT, bpp,
-              "depth", G_TYPE_INT, depth,
-              "red_mask", G_TYPE_INT, r_mask,
-              "green_mask", G_TYPE_INT, g_mask,
-              "blue_mask", G_TYPE_INT, b_mask,
-              "alpha_mask", G_TYPE_INT, a_mask,
+          caps =
+              gst_ff_vid_caps_new (context, codec_id, encode, "video/x-raw-rgb",
+              "bpp", G_TYPE_INT, bpp, "depth", G_TYPE_INT, depth, "red_mask",
+              G_TYPE_INT, r_mask, "green_mask", G_TYPE_INT, g_mask, "blue_mask",
+              G_TYPE_INT, b_mask, "alpha_mask", G_TYPE_INT, a_mask,
               "endianness", G_TYPE_INT, endianness, NULL);
         } else {
-          caps = gst_ff_vid_caps_new (context, codec_id, "video/x-raw-rgb",
-              "bpp", G_TYPE_INT, bpp,
-              "depth", G_TYPE_INT, depth,
-              "red_mask", G_TYPE_INT, r_mask,
-              "green_mask", G_TYPE_INT, g_mask,
-              "blue_mask", G_TYPE_INT, b_mask,
-              "endianness", G_TYPE_INT, endianness, NULL);
+          caps =
+              gst_ff_vid_caps_new (context, codec_id, encode, "video/x-raw-rgb",
+              "bpp", G_TYPE_INT, bpp, "depth", G_TYPE_INT, depth, "red_mask",
+              G_TYPE_INT, r_mask, "green_mask", G_TYPE_INT, g_mask, "blue_mask",
+              G_TYPE_INT, b_mask, "endianness", G_TYPE_INT, endianness, NULL);
         }
       } else {
-        caps = gst_ff_vid_caps_new (context, codec_id, "video/x-raw-rgb",
-            "bpp", G_TYPE_INT, bpp,
-            "depth", G_TYPE_INT, depth,
-            "endianness", G_TYPE_INT, endianness, NULL);
+        caps =
+            gst_ff_vid_caps_new (context, codec_id, encode, "video/x-raw-rgb",
+            "bpp", G_TYPE_INT, bpp, "depth", G_TYPE_INT, depth, "endianness",
+            G_TYPE_INT, endianness, NULL);
         if (caps && context) {
           gst_ffmpeg_set_palette (caps, context);
         }
       }
     } else if (fmt) {
-      caps = gst_ff_vid_caps_new (context, codec_id, "video/x-raw-yuv",
+      caps = gst_ff_vid_caps_new (context, codec_id, encode, "video/x-raw-yuv",
           "format", GST_TYPE_FOURCC, fmt, NULL);
     }
   }
@@ -1858,7 +1936,7 @@ gst_ffmpeg_pixfmt_to_caps (enum PixelFormat pix_fmt, AVCodecContext * context,
 
 static GstCaps *
 gst_ffmpeg_smpfmt_to_caps (enum SampleFormat sample_fmt,
-    AVCodecContext * context, enum CodecID codec_id)
+    AVCodecContext * context, enum CodecID codec_id, gboolean encode)
 {
   GstCaps *caps = NULL;
 
@@ -1893,14 +1971,15 @@ gst_ffmpeg_smpfmt_to_caps (enum SampleFormat sample_fmt,
 
   if (bpp) {
     if (integer) {
-      caps = gst_ff_aud_caps_new (context, codec_id, "audio/x-raw-int",
+      caps = gst_ff_aud_caps_new (context, codec_id, encode, "audio/x-raw-int",
           "signed", G_TYPE_BOOLEAN, signedness,
           "endianness", G_TYPE_INT, G_BYTE_ORDER,
           "width", G_TYPE_INT, bpp, "depth", G_TYPE_INT, bpp, NULL);
     } else {
-      caps = gst_ff_aud_caps_new (context, codec_id, "audio/x-raw-float",
-          "endianness", G_TYPE_INT, G_BYTE_ORDER,
-          "width", G_TYPE_INT, bpp, NULL);
+      caps =
+          gst_ff_aud_caps_new (context, codec_id, encode, "audio/x-raw-float",
+          "endianness", G_TYPE_INT, G_BYTE_ORDER, "width", G_TYPE_INT, bpp,
+          NULL);
     }
   }
 
@@ -1927,7 +2006,9 @@ gst_ffmpeg_codectype_to_audio_caps (AVCodecContext * context,
 
   if (context) {
     /* Specific codec context */
-    caps = gst_ffmpeg_smpfmt_to_caps (context->sample_fmt, context, codec_id);
+    caps =
+        gst_ffmpeg_smpfmt_to_caps (context->sample_fmt, context, codec_id,
+        encode);
   } else if (codec && codec->sample_fmts) {
     GstCaps *temp;
     int i;
@@ -1935,7 +2016,8 @@ gst_ffmpeg_codectype_to_audio_caps (AVCodecContext * context,
     caps = gst_caps_new_empty ();
     for (i = 0; codec->sample_fmts[i] != -1; i++) {
       temp =
-          gst_ffmpeg_smpfmt_to_caps (codec->sample_fmts[i], context, codec_id);
+          gst_ffmpeg_smpfmt_to_caps (codec->sample_fmts[i], context, codec_id,
+          encode);
       if (temp != NULL)
         gst_caps_append (caps, temp);
     }
@@ -1947,7 +2029,8 @@ gst_ffmpeg_codectype_to_audio_caps (AVCodecContext * context,
     ctx.channels = -1;
     caps = gst_caps_new_empty ();
     for (i = 0; i <= SAMPLE_FMT_DBL; i++) {
-      temp = gst_ffmpeg_smpfmt_to_caps (i, encode ? &ctx : NULL, codec_id);
+      temp =
+          gst_ffmpeg_smpfmt_to_caps (i, encode ? &ctx : NULL, codec_id, encode);
       if (temp != NULL) {
         gst_caps_append (caps, temp);
       }
@@ -1966,7 +2049,8 @@ gst_ffmpeg_codectype_to_video_caps (AVCodecContext * context,
       context, codec_id, encode, codec);
 
   if (context) {
-    caps = gst_ffmpeg_pixfmt_to_caps (context->pix_fmt, context, codec_id);
+    caps =
+        gst_ffmpeg_pixfmt_to_caps (context->pix_fmt, context, codec_id, encode);
   } else {
     GstCaps *temp;
     enum PixelFormat i;
@@ -1976,7 +2060,8 @@ gst_ffmpeg_codectype_to_video_caps (AVCodecContext * context,
     for (i = 0; i < PIX_FMT_NB; i++) {
       ctx.width = -1;
       ctx.pix_fmt = i;
-      temp = gst_ffmpeg_pixfmt_to_caps (i, encode ? &ctx : NULL, codec_id);
+      temp =
+          gst_ffmpeg_pixfmt_to_caps (i, encode ? &ctx : NULL, codec_id, encode);
       if (temp != NULL) {
         gst_caps_append (caps, temp);
       }
@@ -2208,6 +2293,135 @@ gst_ffmpeg_caps_to_pixfmt (const GstCaps * caps,
   }
 }
 
+typedef struct
+{
+  GstVideoFormat format;
+  enum PixelFormat pixfmt;
+} PixToFmt;
+
+/* FIXME : FILLME */
+static const PixToFmt pixtofmttable[] = {
+  /* GST_VIDEO_FORMAT_I420, */
+  {GST_VIDEO_FORMAT_I420, PIX_FMT_YUV420P},
+  /* Note : this should use a different chroma placement */
+  {GST_VIDEO_FORMAT_I420, PIX_FMT_YUVJ420P},
+
+  /* GST_VIDEO_FORMAT_YV12, */
+  /* GST_VIDEO_FORMAT_YUY2, */
+  {GST_VIDEO_FORMAT_YUY2, PIX_FMT_YUYV422},
+  /* GST_VIDEO_FORMAT_UYVY, */
+  {GST_VIDEO_FORMAT_UYVY, PIX_FMT_UYVY422},
+  /* GST_VIDEO_FORMAT_AYUV, */
+  /* GST_VIDEO_FORMAT_RGBx, */
+  /* GST_VIDEO_FORMAT_BGRx, */
+  /* GST_VIDEO_FORMAT_xRGB, */
+  /* GST_VIDEO_FORMAT_xBGR, */
+  /* GST_VIDEO_FORMAT_RGBA, */
+  {GST_VIDEO_FORMAT_RGBA, PIX_FMT_RGB32},
+  /* GST_VIDEO_FORMAT_BGRA, */
+  {GST_VIDEO_FORMAT_BGRA, PIX_FMT_BGR32},
+  /* GST_VIDEO_FORMAT_ARGB, */
+  /* GST_VIDEO_FORMAT_ABGR, */
+  /* GST_VIDEO_FORMAT_RGB, */
+  {GST_VIDEO_FORMAT_RGB, PIX_FMT_RGB24},
+  /* GST_VIDEO_FORMAT_BGR, */
+  {GST_VIDEO_FORMAT_BGR, PIX_FMT_BGR24},
+  /* GST_VIDEO_FORMAT_Y41B, */
+  {GST_VIDEO_FORMAT_Y41B, PIX_FMT_YUV411P},
+  /* GST_VIDEO_FORMAT_Y42B, */
+  {GST_VIDEO_FORMAT_Y42B, PIX_FMT_YUV422P},
+  {GST_VIDEO_FORMAT_Y42B, PIX_FMT_YUVJ422P},
+  /* GST_VIDEO_FORMAT_YVYU, */
+  /* GST_VIDEO_FORMAT_Y444, */
+  {GST_VIDEO_FORMAT_Y444, PIX_FMT_YUV444P},
+  {GST_VIDEO_FORMAT_Y444, PIX_FMT_YUVJ444P},
+  /* GST_VIDEO_FORMAT_v210, */
+  /* GST_VIDEO_FORMAT_v216, */
+  /* GST_VIDEO_FORMAT_NV12, */
+  {GST_VIDEO_FORMAT_NV12, PIX_FMT_NV12},
+  /* GST_VIDEO_FORMAT_NV21, */
+  {GST_VIDEO_FORMAT_NV21, PIX_FMT_NV21},
+  /* GST_VIDEO_FORMAT_GRAY8, */
+  {GST_VIDEO_FORMAT_GRAY8, PIX_FMT_GRAY8},
+  /* GST_VIDEO_FORMAT_GRAY16_BE, */
+  {GST_VIDEO_FORMAT_GRAY16_BE, PIX_FMT_GRAY16BE},
+  /* GST_VIDEO_FORMAT_GRAY16_LE, */
+  {GST_VIDEO_FORMAT_GRAY16_LE, PIX_FMT_GRAY16LE},
+  /* GST_VIDEO_FORMAT_v308, */
+  /* GST_VIDEO_FORMAT_Y800, */
+  /* GST_VIDEO_FORMAT_Y16, */
+  /* GST_VIDEO_FORMAT_RGB16, */
+  {GST_VIDEO_FORMAT_RGB16, PIX_FMT_RGB565},
+  /* GST_VIDEO_FORMAT_BGR16, */
+  /* GST_VIDEO_FORMAT_RGB15, */
+  {GST_VIDEO_FORMAT_RGB15, PIX_FMT_RGB555},
+  /* GST_VIDEO_FORMAT_BGR15, */
+  /* GST_VIDEO_FORMAT_UYVP, */
+  /* GST_VIDEO_FORMAT_A420, */
+  {GST_VIDEO_FORMAT_A420, PIX_FMT_YUVA420P},
+  /* GST_VIDEO_FORMAT_RGB8_PALETTED, */
+  {GST_VIDEO_FORMAT_RGB8_PALETTED, PIX_FMT_PAL8},
+  /* GST_VIDEO_FORMAT_YUV9, */
+  /* GST_VIDEO_FORMAT_YVU9, */
+  /* GST_VIDEO_FORMAT_IYU1, */
+  /* GST_VIDEO_FORMAT_ARGB64, */
+  /* GST_VIDEO_FORMAT_AYUV64, */
+  /* GST_VIDEO_FORMAT_r210, */
+  /* GST_VIDEO_FORMAT_ENCODED, */
+  {GST_VIDEO_FORMAT_I420_10BE, PIX_FMT_YUV420P10BE},
+  {GST_VIDEO_FORMAT_I420_10LE, PIX_FMT_YUV420P10LE},
+  {GST_VIDEO_FORMAT_I422_10BE, PIX_FMT_YUV422P10BE},
+  {GST_VIDEO_FORMAT_I422_10LE, PIX_FMT_YUV422P10LE},
+  {GST_VIDEO_FORMAT_Y444_10BE, PIX_FMT_YUV444P10BE},
+  {GST_VIDEO_FORMAT_Y444_10LE, PIX_FMT_YUV444P10LE}
+};
+
+GstVideoFormat
+gst_ffmpeg_pixfmt_to_videoformat (enum PixelFormat pixfmt)
+{
+  guint i;
+
+  for (i = 0; i < G_N_ELEMENTS (pixtofmttable); i++)
+    if (pixtofmttable[i].pixfmt == pixfmt)
+      return pixtofmttable[i].format;
+
+  GST_WARNING ("Unknown pixel format %d", pixfmt);
+  return GST_VIDEO_FORMAT_UNKNOWN;
+}
+
+enum PixelFormat
+gst_ffmpeg_videoformat_to_pixfmt (GstVideoFormat format)
+{
+  guint i;
+
+  for (i = 0; i < G_N_ELEMENTS (pixtofmttable); i++)
+    if (pixtofmttable[i].format == format)
+      return pixtofmttable[i].pixfmt;
+  return PIX_FMT_NONE;
+}
+
+void
+gst_ffmpeg_videoinfo_to_context (GstVideoInfo * info, AVCodecContext * context)
+{
+  gint i, bpp = 0;
+
+  context->width = GST_VIDEO_INFO_WIDTH (info);
+  context->height = GST_VIDEO_INFO_HEIGHT (info);
+  for (i = 0; i < GST_VIDEO_INFO_N_COMPONENTS (info); i++)
+    bpp += GST_VIDEO_INFO_COMP_DEPTH (info, i);
+  context->bits_per_coded_sample = bpp;
+
+  context->ticks_per_frame = 1;
+  context->time_base.den = GST_VIDEO_INFO_FPS_N (info);
+  context->time_base.num = GST_VIDEO_INFO_FPS_D (info);
+
+  context->sample_aspect_ratio.num = GST_VIDEO_INFO_PAR_N (info);
+  context->sample_aspect_ratio.den = GST_VIDEO_INFO_PAR_D (info);
+
+  context->pix_fmt =
+      gst_ffmpeg_videoformat_to_pixfmt (GST_VIDEO_INFO_FORMAT (info));
+}
+
 /* Convert a GstCaps and a FFMPEG codec Type to a
  * AVCodecContext. If the context is ommitted, no fixed values
  * for video/audio size will be included in the context
@@ -2899,7 +3113,8 @@ gst_ffmpeg_caps_to_codecid (const GstCaps * caps, AVCodecContext * context)
     if (gst_structure_get_int (structure, "endianness", &endianness) &&
         gst_structure_get_boolean (structure, "signed", &signedness) &&
         gst_structure_get_int (structure, "width", &width) &&
-        gst_structure_get_int (structure, "depth", &depth) && depth == width) {
+        gst_structure_get_int (structure, "depth", &depth)
+        && depth == width) {
       switch (depth) {
         case 8:
           if (signedness) {
@@ -3181,6 +3396,9 @@ gst_ffmpeg_caps_to_codecid (const GstCaps * caps, AVCodecContext * context)
         case 5:
           id = CODEC_ID_INDEO5;
           break;
+        case 4:
+          id = CODEC_ID_INDEO4;
+          break;
         case 3:
           id = CODEC_ID_INDEO3;
           break;
diff --git a/ext/ffmpeg/gstffmpegcodecmap.h b/ext/ffmpeg/gstffmpegcodecmap.h
index d3d6170..d8df42b 100644
--- a/ext/ffmpeg/gstffmpegcodecmap.h
+++ b/ext/ffmpeg/gstffmpegcodecmap.h
@@ -27,6 +27,7 @@
 #endif
 #include <gst/gst.h>
 
+#include <gst/video/video.h>
 #include <gst/audio/multichannel.h>
 
 /*
@@ -91,6 +92,13 @@ gst_ffmpeg_caps_with_codectype (enum AVMediaType  type,
                                 const GstCaps  *caps,
                                 AVCodecContext *context);
 
+void
+gst_ffmpeg_videoinfo_to_context (GstVideoInfo *info,
+				 AVCodecContext *context);
+
+GstVideoFormat gst_ffmpeg_pixfmt_to_videoformat (enum PixelFormat pixfmt);
+enum PixelFormat gst_ffmpeg_videoformat_to_pixfmt (GstVideoFormat format);
+
 /*
  * _formatid_to_caps () is meant for muxers/demuxers, it
  * transforms a name (ffmpeg way of ID'ing these, why don't
@@ -109,7 +117,7 @@ gst_ffmpeg_formatid_to_caps (const gchar *format_name);
  */
 
 GstCaps *
-gst_ffmpeg_pixfmt_to_caps (enum PixelFormat pix_fmt, AVCodecContext * context, enum CodecID codec_id);
+gst_ffmpeg_pixfmt_to_caps (enum PixelFormat pix_fmt, AVCodecContext * context, enum CodecID codec_id, gboolean encode);
 
 /*
  * _formatid_get_codecids () can be used to get the codecIDs
diff --git a/ext/ffmpeg/gstffmpegdec.c b/ext/ffmpeg/gstffmpegdec.c
index cc07889..5f4fdbb 100644
--- a/ext/ffmpeg/gstffmpegdec.c
+++ b/ext/ffmpeg/gstffmpegdec.c
@@ -31,7 +31,6 @@
 #endif
 
 #include <gst/gst.h>
-#include <gst/video/video.h>
 
 #include "gstffmpeg.h"
 #include "gstffmpegcodecmap.h"
@@ -40,7 +39,7 @@
 /* define to enable alternative buffer refcounting algorithm */
 #undef EXTRA_REF
 
-typedef struct _GstFFMpegDec GstFFMpegDec;
+typedef struct _GstFFMpegAudDec GstFFMpegAudDec;
 
 #define MAX_TS_MASK 0xff
 
@@ -56,7 +55,7 @@ typedef struct
   gint64 offset;
 } GstTSInfo;
 
-struct _GstFFMpegDec
+struct _GstFFMpegAudDec
 {
   GstElement element;
 
@@ -66,40 +65,20 @@ struct _GstFFMpegDec
 
   /* decoding */
   AVCodecContext *context;
-  AVFrame *picture;
   gboolean opened;
   union
   {
     struct
     {
-      gint width, height;
-      gint clip_width, clip_height;
-      gint par_n, par_d;
-      gint fps_n, fps_d;
-      gint old_fps_n, old_fps_d;
-      gboolean interlaced;
-
-      enum PixelFormat pix_fmt;
-    } video;
-    struct
-    {
       gint channels;
       gint samplerate;
       gint depth;
     } audio;
   } format;
-  gboolean waiting_for_key;
   gboolean discont;
   gboolean clear_ts;
 
   /* for tracking DTS/PTS */
-  gboolean has_b_frames;
-  gboolean reordered_in;
-  GstClockTime last_in;
-  GstClockTime last_diff;
-  guint last_frames;
-  gboolean reordered_out;
-  GstClockTime last_out;
   GstClockTime next_out;
 
   /* parsing */
@@ -107,46 +86,20 @@ struct _GstFFMpegDec
                                  * See bug #566250 */
   AVCodecParserContext *pctx;
   GstBuffer *pcache;
-  guint8 *padded;
-  guint padded_size;
-
-  GValue *par;                  /* pixel aspect ratio of incoming data */
-  gboolean current_dr;          /* if direct rendering is enabled */
-  gboolean extra_ref;           /* keep extra ref around in get/release */
-
-  /* some properties */
-  enum AVDiscard skip_frame;
-  gint lowres;
-  gboolean direct_rendering;
-  gboolean do_padding;
-  gboolean debug_mv;
-  gboolean crop;
-  int max_threads;
-
-  /* QoS stuff *//* with LOCK */
-  gdouble proportion;
-  GstClockTime earliest_time;
-  gint64 processed;
-  gint64 dropped;
 
   /* clipping segment */
   GstSegment segment;
 
-  gboolean is_realvideo;
-
   GstTSInfo ts_info[MAX_TS_MASK + 1];
   gint ts_idx;
 
   /* reverse playback queue */
   GList *queued;
-
-  /* Can downstream allocate 16bytes aligned data. */
-  gboolean can_allocate_aligned;
 };
 
-typedef struct _GstFFMpegDecClass GstFFMpegDecClass;
+typedef struct _GstFFMpegAudDecClass GstFFMpegAudDecClass;
 
-struct _GstFFMpegDecClass
+struct _GstFFMpegAudDecClass
 {
   GstElementClass parent_class;
 
@@ -158,7 +111,7 @@ struct _GstFFMpegDecClass
 static const GstTSInfo ts_info_none = { -1, -1, -1, -1 };
 
 static const GstTSInfo *
-gst_ts_info_store (GstFFMpegDec * dec, GstClockTime timestamp,
+gst_ts_info_store (GstFFMpegAudDec * dec, GstClockTime timestamp,
     GstClockTime duration, gint64 offset)
 {
   gint idx = dec->ts_idx;
@@ -172,7 +125,7 @@ gst_ts_info_store (GstFFMpegDec * dec, GstClockTime timestamp,
 }
 
 static const GstTSInfo *
-gst_ts_info_get (GstFFMpegDec * dec, gint idx)
+gst_ts_info_get (GstFFMpegAudDec * dec, gint idx)
 {
   if (G_UNLIKELY (idx < 0 || idx > MAX_TS_MASK))
     return GST_TS_INFO_NONE;
@@ -181,124 +134,47 @@ gst_ts_info_get (GstFFMpegDec * dec, gint idx)
 }
 
 #define GST_TYPE_FFMPEGDEC \
-  (gst_ffmpegdec_get_type())
+  (gst_ffmpegauddec_get_type())
 #define GST_FFMPEGDEC(obj) \
-  (G_TYPE_CHECK_INSTANCE_CAST((obj),GST_TYPE_FFMPEGDEC,GstFFMpegDec))
-#define GST_FFMPEGDEC_CLASS(klass) \
-  (G_TYPE_CHECK_CLASS_CAST((klass),GST_TYPE_FFMPEGDEC,GstFFMpegDecClass))
+  (G_TYPE_CHECK_INSTANCE_CAST((obj),GST_TYPE_FFMPEGDEC,GstFFMpegAudDec))
+#define GST_FFMPEGAUDDEC_CLASS(klass) \
+  (G_TYPE_CHECK_CLASS_CAST((klass),GST_TYPE_FFMPEGDEC,GstFFMpegAudDecClass))
 #define GST_IS_FFMPEGDEC(obj) \
   (G_TYPE_CHECK_INSTANCE_TYPE((obj),GST_TYPE_FFMPEGDEC))
-#define GST_IS_FFMPEGDEC_CLASS(klass) \
+#define GST_IS_FFMPEGAUDDEC_CLASS(klass) \
   (G_TYPE_CHECK_CLASS_TYPE((klass),GST_TYPE_FFMPEGDEC))
 
-#define DEFAULT_LOWRES			0
-#define DEFAULT_SKIPFRAME		0
-#define DEFAULT_DIRECT_RENDERING	TRUE
-#define DEFAULT_DO_PADDING		TRUE
-#define DEFAULT_DEBUG_MV		FALSE
-#define DEFAULT_CROP			TRUE
-#define DEFAULT_MAX_THREADS		1
-
-enum
-{
-  PROP_0,
-  PROP_LOWRES,
-  PROP_SKIPFRAME,
-  PROP_DIRECT_RENDERING,
-  PROP_DO_PADDING,
-  PROP_DEBUG_MV,
-  PROP_CROP,
-  PROP_MAX_THREADS,
-  PROP_LAST
-};
-
 /* A number of function prototypes are given so we can refer to them later. */
-static void gst_ffmpegdec_base_init (GstFFMpegDecClass * klass);
-static void gst_ffmpegdec_class_init (GstFFMpegDecClass * klass);
-static void gst_ffmpegdec_init (GstFFMpegDec * ffmpegdec);
-static void gst_ffmpegdec_finalize (GObject * object);
+static void gst_ffmpegauddec_base_init (GstFFMpegAudDecClass * klass);
+static void gst_ffmpegauddec_class_init (GstFFMpegAudDecClass * klass);
+static void gst_ffmpegauddec_init (GstFFMpegAudDec * ffmpegdec);
+static void gst_ffmpegauddec_finalize (GObject * object);
 
-static gboolean gst_ffmpegdec_query (GstPad * pad, GstQuery * query);
-static gboolean gst_ffmpegdec_src_event (GstPad * pad, GstEvent * event);
+static gboolean gst_ffmpegauddec_setcaps (GstPad * pad, GstCaps * caps);
+static gboolean gst_ffmpegauddec_sink_event (GstPad * pad, GstEvent * event);
+static GstFlowReturn gst_ffmpegauddec_chain (GstPad * pad, GstBuffer * buf);
 
-static gboolean gst_ffmpegdec_setcaps (GstPad * pad, GstCaps * caps);
-static gboolean gst_ffmpegdec_sink_event (GstPad * pad, GstEvent * event);
-static GstFlowReturn gst_ffmpegdec_chain (GstPad * pad, GstBuffer * buf);
-
-static GstStateChangeReturn gst_ffmpegdec_change_state (GstElement * element,
+static GstStateChangeReturn gst_ffmpegauddec_change_state (GstElement * element,
     GstStateChange transition);
 
-static void gst_ffmpegdec_set_property (GObject * object,
-    guint prop_id, const GValue * value, GParamSpec * pspec);
-static void gst_ffmpegdec_get_property (GObject * object,
-    guint prop_id, GValue * value, GParamSpec * pspec);
-
-static gboolean gst_ffmpegdec_negotiate (GstFFMpegDec * ffmpegdec,
+static gboolean gst_ffmpegauddec_negotiate (GstFFMpegAudDec * ffmpegdec,
     gboolean force);
 
-/* some sort of bufferpool handling, but different */
-static int gst_ffmpegdec_get_buffer (AVCodecContext * context,
-    AVFrame * picture);
-static void gst_ffmpegdec_release_buffer (AVCodecContext * context,
-    AVFrame * picture);
-
-static void gst_ffmpegdec_drain (GstFFMpegDec * ffmpegdec);
+static void gst_ffmpegauddec_drain (GstFFMpegAudDec * ffmpegdec);
 
 #define GST_FFDEC_PARAMS_QDATA g_quark_from_static_string("ffdec-params")
 
 static GstElementClass *parent_class = NULL;
 
-#define GST_FFMPEGDEC_TYPE_LOWRES (gst_ffmpegdec_lowres_get_type())
-static GType
-gst_ffmpegdec_lowres_get_type (void)
-{
-  static GType ffmpegdec_lowres_type = 0;
-
-  if (!ffmpegdec_lowres_type) {
-    static const GEnumValue ffmpegdec_lowres[] = {
-      {0, "0", "full"},
-      {1, "1", "1/2-size"},
-      {2, "2", "1/4-size"},
-      {0, NULL, NULL},
-    };
-
-    ffmpegdec_lowres_type =
-        g_enum_register_static ("GstFFMpegDecLowres", ffmpegdec_lowres);
-  }
-
-  return ffmpegdec_lowres_type;
-}
-
-#define GST_FFMPEGDEC_TYPE_SKIPFRAME (gst_ffmpegdec_skipframe_get_type())
-static GType
-gst_ffmpegdec_skipframe_get_type (void)
-{
-  static GType ffmpegdec_skipframe_type = 0;
-
-  if (!ffmpegdec_skipframe_type) {
-    static const GEnumValue ffmpegdec_skipframe[] = {
-      {0, "0", "Skip nothing"},
-      {1, "1", "Skip B-frames"},
-      {2, "2", "Skip IDCT/Dequantization"},
-      {5, "5", "Skip everything"},
-      {0, NULL, NULL},
-    };
-
-    ffmpegdec_skipframe_type =
-        g_enum_register_static ("GstFFMpegDecSkipFrame", ffmpegdec_skipframe);
-  }
-
-  return ffmpegdec_skipframe_type;
-}
 
 static void
-gst_ffmpegdec_base_init (GstFFMpegDecClass * klass)
+gst_ffmpegauddec_base_init (GstFFMpegAudDecClass * klass)
 {
   GstElementClass *element_class = GST_ELEMENT_CLASS (klass);
   GstPadTemplate *sinktempl, *srctempl;
   GstCaps *sinkcaps, *srccaps;
   AVCodec *in_plugin;
-  gchar *longname, *classification, *description;
+  gchar *longname, *description;
 
   in_plugin =
       (AVCodec *) g_type_get_qdata (G_OBJECT_CLASS_TYPE (klass),
@@ -307,16 +183,13 @@ gst_ffmpegdec_base_init (GstFFMpegDecClass * klass)
 
   /* construct the element details struct */
   longname = g_strdup_printf ("FFmpeg %s decoder", in_plugin->long_name);
-  classification = g_strdup_printf ("Codec/Decoder/%s",
-      (in_plugin->type == AVMEDIA_TYPE_VIDEO) ? "Video" : "Audio");
   description = g_strdup_printf ("FFmpeg %s decoder", in_plugin->name);
-  gst_element_class_set_details_simple (element_class, longname, classification,
-      description,
+  gst_element_class_set_details_simple (element_class, longname,
+      "Codec/Decoder/Audio", description,
       "Wim Taymans <wim.taymans@gmail.com>, "
       "Ronald Bultje <rbultje@ronald.bitfreak.net>, "
       "Edward Hervey <bilboed@bilboed.com>");
   g_free (longname);
-  g_free (classification);
   g_free (description);
 
   /* get the caps */
@@ -325,12 +198,8 @@ gst_ffmpegdec_base_init (GstFFMpegDecClass * klass)
     GST_DEBUG ("Couldn't get sink caps for decoder '%s'", in_plugin->name);
     sinkcaps = gst_caps_from_string ("unknown/unknown");
   }
-  if (in_plugin->type == AVMEDIA_TYPE_VIDEO) {
-    srccaps = gst_caps_from_string ("video/x-raw-rgb; video/x-raw-yuv");
-  } else {
-    srccaps = gst_ffmpeg_codectype_to_audio_caps (NULL,
-        in_plugin->id, FALSE, in_plugin);
-  }
+  srccaps = gst_ffmpeg_codectype_to_audio_caps (NULL,
+      in_plugin->id, FALSE, in_plugin);
   if (!srccaps) {
     GST_DEBUG ("Couldn't get source caps for decoder '%s'", in_plugin->name);
     srccaps = gst_caps_from_string ("unknown/unknown");
@@ -350,260 +219,76 @@ gst_ffmpegdec_base_init (GstFFMpegDecClass * klass)
 }
 
 static void
-gst_ffmpegdec_class_init (GstFFMpegDecClass * klass)
+gst_ffmpegauddec_class_init (GstFFMpegAudDecClass * klass)
 {
   GObjectClass *gobject_class = G_OBJECT_CLASS (klass);
   GstElementClass *gstelement_class = GST_ELEMENT_CLASS (klass);
 
   parent_class = g_type_class_peek_parent (klass);
 
-  gobject_class->finalize = gst_ffmpegdec_finalize;
-
-  gobject_class->set_property = gst_ffmpegdec_set_property;
-  gobject_class->get_property = gst_ffmpegdec_get_property;
-
-  if (klass->in_plugin->type == AVMEDIA_TYPE_VIDEO) {
-    int caps;
-
-    g_object_class_install_property (gobject_class, PROP_SKIPFRAME,
-        g_param_spec_enum ("skip-frame", "Skip frames",
-            "Which types of frames to skip during decoding",
-            GST_FFMPEGDEC_TYPE_SKIPFRAME, 0,
-            G_PARAM_READWRITE | G_PARAM_STATIC_STRINGS));
-    g_object_class_install_property (gobject_class, PROP_LOWRES,
-        g_param_spec_enum ("lowres", "Low resolution",
-            "At which resolution to decode images", GST_FFMPEGDEC_TYPE_LOWRES,
-            0, G_PARAM_READWRITE | G_PARAM_STATIC_STRINGS));
-    g_object_class_install_property (gobject_class, PROP_DIRECT_RENDERING,
-        g_param_spec_boolean ("direct-rendering", "Direct Rendering",
-            "Enable direct rendering", DEFAULT_DIRECT_RENDERING,
-            G_PARAM_READWRITE | G_PARAM_STATIC_STRINGS));
-    g_object_class_install_property (gobject_class, PROP_DO_PADDING,
-        g_param_spec_boolean ("do-padding", "Do Padding",
-            "Add 0 padding before decoding data", DEFAULT_DO_PADDING,
-            G_PARAM_READWRITE | G_PARAM_STATIC_STRINGS));
-    g_object_class_install_property (gobject_class, PROP_DEBUG_MV,
-        g_param_spec_boolean ("debug-mv", "Debug motion vectors",
-            "Whether ffmpeg should print motion vectors on top of the image",
-            DEFAULT_DEBUG_MV, G_PARAM_READWRITE | G_PARAM_STATIC_STRINGS));
-#if 0
-    g_object_class_install_property (gobject_class, PROP_CROP,
-        g_param_spec_boolean ("crop", "Crop",
-            "Crop images to the display region",
-            DEFAULT_CROP, G_PARAM_READWRITE | G_PARAM_STATIC_STRINGS));
-#endif
-
-    caps = klass->in_plugin->capabilities;
-    if (caps & (CODEC_CAP_FRAME_THREADS | CODEC_CAP_SLICE_THREADS)) {
-      g_object_class_install_property (G_OBJECT_CLASS (klass), PROP_MAX_THREADS,
-          g_param_spec_int ("max-threads", "Maximum decode threads",
-              "Maximum number of worker threads to spawn. (0 = auto)",
-              0, G_MAXINT, DEFAULT_MAX_THREADS,
-              G_PARAM_READWRITE | G_PARAM_STATIC_STRINGS));
-    }
-  }
+  gobject_class->finalize = gst_ffmpegauddec_finalize;
 
-  gstelement_class->change_state = gst_ffmpegdec_change_state;
+  gstelement_class->change_state = gst_ffmpegauddec_change_state;
 }
 
 static void
-gst_ffmpegdec_init (GstFFMpegDec * ffmpegdec)
+gst_ffmpegauddec_init (GstFFMpegAudDec * ffmpegdec)
 {
-  GstFFMpegDecClass *oclass;
+  GstFFMpegAudDecClass *oclass;
 
-  oclass = (GstFFMpegDecClass *) (G_OBJECT_GET_CLASS (ffmpegdec));
+  oclass = (GstFFMpegAudDecClass *) (G_OBJECT_GET_CLASS (ffmpegdec));
 
   /* setup pads */
   ffmpegdec->sinkpad = gst_pad_new_from_template (oclass->sinktempl, "sink");
   gst_pad_set_setcaps_function (ffmpegdec->sinkpad,
-      GST_DEBUG_FUNCPTR (gst_ffmpegdec_setcaps));
+      GST_DEBUG_FUNCPTR (gst_ffmpegauddec_setcaps));
   gst_pad_set_event_function (ffmpegdec->sinkpad,
-      GST_DEBUG_FUNCPTR (gst_ffmpegdec_sink_event));
+      GST_DEBUG_FUNCPTR (gst_ffmpegauddec_sink_event));
   gst_pad_set_chain_function (ffmpegdec->sinkpad,
-      GST_DEBUG_FUNCPTR (gst_ffmpegdec_chain));
+      GST_DEBUG_FUNCPTR (gst_ffmpegauddec_chain));
   gst_element_add_pad (GST_ELEMENT (ffmpegdec), ffmpegdec->sinkpad);
 
   ffmpegdec->srcpad = gst_pad_new_from_template (oclass->srctempl, "src");
   gst_pad_use_fixed_caps (ffmpegdec->srcpad);
-  gst_pad_set_event_function (ffmpegdec->srcpad,
-      GST_DEBUG_FUNCPTR (gst_ffmpegdec_src_event));
-  gst_pad_set_query_function (ffmpegdec->srcpad,
-      GST_DEBUG_FUNCPTR (gst_ffmpegdec_query));
   gst_element_add_pad (GST_ELEMENT (ffmpegdec), ffmpegdec->srcpad);
 
   /* some ffmpeg data */
   ffmpegdec->context = avcodec_alloc_context ();
-  ffmpegdec->picture = avcodec_alloc_frame ();
   ffmpegdec->pctx = NULL;
   ffmpegdec->pcache = NULL;
-  ffmpegdec->par = NULL;
   ffmpegdec->opened = FALSE;
-  ffmpegdec->waiting_for_key = TRUE;
-  ffmpegdec->skip_frame = ffmpegdec->lowres = 0;
-  ffmpegdec->direct_rendering = DEFAULT_DIRECT_RENDERING;
-  ffmpegdec->do_padding = DEFAULT_DO_PADDING;
-  ffmpegdec->debug_mv = DEFAULT_DEBUG_MV;
-  ffmpegdec->crop = DEFAULT_CROP;
-  ffmpegdec->max_threads = DEFAULT_MAX_THREADS;
-
-  ffmpegdec->format.video.par_n = -1;
-  ffmpegdec->format.video.fps_n = -1;
-  ffmpegdec->format.video.old_fps_n = -1;
-  gst_segment_init (&ffmpegdec->segment, GST_FORMAT_TIME);
 
-  /* We initially assume downstream can allocate 16 bytes aligned buffers */
-  ffmpegdec->can_allocate_aligned = TRUE;
+  gst_segment_init (&ffmpegdec->segment, GST_FORMAT_TIME);
 }
 
 static void
-gst_ffmpegdec_finalize (GObject * object)
+gst_ffmpegauddec_finalize (GObject * object)
 {
-  GstFFMpegDec *ffmpegdec = (GstFFMpegDec *) object;
+  GstFFMpegAudDec *ffmpegdec = (GstFFMpegAudDec *) object;
 
   if (ffmpegdec->context != NULL) {
     av_free (ffmpegdec->context);
     ffmpegdec->context = NULL;
   }
 
-  if (ffmpegdec->picture != NULL) {
-    av_free (ffmpegdec->picture);
-    ffmpegdec->picture = NULL;
-  }
-
   G_OBJECT_CLASS (parent_class)->finalize (object);
 }
 
-static gboolean
-gst_ffmpegdec_query (GstPad * pad, GstQuery * query)
-{
-  GstFFMpegDec *ffmpegdec;
-  GstPad *peer;
-  gboolean res;
-
-  ffmpegdec = (GstFFMpegDec *) gst_pad_get_parent (pad);
-
-  res = FALSE;
-
-  if ((peer = gst_pad_get_peer (ffmpegdec->sinkpad))) {
-    /* just forward to peer */
-    res = gst_pad_query (peer, query);
-    gst_object_unref (peer);
-  }
-#if 0
-  {
-    GstFormat bfmt;
-
-    bfmt = GST_FORMAT_BYTES;
-
-    /* ok, do bitrate calc... */
-    if ((type != GST_QUERY_POSITION && type != GST_QUERY_TOTAL) ||
-        *fmt != GST_FORMAT_TIME || ffmpegdec->context->bit_rate == 0 ||
-        !gst_pad_query (peer, type, &bfmt, value))
-      return FALSE;
-
-    if (ffmpegdec->pcache && type == GST_QUERY_POSITION)
-      *value -= GST_BUFFER_SIZE (ffmpegdec->pcache);
-    *value *= GST_SECOND / ffmpegdec->context->bit_rate;
-  }
-#endif
-
-  gst_object_unref (ffmpegdec);
-
-  return res;
-}
-
 static void
-gst_ffmpegdec_reset_ts (GstFFMpegDec * ffmpegdec)
+gst_ffmpegauddec_reset_ts (GstFFMpegAudDec * ffmpegdec)
 {
-  ffmpegdec->last_in = GST_CLOCK_TIME_NONE;
-  ffmpegdec->last_diff = GST_CLOCK_TIME_NONE;
-  ffmpegdec->last_frames = 0;
-  ffmpegdec->last_out = GST_CLOCK_TIME_NONE;
   ffmpegdec->next_out = GST_CLOCK_TIME_NONE;
-  ffmpegdec->reordered_in = FALSE;
-  ffmpegdec->reordered_out = FALSE;
-}
-
-static void
-gst_ffmpegdec_update_qos (GstFFMpegDec * ffmpegdec, gdouble proportion,
-    GstClockTime timestamp)
-{
-  GST_LOG_OBJECT (ffmpegdec, "update QOS: %f, %" GST_TIME_FORMAT,
-      proportion, GST_TIME_ARGS (timestamp));
-
-  GST_OBJECT_LOCK (ffmpegdec);
-  ffmpegdec->proportion = proportion;
-  ffmpegdec->earliest_time = timestamp;
-  GST_OBJECT_UNLOCK (ffmpegdec);
-}
-
-static void
-gst_ffmpegdec_reset_qos (GstFFMpegDec * ffmpegdec)
-{
-  gst_ffmpegdec_update_qos (ffmpegdec, 0.5, GST_CLOCK_TIME_NONE);
-  ffmpegdec->processed = 0;
-  ffmpegdec->dropped = 0;
-}
-
-static void
-gst_ffmpegdec_read_qos (GstFFMpegDec * ffmpegdec, gdouble * proportion,
-    GstClockTime * timestamp)
-{
-  GST_OBJECT_LOCK (ffmpegdec);
-  *proportion = ffmpegdec->proportion;
-  *timestamp = ffmpegdec->earliest_time;
-  GST_OBJECT_UNLOCK (ffmpegdec);
-}
-
-static gboolean
-gst_ffmpegdec_src_event (GstPad * pad, GstEvent * event)
-{
-  GstFFMpegDec *ffmpegdec;
-  gboolean res;
-
-  ffmpegdec = (GstFFMpegDec *) gst_pad_get_parent (pad);
-
-  switch (GST_EVENT_TYPE (event)) {
-    case GST_EVENT_QOS:
-    {
-      gdouble proportion;
-      GstClockTimeDiff diff;
-      GstClockTime timestamp;
-
-      gst_event_parse_qos (event, &proportion, &diff, &timestamp);
-
-      /* update our QoS values */
-      gst_ffmpegdec_update_qos (ffmpegdec, proportion, timestamp + diff);
-
-      /* forward upstream */
-      res = gst_pad_push_event (ffmpegdec->sinkpad, event);
-      break;
-    }
-    default:
-      /* forward upstream */
-      res = gst_pad_push_event (ffmpegdec->sinkpad, event);
-      break;
-  }
-
-  gst_object_unref (ffmpegdec);
-
-  return res;
 }
 
 /* with LOCK */
 static void
-gst_ffmpegdec_close (GstFFMpegDec * ffmpegdec)
+gst_ffmpegauddec_close (GstFFMpegAudDec * ffmpegdec)
 {
   if (!ffmpegdec->opened)
     return;
 
   GST_LOG_OBJECT (ffmpegdec, "closing ffmpeg codec");
 
-  if (ffmpegdec->par) {
-    g_free (ffmpegdec->par);
-    ffmpegdec->par = NULL;
-  }
-
   if (ffmpegdec->context->priv_data)
     gst_ffmpeg_avcodec_close (ffmpegdec->context);
   ffmpegdec->opened = FALSE;
@@ -626,98 +311,46 @@ gst_ffmpegdec_close (GstFFMpegDec * ffmpegdec)
     av_parser_close (ffmpegdec->pctx);
     ffmpegdec->pctx = NULL;
   }
-
-  ffmpegdec->format.video.par_n = -1;
-  ffmpegdec->format.video.fps_n = -1;
-  ffmpegdec->format.video.old_fps_n = -1;
-  ffmpegdec->format.video.interlaced = FALSE;
 }
 
 /* with LOCK */
 static gboolean
-gst_ffmpegdec_open (GstFFMpegDec * ffmpegdec)
+gst_ffmpegauddec_open (GstFFMpegAudDec * ffmpegdec)
 {
-  GstFFMpegDecClass *oclass;
+  GstFFMpegAudDecClass *oclass;
 
-  oclass = (GstFFMpegDecClass *) (G_OBJECT_GET_CLASS (ffmpegdec));
+  oclass = (GstFFMpegAudDecClass *) (G_OBJECT_GET_CLASS (ffmpegdec));
 
   if (gst_ffmpeg_avcodec_open (ffmpegdec->context, oclass->in_plugin) < 0)
     goto could_not_open;
 
   ffmpegdec->opened = TRUE;
-  ffmpegdec->is_realvideo = FALSE;
 
   GST_LOG_OBJECT (ffmpegdec, "Opened ffmpeg codec %s, id %d",
       oclass->in_plugin->name, oclass->in_plugin->id);
 
-  /* open a parser if we can */
-  switch (oclass->in_plugin->id) {
-    case CODEC_ID_MPEG4:
-    case CODEC_ID_MJPEG:
-    case CODEC_ID_VC1:
-      GST_LOG_OBJECT (ffmpegdec, "not using parser, blacklisted codec");
-      ffmpegdec->pctx = NULL;
-      break;
-    case CODEC_ID_H264:
-      /* For H264, only use a parser if there is no context data, if there is, 
-       * we're talking AVC */
-      if (ffmpegdec->context->extradata_size == 0) {
-        GST_LOG_OBJECT (ffmpegdec, "H264 with no extradata, creating parser");
-        ffmpegdec->pctx = av_parser_init (oclass->in_plugin->id);
-      } else {
-        GST_LOG_OBJECT (ffmpegdec,
-            "H264 with extradata implies framed data - not using parser");
-        ffmpegdec->pctx = NULL;
-      }
-      break;
-    case CODEC_ID_RV10:
-    case CODEC_ID_RV30:
-    case CODEC_ID_RV20:
-    case CODEC_ID_RV40:
-      ffmpegdec->is_realvideo = TRUE;
-      break;
-    default:
-      if (!ffmpegdec->turnoff_parser) {
-        ffmpegdec->pctx = av_parser_init (oclass->in_plugin->id);
-        if (ffmpegdec->pctx)
-          GST_LOG_OBJECT (ffmpegdec, "Using parser %p", ffmpegdec->pctx);
-        else
-          GST_LOG_OBJECT (ffmpegdec, "No parser for codec");
-      } else {
-        GST_LOG_OBJECT (ffmpegdec, "Parser deactivated for format");
-      }
-      break;
+  if (!ffmpegdec->turnoff_parser) {
+    ffmpegdec->pctx = av_parser_init (oclass->in_plugin->id);
+    if (ffmpegdec->pctx)
+      GST_LOG_OBJECT (ffmpegdec, "Using parser %p", ffmpegdec->pctx);
+    else
+      GST_LOG_OBJECT (ffmpegdec, "No parser for codec");
+  } else {
+    GST_LOG_OBJECT (ffmpegdec, "Parser deactivated for format");
   }
 
-  switch (oclass->in_plugin->type) {
-    case AVMEDIA_TYPE_VIDEO:
-      ffmpegdec->format.video.width = 0;
-      ffmpegdec->format.video.height = 0;
-      ffmpegdec->format.video.clip_width = -1;
-      ffmpegdec->format.video.clip_height = -1;
-      ffmpegdec->format.video.pix_fmt = PIX_FMT_NB;
-      ffmpegdec->format.video.interlaced = FALSE;
-      break;
-    case AVMEDIA_TYPE_AUDIO:
-      ffmpegdec->format.audio.samplerate = 0;
-      ffmpegdec->format.audio.channels = 0;
-      ffmpegdec->format.audio.depth = 0;
-      break;
-    default:
-      break;
-  }
+  ffmpegdec->format.audio.samplerate = 0;
+  ffmpegdec->format.audio.channels = 0;
+  ffmpegdec->format.audio.depth = 0;
 
-  gst_ffmpegdec_reset_ts (ffmpegdec);
-  /* FIXME, reset_qos holds the LOCK */
-  ffmpegdec->proportion = 0.0;
-  ffmpegdec->earliest_time = -1;
+  gst_ffmpegauddec_reset_ts (ffmpegdec);
 
   return TRUE;
 
   /* ERRORS */
 could_not_open:
   {
-    gst_ffmpegdec_close (ffmpegdec);
+    gst_ffmpegauddec_close (ffmpegdec);
     GST_DEBUG_OBJECT (ffmpegdec, "ffdec_%s: Failed to open FFMPEG codec",
         oclass->in_plugin->name);
     return FALSE;
@@ -725,127 +358,41 @@ could_not_open:
 }
 
 static gboolean
-gst_ffmpegdec_setcaps (GstPad * pad, GstCaps * caps)
+gst_ffmpegauddec_setcaps (GstPad * pad, GstCaps * caps)
 {
-  GstFFMpegDec *ffmpegdec;
-  GstFFMpegDecClass *oclass;
+  GstFFMpegAudDec *ffmpegdec;
+  GstFFMpegAudDecClass *oclass;
   GstStructure *structure;
-  const GValue *par;
-  const GValue *fps;
   gboolean ret = TRUE;
 
-  ffmpegdec = (GstFFMpegDec *) (gst_pad_get_parent (pad));
-  oclass = (GstFFMpegDecClass *) (G_OBJECT_GET_CLASS (ffmpegdec));
+  ffmpegdec = (GstFFMpegAudDec *) (gst_pad_get_parent (pad));
+  oclass = (GstFFMpegAudDecClass *) (G_OBJECT_GET_CLASS (ffmpegdec));
 
   GST_DEBUG_OBJECT (pad, "setcaps called");
 
   GST_OBJECT_LOCK (ffmpegdec);
 
-  /* stupid check for VC1 */
-  if ((oclass->in_plugin->id == CODEC_ID_WMV3) ||
-      (oclass->in_plugin->id == CODEC_ID_VC1))
-    oclass->in_plugin->id = gst_ffmpeg_caps_to_codecid (caps, NULL);
-
   /* close old session */
   if (ffmpegdec->opened) {
     GST_OBJECT_UNLOCK (ffmpegdec);
-    gst_ffmpegdec_drain (ffmpegdec);
+    gst_ffmpegauddec_drain (ffmpegdec);
     GST_OBJECT_LOCK (ffmpegdec);
-    gst_ffmpegdec_close (ffmpegdec);
+    gst_ffmpegauddec_close (ffmpegdec);
 
     /* and reset the defaults that were set when a context is created */
     avcodec_get_context_defaults (ffmpegdec->context);
   }
 
-  /* set buffer functions */
-  ffmpegdec->context->get_buffer = gst_ffmpegdec_get_buffer;
-  ffmpegdec->context->release_buffer = gst_ffmpegdec_release_buffer;
-  ffmpegdec->context->draw_horiz_band = NULL;
-
   /* default is to let format decide if it needs a parser */
   ffmpegdec->turnoff_parser = FALSE;
 
-  ffmpegdec->has_b_frames = FALSE;
-
-  GST_LOG_OBJECT (ffmpegdec, "size %dx%d", ffmpegdec->context->width,
-      ffmpegdec->context->height);
-
   /* get size and so */
   gst_ffmpeg_caps_with_codecid (oclass->in_plugin->id,
       oclass->in_plugin->type, caps, ffmpegdec->context);
 
-  GST_LOG_OBJECT (ffmpegdec, "size after %dx%d", ffmpegdec->context->width,
-      ffmpegdec->context->height);
-
-  if (!ffmpegdec->context->time_base.den || !ffmpegdec->context->time_base.num) {
-    GST_DEBUG_OBJECT (ffmpegdec, "forcing 25/1 framerate");
-    ffmpegdec->context->time_base.num = 1;
-    ffmpegdec->context->time_base.den = 25;
-  }
-
   /* get pixel aspect ratio if it's set */
   structure = gst_caps_get_structure (caps, 0);
 
-  par = gst_structure_get_value (structure, "pixel-aspect-ratio");
-  if (par) {
-    GST_DEBUG_OBJECT (ffmpegdec, "sink caps have pixel-aspect-ratio of %d:%d",
-        gst_value_get_fraction_numerator (par),
-        gst_value_get_fraction_denominator (par));
-    /* should be NULL */
-    if (ffmpegdec->par)
-      g_free (ffmpegdec->par);
-    ffmpegdec->par = g_new0 (GValue, 1);
-    gst_value_init_and_copy (ffmpegdec->par, par);
-  }
-
-  /* get the framerate from incoming caps. fps_n is set to -1 when
-   * there is no valid framerate */
-  fps = gst_structure_get_value (structure, "framerate");
-  if (fps != NULL && GST_VALUE_HOLDS_FRACTION (fps)) {
-    ffmpegdec->format.video.fps_n = gst_value_get_fraction_numerator (fps);
-    ffmpegdec->format.video.fps_d = gst_value_get_fraction_denominator (fps);
-    GST_DEBUG_OBJECT (ffmpegdec, "Using framerate %d/%d from incoming caps",
-        ffmpegdec->format.video.fps_n, ffmpegdec->format.video.fps_d);
-  } else {
-    ffmpegdec->format.video.fps_n = -1;
-    GST_DEBUG_OBJECT (ffmpegdec, "Using framerate from codec");
-  }
-
-  /* figure out if we can use direct rendering */
-  ffmpegdec->current_dr = FALSE;
-  ffmpegdec->extra_ref = FALSE;
-  if (ffmpegdec->direct_rendering) {
-    GST_DEBUG_OBJECT (ffmpegdec, "trying to enable direct rendering");
-    if (oclass->in_plugin->capabilities & CODEC_CAP_DR1) {
-      if (oclass->in_plugin->id == CODEC_ID_H264) {
-        GST_DEBUG_OBJECT (ffmpegdec, "disable direct rendering setup for H264");
-        /* does not work, many stuff reads outside of the planes */
-        ffmpegdec->current_dr = FALSE;
-        ffmpegdec->extra_ref = TRUE;
-      } else if ((oclass->in_plugin->id == CODEC_ID_SVQ1) ||
-          (oclass->in_plugin->id == CODEC_ID_VP5) ||
-          (oclass->in_plugin->id == CODEC_ID_VP6) ||
-          (oclass->in_plugin->id == CODEC_ID_VP6F) ||
-          (oclass->in_plugin->id == CODEC_ID_VP6A)) {
-        GST_DEBUG_OBJECT (ffmpegdec,
-            "disable direct rendering setup for broken stride support");
-        /* does not work, uses a incompatible stride. See #610613 */
-        ffmpegdec->current_dr = FALSE;
-        ffmpegdec->extra_ref = TRUE;
-      } else {
-        GST_DEBUG_OBJECT (ffmpegdec, "enabled direct rendering");
-        ffmpegdec->current_dr = TRUE;
-      }
-    } else {
-      GST_DEBUG_OBJECT (ffmpegdec, "direct rendering not supported");
-    }
-  }
-  if (ffmpegdec->current_dr) {
-    /* do *not* draw edges when in direct rendering, for some reason it draws
-     * outside of the memory. */
-    ffmpegdec->context->flags |= CODEC_FLAG_EMU_EDGE;
-  }
-
   /* for AAC we only use av_parse if not on stream-format==raw or ==loas */
   if (oclass->in_plugin->id == CODEC_ID_AAC
       || oclass->in_plugin->id == CODEC_ID_AAC_LATM) {
@@ -866,43 +413,12 @@ gst_ffmpegdec_setcaps (GstPad * pad, GstCaps * caps)
   ffmpegdec->context->workaround_bugs |= FF_BUG_AUTODETECT;
   ffmpegdec->context->error_recognition = 1;
 
-  /* for slow cpus */
-  ffmpegdec->context->lowres = ffmpegdec->lowres;
-  ffmpegdec->context->skip_frame = ffmpegdec->skip_frame;
-
-  /* ffmpeg can draw motion vectors on top of the image (not every decoder
-   * supports it) */
-  ffmpegdec->context->debug_mv = ffmpegdec->debug_mv;
-
-  if (ffmpegdec->max_threads == 0)
-    ffmpegdec->context->thread_count = gst_ffmpeg_auto_max_threads ();
-  else
-    ffmpegdec->context->thread_count = ffmpegdec->max_threads;
-
   /* open codec - we don't select an output pix_fmt yet,
    * simply because we don't know! We only get it
    * during playback... */
-  if (!gst_ffmpegdec_open (ffmpegdec))
+  if (!gst_ffmpegauddec_open (ffmpegdec))
     goto open_failed;
 
-  /* clipping region */
-  gst_structure_get_int (structure, "width",
-      &ffmpegdec->format.video.clip_width);
-  gst_structure_get_int (structure, "height",
-      &ffmpegdec->format.video.clip_height);
-
-  GST_DEBUG_OBJECT (pad, "clipping to %dx%d",
-      ffmpegdec->format.video.clip_width, ffmpegdec->format.video.clip_height);
-
-  /* take into account the lowres property */
-  if (ffmpegdec->format.video.clip_width != -1)
-    ffmpegdec->format.video.clip_width >>= ffmpegdec->lowres;
-  if (ffmpegdec->format.video.clip_height != -1)
-    ffmpegdec->format.video.clip_height >>= ffmpegdec->lowres;
-
-  GST_DEBUG_OBJECT (pad, "final clipping to %dx%d",
-      ffmpegdec->format.video.clip_width, ffmpegdec->format.video.clip_height);
-
 done:
   GST_OBJECT_UNLOCK (ffmpegdec);
 
@@ -914,365 +430,34 @@ done:
 open_failed:
   {
     GST_DEBUG_OBJECT (ffmpegdec, "Failed to open");
-    if (ffmpegdec->par) {
-      g_free (ffmpegdec->par);
-      ffmpegdec->par = NULL;
-    }
     ret = FALSE;
     goto done;
   }
 }
 
-static GstFlowReturn
-alloc_output_buffer (GstFFMpegDec * ffmpegdec, GstBuffer ** outbuf,
-    gint width, gint height)
-{
-  GstFlowReturn ret;
-  gint fsize;
-
-  ret = GST_FLOW_ERROR;
-  *outbuf = NULL;
-
-  GST_LOG_OBJECT (ffmpegdec, "alloc output buffer");
-
-  /* see if we need renegotiation */
-  if (G_UNLIKELY (!gst_ffmpegdec_negotiate (ffmpegdec, FALSE)))
-    goto negotiate_failed;
-
-  /* get the size of the gstreamer output buffer given a
-   * width/height/format */
-  fsize = gst_ffmpeg_avpicture_get_size (ffmpegdec->context->pix_fmt,
-      width, height);
-
-  if (!ffmpegdec->context->palctrl && ffmpegdec->can_allocate_aligned) {
-    GST_LOG_OBJECT (ffmpegdec, "calling pad_alloc");
-    /* no pallete, we can use the buffer size to alloc */
-    ret = gst_pad_alloc_buffer_and_set_caps (ffmpegdec->srcpad,
-        GST_BUFFER_OFFSET_NONE, fsize,
-        GST_PAD_CAPS (ffmpegdec->srcpad), outbuf);
-    if (G_UNLIKELY (ret != GST_FLOW_OK))
-      goto alloc_failed;
-
-    /* If buffer isn't 128-bit aligned, create a memaligned one ourselves */
-    if (((uintptr_t) GST_BUFFER_DATA (*outbuf)) % 16) {
-      GST_DEBUG_OBJECT (ffmpegdec,
-          "Downstream can't allocate aligned buffers.");
-      ffmpegdec->can_allocate_aligned = FALSE;
-      gst_buffer_unref (*outbuf);
-      *outbuf = new_aligned_buffer (fsize, GST_PAD_CAPS (ffmpegdec->srcpad));
-    }
-  } else {
-    GST_LOG_OBJECT (ffmpegdec,
-        "not calling pad_alloc, we have a pallete or downstream can't give 16 byte aligned buffers.");
-    /* for paletted data we can't use pad_alloc_buffer(), because
-     * fsize contains the size of the palette, so the overall size
-     * is bigger than ffmpegcolorspace's unit size, which will
-     * prompt GstBaseTransform to complain endlessly ... */
-    *outbuf = new_aligned_buffer (fsize, GST_PAD_CAPS (ffmpegdec->srcpad));
-    ret = GST_FLOW_OK;
-  }
-  /* set caps, we do this here because the buffer is still writable here and we
-   * are sure to be negotiated */
-  gst_buffer_set_caps (*outbuf, GST_PAD_CAPS (ffmpegdec->srcpad));
-
-  return ret;
-
-  /* special cases */
-negotiate_failed:
-  {
-    GST_DEBUG_OBJECT (ffmpegdec, "negotiate failed");
-    return GST_FLOW_NOT_NEGOTIATED;
-  }
-alloc_failed:
-  {
-    GST_DEBUG_OBJECT (ffmpegdec, "pad_alloc failed %d (%s)", ret,
-        gst_flow_get_name (ret));
-    return ret;
-  }
-}
-
-static int
-gst_ffmpegdec_get_buffer (AVCodecContext * context, AVFrame * picture)
-{
-  GstBuffer *buf = NULL;
-  GstFFMpegDec *ffmpegdec;
-  gint width, height;
-  gint coded_width, coded_height;
-  gint res;
-
-  ffmpegdec = (GstFFMpegDec *) context->opaque;
-
-  GST_DEBUG_OBJECT (ffmpegdec, "getting buffer");
-
-  /* apply the last info we have seen to this picture, when we get the
-   * picture back from ffmpeg we can use this to correctly timestamp the output
-   * buffer */
-  picture->reordered_opaque = context->reordered_opaque;
-  /* make sure we don't free the buffer when it's not ours */
-  picture->opaque = NULL;
-
-  /* take width and height before clipping */
-  width = context->width;
-  height = context->height;
-  coded_width = context->coded_width;
-  coded_height = context->coded_height;
-
-  GST_LOG_OBJECT (ffmpegdec, "dimension %dx%d, coded %dx%d", width, height,
-      coded_width, coded_height);
-  if (!ffmpegdec->current_dr) {
-    GST_LOG_OBJECT (ffmpegdec, "direct rendering disabled, fallback alloc");
-    res = avcodec_default_get_buffer (context, picture);
-
-    GST_LOG_OBJECT (ffmpegdec, "linsize %d %d %d", picture->linesize[0],
-        picture->linesize[1], picture->linesize[2]);
-    GST_LOG_OBJECT (ffmpegdec, "data %u %u %u", 0,
-        (guint) (picture->data[1] - picture->data[0]),
-        (guint) (picture->data[2] - picture->data[0]));
-    return res;
-  }
-
-  switch (context->codec_type) {
-    case AVMEDIA_TYPE_VIDEO:
-      /* some ffmpeg video plugins don't see the point in setting codec_type ... */
-    case AVMEDIA_TYPE_UNKNOWN:
-    {
-      GstFlowReturn ret;
-      gint clip_width, clip_height;
-
-      /* take final clipped output size */
-      if ((clip_width = ffmpegdec->format.video.clip_width) == -1)
-        clip_width = width;
-      if ((clip_height = ffmpegdec->format.video.clip_height) == -1)
-        clip_height = height;
-
-      GST_LOG_OBJECT (ffmpegdec, "raw outsize %d/%d", width, height);
-
-      /* this is the size ffmpeg needs for the buffer */
-      avcodec_align_dimensions (context, &width, &height);
-
-      GST_LOG_OBJECT (ffmpegdec, "aligned outsize %d/%d, clip %d/%d",
-          width, height, clip_width, clip_height);
-
-      if (width != clip_width || height != clip_height) {
-        /* We can't alloc if we need to clip the output buffer later */
-        GST_LOG_OBJECT (ffmpegdec, "we need clipping, fallback alloc");
-        return avcodec_default_get_buffer (context, picture);
-      }
-
-      /* alloc with aligned dimensions for ffmpeg */
-      ret = alloc_output_buffer (ffmpegdec, &buf, width, height);
-      if (G_UNLIKELY (ret != GST_FLOW_OK)) {
-        /* alloc default buffer when we can't get one from downstream */
-        GST_LOG_OBJECT (ffmpegdec, "alloc failed, fallback alloc");
-        return avcodec_default_get_buffer (context, picture);
-      }
-
-      /* copy the right pointers and strides in the picture object */
-      gst_ffmpeg_avpicture_fill ((AVPicture *) picture,
-          GST_BUFFER_DATA (buf), context->pix_fmt, width, height);
-      break;
-    }
-    case AVMEDIA_TYPE_AUDIO:
-    default:
-      GST_ERROR_OBJECT (ffmpegdec,
-          "_get_buffer() should never get called for non-video buffers !");
-      g_assert_not_reached ();
-      break;
-  }
-
-  /* tell ffmpeg we own this buffer, tranfer the ref we have on the buffer to
-   * the opaque data. */
-  picture->type = FF_BUFFER_TYPE_USER;
-  picture->age = 256 * 256 * 256 * 64;
-  picture->opaque = buf;
-
-#ifdef EXTRA_REF
-  if (picture->reference != 0 || ffmpegdec->extra_ref) {
-    GST_DEBUG_OBJECT (ffmpegdec, "adding extra ref");
-    gst_buffer_ref (buf);
-  }
-#endif
-
-  GST_LOG_OBJECT (ffmpegdec, "returned buffer %p", buf);
-
-  return 0;
-}
-
-static void
-gst_ffmpegdec_release_buffer (AVCodecContext * context, AVFrame * picture)
-{
-  gint i;
-  GstBuffer *buf;
-  GstFFMpegDec *ffmpegdec;
-
-  ffmpegdec = (GstFFMpegDec *) context->opaque;
-
-  /* check if it was our buffer */
-  if (picture->opaque == NULL) {
-    GST_DEBUG_OBJECT (ffmpegdec, "default release buffer");
-    avcodec_default_release_buffer (context, picture);
-    return;
-  }
-
-  /* we remove the opaque data now */
-  buf = GST_BUFFER_CAST (picture->opaque);
-  GST_DEBUG_OBJECT (ffmpegdec, "release buffer %p", buf);
-  picture->opaque = NULL;
-
-#ifdef EXTRA_REF
-  if (picture->reference != 0 || ffmpegdec->extra_ref) {
-    GST_DEBUG_OBJECT (ffmpegdec, "remove extra ref");
-    gst_buffer_unref (buf);
-  }
-#else
-  gst_buffer_unref (buf);
-#endif
-
-  /* zero out the reference in ffmpeg */
-  for (i = 0; i < 4; i++) {
-    picture->data[i] = NULL;
-    picture->linesize[i] = 0;
-  }
-}
-
-static void
-gst_ffmpegdec_add_pixel_aspect_ratio (GstFFMpegDec * ffmpegdec,
-    GstStructure * s)
-{
-  gboolean demuxer_par_set = FALSE;
-  gboolean decoder_par_set = FALSE;
-  gint demuxer_num = 1, demuxer_denom = 1;
-  gint decoder_num = 1, decoder_denom = 1;
-
-  GST_OBJECT_LOCK (ffmpegdec);
-
-  if (ffmpegdec->par) {
-    demuxer_num = gst_value_get_fraction_numerator (ffmpegdec->par);
-    demuxer_denom = gst_value_get_fraction_denominator (ffmpegdec->par);
-    demuxer_par_set = TRUE;
-    GST_DEBUG_OBJECT (ffmpegdec, "Demuxer PAR: %d:%d", demuxer_num,
-        demuxer_denom);
-  }
-
-  if (ffmpegdec->context->sample_aspect_ratio.num &&
-      ffmpegdec->context->sample_aspect_ratio.den) {
-    decoder_num = ffmpegdec->context->sample_aspect_ratio.num;
-    decoder_denom = ffmpegdec->context->sample_aspect_ratio.den;
-    decoder_par_set = TRUE;
-    GST_DEBUG_OBJECT (ffmpegdec, "Decoder PAR: %d:%d", decoder_num,
-        decoder_denom);
-  }
-
-  GST_OBJECT_UNLOCK (ffmpegdec);
-
-  if (!demuxer_par_set && !decoder_par_set)
-    goto no_par;
-
-  if (demuxer_par_set && !decoder_par_set)
-    goto use_demuxer_par;
-
-  if (decoder_par_set && !demuxer_par_set)
-    goto use_decoder_par;
-
-  /* Both the demuxer and the decoder provide a PAR. If one of
-   * the two PARs is 1:1 and the other one is not, use the one
-   * that is not 1:1. */
-  if (demuxer_num == demuxer_denom && decoder_num != decoder_denom)
-    goto use_decoder_par;
-
-  if (decoder_num == decoder_denom && demuxer_num != demuxer_denom)
-    goto use_demuxer_par;
-
-  /* Both PARs are non-1:1, so use the PAR provided by the demuxer */
-  goto use_demuxer_par;
-
-use_decoder_par:
-  {
-    GST_DEBUG_OBJECT (ffmpegdec,
-        "Setting decoder provided pixel-aspect-ratio of %u:%u", decoder_num,
-        decoder_denom);
-    gst_structure_set (s, "pixel-aspect-ratio", GST_TYPE_FRACTION, decoder_num,
-        decoder_denom, NULL);
-    return;
-  }
-
-use_demuxer_par:
-  {
-    GST_DEBUG_OBJECT (ffmpegdec,
-        "Setting demuxer provided pixel-aspect-ratio of %u:%u", demuxer_num,
-        demuxer_denom);
-    gst_structure_set (s, "pixel-aspect-ratio", GST_TYPE_FRACTION, demuxer_num,
-        demuxer_denom, NULL);
-    return;
-  }
-no_par:
-  {
-    GST_DEBUG_OBJECT (ffmpegdec,
-        "Neither demuxer nor codec provide a pixel-aspect-ratio");
-    return;
-  }
-}
-
 static gboolean
-gst_ffmpegdec_negotiate (GstFFMpegDec * ffmpegdec, gboolean force)
+gst_ffmpegauddec_negotiate (GstFFMpegAudDec * ffmpegdec, gboolean force)
 {
-  GstFFMpegDecClass *oclass;
+  GstFFMpegAudDecClass *oclass;
   GstCaps *caps;
+  gint depth;
 
-  oclass = (GstFFMpegDecClass *) (G_OBJECT_GET_CLASS (ffmpegdec));
-
-  switch (oclass->in_plugin->type) {
-    case AVMEDIA_TYPE_VIDEO:
-      if (!force && ffmpegdec->format.video.width == ffmpegdec->context->width
-          && ffmpegdec->format.video.height == ffmpegdec->context->height
-          && ffmpegdec->format.video.fps_n == ffmpegdec->format.video.old_fps_n
-          && ffmpegdec->format.video.fps_d == ffmpegdec->format.video.old_fps_d
-          && ffmpegdec->format.video.pix_fmt == ffmpegdec->context->pix_fmt
-          && ffmpegdec->format.video.par_n ==
-          ffmpegdec->context->sample_aspect_ratio.num
-          && ffmpegdec->format.video.par_d ==
-          ffmpegdec->context->sample_aspect_ratio.den)
-        return TRUE;
-      GST_DEBUG_OBJECT (ffmpegdec,
-          "Renegotiating video from %dx%d@ %d:%d PAR %d/%d fps to %dx%d@ %d:%d PAR %d/%d fps",
-          ffmpegdec->format.video.width, ffmpegdec->format.video.height,
-          ffmpegdec->format.video.par_n, ffmpegdec->format.video.par_d,
-          ffmpegdec->format.video.old_fps_n, ffmpegdec->format.video.old_fps_n,
-          ffmpegdec->context->width, ffmpegdec->context->height,
-          ffmpegdec->context->sample_aspect_ratio.num,
-          ffmpegdec->context->sample_aspect_ratio.den,
-          ffmpegdec->format.video.fps_n, ffmpegdec->format.video.fps_d);
-      ffmpegdec->format.video.width = ffmpegdec->context->width;
-      ffmpegdec->format.video.height = ffmpegdec->context->height;
-      ffmpegdec->format.video.old_fps_n = ffmpegdec->format.video.fps_n;
-      ffmpegdec->format.video.old_fps_d = ffmpegdec->format.video.fps_d;
-      ffmpegdec->format.video.pix_fmt = ffmpegdec->context->pix_fmt;
-      ffmpegdec->format.video.par_n =
-          ffmpegdec->context->sample_aspect_ratio.num;
-      ffmpegdec->format.video.par_d =
-          ffmpegdec->context->sample_aspect_ratio.den;
-      break;
-    case AVMEDIA_TYPE_AUDIO:
-    {
-      gint depth = av_smp_format_depth (ffmpegdec->context->sample_fmt);
-      if (!force && ffmpegdec->format.audio.samplerate ==
-          ffmpegdec->context->sample_rate &&
-          ffmpegdec->format.audio.channels == ffmpegdec->context->channels &&
-          ffmpegdec->format.audio.depth == depth)
-        return TRUE;
-      GST_DEBUG_OBJECT (ffmpegdec,
-          "Renegotiating audio from %dHz@%dchannels (%d) to %dHz@%dchannels (%d)",
-          ffmpegdec->format.audio.samplerate, ffmpegdec->format.audio.channels,
-          ffmpegdec->format.audio.depth,
-          ffmpegdec->context->sample_rate, ffmpegdec->context->channels, depth);
-      ffmpegdec->format.audio.samplerate = ffmpegdec->context->sample_rate;
-      ffmpegdec->format.audio.channels = ffmpegdec->context->channels;
-      ffmpegdec->format.audio.depth = depth;
-    }
-      break;
-    default:
-      break;
-  }
+  oclass = (GstFFMpegAudDecClass *) (G_OBJECT_GET_CLASS (ffmpegdec));
+
+  depth = av_smp_format_depth (ffmpegdec->context->sample_fmt);
+  if (!force && ffmpegdec->format.audio.samplerate ==
+      ffmpegdec->context->sample_rate &&
+      ffmpegdec->format.audio.channels == ffmpegdec->context->channels &&
+      ffmpegdec->format.audio.depth == depth)
+    return TRUE;
+  GST_DEBUG_OBJECT (ffmpegdec,
+      "Renegotiating audio from %dHz@%dchannels (%d) to %dHz@%dchannels (%d)",
+      ffmpegdec->format.audio.samplerate, ffmpegdec->format.audio.channels,
+      ffmpegdec->format.audio.depth,
+      ffmpegdec->context->sample_rate, ffmpegdec->context->channels, depth);
+  ffmpegdec->format.audio.samplerate = ffmpegdec->context->sample_rate;
+  ffmpegdec->format.audio.channels = ffmpegdec->context->channels;
+  ffmpegdec->format.audio.depth = depth;
 
   caps = gst_ffmpeg_codectype_to_caps (oclass->in_plugin->type,
       ffmpegdec->context, oclass->in_plugin->id, FALSE);
@@ -1280,45 +465,6 @@ gst_ffmpegdec_negotiate (GstFFMpegDec * ffmpegdec, gboolean force)
   if (caps == NULL)
     goto no_caps;
 
-  switch (oclass->in_plugin->type) {
-    case AVMEDIA_TYPE_VIDEO:
-    {
-      gint width, height;
-      gboolean interlaced;
-
-      width = ffmpegdec->format.video.clip_width;
-      height = ffmpegdec->format.video.clip_height;
-      interlaced = ffmpegdec->format.video.interlaced;
-
-      if (width != -1 && height != -1) {
-        /* overwrite the output size with the dimension of the
-         * clipping region but only if they are smaller. */
-        if (width < ffmpegdec->context->width)
-          gst_caps_set_simple (caps, "width", G_TYPE_INT, width, NULL);
-        if (height < ffmpegdec->context->height)
-          gst_caps_set_simple (caps, "height", G_TYPE_INT, height, NULL);
-      }
-      gst_caps_set_simple (caps, "interlaced", G_TYPE_BOOLEAN, interlaced,
-          NULL);
-
-      /* If a demuxer provided a framerate then use it (#313970) */
-      if (ffmpegdec->format.video.fps_n != -1) {
-        gst_caps_set_simple (caps, "framerate",
-            GST_TYPE_FRACTION, ffmpegdec->format.video.fps_n,
-            ffmpegdec->format.video.fps_d, NULL);
-      }
-      gst_ffmpegdec_add_pixel_aspect_ratio (ffmpegdec,
-          gst_caps_get_structure (caps, 0));
-      break;
-    }
-    case AVMEDIA_TYPE_AUDIO:
-    {
-      break;
-    }
-    default:
-      break;
-  }
-
   if (!gst_pad_set_caps (ffmpegdec->srcpad, caps))
     goto caps_failed;
 
@@ -1358,284 +504,9 @@ caps_failed:
   }
 }
 
-/* perform qos calculations before decoding the next frame.
- *
- * Sets the skip_frame flag and if things are really bad, skips to the next
- * keyframe.
- * 
- * Returns TRUE if the frame should be decoded, FALSE if the frame can be dropped
- * entirely.
- */
-static gboolean
-gst_ffmpegdec_do_qos (GstFFMpegDec * ffmpegdec, GstClockTime timestamp,
-    gboolean * mode_switch)
-{
-  GstClockTimeDiff diff;
-  gdouble proportion;
-  GstClockTime qostime, earliest_time;
-  gboolean res = TRUE;
-
-  *mode_switch = FALSE;
-
-  /* no timestamp, can't do QoS */
-  if (G_UNLIKELY (!GST_CLOCK_TIME_IS_VALID (timestamp)))
-    goto no_qos;
-
-  /* get latest QoS observation values */
-  gst_ffmpegdec_read_qos (ffmpegdec, &proportion, &earliest_time);
-
-  /* skip qos if we have no observation (yet) */
-  if (G_UNLIKELY (!GST_CLOCK_TIME_IS_VALID (earliest_time))) {
-    /* no skip_frame initialy */
-    ffmpegdec->context->skip_frame = AVDISCARD_DEFAULT;
-    goto no_qos;
-  }
-
-  /* qos is done on running time of the timestamp */
-  qostime = gst_segment_to_running_time (&ffmpegdec->segment, GST_FORMAT_TIME,
-      timestamp);
-
-  /* timestamp can be out of segment, then we don't do QoS */
-  if (G_UNLIKELY (!GST_CLOCK_TIME_IS_VALID (qostime)))
-    goto no_qos;
-
-  /* see how our next timestamp relates to the latest qos timestamp. negative
-   * values mean we are early, positive values mean we are too late. */
-  diff = GST_CLOCK_DIFF (qostime, earliest_time);
-
-  GST_DEBUG_OBJECT (ffmpegdec, "QOS: qostime %" GST_TIME_FORMAT
-      ", earliest %" GST_TIME_FORMAT, GST_TIME_ARGS (qostime),
-      GST_TIME_ARGS (earliest_time));
-
-  /* if we using less than 40% of the available time, we can try to
-   * speed up again when we were slow. */
-  if (proportion < 0.4 && diff < 0) {
-    goto normal_mode;
-  } else {
-    if (diff >= 0) {
-      /* we're too slow, try to speed up */
-      if (ffmpegdec->waiting_for_key) {
-        /* we were waiting for a keyframe, that's ok */
-        goto skipping;
-      }
-      /* switch to skip_frame mode */
-      goto skip_frame;
-    }
-  }
-
-no_qos:
-  ffmpegdec->processed++;
-  return TRUE;
-
-skipping:
-  {
-    res = FALSE;
-    goto drop_qos;
-  }
-normal_mode:
-  {
-    if (ffmpegdec->context->skip_frame != AVDISCARD_DEFAULT) {
-      ffmpegdec->context->skip_frame = AVDISCARD_DEFAULT;
-      *mode_switch = TRUE;
-      GST_DEBUG_OBJECT (ffmpegdec, "QOS: normal mode %g < 0.4", proportion);
-    }
-    ffmpegdec->processed++;
-    return TRUE;
-  }
-skip_frame:
-  {
-    if (ffmpegdec->context->skip_frame != AVDISCARD_NONREF) {
-      ffmpegdec->context->skip_frame = AVDISCARD_NONREF;
-      *mode_switch = TRUE;
-      GST_DEBUG_OBJECT (ffmpegdec,
-          "QOS: hurry up, diff %" G_GINT64_FORMAT " >= 0", diff);
-    }
-    goto drop_qos;
-  }
-drop_qos:
-  {
-    GstClockTime stream_time, jitter;
-    GstMessage *qos_msg;
-
-    ffmpegdec->dropped++;
-    stream_time =
-        gst_segment_to_stream_time (&ffmpegdec->segment, GST_FORMAT_TIME,
-        timestamp);
-    jitter = GST_CLOCK_DIFF (qostime, earliest_time);
-    qos_msg =
-        gst_message_new_qos (GST_OBJECT_CAST (ffmpegdec), FALSE, qostime,
-        stream_time, timestamp, GST_CLOCK_TIME_NONE);
-    gst_message_set_qos_values (qos_msg, jitter, proportion, 1000000);
-    gst_message_set_qos_stats (qos_msg, GST_FORMAT_BUFFERS,
-        ffmpegdec->processed, ffmpegdec->dropped);
-    gst_element_post_message (GST_ELEMENT_CAST (ffmpegdec), qos_msg);
-
-    return res;
-  }
-}
-
-/* returns TRUE if buffer is within segment, else FALSE.
- * if Buffer is on segment border, it's timestamp and duration will be clipped */
-static gboolean
-clip_video_buffer (GstFFMpegDec * dec, GstBuffer * buf, GstClockTime in_ts,
-    GstClockTime in_dur)
-{
-  gboolean res = TRUE;
-  gint64 cstart, cstop;
-  GstClockTime stop;
-
-  GST_LOG_OBJECT (dec,
-      "timestamp:%" GST_TIME_FORMAT " , duration:%" GST_TIME_FORMAT,
-      GST_TIME_ARGS (in_ts), GST_TIME_ARGS (in_dur));
-
-  /* can't clip without TIME segment */
-  if (G_UNLIKELY (dec->segment.format != GST_FORMAT_TIME))
-    goto beach;
-
-  /* we need a start time */
-  if (G_UNLIKELY (!GST_CLOCK_TIME_IS_VALID (in_ts)))
-    goto beach;
-
-  /* generate valid stop, if duration unknown, we have unknown stop */
-  stop =
-      GST_CLOCK_TIME_IS_VALID (in_dur) ? (in_ts + in_dur) : GST_CLOCK_TIME_NONE;
-
-  /* now clip */
-  res =
-      gst_segment_clip (&dec->segment, GST_FORMAT_TIME, in_ts, stop, &cstart,
-      &cstop);
-  if (G_UNLIKELY (!res))
-    goto beach;
-
-  /* we're pretty sure the duration of this buffer is not till the end of this
-   * segment (which _clip will assume when the stop is -1) */
-  if (stop == GST_CLOCK_TIME_NONE)
-    cstop = GST_CLOCK_TIME_NONE;
-
-  /* update timestamp and possibly duration if the clipped stop time is
-   * valid */
-  GST_BUFFER_TIMESTAMP (buf) = cstart;
-  if (GST_CLOCK_TIME_IS_VALID (cstop))
-    GST_BUFFER_DURATION (buf) = cstop - cstart;
-
-  GST_LOG_OBJECT (dec,
-      "clipped timestamp:%" GST_TIME_FORMAT " , duration:%" GST_TIME_FORMAT,
-      GST_TIME_ARGS (cstart), GST_TIME_ARGS (GST_BUFFER_DURATION (buf)));
-
-beach:
-  GST_LOG_OBJECT (dec, "%sdropping", (res ? "not " : ""));
-  return res;
-}
-
-
-/* figure out if the current picture is a keyframe, return TRUE if that is
- * the case. */
-static gboolean
-check_keyframe (GstFFMpegDec * ffmpegdec)
-{
-  GstFFMpegDecClass *oclass;
-  gboolean is_itype = FALSE;
-  gboolean is_reference = FALSE;
-  gboolean iskeyframe;
-
-  /* figure out if we are dealing with a keyframe */
-  oclass = (GstFFMpegDecClass *) (G_OBJECT_GET_CLASS (ffmpegdec));
-
-  /* remember that we have B frames, we need this for the DTS -> PTS conversion
-   * code */
-  if (!ffmpegdec->has_b_frames && ffmpegdec->picture->pict_type == FF_B_TYPE) {
-    GST_DEBUG_OBJECT (ffmpegdec, "we have B frames");
-    ffmpegdec->has_b_frames = TRUE;
-  }
-
-  is_itype = (ffmpegdec->picture->pict_type == FF_I_TYPE);
-  is_reference = (ffmpegdec->picture->reference == 1);
-
-  iskeyframe = (is_itype || is_reference || ffmpegdec->picture->key_frame)
-      || (oclass->in_plugin->id == CODEC_ID_INDEO3)
-      || (oclass->in_plugin->id == CODEC_ID_MSZH)
-      || (oclass->in_plugin->id == CODEC_ID_ZLIB)
-      || (oclass->in_plugin->id == CODEC_ID_VP3)
-      || (oclass->in_plugin->id == CODEC_ID_HUFFYUV);
-
-  GST_LOG_OBJECT (ffmpegdec,
-      "current picture: type: %d, is_keyframe:%d, is_itype:%d, is_reference:%d",
-      ffmpegdec->picture->pict_type, iskeyframe, is_itype, is_reference);
-
-  return iskeyframe;
-}
-
-/* get an outbuf buffer with the current picture */
-static GstFlowReturn
-get_output_buffer (GstFFMpegDec * ffmpegdec, GstBuffer ** outbuf)
-{
-  GstFlowReturn ret;
-
-  ret = GST_FLOW_OK;
-  *outbuf = NULL;
-
-  if (ffmpegdec->picture->opaque != NULL) {
-    /* we allocated a picture already for ffmpeg to decode into, let's pick it
-     * up and use it now. */
-    *outbuf = (GstBuffer *) ffmpegdec->picture->opaque;
-    GST_LOG_OBJECT (ffmpegdec, "using opaque buffer %p", *outbuf);
-#ifndef EXTRA_REF
-    gst_buffer_ref (*outbuf);
-#endif
-  } else {
-    AVPicture pic, *outpic;
-    gint width, height;
-
-    GST_LOG_OBJECT (ffmpegdec, "get output buffer");
-
-    /* figure out size of output buffer, this is the clipped output size because
-     * we will copy the picture into it but only when the clipping region is
-     * smaller than the actual picture size. */
-    if ((width = ffmpegdec->format.video.clip_width) == -1)
-      width = ffmpegdec->context->width;
-    else if (width > ffmpegdec->context->width)
-      width = ffmpegdec->context->width;
-
-    if ((height = ffmpegdec->format.video.clip_height) == -1)
-      height = ffmpegdec->context->height;
-    else if (height > ffmpegdec->context->height)
-      height = ffmpegdec->context->height;
-
-    GST_LOG_OBJECT (ffmpegdec, "clip width %d/height %d", width, height);
-
-    ret = alloc_output_buffer (ffmpegdec, outbuf, width, height);
-    if (G_UNLIKELY (ret != GST_FLOW_OK))
-      goto alloc_failed;
-
-    /* original ffmpeg code does not handle odd sizes correctly.
-     * This patched up version does */
-    gst_ffmpeg_avpicture_fill (&pic, GST_BUFFER_DATA (*outbuf),
-        ffmpegdec->context->pix_fmt, width, height);
-
-    outpic = (AVPicture *) ffmpegdec->picture;
-
-    GST_LOG_OBJECT (ffmpegdec, "linsize %d %d %d", outpic->linesize[0],
-        outpic->linesize[1], outpic->linesize[2]);
-    GST_LOG_OBJECT (ffmpegdec, "data %u %u %u", 0,
-        (guint) (outpic->data[1] - outpic->data[0]),
-        (guint) (outpic->data[2] - outpic->data[0]));
-
-    av_picture_copy (&pic, outpic, ffmpegdec->context->pix_fmt, width, height);
-  }
-  ffmpegdec->picture->reordered_opaque = -1;
-
-  return ret;
-
-  /* special cases */
-alloc_failed:
-  {
-    GST_DEBUG_OBJECT (ffmpegdec, "pad_alloc failed");
-    return ret;
-  }
-}
 
 static void
-clear_queued (GstFFMpegDec * ffmpegdec)
+clear_queued (GstFFMpegAudDec * ffmpegdec)
 {
   g_list_foreach (ffmpegdec->queued, (GFunc) gst_mini_object_unref, NULL);
   g_list_free (ffmpegdec->queued);
@@ -1643,7 +514,7 @@ clear_queued (GstFFMpegDec * ffmpegdec)
 }
 
 static GstFlowReturn
-flush_queued (GstFFMpegDec * ffmpegdec)
+flush_queued (GstFFMpegAudDec * ffmpegdec)
 {
   GstFlowReturn res = GST_FLOW_OK;
 
@@ -1674,380 +545,10 @@ gst_avpacket_init (AVPacket * packet, guint8 * data, guint size)
   packet->size = size;
 }
 
-/* gst_ffmpegdec_[video|audio]_frame:
- * ffmpegdec:
- * data: pointer to the data to decode
- * size: size of data in bytes
- * in_timestamp: incoming timestamp.
- * in_duration: incoming duration.
- * in_offset: incoming offset (frame number).
- * outbuf: outgoing buffer. Different from NULL ONLY if it contains decoded data.
- * ret: Return flow.
- *
- * Returns: number of bytes used in decoding. The check for successful decode is
- *   outbuf being non-NULL.
- */
-static gint
-gst_ffmpegdec_video_frame (GstFFMpegDec * ffmpegdec,
-    guint8 * data, guint size,
-    const GstTSInfo * dec_info, GstBuffer ** outbuf, GstFlowReturn * ret)
-{
-  gint len = -1;
-  gint have_data;
-  gboolean iskeyframe;
-  gboolean mode_switch;
-  gboolean decode;
-  gint skip_frame = AVDISCARD_DEFAULT;
-  GstClockTime out_timestamp, out_duration, out_pts;
-  gint64 out_offset;
-  const GstTSInfo *out_info;
-  AVPacket packet;
-
-  *ret = GST_FLOW_OK;
-  *outbuf = NULL;
-
-  ffmpegdec->context->opaque = ffmpegdec;
-
-  /* in case we skip frames */
-  ffmpegdec->picture->pict_type = -1;
-
-  /* run QoS code, we don't stop decoding the frame when we are late because
-   * else we might skip a reference frame */
-  decode = gst_ffmpegdec_do_qos (ffmpegdec, dec_info->timestamp, &mode_switch);
-
-  if (ffmpegdec->is_realvideo && data != NULL) {
-    gint slice_count;
-    gint i;
-
-    /* setup the slice table for realvideo */
-    if (ffmpegdec->context->slice_offset == NULL)
-      ffmpegdec->context->slice_offset = g_malloc (sizeof (guint32) * 1000);
-
-    slice_count = (*data++) + 1;
-    ffmpegdec->context->slice_count = slice_count;
-
-    for (i = 0; i < slice_count; i++) {
-      data += 4;
-      ffmpegdec->context->slice_offset[i] = GST_READ_UINT32_LE (data);
-      data += 4;
-    }
-  }
-
-  if (!decode) {
-    /* no decoding needed, save previous skip_frame value and brutely skip
-     * decoding everything */
-    skip_frame = ffmpegdec->context->skip_frame;
-    ffmpegdec->context->skip_frame = AVDISCARD_NONREF;
-  }
-
-  /* save reference to the timing info */
-  ffmpegdec->context->reordered_opaque = (gint64) dec_info->idx;
-  ffmpegdec->picture->reordered_opaque = (gint64) dec_info->idx;
-
-  GST_DEBUG_OBJECT (ffmpegdec, "stored opaque values idx %d", dec_info->idx);
-
-  /* now decode the frame */
-  gst_avpacket_init (&packet, data, size);
-  len = avcodec_decode_video2 (ffmpegdec->context,
-      ffmpegdec->picture, &have_data, &packet);
-
-  /* restore previous state */
-  if (!decode)
-    ffmpegdec->context->skip_frame = skip_frame;
-
-  GST_DEBUG_OBJECT (ffmpegdec, "after decode: len %d, have_data %d",
-      len, have_data);
-
-  /* when we are in skip_frame mode, don't complain when ffmpeg returned
-   * no data because we told it to skip stuff. */
-  if (len < 0 && (mode_switch || ffmpegdec->context->skip_frame))
-    len = 0;
-
-  if (len > 0 && have_data <= 0 && (mode_switch
-          || ffmpegdec->context->skip_frame)) {
-    /* we consumed some bytes but nothing decoded and we are skipping frames,
-     * disable the interpollation of DTS timestamps */
-    ffmpegdec->last_out = -1;
-  }
-
-  /* no data, we're done */
-  if (len < 0 || have_data <= 0)
-    goto beach;
-
-  /* get the output picture timing info again */
-  out_info = gst_ts_info_get (ffmpegdec, ffmpegdec->picture->reordered_opaque);
-  out_pts = out_info->timestamp;
-  out_duration = out_info->duration;
-  out_offset = out_info->offset;
-
-  GST_DEBUG_OBJECT (ffmpegdec,
-      "pts %" G_GUINT64_FORMAT " duration %" G_GUINT64_FORMAT " offset %"
-      G_GINT64_FORMAT, out_pts, out_duration, out_offset);
-  GST_DEBUG_OBJECT (ffmpegdec, "picture: pts %" G_GUINT64_FORMAT,
-      (guint64) ffmpegdec->picture->pts);
-  GST_DEBUG_OBJECT (ffmpegdec, "picture: num %d",
-      ffmpegdec->picture->coded_picture_number);
-  GST_DEBUG_OBJECT (ffmpegdec, "picture: ref %d",
-      ffmpegdec->picture->reference);
-  GST_DEBUG_OBJECT (ffmpegdec, "picture: display %d",
-      ffmpegdec->picture->display_picture_number);
-  GST_DEBUG_OBJECT (ffmpegdec, "picture: opaque %p",
-      ffmpegdec->picture->opaque);
-  GST_DEBUG_OBJECT (ffmpegdec, "picture: reordered opaque %" G_GUINT64_FORMAT,
-      (guint64) ffmpegdec->picture->reordered_opaque);
-  GST_DEBUG_OBJECT (ffmpegdec, "repeat_pict:%d",
-      ffmpegdec->picture->repeat_pict);
-  GST_DEBUG_OBJECT (ffmpegdec, "interlaced_frame:%d",
-      ffmpegdec->picture->interlaced_frame);
-
-  if (G_UNLIKELY (ffmpegdec->picture->interlaced_frame !=
-          ffmpegdec->format.video.interlaced)) {
-    GST_WARNING ("Change in interlacing ! picture:%d, recorded:%d",
-        ffmpegdec->picture->interlaced_frame,
-        ffmpegdec->format.video.interlaced);
-    ffmpegdec->format.video.interlaced = ffmpegdec->picture->interlaced_frame;
-    gst_ffmpegdec_negotiate (ffmpegdec, TRUE);
-  }
-
-
-  /* Whether a frame is interlaced or not is unknown at the time of
-     buffer allocation, so caps on the buffer in opaque will have
-     the previous frame's interlaced flag set. So if interlacedness
-     has changed since allocation, we update the buffer (if any)
-     caps now with the correct interlaced flag. */
-  if (ffmpegdec->picture->opaque != NULL) {
-    GstBuffer *buffer = ffmpegdec->picture->opaque;
-    if (GST_BUFFER_CAPS (buffer) && GST_PAD_CAPS (ffmpegdec->srcpad)) {
-      GstStructure *s = gst_caps_get_structure (GST_BUFFER_CAPS (buffer), 0);
-      gboolean interlaced;
-      gboolean found = gst_structure_get_boolean (s, "interlaced", &interlaced);
-      if (!found || (!!interlaced != !!ffmpegdec->format.video.interlaced)) {
-        GST_DEBUG_OBJECT (ffmpegdec,
-            "Buffer interlacing does not match pad, updating");
-        buffer = gst_buffer_make_metadata_writable (buffer);
-        gst_buffer_set_caps (buffer, GST_PAD_CAPS (ffmpegdec->srcpad));
-        ffmpegdec->picture->opaque = buffer;
-      }
-    }
-  }
-
-  /* check if we are dealing with a keyframe here, this will also check if we
-   * are dealing with B frames. */
-  iskeyframe = check_keyframe (ffmpegdec);
-
-  /* check that the timestamps go upwards */
-  if (ffmpegdec->last_out != -1 && ffmpegdec->last_out > out_pts) {
-    /* timestamps go backwards, this means frames were reordered and we must
-     * be dealing with DTS as the buffer timestamps */
-    if (!ffmpegdec->reordered_out) {
-      GST_DEBUG_OBJECT (ffmpegdec, "detected reordered out timestamps");
-      ffmpegdec->reordered_out = TRUE;
-    }
-    if (ffmpegdec->reordered_in) {
-      /* we reset the input reordering here because we want to recover from an
-       * occasionally wrong reordered input timestamp */
-      GST_DEBUG_OBJECT (ffmpegdec, "assuming DTS input timestamps");
-      ffmpegdec->reordered_in = FALSE;
-    }
-  }
-
-  if (out_pts == 0 && out_pts == ffmpegdec->last_out) {
-    GST_LOG_OBJECT (ffmpegdec, "ffmpeg returns 0 timestamps, ignoring");
-    /* some codecs only output 0 timestamps, when that happens, make us select an
-     * output timestamp based on the input timestamp. We do this by making the
-     * ffmpeg timestamp and the interpollated next timestamp invalid. */
-    out_pts = -1;
-    ffmpegdec->next_out = -1;
-  } else
-    ffmpegdec->last_out = out_pts;
-
-  /* we assume DTS as input timestamps unless we see reordered input
-   * timestamps */
-  if (!ffmpegdec->reordered_in && ffmpegdec->reordered_out) {
-    /* PTS and DTS are the same for keyframes */
-    if (!iskeyframe && ffmpegdec->next_out != -1) {
-      /* interpolate all timestamps except for keyframes, FIXME, this is
-       * wrong when QoS is active. */
-      GST_DEBUG_OBJECT (ffmpegdec, "interpolate timestamps");
-      out_pts = -1;
-      out_offset = -1;
-    }
-  }
-
-  /* when we're waiting for a keyframe, see if we have one or drop the current
-   * non-keyframe */
-  if (G_UNLIKELY (ffmpegdec->waiting_for_key)) {
-    if (G_LIKELY (!iskeyframe))
-      goto drop_non_keyframe;
-
-    /* we have a keyframe, we can stop waiting for one */
-    ffmpegdec->waiting_for_key = FALSE;
-  }
-
-  /* get a handle to the output buffer */
-  *ret = get_output_buffer (ffmpegdec, outbuf);
-  if (G_UNLIKELY (*ret != GST_FLOW_OK))
-    goto no_output;
-
-  /*
-   * Timestamps:
-   *
-   *  1) Copy picture timestamp if valid
-   *  2) else interpolate from previous output timestamp
-   *  3) else copy input timestamp
-   */
-  out_timestamp = -1;
-  if (out_pts != -1) {
-    /* Get (interpolated) timestamp from FFMPEG */
-    out_timestamp = (GstClockTime) out_pts;
-    GST_LOG_OBJECT (ffmpegdec, "using timestamp %" GST_TIME_FORMAT
-        " returned by ffmpeg", GST_TIME_ARGS (out_timestamp));
-  }
-  if (!GST_CLOCK_TIME_IS_VALID (out_timestamp) && ffmpegdec->next_out != -1) {
-    out_timestamp = ffmpegdec->next_out;
-    GST_LOG_OBJECT (ffmpegdec, "using next timestamp %" GST_TIME_FORMAT,
-        GST_TIME_ARGS (out_timestamp));
-  }
-  if (!GST_CLOCK_TIME_IS_VALID (out_timestamp)) {
-    out_timestamp = dec_info->timestamp;
-    GST_LOG_OBJECT (ffmpegdec, "using in timestamp %" GST_TIME_FORMAT,
-        GST_TIME_ARGS (out_timestamp));
-  }
-  GST_BUFFER_TIMESTAMP (*outbuf) = out_timestamp;
-
-  /*
-   * Offset:
-   *  0) Use stored input offset (from opaque)
-   *  1) Use value converted from timestamp if valid
-   *  2) Use input offset if valid
-   */
-  if (out_offset != GST_BUFFER_OFFSET_NONE) {
-    /* out_offset already contains the offset from ts_info */
-    GST_LOG_OBJECT (ffmpegdec, "Using offset returned by ffmpeg");
-  } else if (out_timestamp != GST_CLOCK_TIME_NONE) {
-    GstFormat out_fmt = GST_FORMAT_DEFAULT;
-    GST_LOG_OBJECT (ffmpegdec, "Using offset converted from timestamp");
-    /* FIXME, we should really remove this as it's not nice at all to do
-     * upstream queries for each frame to get the frame offset. We also can't
-     * really remove this because it is the only way of setting frame offsets
-     * on outgoing buffers. We should have metadata so that the upstream peer
-     * can set a frame number on the encoded data. */
-    gst_pad_query_peer_convert (ffmpegdec->sinkpad,
-        GST_FORMAT_TIME, out_timestamp, &out_fmt, &out_offset);
-  } else if (dec_info->offset != GST_BUFFER_OFFSET_NONE) {
-    /* FIXME, the input offset is input media specific and might not
-     * be the same for the output media. (byte offset as input, frame number
-     * as output, for example) */
-    GST_LOG_OBJECT (ffmpegdec, "using in_offset %" G_GINT64_FORMAT,
-        dec_info->offset);
-    out_offset = dec_info->offset;
-  } else {
-    GST_LOG_OBJECT (ffmpegdec, "no valid offset found");
-    out_offset = GST_BUFFER_OFFSET_NONE;
-  }
-  GST_BUFFER_OFFSET (*outbuf) = out_offset;
-
-  /*
-   * Duration:
-   *
-   *  1) Use reordered input duration if valid
-   *  2) Else use input duration
-   *  3) else use input framerate
-   *  4) else use ffmpeg framerate
-   */
-  if (GST_CLOCK_TIME_IS_VALID (out_duration)) {
-    /* We have a valid (reordered) duration */
-    GST_LOG_OBJECT (ffmpegdec, "Using duration returned by ffmpeg");
-  } else if (GST_CLOCK_TIME_IS_VALID (dec_info->duration)) {
-    GST_LOG_OBJECT (ffmpegdec, "using in_duration");
-    out_duration = dec_info->duration;
-  } else if (GST_CLOCK_TIME_IS_VALID (ffmpegdec->last_diff)) {
-    GST_LOG_OBJECT (ffmpegdec, "using last-diff");
-    out_duration = ffmpegdec->last_diff;
-  } else {
-    /* if we have an input framerate, use that */
-    if (ffmpegdec->format.video.fps_n != -1 &&
-        (ffmpegdec->format.video.fps_n != 1000 &&
-            ffmpegdec->format.video.fps_d != 1)) {
-      GST_LOG_OBJECT (ffmpegdec, "using input framerate for duration");
-      out_duration = gst_util_uint64_scale_int (GST_SECOND,
-          ffmpegdec->format.video.fps_d, ffmpegdec->format.video.fps_n);
-    } else {
-      /* don't try to use the decoder's framerate when it seems a bit abnormal,
-       * which we assume when den >= 1000... */
-      if (ffmpegdec->context->time_base.num != 0 &&
-          (ffmpegdec->context->time_base.den > 0 &&
-              ffmpegdec->context->time_base.den < 1000)) {
-        GST_LOG_OBJECT (ffmpegdec, "using decoder's framerate for duration");
-        out_duration = gst_util_uint64_scale_int (GST_SECOND,
-            ffmpegdec->context->time_base.num *
-            ffmpegdec->context->ticks_per_frame,
-            ffmpegdec->context->time_base.den);
-      } else {
-        GST_LOG_OBJECT (ffmpegdec, "no valid duration found");
-      }
-    }
-  }
-
-  /* Take repeat_pict into account */
-  if (GST_CLOCK_TIME_IS_VALID (out_duration)) {
-    out_duration += out_duration * ffmpegdec->picture->repeat_pict / 2;
-  }
-  GST_BUFFER_DURATION (*outbuf) = out_duration;
-
-  if (out_timestamp != -1 && out_duration != -1 && out_duration != 0)
-    ffmpegdec->next_out = out_timestamp + out_duration;
-  else
-    ffmpegdec->next_out = -1;
-
-  /* palette is not part of raw video frame in gst and the size
-   * of the outgoing buffer needs to be adjusted accordingly */
-  if (ffmpegdec->context->palctrl != NULL)
-    GST_BUFFER_SIZE (*outbuf) -= AVPALETTE_SIZE;
-
-  /* now see if we need to clip the buffer against the segment boundaries. */
-  if (G_UNLIKELY (!clip_video_buffer (ffmpegdec, *outbuf, out_timestamp,
-              out_duration)))
-    goto clipped;
-
-  /* mark as keyframe or delta unit */
-  if (!iskeyframe)
-    GST_BUFFER_FLAG_SET (*outbuf, GST_BUFFER_FLAG_DELTA_UNIT);
-
-  if (ffmpegdec->picture->top_field_first)
-    GST_BUFFER_FLAG_SET (*outbuf, GST_VIDEO_BUFFER_TFF);
-
-
-beach:
-  GST_DEBUG_OBJECT (ffmpegdec, "return flow %d, out %p, len %d",
-      *ret, *outbuf, len);
-  return len;
-
-  /* special cases */
-drop_non_keyframe:
-  {
-    GST_WARNING_OBJECT (ffmpegdec, "Dropping non-keyframe (seek/init)");
-    goto beach;
-  }
-no_output:
-  {
-    GST_DEBUG_OBJECT (ffmpegdec, "no output buffer");
-    len = -1;
-    goto beach;
-  }
-clipped:
-  {
-    GST_DEBUG_OBJECT (ffmpegdec, "buffer clipped");
-    gst_buffer_unref (*outbuf);
-    *outbuf = NULL;
-    goto beach;
-  }
-}
-
 /* returns TRUE if buffer is within segment, else FALSE.
  * if Buffer is on segment border, it's timestamp and duration will be clipped */
 static gboolean
-clip_audio_buffer (GstFFMpegDec * dec, GstBuffer * buf, GstClockTime in_ts,
+clip_audio_buffer (GstFFMpegAudDec * dec, GstBuffer * buf, GstClockTime in_ts,
     GstClockTime in_dur)
 {
   GstClockTime stop;
@@ -2115,7 +616,7 @@ out_of_segment:
 }
 
 static gint
-gst_ffmpegdec_audio_frame (GstFFMpegDec * ffmpegdec,
+gst_ffmpegauddec_audio_frame (GstFFMpegAudDec * ffmpegdec,
     AVCodec * in_plugin, guint8 * data, guint size,
     const GstTSInfo * dec_info, GstBuffer ** outbuf, GstFlowReturn * ret)
 {
@@ -2143,7 +644,7 @@ gst_ffmpegdec_audio_frame (GstFFMpegDec * ffmpegdec,
 
   if (len >= 0 && have_data > 0) {
     GST_DEBUG_OBJECT (ffmpegdec, "Creating output buffer");
-    if (!gst_ffmpegdec_negotiate (ffmpegdec, FALSE)) {
+    if (!gst_ffmpegauddec_negotiate (ffmpegdec, FALSE)) {
       gst_buffer_unref (*outbuf);
       *outbuf = NULL;
       len = -1;
@@ -2229,7 +730,7 @@ clipped:
   }
 }
 
-/* gst_ffmpegdec_frame:
+/* gst_ffmpegauddec_frame:
  * ffmpegdec:
  * data: pointer to the data to decode
  * size: size of data in bytes
@@ -2244,11 +745,11 @@ clipped:
  */
 
 static gint
-gst_ffmpegdec_frame (GstFFMpegDec * ffmpegdec,
+gst_ffmpegauddec_frame (GstFFMpegAudDec * ffmpegdec,
     guint8 * data, guint size, gint * got_data, const GstTSInfo * dec_info,
     GstFlowReturn * ret)
 {
-  GstFFMpegDecClass *oclass;
+  GstFFMpegAudDecClass *oclass;
   GstBuffer *outbuf = NULL;
   gint have_data = 0, len = 0;
 
@@ -2261,31 +762,18 @@ gst_ffmpegdec_frame (GstFFMpegDec * ffmpegdec,
   *ret = GST_FLOW_OK;
   ffmpegdec->context->frame_number++;
 
-  oclass = (GstFFMpegDecClass *) (G_OBJECT_GET_CLASS (ffmpegdec));
+  oclass = (GstFFMpegAudDecClass *) (G_OBJECT_GET_CLASS (ffmpegdec));
 
-  switch (oclass->in_plugin->type) {
-    case AVMEDIA_TYPE_VIDEO:
-      len =
-          gst_ffmpegdec_video_frame (ffmpegdec, data, size, dec_info, &outbuf,
-          ret);
-      break;
-    case AVMEDIA_TYPE_AUDIO:
-      len =
-          gst_ffmpegdec_audio_frame (ffmpegdec, oclass->in_plugin, data, size,
-          dec_info, &outbuf, ret);
-
-      /* if we did not get an output buffer and we have a pending discont, don't
-       * clear the input timestamps, we will put them on the next buffer because
-       * else we might create the first buffer with a very big timestamp gap. */
-      if (outbuf == NULL && ffmpegdec->discont) {
-        GST_DEBUG_OBJECT (ffmpegdec, "no buffer but keeping timestamp");
-        ffmpegdec->clear_ts = FALSE;
-      }
-      break;
-    default:
-      GST_ERROR_OBJECT (ffmpegdec, "Asked to decode non-audio/video frame !");
-      g_assert_not_reached ();
-      break;
+  len =
+      gst_ffmpegauddec_audio_frame (ffmpegdec, oclass->in_plugin, data, size,
+      dec_info, &outbuf, ret);
+
+  /* if we did not get an output buffer and we have a pending discont, don't
+   * clear the input timestamps, we will put them on the next buffer because
+   * else we might create the first buffer with a very big timestamp gap. */
+  if (outbuf == NULL && ffmpegdec->discont) {
+    GST_DEBUG_OBJECT (ffmpegdec, "no buffer but keeping timestamp");
+    ffmpegdec->clear_ts = FALSE;
   }
 
   if (outbuf)
@@ -2344,11 +832,11 @@ no_codec:
 }
 
 static void
-gst_ffmpegdec_drain (GstFFMpegDec * ffmpegdec)
+gst_ffmpegauddec_drain (GstFFMpegAudDec * ffmpegdec)
 {
-  GstFFMpegDecClass *oclass;
+  GstFFMpegAudDecClass *oclass;
 
-  oclass = (GstFFMpegDecClass *) (G_OBJECT_GET_CLASS (ffmpegdec));
+  oclass = (GstFFMpegAudDecClass *) (G_OBJECT_GET_CLASS (ffmpegdec));
 
   if (oclass->in_plugin->capabilities & CODEC_CAP_DELAY) {
     gint have_data, len, try = 0;
@@ -2360,7 +848,7 @@ gst_ffmpegdec_drain (GstFFMpegDec * ffmpegdec)
       GstFlowReturn ret;
 
       len =
-          gst_ffmpegdec_frame (ffmpegdec, NULL, 0, &have_data, &ts_info_none,
+          gst_ffmpegauddec_frame (ffmpegdec, NULL, 0, &have_data, &ts_info_none,
           &ret);
       if (len < 0 || have_data == 0)
         break;
@@ -2373,7 +861,7 @@ gst_ffmpegdec_drain (GstFFMpegDec * ffmpegdec)
 }
 
 static void
-gst_ffmpegdec_flush_pcache (GstFFMpegDec * ffmpegdec)
+gst_ffmpegauddec_flush_pcache (GstFFMpegAudDec * ffmpegdec)
 {
   if (ffmpegdec->pctx) {
     gint size, bsize;
@@ -2398,12 +886,12 @@ gst_ffmpegdec_flush_pcache (GstFFMpegDec * ffmpegdec)
 }
 
 static gboolean
-gst_ffmpegdec_sink_event (GstPad * pad, GstEvent * event)
+gst_ffmpegauddec_sink_event (GstPad * pad, GstEvent * event)
 {
-  GstFFMpegDec *ffmpegdec;
+  GstFFMpegAudDec *ffmpegdec;
   gboolean ret = FALSE;
 
-  ffmpegdec = (GstFFMpegDec *) gst_pad_get_parent (pad);
+  ffmpegdec = (GstFFMpegAudDec *) gst_pad_get_parent (pad);
 
   GST_DEBUG_OBJECT (ffmpegdec, "Handling %s event",
       GST_EVENT_TYPE_NAME (event));
@@ -2411,7 +899,7 @@ gst_ffmpegdec_sink_event (GstPad * pad, GstEvent * event)
   switch (GST_EVENT_TYPE (event)) {
     case GST_EVENT_EOS:
     {
-      gst_ffmpegdec_drain (ffmpegdec);
+      gst_ffmpegauddec_drain (ffmpegdec);
       break;
     }
     case GST_EVENT_FLUSH_STOP:
@@ -2419,10 +907,8 @@ gst_ffmpegdec_sink_event (GstPad * pad, GstEvent * event)
       if (ffmpegdec->opened) {
         avcodec_flush_buffers (ffmpegdec->context);
       }
-      gst_ffmpegdec_reset_ts (ffmpegdec);
-      gst_ffmpegdec_reset_qos (ffmpegdec);
-      gst_ffmpegdec_flush_pcache (ffmpegdec);
-      ffmpegdec->waiting_for_key = TRUE;
+      gst_ffmpegauddec_reset_ts (ffmpegdec);
+      gst_ffmpegauddec_flush_pcache (ffmpegdec);
       gst_segment_init (&ffmpegdec->segment, GST_FORMAT_TIME);
       clear_queued (ffmpegdec);
       break;
@@ -2481,7 +967,7 @@ gst_ffmpegdec_sink_event (GstPad * pad, GstEvent * event)
       /* drain pending frames before trying to use the new segment, queued
        * buffers belonged to the previous segment. */
       if (ffmpegdec->context->codec)
-        gst_ffmpegdec_drain (ffmpegdec);
+        gst_ffmpegauddec_drain (ffmpegdec);
 
       GST_DEBUG_OBJECT (ffmpegdec,
           "NEWSEGMENT in time start %" GST_TIME_FORMAT " -- stop %"
@@ -2520,10 +1006,10 @@ invalid_format:
 }
 
 static GstFlowReturn
-gst_ffmpegdec_chain (GstPad * pad, GstBuffer * inbuf)
+gst_ffmpegauddec_chain (GstPad * pad, GstBuffer * inbuf)
 {
-  GstFFMpegDec *ffmpegdec;
-  GstFFMpegDecClass *oclass;
+  GstFFMpegAudDec *ffmpegdec;
+  GstFFMpegAudDecClass *oclass;
   guint8 *data, *bdata;
   gint size, bsize, len, have_data;
   GstFlowReturn ret = GST_FLOW_OK;
@@ -2534,7 +1020,7 @@ gst_ffmpegdec_chain (GstPad * pad, GstBuffer * inbuf)
   const GstTSInfo *in_info;
   const GstTSInfo *dec_info;
 
-  ffmpegdec = (GstFFMpegDec *) (GST_PAD_PARENT (pad));
+  ffmpegdec = (GstFFMpegAudDec *) (GST_PAD_PARENT (pad));
 
   if (G_UNLIKELY (!ffmpegdec->opened))
     goto not_negotiated;
@@ -2542,35 +1028,24 @@ gst_ffmpegdec_chain (GstPad * pad, GstBuffer * inbuf)
   discont = GST_BUFFER_IS_DISCONT (inbuf);
 
   /* The discont flags marks a buffer that is not continuous with the previous
-   * buffer. This means we need to clear whatever data we currently have. We
-   * currently also wait for a new keyframe, which might be suboptimal in the
-   * case of a network error, better show the errors than to drop all data.. */
+   * buffer. This means we need to clear whatever data we currently have. We let
+   * ffmpeg continue with the data that it has. We currently drain the old
+   * frames that might be inside the decoder and we clear any partial data in
+   * the pcache, we might be able to remove the drain and flush too. */
   if (G_UNLIKELY (discont)) {
     GST_DEBUG_OBJECT (ffmpegdec, "received DISCONT");
     /* drain what we have queued */
-    gst_ffmpegdec_drain (ffmpegdec);
-    gst_ffmpegdec_flush_pcache (ffmpegdec);
-    avcodec_flush_buffers (ffmpegdec->context);
+    gst_ffmpegauddec_drain (ffmpegdec);
+    gst_ffmpegauddec_flush_pcache (ffmpegdec);
     ffmpegdec->discont = TRUE;
-    gst_ffmpegdec_reset_ts (ffmpegdec);
+    gst_ffmpegauddec_reset_ts (ffmpegdec);
   }
   /* by default we clear the input timestamp after decoding each frame so that
    * interpollation can work. */
   ffmpegdec->clear_ts = TRUE;
 
-  oclass = (GstFFMpegDecClass *) (G_OBJECT_GET_CLASS (ffmpegdec));
-
-  /* do early keyframe check pretty bad to rely on the keyframe flag in the
-   * source for this as it might not even be parsed (UDP/file/..).  */
-  if (G_UNLIKELY (ffmpegdec->waiting_for_key)) {
-    GST_DEBUG_OBJECT (ffmpegdec, "waiting for keyframe");
-    if (GST_BUFFER_FLAG_IS_SET (inbuf, GST_BUFFER_FLAG_DELTA_UNIT) &&
-        oclass->in_plugin->type != AVMEDIA_TYPE_AUDIO)
-      goto skip_keyframe;
+  oclass = (GstFFMpegAudDecClass *) (G_OBJECT_GET_CLASS (ffmpegdec));
 
-    GST_DEBUG_OBJECT (ffmpegdec, "got keyframe");
-    ffmpegdec->waiting_for_key = FALSE;
-  }
   /* parse cache joining. If there is cached data */
   if (ffmpegdec->pcache) {
     /* join with previous data */
@@ -2587,32 +1062,6 @@ gst_ffmpegdec_chain (GstPad * pad, GstBuffer * inbuf)
   /* get handle to timestamp info, we can pass this around to ffmpeg */
   in_info = gst_ts_info_store (ffmpegdec, in_timestamp, in_duration, in_offset);
 
-  if (in_timestamp != -1) {
-    /* check for increasing timestamps if they are jumping backwards, we
-     * probably are dealing with PTS as timestamps */
-    if (!ffmpegdec->reordered_in && ffmpegdec->last_in != -1) {
-      if (in_timestamp < ffmpegdec->last_in) {
-        GST_LOG_OBJECT (ffmpegdec, "detected reordered input timestamps");
-        ffmpegdec->reordered_in = TRUE;
-        ffmpegdec->last_diff = GST_CLOCK_TIME_NONE;
-      } else if (in_timestamp > ffmpegdec->last_in) {
-        GstClockTime diff;
-        /* keep track of timestamp diff to estimate duration */
-        diff = in_timestamp - ffmpegdec->last_in;
-        /* need to scale with amount of frames in the interval */
-        if (ffmpegdec->last_frames)
-          diff /= ffmpegdec->last_frames;
-
-        GST_LOG_OBJECT (ffmpegdec, "estimated duration %" GST_TIME_FORMAT " %u",
-            GST_TIME_ARGS (diff), ffmpegdec->last_frames);
-
-        ffmpegdec->last_diff = diff;
-      }
-    }
-    ffmpegdec->last_in = in_timestamp;
-    ffmpegdec->last_frames = 0;
-  }
-
   GST_LOG_OBJECT (ffmpegdec,
       "Received new data of size %u, offset:%" G_GUINT64_FORMAT ", ts:%"
       GST_TIME_FORMAT ", dur:%" GST_TIME_FORMAT ", info %d",
@@ -2631,23 +1080,7 @@ gst_ffmpegdec_chain (GstPad * pad, GstBuffer * inbuf)
   bdata = GST_BUFFER_DATA (inbuf);
   bsize = GST_BUFFER_SIZE (inbuf);
 
-  if (ffmpegdec->do_padding) {
-    /* add padding */
-    if (ffmpegdec->padded_size < bsize + FF_INPUT_BUFFER_PADDING_SIZE) {
-      ffmpegdec->padded_size = bsize + FF_INPUT_BUFFER_PADDING_SIZE;
-      ffmpegdec->padded = g_realloc (ffmpegdec->padded, ffmpegdec->padded_size);
-      GST_LOG_OBJECT (ffmpegdec, "resized padding buffer to %d",
-          ffmpegdec->padded_size);
-    }
-    memcpy (ffmpegdec->padded, bdata, bsize);
-    memset (ffmpegdec->padded + bsize, 0, FF_INPUT_BUFFER_PADDING_SIZE);
-
-    bdata = ffmpegdec->padded;
-  }
-
   do {
-    guint8 tmp_padding[FF_INPUT_BUFFER_PADDING_SIZE];
-
     /* parse, if at all possible */
     if (ffmpegdec->pctx) {
       gint res;
@@ -2705,19 +1138,10 @@ gst_ffmpegdec_chain (GstPad * pad, GstBuffer * inbuf)
       dec_info = in_info;
     }
 
-    if (ffmpegdec->do_padding) {
-      /* add temporary padding */
-      memcpy (tmp_padding, data + size, FF_INPUT_BUFFER_PADDING_SIZE);
-      memset (data + size, 0, FF_INPUT_BUFFER_PADDING_SIZE);
-    }
-
     /* decode a frame of audio/video now */
     len =
-        gst_ffmpegdec_frame (ffmpegdec, data, size, &have_data, dec_info, &ret);
-
-    if (ffmpegdec->do_padding) {
-      memcpy (data + size, tmp_padding, FF_INPUT_BUFFER_PADDING_SIZE);
-    }
+        gst_ffmpegauddec_frame (ffmpegdec, data, size, &have_data, dec_info,
+        &ret);
 
     if (ret != GST_FLOW_OK) {
       GST_LOG_OBJECT (ffmpegdec, "breaking because of flow ret %s",
@@ -2767,7 +1191,6 @@ gst_ffmpegdec_chain (GstPad * pad, GstBuffer * inbuf)
     } else {
       ffmpegdec->clear_ts = TRUE;
     }
-    ffmpegdec->last_frames++;
 
     GST_LOG_OBJECT (ffmpegdec, "Before (while bsize>0).  bsize:%d , bdata:%p",
         bsize, bdata);
@@ -2798,25 +1221,19 @@ gst_ffmpegdec_chain (GstPad * pad, GstBuffer * inbuf)
   /* ERRORS */
 not_negotiated:
   {
-    oclass = (GstFFMpegDecClass *) (G_OBJECT_GET_CLASS (ffmpegdec));
+    oclass = (GstFFMpegAudDecClass *) (G_OBJECT_GET_CLASS (ffmpegdec));
     GST_ELEMENT_ERROR (ffmpegdec, CORE, NEGOTIATION, (NULL),
         ("ffdec_%s: input format was not set before data start",
             oclass->in_plugin->name));
     gst_buffer_unref (inbuf);
     return GST_FLOW_NOT_NEGOTIATED;
   }
-skip_keyframe:
-  {
-    GST_DEBUG_OBJECT (ffmpegdec, "skipping non keyframe");
-    gst_buffer_unref (inbuf);
-    return GST_FLOW_OK;
-  }
 }
 
 static GstStateChangeReturn
-gst_ffmpegdec_change_state (GstElement * element, GstStateChange transition)
+gst_ffmpegauddec_change_state (GstElement * element, GstStateChange transition)
 {
-  GstFFMpegDec *ffmpegdec = (GstFFMpegDec *) element;
+  GstFFMpegAudDec *ffmpegdec = (GstFFMpegAudDec *) element;
   GstStateChangeReturn ret;
 
   ret = GST_ELEMENT_CLASS (parent_class)->change_state (element, transition);
@@ -2824,13 +1241,9 @@ gst_ffmpegdec_change_state (GstElement * element, GstStateChange transition)
   switch (transition) {
     case GST_STATE_CHANGE_PAUSED_TO_READY:
       GST_OBJECT_LOCK (ffmpegdec);
-      gst_ffmpegdec_close (ffmpegdec);
+      gst_ffmpegauddec_close (ffmpegdec);
       GST_OBJECT_UNLOCK (ffmpegdec);
       clear_queued (ffmpegdec);
-      g_free (ffmpegdec->padded);
-      ffmpegdec->padded = NULL;
-      ffmpegdec->padded_size = 0;
-      ffmpegdec->can_allocate_aligned = TRUE;
       break;
     default:
       break;
@@ -2839,89 +1252,19 @@ gst_ffmpegdec_change_state (GstElement * element, GstStateChange transition)
   return ret;
 }
 
-static void
-gst_ffmpegdec_set_property (GObject * object,
-    guint prop_id, const GValue * value, GParamSpec * pspec)
-{
-  GstFFMpegDec *ffmpegdec = (GstFFMpegDec *) object;
-
-  switch (prop_id) {
-    case PROP_LOWRES:
-      ffmpegdec->lowres = ffmpegdec->context->lowres = g_value_get_enum (value);
-      break;
-    case PROP_SKIPFRAME:
-      ffmpegdec->skip_frame = ffmpegdec->context->skip_frame =
-          g_value_get_enum (value);
-      break;
-    case PROP_DIRECT_RENDERING:
-      ffmpegdec->direct_rendering = g_value_get_boolean (value);
-      break;
-    case PROP_DO_PADDING:
-      ffmpegdec->do_padding = g_value_get_boolean (value);
-      break;
-    case PROP_DEBUG_MV:
-      ffmpegdec->debug_mv = ffmpegdec->context->debug_mv =
-          g_value_get_boolean (value);
-      break;
-    case PROP_CROP:
-      ffmpegdec->crop = g_value_get_boolean (value);
-      break;
-    case PROP_MAX_THREADS:
-      ffmpegdec->max_threads = g_value_get_int (value);
-      break;
-    default:
-      G_OBJECT_WARN_INVALID_PROPERTY_ID (object, prop_id, pspec);
-      break;
-  }
-}
-
-static void
-gst_ffmpegdec_get_property (GObject * object,
-    guint prop_id, GValue * value, GParamSpec * pspec)
-{
-  GstFFMpegDec *ffmpegdec = (GstFFMpegDec *) object;
-
-  switch (prop_id) {
-    case PROP_LOWRES:
-      g_value_set_enum (value, ffmpegdec->context->lowres);
-      break;
-    case PROP_SKIPFRAME:
-      g_value_set_enum (value, ffmpegdec->context->skip_frame);
-      break;
-    case PROP_DIRECT_RENDERING:
-      g_value_set_boolean (value, ffmpegdec->direct_rendering);
-      break;
-    case PROP_DO_PADDING:
-      g_value_set_boolean (value, ffmpegdec->do_padding);
-      break;
-    case PROP_DEBUG_MV:
-      g_value_set_boolean (value, ffmpegdec->context->debug_mv);
-      break;
-    case PROP_CROP:
-      g_value_set_boolean (value, ffmpegdec->crop);
-      break;
-    case PROP_MAX_THREADS:
-      g_value_set_int (value, ffmpegdec->max_threads);
-      break;
-    default:
-      G_OBJECT_WARN_INVALID_PROPERTY_ID (object, prop_id, pspec);
-      break;
-  }
-}
-
 gboolean
-gst_ffmpegdec_register (GstPlugin * plugin)
+gst_ffmpegauddec_register (GstPlugin * plugin)
 {
   GTypeInfo typeinfo = {
-    sizeof (GstFFMpegDecClass),
-    (GBaseInitFunc) gst_ffmpegdec_base_init,
+    sizeof (GstFFMpegAudDecClass),
+    (GBaseInitFunc) gst_ffmpegauddec_base_init,
     NULL,
-    (GClassInitFunc) gst_ffmpegdec_class_init,
+    (GClassInitFunc) gst_ffmpegauddec_class_init,
     NULL,
     NULL,
-    sizeof (GstFFMpegDec),
+    sizeof (GstFFMpegAudDec),
     0,
-    (GInstanceInitFunc) gst_ffmpegdec_init,
+    (GInstanceInitFunc) gst_ffmpegauddec_init,
   };
   GType type;
   AVCodec *in_plugin;
@@ -2936,17 +1279,13 @@ gst_ffmpegdec_register (GstPlugin * plugin)
     gchar *plugin_name;
 
     /* only decoders */
-    if (!in_plugin->decode) {
+    if (!in_plugin->decode || in_plugin->type != AVMEDIA_TYPE_AUDIO) {
       goto next;
     }
 
     /* no quasi-codecs, please */
-    if (in_plugin->id == CODEC_ID_RAWVIDEO ||
-        in_plugin->id == CODEC_ID_V210 ||
-        in_plugin->id == CODEC_ID_V210X ||
-        in_plugin->id == CODEC_ID_R210 ||
-        (in_plugin->id >= CODEC_ID_PCM_S16LE &&
-            in_plugin->id <= CODEC_ID_PCM_BLURAY)) {
+    if (in_plugin->id >= CODEC_ID_PCM_S16LE &&
+        in_plugin->id <= CODEC_ID_PCM_BLURAY) {
       goto next;
     }
 
@@ -2960,33 +1299,13 @@ gst_ffmpegdec_register (GstPlugin * plugin)
       goto next;
     }
 
-    /* No vdpau plugins until we can figure out how to properly use them
-     * outside of ffmpeg. */
-    if (g_str_has_suffix (in_plugin->name, "_vdpau")) {
-      GST_DEBUG
-          ("Ignoring VDPAU decoder %s. We can't handle this outside of ffmpeg",
-          in_plugin->name);
-      goto next;
-    }
-
-    if (g_str_has_suffix (in_plugin->name, "_xvmc")) {
-      GST_DEBUG
-          ("Ignoring XVMC decoder %s. We can't handle this outside of ffmpeg",
-          in_plugin->name);
-      goto next;
-    }
-
     GST_DEBUG ("Trying plugin %s [%s]", in_plugin->name, in_plugin->long_name);
 
     /* no codecs for which we're GUARANTEED to have better alternatives */
-    /* MPEG1VIDEO : the mpeg2video decoder is preferred */
     /* MP1 : Use MP3 for decoding */
     /* MP2 : Use MP3 for decoding */
     /* Theora: Use libtheora based theoradec */
-    if (!strcmp (in_plugin->name, "gif") ||
-        !strcmp (in_plugin->name, "vorbis") ||
-        !strcmp (in_plugin->name, "theora") ||
-        !strcmp (in_plugin->name, "mpeg1video") ||
+    if (!strcmp (in_plugin->name, "vorbis") ||
         !strcmp (in_plugin->name, "wavpack") ||
         !strcmp (in_plugin->name, "mp1") ||
         !strcmp (in_plugin->name, "mp2") ||
@@ -3020,39 +1339,19 @@ gst_ffmpegdec_register (GstPlugin * plugin)
      * msmpeg4v3 same, as it outperforms divxdec for divx3 playback.
      * VC1/WMV3 are not working and thus unpreferred for now. */
     switch (in_plugin->id) {
-      case CODEC_ID_MPEG4:
-      case CODEC_ID_MSMPEG4V3:
-      case CODEC_ID_H264:
       case CODEC_ID_RA_144:
       case CODEC_ID_RA_288:
-      case CODEC_ID_RV10:
-      case CODEC_ID_RV20:
-      case CODEC_ID_RV30:
-      case CODEC_ID_RV40:
       case CODEC_ID_COOK:
         rank = GST_RANK_PRIMARY;
         break;
-        /* DVVIDEO: we have a good dv decoder, fast on both ppc as well as x86.
-         * They say libdv's quality is better though. leave as secondary.
-         * note: if you change this, see the code in gstdv.c in good/ext/dv.
-         *
-         * SIPR: decoder should have a higher rank than realaudiodec.
+        /* SIPR: decoder should have a higher rank than realaudiodec.
          */
-      case CODEC_ID_DVVIDEO:
       case CODEC_ID_SIPR:
         rank = GST_RANK_SECONDARY;
         break;
       case CODEC_ID_MP3:
         rank = GST_RANK_NONE;
         break;
-        /* TEMPORARILY DISABLING AC3/EAC3/DTS for 0.10.12 release
-         * due to downmixing failure.
-         * See Bug #608892 for more details */
-      case CODEC_ID_EAC3:
-      case CODEC_ID_AC3:
-      case CODEC_ID_DTS:
-        rank = GST_RANK_NONE;
-        break;
       default:
         rank = GST_RANK_MARGINAL;
         break;
diff --git a/ext/ffmpeg/gstffmpegdeinterlace.c b/ext/ffmpeg/gstffmpegdeinterlace.c
index de95314..40fea5e 100644
--- a/ext/ffmpeg/gstffmpegdeinterlace.c
+++ b/ext/ffmpeg/gstffmpegdeinterlace.c
@@ -145,10 +145,8 @@ gst_ffmpegdeinterlace_base_init (gpointer g_class)
 {
   GstElementClass *element_class = GST_ELEMENT_CLASS (g_class);
 
-  gst_element_class_add_pad_template (element_class,
-      gst_static_pad_template_get (&src_factory));
-  gst_element_class_add_pad_template (element_class,
-      gst_static_pad_template_get (&sink_factory));
+  gst_element_class_add_static_pad_template (element_class, &src_factory);
+  gst_element_class_add_static_pad_template (element_class, &sink_factory);
   gst_element_class_set_details_simple (element_class,
       "FFMPEG Deinterlace element", "Filter/Effect/Video/Deinterlace",
       "Deinterlace video", "Luca Ognibene <luogni@tin.it>");
diff --git a/ext/ffmpeg/gstffmpegdemux.c b/ext/ffmpeg/gstffmpegdemux.c
index 3eb5328..82e61c9 100644
--- a/ext/ffmpeg/gstffmpegdemux.c
+++ b/ext/ffmpeg/gstffmpegdemux.c
@@ -1330,6 +1330,7 @@ gst_ffmpegdemux_type_find (GstTypeFind * tf, gpointer priv)
           in_plugin->name, sinkcaps, res);
 
       gst_type_find_suggest (tf, res, sinkcaps);
+      gst_caps_unref (sinkcaps);
     }
   }
 }
@@ -1958,7 +1959,7 @@ gst_ffmpegdemux_register (GstPlugin * plugin)
         )
       register_typefind_func = FALSE;
 
-    /* Set the rank of demuxers know to work to MARGINAL.
+    /* Set the rank of demuxers known to work to MARGINAL.
      * Set demuxers for which we already have another implementation to NONE
      * Set All others to NONE*/
     if (!strcmp (in_plugin->name, "wsvqa") ||
@@ -1966,7 +1967,6 @@ gst_ffmpegdemux_register (GstPlugin * plugin)
         !strcmp (in_plugin->name, "wc3movie") ||
         !strcmp (in_plugin->name, "voc") ||
         !strcmp (in_plugin->name, "tta") ||
-        !strcmp (in_plugin->name, "swf") ||
         !strcmp (in_plugin->name, "sol") ||
         !strcmp (in_plugin->name, "smk") ||
         !strcmp (in_plugin->name, "vmd") ||
diff --git a/ext/ffmpeg/gstffmpegenc.c b/ext/ffmpeg/gstffmpegenc.c
index f3dd34d..7a841e1 100644
--- a/ext/ffmpeg/gstffmpegenc.c
+++ b/ext/ffmpeg/gstffmpegenc.c
@@ -40,18 +40,9 @@
 #include "gstffmpegcodecmap.h"
 #include "gstffmpegutils.h"
 #include "gstffmpegenc.h"
-#include "gstffmpegcfg.h"
 
-#define DEFAULT_VIDEO_BITRATE 300000    /* in bps */
-#define DEFAULT_VIDEO_GOP_SIZE 15
 #define DEFAULT_AUDIO_BITRATE 128000
 
-#define DEFAULT_WIDTH 352
-#define DEFAULT_HEIGHT 288
-
-
-#define VIDEO_BUFFER_SIZE (1024*1024)
-
 enum
 {
   /* FILL ME */
@@ -62,71 +53,44 @@ enum
 {
   ARG_0,
   ARG_BIT_RATE,
-  ARG_GOP_SIZE,
-  ARG_ME_METHOD,
   ARG_BUFSIZE,
   ARG_RTP_PAYLOAD_SIZE,
-  ARG_CFG_BASE
 };
 
-#define GST_TYPE_ME_METHOD (gst_ffmpegenc_me_method_get_type())
-static GType
-gst_ffmpegenc_me_method_get_type (void)
-{
-  static GType ffmpegenc_me_method_type = 0;
-  static GEnumValue ffmpegenc_me_methods[] = {
-    {ME_ZERO, "None (Very low quality)", "zero"},
-    {ME_FULL, "Full (Slow, unmaintained)", "full"},
-    {ME_LOG, "Logarithmic (Low quality, unmaintained)", "logarithmic"},
-    {ME_PHODS, "phods (Low quality, unmaintained)", "phods"},
-    {ME_EPZS, "EPZS (Best quality, Fast)", "epzs"},
-    {ME_X1, "X1 (Experimental)", "x1"},
-    {0, NULL, NULL},
-  };
-  if (!ffmpegenc_me_method_type) {
-    ffmpegenc_me_method_type =
-        g_enum_register_static ("GstFFMpegEncMeMethod", ffmpegenc_me_methods);
-  }
-  return ffmpegenc_me_method_type;
-}
 
 /* A number of function prototypes are given so we can refer to them later. */
-static void gst_ffmpegenc_class_init (GstFFMpegEncClass * klass);
-static void gst_ffmpegenc_base_init (GstFFMpegEncClass * klass);
-static void gst_ffmpegenc_init (GstFFMpegEnc * ffmpegenc);
-static void gst_ffmpegenc_finalize (GObject * object);
-
-static gboolean gst_ffmpegenc_setcaps (GstPad * pad, GstCaps * caps);
-static GstCaps *gst_ffmpegenc_getcaps (GstPad * pad);
-static GstFlowReturn gst_ffmpegenc_chain_video (GstPad * pad,
-    GstBuffer * buffer);
-static GstFlowReturn gst_ffmpegenc_chain_audio (GstPad * pad,
+static void gst_ffmpegaudenc_class_init (GstFFMpegAudEncClass * klass);
+static void gst_ffmpegaudenc_base_init (GstFFMpegAudEncClass * klass);
+static void gst_ffmpegaudenc_init (GstFFMpegAudEnc * ffmpegaudenc);
+static void gst_ffmpegaudenc_finalize (GObject * object);
+
+static gboolean gst_ffmpegaudenc_setcaps (GstPad * pad, GstCaps * caps);
+static GstCaps *gst_ffmpegaudenc_getcaps (GstPad * pad);
+static GstFlowReturn gst_ffmpegaudenc_chain_audio (GstPad * pad,
     GstBuffer * buffer);
-static gboolean gst_ffmpegenc_event_video (GstPad * pad, GstEvent * event);
-static gboolean gst_ffmpegenc_event_src (GstPad * pad, GstEvent * event);
 
-static void gst_ffmpegenc_set_property (GObject * object,
+static void gst_ffmpegaudenc_set_property (GObject * object,
     guint prop_id, const GValue * value, GParamSpec * pspec);
-static void gst_ffmpegenc_get_property (GObject * object,
+static void gst_ffmpegaudenc_get_property (GObject * object,
     guint prop_id, GValue * value, GParamSpec * pspec);
 
-static GstStateChangeReturn gst_ffmpegenc_change_state (GstElement * element,
+static GstStateChangeReturn gst_ffmpegaudenc_change_state (GstElement * element,
     GstStateChange transition);
 
 #define GST_FFENC_PARAMS_QDATA g_quark_from_static_string("ffenc-params")
 
 static GstElementClass *parent_class = NULL;
 
-/*static guint gst_ffmpegenc_signals[LAST_SIGNAL] = { 0 }; */
+/*static guint gst_ffmpegaudenc_signals[LAST_SIGNAL] = { 0 }; */
 
 static void
-gst_ffmpegenc_base_init (GstFFMpegEncClass * klass)
+gst_ffmpegaudenc_base_init (GstFFMpegAudEncClass * klass)
 {
   GstElementClass *element_class = GST_ELEMENT_CLASS (klass);
   AVCodec *in_plugin;
   GstPadTemplate *srctempl = NULL, *sinktempl = NULL;
   GstCaps *srccaps = NULL, *sinkcaps = NULL;
-  gchar *longname, *classification, *description;
+  gchar *longname, *description;
 
   in_plugin =
       (AVCodec *) g_type_get_qdata (G_OBJECT_CLASS_TYPE (klass),
@@ -135,15 +99,12 @@ gst_ffmpegenc_base_init (GstFFMpegEncClass * klass)
 
   /* construct the element details struct */
   longname = g_strdup_printf ("FFmpeg %s encoder", in_plugin->long_name);
-  classification = g_strdup_printf ("Codec/Encoder/%s",
-      (in_plugin->type == AVMEDIA_TYPE_VIDEO) ? "Video" : "Audio");
   description = g_strdup_printf ("FFmpeg %s encoder", in_plugin->name);
-  gst_element_class_set_details_simple (element_class, longname, classification,
-      description,
+  gst_element_class_set_details_simple (element_class, longname,
+      "Codec/Encoder/Audio", description,
       "Wim Taymans <wim.taymans@gmail.com>, "
       "Ronald Bultje <rbultje@ronald.bitfreak.net>");
   g_free (longname);
-  g_free (classification);
   g_free (description);
 
   if (!(srccaps = gst_ffmpeg_codecid_to_caps (in_plugin->id, NULL, TRUE))) {
@@ -151,13 +112,8 @@ gst_ffmpegenc_base_init (GstFFMpegEncClass * klass)
     srccaps = gst_caps_new_simple ("unknown/unknown", NULL);
   }
 
-  if (in_plugin->type == AVMEDIA_TYPE_VIDEO) {
-    sinkcaps = gst_caps_from_string
-        ("video/x-raw-rgb; video/x-raw-yuv; video/x-raw-gray");
-  } else {
-    sinkcaps = gst_ffmpeg_codectype_to_audio_caps (NULL,
-        in_plugin->id, TRUE, in_plugin);
-  }
+  sinkcaps = gst_ffmpeg_codectype_to_audio_caps (NULL,
+      in_plugin->id, TRUE, in_plugin);
   if (!sinkcaps) {
     GST_DEBUG ("Couldn't get sink caps for encoder '%s'", in_plugin->name);
     sinkcaps = gst_caps_new_simple ("unknown/unknown", NULL);
@@ -180,7 +136,7 @@ gst_ffmpegenc_base_init (GstFFMpegEncClass * klass)
 }
 
 static void
-gst_ffmpegenc_class_init (GstFFMpegEncClass * klass)
+gst_ffmpegaudenc_class_init (GstFFMpegAudEncClass * klass)
 {
   GObjectClass *gobject_class;
   GstElementClass *gstelement_class;
@@ -190,514 +146,192 @@ gst_ffmpegenc_class_init (GstFFMpegEncClass * klass)
 
   parent_class = g_type_class_peek_parent (klass);
 
-  gobject_class->set_property = gst_ffmpegenc_set_property;
-  gobject_class->get_property = gst_ffmpegenc_get_property;
+  gobject_class->set_property = gst_ffmpegaudenc_set_property;
+  gobject_class->get_property = gst_ffmpegaudenc_get_property;
 
-  if (klass->in_plugin->type == AVMEDIA_TYPE_VIDEO) {
-    g_object_class_install_property (G_OBJECT_CLASS (klass), ARG_BIT_RATE,
-        g_param_spec_ulong ("bitrate", "Bit Rate",
-            "Target Video Bitrate", 0, G_MAXULONG, DEFAULT_VIDEO_BITRATE,
-            G_PARAM_READWRITE | G_PARAM_STATIC_STRINGS));
-    g_object_class_install_property (G_OBJECT_CLASS (klass), ARG_GOP_SIZE,
-        g_param_spec_int ("gop-size", "GOP Size",
-            "Number of frames within one GOP", 0, G_MAXINT,
-            DEFAULT_VIDEO_GOP_SIZE,
-            G_PARAM_READWRITE | G_PARAM_STATIC_STRINGS));
-    g_object_class_install_property (G_OBJECT_CLASS (klass), ARG_ME_METHOD,
-        g_param_spec_enum ("me-method", "ME Method", "Motion Estimation Method",
-            GST_TYPE_ME_METHOD, ME_EPZS,
-            G_PARAM_READWRITE | G_PARAM_STATIC_STRINGS));
-
-    /* FIXME 0.11: Make this property read-only */
-    g_object_class_install_property (G_OBJECT_CLASS (klass), ARG_BUFSIZE,
-        g_param_spec_ulong ("buffer-size", "Buffer Size",
-            "Size of the video buffers. "
-            "Note: Setting this property has no effect "
-            "and is deprecated!", 0, G_MAXULONG, 0,
-            G_PARAM_READWRITE | G_PARAM_STATIC_STRINGS));
-    g_object_class_install_property (G_OBJECT_CLASS (klass),
-        ARG_RTP_PAYLOAD_SIZE, g_param_spec_ulong ("rtp-payload-size",
-            "RTP Payload Size", "Target GOB length", 0, G_MAXULONG, 0,
-            G_PARAM_READWRITE | G_PARAM_STATIC_STRINGS));
-
-    /* register additional properties, possibly dependent on the exact CODEC */
-    gst_ffmpeg_cfg_install_property (klass, ARG_CFG_BASE);
-  } else if (klass->in_plugin->type == AVMEDIA_TYPE_AUDIO) {
+  if (klass->in_plugin->type == AVMEDIA_TYPE_AUDIO) {
     g_object_class_install_property (G_OBJECT_CLASS (klass), ARG_BIT_RATE,
         g_param_spec_ulong ("bitrate", "Bit Rate",
             "Target Audio Bitrate", 0, G_MAXULONG, DEFAULT_AUDIO_BITRATE,
             G_PARAM_READWRITE | G_PARAM_STATIC_STRINGS));
   }
 
-  gstelement_class->change_state = gst_ffmpegenc_change_state;
+  gstelement_class->change_state = gst_ffmpegaudenc_change_state;
 
-  gobject_class->finalize = gst_ffmpegenc_finalize;
+  gobject_class->finalize = gst_ffmpegaudenc_finalize;
 }
 
 static void
-gst_ffmpegenc_init (GstFFMpegEnc * ffmpegenc)
+gst_ffmpegaudenc_init (GstFFMpegAudEnc * ffmpegaudenc)
 {
-  GstFFMpegEncClass *oclass =
-      (GstFFMpegEncClass *) (G_OBJECT_GET_CLASS (ffmpegenc));
+  GstFFMpegAudEncClass *oclass =
+      (GstFFMpegAudEncClass *) (G_OBJECT_GET_CLASS (ffmpegaudenc));
 
   /* setup pads */
-  ffmpegenc->sinkpad = gst_pad_new_from_template (oclass->sinktempl, "sink");
-  gst_pad_set_setcaps_function (ffmpegenc->sinkpad, gst_ffmpegenc_setcaps);
-  gst_pad_set_getcaps_function (ffmpegenc->sinkpad, gst_ffmpegenc_getcaps);
-  ffmpegenc->srcpad = gst_pad_new_from_template (oclass->srctempl, "src");
-  gst_pad_use_fixed_caps (ffmpegenc->srcpad);
+  ffmpegaudenc->sinkpad = gst_pad_new_from_template (oclass->sinktempl, "sink");
+  gst_pad_set_setcaps_function (ffmpegaudenc->sinkpad,
+      gst_ffmpegaudenc_setcaps);
+  gst_pad_set_getcaps_function (ffmpegaudenc->sinkpad,
+      gst_ffmpegaudenc_getcaps);
+  ffmpegaudenc->srcpad = gst_pad_new_from_template (oclass->srctempl, "src");
+  gst_pad_use_fixed_caps (ffmpegaudenc->srcpad);
 
   /* ffmpeg objects */
-  ffmpegenc->context = avcodec_alloc_context ();
-  ffmpegenc->picture = avcodec_alloc_frame ();
-  ffmpegenc->opened = FALSE;
-
-  ffmpegenc->file = NULL;
-  ffmpegenc->delay = g_queue_new ();
-
-  if (oclass->in_plugin->type == AVMEDIA_TYPE_VIDEO) {
-    gst_pad_set_chain_function (ffmpegenc->sinkpad, gst_ffmpegenc_chain_video);
-    /* so we know when to flush the buffers on EOS */
-    gst_pad_set_event_function (ffmpegenc->sinkpad, gst_ffmpegenc_event_video);
-    gst_pad_set_event_function (ffmpegenc->srcpad, gst_ffmpegenc_event_src);
-
-    ffmpegenc->bitrate = DEFAULT_VIDEO_BITRATE;
-    ffmpegenc->me_method = ME_EPZS;
-    ffmpegenc->buffer_size = 512 * 1024;
-    ffmpegenc->gop_size = DEFAULT_VIDEO_GOP_SIZE;
-    ffmpegenc->rtp_payload_size = 0;
-
-    ffmpegenc->lmin = 2;
-    ffmpegenc->lmax = 31;
-    ffmpegenc->max_key_interval = 0;
-
-    gst_ffmpeg_cfg_set_defaults (ffmpegenc);
-  } else if (oclass->in_plugin->type == AVMEDIA_TYPE_AUDIO) {
-    gst_pad_set_chain_function (ffmpegenc->sinkpad, gst_ffmpegenc_chain_audio);
-
-    ffmpegenc->bitrate = DEFAULT_AUDIO_BITRATE;
+  ffmpegaudenc->context = avcodec_alloc_context ();
+  ffmpegaudenc->opened = FALSE;
+
+  if (oclass->in_plugin->type == AVMEDIA_TYPE_AUDIO) {
+    gst_pad_set_chain_function (ffmpegaudenc->sinkpad,
+        gst_ffmpegaudenc_chain_audio);
+
+    ffmpegaudenc->bitrate = DEFAULT_AUDIO_BITRATE;
   }
 
-  gst_element_add_pad (GST_ELEMENT (ffmpegenc), ffmpegenc->sinkpad);
-  gst_element_add_pad (GST_ELEMENT (ffmpegenc), ffmpegenc->srcpad);
+  gst_element_add_pad (GST_ELEMENT (ffmpegaudenc), ffmpegaudenc->sinkpad);
+  gst_element_add_pad (GST_ELEMENT (ffmpegaudenc), ffmpegaudenc->srcpad);
 
-  ffmpegenc->adapter = gst_adapter_new ();
+  ffmpegaudenc->adapter = gst_adapter_new ();
 }
 
 static void
-gst_ffmpegenc_finalize (GObject * object)
+gst_ffmpegaudenc_finalize (GObject * object)
 {
-  GstFFMpegEnc *ffmpegenc = (GstFFMpegEnc *) object;
+  GstFFMpegAudEnc *ffmpegaudenc = (GstFFMpegAudEnc *) object;
 
-  gst_ffmpeg_cfg_finalize (ffmpegenc);
 
   /* close old session */
-  if (ffmpegenc->opened) {
-    gst_ffmpeg_avcodec_close (ffmpegenc->context);
-    ffmpegenc->opened = FALSE;
+  if (ffmpegaudenc->opened) {
+    gst_ffmpeg_avcodec_close (ffmpegaudenc->context);
+    ffmpegaudenc->opened = FALSE;
   }
 
   /* clean up remaining allocated data */
-  av_free (ffmpegenc->context);
-  av_free (ffmpegenc->picture);
-
-  g_queue_free (ffmpegenc->delay);
-  g_free (ffmpegenc->filename);
+  av_free (ffmpegaudenc->context);
 
-  g_object_unref (ffmpegenc->adapter);
+  g_object_unref (ffmpegaudenc->adapter);
 
   G_OBJECT_CLASS (parent_class)->finalize (object);
 }
 
 static GstCaps *
-gst_ffmpegenc_get_possible_sizes (GstFFMpegEnc * ffmpegenc, GstPad * pad,
-    const GstCaps * caps)
+gst_ffmpegaudenc_getcaps (GstPad * pad)
 {
-  GstCaps *othercaps = NULL;
-  GstCaps *tmpcaps = NULL;
-  GstCaps *intersect = NULL;
-  guint i;
-
-  othercaps = gst_pad_peer_get_caps (ffmpegenc->srcpad);
-
-  if (!othercaps)
-    return gst_caps_copy (caps);
-
-  intersect = gst_caps_intersect (othercaps,
-      gst_pad_get_pad_template_caps (ffmpegenc->srcpad));
-  gst_caps_unref (othercaps);
-
-  if (gst_caps_is_empty (intersect))
-    return intersect;
-
-  if (gst_caps_is_any (intersect))
-    return gst_caps_copy (caps);
-
-  tmpcaps = gst_caps_new_empty ();
-
-  for (i = 0; i < gst_caps_get_size (intersect); i++) {
-    GstStructure *s = gst_caps_get_structure (intersect, i);
-    const GValue *height = NULL;
-    const GValue *width = NULL;
-    const GValue *framerate = NULL;
-    GstStructure *tmps;
-
-    height = gst_structure_get_value (s, "height");
-    width = gst_structure_get_value (s, "width");
-    framerate = gst_structure_get_value (s, "framerate");
-
-    tmps = gst_structure_new ("video/x-raw-rgb", NULL);
-    if (width)
-      gst_structure_set_value (tmps, "width", width);
-    if (height)
-      gst_structure_set_value (tmps, "height", height);
-    if (framerate)
-      gst_structure_set_value (tmps, "framerate", framerate);
-    gst_caps_merge_structure (tmpcaps, gst_structure_copy (tmps));
-
-    gst_structure_set_name (tmps, "video/x-raw-yuv");
-    gst_caps_merge_structure (tmpcaps, gst_structure_copy (tmps));
-
-    gst_structure_set_name (tmps, "video/x-raw-gray");
-    gst_caps_merge_structure (tmpcaps, tmps);
-  }
-  gst_caps_unref (intersect);
-
-  intersect = gst_caps_intersect (caps, tmpcaps);
-  gst_caps_unref (tmpcaps);
-
-  return intersect;
-}
-
-
-static GstCaps *
-gst_ffmpegenc_getcaps (GstPad * pad)
-{
-  GstFFMpegEnc *ffmpegenc = (GstFFMpegEnc *) GST_PAD_PARENT (pad);
-  GstFFMpegEncClass *oclass =
-      (GstFFMpegEncClass *) G_OBJECT_GET_CLASS (ffmpegenc);
-  AVCodecContext *ctx = NULL;
-  enum PixelFormat pixfmt;
+  GstFFMpegAudEnc *ffmpegaudenc = (GstFFMpegAudEnc *) GST_PAD_PARENT (pad);
   GstCaps *caps = NULL;
-  GstCaps *finalcaps = NULL;
-  gint i;
 
-  GST_DEBUG_OBJECT (ffmpegenc, "getting caps");
+  GST_DEBUG_OBJECT (ffmpegaudenc, "getting caps");
 
   /* audio needs no special care */
-  if (oclass->in_plugin->type == AVMEDIA_TYPE_AUDIO) {
-    caps = gst_caps_copy (gst_pad_get_pad_template_caps (pad));
-
-    GST_DEBUG_OBJECT (ffmpegenc, "audio caps, return template %" GST_PTR_FORMAT,
-        caps);
-
-    return caps;
-  }
-
-  /* cached */
-  if (oclass->sinkcaps) {
-    caps = gst_ffmpegenc_get_possible_sizes (ffmpegenc, pad, oclass->sinkcaps);
-    GST_DEBUG_OBJECT (ffmpegenc, "return cached caps %" GST_PTR_FORMAT, caps);
-    return caps;
-  }
-
-  /* create cache etc. */
-
-  /* shut up the logging while we autoprobe; we don't want warnings and
-   * errors about unsupported formats */
-  /* FIXME: if someone cares about this disabling the logging for other
-   * instances/threads/..., one could investigate if there is a way to
-   * set this as a struct member on the av context, and check it from the
-   * log handler */
-#ifndef GST_DISABLE_GST_DEBUG
-  _shut_up_I_am_probing = TRUE;
-#endif
-  GST_DEBUG_OBJECT (ffmpegenc, "probing caps");
-  i = pixfmt = 0;
-  /* check pixfmt until deemed finished */
-  for (pixfmt = 0;; pixfmt++) {
-    GstCaps *tmpcaps;
-
-    /* override looping all pixfmt if codec declares pixfmts;
-     * these may not properly check and report supported pixfmt during _init */
-    if (oclass->in_plugin->pix_fmts) {
-      if ((pixfmt = oclass->in_plugin->pix_fmts[i++]) == PIX_FMT_NONE) {
-        GST_DEBUG_OBJECT (ffmpegenc,
-            "At the end of official pixfmt for this codec, breaking out");
-        break;
-      }
-      GST_DEBUG_OBJECT (ffmpegenc,
-          "Got an official pixfmt [%d], attempting to get caps", pixfmt);
-      tmpcaps = gst_ffmpeg_pixfmt_to_caps (pixfmt, NULL, oclass->in_plugin->id);
-      if (tmpcaps) {
-        GST_DEBUG_OBJECT (ffmpegenc, "Got caps, breaking out");
-        if (!caps)
-          caps = gst_caps_new_empty ();
-        gst_caps_append (caps, tmpcaps);
-        continue;
-      }
-      GST_DEBUG_OBJECT (ffmpegenc,
-          "Couldn't figure out caps without context, trying again with a context");
-    }
-
-    GST_DEBUG_OBJECT (ffmpegenc, "pixfmt :%d", pixfmt);
-    if (pixfmt >= PIX_FMT_NB) {
-      GST_WARNING ("Invalid pixfmt, breaking out");
-      break;
-    }
-
-    /* need to start with a fresh codec_context each time around, since
-     * codec_close may have released stuff causing the next pass to segfault */
-    ctx = avcodec_alloc_context ();
-    if (!ctx) {
-      GST_DEBUG_OBJECT (ffmpegenc, "no context");
-      break;
-    }
-
-    /* set some default properties */
-    ctx->width = DEFAULT_WIDTH;
-    ctx->height = DEFAULT_HEIGHT;
-    ctx->time_base.num = 1;
-    ctx->time_base.den = 25;
-    ctx->ticks_per_frame = 1;
-    ctx->bit_rate = DEFAULT_VIDEO_BITRATE;
-    /* makes it silent */
-    ctx->strict_std_compliance = -1;
-
-    ctx->pix_fmt = pixfmt;
-
-    GST_DEBUG ("Attempting to open codec");
-    if (gst_ffmpeg_avcodec_open (ctx, oclass->in_plugin) >= 0 &&
-        ctx->pix_fmt == pixfmt) {
-      ctx->width = -1;
-      if (!caps)
-        caps = gst_caps_new_empty ();
-      tmpcaps = gst_ffmpeg_codectype_to_caps (oclass->in_plugin->type, ctx,
-          oclass->in_plugin->id, TRUE);
-      if (tmpcaps)
-        gst_caps_append (caps, tmpcaps);
-      else
-        GST_LOG_OBJECT (ffmpegenc,
-            "Couldn't get caps for oclass->in_plugin->name:%s",
-            oclass->in_plugin->name);
-      gst_ffmpeg_avcodec_close (ctx);
-    } else {
-      GST_DEBUG_OBJECT (ffmpegenc, "Opening codec failed with pixfmt : %d",
-          pixfmt);
-    }
-    if (ctx->priv_data)
-      gst_ffmpeg_avcodec_close (ctx);
-    av_free (ctx);
-  }
-#ifndef GST_DISABLE_GST_DEBUG
-  _shut_up_I_am_probing = FALSE;
-#endif
-
-  /* make sure we have something */
-  if (!caps) {
-    caps = gst_ffmpegenc_get_possible_sizes (ffmpegenc, pad,
-        gst_pad_get_pad_template_caps (pad));
-    GST_DEBUG_OBJECT (ffmpegenc, "probing gave nothing, "
-        "return template %" GST_PTR_FORMAT, caps);
-    return caps;
-  }
-
-  GST_DEBUG_OBJECT (ffmpegenc, "probed caps gave %" GST_PTR_FORMAT, caps);
-  oclass->sinkcaps = gst_caps_copy (caps);
+  caps = gst_caps_copy (gst_pad_get_pad_template_caps (pad));
 
-  finalcaps = gst_ffmpegenc_get_possible_sizes (ffmpegenc, pad, caps);
-  gst_caps_unref (caps);
+  GST_DEBUG_OBJECT (ffmpegaudenc,
+      "audio caps, return template %" GST_PTR_FORMAT, caps);
 
-  return finalcaps;
+  return caps;
 }
 
 static gboolean
-gst_ffmpegenc_setcaps (GstPad * pad, GstCaps * caps)
+gst_ffmpegaudenc_setcaps (GstPad * pad, GstCaps * caps)
 {
   GstCaps *other_caps;
   GstCaps *allowed_caps;
   GstCaps *icaps;
-  enum PixelFormat pix_fmt;
-  GstFFMpegEnc *ffmpegenc = (GstFFMpegEnc *) GST_PAD_PARENT (pad);
-  GstFFMpegEncClass *oclass =
-      (GstFFMpegEncClass *) G_OBJECT_GET_CLASS (ffmpegenc);
+  GstFFMpegAudEnc *ffmpegaudenc = (GstFFMpegAudEnc *) GST_PAD_PARENT (pad);
+  GstFFMpegAudEncClass *oclass =
+      (GstFFMpegAudEncClass *) G_OBJECT_GET_CLASS (ffmpegaudenc);
 
   /* close old session */
-  if (ffmpegenc->opened) {
-    gst_ffmpeg_avcodec_close (ffmpegenc->context);
-    ffmpegenc->opened = FALSE;
+  if (ffmpegaudenc->opened) {
+    gst_ffmpeg_avcodec_close (ffmpegaudenc->context);
+    ffmpegaudenc->opened = FALSE;
     /* fixed src caps;
      * so clear src caps for proper (re-)negotiation */
-    gst_pad_set_caps (ffmpegenc->srcpad, NULL);
+    gst_pad_set_caps (ffmpegaudenc->srcpad, NULL);
   }
 
   /* set defaults */
-  avcodec_get_context_defaults (ffmpegenc->context);
+  avcodec_get_context_defaults (ffmpegaudenc->context);
 
   /* if we set it in _getcaps we should set it also in _link */
-  ffmpegenc->context->strict_std_compliance = -1;
+  ffmpegaudenc->context->strict_std_compliance = -1;
 
   /* user defined properties */
-  ffmpegenc->context->bit_rate = ffmpegenc->bitrate;
-  ffmpegenc->context->bit_rate_tolerance = ffmpegenc->bitrate;
-  ffmpegenc->context->gop_size = ffmpegenc->gop_size;
-  ffmpegenc->context->me_method = ffmpegenc->me_method;
-  GST_DEBUG_OBJECT (ffmpegenc, "Setting avcontext to bitrate %lu, gop_size %d",
-      ffmpegenc->bitrate, ffmpegenc->gop_size);
+  ffmpegaudenc->context->bit_rate = ffmpegaudenc->bitrate;
+  ffmpegaudenc->context->bit_rate_tolerance = ffmpegaudenc->bitrate;
+  GST_DEBUG_OBJECT (ffmpegaudenc, "Setting avcontext to bitrate %lu",
+      ffmpegaudenc->bitrate);
 
   /* RTP payload used for GOB production (for Asterisk) */
-  if (ffmpegenc->rtp_payload_size) {
-    ffmpegenc->context->rtp_payload_size = ffmpegenc->rtp_payload_size;
-  }
-
-  /* additional avcodec settings */
-  /* first fill in the majority by copying over */
-  gst_ffmpeg_cfg_fill_context (ffmpegenc, ffmpegenc->context);
-
-  /* then handle some special cases */
-  ffmpegenc->context->lmin = (ffmpegenc->lmin * FF_QP2LAMBDA + 0.5);
-  ffmpegenc->context->lmax = (ffmpegenc->lmax * FF_QP2LAMBDA + 0.5);
-
-  if (ffmpegenc->interlaced) {
-    ffmpegenc->context->flags |=
-        CODEC_FLAG_INTERLACED_DCT | CODEC_FLAG_INTERLACED_ME;
-    ffmpegenc->picture->interlaced_frame = TRUE;
-    /* if this is not the case, a filter element should be used to swap fields */
-    ffmpegenc->picture->top_field_first = TRUE;
+  if (ffmpegaudenc->rtp_payload_size) {
+    ffmpegaudenc->context->rtp_payload_size = ffmpegaudenc->rtp_payload_size;
   }
 
   /* some other defaults */
-  ffmpegenc->context->rc_strategy = 2;
-  ffmpegenc->context->b_frame_strategy = 0;
-  ffmpegenc->context->coder_type = 0;
-  ffmpegenc->context->context_model = 0;
-  ffmpegenc->context->scenechange_threshold = 0;
-  ffmpegenc->context->inter_threshold = 0;
-
-  /* and last but not least the pass; CBR, 2-pass, etc */
-  ffmpegenc->context->flags |= ffmpegenc->pass;
-  switch (ffmpegenc->pass) {
-      /* some additional action depends on type of pass */
-    case CODEC_FLAG_QSCALE:
-      ffmpegenc->context->global_quality
-          = ffmpegenc->picture->quality = FF_QP2LAMBDA * ffmpegenc->quantizer;
-      break;
-    case CODEC_FLAG_PASS1:     /* need to prepare a stats file */
-      /* we don't close when changing caps, fingers crossed */
-      if (!ffmpegenc->file)
-        ffmpegenc->file = g_fopen (ffmpegenc->filename, "w");
-      if (!ffmpegenc->file) {
-        GST_ELEMENT_ERROR (ffmpegenc, RESOURCE, OPEN_WRITE,
-            (("Could not open file \"%s\" for writing."), ffmpegenc->filename),
-            GST_ERROR_SYSTEM);
-        return FALSE;
-      }
-      break;
-    case CODEC_FLAG_PASS2:
-    {                           /* need to read the whole stats file ! */
-      gsize size;
-
-      if (!g_file_get_contents (ffmpegenc->filename,
-              &ffmpegenc->context->stats_in, &size, NULL)) {
-        GST_ELEMENT_ERROR (ffmpegenc, RESOURCE, READ,
-            (("Could not get contents of file \"%s\"."), ffmpegenc->filename),
-            GST_ERROR_SYSTEM);
-        return FALSE;
-      }
+  ffmpegaudenc->context->rc_strategy = 2;
+  ffmpegaudenc->context->b_frame_strategy = 0;
+  ffmpegaudenc->context->coder_type = 0;
+  ffmpegaudenc->context->context_model = 0;
+  ffmpegaudenc->context->scenechange_threshold = 0;
+  ffmpegaudenc->context->inter_threshold = 0;
 
-      break;
-    }
-    default:
-      break;
-  }
 
   /* fetch pix_fmt and so on */
   gst_ffmpeg_caps_with_codectype (oclass->in_plugin->type,
-      caps, ffmpegenc->context);
-  if (!ffmpegenc->context->time_base.den) {
-    ffmpegenc->context->time_base.den = 25;
-    ffmpegenc->context->time_base.num = 1;
-    ffmpegenc->context->ticks_per_frame = 1;
+      caps, ffmpegaudenc->context);
+  if (!ffmpegaudenc->context->time_base.den) {
+    ffmpegaudenc->context->time_base.den = 25;
+    ffmpegaudenc->context->time_base.num = 1;
+    ffmpegaudenc->context->ticks_per_frame = 1;
   } else if ((oclass->in_plugin->id == CODEC_ID_MPEG4)
-      && (ffmpegenc->context->time_base.den > 65535)) {
+      && (ffmpegaudenc->context->time_base.den > 65535)) {
     /* MPEG4 Standards do not support time_base denominator greater than
      * (1<<16) - 1 . We therefore scale them down.
      * Agreed, it will not be the exact framerate... but the difference
      * shouldn't be that noticeable */
-    ffmpegenc->context->time_base.num =
-        (gint) gst_util_uint64_scale_int (ffmpegenc->context->time_base.num,
-        65535, ffmpegenc->context->time_base.den);
-    ffmpegenc->context->time_base.den = 65535;
-    GST_LOG_OBJECT (ffmpegenc, "MPEG4 : scaled down framerate to %d / %d",
-        ffmpegenc->context->time_base.den, ffmpegenc->context->time_base.num);
-  }
-
-  pix_fmt = ffmpegenc->context->pix_fmt;
-
-  /* max-key-interval may need the framerate set above */
-  if (ffmpegenc->max_key_interval) {
-    AVCodecContext *ctx;
-
-    /* override gop-size */
-    ctx = ffmpegenc->context;
-    ctx->gop_size = (ffmpegenc->max_key_interval < 0) ?
-        (-ffmpegenc->max_key_interval
-        * (ctx->time_base.den * ctx->ticks_per_frame / ctx->time_base.num))
-        : ffmpegenc->max_key_interval;
+    ffmpegaudenc->context->time_base.num =
+        (gint) gst_util_uint64_scale_int (ffmpegaudenc->context->time_base.num,
+        65535, ffmpegaudenc->context->time_base.den);
+    ffmpegaudenc->context->time_base.den = 65535;
+    GST_LOG_OBJECT (ffmpegaudenc, "MPEG4 : scaled down framerate to %d / %d",
+        ffmpegaudenc->context->time_base.den,
+        ffmpegaudenc->context->time_base.num);
   }
 
   /* open codec */
-  if (gst_ffmpeg_avcodec_open (ffmpegenc->context, oclass->in_plugin) < 0) {
-    if (ffmpegenc->context->priv_data)
-      gst_ffmpeg_avcodec_close (ffmpegenc->context);
-    if (ffmpegenc->context->stats_in)
-      g_free (ffmpegenc->context->stats_in);
-    GST_DEBUG_OBJECT (ffmpegenc, "ffenc_%s: Failed to open FFMPEG codec",
+  if (gst_ffmpeg_avcodec_open (ffmpegaudenc->context, oclass->in_plugin) < 0) {
+    if (ffmpegaudenc->context->priv_data)
+      gst_ffmpeg_avcodec_close (ffmpegaudenc->context);
+    if (ffmpegaudenc->context->stats_in)
+      g_free (ffmpegaudenc->context->stats_in);
+    GST_DEBUG_OBJECT (ffmpegaudenc, "ffenc_%s: Failed to open FFMPEG codec",
         oclass->in_plugin->name);
     return FALSE;
   }
 
   /* second pass stats buffer no longer needed */
-  if (ffmpegenc->context->stats_in)
-    g_free (ffmpegenc->context->stats_in);
-
-  /* is the colourspace correct? */
-  if (pix_fmt != ffmpegenc->context->pix_fmt) {
-    gst_ffmpeg_avcodec_close (ffmpegenc->context);
-    GST_DEBUG_OBJECT (ffmpegenc,
-        "ffenc_%s: AV wants different colourspace (%d given, %d wanted)",
-        oclass->in_plugin->name, pix_fmt, ffmpegenc->context->pix_fmt);
-    return FALSE;
-  }
-  /* we may have failed mapping caps to a pixfmt,
-   * and quite some codecs do not make up their own mind about that
-   * in any case, _NONE can never work out later on */
-  if (oclass->in_plugin->type == AVMEDIA_TYPE_VIDEO && pix_fmt == PIX_FMT_NONE) {
-    GST_DEBUG_OBJECT (ffmpegenc, "ffenc_%s: Failed to determine input format",
-        oclass->in_plugin->name);
-    return FALSE;
-  }
+  if (ffmpegaudenc->context->stats_in)
+    g_free (ffmpegaudenc->context->stats_in);
 
   /* some codecs support more than one format, first auto-choose one */
-  GST_DEBUG_OBJECT (ffmpegenc, "picking an output format ...");
-  allowed_caps = gst_pad_get_allowed_caps (ffmpegenc->srcpad);
+  GST_DEBUG_OBJECT (ffmpegaudenc, "picking an output format ...");
+  allowed_caps = gst_pad_get_allowed_caps (ffmpegaudenc->srcpad);
   if (!allowed_caps) {
-    GST_DEBUG_OBJECT (ffmpegenc, "... but no peer, using template caps");
+    GST_DEBUG_OBJECT (ffmpegaudenc, "... but no peer, using template caps");
     /* we need to copy because get_allowed_caps returns a ref, and
      * get_pad_template_caps doesn't */
     allowed_caps =
-        gst_caps_copy (gst_pad_get_pad_template_caps (ffmpegenc->srcpad));
+        gst_caps_copy (gst_pad_get_pad_template_caps (ffmpegaudenc->srcpad));
   }
-  GST_DEBUG_OBJECT (ffmpegenc, "chose caps %" GST_PTR_FORMAT, allowed_caps);
+  GST_DEBUG_OBJECT (ffmpegaudenc, "chose caps %" GST_PTR_FORMAT, allowed_caps);
   gst_ffmpeg_caps_with_codecid (oclass->in_plugin->id,
-      oclass->in_plugin->type, allowed_caps, ffmpegenc->context);
+      oclass->in_plugin->type, allowed_caps, ffmpegaudenc->context);
 
   /* try to set this caps on the other side */
   other_caps = gst_ffmpeg_codecid_to_caps (oclass->in_plugin->id,
-      ffmpegenc->context, TRUE);
+      ffmpegaudenc->context, TRUE);
 
   if (!other_caps) {
-    gst_ffmpeg_avcodec_close (ffmpegenc->context);
+    gst_ffmpeg_avcodec_close (ffmpegaudenc->context);
     GST_DEBUG ("Unsupported codec - no caps found");
     return FALSE;
   }
@@ -720,132 +354,23 @@ gst_ffmpegenc_setcaps (GstPad * pad, GstCaps * caps)
     icaps = newcaps;
   }
 
-  if (!gst_pad_set_caps (ffmpegenc->srcpad, icaps)) {
-    gst_ffmpeg_avcodec_close (ffmpegenc->context);
+  if (!gst_pad_set_caps (ffmpegaudenc->srcpad, icaps)) {
+    gst_ffmpeg_avcodec_close (ffmpegaudenc->context);
     gst_caps_unref (icaps);
     return FALSE;
   }
   gst_caps_unref (icaps);
 
   /* success! */
-  ffmpegenc->opened = TRUE;
+  ffmpegaudenc->opened = TRUE;
 
   return TRUE;
 }
 
-static void
-ffmpegenc_setup_working_buf (GstFFMpegEnc * ffmpegenc)
-{
-  guint wanted_size =
-      ffmpegenc->context->width * ffmpegenc->context->height * 6 +
-      FF_MIN_BUFFER_SIZE;
-
-  /* Above is the buffer size used by ffmpeg/ffmpeg.c */
-
-  if (ffmpegenc->working_buf == NULL ||
-      ffmpegenc->working_buf_size != wanted_size) {
-    if (ffmpegenc->working_buf)
-      g_free (ffmpegenc->working_buf);
-    ffmpegenc->working_buf_size = wanted_size;
-    ffmpegenc->working_buf = g_malloc (ffmpegenc->working_buf_size);
-  }
-  ffmpegenc->buffer_size = wanted_size;
-}
 
 static GstFlowReturn
-gst_ffmpegenc_chain_video (GstPad * pad, GstBuffer * inbuf)
-{
-  GstFFMpegEnc *ffmpegenc = (GstFFMpegEnc *) (GST_PAD_PARENT (pad));
-  GstBuffer *outbuf;
-  gint ret_size = 0, frame_size;
-  gboolean force_keyframe;
-
-  GST_DEBUG_OBJECT (ffmpegenc,
-      "Received buffer of time %" GST_TIME_FORMAT,
-      GST_TIME_ARGS (GST_BUFFER_TIMESTAMP (inbuf)));
-
-  GST_OBJECT_LOCK (ffmpegenc);
-  force_keyframe = ffmpegenc->force_keyframe;
-  ffmpegenc->force_keyframe = FALSE;
-  GST_OBJECT_UNLOCK (ffmpegenc);
-
-  if (force_keyframe)
-    ffmpegenc->picture->pict_type = FF_I_TYPE;
-
-  frame_size = gst_ffmpeg_avpicture_fill ((AVPicture *) ffmpegenc->picture,
-      GST_BUFFER_DATA (inbuf),
-      ffmpegenc->context->pix_fmt,
-      ffmpegenc->context->width, ffmpegenc->context->height);
-  g_return_val_if_fail (frame_size == GST_BUFFER_SIZE (inbuf), GST_FLOW_ERROR);
-
-  ffmpegenc->picture->pts =
-      gst_ffmpeg_time_gst_to_ff (GST_BUFFER_TIMESTAMP (inbuf) /
-      ffmpegenc->context->ticks_per_frame, ffmpegenc->context->time_base);
-
-  ffmpegenc_setup_working_buf (ffmpegenc);
-
-  ret_size = avcodec_encode_video (ffmpegenc->context,
-      ffmpegenc->working_buf, ffmpegenc->working_buf_size, ffmpegenc->picture);
-
-  if (ret_size < 0) {
-#ifndef GST_DISABLE_GST_DEBUG
-    GstFFMpegEncClass *oclass =
-        (GstFFMpegEncClass *) (G_OBJECT_GET_CLASS (ffmpegenc));
-    GST_ERROR_OBJECT (ffmpegenc,
-        "ffenc_%s: failed to encode buffer", oclass->in_plugin->name);
-#endif /* GST_DISABLE_GST_DEBUG */
-    gst_buffer_unref (inbuf);
-    return GST_FLOW_OK;
-  }
-
-  /* handle b-frame delay when no output, so we don't output empty frames;
-   * timestamps and so can permute a bit between coding and display order
-   * but keyframes should still end up with the proper metadata */
-  g_queue_push_tail (ffmpegenc->delay, inbuf);
-  if (ret_size)
-    inbuf = g_queue_pop_head (ffmpegenc->delay);
-  else
-    return GST_FLOW_OK;
-
-  /* save stats info if there is some as well as a stats file */
-  if (ffmpegenc->file && ffmpegenc->context->stats_out)
-    if (fprintf (ffmpegenc->file, "%s", ffmpegenc->context->stats_out) < 0)
-      GST_ELEMENT_ERROR (ffmpegenc, RESOURCE, WRITE,
-          (("Could not write to file \"%s\"."), ffmpegenc->filename),
-          GST_ERROR_SYSTEM);
-
-  outbuf = gst_buffer_new_and_alloc (ret_size);
-  memcpy (GST_BUFFER_DATA (outbuf), ffmpegenc->working_buf, ret_size);
-  GST_BUFFER_TIMESTAMP (outbuf) = GST_BUFFER_TIMESTAMP (inbuf);
-  GST_BUFFER_DURATION (outbuf) = GST_BUFFER_DURATION (inbuf);
-  /* buggy codec may not set coded_frame */
-  if (ffmpegenc->context->coded_frame) {
-    if (!ffmpegenc->context->coded_frame->key_frame)
-      GST_BUFFER_FLAG_SET (outbuf, GST_BUFFER_FLAG_DELTA_UNIT);
-  } else
-    GST_WARNING_OBJECT (ffmpegenc, "codec did not provide keyframe info");
-  gst_buffer_set_caps (outbuf, GST_PAD_CAPS (ffmpegenc->srcpad));
-
-  gst_buffer_unref (inbuf);
-
-  /* Reset frame type */
-  if (ffmpegenc->picture->pict_type)
-    ffmpegenc->picture->pict_type = 0;
-
-  if (force_keyframe) {
-    gst_pad_push_event (ffmpegenc->srcpad,
-        gst_event_new_custom (GST_EVENT_CUSTOM_DOWNSTREAM,
-            gst_structure_new ("GstForceKeyUnit",
-                "timestamp", G_TYPE_UINT64, GST_BUFFER_TIMESTAMP (outbuf),
-                NULL)));
-  }
-
-  return gst_pad_push (ffmpegenc->srcpad, outbuf);
-}
-
-static GstFlowReturn
-gst_ffmpegenc_encode_audio (GstFFMpegEnc * ffmpegenc, guint8 * audio_in,
-    guint in_size, guint max_size, GstClockTime timestamp,
+gst_ffmpegaudenc_encode_audio (GstFFMpegAudEnc * ffmpegaudenc,
+    guint8 * audio_in, guint in_size, guint max_size, GstClockTime timestamp,
     GstClockTime duration, gboolean discont)
 {
   GstBuffer *outbuf;
@@ -854,45 +379,45 @@ gst_ffmpegenc_encode_audio (GstFFMpegEnc * ffmpegenc, guint8 * audio_in,
   gint res;
   GstFlowReturn ret;
 
-  ctx = ffmpegenc->context;
+  ctx = ffmpegaudenc->context;
 
   /* We need to provide at least ffmpegs minimal buffer size */
   outbuf = gst_buffer_new_and_alloc (max_size + FF_MIN_BUFFER_SIZE);
   audio_out = GST_BUFFER_DATA (outbuf);
 
-  GST_LOG_OBJECT (ffmpegenc, "encoding buffer of max size %d", max_size);
-  if (ffmpegenc->buffer_size != max_size)
-    ffmpegenc->buffer_size = max_size;
+  GST_LOG_OBJECT (ffmpegaudenc, "encoding buffer of max size %d", max_size);
+  if (ffmpegaudenc->buffer_size != max_size)
+    ffmpegaudenc->buffer_size = max_size;
 
   res = avcodec_encode_audio (ctx, audio_out, max_size, (short *) audio_in);
 
   if (res < 0) {
-    GST_ERROR_OBJECT (ffmpegenc, "Failed to encode buffer: %d", res);
+    GST_ERROR_OBJECT (ffmpegaudenc, "Failed to encode buffer: %d", res);
     gst_buffer_unref (outbuf);
     return GST_FLOW_OK;
   }
-  GST_LOG_OBJECT (ffmpegenc, "got output size %d", res);
+  GST_LOG_OBJECT (ffmpegaudenc, "got output size %d", res);
 
   GST_BUFFER_SIZE (outbuf) = res;
   GST_BUFFER_TIMESTAMP (outbuf) = timestamp;
   GST_BUFFER_DURATION (outbuf) = duration;
   if (discont)
     GST_BUFFER_FLAG_SET (outbuf, GST_BUFFER_FLAG_DISCONT);
-  gst_buffer_set_caps (outbuf, GST_PAD_CAPS (ffmpegenc->srcpad));
+  gst_buffer_set_caps (outbuf, GST_PAD_CAPS (ffmpegaudenc->srcpad));
 
-  GST_LOG_OBJECT (ffmpegenc, "pushing size %d, timestamp %" GST_TIME_FORMAT,
+  GST_LOG_OBJECT (ffmpegaudenc, "pushing size %d, timestamp %" GST_TIME_FORMAT,
       res, GST_TIME_ARGS (timestamp));
 
-  ret = gst_pad_push (ffmpegenc->srcpad, outbuf);
+  ret = gst_pad_push (ffmpegaudenc->srcpad, outbuf);
 
   return ret;
 }
 
 static GstFlowReturn
-gst_ffmpegenc_chain_audio (GstPad * pad, GstBuffer * inbuf)
+gst_ffmpegaudenc_chain_audio (GstPad * pad, GstBuffer * inbuf)
 {
-  GstFFMpegEnc *ffmpegenc;
-  GstFFMpegEncClass *oclass;
+  GstFFMpegAudEnc *ffmpegaudenc;
+  GstFFMpegAudEncClass *oclass;
   AVCodecContext *ctx;
   GstClockTime timestamp, duration;
   guint size, frame_size;
@@ -902,17 +427,17 @@ gst_ffmpegenc_chain_audio (GstPad * pad, GstBuffer * inbuf)
   gboolean discont;
   guint8 *in_data;
 
-  ffmpegenc = (GstFFMpegEnc *) (GST_OBJECT_PARENT (pad));
-  oclass = (GstFFMpegEncClass *) G_OBJECT_GET_CLASS (ffmpegenc);
+  ffmpegaudenc = (GstFFMpegAudEnc *) (GST_OBJECT_PARENT (pad));
+  oclass = (GstFFMpegAudEncClass *) G_OBJECT_GET_CLASS (ffmpegaudenc);
 
-  ctx = ffmpegenc->context;
+  ctx = ffmpegaudenc->context;
 
   size = GST_BUFFER_SIZE (inbuf);
   timestamp = GST_BUFFER_TIMESTAMP (inbuf);
   duration = GST_BUFFER_DURATION (inbuf);
   discont = GST_BUFFER_IS_DISCONT (inbuf);
 
-  GST_DEBUG_OBJECT (ffmpegenc,
+  GST_DEBUG_OBJECT (ffmpegaudenc,
       "Received time %" GST_TIME_FORMAT ", duration %" GST_TIME_FORMAT
       ", size %d", GST_TIME_ARGS (timestamp), GST_TIME_ARGS (duration), size);
 
@@ -924,17 +449,17 @@ gst_ffmpegenc_chain_audio (GstPad * pad, GstBuffer * inbuf)
     guint avail, frame_bytes;
 
     if (discont) {
-      GST_LOG_OBJECT (ffmpegenc, "DISCONT, clear adapter");
-      gst_adapter_clear (ffmpegenc->adapter);
-      ffmpegenc->discont = TRUE;
+      GST_LOG_OBJECT (ffmpegaudenc, "DISCONT, clear adapter");
+      gst_adapter_clear (ffmpegaudenc->adapter);
+      ffmpegaudenc->discont = TRUE;
     }
 
-    if (gst_adapter_available (ffmpegenc->adapter) == 0) {
+    if (gst_adapter_available (ffmpegaudenc->adapter) == 0) {
       /* lock on to new timestamp */
-      GST_LOG_OBJECT (ffmpegenc, "taking buffer timestamp %" GST_TIME_FORMAT,
+      GST_LOG_OBJECT (ffmpegaudenc, "taking buffer timestamp %" GST_TIME_FORMAT,
           GST_TIME_ARGS (timestamp));
-      ffmpegenc->adapter_ts = timestamp;
-      ffmpegenc->adapter_consumed = 0;
+      ffmpegaudenc->adapter_ts = timestamp;
+      ffmpegaudenc->adapter_consumed = 0;
     } else {
       GstClockTime upstream_time;
       GstClockTime consumed_time;
@@ -942,18 +467,20 @@ gst_ffmpegenc_chain_audio (GstPad * pad, GstBuffer * inbuf)
 
       /* use timestamp at head of the adapter */
       consumed_time =
-          gst_util_uint64_scale (ffmpegenc->adapter_consumed, GST_SECOND,
+          gst_util_uint64_scale (ffmpegaudenc->adapter_consumed, GST_SECOND,
           ctx->sample_rate);
-      timestamp = ffmpegenc->adapter_ts + consumed_time;
-      GST_LOG_OBJECT (ffmpegenc, "taking adapter timestamp %" GST_TIME_FORMAT
+      timestamp = ffmpegaudenc->adapter_ts + consumed_time;
+      GST_LOG_OBJECT (ffmpegaudenc, "taking adapter timestamp %" GST_TIME_FORMAT
           " and adding consumed time %" GST_TIME_FORMAT,
-          GST_TIME_ARGS (ffmpegenc->adapter_ts), GST_TIME_ARGS (consumed_time));
+          GST_TIME_ARGS (ffmpegaudenc->adapter_ts),
+          GST_TIME_ARGS (consumed_time));
 
       /* check with upstream timestamps, if too much deviation,
        * forego some timestamp perfection in favour of upstream syncing
        * (particularly in case these do not happen to come in multiple
        * of frame size) */
-      upstream_time = gst_adapter_prev_timestamp (ffmpegenc->adapter, &bytes);
+      upstream_time =
+          gst_adapter_prev_timestamp (ffmpegaudenc->adapter, &bytes);
       if (GST_CLOCK_TIME_IS_VALID (upstream_time)) {
         GstClockTimeDiff diff;
 
@@ -963,32 +490,33 @@ gst_ffmpegenc_chain_audio (GstPad * pad, GstBuffer * inbuf)
         diff = upstream_time - timestamp;
         /* relaxed difference, rather than half a sample or so ... */
         if (diff > GST_SECOND / 10 || diff < -GST_SECOND / 10) {
-          GST_DEBUG_OBJECT (ffmpegenc, "adapter timestamp drifting, "
+          GST_DEBUG_OBJECT (ffmpegaudenc, "adapter timestamp drifting, "
               "taking upstream timestamp %" GST_TIME_FORMAT,
               GST_TIME_ARGS (upstream_time));
           timestamp = upstream_time;
           /* samples corresponding to bytes */
-          ffmpegenc->adapter_consumed = bytes / (osize * ctx->channels);
-          ffmpegenc->adapter_ts = upstream_time -
-              gst_util_uint64_scale (ffmpegenc->adapter_consumed, GST_SECOND,
+          ffmpegaudenc->adapter_consumed = bytes / (osize * ctx->channels);
+          ffmpegaudenc->adapter_ts = upstream_time -
+              gst_util_uint64_scale (ffmpegaudenc->adapter_consumed, GST_SECOND,
               ctx->sample_rate);
-          ffmpegenc->discont = TRUE;
+          ffmpegaudenc->discont = TRUE;
         }
       }
     }
 
-    GST_LOG_OBJECT (ffmpegenc, "pushing buffer in adapter");
-    gst_adapter_push (ffmpegenc->adapter, inbuf);
+    GST_LOG_OBJECT (ffmpegaudenc, "pushing buffer in adapter");
+    gst_adapter_push (ffmpegaudenc->adapter, inbuf);
 
     /* first see how many bytes we need to feed to the decoder. */
     frame_bytes = frame_size * osize * ctx->channels;
-    avail = gst_adapter_available (ffmpegenc->adapter);
+    avail = gst_adapter_available (ffmpegaudenc->adapter);
 
-    GST_LOG_OBJECT (ffmpegenc, "frame_bytes %u, avail %u", frame_bytes, avail);
+    GST_LOG_OBJECT (ffmpegaudenc, "frame_bytes %u, avail %u", frame_bytes,
+        avail);
 
     /* while there is more than a frame size in the adapter, consume it */
     while (avail >= frame_bytes) {
-      GST_LOG_OBJECT (ffmpegenc, "taking %u bytes from the adapter",
+      GST_LOG_OBJECT (ffmpegaudenc, "taking %u bytes from the adapter",
           frame_bytes);
 
       /* Note that we take frame_bytes and add frame_size.
@@ -996,24 +524,25 @@ gst_ffmpegenc_chain_audio (GstPad * pad, GstBuffer * inbuf)
        * or samplesize to divide by the samplerate */
 
       /* take an audio buffer out of the adapter */
-      in_data = (guint8 *) gst_adapter_peek (ffmpegenc->adapter, frame_bytes);
-      ffmpegenc->adapter_consumed += frame_size;
+      in_data =
+          (guint8 *) gst_adapter_peek (ffmpegaudenc->adapter, frame_bytes);
+      ffmpegaudenc->adapter_consumed += frame_size;
 
       /* calculate timestamp and duration relative to start of adapter and to
        * the amount of samples we consumed */
       duration =
-          gst_util_uint64_scale (ffmpegenc->adapter_consumed, GST_SECOND,
+          gst_util_uint64_scale (ffmpegaudenc->adapter_consumed, GST_SECOND,
           ctx->sample_rate);
-      duration -= (timestamp - ffmpegenc->adapter_ts);
+      duration -= (timestamp - ffmpegaudenc->adapter_ts);
 
       /* 4 times the input size should be big enough... */
       out_size = frame_bytes * 4;
 
       ret =
-          gst_ffmpegenc_encode_audio (ffmpegenc, in_data, frame_bytes, out_size,
-          timestamp, duration, ffmpegenc->discont);
+          gst_ffmpegaudenc_encode_audio (ffmpegaudenc, in_data, frame_bytes,
+          out_size, timestamp, duration, ffmpegaudenc->discont);
 
-      gst_adapter_flush (ffmpegenc->adapter, frame_bytes);
+      gst_adapter_flush (ffmpegaudenc->adapter, frame_bytes);
 
       if (ret != GST_FLOW_OK)
         goto push_failed;
@@ -1021,23 +550,23 @@ gst_ffmpegenc_chain_audio (GstPad * pad, GstBuffer * inbuf)
       /* advance the adapter timestamp with the duration */
       timestamp += duration;
 
-      ffmpegenc->discont = FALSE;
-      avail = gst_adapter_available (ffmpegenc->adapter);
+      ffmpegaudenc->discont = FALSE;
+      avail = gst_adapter_available (ffmpegaudenc->adapter);
     }
-    GST_LOG_OBJECT (ffmpegenc, "%u bytes left in the adapter", avail);
+    GST_LOG_OBJECT (ffmpegaudenc, "%u bytes left in the adapter", avail);
   } else {
     /* we have no frame_size, feed the encoder all the data and expect a fixed
      * output size */
     int coded_bps = av_get_bits_per_sample (oclass->in_plugin->id);
 
-    GST_LOG_OBJECT (ffmpegenc, "coded bps %d, osize %d", coded_bps, osize);
+    GST_LOG_OBJECT (ffmpegaudenc, "coded bps %d, osize %d", coded_bps, osize);
 
     out_size = size / osize;
     if (coded_bps)
       out_size = (out_size * coded_bps) / 8;
 
     in_data = (guint8 *) GST_BUFFER_DATA (inbuf);
-    ret = gst_ffmpegenc_encode_audio (ffmpegenc, in_data, size, out_size,
+    ret = gst_ffmpegaudenc_encode_audio (ffmpegaudenc, in_data, size, out_size,
         timestamp, duration, discont);
     gst_buffer_unref (inbuf);
 
@@ -1050,144 +579,24 @@ gst_ffmpegenc_chain_audio (GstPad * pad, GstBuffer * inbuf)
   /* ERRORS */
 push_failed:
   {
-    GST_DEBUG_OBJECT (ffmpegenc, "Failed to push buffer %d (%s)", ret,
+    GST_DEBUG_OBJECT (ffmpegaudenc, "Failed to push buffer %d (%s)", ret,
         gst_flow_get_name (ret));
     return ret;
   }
 }
 
-static void
-gst_ffmpegenc_flush_buffers (GstFFMpegEnc * ffmpegenc, gboolean send)
-{
-  GstBuffer *outbuf, *inbuf;
-  gint ret_size;
-
-  GST_DEBUG_OBJECT (ffmpegenc, "flushing buffers with sending %d", send);
-
-  /* no need to empty codec if there is none */
-  if (!ffmpegenc->opened)
-    goto flush;
-
-  while (!g_queue_is_empty (ffmpegenc->delay)) {
-
-    ffmpegenc_setup_working_buf (ffmpegenc);
-
-    ret_size = avcodec_encode_video (ffmpegenc->context,
-        ffmpegenc->working_buf, ffmpegenc->working_buf_size, NULL);
-
-    if (ret_size < 0) {         /* there should be something, notify and give up */
-#ifndef GST_DISABLE_GST_DEBUG
-      GstFFMpegEncClass *oclass =
-          (GstFFMpegEncClass *) (G_OBJECT_GET_CLASS (ffmpegenc));
-      GST_WARNING_OBJECT (ffmpegenc,
-          "ffenc_%s: failed to flush buffer", oclass->in_plugin->name);
-#endif /* GST_DISABLE_GST_DEBUG */
-      break;
-    }
-
-    /* save stats info if there is some as well as a stats file */
-    if (ffmpegenc->file && ffmpegenc->context->stats_out)
-      if (fprintf (ffmpegenc->file, "%s", ffmpegenc->context->stats_out) < 0)
-        GST_ELEMENT_ERROR (ffmpegenc, RESOURCE, WRITE,
-            (("Could not write to file \"%s\"."), ffmpegenc->filename),
-            GST_ERROR_SYSTEM);
-
-    /* handle b-frame delay when no output, so we don't output empty frames */
-    inbuf = g_queue_pop_head (ffmpegenc->delay);
-
-    outbuf = gst_buffer_new_and_alloc (ret_size);
-    memcpy (GST_BUFFER_DATA (outbuf), ffmpegenc->working_buf, ret_size);
-    GST_BUFFER_TIMESTAMP (outbuf) = GST_BUFFER_TIMESTAMP (inbuf);
-    GST_BUFFER_DURATION (outbuf) = GST_BUFFER_DURATION (inbuf);
-
-    if (!ffmpegenc->context->coded_frame->key_frame)
-      GST_BUFFER_FLAG_SET (outbuf, GST_BUFFER_FLAG_DELTA_UNIT);
-    gst_buffer_set_caps (outbuf, GST_PAD_CAPS (ffmpegenc->srcpad));
-
-    gst_buffer_unref (inbuf);
-
-    if (send)
-      gst_pad_push (ffmpegenc->srcpad, outbuf);
-    else
-      gst_buffer_unref (outbuf);
-  }
-
-flush:
-  {
-    /* make sure that we empty the queue, is still needed if we had to break */
-    while (!g_queue_is_empty (ffmpegenc->delay))
-      gst_buffer_unref (g_queue_pop_head (ffmpegenc->delay));
-  }
-}
-
-static gboolean
-gst_ffmpegenc_event_video (GstPad * pad, GstEvent * event)
-{
-  GstFFMpegEnc *ffmpegenc = (GstFFMpegEnc *) (GST_PAD_PARENT (pad));
-
-  switch (GST_EVENT_TYPE (event)) {
-    case GST_EVENT_EOS:
-      gst_ffmpegenc_flush_buffers (ffmpegenc, TRUE);
-      break;
-      /* no flushing if flush received,
-       * buffers in encoder are considered (in the) past */
-
-    case GST_EVENT_CUSTOM_DOWNSTREAM:{
-      const GstStructure *s;
-      s = gst_event_get_structure (event);
-      if (gst_structure_has_name (s, "GstForceKeyUnit")) {
-        ffmpegenc->picture->pict_type = FF_I_TYPE;
-      }
-      break;
-    }
-    default:
-      break;
-  }
-
-  return gst_pad_push_event (ffmpegenc->srcpad, event);
-}
-
-static gboolean
-gst_ffmpegenc_event_src (GstPad * pad, GstEvent * event)
-{
-  GstFFMpegEnc *ffmpegenc = (GstFFMpegEnc *) (GST_PAD_PARENT (pad));
-  gboolean forward = TRUE;
-
-  switch (GST_EVENT_TYPE (event)) {
-    case GST_EVENT_CUSTOM_UPSTREAM:{
-      const GstStructure *s;
-      s = gst_event_get_structure (event);
-      if (gst_structure_has_name (s, "GstForceKeyUnit")) {
-        GST_OBJECT_LOCK (ffmpegenc);
-        ffmpegenc->force_keyframe = TRUE;
-        GST_OBJECT_UNLOCK (ffmpegenc);
-        forward = FALSE;
-        gst_event_unref (event);
-      }
-      break;
-    }
-
-    default:
-      break;
-  }
-
-  if (forward)
-    return gst_pad_push_event (ffmpegenc->sinkpad, event);
-  else
-    return TRUE;
-}
 
 static void
-gst_ffmpegenc_set_property (GObject * object,
+gst_ffmpegaudenc_set_property (GObject * object,
     guint prop_id, const GValue * value, GParamSpec * pspec)
 {
-  GstFFMpegEnc *ffmpegenc;
+  GstFFMpegAudEnc *ffmpegaudenc;
 
   /* Get a pointer of the right type. */
-  ffmpegenc = (GstFFMpegEnc *) (object);
+  ffmpegaudenc = (GstFFMpegAudEnc *) (object);
 
-  if (ffmpegenc->opened) {
-    GST_WARNING_OBJECT (ffmpegenc,
+  if (ffmpegaudenc->opened) {
+    GST_WARNING_OBJECT (ffmpegaudenc,
         "Can't change properties once decoder is setup !");
     return;
   }
@@ -1195,63 +604,49 @@ gst_ffmpegenc_set_property (GObject * object,
   /* Check the argument id to see which argument we're setting. */
   switch (prop_id) {
     case ARG_BIT_RATE:
-      ffmpegenc->bitrate = g_value_get_ulong (value);
-      break;
-    case ARG_GOP_SIZE:
-      ffmpegenc->gop_size = g_value_get_int (value);
-      break;
-    case ARG_ME_METHOD:
-      ffmpegenc->me_method = g_value_get_enum (value);
+      ffmpegaudenc->bitrate = g_value_get_ulong (value);
       break;
     case ARG_BUFSIZE:
       break;
     case ARG_RTP_PAYLOAD_SIZE:
-      ffmpegenc->rtp_payload_size = g_value_get_ulong (value);
+      ffmpegaudenc->rtp_payload_size = g_value_get_ulong (value);
       break;
     default:
-      if (!gst_ffmpeg_cfg_set_property (object, value, pspec))
-        G_OBJECT_WARN_INVALID_PROPERTY_ID (object, prop_id, pspec);
+      G_OBJECT_WARN_INVALID_PROPERTY_ID (object, prop_id, pspec);
       break;
   }
 }
 
 /* The set function is simply the inverse of the get fuction. */
 static void
-gst_ffmpegenc_get_property (GObject * object,
+gst_ffmpegaudenc_get_property (GObject * object,
     guint prop_id, GValue * value, GParamSpec * pspec)
 {
-  GstFFMpegEnc *ffmpegenc;
+  GstFFMpegAudEnc *ffmpegaudenc;
 
   /* It's not null if we got it, but it might not be ours */
-  ffmpegenc = (GstFFMpegEnc *) (object);
+  ffmpegaudenc = (GstFFMpegAudEnc *) (object);
 
   switch (prop_id) {
     case ARG_BIT_RATE:
-      g_value_set_ulong (value, ffmpegenc->bitrate);
-      break;
-    case ARG_GOP_SIZE:
-      g_value_set_int (value, ffmpegenc->gop_size);
-      break;
-    case ARG_ME_METHOD:
-      g_value_set_enum (value, ffmpegenc->me_method);
+      g_value_set_ulong (value, ffmpegaudenc->bitrate);
       break;
     case ARG_BUFSIZE:
-      g_value_set_ulong (value, ffmpegenc->buffer_size);
+      g_value_set_ulong (value, ffmpegaudenc->buffer_size);
       break;
     case ARG_RTP_PAYLOAD_SIZE:
-      g_value_set_ulong (value, ffmpegenc->rtp_payload_size);
+      g_value_set_ulong (value, ffmpegaudenc->rtp_payload_size);
       break;
     default:
-      if (!gst_ffmpeg_cfg_get_property (object, value, pspec))
-        G_OBJECT_WARN_INVALID_PROPERTY_ID (object, prop_id, pspec);
+      G_OBJECT_WARN_INVALID_PROPERTY_ID (object, prop_id, pspec);
       break;
   }
 }
 
 static GstStateChangeReturn
-gst_ffmpegenc_change_state (GstElement * element, GstStateChange transition)
+gst_ffmpegaudenc_change_state (GstElement * element, GstStateChange transition)
 {
-  GstFFMpegEnc *ffmpegenc = (GstFFMpegEnc *) element;
+  GstFFMpegAudEnc *ffmpegaudenc = (GstFFMpegAudEnc *) element;
   GstStateChangeReturn result;
 
   switch (transition) {
@@ -1263,21 +658,11 @@ gst_ffmpegenc_change_state (GstElement * element, GstStateChange transition)
 
   switch (transition) {
     case GST_STATE_CHANGE_PAUSED_TO_READY:
-      gst_ffmpegenc_flush_buffers (ffmpegenc, FALSE);
-      if (ffmpegenc->opened) {
-        gst_ffmpeg_avcodec_close (ffmpegenc->context);
-        ffmpegenc->opened = FALSE;
-      }
-      gst_adapter_clear (ffmpegenc->adapter);
-
-      if (ffmpegenc->file) {
-        fclose (ffmpegenc->file);
-        ffmpegenc->file = NULL;
-      }
-      if (ffmpegenc->working_buf) {
-        g_free (ffmpegenc->working_buf);
-        ffmpegenc->working_buf = NULL;
+      if (ffmpegaudenc->opened) {
+        gst_ffmpeg_avcodec_close (ffmpegaudenc->context);
+        ffmpegaudenc->opened = FALSE;
       }
+      gst_adapter_clear (ffmpegaudenc->adapter);
       break;
     default:
       break;
@@ -1286,18 +671,18 @@ gst_ffmpegenc_change_state (GstElement * element, GstStateChange transition)
 }
 
 gboolean
-gst_ffmpegenc_register (GstPlugin * plugin)
+gst_ffmpegaudenc_register (GstPlugin * plugin)
 {
   GTypeInfo typeinfo = {
-    sizeof (GstFFMpegEncClass),
-    (GBaseInitFunc) gst_ffmpegenc_base_init,
+    sizeof (GstFFMpegAudEncClass),
+    (GBaseInitFunc) gst_ffmpegaudenc_base_init,
     NULL,
-    (GClassInitFunc) gst_ffmpegenc_class_init,
+    (GClassInitFunc) gst_ffmpegaudenc_class_init,
     NULL,
     NULL,
-    sizeof (GstFFMpegEnc),
+    sizeof (GstFFMpegAudEnc),
     0,
-    (GInstanceInitFunc) gst_ffmpegenc_init,
+    (GInstanceInitFunc) gst_ffmpegaudenc_init,
   };
   GType type;
   AVCodec *in_plugin;
@@ -1305,16 +690,12 @@ gst_ffmpegenc_register (GstPlugin * plugin)
 
   GST_LOG ("Registering encoders");
 
-  /* build global ffmpeg param/property info */
-  gst_ffmpeg_cfg_init ();
-
   in_plugin = av_codec_next (NULL);
   while (in_plugin) {
     gchar *type_name;
 
     /* Skip non-AV codecs */
-    if (in_plugin->type != AVMEDIA_TYPE_AUDIO &&
-        in_plugin->type != AVMEDIA_TYPE_VIDEO)
+    if (in_plugin->type != AVMEDIA_TYPE_AUDIO)
       goto next;
 
     /* no quasi codecs, please */
diff --git a/ext/ffmpeg/gstffmpegenc.h b/ext/ffmpeg/gstffmpegenc.h
index c13a0d3..ec49d8e 100644
--- a/ext/ffmpeg/gstffmpegenc.h
+++ b/ext/ffmpeg/gstffmpegenc.h
@@ -21,16 +21,16 @@
  * object definition and other useful things.
  */
 
-#ifndef __GST_FFMPEGENC_H__
-#define __GST_FFMPEGENC_H__
+#ifndef __GST_FFMPEGAUDENC_H__
+#define __GST_FFMPEGAUDENC_H__
 
 G_BEGIN_DECLS
 
 #include <gst/base/gstadapter.h>
 
-typedef struct _GstFFMpegEnc GstFFMpegEnc;
+typedef struct _GstFFMpegAudEnc GstFFMpegAudEnc;
 
-struct _GstFFMpegEnc
+struct _GstFFMpegAudEnc
 {
   GstElement element;
 
@@ -39,7 +39,6 @@ struct _GstFFMpegEnc
   GstPad *sinkpad;
 
   AVCodecContext *context;
-  AVFrame *picture;
   gboolean opened;
   GstClockTime adapter_ts;
   guint64 adapter_consumed;
@@ -48,39 +47,17 @@ struct _GstFFMpegEnc
 
   /* cache */
   gulong bitrate;
-  gint me_method;
-  gint gop_size;
   gulong buffer_size;
   gulong rtp_payload_size;
 
-  guint8 *working_buf;
-  gulong working_buf_size;
-
-  /* settings with some special handling */
-  guint pass;
-  gfloat quantizer;
-  gchar *filename;
-  guint lmin;
-  guint lmax;
-  gint max_key_interval;
-  gboolean interlaced;
-
-  /* statistics file */
-  FILE *file;
-
-  /* for b-frame delay handling */
-  GQueue *delay;
-
   /* other settings are copied over straight,
    * include a context here, rather than copy-and-past it from avcodec.h */
   AVCodecContext config;
-
-  gboolean force_keyframe;
 };
 
-typedef struct _GstFFMpegEncClass GstFFMpegEncClass;
+typedef struct _GstFFMpegAudEncClass GstFFMpegAudEncClass;
 
-struct _GstFFMpegEncClass
+struct _GstFFMpegAudEncClass
 {
   GstElementClass parent_class;
 
@@ -89,17 +66,17 @@ struct _GstFFMpegEncClass
   GstCaps *sinkcaps;
 };
 
-#define GST_TYPE_FFMPEGENC \
-  (gst_ffmpegenc_get_type())
-#define GST_FFMPEGENC(obj) \
-  (G_TYPE_CHECK_INSTANCE_CAST((obj),GST_TYPE_FFMPEGENC,GstFFMpegEnc))
-#define GST_FFMPEGENC_CLASS(klass) \
-  (G_TYPE_CHECK_CLASS_CAST((klass),GST_TYPE_FFMPEGENC,GstFFMpegEncClass))
-#define GST_IS_FFMPEGENC(obj) \
-  (G_TYPE_CHECK_INSTANCE_TYPE((obj),GST_TYPE_FFMPEGENC))
-#define GST_IS_FFMPEGENC_CLASS(klass) \
-  (G_TYPE_CHECK_CLASS_TYPE((klass),GST_TYPE_FFMPEGENC))
+#define GST_TYPE_FFMPEGAUDENC \
+  (gst_ffmpegaudenc_get_type())
+#define GST_FFMPEGAUDENC(obj) \
+  (G_TYPE_CHECK_INSTANCE_CAST((obj),GST_TYPE_FFMPEGAUDENC,GstFFMpegAudEnc))
+#define GST_FFMPEGAUDENC_CLASS(klass) \
+  (G_TYPE_CHECK_CLASS_CAST((klass),GST_TYPE_FFMPEGAUDENC,GstFFMpegAudEncClass))
+#define GST_IS_FFMPEGAUDENC(obj) \
+  (G_TYPE_CHECK_INSTANCE_TYPE((obj),GST_TYPE_FFMPEGAUDENC))
+#define GST_IS_FFMPEGAUDENC_CLASS(klass) \
+  (G_TYPE_CHECK_CLASS_TYPE((klass),GST_TYPE_FFMPEGAUDENC))
 
 G_END_DECLS
 
-#endif /* __GST_FFMPEGENC_H__ */
+#endif /* __GST_FFMPEGAUDENC_H__ */
diff --git a/ext/ffmpeg/gstffmpegmux.c b/ext/ffmpeg/gstffmpegmux.c
index 538aeed..687203a 100644
--- a/ext/ffmpeg/gstffmpegmux.c
+++ b/ext/ffmpeg/gstffmpegmux.c
@@ -29,7 +29,7 @@
 #endif
 
 #include <gst/gst.h>
-#include <gst/base/gstcollectpads.h>
+#include <gst/base/gstcollectpads2.h>
 
 #include "gstffmpeg.h"
 #include "gstffmpegcodecmap.h"
@@ -40,7 +40,7 @@ typedef struct _GstFFMpegMuxPad GstFFMpegMuxPad;
 
 struct _GstFFMpegMuxPad
 {
-  GstCollectData collect;       /* we extend the CollectData */
+  GstCollectData2 collect;      /* we extend the CollectData2 */
 
   gint padnum;
 };
@@ -49,7 +49,7 @@ struct _GstFFMpegMux
 {
   GstElement element;
 
-  GstCollectPads *collect;
+  GstCollectPads2 *collect;
   /* We need to keep track of our pads, so we do so here. */
   GstPad *srcpad;
 
@@ -114,7 +114,7 @@ static void gst_ffmpegmux_finalize (GObject * object);
 static gboolean gst_ffmpegmux_setcaps (GstPad * pad, GstCaps * caps);
 static GstPad *gst_ffmpegmux_request_new_pad (GstElement * element,
     GstPadTemplate * templ, const gchar * name);
-static GstFlowReturn gst_ffmpegmux_collected (GstCollectPads * pads,
+static GstFlowReturn gst_ffmpegmux_collected (GstCollectPads2 * pads,
     gpointer user_data);
 
 static gboolean gst_ffmpegmux_sink_event (GstPad * pad, GstEvent * event);
@@ -272,17 +272,20 @@ gst_ffmpegmux_base_init (gpointer g_class)
   /* pad templates */
   srctempl = gst_pad_template_new ("src", GST_PAD_SRC, GST_PAD_ALWAYS, srccaps);
   gst_element_class_add_pad_template (element_class, srctempl);
+  gst_object_unref (srctempl);
 
   if (audiosinkcaps) {
     audiosinktempl = gst_pad_template_new ("audio_%d",
         GST_PAD_SINK, GST_PAD_REQUEST, audiosinkcaps);
     gst_element_class_add_pad_template (element_class, audiosinktempl);
+    gst_object_unref (audiosinktempl);
   }
 
   if (videosinkcaps) {
     videosinktempl = gst_pad_template_new ("video_%d",
         GST_PAD_SINK, GST_PAD_REQUEST, videosinkcaps);
     gst_element_class_add_pad_template (element_class, videosinktempl);
+    gst_object_unref (videosinktempl);
   }
 
 beach:
@@ -329,9 +332,9 @@ gst_ffmpegmux_init (GstFFMpegMux * ffmpegmux, GstFFMpegMuxClass * g_class)
   gst_pad_set_caps (ffmpegmux->srcpad, gst_pad_template_get_caps (templ));
   gst_element_add_pad (GST_ELEMENT (ffmpegmux), ffmpegmux->srcpad);
 
-  ffmpegmux->collect = gst_collect_pads_new ();
-  gst_collect_pads_set_function (ffmpegmux->collect,
-      (GstCollectPadsFunction) gst_ffmpegmux_collected, ffmpegmux);
+  ffmpegmux->collect = gst_collect_pads2_new ();
+  gst_collect_pads2_set_function (ffmpegmux->collect,
+      (GstCollectPads2Function) gst_ffmpegmux_collected, ffmpegmux);
 
   ffmpegmux->context = g_new0 (AVFormatContext, 1);
   ffmpegmux->context->oformat = oclass->in_plugin;
@@ -437,7 +440,7 @@ gst_ffmpegmux_request_new_pad (GstElement * element,
   /* create pad */
   pad = gst_pad_new_from_template (templ, padname);
   collect_pad = (GstFFMpegMuxPad *)
-      gst_collect_pads_add_pad (ffmpegmux->collect, pad,
+      gst_collect_pads2_add_pad (ffmpegmux->collect, pad,
       sizeof (GstFFMpegMuxPad));
   collect_pad->padnum = ffmpegmux->context->nb_streams;
 
@@ -537,7 +540,7 @@ gst_ffmpegmux_sink_event (GstPad * pad, GstEvent * event)
 }
 
 static GstFlowReturn
-gst_ffmpegmux_collected (GstCollectPads * pads, gpointer user_data)
+gst_ffmpegmux_collected (GstCollectPads2 * pads, gpointer user_data)
 {
   GstFFMpegMux *ffmpegmux = (GstFFMpegMux *) user_data;
   GSList *collected;
@@ -586,8 +589,8 @@ gst_ffmpegmux_collected (GstCollectPads * pads, gpointer user_data)
 
             /* FIXME : This doesn't work for RAW AUDIO...
              * in fact I'm wondering if it even works for any kind of audio... */
-            buffer = gst_collect_pads_peek (ffmpegmux->collect,
-                (GstCollectData *) collect_pad);
+            buffer = gst_collect_pads2_peek (ffmpegmux->collect,
+                (GstCollectData2 *) collect_pad);
             if (buffer) {
               st->codec->frame_size =
                   st->codec->sample_rate *
@@ -680,8 +683,8 @@ gst_ffmpegmux_collected (GstCollectPads * pads, gpointer user_data)
   for (collected = ffmpegmux->collect->data; collected;
       collected = g_slist_next (collected)) {
     GstFFMpegMuxPad *collect_pad = (GstFFMpegMuxPad *) collected->data;
-    GstBuffer *buffer = gst_collect_pads_peek (ffmpegmux->collect,
-        (GstCollectData *) collect_pad);
+    GstBuffer *buffer = gst_collect_pads2_peek (ffmpegmux->collect,
+        (GstCollectData2 *) collect_pad);
 
     /* if there's no buffer, just continue */
     if (buffer == NULL) {
@@ -717,8 +720,8 @@ gst_ffmpegmux_collected (GstCollectPads * pads, gpointer user_data)
     gboolean need_free = FALSE;
 
     /* push out current buffer */
-    buf = gst_collect_pads_pop (ffmpegmux->collect,
-        (GstCollectData *) best_pad);
+    buf = gst_collect_pads2_pop (ffmpegmux->collect,
+        (GstCollectData2 *) best_pad);
 
     ffmpegmux->context->streams[best_pad->padnum]->codec->frame_number++;
 
@@ -782,19 +785,19 @@ gst_ffmpegmux_collected (GstCollectPads * pads, gpointer user_data)
 static GstStateChangeReturn
 gst_ffmpegmux_change_state (GstElement * element, GstStateChange transition)
 {
-  GstFlowReturn ret;
+  GstStateChangeReturn ret;
   GstFFMpegMux *ffmpegmux = (GstFFMpegMux *) (element);
 
   switch (transition) {
     case GST_STATE_CHANGE_NULL_TO_READY:
       break;
     case GST_STATE_CHANGE_READY_TO_PAUSED:
-      gst_collect_pads_start (ffmpegmux->collect);
+      gst_collect_pads2_start (ffmpegmux->collect);
       break;
     case GST_STATE_CHANGE_PAUSED_TO_PLAYING:
       break;
     case GST_STATE_CHANGE_PAUSED_TO_READY:
-      gst_collect_pads_stop (ffmpegmux->collect);
+      gst_collect_pads2_stop (ffmpegmux->collect);
       break;
     default:
       break;
diff --git a/ext/ffmpeg/gstffmpegscale.c b/ext/ffmpeg/gstffmpegscale.c
new file mode 100644
index 0000000..ac5c7e1
--- /dev/null
+++ b/ext/ffmpeg/gstffmpegscale.c
@@ -0,0 +1,403 @@
+/* GStreamer
+ * Copyright (C) <1999> Erik Walthinsen <omega@cse.ogi.edu>
+ * This file:
+ * Copyright (C) 2005 Luca Ognibene <luogni@tin.it>
+ * Copyright (C) 2006 Martin Zlomek <martin.zlomek@itonis.tv>
+ *
+ * This library is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU Library General Public
+ * License as published by the Free Software Foundation; either
+ * version 2 of the License, or (at your option) any later version.
+ *
+ * This library is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+ * Library General Public License for more details.
+ *
+ * You should have received a copy of the GNU Library General Public
+ * License along with this library; if not, write to the
+ * Free Software Foundation, Inc., 59 Temple Place - Suite 330,
+ * Boston, MA 02111-1307, USA.
+ */
+
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
+#ifdef HAVE_FFMPEG_UNINSTALLED
+#include <avcodec.h>
+#else
+#include <ffmpeg/avcodec.h>
+#endif
+
+#include <gst/gst.h>
+#include <gst/base/gstbasetransform.h>
+#include <gst/video/video.h>
+
+#include "gstffmpeg.h"
+#include "gstffmpegcodecmap.h"
+
+typedef struct _GstFFMpegScale
+{
+  GstBaseTransform element;
+
+  GstPad *sinkpad, *srcpad;
+
+  gint in_width, in_height;
+  gint out_width, out_height;
+
+  enum PixelFormat pixfmt;
+
+  ImgReSampleContext *res;
+} GstFFMpegScale;
+
+typedef struct _GstFFMpegScaleClass
+{
+  GstBaseTransformClass parent_class;
+} GstFFMpegScaleClass;
+
+#define GST_TYPE_FFMPEGSCALE \
+	(gst_ffmpegscale_get_type())
+#define GST_FFMPEGSCALE(obj) \
+	(G_TYPE_CHECK_INSTANCE_CAST((obj),GST_TYPE_FFMPEGSCALE,GstFFMpegScale))
+#define GST_FFMPEGSCALE_CLASS(klass) \
+	(G_TYPE_CHECK_CLASS_CAST((klass),GST_TYPE_FFMPEGSCALE,GstFFMpegScaleClass))
+#define GST_IS_FFMPEGSCALE(obj) \
+	(G_TYPE_CHECK_INSTANCE_TYPE((obj),GST_TYPE_FFMPEGSCALE))
+#define GST_IS_FFMPEGSCALE_CLASS(klass) \
+	(G_TYPE_CHECK_CLASS_TYPE((klass),GST_TYPE_FFMPEGSCALE))
+
+static GstStaticPadTemplate src_factory = GST_STATIC_PAD_TEMPLATE ("src",
+    GST_PAD_SRC,
+    GST_PAD_ALWAYS,
+    GST_STATIC_CAPS (GST_VIDEO_CAPS_YUV ("I420"))
+    );
+
+static GstStaticPadTemplate sink_factory = GST_STATIC_PAD_TEMPLATE ("sink",
+    GST_PAD_SINK,
+    GST_PAD_ALWAYS,
+    GST_STATIC_CAPS (GST_VIDEO_CAPS_YUV ("I420"))
+    );
+
+GST_BOILERPLATE (GstFFMpegScale, gst_ffmpegscale, GstBaseTransform,
+    GST_TYPE_BASE_TRANSFORM);
+
+static void gst_ffmpegscale_finalize (GObject * object);
+
+static GstCaps *gst_ffmpegscale_transform_caps (GstBaseTransform * trans,
+    GstPadDirection direction, GstCaps * caps);
+static void gst_ffmpegscale_fixate_caps (GstBaseTransform * trans,
+    GstPadDirection direction, GstCaps * caps, GstCaps * othercaps);
+static gboolean gst_ffmpegscale_get_unit_size (GstBaseTransform * trans,
+    GstCaps * caps, guint * size);
+static gboolean gst_ffmpegscale_set_caps (GstBaseTransform * trans,
+    GstCaps * incaps, GstCaps * outcaps);
+static GstFlowReturn gst_ffmpegscale_transform (GstBaseTransform * trans,
+    GstBuffer * inbuf, GstBuffer * outbuf);
+
+static gboolean gst_ffmpegscale_handle_src_event (GstPad * pad,
+    GstEvent * event);
+
+static void
+gst_ffmpegscale_base_init (gpointer g_class)
+{
+  GstElementClass *element_class = GST_ELEMENT_CLASS (g_class);
+
+  gst_element_class_add_static_pad_template (element_class, &src_factory);
+  gst_element_class_add_static_pad_template (element_class, &sink_factory);
+  gst_element_class_set_details_simple (element_class, "FFMPEG Scale element",
+      "Filter/Converter/Video/Scaler",
+      "Converts video from one resolution to another",
+      "Luca Ognibene <luogni@tin.it>");
+}
+
+static void
+gst_ffmpegscale_class_init (GstFFMpegScaleClass * klass)
+{
+  GObjectClass *gobject_class = G_OBJECT_CLASS (klass);
+  GstBaseTransformClass *trans_class = GST_BASE_TRANSFORM_CLASS (klass);
+
+  gobject_class->finalize = gst_ffmpegscale_finalize;
+
+  trans_class->transform_caps =
+      GST_DEBUG_FUNCPTR (gst_ffmpegscale_transform_caps);
+  trans_class->fixate_caps = GST_DEBUG_FUNCPTR (gst_ffmpegscale_fixate_caps);
+  trans_class->get_unit_size =
+      GST_DEBUG_FUNCPTR (gst_ffmpegscale_get_unit_size);
+  trans_class->set_caps = GST_DEBUG_FUNCPTR (gst_ffmpegscale_set_caps);
+  trans_class->transform = GST_DEBUG_FUNCPTR (gst_ffmpegscale_transform);
+
+  trans_class->passthrough_on_same_caps = TRUE;
+}
+
+static void
+gst_ffmpegscale_init (GstFFMpegScale * scale, GstFFMpegScaleClass * klass)
+{
+  GstBaseTransform *trans = GST_BASE_TRANSFORM (scale);
+
+  gst_pad_set_event_function (trans->srcpad, gst_ffmpegscale_handle_src_event);
+
+  scale->pixfmt = PIX_FMT_NB;
+  scale->res = NULL;
+}
+
+static void
+gst_ffmpegscale_finalize (GObject * object)
+{
+  GstFFMpegScale *scale = GST_FFMPEGSCALE (object);
+
+  if (scale->res != NULL)
+    img_resample_close (scale->res);
+
+  G_OBJECT_CLASS (parent_class)->finalize (object);
+}
+
+static GstCaps *
+gst_ffmpegscale_transform_caps (GstBaseTransform * trans,
+    GstPadDirection direction, GstCaps * caps)
+{
+  GstCaps *retcaps;
+  int i;
+
+  retcaps = gst_caps_copy (caps);
+
+  for (i = 0; i < gst_caps_get_size (retcaps); i++) {
+    GstStructure *structure = gst_caps_get_structure (retcaps, i);
+
+    gst_structure_set (structure,
+        "width", GST_TYPE_INT_RANGE, 16, 4096,
+        "height", GST_TYPE_INT_RANGE, 16, 4096, NULL);
+    gst_structure_remove_field (structure, "pixel-aspect-ratio");
+  }
+
+  return retcaps;
+}
+
+static void
+gst_ffmpegscale_fixate_caps (GstBaseTransform * trans,
+    GstPadDirection direction, GstCaps * caps, GstCaps * othercaps)
+{
+  GstStructure *instructure = gst_caps_get_structure (caps, 0);
+  GstStructure *outstructure = gst_caps_get_structure (othercaps, 0);
+  const GValue *in_par, *out_par;
+
+  in_par = gst_structure_get_value (instructure, "pixel-aspect-ratio");
+  out_par = gst_structure_get_value (outstructure, "pixel-aspect-ratio");
+
+  if (in_par && out_par) {
+    GValue out_ratio = { 0, };  /* w/h of output video */
+    int in_w, in_h, in_par_n, in_par_d, out_par_n, out_par_d;
+    int count = 0, w = 0, h = 0, num, den;
+
+    /* if both width and height are already fixed, we can't do anything
+     * about it anymore */
+    if (gst_structure_get_int (outstructure, "width", &w))
+      ++count;
+    if (gst_structure_get_int (outstructure, "height", &h))
+      ++count;
+    if (count == 2) {
+      GST_DEBUG_OBJECT (trans, "dimensions already set to %dx%d, not fixating",
+          w, h);
+      return;
+    }
+
+    gst_structure_get_int (instructure, "width", &in_w);
+    gst_structure_get_int (instructure, "height", &in_h);
+    in_par_n = gst_value_get_fraction_numerator (in_par);
+    in_par_d = gst_value_get_fraction_denominator (in_par);
+    out_par_n = gst_value_get_fraction_numerator (out_par);
+    out_par_d = gst_value_get_fraction_denominator (out_par);
+
+    g_value_init (&out_ratio, GST_TYPE_FRACTION);
+    gst_value_set_fraction (&out_ratio, in_w * in_par_n * out_par_d,
+        in_h * in_par_d * out_par_n);
+    num = gst_value_get_fraction_numerator (&out_ratio);
+    den = gst_value_get_fraction_denominator (&out_ratio);
+    GST_DEBUG_OBJECT (trans,
+        "scaling input with %dx%d and PAR %d/%d to output PAR %d/%d",
+        in_w, in_h, in_par_n, in_par_d, out_par_n, out_par_d);
+    GST_DEBUG_OBJECT (trans, "resulting output should respect ratio of %d/%d",
+        num, den);
+
+    /* now find a width x height that respects this display ratio.
+     * prefer those that have one of w/h the same as the incoming video
+     * using wd / hd = num / den */
+
+    /* start with same height, because of interlaced video */
+    /* check hd / den is an integer scale factor, and scale wd with the PAR */
+    if (in_h % den == 0) {
+      GST_DEBUG_OBJECT (trans, "keeping video height");
+      h = in_h;
+      w = h * num / den;
+    } else if (in_w % num == 0) {
+      GST_DEBUG_OBJECT (trans, "keeping video width");
+      w = in_w;
+      h = w * den / num;
+    } else {
+      GST_DEBUG_OBJECT (trans, "approximating but keeping video height");
+      h = in_h;
+      w = h * num / den;
+    }
+    GST_DEBUG_OBJECT (trans, "scaling to %dx%d", w, h);
+
+    /* now fixate */
+    gst_structure_fixate_field_nearest_int (outstructure, "width", w);
+    gst_structure_fixate_field_nearest_int (outstructure, "height", h);
+  } else {
+    gint width, height;
+
+    if (gst_structure_get_int (instructure, "width", &width)) {
+      if (gst_structure_has_field (outstructure, "width"))
+        gst_structure_fixate_field_nearest_int (outstructure, "width", width);
+    }
+    if (gst_structure_get_int (instructure, "height", &height)) {
+      if (gst_structure_has_field (outstructure, "height"))
+        gst_structure_fixate_field_nearest_int (outstructure, "height", height);
+    }
+  }
+}
+
+static gboolean
+gst_ffmpegscale_get_unit_size (GstBaseTransform * trans, GstCaps * caps,
+    guint * size)
+{
+  GstStructure *structure = gst_caps_get_structure (caps, 0);
+  gint width, height;
+  AVCodecContext *ctx;
+
+  if (!gst_structure_get_int (structure, "width", &width))
+    return FALSE;
+  if (!gst_structure_get_int (structure, "height", &height))
+    return FALSE;
+
+  ctx = avcodec_alloc_context ();
+  ctx->width = width;
+  ctx->height = height;
+  ctx->pix_fmt = PIX_FMT_NB;
+  gst_ffmpeg_caps_with_codectype (CODEC_TYPE_VIDEO, caps, ctx);
+  if (ctx->pix_fmt == PIX_FMT_NB) {
+    av_free (ctx);
+    return FALSE;
+  }
+
+  *size = (guint) avpicture_get_size (ctx->pix_fmt, ctx->width, ctx->height);
+
+  av_free (ctx);
+
+  return TRUE;
+}
+
+static gboolean
+gst_ffmpegscale_set_caps (GstBaseTransform * trans, GstCaps * incaps,
+    GstCaps * outcaps)
+{
+  GstFFMpegScale *scale = GST_FFMPEGSCALE (trans);
+  GstStructure *instructure = gst_caps_get_structure (incaps, 0);
+  GstStructure *outstructure = gst_caps_get_structure (outcaps, 0);
+  gint par_num, par_den;
+  AVCodecContext *ctx;
+
+  if (!gst_structure_get_int (instructure, "width", &scale->in_width))
+    return FALSE;
+  if (!gst_structure_get_int (instructure, "height", &scale->in_height))
+    return FALSE;
+
+  if (!gst_structure_get_int (outstructure, "width", &scale->out_width))
+    return FALSE;
+  if (!gst_structure_get_int (outstructure, "height", &scale->out_height))
+    return FALSE;
+
+  if (gst_structure_get_fraction (instructure, "pixel-aspect-ratio",
+          &par_num, &par_den)) {
+    gst_structure_set (outstructure,
+        "pixel-aspect-ratio", GST_TYPE_FRACTION,
+        par_num * scale->in_width / scale->out_width,
+        par_den * scale->in_height / scale->out_height, NULL);
+  }
+
+  ctx = avcodec_alloc_context ();
+  ctx->width = scale->in_width;
+  ctx->height = scale->in_height;
+  ctx->pix_fmt = PIX_FMT_NB;
+  gst_ffmpeg_caps_with_codectype (CODEC_TYPE_VIDEO, incaps, ctx);
+  if (ctx->pix_fmt == PIX_FMT_NB) {
+    av_free (ctx);
+    return FALSE;
+  }
+
+  scale->pixfmt = ctx->pix_fmt;
+
+  av_free (ctx);
+
+  scale->res = img_resample_init (scale->out_width, scale->out_height,
+      scale->in_width, scale->in_height);
+
+  return TRUE;
+}
+
+static GstFlowReturn
+gst_ffmpegscale_transform (GstBaseTransform * trans, GstBuffer * inbuf,
+    GstBuffer * outbuf)
+{
+  GstFFMpegScale *scale = GST_FFMPEGSCALE (trans);
+  AVPicture in_frame, out_frame;
+
+  gst_buffer_copy_metadata (outbuf, inbuf, GST_BUFFER_COPY_TIMESTAMPS);
+
+  gst_ffmpeg_avpicture_fill (&in_frame,
+      GST_BUFFER_DATA (inbuf),
+      scale->pixfmt, scale->in_width, scale->in_height);
+
+  gst_ffmpeg_avpicture_fill (&out_frame,
+      GST_BUFFER_DATA (outbuf),
+      scale->pixfmt, scale->out_width, scale->out_height);
+
+  img_resample (scale->res, &out_frame, &in_frame);
+
+  return GST_FLOW_OK;
+}
+
+static gboolean
+gst_ffmpegscale_handle_src_event (GstPad * pad, GstEvent * event)
+{
+  GstFFMpegScale *scale;
+  GstStructure *structure;
+  gdouble pointer;
+  gboolean res;
+
+  scale = GST_FFMPEGSCALE (gst_pad_get_parent (pad));
+
+  switch (GST_EVENT_TYPE (event)) {
+    case GST_EVENT_NAVIGATION:
+      event =
+          GST_EVENT (gst_mini_object_make_writable (GST_MINI_OBJECT (event)));
+
+      structure = (GstStructure *) gst_event_get_structure (event);
+      if (gst_structure_get_double (structure, "pointer_x", &pointer)) {
+        gst_structure_set (structure,
+            "pointer_x", G_TYPE_DOUBLE,
+            pointer * scale->in_width / scale->out_width, NULL);
+      }
+      if (gst_structure_get_double (structure, "pointer_y", &pointer)) {
+        gst_structure_set (structure,
+            "pointer_y", G_TYPE_DOUBLE,
+            pointer * scale->in_height / scale->out_height, NULL);
+      }
+      break;
+    default:
+      break;
+  }
+
+  res = gst_pad_event_default (pad, event);
+
+  gst_object_unref (scale);
+
+  return res;
+}
+
+gboolean
+gst_ffmpegscale_register (GstPlugin * plugin)
+{
+  return gst_element_register (plugin, "ffvideoscale",
+      GST_RANK_NONE, GST_TYPE_FFMPEGSCALE);
+}
diff --git a/ext/ffmpeg/gstffmpegutils.c b/ext/ffmpeg/gstffmpegutils.c
index d039914..4c5bd1e 100644
--- a/ext/ffmpeg/gstffmpegutils.c
+++ b/ext/ffmpeg/gstffmpegutils.c
@@ -466,7 +466,7 @@ gst_ffmpeg_auto_max_threads (void)
       int mib[] = { CTL_HW, HW_NCPU };
       size_t dataSize = sizeof (int);
 
-      if (sysctl (mib, 2, &n_threads, &dataSize, NULL, 0)) {
+      if (sysctl (mib, 2, &n, &dataSize, NULL, 0)) {
         n = 1;
       }
     }
diff --git a/ext/ffmpeg/gstffmpegutils.h b/ext/ffmpeg/gstffmpegutils.h
index 4b713de..dbc3fae 100644
--- a/ext/ffmpeg/gstffmpegutils.h
+++ b/ext/ffmpeg/gstffmpegutils.h
@@ -20,11 +20,17 @@
 #ifndef __GST_FFMPEG_UTILS_H__
 #define __GST_FFMPEG_UTILS_H__
 
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
 #ifdef HAVE_FFMPEG_UNINSTALLED
+#include <mathematics.h>
 #include <avcodec.h>
 #else
 #include <libavcodec/avcodec.h>
 #endif
+
 #include <gst/gst.h>
 
 /*
diff --git a/ext/ffmpeg/gstffmpegviddec.c b/ext/ffmpeg/gstffmpegviddec.c
new file mode 100644
index 0000000..988c5ea
--- /dev/null
+++ b/ext/ffmpeg/gstffmpegviddec.c
@@ -0,0 +1,1632 @@
+/* GStreamer
+ * Copyright (C) <1999> Erik Walthinsen <omega@cse.ogi.edu>
+ *
+ * This library is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU Library General Public
+ * License as published by the Free Software Foundation; either
+ * version 2 of the License, or (at your option) any later version.
+ *
+ * This library is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+ * Library General Public License for more details.
+ *
+ * You should have received a copy of the GNU Library General Public
+ * License along with this library; if not, write to the
+ * Free Software Foundation, Inc., 59 Temple Place - Suite 330,
+ * Boston, MA 02111-1307, USA.
+ */
+
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
+#include <assert.h>
+#include <string.h>
+
+#ifdef HAVE_FFMPEG_UNINSTALLED
+#include <avcodec.h>
+#else
+#include <libavcodec/avcodec.h>
+#endif
+
+#include <gst/gst.h>
+#include <gst/video/video.h>
+#include <gst/video/gstvideodecoder.h>
+
+#include "gstffmpeg.h"
+#include "gstffmpegcodecmap.h"
+#include "gstffmpegutils.h"
+
+typedef struct _GstFFMpegVidDec GstFFMpegVidDec;
+
+#define MAX_TS_MASK 0xff
+
+struct _GstFFMpegVidDec
+{
+  GstVideoDecoder parent;
+
+  GstVideoCodecState *input_state;
+  GstVideoCodecState *output_state;
+
+  /* decoding */
+  AVCodecContext *context;
+  AVFrame *picture;
+  gboolean opened;
+
+  enum PixelFormat pix_fmt;
+  gboolean waiting_for_key;
+
+  /* for tracking DTS/PTS */
+  gboolean has_b_frames;
+
+  guint8 *padded;
+  guint padded_size;
+
+  GValue *par;                  /* pixel aspect ratio of incoming data */
+  gboolean current_dr;          /* if direct rendering is enabled */
+  gboolean extra_ref;           /* keep extra ref around in get/release */
+
+  /* some properties */
+  enum AVDiscard skip_frame;
+  gint lowres;
+  gboolean direct_rendering;
+  gboolean do_padding;
+  gboolean debug_mv;
+  gboolean crop;
+  int max_threads;
+
+  gboolean is_realvideo;
+
+  /* Can downstream allocate 16bytes aligned data. */
+  gboolean can_allocate_aligned;
+};
+
+typedef struct _GstFFMpegVidDecClass GstFFMpegVidDecClass;
+
+struct _GstFFMpegVidDecClass
+{
+  GstVideoDecoderClass parent_class;
+
+  AVCodec *in_plugin;
+};
+
+
+#define GST_TYPE_FFMPEGDEC \
+  (gst_ffmpegviddec_get_type())
+#define GST_FFMPEGDEC(obj) \
+  (G_TYPE_CHECK_INSTANCE_CAST((obj),GST_TYPE_FFMPEGDEC,GstFFMpegVidDec))
+#define GST_FFMPEGVIDDEC_CLASS(klass) \
+  (G_TYPE_CHECK_CLASS_CAST((klass),GST_TYPE_FFMPEGDEC,GstFFMpegVidDecClass))
+#define GST_IS_FFMPEGDEC(obj) \
+  (G_TYPE_CHECK_INSTANCE_TYPE((obj),GST_TYPE_FFMPEGDEC))
+#define GST_IS_FFMPEGVIDDEC_CLASS(klass) \
+  (G_TYPE_CHECK_CLASS_TYPE((klass),GST_TYPE_FFMPEGDEC))
+
+#define DEFAULT_LOWRES			0
+#define DEFAULT_SKIPFRAME		0
+#define DEFAULT_DIRECT_RENDERING	TRUE
+#define DEFAULT_DO_PADDING		TRUE
+#define DEFAULT_DEBUG_MV		FALSE
+#define DEFAULT_CROP			TRUE
+#define DEFAULT_MAX_THREADS		0
+
+enum
+{
+  PROP_0,
+  PROP_LOWRES,
+  PROP_SKIPFRAME,
+  PROP_DIRECT_RENDERING,
+  PROP_DO_PADDING,
+  PROP_DEBUG_MV,
+  PROP_CROP,
+  PROP_MAX_THREADS,
+  PROP_LAST
+};
+
+/* A number of function prototypes are given so we can refer to them later. */
+static void gst_ffmpegviddec_base_init (GstFFMpegVidDecClass * klass);
+static void gst_ffmpegviddec_class_init (GstFFMpegVidDecClass * klass);
+static void gst_ffmpegviddec_init (GstFFMpegVidDec * ffmpegdec);
+static void gst_ffmpegviddec_finalize (GObject * object);
+
+static gboolean gst_ffmpegviddec_set_format (GstVideoDecoder * decoder,
+    GstVideoCodecState * state);
+static GstFlowReturn gst_ffmpegviddec_handle_frame (GstVideoDecoder * decoder,
+    GstVideoCodecFrame * frame);
+static gboolean gst_ffmpegviddec_stop (GstVideoDecoder * decoder);
+static gboolean gst_ffmpegviddec_reset (GstVideoDecoder * decoder,
+    gboolean hard);
+
+static void gst_ffmpegviddec_set_property (GObject * object,
+    guint prop_id, const GValue * value, GParamSpec * pspec);
+static void gst_ffmpegviddec_get_property (GObject * object,
+    guint prop_id, GValue * value, GParamSpec * pspec);
+
+static gboolean gst_ffmpegviddec_negotiate (GstFFMpegVidDec * ffmpegdec,
+    gboolean force);
+
+/* some sort of bufferpool handling, but different */
+static int gst_ffmpegviddec_get_buffer (AVCodecContext * context,
+    AVFrame * picture);
+static void gst_ffmpegviddec_release_buffer (AVCodecContext * context,
+    AVFrame * picture);
+
+static GstFlowReturn gst_ffmpegviddec_finish (GstVideoDecoder * decoder);
+static void gst_ffmpegviddec_drain (GstFFMpegVidDec * ffmpegdec);
+
+#define GST_FFDEC_PARAMS_QDATA g_quark_from_static_string("ffdec-params")
+
+static GstElementClass *parent_class = NULL;
+
+#define GST_FFMPEGVIDDEC_TYPE_LOWRES (gst_ffmpegviddec_lowres_get_type())
+static GType
+gst_ffmpegviddec_lowres_get_type (void)
+{
+  static GType ffmpegdec_lowres_type = 0;
+
+  if (!ffmpegdec_lowres_type) {
+    static const GEnumValue ffmpegdec_lowres[] = {
+      {0, "0", "full"},
+      {1, "1", "1/2-size"},
+      {2, "2", "1/4-size"},
+      {0, NULL, NULL},
+    };
+
+    ffmpegdec_lowres_type =
+        g_enum_register_static ("GstFFMpegVidDecLowres", ffmpegdec_lowres);
+  }
+
+  return ffmpegdec_lowres_type;
+}
+
+#define GST_FFMPEGVIDDEC_TYPE_SKIPFRAME (gst_ffmpegviddec_skipframe_get_type())
+static GType
+gst_ffmpegviddec_skipframe_get_type (void)
+{
+  static GType ffmpegdec_skipframe_type = 0;
+
+  if (!ffmpegdec_skipframe_type) {
+    static const GEnumValue ffmpegdec_skipframe[] = {
+      {0, "0", "Skip nothing"},
+      {1, "1", "Skip B-frames"},
+      {2, "2", "Skip IDCT/Dequantization"},
+      {5, "5", "Skip everything"},
+      {0, NULL, NULL},
+    };
+
+    ffmpegdec_skipframe_type =
+        g_enum_register_static ("GstFFMpegVidDecSkipFrame",
+        ffmpegdec_skipframe);
+  }
+
+  return ffmpegdec_skipframe_type;
+}
+
+static void
+gst_ffmpegviddec_base_init (GstFFMpegVidDecClass * klass)
+{
+  GstElementClass *element_class = GST_ELEMENT_CLASS (klass);
+  GstPadTemplate *sinktempl, *srctempl;
+  GstCaps *sinkcaps, *srccaps;
+  AVCodec *in_plugin;
+  gchar *longname, *description;
+
+  in_plugin =
+      (AVCodec *) g_type_get_qdata (G_OBJECT_CLASS_TYPE (klass),
+      GST_FFDEC_PARAMS_QDATA);
+  g_assert (in_plugin != NULL);
+
+  /* construct the element details struct */
+  longname = g_strdup_printf ("FFmpeg %s decoder", in_plugin->long_name);
+  description = g_strdup_printf ("FFmpeg %s decoder", in_plugin->name);
+  gst_element_class_set_details_simple (element_class, longname,
+      "Codec/Decoder/Video", description,
+      "Wim Taymans <wim.taymans@gmail.com>, "
+      "Ronald Bultje <rbultje@ronald.bitfreak.net>, "
+      "Edward Hervey <bilboed@bilboed.com>");
+  g_free (longname);
+  g_free (description);
+
+  /* get the caps */
+  sinkcaps = gst_ffmpeg_codecid_to_caps (in_plugin->id, NULL, FALSE);
+  if (!sinkcaps) {
+    GST_DEBUG ("Couldn't get sink caps for decoder '%s'", in_plugin->name);
+    sinkcaps = gst_caps_from_string ("unknown/unknown");
+  }
+  srccaps =
+      gst_caps_from_string
+      ("video/x-raw-rgb; video/x-raw-yuv; video/x-raw-gray");
+
+  /* pad templates */
+  sinktempl = gst_pad_template_new ("sink", GST_PAD_SINK,
+      GST_PAD_ALWAYS, sinkcaps);
+  srctempl = gst_pad_template_new ("src", GST_PAD_SRC, GST_PAD_ALWAYS, srccaps);
+
+  gst_element_class_add_pad_template (element_class, srctempl);
+  gst_element_class_add_pad_template (element_class, sinktempl);
+
+  klass->in_plugin = in_plugin;
+}
+
+static void
+gst_ffmpegviddec_class_init (GstFFMpegVidDecClass * klass)
+{
+  GObjectClass *gobject_class = G_OBJECT_CLASS (klass);
+  GstVideoDecoderClass *viddec_class = GST_VIDEO_DECODER_CLASS (klass);
+  int caps;
+
+  parent_class = g_type_class_peek_parent (klass);
+
+  gobject_class->finalize = gst_ffmpegviddec_finalize;
+
+  gobject_class->set_property = gst_ffmpegviddec_set_property;
+  gobject_class->get_property = gst_ffmpegviddec_get_property;
+
+  g_object_class_install_property (gobject_class, PROP_SKIPFRAME,
+      g_param_spec_enum ("skip-frame", "Skip frames",
+          "Which types of frames to skip during decoding",
+          GST_FFMPEGVIDDEC_TYPE_SKIPFRAME, 0,
+          G_PARAM_READWRITE | G_PARAM_STATIC_STRINGS));
+  g_object_class_install_property (gobject_class, PROP_LOWRES,
+      g_param_spec_enum ("lowres", "Low resolution",
+          "At which resolution to decode images",
+          GST_FFMPEGVIDDEC_TYPE_LOWRES, 0,
+          G_PARAM_READWRITE | G_PARAM_STATIC_STRINGS));
+  g_object_class_install_property (gobject_class, PROP_DIRECT_RENDERING,
+      g_param_spec_boolean ("direct-rendering", "Direct Rendering",
+          "Enable direct rendering", DEFAULT_DIRECT_RENDERING,
+          G_PARAM_READWRITE | G_PARAM_STATIC_STRINGS));
+  g_object_class_install_property (gobject_class, PROP_DO_PADDING,
+      g_param_spec_boolean ("do-padding", "Do Padding",
+          "Add 0 padding before decoding data", DEFAULT_DO_PADDING,
+          G_PARAM_READWRITE | G_PARAM_STATIC_STRINGS));
+  g_object_class_install_property (gobject_class, PROP_DEBUG_MV,
+      g_param_spec_boolean ("debug-mv", "Debug motion vectors",
+          "Whether ffmpeg should print motion vectors on top of the image",
+          DEFAULT_DEBUG_MV, G_PARAM_READWRITE | G_PARAM_STATIC_STRINGS));
+
+  caps = klass->in_plugin->capabilities;
+  if (caps & (CODEC_CAP_FRAME_THREADS | CODEC_CAP_SLICE_THREADS)) {
+    g_object_class_install_property (G_OBJECT_CLASS (klass), PROP_MAX_THREADS,
+        g_param_spec_int ("max-threads", "Maximum decode threads",
+            "Maximum number of worker threads to spawn. (0 = auto)",
+            0, G_MAXINT, DEFAULT_MAX_THREADS,
+            G_PARAM_READWRITE | G_PARAM_STATIC_STRINGS));
+  }
+
+  viddec_class->set_format = gst_ffmpegviddec_set_format;
+  viddec_class->handle_frame = gst_ffmpegviddec_handle_frame;
+  viddec_class->stop = gst_ffmpegviddec_stop;
+  viddec_class->reset = gst_ffmpegviddec_reset;
+  viddec_class->finish = gst_ffmpegviddec_finish;
+}
+
+static void
+gst_ffmpegviddec_init (GstFFMpegVidDec * ffmpegdec)
+{
+  /* some ffmpeg data */
+  ffmpegdec->context = avcodec_alloc_context ();
+  ffmpegdec->picture = avcodec_alloc_frame ();
+  ffmpegdec->opened = FALSE;
+  ffmpegdec->waiting_for_key = TRUE;
+  ffmpegdec->skip_frame = ffmpegdec->lowres = 0;
+  ffmpegdec->direct_rendering = DEFAULT_DIRECT_RENDERING;
+  ffmpegdec->do_padding = DEFAULT_DO_PADDING;
+  ffmpegdec->debug_mv = DEFAULT_DEBUG_MV;
+  ffmpegdec->crop = DEFAULT_CROP;
+  ffmpegdec->max_threads = DEFAULT_MAX_THREADS;
+
+  /* We initially assume downstream can allocate 16 bytes aligned buffers */
+  ffmpegdec->can_allocate_aligned = TRUE;
+}
+
+static void
+gst_ffmpegviddec_finalize (GObject * object)
+{
+  GstFFMpegVidDec *ffmpegdec = (GstFFMpegVidDec *) object;
+
+  if (ffmpegdec->context != NULL) {
+    av_free (ffmpegdec->context);
+    ffmpegdec->context = NULL;
+  }
+
+  if (ffmpegdec->picture != NULL) {
+    av_free (ffmpegdec->picture);
+    ffmpegdec->picture = NULL;
+  }
+
+  G_OBJECT_CLASS (parent_class)->finalize (object);
+}
+
+
+/* with LOCK */
+static void
+gst_ffmpegviddec_close (GstFFMpegVidDec * ffmpegdec)
+{
+  if (!ffmpegdec->opened)
+    return;
+
+  GST_LOG_OBJECT (ffmpegdec, "closing ffmpeg codec");
+
+  if (ffmpegdec->context->priv_data)
+    gst_ffmpeg_avcodec_close (ffmpegdec->context);
+  ffmpegdec->opened = FALSE;
+
+  if (ffmpegdec->context->palctrl) {
+    av_free (ffmpegdec->context->palctrl);
+    ffmpegdec->context->palctrl = NULL;
+  }
+
+  if (ffmpegdec->context->extradata) {
+    av_free (ffmpegdec->context->extradata);
+    ffmpegdec->context->extradata = NULL;
+  }
+}
+
+/* with LOCK */
+static gboolean
+gst_ffmpegviddec_open (GstFFMpegVidDec * ffmpegdec)
+{
+  GstFFMpegVidDecClass *oclass;
+
+  oclass = (GstFFMpegVidDecClass *) (G_OBJECT_GET_CLASS (ffmpegdec));
+
+  if (gst_ffmpeg_avcodec_open (ffmpegdec->context, oclass->in_plugin) < 0)
+    goto could_not_open;
+
+  ffmpegdec->opened = TRUE;
+  ffmpegdec->is_realvideo = FALSE;
+
+  GST_LOG_OBJECT (ffmpegdec, "Opened ffmpeg codec %s, id %d",
+      oclass->in_plugin->name, oclass->in_plugin->id);
+
+  switch (oclass->in_plugin->id) {
+    case CODEC_ID_RV10:
+    case CODEC_ID_RV30:
+    case CODEC_ID_RV20:
+    case CODEC_ID_RV40:
+      ffmpegdec->is_realvideo = TRUE;
+      break;
+    default:
+      GST_LOG_OBJECT (ffmpegdec, "Parser deactivated for format");
+      break;
+  }
+
+  ffmpegdec->pix_fmt = PIX_FMT_NB;
+
+  return TRUE;
+
+  /* ERRORS */
+could_not_open:
+  {
+    gst_ffmpegviddec_close (ffmpegdec);
+    GST_DEBUG_OBJECT (ffmpegdec, "ffdec_%s: Failed to open FFMPEG codec",
+        oclass->in_plugin->name);
+    return FALSE;
+  }
+}
+
+static gboolean
+gst_ffmpegviddec_set_format (GstVideoDecoder * decoder,
+    GstVideoCodecState * state)
+{
+  GstFFMpegVidDec *ffmpegdec;
+  GstFFMpegVidDecClass *oclass;
+  gboolean ret = FALSE;
+
+  ffmpegdec = (GstFFMpegVidDec *) decoder;
+  oclass = (GstFFMpegVidDecClass *) (G_OBJECT_GET_CLASS (ffmpegdec));
+
+  GST_DEBUG_OBJECT (ffmpegdec, "setcaps called");
+
+  GST_OBJECT_LOCK (ffmpegdec);
+  /* stupid check for VC1 */
+  if ((oclass->in_plugin->id == CODEC_ID_WMV3) ||
+      (oclass->in_plugin->id == CODEC_ID_VC1))
+    oclass->in_plugin->id = gst_ffmpeg_caps_to_codecid (state->caps, NULL);
+
+  /* close old session */
+  if (ffmpegdec->opened) {
+    GST_OBJECT_UNLOCK (ffmpegdec);
+    gst_ffmpegviddec_drain (ffmpegdec);
+    GST_OBJECT_LOCK (ffmpegdec);
+    gst_ffmpegviddec_close (ffmpegdec);
+
+    /* and reset the defaults that were set when a context is created */
+    avcodec_get_context_defaults (ffmpegdec->context);
+  }
+
+  /* set buffer functions */
+  ffmpegdec->context->get_buffer = gst_ffmpegviddec_get_buffer;
+  ffmpegdec->context->release_buffer = gst_ffmpegviddec_release_buffer;
+  ffmpegdec->context->draw_horiz_band = NULL;
+
+  ffmpegdec->has_b_frames = FALSE;
+
+  GST_LOG_OBJECT (ffmpegdec, "size %dx%d", ffmpegdec->context->width,
+      ffmpegdec->context->height);
+
+  /* FIXME : Create a method that takes GstVideoCodecState instead */
+  /* get size and so */
+  gst_ffmpeg_caps_with_codecid (oclass->in_plugin->id,
+      oclass->in_plugin->type, state->caps, ffmpegdec->context);
+
+  GST_LOG_OBJECT (ffmpegdec, "size after %dx%d", ffmpegdec->context->width,
+      ffmpegdec->context->height);
+
+  if (!ffmpegdec->context->time_base.den || !ffmpegdec->context->time_base.num) {
+    GST_DEBUG_OBJECT (ffmpegdec, "forcing 25/1 framerate");
+    ffmpegdec->context->time_base.num = 1;
+    ffmpegdec->context->time_base.den = 25;
+  }
+
+  /* figure out if we can use direct rendering */
+  ffmpegdec->current_dr = FALSE;
+  ffmpegdec->extra_ref = FALSE;
+  if (ffmpegdec->direct_rendering) {
+    GST_DEBUG_OBJECT (ffmpegdec, "trying to enable direct rendering");
+    if (oclass->in_plugin->capabilities & CODEC_CAP_DR1) {
+      if (oclass->in_plugin->id == CODEC_ID_H264) {
+        GST_DEBUG_OBJECT (ffmpegdec, "disable direct rendering setup for H264");
+        /* does not work, many stuff reads outside of the planes */
+        ffmpegdec->current_dr = FALSE;
+        ffmpegdec->extra_ref = TRUE;
+      } else if ((oclass->in_plugin->id == CODEC_ID_SVQ1) ||
+          (oclass->in_plugin->id == CODEC_ID_VP5) ||
+          (oclass->in_plugin->id == CODEC_ID_VP6) ||
+          (oclass->in_plugin->id == CODEC_ID_VP6F) ||
+          (oclass->in_plugin->id == CODEC_ID_VP6A)) {
+        GST_DEBUG_OBJECT (ffmpegdec,
+            "disable direct rendering setup for broken stride support");
+        /* does not work, uses a incompatible stride. See #610613 */
+        ffmpegdec->current_dr = FALSE;
+        ffmpegdec->extra_ref = TRUE;
+      } else {
+        GST_DEBUG_OBJECT (ffmpegdec, "enabled direct rendering");
+        ffmpegdec->current_dr = TRUE;
+      }
+    } else {
+      GST_DEBUG_OBJECT (ffmpegdec, "direct rendering not supported");
+    }
+  }
+  if (ffmpegdec->current_dr) {
+    /* do *not* draw edges when in direct rendering, for some reason it draws
+     * outside of the memory. */
+    ffmpegdec->context->flags |= CODEC_FLAG_EMU_EDGE;
+  }
+
+  /* workaround encoder bugs */
+  ffmpegdec->context->workaround_bugs |= FF_BUG_AUTODETECT;
+  ffmpegdec->context->error_recognition = 1;
+
+  /* for slow cpus */
+  ffmpegdec->context->lowres = ffmpegdec->lowres;
+  ffmpegdec->context->skip_frame = ffmpegdec->skip_frame;
+
+  /* ffmpeg can draw motion vectors on top of the image (not every decoder
+   * supports it) */
+  ffmpegdec->context->debug_mv = ffmpegdec->debug_mv;
+
+  if (ffmpegdec->max_threads == 0) {
+    if (!(oclass->in_plugin->capabilities & CODEC_CAP_AUTO_THREADS))
+      ffmpegdec->context->thread_count = gst_ffmpeg_auto_max_threads ();
+    else
+      ffmpegdec->context->thread_count = 0;
+  } else
+    ffmpegdec->context->thread_count = ffmpegdec->max_threads;
+
+  ffmpegdec->context->thread_type = FF_THREAD_SLICE;
+
+  /* open codec - we don't select an output pix_fmt yet,
+   * simply because we don't know! We only get it
+   * during playback... */
+  if (!gst_ffmpegviddec_open (ffmpegdec))
+    goto open_failed;
+
+  if (ffmpegdec->input_state)
+    gst_video_codec_state_unref (ffmpegdec->input_state);
+  ffmpegdec->input_state = gst_video_codec_state_ref (state);
+
+  ret = TRUE;
+
+done:
+  GST_OBJECT_UNLOCK (ffmpegdec);
+
+  return ret;
+
+  /* ERRORS */
+open_failed:
+  {
+    GST_DEBUG_OBJECT (ffmpegdec, "Failed to open");
+    goto done;
+  }
+}
+
+static GstFlowReturn
+alloc_output_buffer (GstFFMpegVidDec * ffmpegdec, GstVideoCodecFrame * frame)
+{
+  GstFlowReturn ret;
+  gint fsize;
+
+  ret = GST_FLOW_ERROR;
+
+  GST_LOG_OBJECT (ffmpegdec, "alloc output buffer");
+
+  /* see if we need renegotiation */
+  if (G_UNLIKELY (!gst_ffmpegviddec_negotiate (ffmpegdec, FALSE)))
+    goto negotiate_failed;
+
+  /* get the size of the gstreamer output buffer given a
+   * width/height/format */
+  fsize = GST_VIDEO_INFO_SIZE (&ffmpegdec->output_state->info);
+
+  if (!ffmpegdec->context->palctrl && ffmpegdec->can_allocate_aligned) {
+    GST_LOG_OBJECT (ffmpegdec, "calling pad_alloc");
+    /* no pallete, we can use the buffer size to alloc */
+    ret =
+        gst_video_decoder_alloc_output_frame (GST_VIDEO_DECODER (ffmpegdec),
+        frame);
+    if (G_UNLIKELY (ret != GST_FLOW_OK))
+      goto alloc_failed;
+
+    /* If buffer isn't 128-bit aligned, create a memaligned one ourselves */
+    if (((uintptr_t) GST_BUFFER_DATA (frame->output_buffer)) % 16) {
+      GST_DEBUG_OBJECT (ffmpegdec,
+          "Downstream can't allocate aligned buffers.");
+      ffmpegdec->can_allocate_aligned = FALSE;
+      gst_buffer_unref (frame->output_buffer);
+      frame->output_buffer = new_aligned_buffer (fsize, NULL);
+    }
+  } else {
+    GST_LOG_OBJECT (ffmpegdec,
+        "not calling pad_alloc, we have a pallete or downstream can't give 16 byte aligned buffers.");
+    /* for paletted data we can't use pad_alloc_buffer(), because
+     * fsize contains the size of the palette, so the overall size
+     * is bigger than ffmpegcolorspace's unit size, which will
+     * prompt GstBaseTransform to complain endlessly ... */
+    frame->output_buffer = new_aligned_buffer (fsize, NULL);
+    ret = GST_FLOW_OK;
+  }
+
+  return ret;
+
+  /* special cases */
+negotiate_failed:
+  {
+    GST_DEBUG_OBJECT (ffmpegdec, "negotiate failed");
+    return GST_FLOW_NOT_NEGOTIATED;
+  }
+alloc_failed:
+  {
+    GST_DEBUG_OBJECT (ffmpegdec, "pad_alloc failed %d (%s)", ret,
+        gst_flow_get_name (ret));
+    return ret;
+  }
+}
+
+static int
+gst_ffmpegviddec_get_buffer (AVCodecContext * context, AVFrame * picture)
+{
+  GstVideoCodecFrame *frame;
+  GstFFMpegVidDec *ffmpegdec;
+  gint width, height;
+  gint coded_width, coded_height;
+  gint res;
+  gint c;
+  GstVideoInfo *info;
+  GstFlowReturn ret;
+
+
+  ffmpegdec = (GstFFMpegVidDec *) context->opaque;
+
+  GST_DEBUG_OBJECT (ffmpegdec, "getting buffer");
+
+  /* apply the last info we have seen to this picture, when we get the
+   * picture back from ffmpeg we can use this to correctly timestamp the output
+   * buffer */
+  picture->reordered_opaque = context->reordered_opaque;
+
+  frame =
+      gst_video_decoder_get_frame (GST_VIDEO_DECODER (ffmpegdec),
+      picture->reordered_opaque);
+  if (G_UNLIKELY (frame == NULL))
+    goto no_frame;
+
+  picture->opaque = frame;
+
+  if (!ffmpegdec->current_dr) {
+    GST_LOG_OBJECT (ffmpegdec, "direct rendering disabled, fallback alloc");
+    res = avcodec_default_get_buffer (context, picture);
+
+    GST_LOG_OBJECT (ffmpegdec, "linsize %d %d %d", picture->linesize[0],
+        picture->linesize[1], picture->linesize[2]);
+    GST_LOG_OBJECT (ffmpegdec, "data %u %u %u", 0,
+        (guint) (picture->data[1] - picture->data[0]),
+        (guint) (picture->data[2] - picture->data[0]));
+    return res;
+  }
+
+  /* take width and height before clipping */
+  width = context->width;
+  height = context->height;
+  coded_width = context->coded_width;
+  coded_height = context->coded_height;
+
+  GST_LOG_OBJECT (ffmpegdec, "dimension %dx%d, coded %dx%d", width, height,
+      coded_width, coded_height);
+
+  /* this is the size ffmpeg needs for the buffer */
+  avcodec_align_dimensions (context, &width, &height);
+  GST_LOG_OBJECT (ffmpegdec, "Aligned dimensions %dx%d", width, height);
+
+  if (width != context->width || height != context->height) {
+    /* We can't alloc if we need to clip the output buffer later */
+    GST_LOG_OBJECT (ffmpegdec, "we need clipping, fallback alloc");
+    return avcodec_default_get_buffer (context, picture);
+  }
+
+  /* alloc with aligned dimensions for ffmpeg */
+  ret = alloc_output_buffer (ffmpegdec, frame);
+  if (G_UNLIKELY (ret != GST_FLOW_OK)) {
+    /* alloc default buffer when we can't get one from downstream */
+    GST_LOG_OBJECT (ffmpegdec, "alloc failed, fallback alloc");
+    return avcodec_default_get_buffer (context, picture);
+  }
+
+  /* Fill avpicture */
+  info = &ffmpegdec->output_state->info;
+  for (c = 0; c < AV_NUM_DATA_POINTERS; c++) {
+    if (c < GST_VIDEO_INFO_N_PLANES (info)) {
+      picture->data[c] =
+          GST_BUFFER_DATA (frame->output_buffer) +
+          GST_VIDEO_INFO_PLANE_OFFSET (info, c);
+      picture->linesize[c] = GST_VIDEO_INFO_PLANE_STRIDE (info, c);
+    } else {
+      picture->data[c] = NULL;
+      picture->linesize[c] = 0;
+    }
+  }
+  GST_DEBUG_OBJECT (ffmpegdec, "from GstVideoInfo data %p %p %p",
+      picture->data[0], picture->data[1], picture->data[2]);
+  GST_DEBUG_OBJECT (ffmpegdec, "from GstVideoInfo linesize %d %d %d",
+      picture->linesize[0], picture->linesize[1], picture->linesize[2]);
+
+  /* tell ffmpeg we own this buffer, tranfer the ref we have on the buffer to
+   * the opaque data. */
+  picture->type = FF_BUFFER_TYPE_USER;
+  picture->age = 256 * 256 * 256 * 64;
+
+  GST_LOG_OBJECT (ffmpegdec, "returned frame %p", frame->output_buffer);
+
+  return 0;
+
+no_frame:
+  GST_WARNING_OBJECT (ffmpegdec, "Couldn't get codec frame !");
+  return -1;
+}
+
+static void
+gst_ffmpegviddec_release_buffer (AVCodecContext * context, AVFrame * picture)
+{
+  gint i;
+  GstVideoCodecFrame *frame;
+  GstFFMpegVidDec *ffmpegdec;
+
+  ffmpegdec = (GstFFMpegVidDec *) context->opaque;
+  frame = (GstVideoCodecFrame *) picture->opaque;
+  GST_DEBUG_OBJECT (ffmpegdec, "release frame %d", frame->system_frame_number);
+
+  /* check if it was our buffer */
+  if (picture->type != FF_BUFFER_TYPE_USER) {
+    GST_DEBUG_OBJECT (ffmpegdec, "default release buffer");
+    avcodec_default_release_buffer (context, picture);
+  }
+
+  /* we remove the opaque data now */
+  picture->opaque = NULL;
+
+  gst_video_codec_frame_unref (frame);
+
+  /* zero out the reference in ffmpeg */
+  for (i = 0; i < 4; i++) {
+    picture->data[i] = NULL;
+    picture->linesize[i] = 0;
+  }
+}
+
+static gboolean
+gst_ffmpegviddec_negotiate (GstFFMpegVidDec * ffmpegdec, gboolean force)
+{
+  GstVideoInfo *info;
+  AVCodecContext *context = ffmpegdec->context;
+  GstVideoFormat fmt;
+  GstVideoCodecState *output_format;
+
+  info = &ffmpegdec->input_state->info;
+  if (!force && GST_VIDEO_INFO_WIDTH (info) == context->width
+      && GST_VIDEO_INFO_HEIGHT (info) == context->height
+      && GST_VIDEO_INFO_PAR_N (info) == context->sample_aspect_ratio.num
+      && GST_VIDEO_INFO_PAR_D (info) == context->sample_aspect_ratio.den
+      && ffmpegdec->pix_fmt == context->pix_fmt)
+    return TRUE;
+
+  GST_DEBUG_OBJECT (ffmpegdec,
+      "Renegotiating video from %dx%d@ (PAR %d:%d, %d/%d fps) to %dx%d@ (PAR %d:%d, %d/%d fps)",
+      GST_VIDEO_INFO_WIDTH (info), GST_VIDEO_INFO_HEIGHT (info),
+      GST_VIDEO_INFO_PAR_N (info), GST_VIDEO_INFO_PAR_D (info),
+      GST_VIDEO_INFO_FPS_N (info), GST_VIDEO_INFO_FPS_D (info),
+      context->width, context->height,
+      context->sample_aspect_ratio.num,
+      context->sample_aspect_ratio.den, -1, -1);
+
+  /* Remember current pix_fmt */
+  ffmpegdec->pix_fmt = context->pix_fmt;
+  fmt = gst_ffmpeg_pixfmt_to_videoformat (context->pix_fmt);
+
+  if (G_UNLIKELY (fmt == GST_VIDEO_FORMAT_UNKNOWN))
+    goto unknown_format;
+
+  output_format =
+      gst_video_decoder_set_output_state (GST_VIDEO_DECODER (ffmpegdec), fmt,
+      ffmpegdec->context->width, ffmpegdec->context->height,
+      ffmpegdec->input_state);
+  if (context->sample_aspect_ratio.num) {
+    GST_VIDEO_INFO_PAR_N (&output_format->info) =
+        context->sample_aspect_ratio.num;
+    GST_VIDEO_INFO_PAR_D (&output_format->info) =
+        context->sample_aspect_ratio.den;
+  }
+  if (ffmpegdec->output_state)
+    gst_video_codec_state_unref (ffmpegdec->output_state);
+  ffmpegdec->output_state = output_format;
+
+  return TRUE;
+
+  /* ERRORS */
+unknown_format:
+  {
+    GST_ERROR_OBJECT (ffmpegdec,
+        "decoder requires a video format unsupported by GStreamer");
+    return FALSE;
+  }
+}
+
+/* perform qos calculations before decoding the next frame.
+ *
+ * Sets the skip_frame flag and if things are really bad, skips to the next
+ * keyframe.
+ * 
+ * Returns TRUE if the frame should be decoded, FALSE if the frame can be dropped
+ * entirely.
+ */
+static gboolean
+gst_ffmpegviddec_do_qos (GstFFMpegVidDec * ffmpegdec,
+    GstVideoCodecFrame * frame, gboolean * mode_switch)
+{
+  GstClockTimeDiff diff;
+
+  *mode_switch = FALSE;
+
+  if (frame == NULL)
+    goto no_qos;
+
+  diff =
+      gst_video_decoder_get_max_decode_time (GST_VIDEO_DECODER (ffmpegdec),
+      frame);
+
+  /* if we don't have timing info, then we don't do QoS */
+  if (G_UNLIKELY (!GST_CLOCK_TIME_IS_VALID (diff)))
+    goto no_qos;
+
+  GST_DEBUG_OBJECT (ffmpegdec, "decoding time %" GST_TIME_FORMAT,
+      GST_TIME_ARGS (diff));
+
+  if (diff > 0)
+    goto normal_mode;
+
+  if (diff <= 0) {
+    if (ffmpegdec->waiting_for_key)
+      goto skipping;
+    goto skip_frame;
+  }
+
+no_qos:
+  return TRUE;
+
+skipping:
+  {
+    return FALSE;
+  }
+normal_mode:
+  {
+    if (ffmpegdec->context->skip_frame != AVDISCARD_DEFAULT) {
+      ffmpegdec->context->skip_frame = AVDISCARD_DEFAULT;
+      *mode_switch = TRUE;
+      GST_DEBUG_OBJECT (ffmpegdec, "QOS: normal mode");
+    }
+    return TRUE;
+  }
+skip_frame:
+  {
+    if (ffmpegdec->context->skip_frame != AVDISCARD_NONREF) {
+      ffmpegdec->context->skip_frame = AVDISCARD_NONREF;
+      *mode_switch = TRUE;
+      GST_DEBUG_OBJECT (ffmpegdec,
+          "QOS: hurry up, diff %" G_GINT64_FORMAT " >= 0", diff);
+    }
+    return FALSE;
+  }
+}
+
+/* figure out if the current picture is a keyframe, return TRUE if that is
+ * the case. */
+static gboolean
+check_keyframe (GstFFMpegVidDec * ffmpegdec)
+{
+  GstFFMpegVidDecClass *oclass;
+  gboolean is_itype = FALSE;
+  gboolean is_reference = FALSE;
+  gboolean iskeyframe;
+
+  /* figure out if we are dealing with a keyframe */
+  oclass = (GstFFMpegVidDecClass *) (G_OBJECT_GET_CLASS (ffmpegdec));
+
+  /* remember that we have B frames, we need this for the DTS -> PTS conversion
+   * code */
+  if (!ffmpegdec->has_b_frames && ffmpegdec->picture->pict_type == FF_B_TYPE) {
+    GST_DEBUG_OBJECT (ffmpegdec, "we have B frames");
+    ffmpegdec->has_b_frames = TRUE;
+    /* FIXME : set latency on base video class */
+    /* Emit latency message to recalculate it */
+    gst_element_post_message (GST_ELEMENT_CAST (ffmpegdec),
+        gst_message_new_latency (GST_OBJECT_CAST (ffmpegdec)));
+  }
+
+  is_itype = (ffmpegdec->picture->pict_type == FF_I_TYPE);
+  is_reference = (ffmpegdec->picture->reference == 1);
+
+  iskeyframe = (is_itype || is_reference || ffmpegdec->picture->key_frame)
+      || (oclass->in_plugin->id == CODEC_ID_INDEO3)
+      || (oclass->in_plugin->id == CODEC_ID_MSZH)
+      || (oclass->in_plugin->id == CODEC_ID_ZLIB)
+      || (oclass->in_plugin->id == CODEC_ID_VP3)
+      || (oclass->in_plugin->id == CODEC_ID_HUFFYUV);
+
+  GST_LOG_OBJECT (ffmpegdec,
+      "current picture: type: %d, is_keyframe:%d, is_itype:%d, is_reference:%d",
+      ffmpegdec->picture->pict_type, iskeyframe, is_itype, is_reference);
+
+  return iskeyframe;
+}
+
+/* get an outbuf buffer with the current picture */
+static GstFlowReturn
+get_output_buffer (GstFFMpegVidDec * ffmpegdec, GstVideoCodecFrame * frame)
+{
+  GstFlowReturn ret = GST_FLOW_OK;
+  AVPicture pic, *outpic;
+  GstVideoInfo *info;
+  gint c;
+
+  GST_LOG_OBJECT (ffmpegdec, "get output buffer");
+
+  ret = alloc_output_buffer (ffmpegdec, frame);
+  if (G_UNLIKELY (ret != GST_FLOW_OK))
+    goto alloc_failed;
+
+  /* original ffmpeg code does not handle odd sizes correctly.
+   * This patched up version does */
+  /* Fill avpicture */
+  info = &ffmpegdec->output_state->info;
+  for (c = 0; c < AV_NUM_DATA_POINTERS; c++) {
+    if (c < GST_VIDEO_INFO_N_COMPONENTS (info)) {
+      pic.data[c] =
+          GST_BUFFER_DATA (frame->output_buffer) +
+          GST_VIDEO_INFO_COMP_OFFSET (info, c);
+      pic.linesize[c] = GST_VIDEO_INFO_COMP_STRIDE (info, c);
+    } else {
+      pic.data[c] = NULL;
+      pic.linesize[c] = 0;
+    }
+  }
+
+  outpic = (AVPicture *) ffmpegdec->picture;
+
+  GST_LOG_OBJECT (ffmpegdec, "linsize %d %d %d", outpic->linesize[0],
+      outpic->linesize[1], outpic->linesize[2]);
+  GST_LOG_OBJECT (ffmpegdec, "data %u %u %u", 0,
+      (guint) (outpic->data[1] - outpic->data[0]),
+      (guint) (outpic->data[2] - outpic->data[0]));
+
+  av_picture_copy (&pic, outpic, ffmpegdec->context->pix_fmt,
+      GST_VIDEO_INFO_WIDTH (info), GST_VIDEO_INFO_HEIGHT (info));
+
+  ffmpegdec->picture->reordered_opaque = -1;
+
+  return ret;
+
+  /* special cases */
+alloc_failed:
+  {
+    GST_DEBUG_OBJECT (ffmpegdec, "pad_alloc failed");
+    return ret;
+  }
+}
+
+static void
+gst_avpacket_init (AVPacket * packet, guint8 * data, guint size)
+{
+  memset (packet, 0, sizeof (AVPacket));
+  packet->data = data;
+  packet->size = size;
+}
+
+/* gst_ffmpegviddec_[video|audio]_frame:
+ * ffmpegdec:
+ * data: pointer to the data to decode
+ * size: size of data in bytes
+ * in_timestamp: incoming timestamp.
+ * in_duration: incoming duration.
+ * in_offset: incoming offset (frame number).
+ * ret: Return flow.
+ *
+ * Returns: number of bytes used in decoding. The check for successful decode is
+ *   outbuf being non-NULL.
+ */
+static gint
+gst_ffmpegviddec_video_frame (GstFFMpegVidDec * ffmpegdec,
+    guint8 * data, guint size, GstVideoCodecFrame * frame, GstFlowReturn * ret)
+{
+  gint len = -1;
+  gint have_data;
+  gboolean iskeyframe;
+  gboolean mode_switch;
+  gboolean decode;
+  gint skip_frame = AVDISCARD_DEFAULT;
+  GstVideoCodecFrame *out_frame;
+  AVPacket packet;
+
+  *ret = GST_FLOW_OK;
+
+  ffmpegdec->context->opaque = ffmpegdec;
+
+  /* in case we skip frames */
+  ffmpegdec->picture->pict_type = -1;
+
+  /* run QoS code, we don't stop decoding the frame when we are late because
+   * else we might skip a reference frame */
+  decode = gst_ffmpegviddec_do_qos (ffmpegdec, frame, &mode_switch);
+
+  if (ffmpegdec->is_realvideo && data != NULL) {
+    gint slice_count;
+    gint i;
+
+    /* setup the slice table for realvideo */
+    if (ffmpegdec->context->slice_offset == NULL)
+      ffmpegdec->context->slice_offset = g_malloc (sizeof (guint32) * 1000);
+
+    slice_count = (*data++) + 1;
+    ffmpegdec->context->slice_count = slice_count;
+
+    for (i = 0; i < slice_count; i++) {
+      data += 4;
+      ffmpegdec->context->slice_offset[i] = GST_READ_UINT32_LE (data);
+      data += 4;
+    }
+  }
+
+  if (!decode) {
+    /* no decoding needed, save previous skip_frame value and brutely skip
+     * decoding everything */
+    skip_frame = ffmpegdec->context->skip_frame;
+    ffmpegdec->context->skip_frame = AVDISCARD_NONREF;
+  }
+
+  if (frame) {
+    /* save reference to the timing info */
+    ffmpegdec->context->reordered_opaque = (gint64) frame->system_frame_number;
+    ffmpegdec->picture->reordered_opaque = (gint64) frame->system_frame_number;
+
+    GST_DEBUG_OBJECT (ffmpegdec, "stored opaque values idx %d",
+        frame->system_frame_number);
+  }
+
+  /* now decode the frame */
+  gst_avpacket_init (&packet, data, size);
+  len = avcodec_decode_video2 (ffmpegdec->context,
+      ffmpegdec->picture, &have_data, &packet);
+
+  /* restore previous state */
+  if (!decode)
+    ffmpegdec->context->skip_frame = skip_frame;
+
+  GST_DEBUG_OBJECT (ffmpegdec, "after decode: len %d, have_data %d",
+      len, have_data);
+
+  /* when we are in skip_frame mode, don't complain when ffmpeg returned
+   * no data because we told it to skip stuff. */
+  if (len < 0 && (mode_switch || ffmpegdec->context->skip_frame))
+    len = 0;
+
+  /* no data, we're done */
+  if (len < 0 || have_data <= 0)
+    goto beach;
+
+  /* get the output picture timing info again */
+  out_frame = ffmpegdec->picture->opaque;
+
+  GST_DEBUG_OBJECT (ffmpegdec,
+      "pts %" G_GUINT64_FORMAT " duration %" G_GUINT64_FORMAT,
+      out_frame->pts, out_frame->duration);
+  GST_DEBUG_OBJECT (ffmpegdec, "picture: pts %" G_GUINT64_FORMAT,
+      (guint64) ffmpegdec->picture->pts);
+  GST_DEBUG_OBJECT (ffmpegdec, "picture: num %d",
+      ffmpegdec->picture->coded_picture_number);
+  GST_DEBUG_OBJECT (ffmpegdec, "picture: ref %d",
+      ffmpegdec->picture->reference);
+  GST_DEBUG_OBJECT (ffmpegdec, "picture: display %d",
+      ffmpegdec->picture->display_picture_number);
+  GST_DEBUG_OBJECT (ffmpegdec, "picture: opaque %p",
+      ffmpegdec->picture->opaque);
+  GST_DEBUG_OBJECT (ffmpegdec, "picture: reordered opaque %" G_GUINT64_FORMAT,
+      (guint64) ffmpegdec->picture->reordered_opaque);
+  GST_DEBUG_OBJECT (ffmpegdec, "repeat_pict:%d",
+      ffmpegdec->picture->repeat_pict);
+  GST_DEBUG_OBJECT (ffmpegdec, "interlaced_frame:%d (current:%d)",
+      ffmpegdec->picture->interlaced_frame,
+      GST_VIDEO_INFO_IS_INTERLACED (&ffmpegdec->input_state->info));
+
+  if (G_UNLIKELY (ffmpegdec->input_state
+          && ffmpegdec->picture->interlaced_frame !=
+          GST_VIDEO_INFO_IS_INTERLACED (&ffmpegdec->input_state->info))) {
+    GST_WARNING ("Change in interlacing ! picture:%d, recorded:%d",
+        ffmpegdec->picture->interlaced_frame,
+        GST_VIDEO_INFO_IS_INTERLACED (&ffmpegdec->input_state->info));
+    if (ffmpegdec->picture->interlaced_frame)
+      GST_VIDEO_INFO_INTERLACE_MODE (&ffmpegdec->input_state->info) =
+          GST_VIDEO_INTERLACE_MODE_INTERLEAVED;
+    else
+      GST_VIDEO_INFO_INTERLACE_MODE (&ffmpegdec->input_state->info) =
+          GST_VIDEO_INTERLACE_MODE_PROGRESSIVE;
+    if (!gst_ffmpegviddec_negotiate (ffmpegdec, TRUE))
+      goto negotiation_error;
+  }
+
+  if (G_UNLIKELY (out_frame->output_buffer == NULL))
+    *ret = get_output_buffer (ffmpegdec, out_frame);
+
+  if (G_UNLIKELY (*ret != GST_FLOW_OK))
+    goto no_output;
+
+  if (G_UNLIKELY (ffmpegdec->input_state
+          && ffmpegdec->picture->interlaced_frame !=
+          GST_VIDEO_INFO_IS_INTERLACED (&ffmpegdec->input_state->info))) {
+    GST_WARNING ("Change in interlacing ! picture:%d, recorded:%d",
+        ffmpegdec->picture->interlaced_frame,
+        GST_VIDEO_INFO_IS_INTERLACED (&ffmpegdec->input_state->info));
+    if (ffmpegdec->picture->interlaced_frame)
+      GST_VIDEO_INFO_INTERLACE_MODE (&ffmpegdec->input_state->info) =
+          GST_VIDEO_INTERLACE_MODE_INTERLEAVED;
+    else
+      GST_VIDEO_INFO_INTERLACE_MODE (&ffmpegdec->input_state->info) =
+          GST_VIDEO_INTERLACE_MODE_PROGRESSIVE;
+    if (!gst_ffmpegviddec_negotiate (ffmpegdec, TRUE))
+      goto negotiation_error;
+  }
+
+  /* check if we are dealing with a keyframe here, this will also check if we
+   * are dealing with B frames. */
+  iskeyframe = check_keyframe (ffmpegdec);
+
+  /* when we're waiting for a keyframe, see if we have one or drop the current
+   * non-keyframe */
+  if (G_UNLIKELY (ffmpegdec->waiting_for_key)) {
+    if (G_LIKELY (!iskeyframe))
+      goto drop_non_keyframe;
+
+    /* we have a keyframe, we can stop waiting for one */
+    ffmpegdec->waiting_for_key = FALSE;
+  }
+#if 0
+  /* FIXME : How should we properly handle this with base classes */
+  frame->n_fields = ffmpegdec->picture->repeat_pict;
+#endif
+
+  /* palette is not part of raw video frame in gst and the size
+   * of the outgoing buffer needs to be adjusted accordingly */
+  if (ffmpegdec->context->palctrl != NULL)
+    GST_BUFFER_SIZE (out_frame->output_buffer) -= AVPALETTE_SIZE;
+
+  /* mark as keyframe or delta unit */
+  if (ffmpegdec->picture->top_field_first)
+    GST_VIDEO_CODEC_FRAME_FLAG_SET (out_frame, GST_VIDEO_CODEC_FRAME_FLAG_TFF);
+
+
+  *ret =
+      gst_video_decoder_finish_frame (GST_VIDEO_DECODER (ffmpegdec), out_frame);
+
+beach:
+  GST_DEBUG_OBJECT (ffmpegdec, "return flow %d, len %d", *ret, len);
+  return len;
+
+  /* special cases */
+drop_non_keyframe:
+  {
+    GST_WARNING_OBJECT (ffmpegdec, "Dropping non-keyframe (seek/init)");
+    gst_video_decoder_drop_frame (GST_VIDEO_DECODER (ffmpegdec), out_frame);
+    goto beach;
+  }
+
+no_output:
+  {
+    GST_DEBUG_OBJECT (ffmpegdec, "no output buffer");
+    gst_video_decoder_drop_frame (GST_VIDEO_DECODER (ffmpegdec), out_frame);
+    len = -1;
+    goto beach;
+  }
+
+negotiation_error:
+  {
+    GST_WARNING_OBJECT (ffmpegdec, "Error negotiating format");
+    *ret = GST_FLOW_NOT_NEGOTIATED;
+    goto beach;
+  }
+}
+
+
+/* gst_ffmpegviddec_frame:
+ * ffmpegdec:
+ * data: pointer to the data to decode
+ * size: size of data in bytes
+ * got_data: 0 if no data was decoded, != 0 otherwise.
+ * in_time: timestamp of data
+ * in_duration: duration of data
+ * ret: GstFlowReturn to return in the chain function
+ *
+ * Decode the given frame and pushes it downstream.
+ *
+ * Returns: Number of bytes used in decoding, -1 on error/failure.
+ */
+
+static gint
+gst_ffmpegviddec_frame (GstFFMpegVidDec * ffmpegdec,
+    guint8 * data, guint size, gint * got_data, GstVideoCodecFrame * frame,
+    GstFlowReturn * ret)
+{
+  GstFFMpegVidDecClass *oclass;
+  gint have_data = 0, len = 0;
+
+  if (G_UNLIKELY (ffmpegdec->context->codec == NULL))
+    goto no_codec;
+
+  GST_LOG_OBJECT (ffmpegdec, "data:%p, size:%d", data, size);
+
+  *ret = GST_FLOW_OK;
+  ffmpegdec->context->frame_number++;
+
+  oclass = (GstFFMpegVidDecClass *) (G_OBJECT_GET_CLASS (ffmpegdec));
+
+  len = gst_ffmpegviddec_video_frame (ffmpegdec, data, size, frame, ret);
+
+  if (frame && frame->output_buffer)
+    have_data = 1;
+
+  if (len < 0 || have_data < 0) {
+    GST_WARNING_OBJECT (ffmpegdec,
+        "ffdec_%s: decoding error (len: %d, have_data: %d)",
+        oclass->in_plugin->name, len, have_data);
+    *got_data = 0;
+    goto beach;
+  }
+  if (len == 0 && have_data == 0) {
+    *got_data = 0;
+    goto beach;
+  }
+
+  /* this is where I lost my last clue on ffmpeg... */
+  *got_data = 1;
+
+beach:
+  return len;
+
+  /* ERRORS */
+no_codec:
+  {
+    GST_ERROR_OBJECT (ffmpegdec, "no codec context");
+    return -1;
+  }
+}
+
+static void
+gst_ffmpegviddec_drain (GstFFMpegVidDec * ffmpegdec)
+{
+  GstFFMpegVidDecClass *oclass;
+
+  oclass = (GstFFMpegVidDecClass *) (G_OBJECT_GET_CLASS (ffmpegdec));
+
+  if (oclass->in_plugin->capabilities & CODEC_CAP_DELAY) {
+    gint have_data, len, try = 0;
+
+    GST_LOG_OBJECT (ffmpegdec,
+        "codec has delay capabilities, calling until ffmpeg has drained everything");
+
+    do {
+      GstFlowReturn ret;
+
+      len = gst_ffmpegviddec_frame (ffmpegdec, NULL, 0, &have_data, NULL, &ret);
+      if (len < 0 || have_data == 0)
+        break;
+    } while (try++ < 10);
+  }
+}
+
+static GstFlowReturn
+gst_ffmpegviddec_handle_frame (GstVideoDecoder * decoder,
+    GstVideoCodecFrame * frame)
+{
+  GstFFMpegVidDec *ffmpegdec = (GstFFMpegVidDec *) decoder;
+  guint8 *data, *bdata;
+  gint size, bsize, len, have_data;
+  GstFlowReturn ret = GST_FLOW_OK;
+
+  /* do early keyframe check pretty bad to rely on the keyframe flag in the
+   * source for this as it might not even be parsed (UDP/file/..).  */
+  if (G_UNLIKELY (ffmpegdec->waiting_for_key)) {
+    GST_DEBUG_OBJECT (ffmpegdec, "waiting for keyframe");
+    if (!GST_VIDEO_CODEC_FRAME_IS_SYNC_POINT (frame))
+      goto skip_keyframe;
+
+    GST_DEBUG_OBJECT (ffmpegdec, "got keyframe");
+    ffmpegdec->waiting_for_key = FALSE;
+  }
+
+  GST_LOG_OBJECT (ffmpegdec,
+      "Received new data of size %u, pts:%"
+      GST_TIME_FORMAT ", dur:%" GST_TIME_FORMAT,
+      GST_BUFFER_SIZE (frame->input_buffer),
+      GST_TIME_ARGS (frame->pts), GST_TIME_ARGS (frame->duration));
+
+  bdata = GST_BUFFER_DATA (frame->input_buffer);
+  bsize = GST_BUFFER_SIZE (frame->input_buffer);
+
+  if (ffmpegdec->do_padding) {
+    /* add padding */
+    if (ffmpegdec->padded_size < bsize + FF_INPUT_BUFFER_PADDING_SIZE) {
+      ffmpegdec->padded_size = bsize + FF_INPUT_BUFFER_PADDING_SIZE;
+      ffmpegdec->padded = g_realloc (ffmpegdec->padded, ffmpegdec->padded_size);
+      GST_LOG_OBJECT (ffmpegdec, "resized padding buffer to %d",
+          ffmpegdec->padded_size);
+    }
+    memcpy (ffmpegdec->padded, bdata, bsize);
+    memset (ffmpegdec->padded + bsize, 0, FF_INPUT_BUFFER_PADDING_SIZE);
+
+    bdata = ffmpegdec->padded;
+  }
+
+  do {
+    guint8 tmp_padding[FF_INPUT_BUFFER_PADDING_SIZE];
+
+    /* parse, if at all possible */
+    data = bdata;
+    size = bsize;
+
+    if (ffmpegdec->do_padding) {
+      /* add temporary padding */
+      memcpy (tmp_padding, data + size, FF_INPUT_BUFFER_PADDING_SIZE);
+      memset (data + size, 0, FF_INPUT_BUFFER_PADDING_SIZE);
+    }
+
+    /* decode a frame of audio/video now */
+    len =
+        gst_ffmpegviddec_frame (ffmpegdec, data, size, &have_data, frame, &ret);
+
+    if (ffmpegdec->do_padding) {
+      memcpy (data + size, tmp_padding, FF_INPUT_BUFFER_PADDING_SIZE);
+    }
+
+    if (ret != GST_FLOW_OK) {
+      GST_LOG_OBJECT (ffmpegdec, "breaking because of flow ret %s",
+          gst_flow_get_name (ret));
+      /* bad flow retun, make sure we discard all data and exit */
+      bsize = 0;
+      break;
+    }
+
+    if (len == 0 && !have_data) {
+      /* nothing was decoded, this could be because no data was available or
+       * because we were skipping frames.
+       * If we have no context we must exit and wait for more data, we keep the
+       * data we tried. */
+      GST_LOG_OBJECT (ffmpegdec, "Decoding didn't return any data, breaking");
+      break;
+    }
+
+    if (len < 0) {
+      /* a decoding error happened, we must break and try again with next data. */
+      GST_LOG_OBJECT (ffmpegdec, "Decoding error, breaking");
+      bsize = 0;
+      break;
+    }
+
+    /* prepare for the next round, for codecs with a context we did this
+     * already when using the parser. */
+    bsize -= len;
+    bdata += len;
+
+    GST_LOG_OBJECT (ffmpegdec, "Before (while bsize>0).  bsize:%d , bdata:%p",
+        bsize, bdata);
+  } while (bsize > 0);
+
+  if (bsize > 0)
+    GST_DEBUG_OBJECT (ffmpegdec, "Dropping %d bytes of data", bsize);
+
+  return ret;
+
+  /* ERRORS */
+skip_keyframe:
+  {
+    GST_DEBUG_OBJECT (ffmpegdec, "skipping non keyframe");
+    return gst_video_decoder_drop_frame (decoder, frame);
+  }
+}
+
+static gboolean
+gst_ffmpegviddec_stop (GstVideoDecoder * decoder)
+{
+  GstFFMpegVidDec *ffmpegdec = (GstFFMpegVidDec *) decoder;
+
+  GST_OBJECT_LOCK (ffmpegdec);
+  gst_ffmpegviddec_close (ffmpegdec);
+  GST_OBJECT_UNLOCK (ffmpegdec);
+  g_free (ffmpegdec->padded);
+  ffmpegdec->padded = NULL;
+  ffmpegdec->padded_size = 0;
+  ffmpegdec->can_allocate_aligned = TRUE;
+  if (ffmpegdec->input_state)
+    gst_video_codec_state_unref (ffmpegdec->input_state);
+  ffmpegdec->input_state = NULL;
+  if (ffmpegdec->output_state)
+    gst_video_codec_state_unref (ffmpegdec->output_state);
+  ffmpegdec->output_state = NULL;
+
+  return TRUE;
+}
+
+static GstFlowReturn
+gst_ffmpegviddec_finish (GstVideoDecoder * decoder)
+{
+  GstFFMpegVidDec *ffmpegdec = (GstFFMpegVidDec *) decoder;
+
+  gst_ffmpegviddec_drain (ffmpegdec);
+
+  return GST_FLOW_OK;
+}
+
+static gboolean
+gst_ffmpegviddec_reset (GstVideoDecoder * decoder, gboolean hard)
+{
+  GstFFMpegVidDec *ffmpegdec = (GstFFMpegVidDec *) decoder;
+
+  if (ffmpegdec->opened) {
+    if (!hard)
+      gst_ffmpegviddec_drain (ffmpegdec);
+    avcodec_flush_buffers (ffmpegdec->context);
+  }
+
+  return TRUE;
+}
+
+static void
+gst_ffmpegviddec_set_property (GObject * object,
+    guint prop_id, const GValue * value, GParamSpec * pspec)
+{
+  GstFFMpegVidDec *ffmpegdec = (GstFFMpegVidDec *) object;
+
+  switch (prop_id) {
+    case PROP_LOWRES:
+      ffmpegdec->lowres = ffmpegdec->context->lowres = g_value_get_enum (value);
+      break;
+    case PROP_SKIPFRAME:
+      ffmpegdec->skip_frame = ffmpegdec->context->skip_frame =
+          g_value_get_enum (value);
+      break;
+    case PROP_DIRECT_RENDERING:
+      ffmpegdec->direct_rendering = g_value_get_boolean (value);
+      break;
+    case PROP_DO_PADDING:
+      ffmpegdec->do_padding = g_value_get_boolean (value);
+      break;
+    case PROP_DEBUG_MV:
+      ffmpegdec->debug_mv = ffmpegdec->context->debug_mv =
+          g_value_get_boolean (value);
+      break;
+    case PROP_CROP:
+      ffmpegdec->crop = g_value_get_boolean (value);
+      break;
+    case PROP_MAX_THREADS:
+      ffmpegdec->max_threads = g_value_get_int (value);
+      break;
+    default:
+      G_OBJECT_WARN_INVALID_PROPERTY_ID (object, prop_id, pspec);
+      break;
+  }
+}
+
+static void
+gst_ffmpegviddec_get_property (GObject * object,
+    guint prop_id, GValue * value, GParamSpec * pspec)
+{
+  GstFFMpegVidDec *ffmpegdec = (GstFFMpegVidDec *) object;
+
+  switch (prop_id) {
+    case PROP_LOWRES:
+      g_value_set_enum (value, ffmpegdec->context->lowres);
+      break;
+    case PROP_SKIPFRAME:
+      g_value_set_enum (value, ffmpegdec->context->skip_frame);
+      break;
+    case PROP_DIRECT_RENDERING:
+      g_value_set_boolean (value, ffmpegdec->direct_rendering);
+      break;
+    case PROP_DO_PADDING:
+      g_value_set_boolean (value, ffmpegdec->do_padding);
+      break;
+    case PROP_DEBUG_MV:
+      g_value_set_boolean (value, ffmpegdec->context->debug_mv);
+      break;
+    case PROP_CROP:
+      g_value_set_boolean (value, ffmpegdec->crop);
+      break;
+    case PROP_MAX_THREADS:
+      g_value_set_int (value, ffmpegdec->max_threads);
+      break;
+    default:
+      G_OBJECT_WARN_INVALID_PROPERTY_ID (object, prop_id, pspec);
+      break;
+  }
+}
+
+gboolean
+gst_ffmpegviddec_register (GstPlugin * plugin)
+{
+  GTypeInfo typeinfo = {
+    sizeof (GstFFMpegVidDecClass),
+    (GBaseInitFunc) gst_ffmpegviddec_base_init,
+    NULL,
+    (GClassInitFunc) gst_ffmpegviddec_class_init,
+    NULL,
+    NULL,
+    sizeof (GstFFMpegVidDec),
+    0,
+    (GInstanceInitFunc) gst_ffmpegviddec_init,
+  };
+  GType type;
+  AVCodec *in_plugin;
+  gint rank;
+
+  in_plugin = av_codec_next (NULL);
+
+  GST_LOG ("Registering decoders");
+
+  while (in_plugin) {
+    gchar *type_name;
+    gchar *plugin_name;
+
+    /* only decoders */
+    if (!in_plugin->decode) {
+      goto next;
+    }
+
+    /* no quasi-codecs, please */
+    if (in_plugin->id == CODEC_ID_RAWVIDEO ||
+        in_plugin->id == CODEC_ID_V210 ||
+        in_plugin->id == CODEC_ID_V210X ||
+        in_plugin->id == CODEC_ID_R210 ||
+        (in_plugin->id >= CODEC_ID_PCM_S16LE &&
+            in_plugin->id <= CODEC_ID_PCM_BLURAY)) {
+      goto next;
+    }
+
+    /* No decoders depending on external libraries (we don't build them, but
+     * people who build against an external ffmpeg might have them.
+     * We have native gstreamer plugins for all of those libraries anyway. */
+    if (!strncmp (in_plugin->name, "lib", 3)) {
+      GST_DEBUG
+          ("Not using external library decoder %s. Use the gstreamer-native ones instead.",
+          in_plugin->name);
+      goto next;
+    }
+
+    /* No vdpau plugins until we can figure out how to properly use them
+     * outside of ffmpeg. */
+    if (g_str_has_suffix (in_plugin->name, "_vdpau")) {
+      GST_DEBUG
+          ("Ignoring VDPAU decoder %s. We can't handle this outside of ffmpeg",
+          in_plugin->name);
+      goto next;
+    }
+
+    if (g_str_has_suffix (in_plugin->name, "_xvmc")) {
+      GST_DEBUG
+          ("Ignoring XVMC decoder %s. We can't handle this outside of ffmpeg",
+          in_plugin->name);
+      goto next;
+    }
+
+    GST_DEBUG ("Trying plugin %s [%s]", in_plugin->name, in_plugin->long_name);
+
+    /* no codecs for which we're GUARANTEED to have better alternatives */
+    /* MPEG1VIDEO : the mpeg2video decoder is preferred */
+    /* MP1 : Use MP3 for decoding */
+    /* MP2 : Use MP3 for decoding */
+    /* Theora: Use libtheora based theoradec */
+    if (!strcmp (in_plugin->name, "gif") ||
+        !strcmp (in_plugin->name, "theora") ||
+        !strcmp (in_plugin->name, "mpeg1video") ||
+        !strcmp (in_plugin->name, "ass") ||
+        !strcmp (in_plugin->name, "srt") ||
+        !strcmp (in_plugin->name, "pgssub") ||
+        !strcmp (in_plugin->name, "dvdsub") ||
+        !strcmp (in_plugin->name, "dvbsub")) {
+      GST_LOG ("Ignoring decoder %s", in_plugin->name);
+      goto next;
+    }
+
+    /* construct the type */
+    plugin_name = g_strdup ((gchar *) in_plugin->name);
+    g_strdelimit (plugin_name, NULL, '_');
+    type_name = g_strdup_printf ("ffdec_%s", plugin_name);
+    g_free (plugin_name);
+
+    type = g_type_from_name (type_name);
+
+    if (!type) {
+      /* create the gtype now */
+      type =
+          g_type_register_static (GST_TYPE_VIDEO_DECODER, type_name, &typeinfo,
+          0);
+      g_type_set_qdata (type, GST_FFDEC_PARAMS_QDATA, (gpointer) in_plugin);
+    }
+
+    /* (Ronald) MPEG-4 gets a higher priority because it has been well-
+     * tested and by far outperforms divxdec/xviddec - so we prefer it.
+     * msmpeg4v3 same, as it outperforms divxdec for divx3 playback.
+     * VC1/WMV3 are not working and thus unpreferred for now. */
+    switch (in_plugin->id) {
+      case CODEC_ID_MPEG4:
+      case CODEC_ID_MSMPEG4V3:
+      case CODEC_ID_H264:
+      case CODEC_ID_RV10:
+      case CODEC_ID_RV20:
+      case CODEC_ID_RV30:
+      case CODEC_ID_RV40:
+        rank = GST_RANK_PRIMARY;
+        break;
+        /* DVVIDEO: we have a good dv decoder, fast on both ppc as well as x86.
+         * They say libdv's quality is better though. leave as secondary.
+         * note: if you change this, see the code in gstdv.c in good/ext/dv.
+         */
+      case CODEC_ID_DVVIDEO:
+        rank = GST_RANK_SECONDARY;
+        break;
+      default:
+        rank = GST_RANK_MARGINAL;
+        break;
+    }
+    if (!gst_element_register (plugin, type_name, rank, type)) {
+      g_warning ("Failed to register %s", type_name);
+      g_free (type_name);
+      return FALSE;
+    }
+
+    g_free (type_name);
+
+  next:
+    in_plugin = av_codec_next (in_plugin);
+  }
+
+  GST_LOG ("Finished Registering decoders");
+
+  return TRUE;
+}
diff --git a/ext/ffmpeg/gstffmpegvidenc.c b/ext/ffmpeg/gstffmpegvidenc.c
new file mode 100644
index 0000000..e30014a
--- /dev/null
+++ b/ext/ffmpeg/gstffmpegvidenc.c
@@ -0,0 +1,988 @@
+/* GStreamer
+ * Copyright (C) <1999> Erik Walthinsen <omega@cse.ogi.edu>
+ *
+ * This library is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU Library General Public
+ * License as published by the Free Software Foundation; either
+ * version 2 of the License, or (at your option) any later version.
+ *
+ * This library is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+ * Library General Public License for more details.
+ *
+ * You should have received a copy of the GNU Library General Public
+ * License along with this library; if not, write to the
+ * Free Software Foundation, Inc., 59 Temple Place - Suite 330,
+ * Boston, MA 02111-1307, USA.
+ */
+
+#ifdef HAVE_CONFIG_H
+#include "config.h"
+#endif
+
+#include <assert.h>
+#include <string.h>
+/* for stats file handling */
+#include <stdio.h>
+#include <glib/gstdio.h>
+#include <errno.h>
+
+#ifdef HAVE_FFMPEG_UNINSTALLED
+#include <avcodec.h>
+#else
+#include <libavcodec/avcodec.h>
+#endif
+
+#include <gst/gst.h>
+
+#include "gstffmpeg.h"
+#include "gstffmpegcodecmap.h"
+#include "gstffmpegutils.h"
+#include "gstffmpegvidenc.h"
+#include "gstffmpegcfg.h"
+
+#define DEFAULT_VIDEO_BITRATE 300000    /* in bps */
+#define DEFAULT_VIDEO_GOP_SIZE 15
+
+#define DEFAULT_WIDTH 352
+#define DEFAULT_HEIGHT 288
+
+
+#define VIDEO_BUFFER_SIZE (1024*1024)
+
+enum
+{
+  /* FILL ME */
+  LAST_SIGNAL
+};
+
+enum
+{
+  ARG_0,
+  ARG_BIT_RATE,
+  ARG_GOP_SIZE,
+  ARG_ME_METHOD,
+  ARG_BUFSIZE,
+  ARG_RTP_PAYLOAD_SIZE,
+  ARG_CFG_BASE
+};
+
+#define GST_TYPE_ME_METHOD (gst_ffmpegvidenc_me_method_get_type())
+static GType
+gst_ffmpegvidenc_me_method_get_type (void)
+{
+  static GType ffmpegenc_me_method_type = 0;
+  static GEnumValue ffmpegenc_me_methods[] = {
+    {ME_ZERO, "None (Very low quality)", "zero"},
+    {ME_FULL, "Full (Slow, unmaintained)", "full"},
+    {ME_LOG, "Logarithmic (Low quality, unmaintained)", "logarithmic"},
+    {ME_PHODS, "phods (Low quality, unmaintained)", "phods"},
+    {ME_EPZS, "EPZS (Best quality, Fast)", "epzs"},
+    {ME_X1, "X1 (Experimental)", "x1"},
+    {0, NULL, NULL},
+  };
+  if (!ffmpegenc_me_method_type) {
+    ffmpegenc_me_method_type =
+        g_enum_register_static ("GstFFMpegVidEncMeMethod",
+        ffmpegenc_me_methods);
+  }
+  return ffmpegenc_me_method_type;
+}
+
+/* A number of function prototypes are given so we can refer to them later. */
+static void gst_ffmpegvidenc_class_init (GstFFMpegVidEncClass * klass);
+static void gst_ffmpegvidenc_base_init (GstFFMpegVidEncClass * klass);
+static void gst_ffmpegvidenc_init (GstFFMpegVidEnc * ffmpegenc);
+static void gst_ffmpegvidenc_finalize (GObject * object);
+
+static gboolean gst_ffmpegvidenc_stop (GstVideoEncoder * encoder);
+static GstFlowReturn gst_ffmpegvidenc_finish (GstVideoEncoder * encoder);
+static gboolean gst_ffmpegvidenc_set_format (GstVideoEncoder * encoder,
+    GstVideoCodecState * state);
+
+static GstCaps *gst_ffmpegvidenc_getcaps (GstVideoEncoder * encoder);
+static GstFlowReturn gst_ffmpegvidenc_handle_frame (GstVideoEncoder * encoder,
+    GstVideoCodecFrame * frame);
+
+static void gst_ffmpegvidenc_set_property (GObject * object,
+    guint prop_id, const GValue * value, GParamSpec * pspec);
+static void gst_ffmpegvidenc_get_property (GObject * object,
+    guint prop_id, GValue * value, GParamSpec * pspec);
+
+#define GST_FFENC_PARAMS_QDATA g_quark_from_static_string("ffenc-params")
+
+static GstElementClass *parent_class = NULL;
+
+/*static guint gst_ffmpegvidenc_signals[LAST_SIGNAL] = { 0 }; */
+
+static void
+gst_ffmpegvidenc_base_init (GstFFMpegVidEncClass * klass)
+{
+  GstElementClass *element_class = GST_ELEMENT_CLASS (klass);
+  AVCodec *in_plugin;
+  GstPadTemplate *srctempl = NULL, *sinktempl = NULL;
+  GstCaps *srccaps = NULL, *sinkcaps = NULL;
+  gchar *longname, *description;
+
+  in_plugin =
+      (AVCodec *) g_type_get_qdata (G_OBJECT_CLASS_TYPE (klass),
+      GST_FFENC_PARAMS_QDATA);
+  g_assert (in_plugin != NULL);
+
+  /* construct the element details struct */
+  longname = g_strdup_printf ("FFmpeg %s encoder", in_plugin->long_name);
+  description = g_strdup_printf ("FFmpeg %s encoder", in_plugin->name);
+  gst_element_class_set_details_simple (element_class, longname,
+      "Codec/Encoder/Video", description,
+      "Wim Taymans <wim.taymans@gmail.com>, "
+      "Ronald Bultje <rbultje@ronald.bitfreak.net>");
+  g_free (longname);
+  g_free (description);
+
+  if (!(srccaps = gst_ffmpeg_codecid_to_caps (in_plugin->id, NULL, TRUE))) {
+    GST_DEBUG ("Couldn't get source caps for encoder '%s'", in_plugin->name);
+    srccaps = gst_caps_new_simple ("unknown/unknown", NULL);
+  }
+
+  sinkcaps = gst_caps_from_string
+      ("video/x-raw-rgb; video/x-raw-yuv; video/x-raw-gray");
+
+  /* pad templates */
+  sinktempl = gst_pad_template_new ("sink", GST_PAD_SINK,
+      GST_PAD_ALWAYS, sinkcaps);
+  srctempl = gst_pad_template_new ("src", GST_PAD_SRC, GST_PAD_ALWAYS, srccaps);
+
+  gst_element_class_add_pad_template (element_class, srctempl);
+  gst_element_class_add_pad_template (element_class, sinktempl);
+
+  klass->in_plugin = in_plugin;
+  klass->srctempl = srctempl;
+  klass->sinktempl = sinktempl;
+  klass->sinkcaps = NULL;
+
+  return;
+}
+
+static void
+gst_ffmpegvidenc_class_init (GstFFMpegVidEncClass * klass)
+{
+  GObjectClass *gobject_class;
+  GstVideoEncoderClass *venc_class;
+
+  gobject_class = (GObjectClass *) klass;
+  venc_class = (GstVideoEncoderClass *) klass;
+
+  parent_class = g_type_class_peek_parent (klass);
+
+  gobject_class->set_property = gst_ffmpegvidenc_set_property;
+  gobject_class->get_property = gst_ffmpegvidenc_get_property;
+
+  g_object_class_install_property (G_OBJECT_CLASS (klass), ARG_BIT_RATE,
+      g_param_spec_ulong ("bitrate", "Bit Rate",
+          "Target Video Bitrate", 0, G_MAXULONG, DEFAULT_VIDEO_BITRATE,
+          G_PARAM_READWRITE | G_PARAM_STATIC_STRINGS));
+  g_object_class_install_property (G_OBJECT_CLASS (klass), ARG_GOP_SIZE,
+      g_param_spec_int ("gop-size", "GOP Size",
+          "Number of frames within one GOP", 0, G_MAXINT,
+          DEFAULT_VIDEO_GOP_SIZE, G_PARAM_READWRITE | G_PARAM_STATIC_STRINGS));
+  g_object_class_install_property (G_OBJECT_CLASS (klass), ARG_ME_METHOD,
+      g_param_spec_enum ("me-method", "ME Method", "Motion Estimation Method",
+          GST_TYPE_ME_METHOD, ME_EPZS,
+          G_PARAM_READWRITE | G_PARAM_STATIC_STRINGS));
+
+  /* FIXME 0.11: Make this property read-only */
+  g_object_class_install_property (G_OBJECT_CLASS (klass), ARG_BUFSIZE,
+      g_param_spec_ulong ("buffer-size", "Buffer Size",
+          "Size of the video buffers. "
+          "Note: Setting this property has no effect "
+          "and is deprecated!", 0, G_MAXULONG, 0,
+          G_PARAM_READWRITE | G_PARAM_STATIC_STRINGS));
+  g_object_class_install_property (G_OBJECT_CLASS (klass),
+      ARG_RTP_PAYLOAD_SIZE, g_param_spec_ulong ("rtp-payload-size",
+          "RTP Payload Size", "Target GOB length", 0, G_MAXULONG, 0,
+          G_PARAM_READWRITE | G_PARAM_STATIC_STRINGS));
+
+  /* register additional properties, possibly dependent on the exact CODEC */
+  gst_ffmpeg_cfg_install_property (klass, ARG_CFG_BASE);
+
+  venc_class->stop = gst_ffmpegvidenc_stop;
+  venc_class->finish = gst_ffmpegvidenc_finish;
+  venc_class->handle_frame = gst_ffmpegvidenc_handle_frame;
+  venc_class->getcaps = gst_ffmpegvidenc_getcaps;
+  venc_class->set_format = gst_ffmpegvidenc_set_format;
+
+  gobject_class->finalize = gst_ffmpegvidenc_finalize;
+}
+
+static void
+gst_ffmpegvidenc_init (GstFFMpegVidEnc * ffmpegenc)
+{
+  /* ffmpeg objects */
+  ffmpegenc->context = avcodec_alloc_context ();
+  ffmpegenc->picture = avcodec_alloc_frame ();
+  ffmpegenc->opened = FALSE;
+
+  ffmpegenc->file = NULL;
+
+  ffmpegenc->bitrate = DEFAULT_VIDEO_BITRATE;
+  ffmpegenc->me_method = ME_EPZS;
+  ffmpegenc->buffer_size = 512 * 1024;
+  ffmpegenc->gop_size = DEFAULT_VIDEO_GOP_SIZE;
+  ffmpegenc->rtp_payload_size = 0;
+
+  ffmpegenc->lmin = 2;
+  ffmpegenc->lmax = 31;
+  ffmpegenc->max_key_interval = 0;
+
+  gst_ffmpeg_cfg_set_defaults (ffmpegenc);
+}
+
+static void
+gst_ffmpegvidenc_finalize (GObject * object)
+{
+  GstFFMpegVidEnc *ffmpegenc = (GstFFMpegVidEnc *) object;
+
+  gst_ffmpeg_cfg_finalize (ffmpegenc);
+
+  /* close old session */
+  if (ffmpegenc->opened) {
+    gst_ffmpeg_avcodec_close (ffmpegenc->context);
+    ffmpegenc->opened = FALSE;
+  }
+
+  /* clean up remaining allocated data */
+  av_free (ffmpegenc->context);
+  av_free (ffmpegenc->picture);
+
+  g_free (ffmpegenc->filename);
+
+  G_OBJECT_CLASS (parent_class)->finalize (object);
+}
+
+static GstCaps *
+gst_ffmpegvidenc_getcaps (GstVideoEncoder * encoder)
+{
+  GstFFMpegVidEnc *ffmpegenc = (GstFFMpegVidEnc *) encoder;
+  GstFFMpegVidEncClass *oclass =
+      (GstFFMpegVidEncClass *) G_OBJECT_GET_CLASS (ffmpegenc);
+  AVCodecContext *ctx = NULL;
+  enum PixelFormat pixfmt;
+  GstCaps *caps = NULL;
+  gint i;
+
+  GST_DEBUG_OBJECT (ffmpegenc, "getting caps");
+
+  /* cached */
+  if (oclass->sinkcaps) {
+    caps = gst_video_encoder_proxy_getcaps (encoder, oclass->sinkcaps);
+    GST_DEBUG_OBJECT (ffmpegenc, "return cached caps %" GST_PTR_FORMAT, caps);
+    return caps;
+  }
+
+  /* create cache etc. */
+
+  /* shut up the logging while we autoprobe; we don't want warnings and
+   * errors about unsupported formats */
+  /* FIXME: if someone cares about this disabling the logging for other
+   * instances/threads/..., one could investigate if there is a way to
+   * set this as a struct member on the av context, and check it from the
+   * log handler */
+#ifndef GST_DISABLE_GST_DEBUG
+  _shut_up_I_am_probing = TRUE;
+#endif
+  GST_DEBUG_OBJECT (ffmpegenc, "probing caps");
+  i = pixfmt = 0;
+  /* check pixfmt until deemed finished */
+  for (pixfmt = 0;; pixfmt++) {
+    GstCaps *tmpcaps;
+
+    /* override looping all pixfmt if codec declares pixfmts;
+     * these may not properly check and report supported pixfmt during _init */
+    if (oclass->in_plugin->pix_fmts) {
+      if ((pixfmt = oclass->in_plugin->pix_fmts[i++]) == PIX_FMT_NONE) {
+        GST_DEBUG_OBJECT (ffmpegenc,
+            "At the end of official pixfmt for this codec, breaking out");
+        break;
+      }
+      GST_DEBUG_OBJECT (ffmpegenc,
+          "Got an official pixfmt [%d], attempting to get caps", pixfmt);
+      tmpcaps =
+          gst_ffmpeg_pixfmt_to_caps (pixfmt, NULL, oclass->in_plugin->id, TRUE);
+      if (tmpcaps) {
+        GST_DEBUG_OBJECT (ffmpegenc, "Got caps, breaking out");
+        if (!caps)
+          caps = gst_caps_new_empty ();
+        gst_caps_append (caps, tmpcaps);
+        continue;
+      }
+      GST_DEBUG_OBJECT (ffmpegenc,
+          "Couldn't figure out caps without context, trying again with a context");
+    }
+
+    GST_DEBUG_OBJECT (ffmpegenc, "pixfmt :%d", pixfmt);
+    if (pixfmt >= PIX_FMT_NB) {
+      GST_WARNING ("Invalid pixfmt, breaking out");
+      break;
+    }
+
+    /* need to start with a fresh codec_context each time around, since
+     * codec_close may have released stuff causing the next pass to segfault */
+    ctx = avcodec_alloc_context ();
+    if (!ctx) {
+      GST_DEBUG_OBJECT (ffmpegenc, "no context");
+      break;
+    }
+
+    /* set some default properties */
+    ctx->width = DEFAULT_WIDTH;
+    ctx->height = DEFAULT_HEIGHT;
+    ctx->time_base.num = 1;
+    ctx->time_base.den = 25;
+    ctx->ticks_per_frame = 1;
+    ctx->bit_rate = DEFAULT_VIDEO_BITRATE;
+    /* makes it silent */
+    ctx->strict_std_compliance = -1;
+
+    ctx->pix_fmt = pixfmt;
+
+    GST_DEBUG ("Attempting to open codec");
+    if (gst_ffmpeg_avcodec_open (ctx, oclass->in_plugin) >= 0 &&
+        ctx->pix_fmt == pixfmt) {
+      ctx->width = -1;
+      if (!caps)
+        caps = gst_caps_new_empty ();
+      tmpcaps = gst_ffmpeg_codectype_to_caps (oclass->in_plugin->type, ctx,
+          oclass->in_plugin->id, TRUE);
+      if (tmpcaps)
+        gst_caps_append (caps, tmpcaps);
+      else
+        GST_LOG_OBJECT (ffmpegenc,
+            "Couldn't get caps for oclass->in_plugin->name:%s",
+            oclass->in_plugin->name);
+      gst_ffmpeg_avcodec_close (ctx);
+    } else {
+      GST_DEBUG_OBJECT (ffmpegenc, "Opening codec failed with pixfmt : %d",
+          pixfmt);
+    }
+    if (ctx->priv_data)
+      gst_ffmpeg_avcodec_close (ctx);
+    av_free (ctx);
+  }
+#ifndef GST_DISABLE_GST_DEBUG
+  _shut_up_I_am_probing = FALSE;
+#endif
+
+  oclass->sinkcaps = gst_video_encoder_proxy_getcaps (encoder, caps);
+
+  return gst_caps_ref (oclass->sinkcaps);
+}
+
+static gboolean
+gst_ffmpegvidenc_set_format (GstVideoEncoder * encoder,
+    GstVideoCodecState * state)
+{
+  GstCaps *other_caps;
+  GstCaps *allowed_caps;
+  GstCaps *icaps;
+  GstVideoCodecState *output_format;
+  enum PixelFormat pix_fmt;
+  GstFFMpegVidEnc *ffmpegenc = (GstFFMpegVidEnc *) encoder;
+  GstFFMpegVidEncClass *oclass =
+      (GstFFMpegVidEncClass *) G_OBJECT_GET_CLASS (ffmpegenc);
+
+  /* close old session */
+  if (ffmpegenc->opened) {
+    gst_ffmpeg_avcodec_close (ffmpegenc->context);
+    ffmpegenc->opened = FALSE;
+#if 0
+    /* FIXME : Is this still needed with GstVideoEncoder ?? */
+    /* fixed src caps;
+     * so clear src caps for proper (re-)negotiation */
+    gst_pad_set_caps (ffmpegenc->srcpad, NULL);
+#endif
+  }
+
+  /* set defaults */
+  avcodec_get_context_defaults (ffmpegenc->context);
+
+  /* if we set it in _getcaps we should set it also in _link */
+  ffmpegenc->context->strict_std_compliance = -1;
+
+  /* user defined properties */
+  ffmpegenc->context->bit_rate = ffmpegenc->bitrate;
+  ffmpegenc->context->bit_rate_tolerance = ffmpegenc->bitrate;
+  ffmpegenc->context->gop_size = ffmpegenc->gop_size;
+  ffmpegenc->context->me_method = ffmpegenc->me_method;
+  GST_DEBUG_OBJECT (ffmpegenc, "Setting avcontext to bitrate %lu, gop_size %d",
+      ffmpegenc->bitrate, ffmpegenc->gop_size);
+
+  /* RTP payload used for GOB production (for Asterisk) */
+  if (ffmpegenc->rtp_payload_size) {
+    ffmpegenc->context->rtp_payload_size = ffmpegenc->rtp_payload_size;
+  }
+
+  /* additional avcodec settings */
+  /* first fill in the majority by copying over */
+  gst_ffmpeg_cfg_fill_context (ffmpegenc, ffmpegenc->context);
+
+  /* then handle some special cases */
+  ffmpegenc->context->lmin = (ffmpegenc->lmin * FF_QP2LAMBDA + 0.5);
+  ffmpegenc->context->lmax = (ffmpegenc->lmax * FF_QP2LAMBDA + 0.5);
+
+  if (ffmpegenc->interlaced) {
+    ffmpegenc->context->flags |=
+        CODEC_FLAG_INTERLACED_DCT | CODEC_FLAG_INTERLACED_ME;
+    ffmpegenc->picture->interlaced_frame = TRUE;
+    /* if this is not the case, a filter element should be used to swap fields */
+    ffmpegenc->picture->top_field_first = TRUE;
+  }
+
+  /* some other defaults */
+  ffmpegenc->context->rc_strategy = 2;
+  ffmpegenc->context->b_frame_strategy = 0;
+  ffmpegenc->context->coder_type = 0;
+  ffmpegenc->context->context_model = 0;
+  ffmpegenc->context->scenechange_threshold = 0;
+  ffmpegenc->context->inter_threshold = 0;
+
+  /* and last but not least the pass; CBR, 2-pass, etc */
+  ffmpegenc->context->flags |= ffmpegenc->pass;
+  switch (ffmpegenc->pass) {
+      /* some additional action depends on type of pass */
+    case CODEC_FLAG_QSCALE:
+      ffmpegenc->context->global_quality
+          = ffmpegenc->picture->quality = FF_QP2LAMBDA * ffmpegenc->quantizer;
+      break;
+    case CODEC_FLAG_PASS1:     /* need to prepare a stats file */
+      /* we don't close when changing caps, fingers crossed */
+      if (!ffmpegenc->file)
+        ffmpegenc->file = g_fopen (ffmpegenc->filename, "w");
+      if (!ffmpegenc->file)
+        goto open_file_err;
+      break;
+    case CODEC_FLAG_PASS2:
+    {                           /* need to read the whole stats file ! */
+      gsize size;
+
+      if (!g_file_get_contents (ffmpegenc->filename,
+              &ffmpegenc->context->stats_in, &size, NULL))
+        goto file_read_err;
+
+      break;
+    }
+    default:
+      break;
+  }
+
+  GST_DEBUG_OBJECT (ffmpegenc, "Extracting common video information");
+  /* fetch pix_fmt, fps, par, width, height... */
+  gst_ffmpeg_videoinfo_to_context (&state->info, ffmpegenc->context);
+
+  if ((oclass->in_plugin->id == CODEC_ID_MPEG4)
+      && (ffmpegenc->context->time_base.den > 65535)) {
+    /* MPEG4 Standards do not support time_base denominator greater than
+     * (1<<16) - 1 . We therefore scale them down.
+     * Agreed, it will not be the exact framerate... but the difference
+     * shouldn't be that noticeable */
+    ffmpegenc->context->time_base.num =
+        (gint) gst_util_uint64_scale_int (ffmpegenc->context->time_base.num,
+        65535, ffmpegenc->context->time_base.den);
+    ffmpegenc->context->time_base.den = 65535;
+    GST_LOG_OBJECT (ffmpegenc, "MPEG4 : scaled down framerate to %d / %d",
+        ffmpegenc->context->time_base.den, ffmpegenc->context->time_base.num);
+  }
+
+  pix_fmt = ffmpegenc->context->pix_fmt;
+
+  /* max-key-interval may need the framerate set above */
+  if (ffmpegenc->max_key_interval) {
+    AVCodecContext *ctx;
+
+    /* override gop-size */
+    ctx = ffmpegenc->context;
+    ctx->gop_size = (ffmpegenc->max_key_interval < 0) ?
+        (-ffmpegenc->max_key_interval
+        * (ctx->time_base.den * ctx->ticks_per_frame / ctx->time_base.num))
+        : ffmpegenc->max_key_interval;
+  }
+
+  /* open codec */
+  if (gst_ffmpeg_avcodec_open (ffmpegenc->context, oclass->in_plugin) < 0)
+    goto open_codec_fail;
+
+  /* second pass stats buffer no longer needed */
+  if (ffmpegenc->context->stats_in)
+    g_free (ffmpegenc->context->stats_in);
+
+  /* is the colourspace correct? */
+  if (pix_fmt != ffmpegenc->context->pix_fmt)
+    goto pix_fmt_err;
+
+  /* we may have failed mapping caps to a pixfmt,
+   * and quite some codecs do not make up their own mind about that
+   * in any case, _NONE can never work out later on */
+  if (pix_fmt == PIX_FMT_NONE)
+    goto bad_input_fmt;
+
+  /* some codecs support more than one format, first auto-choose one */
+  GST_DEBUG_OBJECT (ffmpegenc, "picking an output format ...");
+  allowed_caps = gst_pad_get_allowed_caps (GST_VIDEO_ENCODER_SRC_PAD (encoder));
+  if (!allowed_caps) {
+    GST_DEBUG_OBJECT (ffmpegenc, "... but no peer, using template caps");
+    /* we need to copy because get_allowed_caps returns a ref, and
+     * get_pad_template_caps doesn't */
+    allowed_caps =
+        gst_caps_copy (gst_pad_get_pad_template_caps (GST_VIDEO_ENCODER_SRC_PAD
+            (encoder)));
+  }
+  GST_DEBUG_OBJECT (ffmpegenc, "chose caps %" GST_PTR_FORMAT, allowed_caps);
+  gst_ffmpeg_caps_with_codecid (oclass->in_plugin->id,
+      oclass->in_plugin->type, allowed_caps, ffmpegenc->context);
+
+  /* try to set this caps on the other side */
+  other_caps = gst_ffmpeg_codecid_to_caps (oclass->in_plugin->id,
+      ffmpegenc->context, TRUE);
+
+  if (!other_caps)
+    goto unsupported_codec;
+
+  icaps = gst_caps_intersect (allowed_caps, other_caps);
+  gst_caps_unref (allowed_caps);
+  gst_caps_unref (other_caps);
+  if (gst_caps_is_empty (icaps)) {
+    gst_caps_unref (icaps);
+    return FALSE;
+  }
+
+  if (gst_caps_get_size (icaps) > 1) {
+    GstCaps *newcaps;
+
+    newcaps =
+        gst_caps_new_full (gst_structure_copy (gst_caps_get_structure (icaps,
+                0)), NULL);
+    gst_caps_unref (icaps);
+    icaps = newcaps;
+  }
+
+  /* Store input state and set output state */
+  if (ffmpegenc->input_state)
+    gst_video_codec_state_unref (ffmpegenc->input_state);
+  ffmpegenc->input_state = gst_video_codec_state_ref (state);
+
+  output_format = gst_video_encoder_set_output_state (encoder, icaps, state);
+  gst_video_codec_state_unref (output_format);
+
+  /* success! */
+  ffmpegenc->opened = TRUE;
+
+  return TRUE;
+
+  /* ERRORS */
+open_file_err:
+  {
+    GST_ELEMENT_ERROR (ffmpegenc, RESOURCE, OPEN_WRITE,
+        (("Could not open file \"%s\" for writing."), ffmpegenc->filename),
+        GST_ERROR_SYSTEM);
+    return FALSE;
+  }
+file_read_err:
+  {
+    GST_ELEMENT_ERROR (ffmpegenc, RESOURCE, READ,
+        (("Could not get contents of file \"%s\"."), ffmpegenc->filename),
+        GST_ERROR_SYSTEM);
+    return FALSE;
+  }
+
+open_codec_fail:
+  {
+    if (ffmpegenc->context->priv_data)
+      gst_ffmpeg_avcodec_close (ffmpegenc->context);
+    if (ffmpegenc->context->stats_in)
+      g_free (ffmpegenc->context->stats_in);
+    GST_DEBUG_OBJECT (ffmpegenc, "ffenc_%s: Failed to open FFMPEG codec",
+        oclass->in_plugin->name);
+    return FALSE;
+  }
+
+pix_fmt_err:
+  {
+    gst_ffmpeg_avcodec_close (ffmpegenc->context);
+    GST_DEBUG_OBJECT (ffmpegenc,
+        "ffenc_%s: AV wants different colourspace (%d given, %d wanted)",
+        oclass->in_plugin->name, pix_fmt, ffmpegenc->context->pix_fmt);
+    return FALSE;
+  }
+
+bad_input_fmt:
+  {
+    GST_DEBUG_OBJECT (ffmpegenc, "ffenc_%s: Failed to determine input format",
+        oclass->in_plugin->name);
+    return FALSE;
+  }
+
+unsupported_codec:
+  {
+    gst_ffmpeg_avcodec_close (ffmpegenc->context);
+    GST_DEBUG ("Unsupported codec - no caps found");
+    return FALSE;
+  }
+}
+
+static void
+ffmpegenc_setup_working_buf (GstFFMpegVidEnc * ffmpegenc)
+{
+  guint wanted_size =
+      ffmpegenc->context->width * ffmpegenc->context->height * 6 +
+      FF_MIN_BUFFER_SIZE;
+
+  /* Above is the buffer size used by ffmpeg/ffmpeg.c */
+
+  if (ffmpegenc->working_buf == NULL ||
+      ffmpegenc->working_buf_size != wanted_size) {
+    if (ffmpegenc->working_buf)
+      g_free (ffmpegenc->working_buf);
+    ffmpegenc->working_buf_size = wanted_size;
+    ffmpegenc->working_buf = g_malloc (ffmpegenc->working_buf_size);
+  }
+  ffmpegenc->buffer_size = wanted_size;
+}
+
+static GstFlowReturn
+gst_ffmpegvidenc_handle_frame (GstVideoEncoder * encoder,
+    GstVideoCodecFrame * frame)
+{
+  GstFFMpegVidEnc *ffmpegenc = (GstFFMpegVidEnc *) encoder;
+  GstBuffer *outbuf;
+  gint ret_size = 0, c;
+  GstVideoInfo *info = &ffmpegenc->input_state->info;
+  guint8 *data = GST_BUFFER_DATA (frame->input_buffer);
+
+  if (GST_VIDEO_CODEC_FRAME_IS_FORCE_KEYFRAME (frame))
+    ffmpegenc->picture->pict_type = FF_I_TYPE;
+
+  /* Fill avpicture */
+  for (c = 0; c < AV_NUM_DATA_POINTERS; c++) {
+    if (c < GST_VIDEO_INFO_N_COMPONENTS (info)) {
+      ffmpegenc->picture->data[c] = data + GST_VIDEO_INFO_COMP_OFFSET (info, c);
+      ffmpegenc->picture->linesize[c] = GST_VIDEO_INFO_COMP_STRIDE (info, c);
+    } else {
+      ffmpegenc->picture->data[c] = NULL;
+      ffmpegenc->picture->linesize[c] = 0;
+    }
+  }
+
+  ffmpegenc->picture->pts =
+      gst_ffmpeg_time_gst_to_ff (frame->pts /
+      ffmpegenc->context->ticks_per_frame, ffmpegenc->context->time_base);
+
+  ffmpegenc_setup_working_buf (ffmpegenc);
+
+  ret_size = avcodec_encode_video (ffmpegenc->context,
+      ffmpegenc->working_buf, ffmpegenc->working_buf_size, ffmpegenc->picture);
+
+  if (ret_size < 0)
+    goto encode_fail;
+
+  /* Encoder needs more data */
+  if (!ret_size)
+    return GST_FLOW_OK;
+
+  /* save stats info if there is some as well as a stats file */
+  if (ffmpegenc->file && ffmpegenc->context->stats_out)
+    if (fprintf (ffmpegenc->file, "%s", ffmpegenc->context->stats_out) < 0)
+      GST_ELEMENT_ERROR (ffmpegenc, RESOURCE, WRITE,
+          (("Could not write to file \"%s\"."), ffmpegenc->filename),
+          GST_ERROR_SYSTEM);
+
+  /* Get oldest frame */
+  frame = gst_video_encoder_get_oldest_frame (encoder);
+
+  /* Allocate output buffer */
+  frame->output_buffer = outbuf = gst_buffer_new_and_alloc (ret_size);
+  memcpy (GST_BUFFER_DATA (outbuf), ffmpegenc->working_buf, ret_size);
+
+  /* buggy codec may not set coded_frame */
+  if (ffmpegenc->context->coded_frame) {
+    if (ffmpegenc->context->coded_frame->key_frame)
+      GST_VIDEO_CODEC_FRAME_SET_SYNC_POINT (frame);
+  } else
+    GST_WARNING_OBJECT (ffmpegenc, "codec did not provide keyframe info");
+
+  /* Reset frame type */
+  if (ffmpegenc->picture->pict_type)
+    ffmpegenc->picture->pict_type = 0;
+
+  return gst_video_encoder_finish_frame (encoder, frame);
+
+  /* ERRORS */
+encode_fail:
+  {
+#ifndef GST_DISABLE_GST_DEBUG
+    GstFFMpegVidEncClass *oclass =
+        (GstFFMpegVidEncClass *) (G_OBJECT_GET_CLASS (ffmpegenc));
+    GST_ERROR_OBJECT (ffmpegenc,
+        "ffenc_%s: failed to encode buffer", oclass->in_plugin->name);
+#endif /* GST_DISABLE_GST_DEBUG */
+    return GST_FLOW_OK;
+  }
+}
+
+static void
+gst_ffmpegvidenc_flush_buffers (GstFFMpegVidEnc * ffmpegenc, gboolean send)
+{
+  GstVideoCodecFrame *frame;
+  GstBuffer *outbuf;
+  gint ret_size;
+
+  GST_DEBUG_OBJECT (ffmpegenc, "flushing buffers with sending %d", send);
+
+  /* no need to empty codec if there is none */
+  if (!ffmpegenc->opened)
+    return;
+
+  while ((frame =
+          gst_video_encoder_get_oldest_frame (GST_VIDEO_ENCODER (ffmpegenc)))) {
+
+    ffmpegenc_setup_working_buf (ffmpegenc);
+
+    ret_size = avcodec_encode_video (ffmpegenc->context,
+        ffmpegenc->working_buf, ffmpegenc->working_buf_size, NULL);
+
+    if (ret_size < 0) {         /* there should be something, notify and give up */
+#ifndef GST_DISABLE_GST_DEBUG
+      GstFFMpegVidEncClass *oclass =
+          (GstFFMpegVidEncClass *) (G_OBJECT_GET_CLASS (ffmpegenc));
+      GST_WARNING_OBJECT (ffmpegenc,
+          "ffenc_%s: failed to flush buffer", oclass->in_plugin->name);
+#endif /* GST_DISABLE_GST_DEBUG */
+      break;
+    }
+
+    /* save stats info if there is some as well as a stats file */
+    if (ffmpegenc->file && ffmpegenc->context->stats_out)
+      if (fprintf (ffmpegenc->file, "%s", ffmpegenc->context->stats_out) < 0)
+        GST_ELEMENT_ERROR (ffmpegenc, RESOURCE, WRITE,
+            (("Could not write to file \"%s\"."), ffmpegenc->filename),
+            GST_ERROR_SYSTEM);
+
+    frame->output_buffer = outbuf = gst_buffer_new_and_alloc (ret_size);
+    memcpy (GST_BUFFER_DATA (outbuf), ffmpegenc->working_buf, ret_size);
+
+    if (ffmpegenc->context->coded_frame->key_frame)
+      GST_VIDEO_CODEC_FRAME_SET_SYNC_POINT (frame);
+
+    gst_video_encoder_finish_frame (GST_VIDEO_ENCODER (ffmpegenc), frame);
+  }
+}
+
+
+static void
+gst_ffmpegvidenc_set_property (GObject * object,
+    guint prop_id, const GValue * value, GParamSpec * pspec)
+{
+  GstFFMpegVidEnc *ffmpegenc;
+
+  /* Get a pointer of the right type. */
+  ffmpegenc = (GstFFMpegVidEnc *) (object);
+
+  if (ffmpegenc->opened) {
+    GST_WARNING_OBJECT (ffmpegenc,
+        "Can't change properties once decoder is setup !");
+    return;
+  }
+
+  /* Check the argument id to see which argument we're setting. */
+  switch (prop_id) {
+    case ARG_BIT_RATE:
+      ffmpegenc->bitrate = g_value_get_ulong (value);
+      break;
+    case ARG_GOP_SIZE:
+      ffmpegenc->gop_size = g_value_get_int (value);
+      break;
+    case ARG_ME_METHOD:
+      ffmpegenc->me_method = g_value_get_enum (value);
+      break;
+    case ARG_BUFSIZE:
+      break;
+    case ARG_RTP_PAYLOAD_SIZE:
+      ffmpegenc->rtp_payload_size = g_value_get_ulong (value);
+      break;
+    default:
+      if (!gst_ffmpeg_cfg_set_property (object, value, pspec))
+        G_OBJECT_WARN_INVALID_PROPERTY_ID (object, prop_id, pspec);
+      break;
+  }
+}
+
+/* The set function is simply the inverse of the get fuction. */
+static void
+gst_ffmpegvidenc_get_property (GObject * object,
+    guint prop_id, GValue * value, GParamSpec * pspec)
+{
+  GstFFMpegVidEnc *ffmpegenc;
+
+  /* It's not null if we got it, but it might not be ours */
+  ffmpegenc = (GstFFMpegVidEnc *) (object);
+
+  switch (prop_id) {
+    case ARG_BIT_RATE:
+      g_value_set_ulong (value, ffmpegenc->bitrate);
+      break;
+    case ARG_GOP_SIZE:
+      g_value_set_int (value, ffmpegenc->gop_size);
+      break;
+    case ARG_ME_METHOD:
+      g_value_set_enum (value, ffmpegenc->me_method);
+      break;
+    case ARG_BUFSIZE:
+      g_value_set_ulong (value, ffmpegenc->buffer_size);
+      break;
+    case ARG_RTP_PAYLOAD_SIZE:
+      g_value_set_ulong (value, ffmpegenc->rtp_payload_size);
+      break;
+    default:
+      if (!gst_ffmpeg_cfg_get_property (object, value, pspec))
+        G_OBJECT_WARN_INVALID_PROPERTY_ID (object, prop_id, pspec);
+      break;
+  }
+}
+
+static gboolean
+gst_ffmpegvidenc_stop (GstVideoEncoder * encoder)
+{
+  GstFFMpegVidEnc *ffmpegenc = (GstFFMpegVidEnc *) encoder;
+
+  gst_ffmpegvidenc_flush_buffers (ffmpegenc, FALSE);
+  if (ffmpegenc->opened) {
+    gst_ffmpeg_avcodec_close (ffmpegenc->context);
+    ffmpegenc->opened = FALSE;
+  }
+  if (ffmpegenc->file) {
+    fclose (ffmpegenc->file);
+    ffmpegenc->file = NULL;
+  }
+  if (ffmpegenc->working_buf) {
+    g_free (ffmpegenc->working_buf);
+    ffmpegenc->working_buf = NULL;
+  }
+
+  return TRUE;
+}
+
+static GstFlowReturn
+gst_ffmpegvidenc_finish (GstVideoEncoder * encoder)
+{
+  GstFFMpegVidEnc *ffmpegenc = (GstFFMpegVidEnc *) encoder;
+
+  gst_ffmpegvidenc_flush_buffers (ffmpegenc, TRUE);
+
+  return GST_FLOW_OK;
+}
+
+gboolean
+gst_ffmpegvidenc_register (GstPlugin * plugin)
+{
+  GTypeInfo typeinfo = {
+    sizeof (GstFFMpegVidEncClass),
+    (GBaseInitFunc) gst_ffmpegvidenc_base_init,
+    NULL,
+    (GClassInitFunc) gst_ffmpegvidenc_class_init,
+    NULL,
+    NULL,
+    sizeof (GstFFMpegVidEnc),
+    0,
+    (GInstanceInitFunc) gst_ffmpegvidenc_init,
+  };
+  GType type;
+  AVCodec *in_plugin;
+
+
+  GST_LOG ("Registering encoders");
+
+  /* build global ffmpeg param/property info */
+  gst_ffmpeg_cfg_init ();
+
+  in_plugin = av_codec_next (NULL);
+  while (in_plugin) {
+    gchar *type_name;
+
+    /* Skip non-AV codecs */
+    if (in_plugin->type != AVMEDIA_TYPE_VIDEO)
+      goto next;
+
+    /* no quasi codecs, please */
+    if (in_plugin->id == CODEC_ID_RAWVIDEO ||
+        in_plugin->id == CODEC_ID_V210 ||
+        in_plugin->id == CODEC_ID_V210X ||
+        in_plugin->id == CODEC_ID_R210 ||
+        in_plugin->id == CODEC_ID_ZLIB ||
+        (in_plugin->id >= CODEC_ID_PCM_S16LE &&
+            in_plugin->id <= CODEC_ID_PCM_BLURAY)) {
+      goto next;
+    }
+
+    /* No encoders depending on external libraries (we don't build them, but
+     * people who build against an external ffmpeg might have them.
+     * We have native gstreamer plugins for all of those libraries anyway. */
+    if (!strncmp (in_plugin->name, "lib", 3)) {
+      GST_DEBUG
+          ("Not using external library encoder %s. Use the gstreamer-native ones instead.",
+          in_plugin->name);
+      goto next;
+    }
+
+    /* only encoders */
+    if (!in_plugin->encode) {
+      goto next;
+    }
+
+    /* FIXME : We should have a method to know cheaply whether we have a mapping
+     * for the given plugin or not */
+
+    GST_DEBUG ("Trying plugin %s [%s]", in_plugin->name, in_plugin->long_name);
+
+    /* no codecs for which we're GUARANTEED to have better alternatives */
+    if (!strcmp (in_plugin->name, "gif")) {
+      GST_LOG ("Ignoring encoder %s", in_plugin->name);
+      goto next;
+    }
+
+    /* construct the type */
+    type_name = g_strdup_printf ("ffenc_%s", in_plugin->name);
+
+    type = g_type_from_name (type_name);
+
+    if (!type) {
+
+      /* create the glib type now */
+      type =
+          g_type_register_static (GST_TYPE_VIDEO_ENCODER, type_name, &typeinfo,
+          0);
+      g_type_set_qdata (type, GST_FFENC_PARAMS_QDATA, (gpointer) in_plugin);
+
+      {
+        static const GInterfaceInfo preset_info = {
+          NULL,
+          NULL,
+          NULL
+        };
+        g_type_add_interface_static (type, GST_TYPE_PRESET, &preset_info);
+      }
+    }
+
+    if (!gst_element_register (plugin, type_name, GST_RANK_SECONDARY, type)) {
+      g_free (type_name);
+      return FALSE;
+    }
+
+    g_free (type_name);
+
+  next:
+    in_plugin = av_codec_next (in_plugin);
+  }
+
+  GST_LOG ("Finished registering encoders");
+
+  return TRUE;
+}
diff --git a/ext/ffmpeg/gstffmpegvidenc.h b/ext/ffmpeg/gstffmpegvidenc.h
new file mode 100644
index 0000000..1816623
--- /dev/null
+++ b/ext/ffmpeg/gstffmpegvidenc.h
@@ -0,0 +1,95 @@
+/* GStreamer
+ * Copyright (C) <1999> Erik Walthinsen <omega@cse.ogi.edu>
+ *
+ * This library is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU Library General Public
+ * License as published by the Free Software Foundation; either
+ * version 2 of the License, or (at your option) any later version.
+ *
+ * This library is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+ * Library General Public License for more details.
+ *
+ * You should have received a copy of the GNU Library General Public
+ * License along with this library; if not, write to the
+ * Free Software Foundation, Inc., 59 Temple Place - Suite 330,
+ * Boston, MA 02111-1307, USA.
+ */
+
+/* First, include the header file for the plugin, to bring in the
+ * object definition and other useful things.
+ */
+
+#ifndef __GST_FFMPEGVIDENC_H__
+#define __GST_FFMPEGVIDENC_H__
+
+G_BEGIN_DECLS
+
+#include <gst/video/gstvideoencoder.h>
+
+typedef struct _GstFFMpegVidEnc GstFFMpegVidEnc;
+
+struct _GstFFMpegVidEnc
+{
+  GstVideoEncoder parent;
+
+  GstVideoCodecState *input_state;
+
+  AVCodecContext *context;
+  AVFrame *picture;
+  gboolean opened;
+  gboolean discont;
+
+  /* cache */
+  gulong bitrate;
+  gint me_method;
+  gint gop_size;
+  gulong buffer_size;
+  gulong rtp_payload_size;
+
+  guint8 *working_buf;
+  gulong working_buf_size;
+
+  /* settings with some special handling */
+  guint pass;
+  gfloat quantizer;
+  gchar *filename;
+  guint lmin;
+  guint lmax;
+  gint max_key_interval;
+  gboolean interlaced;
+
+  /* statistics file */
+  FILE *file;
+
+  /* other settings are copied over straight,
+   * include a context here, rather than copy-and-past it from avcodec.h */
+  AVCodecContext config;
+};
+
+typedef struct _GstFFMpegVidEncClass GstFFMpegVidEncClass;
+
+struct _GstFFMpegVidEncClass
+{
+  GstVideoEncoderClass parent_class;
+
+  AVCodec *in_plugin;
+  GstPadTemplate *srctempl, *sinktempl;
+  GstCaps *sinkcaps;
+};
+
+#define GST_TYPE_FFMPEGVIDENC \
+  (gst_ffmpegvidenc_get_type())
+#define GST_FFMPEGVIDENC(obj) \
+  (G_TYPE_CHECK_INSTANCE_CAST((obj),GST_TYPE_FFMPEGVIDENC,GstFFMpegVidEnc))
+#define GST_FFMPEGVIDENC_CLASS(klass) \
+  (G_TYPE_CHECK_CLASS_CAST((klass),GST_TYPE_FFMPEGVIDENC,GstFFMpegVidEncClass))
+#define GST_IS_FFMPEGVIDENC(obj) \
+  (G_TYPE_CHECK_INSTANCE_TYPE((obj),GST_TYPE_FFMPEGVIDENC))
+#define GST_IS_FFMPEGVIDENC_CLASS(klass) \
+  (G_TYPE_CHECK_CLASS_TYPE((klass),GST_TYPE_FFMPEGVIDENC))
+
+G_END_DECLS
+
+#endif /* __GST_FFMPEGVIDENC_H__ */
diff --git a/ext/libpostproc/Makefile.in b/ext/libpostproc/Makefile.in
index 58557c4..8725522 100644
--- a/ext/libpostproc/Makefile.in
+++ b/ext/libpostproc/Makefile.in
@@ -1,9 +1,8 @@
-# Makefile.in generated by automake 1.11.1 from Makefile.am.
+# Makefile.in generated by automake 1.12.6 from Makefile.am.
 # @configure_input@
 
-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
-# Inc.
+# Copyright (C) 1994-2012 Free Software Foundation, Inc.
+
 # This Makefile.in is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
@@ -16,6 +15,23 @@
 @SET_MAKE@
 
 VPATH = @srcdir@
+am__make_dryrun = \
+  { \
+    am__dry=no; \
+    case $$MAKEFLAGS in \
+      *\\[\ \	]*) \
+        echo 'am--echo: ; @echo "AM"  OK' | $(MAKE) -f - 2>/dev/null \
+          | grep '^AM OK$$' >/dev/null || am__dry=yes;; \
+      *) \
+        for am__flg in $$MAKEFLAGS; do \
+          case $$am__flg in \
+            *=*|--*) ;; \
+            *n*) am__dry=yes; break;; \
+          esac; \
+        done;; \
+    esac; \
+    test $$am__dry = yes; \
+  }
 pkgdatadir = $(datadir)/@PACKAGE@
 pkgincludedir = $(includedir)/@PACKAGE@
 pkglibdir = $(libdir)/@PACKAGE@
@@ -34,8 +50,10 @@ PRE_UNINSTALL = :
 POST_UNINSTALL = :
 build_triplet = @build@
 host_triplet = @host@
+target_triplet = @target@
 subdir = ext/libpostproc
-DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
+DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in \
+	$(top_srcdir)/depcomp
 ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
 am__aclocal_m4_deps = $(top_srcdir)/common/m4/as-ac-expand.m4 \
 	$(top_srcdir)/common/m4/as-auto-alt.m4 \
@@ -85,6 +103,12 @@ am__nobase_list = $(am__nobase_strip_setup); \
 am__base_list = \
   sed '$$!N;$$!N;$$!N;$$!N;$$!N;$$!N;$$!N;s/\n/ /g' | \
   sed '$$!N;$$!N;$$!N;$$!N;s/\n/ /g'
+am__uninstall_files_from_dir = { \
+  test -z "$$files" \
+    || { test ! -d "$$dir" && test ! -f "$$dir" && test ! -r "$$dir"; } \
+    || { echo " ( cd '$$dir' && rm -f" $$files ")"; \
+         $(am__cd) "$$dir" && rm -f $$files; }; \
+  }
 am__installdirs = "$(DESTDIR)$(plugindir)"
 LTLIBRARIES = $(plugin_LTLIBRARIES)
 am__DEPENDENCIES_1 =
@@ -93,13 +117,26 @@ libgstpostproc_la_DEPENDENCIES = $(am__DEPENDENCIES_1) \
 	$(am__DEPENDENCIES_1)
 am_libgstpostproc_la_OBJECTS = libgstpostproc_la-gstpostproc.lo
 libgstpostproc_la_OBJECTS = $(am_libgstpostproc_la_OBJECTS)
-AM_V_lt = $(am__v_lt_$(V))
-am__v_lt_ = $(am__v_lt_$(AM_DEFAULT_VERBOSITY))
+AM_V_lt = $(am__v_lt_@AM_V@)
+am__v_lt_ = $(am__v_lt_@AM_DEFAULT_V@)
 am__v_lt_0 = --silent
+am__v_lt_1 = 
 libgstpostproc_la_LINK = $(LIBTOOL) $(AM_V_lt) --tag=CC \
 	$(libgstpostproc_la_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=link \
 	$(CCLD) $(libgstpostproc_la_CFLAGS) $(CFLAGS) \
 	$(libgstpostproc_la_LDFLAGS) $(LDFLAGS) -o $@
+AM_V_P = $(am__v_P_@AM_V@)
+am__v_P_ = $(am__v_P_@AM_DEFAULT_V@)
+am__v_P_0 = false
+am__v_P_1 = :
+AM_V_GEN = $(am__v_GEN_@AM_V@)
+am__v_GEN_ = $(am__v_GEN_@AM_DEFAULT_V@)
+am__v_GEN_0 = @echo "  GEN     " $@;
+am__v_GEN_1 = 
+AM_V_at = $(am__v_at_@AM_V@)
+am__v_at_ = $(am__v_at_@AM_DEFAULT_V@)
+am__v_at_0 = @
+am__v_at_1 = 
 DEFAULT_INCLUDES = -I.@am__isrc@ -I$(top_builddir)
 depcomp = $(SHELL) $(top_srcdir)/depcomp
 am__depfiles_maybe = depfiles
@@ -110,24 +147,25 @@ LTCOMPILE = $(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) \
 	$(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) \
 	$(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) \
 	$(AM_CFLAGS) $(CFLAGS)
-AM_V_CC = $(am__v_CC_$(V))
-am__v_CC_ = $(am__v_CC_$(AM_DEFAULT_VERBOSITY))
-am__v_CC_0 = @echo "  CC    " $@;
-AM_V_at = $(am__v_at_$(V))
-am__v_at_ = $(am__v_at_$(AM_DEFAULT_VERBOSITY))
-am__v_at_0 = @
+AM_V_CC = $(am__v_CC_@AM_V@)
+am__v_CC_ = $(am__v_CC_@AM_DEFAULT_V@)
+am__v_CC_0 = @echo "  CC      " $@;
+am__v_CC_1 = 
 CCLD = $(CC)
 LINK = $(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) \
 	$(LIBTOOLFLAGS) --mode=link $(CCLD) $(AM_CFLAGS) $(CFLAGS) \
 	$(AM_LDFLAGS) $(LDFLAGS) -o $@
-AM_V_CCLD = $(am__v_CCLD_$(V))
-am__v_CCLD_ = $(am__v_CCLD_$(AM_DEFAULT_VERBOSITY))
-am__v_CCLD_0 = @echo "  CCLD  " $@;
-AM_V_GEN = $(am__v_GEN_$(V))
-am__v_GEN_ = $(am__v_GEN_$(AM_DEFAULT_VERBOSITY))
-am__v_GEN_0 = @echo "  GEN   " $@;
+AM_V_CCLD = $(am__v_CCLD_@AM_V@)
+am__v_CCLD_ = $(am__v_CCLD_@AM_DEFAULT_V@)
+am__v_CCLD_0 = @echo "  CCLD    " $@;
+am__v_CCLD_1 = 
 SOURCES = $(libgstpostproc_la_SOURCES)
 DIST_SOURCES = $(libgstpostproc_la_SOURCES)
+am__can_run_installinfo = \
+  case $$AM_UPDATE_INFO_DIR in \
+    n|no|NO) false;; \
+    *) (install-info --version) >/dev/null 2>&1;; \
+  esac
 ETAGS = etags
 CTAGS = ctags
 DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
@@ -324,7 +362,11 @@ sbindir = @sbindir@
 sharedstatedir = @sharedstatedir@
 srcdir = @srcdir@
 sysconfdir = @sysconfdir@
+target = @target@
 target_alias = @target_alias@
+target_cpu = @target_cpu@
+target_os = @target_os@
+target_vendor = @target_vendor@
 top_build_prefix = @top_build_prefix@
 top_builddir = @top_builddir@
 top_srcdir = @top_srcdir@
@@ -373,7 +415,6 @@ $(ACLOCAL_M4): @MAINTAINER_MODE_TRUE@ $(am__aclocal_m4_deps)
 $(am__aclocal_m4_deps):
 install-pluginLTLIBRARIES: $(plugin_LTLIBRARIES)
 	@$(NORMAL_INSTALL)
-	test -z "$(plugindir)" || $(MKDIR_P) "$(DESTDIR)$(plugindir)"
 	@list='$(plugin_LTLIBRARIES)'; test -n "$(plugindir)" || list=; \
 	list2=; for p in $$list; do \
 	  if test -f $$p; then \
@@ -381,6 +422,8 @@ install-pluginLTLIBRARIES: $(plugin_LTLIBRARIES)
 	  else :; fi; \
 	done; \
 	test -z "$$list2" || { \
+	  echo " $(MKDIR_P) '$(DESTDIR)$(plugindir)'"; \
+	  $(MKDIR_P) "$(DESTDIR)$(plugindir)" || exit 1; \
 	  echo " $(LIBTOOL) $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=install $(INSTALL) $(INSTALL_STRIP_FLAG) $$list2 '$(DESTDIR)$(plugindir)'"; \
 	  $(LIBTOOL) $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=install $(INSTALL) $(INSTALL_STRIP_FLAG) $$list2 "$(DESTDIR)$(plugindir)"; \
 	}
@@ -396,13 +439,15 @@ uninstall-pluginLTLIBRARIES:
 
 clean-pluginLTLIBRARIES:
 	-test -z "$(plugin_LTLIBRARIES)" || rm -f $(plugin_LTLIBRARIES)
-	@list='$(plugin_LTLIBRARIES)'; for p in $$list; do \
-	  dir="`echo $$p | sed -e 's|/[^/]*$$||'`"; \
-	  test "$$dir" != "$$p" || dir=.; \
-	  echo "rm -f \"$${dir}/so_locations\""; \
-	  rm -f "$${dir}/so_locations"; \
-	done
-libgstpostproc.la: $(libgstpostproc_la_OBJECTS) $(libgstpostproc_la_DEPENDENCIES) 
+	@list='$(plugin_LTLIBRARIES)'; \
+	locs=`for p in $$list; do echo $$p; done | \
+	      sed 's|^[^/]*$$|.|; s|/[^/]*$$||; s|$$|/so_locations|' | \
+	      sort -u`; \
+	test -z "$$locs" || { \
+	  echo rm -f $${locs}; \
+	  rm -f $${locs}; \
+	}
+libgstpostproc.la: $(libgstpostproc_la_OBJECTS) $(libgstpostproc_la_DEPENDENCIES) $(EXTRA_libgstpostproc_la_DEPENDENCIES) 
 	$(AM_V_CCLD)$(libgstpostproc_la_LINK) -rpath $(plugindir) $(libgstpostproc_la_OBJECTS) $(libgstpostproc_la_LIBADD) $(LIBS)
 
 mostlyclean-compile:
@@ -416,34 +461,30 @@ distclean-compile:
 .c.o:
 @am__fastdepCC_TRUE@	$(AM_V_CC)$(COMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
 @am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
-@am__fastdepCC_FALSE@	$(AM_V_CC) @AM_BACKSLASH@
-@AMDEP_TRUE@@am__fastdepCC_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(COMPILE) -c $<
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(COMPILE) -c $<
 
 .c.obj:
 @am__fastdepCC_TRUE@	$(AM_V_CC)$(COMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ `$(CYGPATH_W) '$<'`
 @am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
-@am__fastdepCC_FALSE@	$(AM_V_CC) @AM_BACKSLASH@
-@AMDEP_TRUE@@am__fastdepCC_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(COMPILE) -c `$(CYGPATH_W) '$<'`
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(COMPILE) -c `$(CYGPATH_W) '$<'`
 
 .c.lo:
 @am__fastdepCC_TRUE@	$(AM_V_CC)$(LTCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
 @am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Plo
-@am__fastdepCC_FALSE@	$(AM_V_CC) @AM_BACKSLASH@
-@AMDEP_TRUE@@am__fastdepCC_FALSE@	source='$<' object='$@' libtool=yes @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='$<' object='$@' libtool=yes @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(LTCOMPILE) -c -o $@ $<
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(LTCOMPILE) -c -o $@ $<
 
 libgstpostproc_la-gstpostproc.lo: gstpostproc.c
 @am__fastdepCC_TRUE@	$(AM_V_CC)$(LIBTOOL) $(AM_V_lt) --tag=CC $(libgstpostproc_la_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libgstpostproc_la_CFLAGS) $(CFLAGS) -MT libgstpostproc_la-gstpostproc.lo -MD -MP -MF $(DEPDIR)/libgstpostproc_la-gstpostproc.Tpo -c -o libgstpostproc_la-gstpostproc.lo `test -f 'gstpostproc.c' || echo '$(srcdir)/'`gstpostproc.c
 @am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/libgstpostproc_la-gstpostproc.Tpo $(DEPDIR)/libgstpostproc_la-gstpostproc.Plo
-@am__fastdepCC_FALSE@	$(AM_V_CC) @AM_BACKSLASH@
-@AMDEP_TRUE@@am__fastdepCC_FALSE@	source='gstpostproc.c' object='libgstpostproc_la-gstpostproc.lo' libtool=yes @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='gstpostproc.c' object='libgstpostproc_la-gstpostproc.lo' libtool=yes @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(LIBTOOL) $(AM_V_lt) --tag=CC $(libgstpostproc_la_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libgstpostproc_la_CFLAGS) $(CFLAGS) -c -o libgstpostproc_la-gstpostproc.lo `test -f 'gstpostproc.c' || echo '$(srcdir)/'`gstpostproc.c
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(LIBTOOL) $(AM_V_lt) --tag=CC $(libgstpostproc_la_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libgstpostproc_la_CFLAGS) $(CFLAGS) -c -o libgstpostproc_la-gstpostproc.lo `test -f 'gstpostproc.c' || echo '$(srcdir)/'`gstpostproc.c
 
 mostlyclean-libtool:
 	-rm -f *.lo
@@ -500,6 +541,20 @@ GTAGS:
 	  && $(am__cd) $(top_srcdir) \
 	  && gtags -i $(GTAGS_ARGS) "$$here"
 
+cscopelist:  $(HEADERS) $(SOURCES) $(LISP)
+	list='$(SOURCES) $(HEADERS) $(LISP)'; \
+	case "$(srcdir)" in \
+	  [\\/]* | ?:[\\/]*) sdir="$(srcdir)" ;; \
+	  *) sdir=$(subdir)/$(srcdir) ;; \
+	esac; \
+	for i in $$list; do \
+	  if test -f "$$i"; then \
+	    echo "$(subdir)/$$i"; \
+	  else \
+	    echo "$$sdir/$$i"; \
+	  fi; \
+	done >> $(top_builddir)/cscope.files
+
 distclean-tags:
 	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
 
@@ -550,10 +605,15 @@ install-am: all-am
 
 installcheck: installcheck-am
 install-strip:
-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
-	  `test -z '$(STRIP)' || \
-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+	if test -z '$(STRIP)'; then \
+	  $(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+	    install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+	      install; \
+	else \
+	  $(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+	    install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+	    "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'" install; \
+	fi
 mostlyclean-generic:
 
 clean-generic:
@@ -639,18 +699,19 @@ uninstall-am: uninstall-pluginLTLIBRARIES
 .MAKE: install-am install-strip
 
 .PHONY: CTAGS GTAGS all all-am check check-am clean clean-generic \
-	clean-libtool clean-pluginLTLIBRARIES ctags distclean \
-	distclean-compile distclean-generic distclean-libtool \
-	distclean-tags distdir dvi dvi-am html html-am info info-am \
-	install install-am install-data install-data-am install-dvi \
-	install-dvi-am install-exec install-exec-am install-html \
-	install-html-am install-info install-info-am install-man \
-	install-pdf install-pdf-am install-pluginLTLIBRARIES \
-	install-ps install-ps-am install-strip installcheck \
-	installcheck-am installdirs maintainer-clean \
-	maintainer-clean-generic mostlyclean mostlyclean-compile \
-	mostlyclean-generic mostlyclean-libtool pdf pdf-am ps ps-am \
-	tags uninstall uninstall-am uninstall-pluginLTLIBRARIES
+	clean-libtool clean-pluginLTLIBRARIES cscopelist ctags \
+	distclean distclean-compile distclean-generic \
+	distclean-libtool distclean-tags distdir dvi dvi-am html \
+	html-am info info-am install install-am install-data \
+	install-data-am install-dvi install-dvi-am install-exec \
+	install-exec-am install-html install-html-am install-info \
+	install-info-am install-man install-pdf install-pdf-am \
+	install-pluginLTLIBRARIES install-ps install-ps-am \
+	install-strip installcheck installcheck-am installdirs \
+	maintainer-clean maintainer-clean-generic mostlyclean \
+	mostlyclean-compile mostlyclean-generic mostlyclean-libtool \
+	pdf pdf-am ps ps-am tags uninstall uninstall-am \
+	uninstall-pluginLTLIBRARIES
 
 
 # Tell versions [3.59,3.63) of GNU make to not export all variables.
diff --git a/ext/libpostproc/gstpostproc.c b/ext/libpostproc/gstpostproc.c
index f9ddcdd..41ff8b7 100644
--- a/ext/libpostproc/gstpostproc.c
+++ b/ext/libpostproc/gstpostproc.c
@@ -281,8 +281,10 @@ gst_ffmpeg_log_callback (void *ptr, int level, const char *fmt, va_list vl)
 static void
 change_context (GstPostProc * postproc, gint width, gint height)
 {
+#ifdef HAVE_ORC
   guint mmx_flags;
   guint altivec_flags;
+#endif
   gint ppflags;
 
   GST_DEBUG_OBJECT (postproc, "change_context, width:%d, height:%d",
@@ -302,8 +304,6 @@ change_context (GstPostProc * postproc, gint width, gint height)
         | (altivec_flags & ORC_TARGET_ALTIVEC_ALTIVEC ? PP_CPU_CAPS_ALTIVEC :
         0);
 #else
-    mmx_flags = 0;
-    altivec_flags = 0;
     ppflags = 0;
 #endif
 
@@ -381,10 +381,10 @@ gst_post_proc_base_init (GstPostProcClass * klass)
   g_free (longname);
   g_free (description);
 
-  gst_element_class_add_pad_template (element_class,
-      gst_static_pad_template_get (&gst_post_proc_src_template));
-  gst_element_class_add_pad_template (element_class,
-      gst_static_pad_template_get (&gst_post_proc_sink_template));
+  gst_element_class_add_static_pad_template (element_class,
+      &gst_post_proc_src_template);
+  gst_element_class_add_static_pad_template (element_class,
+      &gst_post_proc_sink_template);
 
   klass->filterid = ppidx;
 }
diff --git a/ext/libswscale/Makefile.in b/ext/libswscale/Makefile.in
index 46bd64e..13d2500 100644
--- a/ext/libswscale/Makefile.in
+++ b/ext/libswscale/Makefile.in
@@ -1,9 +1,8 @@
-# Makefile.in generated by automake 1.11.1 from Makefile.am.
+# Makefile.in generated by automake 1.12.6 from Makefile.am.
 # @configure_input@
 
-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
-# Inc.
+# Copyright (C) 1994-2012 Free Software Foundation, Inc.
+
 # This Makefile.in is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
@@ -16,6 +15,23 @@
 @SET_MAKE@
 
 VPATH = @srcdir@
+am__make_dryrun = \
+  { \
+    am__dry=no; \
+    case $$MAKEFLAGS in \
+      *\\[\ \	]*) \
+        echo 'am--echo: ; @echo "AM"  OK' | $(MAKE) -f - 2>/dev/null \
+          | grep '^AM OK$$' >/dev/null || am__dry=yes;; \
+      *) \
+        for am__flg in $$MAKEFLAGS; do \
+          case $$am__flg in \
+            *=*|--*) ;; \
+            *n*) am__dry=yes; break;; \
+          esac; \
+        done;; \
+    esac; \
+    test $$am__dry = yes; \
+  }
 pkgdatadir = $(datadir)/@PACKAGE@
 pkgincludedir = $(includedir)/@PACKAGE@
 pkglibdir = $(libdir)/@PACKAGE@
@@ -34,6 +50,7 @@ PRE_UNINSTALL = :
 POST_UNINSTALL = :
 build_triplet = @build@
 host_triplet = @host@
+target_triplet = @target@
 @HAVE_FFMPEG_UNINSTALLED_FALSE@libgstffmpegscale_la_DEPENDENCIES =  \
 @HAVE_FFMPEG_UNINSTALLED_FALSE@	$(am__DEPENDENCIES_1) \
 @HAVE_FFMPEG_UNINSTALLED_FALSE@	$(am__DEPENDENCIES_1) \
@@ -41,7 +58,8 @@ host_triplet = @host@
 @HAVE_FFMPEG_UNINSTALLED_FALSE@	$(am__DEPENDENCIES_1) \
 @HAVE_FFMPEG_UNINSTALLED_FALSE@	$(am__DEPENDENCIES_1)
 subdir = ext/libswscale
-DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
+DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in \
+	$(top_srcdir)/depcomp
 ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
 am__aclocal_m4_deps = $(top_srcdir)/common/m4/as-ac-expand.m4 \
 	$(top_srcdir)/common/m4/as-auto-alt.m4 \
@@ -91,19 +109,38 @@ am__nobase_list = $(am__nobase_strip_setup); \
 am__base_list = \
   sed '$$!N;$$!N;$$!N;$$!N;$$!N;$$!N;$$!N;s/\n/ /g' | \
   sed '$$!N;$$!N;$$!N;$$!N;s/\n/ /g'
+am__uninstall_files_from_dir = { \
+  test -z "$$files" \
+    || { test ! -d "$$dir" && test ! -f "$$dir" && test ! -r "$$dir"; } \
+    || { echo " ( cd '$$dir' && rm -f" $$files ")"; \
+         $(am__cd) "$$dir" && rm -f $$files; }; \
+  }
 am__installdirs = "$(DESTDIR)$(plugindir)"
 LTLIBRARIES = $(plugin_LTLIBRARIES)
 am__DEPENDENCIES_1 =
 am_libgstffmpegscale_la_OBJECTS =  \
 	libgstffmpegscale_la-gstffmpegscale.lo
 libgstffmpegscale_la_OBJECTS = $(am_libgstffmpegscale_la_OBJECTS)
-AM_V_lt = $(am__v_lt_$(V))
-am__v_lt_ = $(am__v_lt_$(AM_DEFAULT_VERBOSITY))
+AM_V_lt = $(am__v_lt_@AM_V@)
+am__v_lt_ = $(am__v_lt_@AM_DEFAULT_V@)
 am__v_lt_0 = --silent
+am__v_lt_1 = 
 libgstffmpegscale_la_LINK = $(LIBTOOL) $(AM_V_lt) --tag=CC \
 	$(libgstffmpegscale_la_LIBTOOLFLAGS) $(LIBTOOLFLAGS) \
 	--mode=link $(CCLD) $(libgstffmpegscale_la_CFLAGS) $(CFLAGS) \
 	$(libgstffmpegscale_la_LDFLAGS) $(LDFLAGS) -o $@
+AM_V_P = $(am__v_P_@AM_V@)
+am__v_P_ = $(am__v_P_@AM_DEFAULT_V@)
+am__v_P_0 = false
+am__v_P_1 = :
+AM_V_GEN = $(am__v_GEN_@AM_V@)
+am__v_GEN_ = $(am__v_GEN_@AM_DEFAULT_V@)
+am__v_GEN_0 = @echo "  GEN     " $@;
+am__v_GEN_1 = 
+AM_V_at = $(am__v_at_@AM_V@)
+am__v_at_ = $(am__v_at_@AM_DEFAULT_V@)
+am__v_at_0 = @
+am__v_at_1 = 
 DEFAULT_INCLUDES = -I.@am__isrc@ -I$(top_builddir)
 depcomp = $(SHELL) $(top_srcdir)/depcomp
 am__depfiles_maybe = depfiles
@@ -114,24 +151,25 @@ LTCOMPILE = $(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) \
 	$(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) \
 	$(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) \
 	$(AM_CFLAGS) $(CFLAGS)
-AM_V_CC = $(am__v_CC_$(V))
-am__v_CC_ = $(am__v_CC_$(AM_DEFAULT_VERBOSITY))
-am__v_CC_0 = @echo "  CC    " $@;
-AM_V_at = $(am__v_at_$(V))
-am__v_at_ = $(am__v_at_$(AM_DEFAULT_VERBOSITY))
-am__v_at_0 = @
+AM_V_CC = $(am__v_CC_@AM_V@)
+am__v_CC_ = $(am__v_CC_@AM_DEFAULT_V@)
+am__v_CC_0 = @echo "  CC      " $@;
+am__v_CC_1 = 
 CCLD = $(CC)
 LINK = $(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) \
 	$(LIBTOOLFLAGS) --mode=link $(CCLD) $(AM_CFLAGS) $(CFLAGS) \
 	$(AM_LDFLAGS) $(LDFLAGS) -o $@
-AM_V_CCLD = $(am__v_CCLD_$(V))
-am__v_CCLD_ = $(am__v_CCLD_$(AM_DEFAULT_VERBOSITY))
-am__v_CCLD_0 = @echo "  CCLD  " $@;
-AM_V_GEN = $(am__v_GEN_$(V))
-am__v_GEN_ = $(am__v_GEN_$(AM_DEFAULT_VERBOSITY))
-am__v_GEN_0 = @echo "  GEN   " $@;
+AM_V_CCLD = $(am__v_CCLD_@AM_V@)
+am__v_CCLD_ = $(am__v_CCLD_@AM_DEFAULT_V@)
+am__v_CCLD_0 = @echo "  CCLD    " $@;
+am__v_CCLD_1 = 
 SOURCES = $(libgstffmpegscale_la_SOURCES)
 DIST_SOURCES = $(libgstffmpegscale_la_SOURCES)
+am__can_run_installinfo = \
+  case $$AM_UPDATE_INFO_DIR in \
+    n|no|NO) false;; \
+    *) (install-info --version) >/dev/null 2>&1;; \
+  esac
 ETAGS = etags
 CTAGS = ctags
 DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
@@ -328,7 +366,11 @@ sbindir = @sbindir@
 sharedstatedir = @sharedstatedir@
 srcdir = @srcdir@
 sysconfdir = @sysconfdir@
+target = @target@
 target_alias = @target_alias@
+target_cpu = @target_cpu@
+target_os = @target_os@
+target_vendor = @target_vendor@
 top_build_prefix = @top_build_prefix@
 top_builddir = @top_builddir@
 top_srcdir = @top_srcdir@
@@ -380,7 +422,6 @@ $(ACLOCAL_M4): @MAINTAINER_MODE_TRUE@ $(am__aclocal_m4_deps)
 $(am__aclocal_m4_deps):
 install-pluginLTLIBRARIES: $(plugin_LTLIBRARIES)
 	@$(NORMAL_INSTALL)
-	test -z "$(plugindir)" || $(MKDIR_P) "$(DESTDIR)$(plugindir)"
 	@list='$(plugin_LTLIBRARIES)'; test -n "$(plugindir)" || list=; \
 	list2=; for p in $$list; do \
 	  if test -f $$p; then \
@@ -388,6 +429,8 @@ install-pluginLTLIBRARIES: $(plugin_LTLIBRARIES)
 	  else :; fi; \
 	done; \
 	test -z "$$list2" || { \
+	  echo " $(MKDIR_P) '$(DESTDIR)$(plugindir)'"; \
+	  $(MKDIR_P) "$(DESTDIR)$(plugindir)" || exit 1; \
 	  echo " $(LIBTOOL) $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=install $(INSTALL) $(INSTALL_STRIP_FLAG) $$list2 '$(DESTDIR)$(plugindir)'"; \
 	  $(LIBTOOL) $(AM_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=install $(INSTALL) $(INSTALL_STRIP_FLAG) $$list2 "$(DESTDIR)$(plugindir)"; \
 	}
@@ -403,13 +446,15 @@ uninstall-pluginLTLIBRARIES:
 
 clean-pluginLTLIBRARIES:
 	-test -z "$(plugin_LTLIBRARIES)" || rm -f $(plugin_LTLIBRARIES)
-	@list='$(plugin_LTLIBRARIES)'; for p in $$list; do \
-	  dir="`echo $$p | sed -e 's|/[^/]*$$||'`"; \
-	  test "$$dir" != "$$p" || dir=.; \
-	  echo "rm -f \"$${dir}/so_locations\""; \
-	  rm -f "$${dir}/so_locations"; \
-	done
-libgstffmpegscale.la: $(libgstffmpegscale_la_OBJECTS) $(libgstffmpegscale_la_DEPENDENCIES) 
+	@list='$(plugin_LTLIBRARIES)'; \
+	locs=`for p in $$list; do echo $$p; done | \
+	      sed 's|^[^/]*$$|.|; s|/[^/]*$$||; s|$$|/so_locations|' | \
+	      sort -u`; \
+	test -z "$$locs" || { \
+	  echo rm -f $${locs}; \
+	  rm -f $${locs}; \
+	}
+libgstffmpegscale.la: $(libgstffmpegscale_la_OBJECTS) $(libgstffmpegscale_la_DEPENDENCIES) $(EXTRA_libgstffmpegscale_la_DEPENDENCIES) 
 	$(AM_V_CCLD)$(libgstffmpegscale_la_LINK) -rpath $(plugindir) $(libgstffmpegscale_la_OBJECTS) $(libgstffmpegscale_la_LIBADD) $(LIBS)
 
 mostlyclean-compile:
@@ -423,34 +468,30 @@ distclean-compile:
 .c.o:
 @am__fastdepCC_TRUE@	$(AM_V_CC)$(COMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
 @am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
-@am__fastdepCC_FALSE@	$(AM_V_CC) @AM_BACKSLASH@
-@AMDEP_TRUE@@am__fastdepCC_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(COMPILE) -c $<
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(COMPILE) -c $<
 
 .c.obj:
 @am__fastdepCC_TRUE@	$(AM_V_CC)$(COMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ `$(CYGPATH_W) '$<'`
 @am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
-@am__fastdepCC_FALSE@	$(AM_V_CC) @AM_BACKSLASH@
-@AMDEP_TRUE@@am__fastdepCC_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(COMPILE) -c `$(CYGPATH_W) '$<'`
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(COMPILE) -c `$(CYGPATH_W) '$<'`
 
 .c.lo:
 @am__fastdepCC_TRUE@	$(AM_V_CC)$(LTCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
 @am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Plo
-@am__fastdepCC_FALSE@	$(AM_V_CC) @AM_BACKSLASH@
-@AMDEP_TRUE@@am__fastdepCC_FALSE@	source='$<' object='$@' libtool=yes @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='$<' object='$@' libtool=yes @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(LTCOMPILE) -c -o $@ $<
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(LTCOMPILE) -c -o $@ $<
 
 libgstffmpegscale_la-gstffmpegscale.lo: gstffmpegscale.c
 @am__fastdepCC_TRUE@	$(AM_V_CC)$(LIBTOOL) $(AM_V_lt) --tag=CC $(libgstffmpegscale_la_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libgstffmpegscale_la_CFLAGS) $(CFLAGS) -MT libgstffmpegscale_la-gstffmpegscale.lo -MD -MP -MF $(DEPDIR)/libgstffmpegscale_la-gstffmpegscale.Tpo -c -o libgstffmpegscale_la-gstffmpegscale.lo `test -f 'gstffmpegscale.c' || echo '$(srcdir)/'`gstffmpegscale.c
 @am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/libgstffmpegscale_la-gstffmpegscale.Tpo $(DEPDIR)/libgstffmpegscale_la-gstffmpegscale.Plo
-@am__fastdepCC_FALSE@	$(AM_V_CC) @AM_BACKSLASH@
-@AMDEP_TRUE@@am__fastdepCC_FALSE@	source='gstffmpegscale.c' object='libgstffmpegscale_la-gstffmpegscale.lo' libtool=yes @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='gstffmpegscale.c' object='libgstffmpegscale_la-gstffmpegscale.lo' libtool=yes @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(LIBTOOL) $(AM_V_lt) --tag=CC $(libgstffmpegscale_la_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libgstffmpegscale_la_CFLAGS) $(CFLAGS) -c -o libgstffmpegscale_la-gstffmpegscale.lo `test -f 'gstffmpegscale.c' || echo '$(srcdir)/'`gstffmpegscale.c
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(LIBTOOL) $(AM_V_lt) --tag=CC $(libgstffmpegscale_la_LIBTOOLFLAGS) $(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(libgstffmpegscale_la_CFLAGS) $(CFLAGS) -c -o libgstffmpegscale_la-gstffmpegscale.lo `test -f 'gstffmpegscale.c' || echo '$(srcdir)/'`gstffmpegscale.c
 
 mostlyclean-libtool:
 	-rm -f *.lo
@@ -507,6 +548,20 @@ GTAGS:
 	  && $(am__cd) $(top_srcdir) \
 	  && gtags -i $(GTAGS_ARGS) "$$here"
 
+cscopelist:  $(HEADERS) $(SOURCES) $(LISP)
+	list='$(SOURCES) $(HEADERS) $(LISP)'; \
+	case "$(srcdir)" in \
+	  [\\/]* | ?:[\\/]*) sdir="$(srcdir)" ;; \
+	  *) sdir=$(subdir)/$(srcdir) ;; \
+	esac; \
+	for i in $$list; do \
+	  if test -f "$$i"; then \
+	    echo "$(subdir)/$$i"; \
+	  else \
+	    echo "$$sdir/$$i"; \
+	  fi; \
+	done >> $(top_builddir)/cscope.files
+
 distclean-tags:
 	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
 
@@ -557,10 +612,15 @@ install-am: all-am
 
 installcheck: installcheck-am
 install-strip:
-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
-	  `test -z '$(STRIP)' || \
-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+	if test -z '$(STRIP)'; then \
+	  $(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+	    install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+	      install; \
+	else \
+	  $(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+	    install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+	    "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'" install; \
+	fi
 mostlyclean-generic:
 
 clean-generic:
@@ -646,18 +706,19 @@ uninstall-am: uninstall-pluginLTLIBRARIES
 .MAKE: install-am install-strip
 
 .PHONY: CTAGS GTAGS all all-am check check-am clean clean-generic \
-	clean-libtool clean-pluginLTLIBRARIES ctags distclean \
-	distclean-compile distclean-generic distclean-libtool \
-	distclean-tags distdir dvi dvi-am html html-am info info-am \
-	install install-am install-data install-data-am install-dvi \
-	install-dvi-am install-exec install-exec-am install-html \
-	install-html-am install-info install-info-am install-man \
-	install-pdf install-pdf-am install-pluginLTLIBRARIES \
-	install-ps install-ps-am install-strip installcheck \
-	installcheck-am installdirs maintainer-clean \
-	maintainer-clean-generic mostlyclean mostlyclean-compile \
-	mostlyclean-generic mostlyclean-libtool pdf pdf-am ps ps-am \
-	tags uninstall uninstall-am uninstall-pluginLTLIBRARIES
+	clean-libtool clean-pluginLTLIBRARIES cscopelist ctags \
+	distclean distclean-compile distclean-generic \
+	distclean-libtool distclean-tags distdir dvi dvi-am html \
+	html-am info info-am install install-am install-data \
+	install-data-am install-dvi install-dvi-am install-exec \
+	install-exec-am install-html install-html-am install-info \
+	install-info-am install-man install-pdf install-pdf-am \
+	install-pluginLTLIBRARIES install-ps install-ps-am \
+	install-strip installcheck installcheck-am installdirs \
+	maintainer-clean maintainer-clean-generic mostlyclean \
+	mostlyclean-compile mostlyclean-generic mostlyclean-libtool \
+	pdf pdf-am ps ps-am tags uninstall uninstall-am \
+	uninstall-pluginLTLIBRARIES
 
 
 # Tell versions [3.59,3.63) of GNU make to not export all variables.
diff --git a/ext/libswscale/gstffmpegscale.c b/ext/libswscale/gstffmpegscale.c
index b9ef3e1..c7a7087 100644
--- a/ext/libswscale/gstffmpegscale.c
+++ b/ext/libswscale/gstffmpegscale.c
@@ -190,10 +190,8 @@ gst_ffmpegscale_base_init (gpointer g_class)
 {
   GstElementClass *element_class = GST_ELEMENT_CLASS (g_class);
 
-  gst_element_class_add_pad_template (element_class,
-      gst_static_pad_template_get (&src_factory));
-  gst_element_class_add_pad_template (element_class,
-      gst_static_pad_template_get (&sink_factory));
+  gst_element_class_add_static_pad_template (element_class, &src_factory);
+  gst_element_class_add_static_pad_template (element_class, &sink_factory);
   gst_element_class_set_details_simple (element_class, "FFMPEG Scale element",
       "Filter/Converter/Video",
       "Converts video from one resolution to another",
@@ -596,7 +594,9 @@ gst_ffmpegscale_set_caps (GstBaseTransform * trans, GstCaps * incaps,
     GstCaps * outcaps)
 {
   GstFFMpegScale *scale = GST_FFMPEGSCALE (trans);
+#ifdef HAVE_ORC
   guint mmx_flags, altivec_flags;
+#endif
   gint swsflags;
   GstVideoFormat in_format, out_format;
   gboolean ok;
@@ -640,12 +640,9 @@ gst_ffmpegscale_set_caps (GstBaseTransform * trans, GstCaps * incaps,
       | (mmx_flags & ORC_TARGET_MMX_3DNOW ? SWS_CPU_CAPS_3DNOW : 0)
       | (altivec_flags & ORC_TARGET_ALTIVEC_ALTIVEC ? SWS_CPU_CAPS_ALTIVEC : 0);
 #else
-  mmx_flags = 0;
-  altivec_flags = 0;
   swsflags = 0;
 #endif
 
-
   scale->ctx = sws_getContext (scale->in_width, scale->in_height,
       scale->in_pixfmt, scale->out_width, scale->out_height, scale->out_pixfmt,
       swsflags | gst_ffmpegscale_method_flags[scale->method], NULL, NULL, NULL);
diff --git a/gst-ffmpeg.spec b/gst-ffmpeg.spec
deleted file mode 100644
index 0160958..0000000
--- a/gst-ffmpeg.spec
+++ /dev/null
@@ -1,72 +0,0 @@
-%define majorminor  0.10
-%define gstreamer   gstreamer
-%define gst_minver  0.10.0
-%define gst_majorminor  0.10
-
-
-Name: 		%{gstreamer}-ffmpeg
-Version: 	0.10.13
-Release:	1	
-Summary: 	GStreamer Streaming-media framework plug-in using FFmpeg.
-
-Group: 		Libraries/Multimedia
-License: 	LGPL
-URL:		http://gstreamer.net/
-Vendor:		GStreamer Backpackers Team <package@gstreamer.net>
-Source:		http://gstreamer.freedesktop.org/src/gst-ffmpeg/gst-ffmpeg/gst-ffmpeg-%{version}.tar.gz
-BuildRoot:	%{_tmppath}/%{name}-%{version}-%{release}-root-%(%{__id_u} -n)
-
-Requires:  	%{gstreamer} >= 0.9.7
-BuildRequires: 	%{gstreamer}-devel >= 0.9.7
-BuildRequires: 	%{gstreamer}-plugins-base-devel >= 0.9.7
-BuildRequires: 	liboil-devel >= 0.3.6
-
-%description
-GStreamer is a streaming-media framework, based on graphs of filters which
-operate on media data. Applications using this library can do anything
-from real-time sound processing to playing videos, and just about anything
-else media-related. Its plugin-based architecture means that new data
-types or processing capabilities can be added simply by installing new
-plug-ins.
-
-This plugin contains the FFmpeg codecs, containing codecs for most popular
-multimedia formats.
-
-%prep
-%setup -q -n gst-ffmpeg-%{version}
-
-%build
-%configure
-
-make
-
-%install
-rm -rf $RPM_BUILD_ROOT
-
-%makeinstall
-rm -f $RPM_BUILD_ROOT%{_libdir}/gstreamer-%{gst_majorminor}/*.la
-rm -f $RPM_BUILD_ROOT%{_libdir}/gstreamer-%{gst_majorminor}/*.a
-
-%clean
-rm -rf $RPM_BUILD_ROOT
-
-%files
-%defattr(-, root, root, -)
-%doc AUTHORS COPYING README gst-ffmpeg.doap
-%{_libdir}/gstreamer-%{gst_majorminor}/libgstffmpeg.so
-%{_libdir}/gstreamer-%{gst_majorminor}/libgstpostproc.so
-%{_libdir}/gstreamer-%{gst_majorminor}/libgstffmpegscale.so
-
-%changelog
-* Fri Dec 15 2006 Thomas Vander Stichele <thomas at apestaart dot org>
-- clean up
-- add doap file
-
-* Wed Oct 05 2004 Christian Schaller <christian at fluendo dot com>
-- Update SPEC file to fit the times
-
-* Sat Feb 14 2004 Thomas Vander Stichele <thomas at apestaart dot org>
-- Clean up spec file
-
-* Wed Jan 21 2004 Christian Schaller <Uraeus@gnome.org>
-- First version of spec
diff --git a/gst-libs/Makefile.in b/gst-libs/Makefile.in
index 06cd3d4..485a966 100644
--- a/gst-libs/Makefile.in
+++ b/gst-libs/Makefile.in
@@ -1,9 +1,8 @@
-# Makefile.in generated by automake 1.11.1 from Makefile.am.
+# Makefile.in generated by automake 1.12.6 from Makefile.am.
 # @configure_input@
 
-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
-# Inc.
+# Copyright (C) 1994-2012 Free Software Foundation, Inc.
+
 # This Makefile.in is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
@@ -15,6 +14,23 @@
 
 @SET_MAKE@
 VPATH = @srcdir@
+am__make_dryrun = \
+  { \
+    am__dry=no; \
+    case $$MAKEFLAGS in \
+      *\\[\ \	]*) \
+        echo 'am--echo: ; @echo "AM"  OK' | $(MAKE) -f - 2>/dev/null \
+          | grep '^AM OK$$' >/dev/null || am__dry=yes;; \
+      *) \
+        for am__flg in $$MAKEFLAGS; do \
+          case $$am__flg in \
+            *=*|--*) ;; \
+            *n*) am__dry=yes; break;; \
+          esac; \
+        done;; \
+    esac; \
+    test $$am__dry = yes; \
+  }
 pkgdatadir = $(datadir)/@PACKAGE@
 pkgincludedir = $(includedir)/@PACKAGE@
 pkglibdir = $(libdir)/@PACKAGE@
@@ -33,6 +49,7 @@ PRE_UNINSTALL = :
 POST_UNINSTALL = :
 build_triplet = @build@
 host_triplet = @host@
+target_triplet = @target@
 subdir = gst-libs
 DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
 ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
@@ -63,12 +80,18 @@ mkinstalldirs = $(install_sh) -d
 CONFIG_HEADER = $(top_builddir)/config.h
 CONFIG_CLEAN_FILES =
 CONFIG_CLEAN_VPATH_FILES =
-AM_V_GEN = $(am__v_GEN_$(V))
-am__v_GEN_ = $(am__v_GEN_$(AM_DEFAULT_VERBOSITY))
-am__v_GEN_0 = @echo "  GEN   " $@;
-AM_V_at = $(am__v_at_$(V))
-am__v_at_ = $(am__v_at_$(AM_DEFAULT_VERBOSITY))
+AM_V_P = $(am__v_P_@AM_V@)
+am__v_P_ = $(am__v_P_@AM_DEFAULT_V@)
+am__v_P_0 = false
+am__v_P_1 = :
+AM_V_GEN = $(am__v_GEN_@AM_V@)
+am__v_GEN_ = $(am__v_GEN_@AM_DEFAULT_V@)
+am__v_GEN_0 = @echo "  GEN     " $@;
+am__v_GEN_1 = 
+AM_V_at = $(am__v_at_@AM_V@)
+am__v_at_ = $(am__v_at_@AM_DEFAULT_V@)
 am__v_at_0 = @
+am__v_at_1 = 
 SOURCES =
 DIST_SOURCES =
 RECURSIVE_TARGETS = all-recursive check-recursive dvi-recursive \
@@ -78,6 +101,11 @@ RECURSIVE_TARGETS = all-recursive check-recursive dvi-recursive \
 	install-pdf-recursive install-ps-recursive install-recursive \
 	installcheck-recursive installdirs-recursive pdf-recursive \
 	ps-recursive uninstall-recursive
+am__can_run_installinfo = \
+  case $$AM_UPDATE_INFO_DIR in \
+    n|no|NO) false;; \
+    *) (install-info --version) >/dev/null 2>&1;; \
+  esac
 RECURSIVE_CLEAN_TARGETS = mostlyclean-recursive clean-recursive	\
   distclean-recursive maintainer-clean-recursive
 AM_RECURSIVE_TARGETS = $(RECURSIVE_TARGETS:-recursive=) \
@@ -305,7 +333,11 @@ sbindir = @sbindir@
 sharedstatedir = @sharedstatedir@
 srcdir = @srcdir@
 sysconfdir = @sysconfdir@
+target = @target@
 target_alias = @target_alias@
+target_cpu = @target_cpu@
+target_os = @target_os@
+target_vendor = @target_vendor@
 top_build_prefix = @top_build_prefix@
 top_builddir = @top_builddir@
 top_srcdir = @top_srcdir@
@@ -351,12 +383,12 @@ clean-libtool:
 	-rm -rf .libs _libs
 
 # This directory's subdirectories are mostly independent; you can cd
-# into them and run `make' without going through this Makefile.
-# To change the values of `make' variables: instead of editing Makefiles,
-# (1) if the variable is set in `config.status', edit `config.status'
-#     (which will cause the Makefiles to be regenerated when you run `make');
-# (2) otherwise, pass the desired values on the `make' command line.
-$(RECURSIVE_TARGETS):
+# into them and run 'make' without going through this Makefile.
+# To change the values of 'make' variables: instead of editing Makefiles,
+# (1) if the variable is set in 'config.status', edit 'config.status'
+#     (which will cause the Makefiles to be regenerated when you run 'make');
+# (2) otherwise, pass the desired values on the 'make' command line.
+$(RECURSIVE_TARGETS) $(RECURSIVE_CLEAN_TARGETS):
 	@fail= failcom='exit 1'; \
 	for f in x $$MAKEFLAGS; do \
 	  case $$f in \
@@ -366,7 +398,11 @@ $(RECURSIVE_TARGETS):
 	done; \
 	dot_seen=no; \
 	target=`echo $@ | sed s/-recursive//`; \
-	list='$(SUBDIRS)'; for subdir in $$list; do \
+	case "$@" in \
+	  distclean-* | maintainer-clean-*) list='$(DIST_SUBDIRS)' ;; \
+	  *) list='$(SUBDIRS)' ;; \
+	esac; \
+	for subdir in $$list; do \
 	  echo "Making $$target in $$subdir"; \
 	  if test "$$subdir" = "."; then \
 	    dot_seen=yes; \
@@ -380,37 +416,6 @@ $(RECURSIVE_TARGETS):
 	if test "$$dot_seen" = "no"; then \
 	  $(MAKE) $(AM_MAKEFLAGS) "$$target-am" || exit 1; \
 	fi; test -z "$$fail"
-
-$(RECURSIVE_CLEAN_TARGETS):
-	@fail= failcom='exit 1'; \
-	for f in x $$MAKEFLAGS; do \
-	  case $$f in \
-	    *=* | --[!k]*);; \
-	    *k*) failcom='fail=yes';; \
-	  esac; \
-	done; \
-	dot_seen=no; \
-	case "$@" in \
-	  distclean-* | maintainer-clean-*) list='$(DIST_SUBDIRS)' ;; \
-	  *) list='$(SUBDIRS)' ;; \
-	esac; \
-	rev=''; for subdir in $$list; do \
-	  if test "$$subdir" = "."; then :; else \
-	    rev="$$subdir $$rev"; \
-	  fi; \
-	done; \
-	rev="$$rev ."; \
-	target=`echo $@ | sed s/-recursive//`; \
-	for subdir in $$rev; do \
-	  echo "Making $$target in $$subdir"; \
-	  if test "$$subdir" = "."; then \
-	    local_target="$$target-am"; \
-	  else \
-	    local_target="$$target"; \
-	  fi; \
-	  ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) $$local_target) \
-	  || eval $$failcom; \
-	done && test -z "$$fail"
 tags-recursive:
 	list='$(SUBDIRS)'; for subdir in $$list; do \
 	  test "$$subdir" = . || ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) tags); \
@@ -419,6 +424,10 @@ ctags-recursive:
 	list='$(SUBDIRS)'; for subdir in $$list; do \
 	  test "$$subdir" = . || ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) ctags); \
 	done
+cscopelist-recursive:
+	list='$(SUBDIRS)'; for subdir in $$list; do \
+	  test "$$subdir" = . || ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) cscopelist); \
+	done
 
 ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
 	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
@@ -482,6 +491,20 @@ GTAGS:
 	  && $(am__cd) $(top_srcdir) \
 	  && gtags -i $(GTAGS_ARGS) "$$here"
 
+cscopelist: cscopelist-recursive $(HEADERS) $(SOURCES) $(LISP)
+	list='$(SOURCES) $(HEADERS) $(LISP)'; \
+	case "$(srcdir)" in \
+	  [\\/]* | ?:[\\/]*) sdir="$(srcdir)" ;; \
+	  *) sdir=$(subdir)/$(srcdir) ;; \
+	esac; \
+	for i in $$list; do \
+	  if test -f "$$i"; then \
+	    echo "$(subdir)/$$i"; \
+	  else \
+	    echo "$$sdir/$$i"; \
+	  fi; \
+	done >> $(top_builddir)/cscope.files
+
 distclean-tags:
 	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
 
@@ -517,13 +540,10 @@ distdir: $(DISTFILES)
 	done
 	@list='$(DIST_SUBDIRS)'; for subdir in $$list; do \
 	  if test "$$subdir" = .; then :; else \
-	    test -d "$(distdir)/$$subdir" \
-	    || $(MKDIR_P) "$(distdir)/$$subdir" \
-	    || exit 1; \
-	  fi; \
-	done
-	@list='$(DIST_SUBDIRS)'; for subdir in $$list; do \
-	  if test "$$subdir" = .; then :; else \
+	    $(am__make_dryrun) \
+	      || test -d "$(distdir)/$$subdir" \
+	      || $(MKDIR_P) "$(distdir)/$$subdir" \
+	      || exit 1; \
 	    dir1=$$subdir; dir2="$(distdir)/$$subdir"; \
 	    $(am__relativize); \
 	    new_distdir=$$reldir; \
@@ -558,10 +578,15 @@ install-am: all-am
 
 installcheck: installcheck-recursive
 install-strip:
-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
-	  `test -z '$(STRIP)' || \
-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+	if test -z '$(STRIP)'; then \
+	  $(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+	    install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+	      install; \
+	else \
+	  $(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+	    install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+	    "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'" install; \
+	fi
 mostlyclean-generic:
 
 clean-generic:
@@ -639,22 +664,23 @@ ps-am:
 
 uninstall-am:
 
-.MAKE: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) ctags-recursive \
-	install-am install-strip tags-recursive
+.MAKE: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) \
+	cscopelist-recursive ctags-recursive install-am install-strip \
+	tags-recursive
 
 .PHONY: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) CTAGS GTAGS \
 	all all-am check check-am clean clean-generic clean-libtool \
-	ctags ctags-recursive distclean distclean-generic \
-	distclean-libtool distclean-tags distdir dvi dvi-am html \
-	html-am info info-am install install-am install-data \
-	install-data-am install-dvi install-dvi-am install-exec \
-	install-exec-am install-html install-html-am install-info \
-	install-info-am install-man install-pdf install-pdf-am \
-	install-ps install-ps-am install-strip installcheck \
-	installcheck-am installdirs installdirs-am maintainer-clean \
-	maintainer-clean-generic mostlyclean mostlyclean-generic \
-	mostlyclean-libtool pdf pdf-am ps ps-am tags tags-recursive \
-	uninstall uninstall-am
+	cscopelist cscopelist-recursive ctags ctags-recursive \
+	distclean distclean-generic distclean-libtool distclean-tags \
+	distdir dvi dvi-am html html-am info info-am install \
+	install-am install-data install-data-am install-dvi \
+	install-dvi-am install-exec install-exec-am install-html \
+	install-html-am install-info install-info-am install-man \
+	install-pdf install-pdf-am install-ps install-ps-am \
+	install-strip installcheck installcheck-am installdirs \
+	installdirs-am maintainer-clean maintainer-clean-generic \
+	mostlyclean mostlyclean-generic mostlyclean-libtool pdf pdf-am \
+	ps ps-am tags tags-recursive uninstall uninstall-am
 
 
 # Tell versions [3.59,3.63) of GNU make to not export all variables.
diff --git a/gst-libs/ext/Makefile.in b/gst-libs/ext/Makefile.in
index 4aa11b9..993d262 100644
--- a/gst-libs/ext/Makefile.in
+++ b/gst-libs/ext/Makefile.in
@@ -1,9 +1,8 @@
-# Makefile.in generated by automake 1.11.1 from Makefile.am.
+# Makefile.in generated by automake 1.12.6 from Makefile.am.
 # @configure_input@
 
-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
-# Inc.
+# Copyright (C) 1994-2012 Free Software Foundation, Inc.
+
 # This Makefile.in is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
@@ -25,6 +24,23 @@
 # - add an all-local hook so it does get built
 # this also satisfies make distcheck
 VPATH = @srcdir@
+am__make_dryrun = \
+  { \
+    am__dry=no; \
+    case $$MAKEFLAGS in \
+      *\\[\ \	]*) \
+        echo 'am--echo: ; @echo "AM"  OK' | $(MAKE) -f - 2>/dev/null \
+          | grep '^AM OK$$' >/dev/null || am__dry=yes;; \
+      *) \
+        for am__flg in $$MAKEFLAGS; do \
+          case $$am__flg in \
+            *=*|--*) ;; \
+            *n*) am__dry=yes; break;; \
+          esac; \
+        done;; \
+    esac; \
+    test $$am__dry = yes; \
+  }
 pkgdatadir = $(datadir)/@PACKAGE@
 pkgincludedir = $(includedir)/@PACKAGE@
 pkglibdir = $(libdir)/@PACKAGE@
@@ -43,6 +59,7 @@ PRE_UNINSTALL = :
 POST_UNINSTALL = :
 build_triplet = @build@
 host_triplet = @host@
+target_triplet = @target@
 subdir = gst-libs/ext
 DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
 ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
@@ -73,12 +90,18 @@ mkinstalldirs = $(install_sh) -d
 CONFIG_HEADER = $(top_builddir)/config.h
 CONFIG_CLEAN_FILES =
 CONFIG_CLEAN_VPATH_FILES =
-AM_V_GEN = $(am__v_GEN_$(V))
-am__v_GEN_ = $(am__v_GEN_$(AM_DEFAULT_VERBOSITY))
-am__v_GEN_0 = @echo "  GEN   " $@;
-AM_V_at = $(am__v_at_$(V))
-am__v_at_ = $(am__v_at_$(AM_DEFAULT_VERBOSITY))
+AM_V_P = $(am__v_P_@AM_V@)
+am__v_P_ = $(am__v_P_@AM_DEFAULT_V@)
+am__v_P_0 = false
+am__v_P_1 = :
+AM_V_GEN = $(am__v_GEN_@AM_V@)
+am__v_GEN_ = $(am__v_GEN_@AM_DEFAULT_V@)
+am__v_GEN_0 = @echo "  GEN     " $@;
+am__v_GEN_1 = 
+AM_V_at = $(am__v_at_@AM_V@)
+am__v_at_ = $(am__v_at_@AM_DEFAULT_V@)
 am__v_at_0 = @
+am__v_at_1 = 
 SOURCES =
 DIST_SOURCES =
 RECURSIVE_TARGETS = all-recursive check-recursive dvi-recursive \
@@ -88,6 +111,11 @@ RECURSIVE_TARGETS = all-recursive check-recursive dvi-recursive \
 	install-pdf-recursive install-ps-recursive install-recursive \
 	installcheck-recursive installdirs-recursive pdf-recursive \
 	ps-recursive uninstall-recursive
+am__can_run_installinfo = \
+  case $$AM_UPDATE_INFO_DIR in \
+    n|no|NO) false;; \
+    *) (install-info --version) >/dev/null 2>&1;; \
+  esac
 RECURSIVE_CLEAN_TARGETS = mostlyclean-recursive clean-recursive	\
   distclean-recursive maintainer-clean-recursive
 AM_RECURSIVE_TARGETS = $(RECURSIVE_TARGETS:-recursive=) \
@@ -314,7 +342,11 @@ sbindir = @sbindir@
 sharedstatedir = @sharedstatedir@
 srcdir = @srcdir@
 sysconfdir = @sysconfdir@
+target = @target@
 target_alias = @target_alias@
+target_cpu = @target_cpu@
+target_os = @target_os@
+target_vendor = @target_vendor@
 top_build_prefix = @top_build_prefix@
 top_builddir = @top_builddir@
 top_srcdir = @top_srcdir@
@@ -365,12 +397,12 @@ clean-libtool:
 	-rm -rf .libs _libs
 
 # This directory's subdirectories are mostly independent; you can cd
-# into them and run `make' without going through this Makefile.
-# To change the values of `make' variables: instead of editing Makefiles,
-# (1) if the variable is set in `config.status', edit `config.status'
-#     (which will cause the Makefiles to be regenerated when you run `make');
-# (2) otherwise, pass the desired values on the `make' command line.
-$(RECURSIVE_TARGETS):
+# into them and run 'make' without going through this Makefile.
+# To change the values of 'make' variables: instead of editing Makefiles,
+# (1) if the variable is set in 'config.status', edit 'config.status'
+#     (which will cause the Makefiles to be regenerated when you run 'make');
+# (2) otherwise, pass the desired values on the 'make' command line.
+$(RECURSIVE_TARGETS) $(RECURSIVE_CLEAN_TARGETS):
 	@fail= failcom='exit 1'; \
 	for f in x $$MAKEFLAGS; do \
 	  case $$f in \
@@ -380,7 +412,11 @@ $(RECURSIVE_TARGETS):
 	done; \
 	dot_seen=no; \
 	target=`echo $@ | sed s/-recursive//`; \
-	list='$(SUBDIRS)'; for subdir in $$list; do \
+	case "$@" in \
+	  distclean-* | maintainer-clean-*) list='$(DIST_SUBDIRS)' ;; \
+	  *) list='$(SUBDIRS)' ;; \
+	esac; \
+	for subdir in $$list; do \
 	  echo "Making $$target in $$subdir"; \
 	  if test "$$subdir" = "."; then \
 	    dot_seen=yes; \
@@ -394,37 +430,6 @@ $(RECURSIVE_TARGETS):
 	if test "$$dot_seen" = "no"; then \
 	  $(MAKE) $(AM_MAKEFLAGS) "$$target-am" || exit 1; \
 	fi; test -z "$$fail"
-
-$(RECURSIVE_CLEAN_TARGETS):
-	@fail= failcom='exit 1'; \
-	for f in x $$MAKEFLAGS; do \
-	  case $$f in \
-	    *=* | --[!k]*);; \
-	    *k*) failcom='fail=yes';; \
-	  esac; \
-	done; \
-	dot_seen=no; \
-	case "$@" in \
-	  distclean-* | maintainer-clean-*) list='$(DIST_SUBDIRS)' ;; \
-	  *) list='$(SUBDIRS)' ;; \
-	esac; \
-	rev=''; for subdir in $$list; do \
-	  if test "$$subdir" = "."; then :; else \
-	    rev="$$subdir $$rev"; \
-	  fi; \
-	done; \
-	rev="$$rev ."; \
-	target=`echo $@ | sed s/-recursive//`; \
-	for subdir in $$rev; do \
-	  echo "Making $$target in $$subdir"; \
-	  if test "$$subdir" = "."; then \
-	    local_target="$$target-am"; \
-	  else \
-	    local_target="$$target"; \
-	  fi; \
-	  ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) $$local_target) \
-	  || eval $$failcom; \
-	done && test -z "$$fail"
 tags-recursive:
 	list='$(SUBDIRS)'; for subdir in $$list; do \
 	  test "$$subdir" = . || ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) tags); \
@@ -433,6 +438,10 @@ ctags-recursive:
 	list='$(SUBDIRS)'; for subdir in $$list; do \
 	  test "$$subdir" = . || ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) ctags); \
 	done
+cscopelist-recursive:
+	list='$(SUBDIRS)'; for subdir in $$list; do \
+	  test "$$subdir" = . || ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) cscopelist); \
+	done
 
 ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
 	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
@@ -496,6 +505,20 @@ GTAGS:
 	  && $(am__cd) $(top_srcdir) \
 	  && gtags -i $(GTAGS_ARGS) "$$here"
 
+cscopelist: cscopelist-recursive $(HEADERS) $(SOURCES) $(LISP)
+	list='$(SOURCES) $(HEADERS) $(LISP)'; \
+	case "$(srcdir)" in \
+	  [\\/]* | ?:[\\/]*) sdir="$(srcdir)" ;; \
+	  *) sdir=$(subdir)/$(srcdir) ;; \
+	esac; \
+	for i in $$list; do \
+	  if test -f "$$i"; then \
+	    echo "$(subdir)/$$i"; \
+	  else \
+	    echo "$$sdir/$$i"; \
+	  fi; \
+	done >> $(top_builddir)/cscope.files
+
 distclean-tags:
 	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
 check-am: all-am
@@ -513,10 +536,15 @@ install-am: all-am
 
 installcheck: installcheck-recursive
 install-strip:
-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
-	  `test -z '$(STRIP)' || \
-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+	if test -z '$(STRIP)'; then \
+	  $(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+	    install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+	      install; \
+	else \
+	  $(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+	    install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+	    "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'" install; \
+	fi
 mostlyclean-generic:
 
 clean-generic:
@@ -590,22 +618,24 @@ ps-am:
 
 uninstall-am:
 
-.MAKE: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) ctags-recursive \
-	install-am install-strip tags-recursive
+.MAKE: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) \
+	cscopelist-recursive ctags-recursive install-am install-strip \
+	tags-recursive
 
 .PHONY: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) CTAGS GTAGS \
 	all all-am all-local check check-am clean clean-generic \
-	clean-libtool clean-local ctags ctags-recursive distclean \
-	distclean-generic distclean-libtool distclean-tags distdir dvi \
-	dvi-am html html-am info info-am install install-am \
-	install-data install-data-am install-dvi install-dvi-am \
-	install-exec install-exec-am install-html install-html-am \
-	install-info install-info-am install-man install-pdf \
-	install-pdf-am install-ps install-ps-am install-strip \
-	installcheck installcheck-am installdirs installdirs-am \
-	maintainer-clean maintainer-clean-generic mostlyclean \
-	mostlyclean-generic mostlyclean-libtool pdf pdf-am ps ps-am \
-	tags tags-recursive uninstall uninstall-am
+	clean-libtool clean-local cscopelist cscopelist-recursive \
+	ctags ctags-recursive distclean distclean-generic \
+	distclean-libtool distclean-tags distdir dvi dvi-am html \
+	html-am info info-am install install-am install-data \
+	install-data-am install-dvi install-dvi-am install-exec \
+	install-exec-am install-html install-html-am install-info \
+	install-info-am install-man install-pdf install-pdf-am \
+	install-ps install-ps-am install-strip installcheck \
+	installcheck-am installdirs installdirs-am maintainer-clean \
+	maintainer-clean-generic mostlyclean mostlyclean-generic \
+	mostlyclean-libtool pdf pdf-am ps ps-am tags tags-recursive \
+	uninstall uninstall-am
 
 
 all-local:
diff --git a/ltmain.sh b/ltmain.sh
old mode 100755
new mode 100644
index b395ba7..79fb897
--- a/ltmain.sh
+++ b/ltmain.sh
@@ -1,9 +1,9 @@
 
-# libtool (GNU libtool) 2.4
+# libtool (GNU libtool) 2.4.2
 # Written by Gordon Matzigkeit <gord@gnu.ai.mit.edu>, 1996
 
 # Copyright (C) 1996, 1997, 1998, 1999, 2000, 2001, 2003, 2004, 2005, 2006,
-# 2007, 2008, 2009, 2010 Free Software Foundation, Inc.
+# 2007, 2008, 2009, 2010, 2011 Free Software Foundation, Inc.
 # This is free software; see the source for copying conditions.  There is NO
 # warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
 
@@ -41,6 +41,7 @@
 #       --quiet, --silent    don't print informational messages
 #       --no-quiet, --no-silent
 #                            print informational messages (default)
+#       --no-warn            don't display warning messages
 #       --tag=TAG            use configuration variables from tag TAG
 #   -v, --verbose            print more informational messages than default
 #       --no-verbose         don't print the extra informational messages
@@ -69,7 +70,7 @@
 #         compiler:		$LTCC
 #         compiler flags:		$LTCFLAGS
 #         linker:		$LD (gnu? $with_gnu_ld)
-#         $progname:	(GNU libtool) 2.4
+#         $progname:	(GNU libtool) 2.4.2
 #         automake:	$automake_version
 #         autoconf:	$autoconf_version
 #
@@ -79,9 +80,9 @@
 
 PROGRAM=libtool
 PACKAGE=libtool
-VERSION=2.4
+VERSION=2.4.2
 TIMESTAMP=""
-package_revision=1.3293
+package_revision=1.3337
 
 # Be Bourne compatible
 if test -n "${ZSH_VERSION+set}" && (emulate sh) >/dev/null 2>&1; then
@@ -136,15 +137,10 @@ progpath="$0"
 
 : ${CP="cp -f"}
 test "${ECHO+set}" = set || ECHO=${as_echo-'printf %s\n'}
-: ${EGREP="/bin/grep -E"}
-: ${FGREP="/bin/grep -F"}
-: ${GREP="/bin/grep"}
-: ${LN_S="ln -s"}
 : ${MAKE="make"}
 : ${MKDIR="mkdir"}
 : ${MV="mv -f"}
 : ${RM="rm -f"}
-: ${SED="/bin/sed"}
 : ${SHELL="${CONFIG_SHELL-/bin/sh}"}
 : ${Xsed="$SED -e 1s/^X//"}
 
@@ -387,7 +383,7 @@ case $progpath in
      ;;
   *)
      save_IFS="$IFS"
-     IFS=:
+     IFS=${PATH_SEPARATOR-:}
      for progdir in $PATH; do
        IFS="$save_IFS"
        test -x "$progdir/$progname" && break
@@ -771,8 +767,8 @@ func_help ()
 	s*\$LTCFLAGS*'"$LTCFLAGS"'*
 	s*\$LD*'"$LD"'*
 	s/\$with_gnu_ld/'"$with_gnu_ld"'/
-	s/\$automake_version/'"`(automake --version) 2>/dev/null |$SED 1q`"'/
-	s/\$autoconf_version/'"`(autoconf --version) 2>/dev/null |$SED 1q`"'/
+	s/\$automake_version/'"`(${AUTOMAKE-automake} --version) 2>/dev/null |$SED 1q`"'/
+	s/\$autoconf_version/'"`(${AUTOCONF-autoconf} --version) 2>/dev/null |$SED 1q`"'/
 	p
 	d
      }
@@ -1052,6 +1048,7 @@ opt_finish=false
 opt_help=false
 opt_help_all=false
 opt_silent=:
+opt_warning=:
 opt_verbose=:
 opt_silent=false
 opt_verbose=false
@@ -1120,6 +1117,10 @@ esac
 			opt_silent=false
 func_append preserve_args " $opt"
 			;;
+      --no-warning|--no-warn)
+			opt_warning=false
+func_append preserve_args " $opt"
+			;;
       --no-verbose)
 			opt_verbose=false
 func_append preserve_args " $opt"
@@ -2059,7 +2060,7 @@ func_mode_compile ()
     *.[cCFSifmso] | \
     *.ada | *.adb | *.ads | *.asm | \
     *.c++ | *.cc | *.ii | *.class | *.cpp | *.cxx | \
-    *.[fF][09]? | *.for | *.java | *.obj | *.sx | *.cu | *.cup)
+    *.[fF][09]? | *.for | *.java | *.go | *.obj | *.sx | *.cu | *.cup)
       func_xform "$libobj"
       libobj=$func_xform_result
       ;;
@@ -3201,11 +3202,13 @@ func_mode_install ()
 
       # Set up the ranlib parameters.
       oldlib="$destdir/$name"
+      func_to_tool_file "$oldlib" func_convert_file_msys_to_w32
+      tool_oldlib=$func_to_tool_file_result
 
       func_show_eval "$install_prog \$file \$oldlib" 'exit $?'
 
       if test -n "$stripme" && test -n "$old_striplib"; then
-	func_show_eval "$old_striplib $oldlib" 'exit $?'
+	func_show_eval "$old_striplib $tool_oldlib" 'exit $?'
       fi
 
       # Do each command in the postinstall commands.
@@ -3470,7 +3473,7 @@ static const void *lt_preloaded_setup() {
 	  # linked before any other PIC object.  But we must not use
 	  # pic_flag when linking with -static.  The problem exists in
 	  # FreeBSD 2.2.6 and is fixed in FreeBSD 3.1.
-	  *-*-freebsd2*|*-*-freebsd3.0*|*-*-freebsdelf3.0*)
+	  *-*-freebsd2.*|*-*-freebsd3.0*|*-*-freebsdelf3.0*)
 	    pic_flag_for_symtable=" $pic_flag -DFREEBSD_WORKAROUND" ;;
 	  *-*-hpux*)
 	    pic_flag_for_symtable=" $pic_flag"  ;;
@@ -3982,14 +3985,17 @@ func_exec_program_core ()
 # launches target application with the remaining arguments.
 func_exec_program ()
 {
-  for lt_wr_arg
-  do
-    case \$lt_wr_arg in
-    --lt-*) ;;
-    *) set x \"\$@\" \"\$lt_wr_arg\"; shift;;
-    esac
-    shift
-  done
+  case \" \$* \" in
+  *\\ --lt-*)
+    for lt_wr_arg
+    do
+      case \$lt_wr_arg in
+      --lt-*) ;;
+      *) set x \"\$@\" \"\$lt_wr_arg\"; shift;;
+      esac
+      shift
+    done ;;
+  esac
   func_exec_program_core \${1+\"\$@\"}
 }
 
@@ -5057,9 +5063,15 @@ void lt_dump_script (FILE* f)
 {
 EOF
 	    func_emit_wrapper yes |
-              $SED -e 's/\([\\"]\)/\\\1/g' \
-	           -e 's/^/  fputs ("/' -e 's/$/\\n", f);/'
-
+	      $SED -n -e '
+s/^\(.\{79\}\)\(..*\)/\1\
+\2/
+h
+s/\([\\"]\)/\\\1/g
+s/$/\\n/
+s/\([^\n]*\).*/  fputs ("\1", f);/p
+g
+D'
             cat <<"EOF"
 }
 EOF
@@ -6833,7 +6845,7 @@ func_mode_link ()
 	         test "$hardcode_direct_absolute" = no; then
 		add="$dir/$linklib"
 	      elif test "$hardcode_minus_L" = yes; then
-		add_dir="-L$dir"
+		add_dir="-L$absdir"
 		# Try looking first in the location we're being installed to.
 		if test -n "$inst_prefix_dir"; then
 		  case $libdir in
@@ -6906,7 +6918,7 @@ func_mode_link ()
 	      fi
 	    else
 	      # We cannot seem to hardcode it, guess we'll fake it.
-	      add_dir="-L$libdir"
+	      add_dir="-L$lt_sysroot$libdir"
 	      # Try looking first in the location we're being installed to.
 	      if test -n "$inst_prefix_dir"; then
 		case $libdir in
@@ -7318,6 +7330,7 @@ func_mode_link ()
 	  # which has an extra 1 added just for fun
 	  #
 	  case $version_type in
+	  # correct linux to gnu/linux during the next big refactor
 	  darwin|linux|osf|windows|none)
 	    func_arith $number_major + $number_minor
 	    current=$func_arith_result
@@ -7434,7 +7447,7 @@ func_mode_link ()
 	  versuffix="$major.$revision"
 	  ;;
 
-	linux)
+	linux) # correct to gnu/linux during the next big refactor
 	  func_arith $current - $age
 	  major=.$func_arith_result
 	  versuffix="$major.$age.$revision"
@@ -8022,6 +8035,11 @@ EOF
 
       # Test again, we may have decided not to build it any more
       if test "$build_libtool_libs" = yes; then
+	# Remove ${wl} instances when linking with ld.
+	# FIXME: should test the right _cmds variable.
+	case $archive_cmds in
+	  *\$LD\ *) wl= ;;
+        esac
 	if test "$hardcode_into_libs" = yes; then
 	  # Hardcode the library paths
 	  hardcode_libdirs=
@@ -8052,7 +8070,7 @@ EOF
 	    elif test -n "$runpath_var"; then
 	      case "$perm_rpath " in
 	      *" $libdir "*) ;;
-	      *) func_apped perm_rpath " $libdir" ;;
+	      *) func_append perm_rpath " $libdir" ;;
 	      esac
 	    fi
 	  done
@@ -8060,11 +8078,7 @@ EOF
 	  if test -n "$hardcode_libdir_separator" &&
 	     test -n "$hardcode_libdirs"; then
 	    libdir="$hardcode_libdirs"
-	    if test -n "$hardcode_libdir_flag_spec_ld"; then
-	      eval dep_rpath=\"$hardcode_libdir_flag_spec_ld\"
-	    else
-	      eval dep_rpath=\"$hardcode_libdir_flag_spec\"
-	    fi
+	    eval "dep_rpath=\"$hardcode_libdir_flag_spec\""
 	  fi
 	  if test -n "$runpath_var" && test -n "$perm_rpath"; then
 	    # We should set the runpath_var.
@@ -9154,6 +9168,8 @@ EOF
 	    esac
 	  done
 	fi
+	func_to_tool_file "$oldlib" func_convert_file_msys_to_w32
+	tool_oldlib=$func_to_tool_file_result
 	eval cmds=\"$old_archive_cmds\"
 
 	func_len " $cmds"
@@ -9263,7 +9279,8 @@ EOF
 	      *.la)
 		func_basename "$deplib"
 		name="$func_basename_result"
-		eval libdir=`${SED} -n -e 's/^libdir=\(.*\)$/\1/p' $deplib`
+		func_resolve_sysroot "$deplib"
+		eval libdir=`${SED} -n -e 's/^libdir=\(.*\)$/\1/p' $func_resolve_sysroot_result`
 		test -z "$libdir" && \
 		  func_fatal_error "\`$deplib' is not a valid libtool archive"
 		func_append newdependency_libs " ${lt_sysroot:+=}$libdir/$name"
diff --git a/m4/as-slurp-ffmpeg.m4 b/m4/as-slurp-ffmpeg.m4
new file mode 100644
index 0000000..fd54b42
--- /dev/null
+++ b/m4/as-slurp-ffmpeg.m4
@@ -0,0 +1,59 @@
+dnl slurp-ffmpeg.m4 0.1.1
+dnl a macro to slurp in ffmpeg's cvs source inside a project tree
+dnl taken from Autostar Sandbox, http://autostars.sourceforge.net/
+
+dnl Usage:
+dnl AS_SLURP_FFMPEG(DIRECTORY, DATE, [ACTION-IF-WORKED [, ACTION-IF-NOT-WORKED]]])
+dnl
+dnl Example:
+dnl AM_PATH_FFMPEG(lib/ffmpeg, 2002-12-14 12:00 GMT)
+dnl
+dnl make sure you have a Tag file in the dir where you check out that
+dnl is the Tag of CVS you want to have checked out
+dnl it should correspond to the DATE argument you supply, ie resolve to
+dnl the same date
+dnl (in an ideal world, cvs would understand it's own Tag file format as
+dnl a date spec)
+
+AC_DEFUN([AS_SLURP_FFMPEG],
+[
+  # save original dir
+  FAILED=""
+  DIRECTORY=`pwd`
+  # get/update cvs
+  if test ! -d $1; then mkdir -p $1; fi
+  dnl we need to check $srcdir/$1 or it will always checkout ffmpeg even if it is there
+  dnl at least when top_srcdir != top_builddir.
+  dnl FIXME: unfortunately this makes the checkout go into top_srcdir
+  cd $srcdir/$1
+
+  if test ! -e ffmpeg/README; then
+    # check out cvs code
+    AC_MSG_NOTICE(checking out ffmpeg cvs code from $2 into $1)
+    cvs -Q -z4 -d:pserver:anonymous@mplayerhq.hu:/cvsroot/ffmpeg co -D '$2' ffmpeg || FAILED=yes
+  else
+    # compare against Tag file and see if it needs updating
+    if test "`cat Tag`" == "$2"; then
+      AC_MSG_NOTICE(ffmpeg cvs code in sync)
+    else
+      cd ffmpeg 
+      AC_MSG_NOTICE(updating ffmpeg cvs code to $2)
+      cvs -Q -z4 update -dP -D '$2' || FAILED=yes
+      cd ..
+    fi
+  fi
+  if test "x$FAILED" != "xyes"; then
+    echo "$2" > Tag 
+  fi
+  
+  # now go back
+  cd $DIRECTORY
+
+  if test "x$FAILED" == "xyes"; then
+    [$4]
+    false
+  else
+    [$3]
+    true
+  fi
+])
diff --git a/m4/libtool.m4 b/m4/libtool.m4
index 2ed159c..327d0bd 100644
--- a/m4/libtool.m4
+++ b/m4/libtool.m4
@@ -1,8 +1,8 @@
 # libtool.m4 - Configure libtool for the host system. -*-Autoconf-*-
 #
 #   Copyright (C) 1996, 1997, 1998, 1999, 2000, 2001, 2003, 2004, 2005,
-#                 2006, 2007, 2008, 2009, 2010 Free Software Foundation,
-#                 Inc.
+#                 2006, 2007, 2008, 2009, 2010, 2011 Free Software
+#                 Foundation, Inc.
 #   Written by Gordon Matzigkeit, 1996
 #
 # This file is free software; the Free Software Foundation gives
@@ -11,8 +11,8 @@
 
 m4_define([_LT_COPYING], [dnl
 #   Copyright (C) 1996, 1997, 1998, 1999, 2000, 2001, 2003, 2004, 2005,
-#                 2006, 2007, 2008, 2009, 2010 Free Software Foundation,
-#                 Inc.
+#                 2006, 2007, 2008, 2009, 2010, 2011 Free Software
+#                 Foundation, Inc.
 #   Written by Gordon Matzigkeit, 1996
 #
 #   This file is part of GNU Libtool.
@@ -146,6 +146,8 @@ AC_REQUIRE([AC_CANONICAL_BUILD])dnl
 AC_REQUIRE([_LT_PREPARE_SED_QUOTE_VARS])dnl
 AC_REQUIRE([_LT_PROG_ECHO_BACKSLASH])dnl
 
+_LT_DECL([], [PATH_SEPARATOR], [1], [The PATH separator for the build system])dnl
+dnl
 _LT_DECL([], [host_alias], [0], [The host system])dnl
 _LT_DECL([], [host], [0])dnl
 _LT_DECL([], [host_os], [0])dnl
@@ -637,7 +639,7 @@ m4_ifset([AC_PACKAGE_NAME], [AC_PACKAGE_NAME ])config.lt[]dnl
 m4_ifset([AC_PACKAGE_VERSION], [ AC_PACKAGE_VERSION])
 configured by $[0], generated by m4_PACKAGE_STRING.
 
-Copyright (C) 2010 Free Software Foundation, Inc.
+Copyright (C) 2011 Free Software Foundation, Inc.
 This config.lt script is free software; the Free Software Foundation
 gives unlimited permision to copy, distribute and modify it."
 
@@ -801,6 +803,7 @@ AC_DEFUN([LT_LANG],
 m4_case([$1],
   [C],			[_LT_LANG(C)],
   [C++],		[_LT_LANG(CXX)],
+  [Go],			[_LT_LANG(GO)],
   [Java],		[_LT_LANG(GCJ)],
   [Fortran 77],		[_LT_LANG(F77)],
   [Fortran],		[_LT_LANG(FC)],
@@ -822,6 +825,31 @@ m4_defun([_LT_LANG],
 ])# _LT_LANG
 
 
+m4_ifndef([AC_PROG_GO], [
+############################################################
+# NOTE: This macro has been submitted for inclusion into   #
+#  GNU Autoconf as AC_PROG_GO.  When it is available in    #
+#  a released version of Autoconf we should remove this    #
+#  macro and use it instead.                               #
+############################################################
+m4_defun([AC_PROG_GO],
+[AC_LANG_PUSH(Go)dnl
+AC_ARG_VAR([GOC],     [Go compiler command])dnl
+AC_ARG_VAR([GOFLAGS], [Go compiler flags])dnl
+_AC_ARG_VAR_LDFLAGS()dnl
+AC_CHECK_TOOL(GOC, gccgo)
+if test -z "$GOC"; then
+  if test -n "$ac_tool_prefix"; then
+    AC_CHECK_PROG(GOC, [${ac_tool_prefix}gccgo], [${ac_tool_prefix}gccgo])
+  fi
+fi
+if test -z "$GOC"; then
+  AC_CHECK_PROG(GOC, gccgo, gccgo, false)
+fi
+])#m4_defun
+])#m4_ifndef
+
+
 # _LT_LANG_DEFAULT_CONFIG
 # -----------------------
 m4_defun([_LT_LANG_DEFAULT_CONFIG],
@@ -852,6 +880,10 @@ AC_PROVIDE_IFELSE([AC_PROG_GCJ],
        m4_ifdef([LT_PROG_GCJ],
 	[m4_define([LT_PROG_GCJ], defn([LT_PROG_GCJ])[LT_LANG(GCJ)])])])])])
 
+AC_PROVIDE_IFELSE([AC_PROG_GO],
+  [LT_LANG(GO)],
+  [m4_define([AC_PROG_GO], defn([AC_PROG_GO])[LT_LANG(GO)])])
+
 AC_PROVIDE_IFELSE([LT_PROG_RC],
   [LT_LANG(RC)],
   [m4_define([LT_PROG_RC], defn([LT_PROG_RC])[LT_LANG(RC)])])
@@ -954,7 +986,13 @@ m4_defun_once([_LT_REQUIRED_DARWIN_CHECKS],[
 	$LTCC $LTCFLAGS $LDFLAGS -o libconftest.dylib \
 	  -dynamiclib -Wl,-single_module conftest.c 2>conftest.err
         _lt_result=$?
-	if test -f libconftest.dylib && test ! -s conftest.err && test $_lt_result = 0; then
+	# If there is a non-empty error log, and "single_module"
+	# appears in it, assume the flag caused a linker warning
+        if test -s conftest.err && $GREP single_module conftest.err; then
+	  cat conftest.err >&AS_MESSAGE_LOG_FD
+	# Otherwise, if the output was created with a 0 exit code from
+	# the compiler, it worked.
+	elif test -f libconftest.dylib && test $_lt_result -eq 0; then
 	  lt_cv_apple_cc_single_mod=yes
 	else
 	  cat conftest.err >&AS_MESSAGE_LOG_FD
@@ -962,6 +1000,7 @@ m4_defun_once([_LT_REQUIRED_DARWIN_CHECKS],[
 	rm -rf libconftest.dylib*
 	rm -f conftest.*
       fi])
+
     AC_CACHE_CHECK([for -exported_symbols_list linker flag],
       [lt_cv_ld_exported_symbols_list],
       [lt_cv_ld_exported_symbols_list=no
@@ -973,6 +1012,7 @@ m4_defun_once([_LT_REQUIRED_DARWIN_CHECKS],[
 	[lt_cv_ld_exported_symbols_list=no])
 	LDFLAGS="$save_LDFLAGS"
     ])
+
     AC_CACHE_CHECK([for -force_load linker flag],[lt_cv_ld_force_load],
       [lt_cv_ld_force_load=no
       cat > conftest.c << _LT_EOF
@@ -990,7 +1030,9 @@ _LT_EOF
       echo "$LTCC $LTCFLAGS $LDFLAGS -o conftest conftest.c -Wl,-force_load,./libconftest.a" >&AS_MESSAGE_LOG_FD
       $LTCC $LTCFLAGS $LDFLAGS -o conftest conftest.c -Wl,-force_load,./libconftest.a 2>conftest.err
       _lt_result=$?
-      if test -f conftest && test ! -s conftest.err && test $_lt_result = 0 && $GREP forced_load conftest 2>&1 >/dev/null; then
+      if test -s conftest.err && $GREP force_load conftest.err; then
+	cat conftest.err >&AS_MESSAGE_LOG_FD
+      elif test -f conftest && test $_lt_result -eq 0 && $GREP forced_load conftest >/dev/null 2>&1 ; then
 	lt_cv_ld_force_load=yes
       else
 	cat conftest.err >&AS_MESSAGE_LOG_FD
@@ -1035,8 +1077,8 @@ _LT_EOF
 ])
 
 
-# _LT_DARWIN_LINKER_FEATURES
-# --------------------------
+# _LT_DARWIN_LINKER_FEATURES([TAG])
+# ---------------------------------
 # Checks for linker and compiler features on darwin
 m4_defun([_LT_DARWIN_LINKER_FEATURES],
 [
@@ -1047,6 +1089,8 @@ m4_defun([_LT_DARWIN_LINKER_FEATURES],
   _LT_TAGVAR(hardcode_shlibpath_var, $1)=unsupported
   if test "$lt_cv_ld_force_load" = "yes"; then
     _LT_TAGVAR(whole_archive_flag_spec, $1)='`for conv in $convenience\"\"; do test  -n \"$conv\" && new_convenience=\"$new_convenience ${wl}-force_load,$conv\"; done; func_echo_all \"$new_convenience\"`'
+    m4_case([$1], [F77], [_LT_TAGVAR(compiler_needs_object, $1)=yes],
+                  [FC],  [_LT_TAGVAR(compiler_needs_object, $1)=yes])
   else
     _LT_TAGVAR(whole_archive_flag_spec, $1)=''
   fi
@@ -1330,14 +1374,27 @@ s390*-*linux*|s390*-*tpf*|sparc*-*linux*)
     CFLAGS="$SAVE_CFLAGS"
   fi
   ;;
-sparc*-*solaris*)
+*-*solaris*)
   # Find out which ABI we are using.
   echo 'int i;' > conftest.$ac_ext
   if AC_TRY_EVAL(ac_compile); then
     case `/usr/bin/file conftest.o` in
     *64-bit*)
       case $lt_cv_prog_gnu_ld in
-      yes*) LD="${LD-ld} -m elf64_sparc" ;;
+      yes*)
+        case $host in
+        i?86-*-solaris*)
+          LD="${LD-ld} -m elf_x86_64"
+          ;;
+        sparc*-*-solaris*)
+          LD="${LD-ld} -m elf64_sparc"
+          ;;
+        esac
+        # GNU ld 2.21 introduced _sol2 emulations.  Use them if available.
+        if ${LD-ld} -V | grep _sol2 >/dev/null 2>&1; then
+          LD="${LD-ld}_sol2"
+        fi
+        ;;
       *)
 	if ${LD-ld} -64 -r -o conftest2.o conftest.o >/dev/null 2>&1; then
 	  LD="${LD-ld} -64"
@@ -1414,13 +1471,13 @@ old_postuninstall_cmds=
 if test -n "$RANLIB"; then
   case $host_os in
   openbsd*)
-    old_postinstall_cmds="$old_postinstall_cmds~\$RANLIB -t \$oldlib"
+    old_postinstall_cmds="$old_postinstall_cmds~\$RANLIB -t \$tool_oldlib"
     ;;
   *)
-    old_postinstall_cmds="$old_postinstall_cmds~\$RANLIB \$oldlib"
+    old_postinstall_cmds="$old_postinstall_cmds~\$RANLIB \$tool_oldlib"
     ;;
   esac
-  old_archive_cmds="$old_archive_cmds~\$RANLIB \$oldlib"
+  old_archive_cmds="$old_archive_cmds~\$RANLIB \$tool_oldlib"
 fi
 
 case $host_os in
@@ -1600,6 +1657,11 @@ AC_CACHE_VAL([lt_cv_sys_max_cmd_len], [dnl
     lt_cv_sys_max_cmd_len=196608
     ;;
 
+  os2*)
+    # The test takes a long time on OS/2.
+    lt_cv_sys_max_cmd_len=8192
+    ;;
+
   osf*)
     # Dr. Hans Ekkehard Plesser reports seeing a kernel panic running configure
     # due to this test when exec_disable_arg_limit is 1 on Tru64. It is not
@@ -1639,7 +1701,7 @@ AC_CACHE_VAL([lt_cv_sys_max_cmd_len], [dnl
       # If test is not a shell built-in, we'll probably end up computing a
       # maximum length that is only half of the actual maximum length, but
       # we can't tell.
-      while { test "X"`func_fallback_echo "$teststring$teststring" 2>/dev/null` \
+      while { test "X"`env echo "$teststring$teststring" 2>/dev/null` \
 	         = "X$teststring$teststring"; } >/dev/null 2>&1 &&
 	      test $i != 17 # 1/2 MB should be enough
       do
@@ -2185,7 +2247,7 @@ need_version=unknown
 
 case $host_os in
 aix3*)
-  version_type=linux
+  version_type=linux # correct to gnu/linux during the next big refactor
   library_names_spec='${libname}${release}${shared_ext}$versuffix $libname.a'
   shlibpath_var=LIBPATH
 
@@ -2194,7 +2256,7 @@ aix3*)
   ;;
 
 aix[[4-9]]*)
-  version_type=linux
+  version_type=linux # correct to gnu/linux during the next big refactor
   need_lib_prefix=no
   need_version=no
   hardcode_into_libs=yes
@@ -2259,7 +2321,7 @@ beos*)
   ;;
 
 bsdi[[45]]*)
-  version_type=linux
+  version_type=linux # correct to gnu/linux during the next big refactor
   need_version=no
   library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext}$major $libname${shared_ext}'
   soname_spec='${libname}${release}${shared_ext}$major'
@@ -2398,7 +2460,7 @@ m4_if([$1], [],[
   ;;
 
 dgux*)
-  version_type=linux
+  version_type=linux # correct to gnu/linux during the next big refactor
   need_lib_prefix=no
   need_version=no
   library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext}$major $libname$shared_ext'
@@ -2406,10 +2468,6 @@ dgux*)
   shlibpath_var=LD_LIBRARY_PATH
   ;;
 
-freebsd1*)
-  dynamic_linker=no
-  ;;
-
 freebsd* | dragonfly*)
   # DragonFly does not have aout.  When/if they implement a new
   # versioning mechanism, adjust this.
@@ -2417,18 +2475,11 @@ freebsd* | dragonfly*)
     objformat=`/usr/bin/objformat`
   else
     case $host_os in
-    freebsd[[123]]*) objformat=aout ;;
+    freebsd[[23]].*) objformat=aout ;;
     *) objformat=elf ;;
     esac
   fi
-  # Handle Gentoo/FreeBSD as it was Linux
-  case $host_vendor in
-    gentoo)
-      version_type=linux ;;
-    *)
-      version_type=freebsd-$objformat ;;
-  esac
-
+  version_type=freebsd-$objformat
   case $version_type in
     freebsd-elf*)
       library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext} $libname${shared_ext}'
@@ -2439,16 +2490,10 @@ freebsd* | dragonfly*)
       library_names_spec='${libname}${release}${shared_ext}$versuffix $libname${shared_ext}$versuffix'
       need_version=yes
       ;;
-    linux)
-      library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext}$major ${libname}${shared_ext}'
-      soname_spec='${libname}${release}${shared_ext}$major'
-      need_lib_prefix=no
-      need_version=no
-      ;;
   esac
   shlibpath_var=LD_LIBRARY_PATH
   case $host_os in
-  freebsd2*)
+  freebsd2.*)
     shlibpath_overrides_runpath=yes
     ;;
   freebsd3.[[01]]* | freebsdelf3.[[01]]*)
@@ -2468,17 +2513,18 @@ freebsd* | dragonfly*)
   ;;
 
 gnu*)
-  version_type=linux
+  version_type=linux # correct to gnu/linux during the next big refactor
   need_lib_prefix=no
   need_version=no
   library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext}${major} ${libname}${shared_ext}'
   soname_spec='${libname}${release}${shared_ext}$major'
   shlibpath_var=LD_LIBRARY_PATH
+  shlibpath_overrides_runpath=no
   hardcode_into_libs=yes
   ;;
 
 haiku*)
-  version_type=linux
+  version_type=linux # correct to gnu/linux during the next big refactor
   need_lib_prefix=no
   need_version=no
   dynamic_linker="$host_os runtime_loader"
@@ -2539,7 +2585,7 @@ hpux9* | hpux10* | hpux11*)
   ;;
 
 interix[[3-9]]*)
-  version_type=linux
+  version_type=linux # correct to gnu/linux during the next big refactor
   need_lib_prefix=no
   need_version=no
   library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext}$major ${libname}${shared_ext}'
@@ -2555,7 +2601,7 @@ irix5* | irix6* | nonstopux*)
     nonstopux*) version_type=nonstopux ;;
     *)
 	if test "$lt_cv_prog_gnu_ld" = yes; then
-		version_type=linux
+		version_type=linux # correct to gnu/linux during the next big refactor
 	else
 		version_type=irix
 	fi ;;
@@ -2592,9 +2638,9 @@ linux*oldld* | linux*aout* | linux*coff*)
   dynamic_linker=no
   ;;
 
-# This must be Linux ELF.
+# This must be glibc/ELF.
 linux* | k*bsd*-gnu | kopensolaris*-gnu)
-  version_type=linux
+  version_type=linux # correct to gnu/linux during the next big refactor
   need_lib_prefix=no
   need_version=no
   library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext}$major $libname${shared_ext}'
@@ -2657,7 +2703,7 @@ netbsd*)
   ;;
 
 newsos6)
-  version_type=linux
+  version_type=linux # correct to gnu/linux during the next big refactor
   library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext}$major $libname${shared_ext}'
   shlibpath_var=LD_LIBRARY_PATH
   shlibpath_overrides_runpath=yes
@@ -2726,7 +2772,7 @@ rdos*)
   ;;
 
 solaris*)
-  version_type=linux
+  version_type=linux # correct to gnu/linux during the next big refactor
   need_lib_prefix=no
   need_version=no
   library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext}$major $libname${shared_ext}'
@@ -2751,7 +2797,7 @@ sunos4*)
   ;;
 
 sysv4 | sysv4.3*)
-  version_type=linux
+  version_type=linux # correct to gnu/linux during the next big refactor
   library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext}$major $libname${shared_ext}'
   soname_spec='${libname}${release}${shared_ext}$major'
   shlibpath_var=LD_LIBRARY_PATH
@@ -2775,7 +2821,7 @@ sysv4 | sysv4.3*)
 
 sysv4*MP*)
   if test -d /usr/nec ;then
-    version_type=linux
+    version_type=linux # correct to gnu/linux during the next big refactor
     library_names_spec='$libname${shared_ext}.$versuffix $libname${shared_ext}.$major $libname${shared_ext}'
     soname_spec='$libname${shared_ext}.$major'
     shlibpath_var=LD_LIBRARY_PATH
@@ -2806,7 +2852,7 @@ sysv5* | sco3.2v5* | sco5v6* | unixware* | OpenUNIX* | sysv4*uw2*)
 
 tpf*)
   # TPF is a cross-target only.  Preferred cross-host = GNU/Linux.
-  version_type=linux
+  version_type=linux # correct to gnu/linux during the next big refactor
   need_lib_prefix=no
   need_version=no
   library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext}$major $libname${shared_ext}'
@@ -2816,7 +2862,7 @@ tpf*)
   ;;
 
 uts4*)
-  version_type=linux
+  version_type=linux # correct to gnu/linux during the next big refactor
   library_names_spec='${libname}${release}${shared_ext}$versuffix ${libname}${release}${shared_ext}$major $libname${shared_ext}'
   soname_spec='${libname}${release}${shared_ext}$major'
   shlibpath_var=LD_LIBRARY_PATH
@@ -3238,7 +3284,7 @@ irix5* | irix6* | nonstopux*)
   lt_cv_deplibs_check_method=pass_all
   ;;
 
-# This must be Linux ELF.
+# This must be glibc/ELF.
 linux* | k*bsd*-gnu | kopensolaris*-gnu)
   lt_cv_deplibs_check_method=pass_all
   ;;
@@ -3658,6 +3704,7 @@ for ac_symprfx in "" "_"; do
     # which start with @ or ?.
     lt_cv_sys_global_symbol_pipe="$AWK ['"\
 "     {last_section=section; section=\$ 3};"\
+"     /^COFF SYMBOL TABLE/{for(i in hide) delete hide[i]};"\
 "     /Section length .*#relocs.*(pick any)/{hide[last_section]=1};"\
 "     \$ 0!~/External *\|/{next};"\
 "     / 0+ UNDEF /{next}; / UNDEF \([^|]\)*()/{next};"\
@@ -4242,7 +4289,9 @@ m4_if([$1], [CXX], [
     case $cc_basename in
     nvcc*) # Cuda Compiler Driver 2.2
       _LT_TAGVAR(lt_prog_compiler_wl, $1)='-Xlinker '
-      _LT_TAGVAR(lt_prog_compiler_pic, $1)='-Xcompiler -fPIC'
+      if test -n "$_LT_TAGVAR(lt_prog_compiler_pic, $1)"; then
+        _LT_TAGVAR(lt_prog_compiler_pic, $1)="-Xcompiler $_LT_TAGVAR(lt_prog_compiler_pic, $1)"
+      fi
       ;;
     esac
   else
@@ -4334,18 +4383,33 @@ m4_if([$1], [CXX], [
 	;;
       *)
 	case `$CC -V 2>&1 | sed 5q` in
-	*Sun\ F* | *Sun*Fortran*)
+	*Sun\ Ceres\ Fortran* | *Sun*Fortran*\ [[1-7]].* | *Sun*Fortran*\ 8.[[0-3]]*)
 	  # Sun Fortran 8.3 passes all unrecognized flags to the linker
 	  _LT_TAGVAR(lt_prog_compiler_pic, $1)='-KPIC'
 	  _LT_TAGVAR(lt_prog_compiler_static, $1)='-Bstatic'
 	  _LT_TAGVAR(lt_prog_compiler_wl, $1)=''
 	  ;;
+	*Sun\ F* | *Sun*Fortran*)
+	  _LT_TAGVAR(lt_prog_compiler_pic, $1)='-KPIC'
+	  _LT_TAGVAR(lt_prog_compiler_static, $1)='-Bstatic'
+	  _LT_TAGVAR(lt_prog_compiler_wl, $1)='-Qoption ld '
+	  ;;
 	*Sun\ C*)
 	  # Sun C 5.9
 	  _LT_TAGVAR(lt_prog_compiler_pic, $1)='-KPIC'
 	  _LT_TAGVAR(lt_prog_compiler_static, $1)='-Bstatic'
 	  _LT_TAGVAR(lt_prog_compiler_wl, $1)='-Wl,'
 	  ;;
+        *Intel*\ [[CF]]*Compiler*)
+	  _LT_TAGVAR(lt_prog_compiler_wl, $1)='-Wl,'
+	  _LT_TAGVAR(lt_prog_compiler_pic, $1)='-fPIC'
+	  _LT_TAGVAR(lt_prog_compiler_static, $1)='-static'
+	  ;;
+	*Portland\ Group*)
+	  _LT_TAGVAR(lt_prog_compiler_wl, $1)='-Wl,'
+	  _LT_TAGVAR(lt_prog_compiler_pic, $1)='-fpic'
+	  _LT_TAGVAR(lt_prog_compiler_static, $1)='-Bstatic'
+	  ;;
 	esac
 	;;
       esac
@@ -4505,7 +4569,9 @@ m4_if([$1], [CXX], [
     ;;
   cygwin* | mingw* | cegcc*)
     case $cc_basename in
-    cl*) ;;
+    cl*)
+      _LT_TAGVAR(exclude_expsyms, $1)='_NULL_IMPORT_DESCRIPTOR|_IMPORT_DESCRIPTOR_.*'
+      ;;
     *)
       _LT_TAGVAR(export_symbols_cmds, $1)='$NM $libobjs $convenience | $global_symbol_pipe | $SED -e '\''/^[[BCDGRS]][[ ]]/s/.*[[ ]]\([[^ ]]*\)/\1 DATA/;s/^.*[[ ]]__nm__\([[^ ]]*\)[[ ]][[^ ]]*/\1 DATA/;/^I[[ ]]/d;/^[[AITW]][[ ]]/s/.* //'\'' | sort | uniq > $export_symbols'
       _LT_TAGVAR(exclude_expsyms, $1)=['[_]+GLOBAL_OFFSET_TABLE_|[_]+GLOBAL__[FID]_.*|[_]+head_[A-Za-z0-9_]+_dll|[A-Za-z0-9_]+_dll_iname']
@@ -4530,7 +4596,6 @@ m4_if([$1], [CXX], [
   _LT_TAGVAR(hardcode_direct, $1)=no
   _LT_TAGVAR(hardcode_direct_absolute, $1)=no
   _LT_TAGVAR(hardcode_libdir_flag_spec, $1)=
-  _LT_TAGVAR(hardcode_libdir_flag_spec_ld, $1)=
   _LT_TAGVAR(hardcode_libdir_separator, $1)=
   _LT_TAGVAR(hardcode_minus_L, $1)=no
   _LT_TAGVAR(hardcode_shlibpath_var, $1)=unsupported
@@ -4781,8 +4846,7 @@ _LT_EOF
 	xlf* | bgf* | bgxlf* | mpixlf*)
 	  # IBM XL Fortran 10.1 on PPC cannot create shared libs itself
 	  _LT_TAGVAR(whole_archive_flag_spec, $1)='--whole-archive$convenience --no-whole-archive'
-	  _LT_TAGVAR(hardcode_libdir_flag_spec, $1)=
-	  _LT_TAGVAR(hardcode_libdir_flag_spec_ld, $1)='-rpath $libdir'
+	  _LT_TAGVAR(hardcode_libdir_flag_spec, $1)='${wl}-rpath ${wl}$libdir'
 	  _LT_TAGVAR(archive_cmds, $1)='$LD -shared $libobjs $deplibs $linker_flags -soname $soname -o $lib'
 	  if test "x$supports_anon_versioning" = xyes; then
 	    _LT_TAGVAR(archive_expsym_cmds, $1)='echo "{ global:" > $output_objdir/$libname.ver~
@@ -5077,6 +5141,7 @@ _LT_EOF
 	# The linker will not automatically build a static lib if we build a DLL.
 	# _LT_TAGVAR(old_archive_from_new_cmds, $1)='true'
 	_LT_TAGVAR(enable_shared_with_static_runtimes, $1)=yes
+	_LT_TAGVAR(exclude_expsyms, $1)='_NULL_IMPORT_DESCRIPTOR|_IMPORT_DESCRIPTOR_.*'
 	_LT_TAGVAR(export_symbols_cmds, $1)='$NM $libobjs $convenience | $global_symbol_pipe | $SED -e '\''/^[[BCDGRS]][[ ]]/s/.*[[ ]]\([[^ ]]*\)/\1,DATA/'\'' | $SED -e '\''/^[[AITW]][[ ]]/s/.*[[ ]]//'\'' | sort | uniq > $export_symbols'
 	# Don't use ranlib
 	_LT_TAGVAR(old_postinstall_cmds, $1)='chmod 644 $oldlib'
@@ -5123,10 +5188,6 @@ _LT_EOF
       _LT_TAGVAR(hardcode_shlibpath_var, $1)=no
       ;;
 
-    freebsd1*)
-      _LT_TAGVAR(ld_shlibs, $1)=no
-      ;;
-
     # FreeBSD 2.2.[012] allows us to include c++rt0.o to get C++ constructor
     # support.  Future versions do this automatically, but an explicit c++rt0.o
     # does not break anything, and helps significantly (at the cost of a little
@@ -5139,7 +5200,7 @@ _LT_EOF
       ;;
 
     # Unfortunately, older versions of FreeBSD 2 do not have this feature.
-    freebsd2*)
+    freebsd2.*)
       _LT_TAGVAR(archive_cmds, $1)='$LD -Bshareable -o $lib $libobjs $deplibs $linker_flags'
       _LT_TAGVAR(hardcode_direct, $1)=yes
       _LT_TAGVAR(hardcode_minus_L, $1)=yes
@@ -5178,7 +5239,6 @@ _LT_EOF
       fi
       if test "$with_gnu_ld" = no; then
 	_LT_TAGVAR(hardcode_libdir_flag_spec, $1)='${wl}+b ${wl}$libdir'
-	_LT_TAGVAR(hardcode_libdir_flag_spec_ld, $1)='+b $libdir'
 	_LT_TAGVAR(hardcode_libdir_separator, $1)=:
 	_LT_TAGVAR(hardcode_direct, $1)=yes
 	_LT_TAGVAR(hardcode_direct_absolute, $1)=yes
@@ -5620,9 +5680,6 @@ _LT_TAGDECL([], [no_undefined_flag], [1],
 _LT_TAGDECL([], [hardcode_libdir_flag_spec], [1],
     [Flag to hardcode $libdir into a binary during linking.
     This must work even if $libdir does not exist])
-_LT_TAGDECL([], [hardcode_libdir_flag_spec_ld], [1],
-    [[If ld is used when linking, flag to hardcode $libdir into a binary
-    during linking.  This must work even if $libdir does not exist]])
 _LT_TAGDECL([], [hardcode_libdir_separator], [1],
     [Whether we need a single "-rpath" flag with a separated argument])
 _LT_TAGDECL([], [hardcode_direct], [0],
@@ -5780,7 +5837,6 @@ _LT_TAGVAR(export_dynamic_flag_spec, $1)=
 _LT_TAGVAR(hardcode_direct, $1)=no
 _LT_TAGVAR(hardcode_direct_absolute, $1)=no
 _LT_TAGVAR(hardcode_libdir_flag_spec, $1)=
-_LT_TAGVAR(hardcode_libdir_flag_spec_ld, $1)=
 _LT_TAGVAR(hardcode_libdir_separator, $1)=
 _LT_TAGVAR(hardcode_minus_L, $1)=no
 _LT_TAGVAR(hardcode_shlibpath_var, $1)=unsupported
@@ -5863,8 +5919,13 @@ if test "$_lt_caught_CXX_error" != yes; then
       # Check if GNU C++ uses GNU ld as the underlying linker, since the
       # archiving commands below assume that GNU ld is being used.
       if test "$with_gnu_ld" = yes; then
-        _LT_TAGVAR(archive_cmds, $1)='$CC $pic_flag -shared -nostdlib $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags ${wl}-soname $wl$soname -o $lib'
-        _LT_TAGVAR(archive_expsym_cmds, $1)='$CC $pic_flag -shared -nostdlib $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags ${wl}-soname $wl$soname ${wl}-retain-symbols-file $wl$export_symbols -o $lib'
+        if test "$cross_compiling" = yes; then
+          _LT_TAGVAR(archive_cmds, $1)='$CC $pic_flag $compiler_flags -shared $libobjs $deplibs ${wl}-soname $wl$soname -o $lib'
+          _LT_TAGVAR(archive_expsym_cmds, $1)='$CC $pic_flag $compiler_flags -shared $libobjs $deplibs ${wl}-soname $wl$soname ${wl}-retain-symbols-file $wl$export_symbols -o $lib'
+        else
+          _LT_TAGVAR(archive_cmds, $1)='$CC $pic_flag -shared -nostdlib $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags ${wl}-soname $wl$soname -o $lib'
+          _LT_TAGVAR(archive_expsym_cmds, $1)='$CC $pic_flag -shared -nostdlib $predep_objects $libobjs $deplibs $postdep_objects $compiler_flags ${wl}-soname $wl$soname ${wl}-retain-symbols-file $wl$export_symbols -o $lib'
+        fi
 
         _LT_TAGVAR(hardcode_libdir_flag_spec, $1)='${wl}-rpath ${wl}$libdir'
         _LT_TAGVAR(export_dynamic_flag_spec, $1)='${wl}--export-dynamic'
@@ -6150,7 +6211,7 @@ if test "$_lt_caught_CXX_error" != yes; then
         esac
         ;;
 
-      freebsd[[12]]*)
+      freebsd2.*)
         # C++ shared libraries reported to be fairly broken before
 	# switch to ELF
         _LT_TAGVAR(ld_shlibs, $1)=no
@@ -6911,12 +6972,18 @@ public class foo {
   }
 };
 _LT_EOF
+], [$1], [GO], [cat > conftest.$ac_ext <<_LT_EOF
+package foo
+func foo() {
+}
+_LT_EOF
 ])
 
 _lt_libdeps_save_CFLAGS=$CFLAGS
 case "$CC $CFLAGS " in #(
 *\ -flto*\ *) CFLAGS="$CFLAGS -fno-lto" ;;
 *\ -fwhopr*\ *) CFLAGS="$CFLAGS -fno-whopr" ;;
+*\ -fuse-linker-plugin*\ *) CFLAGS="$CFLAGS -fno-use-linker-plugin" ;;
 esac
 
 dnl Parse the compiler output and extract the necessary
@@ -6955,23 +7022,27 @@ if AC_TRY_EVAL(ac_compile); then
        if test "$pre_test_object_deps_done" = no; then
 	 case ${prev} in
 	 -L | -R)
-	   # Internal compiler library paths should come after those
-	   # provided the user.  The postdeps already come after the
-	   # user supplied libs so there is no need to process them.
-	   if test -z "$_LT_TAGVAR(compiler_lib_search_path, $1)"; then
-	     _LT_TAGVAR(compiler_lib_search_path, $1)="${prev}${p}"
-	   else
-	     _LT_TAGVAR(compiler_lib_search_path, $1)="${_LT_TAGVAR(compiler_lib_search_path, $1)} ${prev}${p}"
+	   if test "$cross_compiling" != yes; then
+	     # Internal compiler library paths should come after those
+	     # provided the user.  The postdeps already come after the
+	     # user supplied libs so there is no need to process them.
+	     if test -z "$_LT_TAGVAR(compiler_lib_search_path, $1)"; then
+	       _LT_TAGVAR(compiler_lib_search_path, $1)="${prev}${p}"
+	     else
+	       _LT_TAGVAR(compiler_lib_search_path, $1)="${_LT_TAGVAR(compiler_lib_search_path, $1)} ${prev}${p}"
+	     fi
 	   fi
 	   ;;
 	 # The "-l" case would never come before the object being
 	 # linked, so don't bother handling this case.
 	 esac
        else
-	 if test -z "$_LT_TAGVAR(postdeps, $1)"; then
-	   _LT_TAGVAR(postdeps, $1)="${prev}${p}"
-	 else
-	   _LT_TAGVAR(postdeps, $1)="${_LT_TAGVAR(postdeps, $1)} ${prev}${p}"
+	 if test "$cross_compiling" != yes; then
+	   if test -z "$_LT_TAGVAR(postdeps, $1)"; then
+	     _LT_TAGVAR(postdeps, $1)="${prev}${p}"
+	   else
+	     _LT_TAGVAR(postdeps, $1)="${_LT_TAGVAR(postdeps, $1)} ${prev}${p}"
+	   fi
 	 fi
        fi
        prev=
@@ -6986,17 +7057,19 @@ if AC_TRY_EVAL(ac_compile); then
 	 continue
        fi
 
-       if test "$pre_test_object_deps_done" = no; then
-	 if test -z "$_LT_TAGVAR(predep_objects, $1)"; then
-	   _LT_TAGVAR(predep_objects, $1)="$p"
-	 else
-	   _LT_TAGVAR(predep_objects, $1)="$_LT_TAGVAR(predep_objects, $1) $p"
-	 fi
-       else
-	 if test -z "$_LT_TAGVAR(postdep_objects, $1)"; then
-	   _LT_TAGVAR(postdep_objects, $1)="$p"
+       if test "$cross_compiling" != yes; then
+	 if test "$pre_test_object_deps_done" = no; then
+	   if test -z "$_LT_TAGVAR(predep_objects, $1)"; then
+	     _LT_TAGVAR(predep_objects, $1)="$p"
+	   else
+	     _LT_TAGVAR(predep_objects, $1)="$_LT_TAGVAR(predep_objects, $1) $p"
+	   fi
 	 else
-	   _LT_TAGVAR(postdep_objects, $1)="$_LT_TAGVAR(postdep_objects, $1) $p"
+	   if test -z "$_LT_TAGVAR(postdep_objects, $1)"; then
+	     _LT_TAGVAR(postdep_objects, $1)="$p"
+	   else
+	     _LT_TAGVAR(postdep_objects, $1)="$_LT_TAGVAR(postdep_objects, $1) $p"
+	   fi
 	 fi
        fi
        ;;
@@ -7113,7 +7186,6 @@ _LT_TAGVAR(export_dynamic_flag_spec, $1)=
 _LT_TAGVAR(hardcode_direct, $1)=no
 _LT_TAGVAR(hardcode_direct_absolute, $1)=no
 _LT_TAGVAR(hardcode_libdir_flag_spec, $1)=
-_LT_TAGVAR(hardcode_libdir_flag_spec_ld, $1)=
 _LT_TAGVAR(hardcode_libdir_separator, $1)=
 _LT_TAGVAR(hardcode_minus_L, $1)=no
 _LT_TAGVAR(hardcode_automatic, $1)=no
@@ -7246,7 +7318,6 @@ _LT_TAGVAR(export_dynamic_flag_spec, $1)=
 _LT_TAGVAR(hardcode_direct, $1)=no
 _LT_TAGVAR(hardcode_direct_absolute, $1)=no
 _LT_TAGVAR(hardcode_libdir_flag_spec, $1)=
-_LT_TAGVAR(hardcode_libdir_flag_spec_ld, $1)=
 _LT_TAGVAR(hardcode_libdir_separator, $1)=
 _LT_TAGVAR(hardcode_minus_L, $1)=no
 _LT_TAGVAR(hardcode_automatic, $1)=no
@@ -7433,6 +7504,77 @@ CFLAGS=$lt_save_CFLAGS
 ])# _LT_LANG_GCJ_CONFIG
 
 
+# _LT_LANG_GO_CONFIG([TAG])
+# --------------------------
+# Ensure that the configuration variables for the GNU Go compiler
+# are suitably defined.  These variables are subsequently used by _LT_CONFIG
+# to write the compiler configuration to `libtool'.
+m4_defun([_LT_LANG_GO_CONFIG],
+[AC_REQUIRE([LT_PROG_GO])dnl
+AC_LANG_SAVE
+
+# Source file extension for Go test sources.
+ac_ext=go
+
+# Object file extension for compiled Go test sources.
+objext=o
+_LT_TAGVAR(objext, $1)=$objext
+
+# Code to be used in simple compile tests
+lt_simple_compile_test_code="package main; func main() { }"
+
+# Code to be used in simple link tests
+lt_simple_link_test_code='package main; func main() { }'
+
+# ltmain only uses $CC for tagged configurations so make sure $CC is set.
+_LT_TAG_COMPILER
+
+# save warnings/boilerplate of simple test code
+_LT_COMPILER_BOILERPLATE
+_LT_LINKER_BOILERPLATE
+
+# Allow CC to be a program name with arguments.
+lt_save_CC=$CC
+lt_save_CFLAGS=$CFLAGS
+lt_save_GCC=$GCC
+GCC=yes
+CC=${GOC-"gccgo"}
+CFLAGS=$GOFLAGS
+compiler=$CC
+_LT_TAGVAR(compiler, $1)=$CC
+_LT_TAGVAR(LD, $1)="$LD"
+_LT_CC_BASENAME([$compiler])
+
+# Go did not exist at the time GCC didn't implicitly link libc in.
+_LT_TAGVAR(archive_cmds_need_lc, $1)=no
+
+_LT_TAGVAR(old_archive_cmds, $1)=$old_archive_cmds
+_LT_TAGVAR(reload_flag, $1)=$reload_flag
+_LT_TAGVAR(reload_cmds, $1)=$reload_cmds
+
+## CAVEAT EMPTOR:
+## There is no encapsulation within the following macros, do not change
+## the running order or otherwise move them around unless you know exactly
+## what you are doing...
+if test -n "$compiler"; then
+  _LT_COMPILER_NO_RTTI($1)
+  _LT_COMPILER_PIC($1)
+  _LT_COMPILER_C_O($1)
+  _LT_COMPILER_FILE_LOCKS($1)
+  _LT_LINKER_SHLIBS($1)
+  _LT_LINKER_HARDCODE_LIBPATH($1)
+
+  _LT_CONFIG($1)
+fi
+
+AC_LANG_RESTORE
+
+GCC=$lt_save_GCC
+CC=$lt_save_CC
+CFLAGS=$lt_save_CFLAGS
+])# _LT_LANG_GO_CONFIG
+
+
 # _LT_LANG_RC_CONFIG([TAG])
 # -------------------------
 # Ensure that the configuration variables for the Windows resource compiler
@@ -7502,6 +7644,13 @@ dnl aclocal-1.4 backwards compatibility:
 dnl AC_DEFUN([LT_AC_PROG_GCJ], [])
 
 
+# LT_PROG_GO
+# ----------
+AC_DEFUN([LT_PROG_GO],
+[AC_CHECK_TOOL(GOC, gccgo,)
+])
+
+
 # LT_PROG_RC
 # ----------
 AC_DEFUN([LT_PROG_RC],
diff --git a/m4/ltoptions.m4 b/m4/ltoptions.m4
index 17cfd51..5d9acd8 100644
--- a/m4/ltoptions.m4
+++ b/m4/ltoptions.m4
@@ -326,9 +326,24 @@ dnl AC_DEFUN([AM_DISABLE_FAST_INSTALL], [])
 # MODE is either `yes' or `no'.  If omitted, it defaults to `both'.
 m4_define([_LT_WITH_PIC],
 [AC_ARG_WITH([pic],
-    [AS_HELP_STRING([--with-pic],
+    [AS_HELP_STRING([--with-pic@<:@=PKGS@:>@],
 	[try to use only PIC/non-PIC objects @<:@default=use both@:>@])],
-    [pic_mode="$withval"],
+    [lt_p=${PACKAGE-default}
+    case $withval in
+    yes|no) pic_mode=$withval ;;
+    *)
+      pic_mode=default
+      # Look at the argument we got.  We use all the common list separators.
+      lt_save_ifs="$IFS"; IFS="${IFS}$PATH_SEPARATOR,"
+      for lt_pkg in $withval; do
+	IFS="$lt_save_ifs"
+	if test "X$lt_pkg" = "X$lt_p"; then
+	  pic_mode=yes
+	fi
+      done
+      IFS="$lt_save_ifs"
+      ;;
+    esac],
     [pic_mode=default])
 
 test -z "$pic_mode" && pic_mode=m4_default([$1], [default])
diff --git a/m4/ltversion.m4 b/m4/ltversion.m4
index 9c7b5d4..07a8602 100644
--- a/m4/ltversion.m4
+++ b/m4/ltversion.m4
@@ -9,15 +9,15 @@
 
 # @configure_input@
 
-# serial 3293 ltversion.m4
+# serial 3337 ltversion.m4
 # This file is part of GNU Libtool
 
-m4_define([LT_PACKAGE_VERSION], [2.4])
-m4_define([LT_PACKAGE_REVISION], [1.3293])
+m4_define([LT_PACKAGE_VERSION], [2.4.2])
+m4_define([LT_PACKAGE_REVISION], [1.3337])
 
 AC_DEFUN([LTVERSION_VERSION],
-[macro_version='2.4'
-macro_revision='1.3293'
+[macro_version='2.4.2'
+macro_revision='1.3337'
 _LT_DECL(, macro_version, 0, [Which release of libtool.m4 was used?])
 _LT_DECL(, macro_revision, 0)
 ])
diff --git a/tests/Makefile.in b/tests/Makefile.in
index d8b4e72..72e8930 100644
--- a/tests/Makefile.in
+++ b/tests/Makefile.in
@@ -1,9 +1,8 @@
-# Makefile.in generated by automake 1.11.1 from Makefile.am.
+# Makefile.in generated by automake 1.12.6 from Makefile.am.
 # @configure_input@
 
-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
-# Inc.
+# Copyright (C) 1994-2012 Free Software Foundation, Inc.
+
 # This Makefile.in is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
@@ -15,6 +14,23 @@
 
 @SET_MAKE@
 VPATH = @srcdir@
+am__make_dryrun = \
+  { \
+    am__dry=no; \
+    case $$MAKEFLAGS in \
+      *\\[\ \	]*) \
+        echo 'am--echo: ; @echo "AM"  OK' | $(MAKE) -f - 2>/dev/null \
+          | grep '^AM OK$$' >/dev/null || am__dry=yes;; \
+      *) \
+        for am__flg in $$MAKEFLAGS; do \
+          case $$am__flg in \
+            *=*|--*) ;; \
+            *n*) am__dry=yes; break;; \
+          esac; \
+        done;; \
+    esac; \
+    test $$am__dry = yes; \
+  }
 pkgdatadir = $(datadir)/@PACKAGE@
 pkgincludedir = $(includedir)/@PACKAGE@
 pkglibdir = $(libdir)/@PACKAGE@
@@ -33,6 +49,7 @@ PRE_UNINSTALL = :
 POST_UNINSTALL = :
 build_triplet = @build@
 host_triplet = @host@
+target_triplet = @target@
 subdir = tests
 DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
 ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
@@ -63,12 +80,18 @@ mkinstalldirs = $(install_sh) -d
 CONFIG_HEADER = $(top_builddir)/config.h
 CONFIG_CLEAN_FILES =
 CONFIG_CLEAN_VPATH_FILES =
-AM_V_GEN = $(am__v_GEN_$(V))
-am__v_GEN_ = $(am__v_GEN_$(AM_DEFAULT_VERBOSITY))
-am__v_GEN_0 = @echo "  GEN   " $@;
-AM_V_at = $(am__v_at_$(V))
-am__v_at_ = $(am__v_at_$(AM_DEFAULT_VERBOSITY))
+AM_V_P = $(am__v_P_@AM_V@)
+am__v_P_ = $(am__v_P_@AM_DEFAULT_V@)
+am__v_P_0 = false
+am__v_P_1 = :
+AM_V_GEN = $(am__v_GEN_@AM_V@)
+am__v_GEN_ = $(am__v_GEN_@AM_DEFAULT_V@)
+am__v_GEN_0 = @echo "  GEN     " $@;
+am__v_GEN_1 = 
+AM_V_at = $(am__v_at_@AM_V@)
+am__v_at_ = $(am__v_at_@AM_DEFAULT_V@)
 am__v_at_0 = @
+am__v_at_1 = 
 SOURCES =
 DIST_SOURCES =
 RECURSIVE_TARGETS = all-recursive check-recursive dvi-recursive \
@@ -78,6 +101,11 @@ RECURSIVE_TARGETS = all-recursive check-recursive dvi-recursive \
 	install-pdf-recursive install-ps-recursive install-recursive \
 	installcheck-recursive installdirs-recursive pdf-recursive \
 	ps-recursive uninstall-recursive
+am__can_run_installinfo = \
+  case $$AM_UPDATE_INFO_DIR in \
+    n|no|NO) false;; \
+    *) (install-info --version) >/dev/null 2>&1;; \
+  esac
 RECURSIVE_CLEAN_TARGETS = mostlyclean-recursive clean-recursive	\
   distclean-recursive maintainer-clean-recursive
 AM_RECURSIVE_TARGETS = $(RECURSIVE_TARGETS:-recursive=) \
@@ -304,7 +332,11 @@ sbindir = @sbindir@
 sharedstatedir = @sharedstatedir@
 srcdir = @srcdir@
 sysconfdir = @sysconfdir@
+target = @target@
 target_alias = @target_alias@
+target_cpu = @target_cpu@
+target_os = @target_os@
+target_vendor = @target_vendor@
 top_build_prefix = @top_build_prefix@
 top_builddir = @top_builddir@
 top_srcdir = @top_srcdir@
@@ -353,12 +385,12 @@ clean-libtool:
 	-rm -rf .libs _libs
 
 # This directory's subdirectories are mostly independent; you can cd
-# into them and run `make' without going through this Makefile.
-# To change the values of `make' variables: instead of editing Makefiles,
-# (1) if the variable is set in `config.status', edit `config.status'
-#     (which will cause the Makefiles to be regenerated when you run `make');
-# (2) otherwise, pass the desired values on the `make' command line.
-$(RECURSIVE_TARGETS):
+# into them and run 'make' without going through this Makefile.
+# To change the values of 'make' variables: instead of editing Makefiles,
+# (1) if the variable is set in 'config.status', edit 'config.status'
+#     (which will cause the Makefiles to be regenerated when you run 'make');
+# (2) otherwise, pass the desired values on the 'make' command line.
+$(RECURSIVE_TARGETS) $(RECURSIVE_CLEAN_TARGETS):
 	@fail= failcom='exit 1'; \
 	for f in x $$MAKEFLAGS; do \
 	  case $$f in \
@@ -368,7 +400,11 @@ $(RECURSIVE_TARGETS):
 	done; \
 	dot_seen=no; \
 	target=`echo $@ | sed s/-recursive//`; \
-	list='$(SUBDIRS)'; for subdir in $$list; do \
+	case "$@" in \
+	  distclean-* | maintainer-clean-*) list='$(DIST_SUBDIRS)' ;; \
+	  *) list='$(SUBDIRS)' ;; \
+	esac; \
+	for subdir in $$list; do \
 	  echo "Making $$target in $$subdir"; \
 	  if test "$$subdir" = "."; then \
 	    dot_seen=yes; \
@@ -382,37 +418,6 @@ $(RECURSIVE_TARGETS):
 	if test "$$dot_seen" = "no"; then \
 	  $(MAKE) $(AM_MAKEFLAGS) "$$target-am" || exit 1; \
 	fi; test -z "$$fail"
-
-$(RECURSIVE_CLEAN_TARGETS):
-	@fail= failcom='exit 1'; \
-	for f in x $$MAKEFLAGS; do \
-	  case $$f in \
-	    *=* | --[!k]*);; \
-	    *k*) failcom='fail=yes';; \
-	  esac; \
-	done; \
-	dot_seen=no; \
-	case "$@" in \
-	  distclean-* | maintainer-clean-*) list='$(DIST_SUBDIRS)' ;; \
-	  *) list='$(SUBDIRS)' ;; \
-	esac; \
-	rev=''; for subdir in $$list; do \
-	  if test "$$subdir" = "."; then :; else \
-	    rev="$$subdir $$rev"; \
-	  fi; \
-	done; \
-	rev="$$rev ."; \
-	target=`echo $@ | sed s/-recursive//`; \
-	for subdir in $$rev; do \
-	  echo "Making $$target in $$subdir"; \
-	  if test "$$subdir" = "."; then \
-	    local_target="$$target-am"; \
-	  else \
-	    local_target="$$target"; \
-	  fi; \
-	  ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) $$local_target) \
-	  || eval $$failcom; \
-	done && test -z "$$fail"
 tags-recursive:
 	list='$(SUBDIRS)'; for subdir in $$list; do \
 	  test "$$subdir" = . || ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) tags); \
@@ -421,6 +426,10 @@ ctags-recursive:
 	list='$(SUBDIRS)'; for subdir in $$list; do \
 	  test "$$subdir" = . || ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) ctags); \
 	done
+cscopelist-recursive:
+	list='$(SUBDIRS)'; for subdir in $$list; do \
+	  test "$$subdir" = . || ($(am__cd) $$subdir && $(MAKE) $(AM_MAKEFLAGS) cscopelist); \
+	done
 
 ID: $(HEADERS) $(SOURCES) $(LISP) $(TAGS_FILES)
 	list='$(SOURCES) $(HEADERS) $(LISP) $(TAGS_FILES)'; \
@@ -484,6 +493,20 @@ GTAGS:
 	  && $(am__cd) $(top_srcdir) \
 	  && gtags -i $(GTAGS_ARGS) "$$here"
 
+cscopelist: cscopelist-recursive $(HEADERS) $(SOURCES) $(LISP)
+	list='$(SOURCES) $(HEADERS) $(LISP)'; \
+	case "$(srcdir)" in \
+	  [\\/]* | ?:[\\/]*) sdir="$(srcdir)" ;; \
+	  *) sdir=$(subdir)/$(srcdir) ;; \
+	esac; \
+	for i in $$list; do \
+	  if test -f "$$i"; then \
+	    echo "$(subdir)/$$i"; \
+	  else \
+	    echo "$$sdir/$$i"; \
+	  fi; \
+	done >> $(top_builddir)/cscope.files
+
 distclean-tags:
 	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
 
@@ -519,13 +542,10 @@ distdir: $(DISTFILES)
 	done
 	@list='$(DIST_SUBDIRS)'; for subdir in $$list; do \
 	  if test "$$subdir" = .; then :; else \
-	    test -d "$(distdir)/$$subdir" \
-	    || $(MKDIR_P) "$(distdir)/$$subdir" \
-	    || exit 1; \
-	  fi; \
-	done
-	@list='$(DIST_SUBDIRS)'; for subdir in $$list; do \
-	  if test "$$subdir" = .; then :; else \
+	    $(am__make_dryrun) \
+	      || test -d "$(distdir)/$$subdir" \
+	      || $(MKDIR_P) "$(distdir)/$$subdir" \
+	      || exit 1; \
 	    dir1=$$subdir; dir2="$(distdir)/$$subdir"; \
 	    $(am__relativize); \
 	    new_distdir=$$reldir; \
@@ -560,10 +580,15 @@ install-am: all-am
 
 installcheck: installcheck-recursive
 install-strip:
-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
-	  `test -z '$(STRIP)' || \
-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+	if test -z '$(STRIP)'; then \
+	  $(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+	    install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+	      install; \
+	else \
+	  $(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+	    install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+	    "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'" install; \
+	fi
 mostlyclean-generic:
 
 clean-generic:
@@ -641,22 +666,23 @@ ps-am:
 
 uninstall-am:
 
-.MAKE: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) ctags-recursive \
-	install-am install-strip tags-recursive
+.MAKE: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) \
+	cscopelist-recursive ctags-recursive install-am install-strip \
+	tags-recursive
 
 .PHONY: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) CTAGS GTAGS \
 	all all-am check check-am clean clean-generic clean-libtool \
-	ctags ctags-recursive distclean distclean-generic \
-	distclean-libtool distclean-tags distdir dvi dvi-am html \
-	html-am info info-am install install-am install-data \
-	install-data-am install-dvi install-dvi-am install-exec \
-	install-exec-am install-html install-html-am install-info \
-	install-info-am install-man install-pdf install-pdf-am \
-	install-ps install-ps-am install-strip installcheck \
-	installcheck-am installdirs installdirs-am maintainer-clean \
-	maintainer-clean-generic mostlyclean mostlyclean-generic \
-	mostlyclean-libtool pdf pdf-am ps ps-am tags tags-recursive \
-	uninstall uninstall-am
+	cscopelist cscopelist-recursive ctags ctags-recursive \
+	distclean distclean-generic distclean-libtool distclean-tags \
+	distdir dvi dvi-am html html-am info info-am install \
+	install-am install-data install-data-am install-dvi \
+	install-dvi-am install-exec install-exec-am install-html \
+	install-html-am install-info install-info-am install-man \
+	install-pdf install-pdf-am install-ps install-ps-am \
+	install-strip installcheck installcheck-am installdirs \
+	installdirs-am maintainer-clean maintainer-clean-generic \
+	mostlyclean mostlyclean-generic mostlyclean-libtool pdf pdf-am \
+	ps ps-am tags tags-recursive uninstall uninstall-am
 
 
 # Tell versions [3.59,3.63) of GNU make to not export all variables.
diff --git a/tests/check/Makefile.am b/tests/check/Makefile.am
index a904a44..3473c48 100644
--- a/tests/check/Makefile.am
+++ b/tests/check/Makefile.am
@@ -16,12 +16,16 @@ CLEANFILES = core.* test-registry.xml
 
 clean-local: clean-local-check
 
+if !GST_FFMPEG_ENABLE_LGPL
+postproc_tests = elements/postproc
+endif
+
 check_PROGRAMS = \
 	generic/plugin-test \
 	generic/libavcodec-locking \
 	elements/ffdec_adpcm \
 	elements/ffdemux_ape \
-	elements/postproc
+	$(postproc_tests)
 
 VALGRIND_TO_FIX = \
 	generic/plugin-test \
diff --git a/tests/check/Makefile.in b/tests/check/Makefile.in
index 90816a1..b20b1b2 100644
--- a/tests/check/Makefile.in
+++ b/tests/check/Makefile.in
@@ -1,9 +1,8 @@
-# Makefile.in generated by automake 1.11.1 from Makefile.am.
+# Makefile.in generated by automake 1.12.6 from Makefile.am.
 # @configure_input@
 
-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
-# Inc.
+# Copyright (C) 1994-2012 Free Software Foundation, Inc.
+
 # This Makefile.in is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
@@ -16,6 +15,23 @@
 @SET_MAKE@
 
 VPATH = @srcdir@
+am__make_dryrun = \
+  { \
+    am__dry=no; \
+    case $$MAKEFLAGS in \
+      *\\[\ \	]*) \
+        echo 'am--echo: ; @echo "AM"  OK' | $(MAKE) -f - 2>/dev/null \
+          | grep '^AM OK$$' >/dev/null || am__dry=yes;; \
+      *) \
+        for am__flg in $$MAKEFLAGS; do \
+          case $$am__flg in \
+            *=*|--*) ;; \
+            *n*) am__dry=yes; break;; \
+          esac; \
+        done;; \
+    esac; \
+    test $$am__dry = yes; \
+  }
 pkgdatadir = $(datadir)/@PACKAGE@
 pkgincludedir = $(includedir)/@PACKAGE@
 pkglibdir = $(libdir)/@PACKAGE@
@@ -34,12 +50,13 @@ PRE_UNINSTALL = :
 POST_UNINSTALL = :
 build_triplet = @build@
 host_triplet = @host@
+target_triplet = @target@
 DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in \
-	$(top_srcdir)/common/check.mak
+	$(top_srcdir)/common/check.mak $(top_srcdir)/depcomp
 check_PROGRAMS = generic/plugin-test$(EXEEXT) \
 	generic/libavcodec-locking$(EXEEXT) \
 	elements/ffdec_adpcm$(EXEEXT) elements/ffdemux_ape$(EXEEXT) \
-	elements/postproc$(EXEEXT)
+	$(am__EXEEXT_1)
 noinst_PROGRAMS =
 subdir = tests/check
 ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
@@ -70,15 +87,18 @@ mkinstalldirs = $(install_sh) -d
 CONFIG_HEADER = $(top_builddir)/config.h
 CONFIG_CLEAN_FILES =
 CONFIG_CLEAN_VPATH_FILES =
+@GST_FFMPEG_ENABLE_LGPL_FALSE@am__EXEEXT_1 =  \
+@GST_FFMPEG_ENABLE_LGPL_FALSE@	elements/postproc$(EXEEXT)
 PROGRAMS = $(noinst_PROGRAMS)
 elements_ffdec_adpcm_SOURCES = elements/ffdec_adpcm.c
 elements_ffdec_adpcm_OBJECTS = ffdec_adpcm.$(OBJEXT)
 elements_ffdec_adpcm_LDADD = $(LDADD)
 am__DEPENDENCIES_1 =
 elements_ffdec_adpcm_DEPENDENCIES = $(am__DEPENDENCIES_1)
-AM_V_lt = $(am__v_lt_$(V))
-am__v_lt_ = $(am__v_lt_$(AM_DEFAULT_VERBOSITY))
+AM_V_lt = $(am__v_lt_@AM_V@)
+am__v_lt_ = $(am__v_lt_@AM_DEFAULT_V@)
 am__v_lt_0 = --silent
+am__v_lt_1 = 
 am__dirstamp = $(am__leading_dot)dirstamp
 elements_ffdemux_ape_SOURCES = elements/ffdemux_ape.c
 elements_ffdemux_ape_OBJECTS = ffdemux_ape.$(OBJEXT)
@@ -96,6 +116,18 @@ generic_plugin_test_SOURCES = generic/plugin-test.c
 generic_plugin_test_OBJECTS = plugin-test.$(OBJEXT)
 generic_plugin_test_LDADD = $(LDADD)
 generic_plugin_test_DEPENDENCIES = $(am__DEPENDENCIES_1)
+AM_V_P = $(am__v_P_@AM_V@)
+am__v_P_ = $(am__v_P_@AM_DEFAULT_V@)
+am__v_P_0 = false
+am__v_P_1 = :
+AM_V_GEN = $(am__v_GEN_@AM_V@)
+am__v_GEN_ = $(am__v_GEN_@AM_DEFAULT_V@)
+am__v_GEN_0 = @echo "  GEN     " $@;
+am__v_GEN_1 = 
+AM_V_at = $(am__v_at_@AM_V@)
+am__v_at_ = $(am__v_at_@AM_DEFAULT_V@)
+am__v_at_0 = @
+am__v_at_1 = 
 DEFAULT_INCLUDES = -I.@am__isrc@ -I$(top_builddir)
 depcomp = $(SHELL) $(top_srcdir)/depcomp
 am__depfiles_maybe = depfiles
@@ -106,32 +138,35 @@ LTCOMPILE = $(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) \
 	$(LIBTOOLFLAGS) --mode=compile $(CC) $(DEFS) \
 	$(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) \
 	$(AM_CFLAGS) $(CFLAGS)
-AM_V_CC = $(am__v_CC_$(V))
-am__v_CC_ = $(am__v_CC_$(AM_DEFAULT_VERBOSITY))
-am__v_CC_0 = @echo "  CC    " $@;
-AM_V_at = $(am__v_at_$(V))
-am__v_at_ = $(am__v_at_$(AM_DEFAULT_VERBOSITY))
-am__v_at_0 = @
+AM_V_CC = $(am__v_CC_@AM_V@)
+am__v_CC_ = $(am__v_CC_@AM_DEFAULT_V@)
+am__v_CC_0 = @echo "  CC      " $@;
+am__v_CC_1 = 
 CCLD = $(CC)
 LINK = $(LIBTOOL) $(AM_V_lt) --tag=CC $(AM_LIBTOOLFLAGS) \
 	$(LIBTOOLFLAGS) --mode=link $(CCLD) $(AM_CFLAGS) $(CFLAGS) \
 	$(AM_LDFLAGS) $(LDFLAGS) -o $@
-AM_V_CCLD = $(am__v_CCLD_$(V))
-am__v_CCLD_ = $(am__v_CCLD_$(AM_DEFAULT_VERBOSITY))
-am__v_CCLD_0 = @echo "  CCLD  " $@;
-AM_V_GEN = $(am__v_GEN_$(V))
-am__v_GEN_ = $(am__v_GEN_$(AM_DEFAULT_VERBOSITY))
-am__v_GEN_0 = @echo "  GEN   " $@;
+AM_V_CCLD = $(am__v_CCLD_@AM_V@)
+am__v_CCLD_ = $(am__v_CCLD_@AM_DEFAULT_V@)
+am__v_CCLD_0 = @echo "  CCLD    " $@;
+am__v_CCLD_1 = 
 SOURCES = elements/ffdec_adpcm.c elements/ffdemux_ape.c \
 	elements/postproc.c generic/libavcodec-locking.c \
 	generic/plugin-test.c
 DIST_SOURCES = elements/ffdec_adpcm.c elements/ffdemux_ape.c \
 	elements/postproc.c generic/libavcodec-locking.c \
 	generic/plugin-test.c
+am__can_run_installinfo = \
+  case $$AM_UPDATE_INFO_DIR in \
+    n|no|NO) false;; \
+    *) (install-info --version) >/dev/null 2>&1;; \
+  esac
 ETAGS = etags
 CTAGS = ctags
-am__tty_colors = \
-red=; grn=; lgn=; blu=; std=
+am__tty_colors_dummy = \
+  mgn= red= grn= lgn= blu= brg= std=; \
+  am__color_tests=no
+am__tty_colors = $(am__tty_colors_dummy)
 DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
 ACLOCAL = @ACLOCAL@
 ACLOCAL_AMFLAGS = @ACLOCAL_AMFLAGS@
@@ -326,7 +361,11 @@ sbindir = @sbindir@
 sharedstatedir = @sharedstatedir@
 srcdir = @srcdir@
 sysconfdir = @sysconfdir@
+target = @target@
 target_alias = @target_alias@
+target_cpu = @target_cpu@
+target_os = @target_os@
+target_vendor = @target_vendor@
 top_build_prefix = @top_build_prefix@
 top_builddir = @top_builddir@
 top_srcdir = @top_srcdir@
@@ -347,6 +386,7 @@ TESTS_ENVIRONMENT = \
 
 # ths core dumps of some machines have PIDs appended
 CLEANFILES = core.* test-registry.xml
+@GST_FFMPEG_ENABLE_LGPL_FALSE@postproc_tests = elements/postproc
 VALGRIND_TO_FIX = \
 	generic/plugin-test \
 	generic/libavcodec-locking \
@@ -387,6 +427,7 @@ Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
 	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
 	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
 	esac;
+$(top_srcdir)/common/check.mak:
 
 $(top_builddir)/config.status: $(top_srcdir)/configure $(CONFIG_STATUS_DEPENDENCIES)
 	cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh
@@ -417,22 +458,22 @@ clean-noinstPROGRAMS:
 elements/$(am__dirstamp):
 	@$(MKDIR_P) elements
 	@: > elements/$(am__dirstamp)
-elements/ffdec_adpcm$(EXEEXT): $(elements_ffdec_adpcm_OBJECTS) $(elements_ffdec_adpcm_DEPENDENCIES) elements/$(am__dirstamp)
+elements/ffdec_adpcm$(EXEEXT): $(elements_ffdec_adpcm_OBJECTS) $(elements_ffdec_adpcm_DEPENDENCIES) $(EXTRA_elements_ffdec_adpcm_DEPENDENCIES) elements/$(am__dirstamp)
 	@rm -f elements/ffdec_adpcm$(EXEEXT)
 	$(AM_V_CCLD)$(LINK) $(elements_ffdec_adpcm_OBJECTS) $(elements_ffdec_adpcm_LDADD) $(LIBS)
-elements/ffdemux_ape$(EXEEXT): $(elements_ffdemux_ape_OBJECTS) $(elements_ffdemux_ape_DEPENDENCIES) elements/$(am__dirstamp)
+elements/ffdemux_ape$(EXEEXT): $(elements_ffdemux_ape_OBJECTS) $(elements_ffdemux_ape_DEPENDENCIES) $(EXTRA_elements_ffdemux_ape_DEPENDENCIES) elements/$(am__dirstamp)
 	@rm -f elements/ffdemux_ape$(EXEEXT)
 	$(AM_V_CCLD)$(LINK) $(elements_ffdemux_ape_OBJECTS) $(elements_ffdemux_ape_LDADD) $(LIBS)
-elements/postproc$(EXEEXT): $(elements_postproc_OBJECTS) $(elements_postproc_DEPENDENCIES) elements/$(am__dirstamp)
+elements/postproc$(EXEEXT): $(elements_postproc_OBJECTS) $(elements_postproc_DEPENDENCIES) $(EXTRA_elements_postproc_DEPENDENCIES) elements/$(am__dirstamp)
 	@rm -f elements/postproc$(EXEEXT)
 	$(AM_V_CCLD)$(LINK) $(elements_postproc_OBJECTS) $(elements_postproc_LDADD) $(LIBS)
 generic/$(am__dirstamp):
 	@$(MKDIR_P) generic
 	@: > generic/$(am__dirstamp)
-generic/libavcodec-locking$(EXEEXT): $(generic_libavcodec_locking_OBJECTS) $(generic_libavcodec_locking_DEPENDENCIES) generic/$(am__dirstamp)
+generic/libavcodec-locking$(EXEEXT): $(generic_libavcodec_locking_OBJECTS) $(generic_libavcodec_locking_DEPENDENCIES) $(EXTRA_generic_libavcodec_locking_DEPENDENCIES) generic/$(am__dirstamp)
 	@rm -f generic/libavcodec-locking$(EXEEXT)
 	$(AM_V_CCLD)$(LINK) $(generic_libavcodec_locking_OBJECTS) $(generic_libavcodec_locking_LDADD) $(LIBS)
-generic/plugin-test$(EXEEXT): $(generic_plugin_test_OBJECTS) $(generic_plugin_test_DEPENDENCIES) generic/$(am__dirstamp)
+generic/plugin-test$(EXEEXT): $(generic_plugin_test_OBJECTS) $(generic_plugin_test_DEPENDENCIES) $(EXTRA_generic_plugin_test_DEPENDENCIES) generic/$(am__dirstamp)
 	@rm -f generic/plugin-test$(EXEEXT)
 	$(AM_V_CCLD)$(LINK) $(generic_plugin_test_OBJECTS) $(generic_plugin_test_LDADD) $(LIBS)
 
@@ -451,106 +492,93 @@ distclean-compile:
 .c.o:
 @am__fastdepCC_TRUE@	$(AM_V_CC)$(COMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
 @am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
-@am__fastdepCC_FALSE@	$(AM_V_CC) @AM_BACKSLASH@
-@AMDEP_TRUE@@am__fastdepCC_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(COMPILE) -c $<
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(COMPILE) -c $<
 
 .c.obj:
 @am__fastdepCC_TRUE@	$(AM_V_CC)$(COMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ `$(CYGPATH_W) '$<'`
 @am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Po
-@am__fastdepCC_FALSE@	$(AM_V_CC) @AM_BACKSLASH@
-@AMDEP_TRUE@@am__fastdepCC_FALSE@	source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='$<' object='$@' libtool=no @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(COMPILE) -c `$(CYGPATH_W) '$<'`
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(COMPILE) -c `$(CYGPATH_W) '$<'`
 
 .c.lo:
 @am__fastdepCC_TRUE@	$(AM_V_CC)$(LTCOMPILE) -MT $@ -MD -MP -MF $(DEPDIR)/$*.Tpo -c -o $@ $<
 @am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/$*.Tpo $(DEPDIR)/$*.Plo
-@am__fastdepCC_FALSE@	$(AM_V_CC) @AM_BACKSLASH@
-@AMDEP_TRUE@@am__fastdepCC_FALSE@	source='$<' object='$@' libtool=yes @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='$<' object='$@' libtool=yes @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(LTCOMPILE) -c -o $@ $<
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(LTCOMPILE) -c -o $@ $<
 
 ffdec_adpcm.o: elements/ffdec_adpcm.c
 @am__fastdepCC_TRUE@	$(AM_V_CC)$(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS) -MT ffdec_adpcm.o -MD -MP -MF $(DEPDIR)/ffdec_adpcm.Tpo -c -o ffdec_adpcm.o `test -f 'elements/ffdec_adpcm.c' || echo '$(srcdir)/'`elements/ffdec_adpcm.c
 @am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/ffdec_adpcm.Tpo $(DEPDIR)/ffdec_adpcm.Po
-@am__fastdepCC_FALSE@	$(AM_V_CC) @AM_BACKSLASH@
-@AMDEP_TRUE@@am__fastdepCC_FALSE@	source='elements/ffdec_adpcm.c' object='ffdec_adpcm.o' libtool=no @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='elements/ffdec_adpcm.c' object='ffdec_adpcm.o' libtool=no @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS) -c -o ffdec_adpcm.o `test -f 'elements/ffdec_adpcm.c' || echo '$(srcdir)/'`elements/ffdec_adpcm.c
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS) -c -o ffdec_adpcm.o `test -f 'elements/ffdec_adpcm.c' || echo '$(srcdir)/'`elements/ffdec_adpcm.c
 
 ffdec_adpcm.obj: elements/ffdec_adpcm.c
 @am__fastdepCC_TRUE@	$(AM_V_CC)$(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS) -MT ffdec_adpcm.obj -MD -MP -MF $(DEPDIR)/ffdec_adpcm.Tpo -c -o ffdec_adpcm.obj `if test -f 'elements/ffdec_adpcm.c'; then $(CYGPATH_W) 'elements/ffdec_adpcm.c'; else $(CYGPATH_W) '$(srcdir)/elements/ffdec_adpcm.c'; fi`
 @am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/ffdec_adpcm.Tpo $(DEPDIR)/ffdec_adpcm.Po
-@am__fastdepCC_FALSE@	$(AM_V_CC) @AM_BACKSLASH@
-@AMDEP_TRUE@@am__fastdepCC_FALSE@	source='elements/ffdec_adpcm.c' object='ffdec_adpcm.obj' libtool=no @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='elements/ffdec_adpcm.c' object='ffdec_adpcm.obj' libtool=no @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS) -c -o ffdec_adpcm.obj `if test -f 'elements/ffdec_adpcm.c'; then $(CYGPATH_W) 'elements/ffdec_adpcm.c'; else $(CYGPATH_W) '$(srcdir)/elements/ffdec_adpcm.c'; fi`
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS) -c -o ffdec_adpcm.obj `if test -f 'elements/ffdec_adpcm.c'; then $(CYGPATH_W) 'elements/ffdec_adpcm.c'; else $(CYGPATH_W) '$(srcdir)/elements/ffdec_adpcm.c'; fi`
 
 ffdemux_ape.o: elements/ffdemux_ape.c
 @am__fastdepCC_TRUE@	$(AM_V_CC)$(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS) -MT ffdemux_ape.o -MD -MP -MF $(DEPDIR)/ffdemux_ape.Tpo -c -o ffdemux_ape.o `test -f 'elements/ffdemux_ape.c' || echo '$(srcdir)/'`elements/ffdemux_ape.c
 @am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/ffdemux_ape.Tpo $(DEPDIR)/ffdemux_ape.Po
-@am__fastdepCC_FALSE@	$(AM_V_CC) @AM_BACKSLASH@
-@AMDEP_TRUE@@am__fastdepCC_FALSE@	source='elements/ffdemux_ape.c' object='ffdemux_ape.o' libtool=no @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='elements/ffdemux_ape.c' object='ffdemux_ape.o' libtool=no @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS) -c -o ffdemux_ape.o `test -f 'elements/ffdemux_ape.c' || echo '$(srcdir)/'`elements/ffdemux_ape.c
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS) -c -o ffdemux_ape.o `test -f 'elements/ffdemux_ape.c' || echo '$(srcdir)/'`elements/ffdemux_ape.c
 
 ffdemux_ape.obj: elements/ffdemux_ape.c
 @am__fastdepCC_TRUE@	$(AM_V_CC)$(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS) -MT ffdemux_ape.obj -MD -MP -MF $(DEPDIR)/ffdemux_ape.Tpo -c -o ffdemux_ape.obj `if test -f 'elements/ffdemux_ape.c'; then $(CYGPATH_W) 'elements/ffdemux_ape.c'; else $(CYGPATH_W) '$(srcdir)/elements/ffdemux_ape.c'; fi`
 @am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/ffdemux_ape.Tpo $(DEPDIR)/ffdemux_ape.Po
-@am__fastdepCC_FALSE@	$(AM_V_CC) @AM_BACKSLASH@
-@AMDEP_TRUE@@am__fastdepCC_FALSE@	source='elements/ffdemux_ape.c' object='ffdemux_ape.obj' libtool=no @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='elements/ffdemux_ape.c' object='ffdemux_ape.obj' libtool=no @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS) -c -o ffdemux_ape.obj `if test -f 'elements/ffdemux_ape.c'; then $(CYGPATH_W) 'elements/ffdemux_ape.c'; else $(CYGPATH_W) '$(srcdir)/elements/ffdemux_ape.c'; fi`
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS) -c -o ffdemux_ape.obj `if test -f 'elements/ffdemux_ape.c'; then $(CYGPATH_W) 'elements/ffdemux_ape.c'; else $(CYGPATH_W) '$(srcdir)/elements/ffdemux_ape.c'; fi`
 
 postproc.o: elements/postproc.c
 @am__fastdepCC_TRUE@	$(AM_V_CC)$(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS) -MT postproc.o -MD -MP -MF $(DEPDIR)/postproc.Tpo -c -o postproc.o `test -f 'elements/postproc.c' || echo '$(srcdir)/'`elements/postproc.c
 @am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/postproc.Tpo $(DEPDIR)/postproc.Po
-@am__fastdepCC_FALSE@	$(AM_V_CC) @AM_BACKSLASH@
-@AMDEP_TRUE@@am__fastdepCC_FALSE@	source='elements/postproc.c' object='postproc.o' libtool=no @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='elements/postproc.c' object='postproc.o' libtool=no @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS) -c -o postproc.o `test -f 'elements/postproc.c' || echo '$(srcdir)/'`elements/postproc.c
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS) -c -o postproc.o `test -f 'elements/postproc.c' || echo '$(srcdir)/'`elements/postproc.c
 
 postproc.obj: elements/postproc.c
 @am__fastdepCC_TRUE@	$(AM_V_CC)$(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS) -MT postproc.obj -MD -MP -MF $(DEPDIR)/postproc.Tpo -c -o postproc.obj `if test -f 'elements/postproc.c'; then $(CYGPATH_W) 'elements/postproc.c'; else $(CYGPATH_W) '$(srcdir)/elements/postproc.c'; fi`
 @am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/postproc.Tpo $(DEPDIR)/postproc.Po
-@am__fastdepCC_FALSE@	$(AM_V_CC) @AM_BACKSLASH@
-@AMDEP_TRUE@@am__fastdepCC_FALSE@	source='elements/postproc.c' object='postproc.obj' libtool=no @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='elements/postproc.c' object='postproc.obj' libtool=no @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS) -c -o postproc.obj `if test -f 'elements/postproc.c'; then $(CYGPATH_W) 'elements/postproc.c'; else $(CYGPATH_W) '$(srcdir)/elements/postproc.c'; fi`
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS) -c -o postproc.obj `if test -f 'elements/postproc.c'; then $(CYGPATH_W) 'elements/postproc.c'; else $(CYGPATH_W) '$(srcdir)/elements/postproc.c'; fi`
 
 libavcodec-locking.o: generic/libavcodec-locking.c
 @am__fastdepCC_TRUE@	$(AM_V_CC)$(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS) -MT libavcodec-locking.o -MD -MP -MF $(DEPDIR)/libavcodec-locking.Tpo -c -o libavcodec-locking.o `test -f 'generic/libavcodec-locking.c' || echo '$(srcdir)/'`generic/libavcodec-locking.c
 @am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/libavcodec-locking.Tpo $(DEPDIR)/libavcodec-locking.Po
-@am__fastdepCC_FALSE@	$(AM_V_CC) @AM_BACKSLASH@
-@AMDEP_TRUE@@am__fastdepCC_FALSE@	source='generic/libavcodec-locking.c' object='libavcodec-locking.o' libtool=no @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='generic/libavcodec-locking.c' object='libavcodec-locking.o' libtool=no @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS) -c -o libavcodec-locking.o `test -f 'generic/libavcodec-locking.c' || echo '$(srcdir)/'`generic/libavcodec-locking.c
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS) -c -o libavcodec-locking.o `test -f 'generic/libavcodec-locking.c' || echo '$(srcdir)/'`generic/libavcodec-locking.c
 
 libavcodec-locking.obj: generic/libavcodec-locking.c
 @am__fastdepCC_TRUE@	$(AM_V_CC)$(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS) -MT libavcodec-locking.obj -MD -MP -MF $(DEPDIR)/libavcodec-locking.Tpo -c -o libavcodec-locking.obj `if test -f 'generic/libavcodec-locking.c'; then $(CYGPATH_W) 'generic/libavcodec-locking.c'; else $(CYGPATH_W) '$(srcdir)/generic/libavcodec-locking.c'; fi`
 @am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/libavcodec-locking.Tpo $(DEPDIR)/libavcodec-locking.Po
-@am__fastdepCC_FALSE@	$(AM_V_CC) @AM_BACKSLASH@
-@AMDEP_TRUE@@am__fastdepCC_FALSE@	source='generic/libavcodec-locking.c' object='libavcodec-locking.obj' libtool=no @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='generic/libavcodec-locking.c' object='libavcodec-locking.obj' libtool=no @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS) -c -o libavcodec-locking.obj `if test -f 'generic/libavcodec-locking.c'; then $(CYGPATH_W) 'generic/libavcodec-locking.c'; else $(CYGPATH_W) '$(srcdir)/generic/libavcodec-locking.c'; fi`
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS) -c -o libavcodec-locking.obj `if test -f 'generic/libavcodec-locking.c'; then $(CYGPATH_W) 'generic/libavcodec-locking.c'; else $(CYGPATH_W) '$(srcdir)/generic/libavcodec-locking.c'; fi`
 
 plugin-test.o: generic/plugin-test.c
 @am__fastdepCC_TRUE@	$(AM_V_CC)$(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS) -MT plugin-test.o -MD -MP -MF $(DEPDIR)/plugin-test.Tpo -c -o plugin-test.o `test -f 'generic/plugin-test.c' || echo '$(srcdir)/'`generic/plugin-test.c
 @am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/plugin-test.Tpo $(DEPDIR)/plugin-test.Po
-@am__fastdepCC_FALSE@	$(AM_V_CC) @AM_BACKSLASH@
-@AMDEP_TRUE@@am__fastdepCC_FALSE@	source='generic/plugin-test.c' object='plugin-test.o' libtool=no @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='generic/plugin-test.c' object='plugin-test.o' libtool=no @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS) -c -o plugin-test.o `test -f 'generic/plugin-test.c' || echo '$(srcdir)/'`generic/plugin-test.c
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS) -c -o plugin-test.o `test -f 'generic/plugin-test.c' || echo '$(srcdir)/'`generic/plugin-test.c
 
 plugin-test.obj: generic/plugin-test.c
 @am__fastdepCC_TRUE@	$(AM_V_CC)$(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS) -MT plugin-test.obj -MD -MP -MF $(DEPDIR)/plugin-test.Tpo -c -o plugin-test.obj `if test -f 'generic/plugin-test.c'; then $(CYGPATH_W) 'generic/plugin-test.c'; else $(CYGPATH_W) '$(srcdir)/generic/plugin-test.c'; fi`
 @am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) $(DEPDIR)/plugin-test.Tpo $(DEPDIR)/plugin-test.Po
-@am__fastdepCC_FALSE@	$(AM_V_CC) @AM_BACKSLASH@
-@AMDEP_TRUE@@am__fastdepCC_FALSE@	source='generic/plugin-test.c' object='plugin-test.obj' libtool=no @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='generic/plugin-test.c' object='plugin-test.obj' libtool=no @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
-@am__fastdepCC_FALSE@	$(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS) -c -o plugin-test.obj `if test -f 'generic/plugin-test.c'; then $(CYGPATH_W) 'generic/plugin-test.c'; else $(CYGPATH_W) '$(srcdir)/generic/plugin-test.c'; fi`
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS) -c -o plugin-test.obj `if test -f 'generic/plugin-test.c'; then $(CYGPATH_W) 'generic/plugin-test.c'; else $(CYGPATH_W) '$(srcdir)/generic/plugin-test.c'; fi`
 
 mostlyclean-libtool:
 	-rm -f *.lo
@@ -609,6 +637,20 @@ GTAGS:
 	  && $(am__cd) $(top_srcdir) \
 	  && gtags -i $(GTAGS_ARGS) "$$here"
 
+cscopelist:  $(HEADERS) $(SOURCES) $(LISP)
+	list='$(SOURCES) $(HEADERS) $(LISP)'; \
+	case "$(srcdir)" in \
+	  [\\/]* | ?:[\\/]*) sdir="$(srcdir)" ;; \
+	  *) sdir=$(subdir)/$(srcdir) ;; \
+	esac; \
+	for i in $$list; do \
+	  if test -f "$$i"; then \
+	    echo "$(subdir)/$$i"; \
+	  else \
+	    echo "$$sdir/$$i"; \
+	  fi; \
+	done >> $(top_builddir)/cscope.files
+
 distclean-tags:
 	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
 
@@ -622,7 +664,7 @@ check-TESTS: $(TESTS)
 	    if test -f ./$$tst; then dir=./; \
 	    elif test -f $$tst; then dir=; \
 	    else dir="$(srcdir)/"; fi; \
-	    if $(TESTS_ENVIRONMENT) $${dir}$$tst; then \
+	    if $(TESTS_ENVIRONMENT) $${dir}$$tst $(AM_TESTS_FD_REDIRECT); then \
 	      all=`expr $$all + 1`; \
 	      case " $(XFAIL_TESTS) " in \
 	      *[\ \	]$$tst[\ \	]*) \
@@ -693,14 +735,15 @@ check-TESTS: $(TESTS)
 	  fi; \
 	  dashes=`echo "$$dashes" | sed s/./=/g`; \
 	  if test "$$failed" -eq 0; then \
-	    echo "$$grn$$dashes"; \
+	    col="$$grn"; \
 	  else \
-	    echo "$$red$$dashes"; \
+	    col="$$red"; \
 	  fi; \
-	  echo "$$banner"; \
-	  test -z "$$skipped" || echo "$$skipped"; \
-	  test -z "$$report" || echo "$$report"; \
-	  echo "$$dashes$$std"; \
+	  echo "$${col}$$dashes$${std}"; \
+	  echo "$${col}$$banner$${std}"; \
+	  test -z "$$skipped" || echo "$${col}$$skipped$${std}"; \
+	  test -z "$$report" || echo "$${col}$$report$${std}"; \
+	  echo "$${col}$$dashes$${std}"; \
 	  test "$$failed" -eq 0; \
 	else :; fi
 
@@ -750,10 +793,15 @@ install-am: all-am
 
 installcheck: installcheck-am
 install-strip:
-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
-	  `test -z '$(STRIP)' || \
-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+	if test -z '$(STRIP)'; then \
+	  $(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+	    install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+	      install; \
+	else \
+	  $(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+	    install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+	    "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'" install; \
+	fi
 mostlyclean-generic:
 
 clean-generic:
@@ -843,17 +891,17 @@ uninstall-am:
 
 .PHONY: CTAGS GTAGS all all-am check check-TESTS check-am clean \
 	clean-checkPROGRAMS clean-generic clean-libtool clean-local \
-	clean-noinstPROGRAMS ctags distclean distclean-compile \
-	distclean-generic distclean-libtool distclean-tags distdir dvi \
-	dvi-am html html-am info info-am install install-am \
-	install-data install-data-am install-dvi install-dvi-am \
-	install-exec install-exec-am install-html install-html-am \
-	install-info install-info-am install-man install-pdf \
-	install-pdf-am install-ps install-ps-am install-strip \
-	installcheck installcheck-am installdirs maintainer-clean \
-	maintainer-clean-generic mostlyclean mostlyclean-compile \
-	mostlyclean-generic mostlyclean-libtool pdf pdf-am ps ps-am \
-	tags uninstall uninstall-am
+	clean-noinstPROGRAMS cscopelist ctags distclean \
+	distclean-compile distclean-generic distclean-libtool \
+	distclean-tags distdir dvi dvi-am html html-am info info-am \
+	install install-am install-data install-data-am install-dvi \
+	install-dvi-am install-exec install-exec-am install-html \
+	install-html-am install-info install-info-am install-man \
+	install-pdf install-pdf-am install-ps install-ps-am \
+	install-strip installcheck installcheck-am installdirs \
+	maintainer-clean maintainer-clean-generic mostlyclean \
+	mostlyclean-compile mostlyclean-generic mostlyclean-libtool \
+	pdf pdf-am ps ps-am tags uninstall uninstall-am
 
 
 # keep target around, since it's referenced in the modules' Makefiles
@@ -877,6 +925,12 @@ clean-local-check:
 	CK_DEFAULT_TIMEOUT=20					\
 	$*
 
+# just like 'check', but don't run it again if it fails (useful for debugging)
+%.check-norepeat: %
+	@$(TESTS_ENVIRONMENT)					\
+	CK_DEFAULT_TIMEOUT=20					\
+	$*
+
 # run any given test in a loop
 %.torture: %
 	@for i in `seq 1 $(LOOPS)`; do				\
@@ -1002,7 +1056,8 @@ help:
 	@echo
 	@echo "make check                         -- run all checks"
 	@echo "make torture                       -- run all checks $(LOOPS) times"
-	@echo "make (dir)/(test).check            -- run the given check once"
+	@echo "make (dir)/(test).check            -- run the given check once, repeat with GST_DEBUG=*:2 if it fails"
+	@echo "make (dir)/(test).check-norepeat   -- run the given check once, but don't run it again if it fails"
 	@echo "make (dir)/(test).forever          -- run the given check forever"
 	@echo "make (dir)/(test).torture          -- run the given check $(LOOPS) times"
 	@echo
diff --git a/tests/files/Makefile.in b/tests/files/Makefile.in
index 76faf84..8d5a14d 100644
--- a/tests/files/Makefile.in
+++ b/tests/files/Makefile.in
@@ -1,9 +1,8 @@
-# Makefile.in generated by automake 1.11.1 from Makefile.am.
+# Makefile.in generated by automake 1.12.6 from Makefile.am.
 # @configure_input@
 
-# Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
-# 2003, 2004, 2005, 2006, 2007, 2008, 2009  Free Software Foundation,
-# Inc.
+# Copyright (C) 1994-2012 Free Software Foundation, Inc.
+
 # This Makefile.in is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
 # with or without modifications, as long as this notice is preserved.
@@ -15,6 +14,23 @@
 
 @SET_MAKE@
 VPATH = @srcdir@
+am__make_dryrun = \
+  { \
+    am__dry=no; \
+    case $$MAKEFLAGS in \
+      *\\[\ \	]*) \
+        echo 'am--echo: ; @echo "AM"  OK' | $(MAKE) -f - 2>/dev/null \
+          | grep '^AM OK$$' >/dev/null || am__dry=yes;; \
+      *) \
+        for am__flg in $$MAKEFLAGS; do \
+          case $$am__flg in \
+            *=*|--*) ;; \
+            *n*) am__dry=yes; break;; \
+          esac; \
+        done;; \
+    esac; \
+    test $$am__dry = yes; \
+  }
 pkgdatadir = $(datadir)/@PACKAGE@
 pkgincludedir = $(includedir)/@PACKAGE@
 pkglibdir = $(libdir)/@PACKAGE@
@@ -33,6 +49,7 @@ PRE_UNINSTALL = :
 POST_UNINSTALL = :
 build_triplet = @build@
 host_triplet = @host@
+target_triplet = @target@
 subdir = tests/files
 DIST_COMMON = $(srcdir)/Makefile.am $(srcdir)/Makefile.in
 ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
@@ -63,14 +80,25 @@ mkinstalldirs = $(install_sh) -d
 CONFIG_HEADER = $(top_builddir)/config.h
 CONFIG_CLEAN_FILES =
 CONFIG_CLEAN_VPATH_FILES =
-AM_V_GEN = $(am__v_GEN_$(V))
-am__v_GEN_ = $(am__v_GEN_$(AM_DEFAULT_VERBOSITY))
-am__v_GEN_0 = @echo "  GEN   " $@;
-AM_V_at = $(am__v_at_$(V))
-am__v_at_ = $(am__v_at_$(AM_DEFAULT_VERBOSITY))
+AM_V_P = $(am__v_P_@AM_V@)
+am__v_P_ = $(am__v_P_@AM_DEFAULT_V@)
+am__v_P_0 = false
+am__v_P_1 = :
+AM_V_GEN = $(am__v_GEN_@AM_V@)
+am__v_GEN_ = $(am__v_GEN_@AM_DEFAULT_V@)
+am__v_GEN_0 = @echo "  GEN     " $@;
+am__v_GEN_1 = 
+AM_V_at = $(am__v_at_@AM_V@)
+am__v_at_ = $(am__v_at_@AM_DEFAULT_V@)
 am__v_at_0 = @
+am__v_at_1 = 
 SOURCES =
 DIST_SOURCES =
+am__can_run_installinfo = \
+  case $$AM_UPDATE_INFO_DIR in \
+    n|no|NO) false;; \
+    *) (install-info --version) >/dev/null 2>&1;; \
+  esac
 DISTFILES = $(DIST_COMMON) $(DIST_SOURCES) $(TEXINFOS) $(EXTRA_DIST)
 ACLOCAL = @ACLOCAL@
 ACLOCAL_AMFLAGS = @ACLOCAL_AMFLAGS@
@@ -265,7 +293,11 @@ sbindir = @sbindir@
 sharedstatedir = @sharedstatedir@
 srcdir = @srcdir@
 sysconfdir = @sysconfdir@
+target = @target@
 target_alias = @target_alias@
+target_cpu = @target_cpu@
+target_os = @target_os@
+target_vendor = @target_vendor@
 top_build_prefix = @top_build_prefix@
 top_builddir = @top_builddir@
 top_srcdir = @top_srcdir@
@@ -318,6 +350,8 @@ TAGS:
 ctags: CTAGS
 CTAGS:
 
+cscope cscopelist:
+
 
 distdir: $(DISTFILES)
 	@srcdirstrip=`echo "$(srcdir)" | sed 's/[].[^$$\\*]/\\\\&/g'`; \
@@ -363,10 +397,15 @@ install-am: all-am
 
 installcheck: installcheck-am
 install-strip:
-	$(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
-	  install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
-	  `test -z '$(STRIP)' || \
-	    echo "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'"` install
+	if test -z '$(STRIP)'; then \
+	  $(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+	    install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+	      install; \
+	else \
+	  $(MAKE) $(AM_MAKEFLAGS) INSTALL_PROGRAM="$(INSTALL_STRIP_PROGRAM)" \
+	    install_sh_PROGRAM="$(INSTALL_STRIP_PROGRAM)" INSTALL_STRIP_FLAG=-s \
+	    "INSTALL_PROGRAM_ENV=STRIPPROG='$(STRIP)'" install; \
+	fi
 mostlyclean-generic:
 
 clean-generic:
-- 
1.8.1.4

