Allow gudev to be built separately from other extras.

From: Thierry Reding <thierry.reding@avionic-design.de>


---
 Makefile.am  |   22 +++++++++++++---------
 configure.ac |   14 ++++++++++----
 2 files changed, 23 insertions(+), 13 deletions(-)

diff --git a/Makefile.am b/Makefile.am
index 4dbdfd9..6c7fcb3 100644
--- a/Makefile.am
+++ b/Makefile.am
@@ -309,15 +309,9 @@ extras_v4l_id_v4l_id_LDADD = libudev/libudev-private.la
 libexec_PROGRAMS += extras/v4l_id/v4l_id
 dist_udevrules_DATA += extras/v4l_id/60-persistent-v4l.rules
 
-if ENABLE_EXTRAS
-# ------------------------------------------------------------------------------
-# conditional extras (need glib, libusb, libacl, ...)
-# ------------------------------------------------------------------------------
-dist_udevrules_DATA += \
-	rules/rules.d/75-net-description.rules \
-	rules/rules.d/75-tty-description.rules \
-	rules/rules.d/78-sound-card.rules
+BUILT_SOURCES =
 
+if ENABLE_GLIB
 # ------------------------------------------------------------------------------
 # GUdev - libudev gobject interface
 # ------------------------------------------------------------------------------
@@ -355,7 +349,7 @@ dist_extras_gudev_libgudev_1_0_la_SOURCES = \
 	extras/gudev/gudevmarshal.c \
 	extras/gudev/gudevenumtypes.h \
 	extras/gudev/gudevenumtypes.c
-BUILT_SOURCES = $(dist_extras_gudev_libgudev_1_0_la_SOURCES)
+BUILT_SOURCES += $(dist_extras_gudev_libgudev_1_0_la_SOURCES)
 
 extras_gudev_libgudev_1_0_la_CPPFLAGS = \
 	$(AM_CPPFLAGS) \
@@ -448,6 +442,16 @@ libgudev-uninstall-move-hook:
 
 INSTALL_EXEC_HOOKS += libgudev-install-move-hook
 UNINSTALL_EXEC_HOOKS += libgudev-uninstall-move-hook
+endif
+
+if ENABLE_EXTRAS
+# ------------------------------------------------------------------------------
+# conditional extras (need glib, libusb, libacl, ...)
+# ------------------------------------------------------------------------------
+dist_udevrules_DATA += \
+	rules/rules.d/75-net-description.rules \
+	rules/rules.d/75-tty-description.rules \
+	rules/rules.d/78-sound-card.rules
 
 # ------------------------------------------------------------------------------
 # Bluetooth HID devices with special magic to switch the device
diff --git a/configure.ac b/configure.ac
index 9f8e377..51e6a26 100644
--- a/configure.ac
+++ b/configure.ac
@@ -71,6 +71,16 @@ if test "x$with_systemdsystemunitdir" != xno; then
 fi
 AM_CONDITIONAL(WITH_SYSTEMD, [test -n "$with_systemdsystemunitdir" -a "x$with_systemdsystemunitdir" != xno ])
 
+AC_ARG_ENABLE([glib],
+	AS_HELP_STRING([--disable-glib], [disable GLIB dependencies]),
+	[], [enable_glib=yes])
+if test "x$enable_glib" = xyes; then
+	PKG_CHECK_MODULES([GLIB], [glib-2.0 >= 2.22.0 gobject-2.0 >= 2.22.0])
+	AC_SUBST([GLIB_CFLAGS])
+	AC_SUBST([GLIB_LIBS])
+fi
+AM_CONDITIONAL([ENABLE_GLIB], [test "x$enable_glib" = xyes])
+
 AC_ARG_ENABLE([extras],
 	AS_HELP_STRING([--disable-extras], [disable extras with external dependencies]),
 	[], [enable_extras=yes])
@@ -80,10 +90,6 @@ if test "x$enable_extras" = xyes; then
 		AC_MSG_ERROR([gperf is needed])
 	fi
 
-	PKG_CHECK_MODULES([GLIB], [glib-2.0 >= 2.22.0 gobject-2.0 >= 2.22.0])
-	AC_SUBST([GLIB_CFLAGS])
-	AC_SUBST([GLIB_LIBS])
-
 	AC_CHECK_LIB([acl], [acl_init], [:], AC_MSG_ERROR([libacl not found]))
 	AC_CHECK_HEADER([acl/libacl.h], [:], AC_MSG_ERROR([libacl header not found]))
 
