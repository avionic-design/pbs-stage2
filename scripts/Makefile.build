src = $(obj)

PHONY := __build
__build:

obj-y :=

ifeq ($(findstring package, $(MAKECMDGOALS)),)
  include $(objtree)/include/config/auto.conf

  # get rid of quotes
  ARCH := $(shell echo $(CONFIG_ARCH))

  include arch/$(ARCH)/Makefile
endif

include scripts/Kbuild.include
include scripts/Makefile.lib

ifneq ($(wildcard .package),)
include .package
endif

kbuild-dir := $(if $(filter /%,$(src)),$(src),$(srctree)/$(src))
kbuild-file := $(if $(wildcard $(kbuild-dir)/Kbuild),$(kbuild-dir)/Kbuild,$(kbuild-dir)/Makefile)
include $(kbuild-file)

depends-file = $(objtree)/.depends
packages-y = $(shell cat $(depends-file) | grep '^CONFIG_PACKAGE_' | xargs echo)

PHONY += $(packages-y)
$(packages-y):
	@echo $@ > .package
	$(Q)$(MAKE) $(build)=$(obj) package
	@rm .package

PHONY += platforms
platforms:
	@cat $(depends-file) | grep '^CONFIG_PLATFORM_' > .package
	$(Q)$(MAKE) $(build)=$(obj) package
	@rm .package

__build: $(packages-y) platforms

dirs := $(filter %/,$(obj-y))
dirs := $(addprefix $(obj)/, $(dirs))

pkgs := $(filter-out %/,$(obj-y))
pkgs := $(addprefix $(obj)/, $(pkgs))

build-dirs := $(addprefix build-,$(dirs))
build-pkgs := $(addprefix build-,$(pkgs))

PHONY += $(build-dirs)
$(build-dirs): build-%:
	$(Q)$(MAKE) $(build)=$* package

PHONY += $(build-pkgs)
$(build-pkgs): build-%:
	$(Q)$(MAKE) $(package)=$*

PHONY += package
package: $(build-dirs) $(build-pkgs)
	@:

PHONY += FORCE
FORCE:

.PHONY: $(PHONY)
