#!/bin/sh

. /lib/lsb/init-functions

log_action_begin_msg "Mounting /proc filesystem"
mkdir -p /proc
mount -t proc none /proc
log_action_end_msg $?

log_action_begin_msg "Mounting /sys filesystem"
mkdir -p /sys
mount -t sysfs none /sys
log_action_end_msg $?

log_action_begin_msg "Mounting /dev filesystem"
mount -o size=512K,mode=0755 -t tmpfs udev /dev
log_action_end_msg $?

if test -x /usr/sbin/plymouthd; then
	log_action_begin_msg "Mounting /dev/pts filesystem"
	mkdir -p /dev/pts && mount -t devpts devpts /dev/pts
	log_action_end_msg $?
fi

log_action_begin_msg "Creating devices"
[ -e /dev/console ] || mknod -m 0600 /dev/console c 5 1
[ -e /dev/ptmx ] || mknod -m 0644 /dev/ptmx c 5 2
[ -e /dev/null ] || mknod /dev/null c 1 3
log_action_end_msg $?

log_action_begin_msg "Starting udev daemon"
/sbin/udevd --daemon --resolve-names=never
log_action_end_msg $?

if test -x /usr/sbin/plymouthd; then
	mkdir -p /var/log
	mkdir -p /var/lib/plymouth

	/sbin/modprobe i915 modeset=1

	udevadm trigger --attr-match=class=0x030000
	udevadm trigger --subsystem-match=graphics --subsystem-match=drm --subsystem-match=tty
	udevadm settle || true

	log_action_begin_msg "Starting plymouth daemon"
	/usr/sbin/plymouthd --mode=boot --attach-to-session
	log_action_end_msg $?

	if test -x /usr/bin/plymouth; then
		log_action_begin_msg "Showing boot splash"
		/usr/bin/plymouth --show-splash
		log_action_end_msg $?
	fi
fi

log_action_begin_msg "Waiting for /dev filesystem to be populated"
/sbin/udevadm trigger
/sbin/udevadm settle || true
log_action_end_msg $?

cmdline=`cat /proc/cmdline`
init=/sbin/init
root=/dev/sda1:/rootfs.img
disk=/media/disk
mp=/rootfs
ro=n

for arg in $cmdline; do
	case $arg in
	root=*)
		root=`echo $arg | cut -d= -f2-`
		case $root in
		LABEL=*)
			label=`echo $arg | cut -d= -f3-`
			root="/dev/disk/by-label/$label"
			;;

		UUID=*)
			uuid=`echo $arg | cut -d= -f3-`
			root="/dev/disk/by-uuid/$root"
			;;
		esac
		;;

	init=*)
		init=`echo $arg | cut -d = -f 2`
		;;

	ro)
		ro=y
		;;

	*)
		;;
	esac
done

dev=`echo $root | cut -d : -f 1`
img=`echo $root | cut -d : -f 2`

if [ "x$dev" = "x$img" ]; then
	img=
fi

log_action_begin_msg "Waiting for root device: $dev"
# wait for boot device
while ! test -e "$dev"; do
	sleep 1
done
log_action_end_msg $?

log_action_begin_msg "Mounting root filesystem: $mp"
mkdir -p "$mp"

if [ "x$img" = "x" ]; then
	if [ "x$ro" = "xy" ]; then
		mount -o ro "$dev" "$mp"
	else
		mount "$dev" "$mp"
	fi

	mp="$disk"
else
	mkdir -p "$disk"

	if [ "x$ro" = "xy" ]; then
		mount -o ro "$dev" "$disk"
		mount -o ro,loop "${disk}${img}" "$mp"
	else
		mount "$dev" "$disk"
		mount -o loop "${disk}${img}" "$mp"
	fi
fi

log_action_end_msg $?

if [ "x$img" != "x" ]; then
	mkdir -p "${mp}${disk}"
	mount --move "$disk" "${mp}${disk}"
fi

while [ ! -x "${mp}${init}" ]; do
	log_failure_msg "Target filesystem doesn't have $init"
	exit 1
done

if [ "x$ro" = "xremount" ]; then
	log_action_begin_msg "Remounting root filesystem read-only"
	mount -o remount,ro "$mp"
	log_action_end_msg $?
fi

log_action_begin_msg "Stopping udevd"
for proc in /proc/[0-9]*; do
	[ -x $proc/exe ] || continue
	if [ "`readlink $proc/exe`" = /sbin/udevd ]; then
		kill ${proc#/proc/} 2> /dev/null || true
	fi
done
log_action_end_msg $?

if test -b /dev/disk/by-label/persist; then
	log_action_begin_msg "Mounting persistent storage at $mp/persist"
	mount /dev/disk/by-label/persist $mp/persist
	log_action_end_msg $?
fi

if test -x /usr/bin/plymouth; then
	/usr/bin/plymouth --newroot=$mp
fi

exec switch_root "$mp" "$init" "$@"
