#!/bin/sh

. /lib/lsb/init-functions

log_action_begin_msg "Mounting /proc filesystem"
mkdir -p /proc
mount -t proc none /proc
log_action_end_msg $?

log_action_begin_msg "Mounting /sys filesystem"
mkdir -p /sys
mount -t sysfs none /sys
log_action_end_msg $?

log_action_begin_msg "Populating /dev filesystem ... "
mdev -s
log_action_end_msg $?

cmdline=`cat /proc/cmdline`
init=/sbin/init
root=/dev/sda1:/rootfs.img
disk=/media/disk
mp=/rootfs
ro=n

for arg in $cmdline; do
	case $arg in
	root=*)
		root=`echo $arg | cut -d= -f2-`
		case $root in
		LABEL=*)
			root=`echo $arg | cut -d= -f2-`
			root="/dev/disk/by-label/$root"
			;;

		UUID=*)
			root=`echo $arg | cut -d= -f2-`
			root="/dev/disk/by-uuid/$root"
			;;
		esac
		;;

	init=*)
		init=`echo $arg | cut -d = -f 2`
		;;

	ro)
		ro=y
		;;

	*)
		;;
	esac
done

dev=`echo $root | cut -d : -f 1`
img=`echo $root | cut -d : -f 2`

if [ "x$dev" = "x$img" ]; then
	img=
fi

log_action_begin_msg "Waiting for root device: $dev"
# wait for boot device
while ! test -e "$dev"; do
	sleep 1
	mdev -s
done
log_action_end_msg $?

log_action_begin_msg "Mounting root filesystem: $mp"
mkdir -p "$mp"

if [ "x$img" = "x" ]; then
	if [ "x$ro" = "xy" ]; then
		mount -o ro "$dev" "$mp"
	else
		mount "$dev" "$mp"
	fi

	mp="$disk"
else
	mkdir -p "$disk"

	if [ "x$ro" = "xy" ]; then
		mount -o ro "$dev" "$disk"
		mount -o ro,loop "${disk}${img}" "$mp"
	else
		mount "$dev" "$disk"
		mount -o loop "${disk}${img}" "$mp"
	fi
fi

log_action_end_msg $?

log_action_begin_msg "Mounting /dev filesystem"
mount -o rw,mode=0755,size=256K -t tmpfs udev "$mp/dev"
log_action_end_msg $?

log_action_begin_msg "Creating devices"
[ -e "$mp/dev/console" ] || mknod "$mp/dev/console" c 5 1
log_action_end_msg $?

if [ "x$img" != "x" ]; then
	mkdir -p "${mp}${disk}"
	mount -o move "$disk" "${mp}${disk}"
fi

while [ ! -x "${mp}${init}" ]; do
	log_failure_msg "Target filesystem doesn't have $init"
	exit 1
done

if [ "x$ro" = "xremount" ]; then
	log_action_begin_msg "Remounting root filesystem read-only"
	mount -o remount,ro "$mp"
	log_action_end_msg $?
fi

log_action_begin_msg "Moving filesystems to root filesystem"
mount -o move /sys  "$mp/sys"
mount -o move /proc "$mp/proc"
mount -o move /media/disk "$mp/media/disk"
log_action_end_msg $?

exec switch_root "$mp" "$init" "$@"
